<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="mask-icon" href="/images/freesoft.jpg?v=6.0.3" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="C/C++开发," />


<meta name="description" content="AddressSanitizer 是一个性能非常好的 C/C++ 内存错误探测工具。它由编译器的插桩模块（目前，LLVM 通过）和替换了 malloc 函数的运行时库组成。这个工具可以探测如下这些类型的错误：">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux 下的 AddressSanitizer">
<meta property="og:url" content="https://www.wolfcstech.com/2019/05/19/AddressSanitizer_on_linux/index.html">
<meta property="og:site_name" content="WolfcsTech">
<meta property="og:description" content="AddressSanitizer 是一个性能非常好的 C/C++ 内存错误探测工具。它由编译器的插桩模块（目前，LLVM 通过）和替换了 malloc 函数的运行时库组成。这个工具可以探测如下这些类型的错误：">
<meta property="og:updated_time" content="2019-10-25T03:39:45.609Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux 下的 AddressSanitizer">
<meta name="twitter:description" content="AddressSanitizer 是一个性能非常好的 C/C++ 内存错误探测工具。它由编译器的插桩模块（目前，LLVM 通过）和替换了 malloc 函数的运行时库组成。这个工具可以探测如下这些类型的错误：">






  <link rel="canonical" href="https://www.wolfcstech.com/2019/05/19/AddressSanitizer_on_linux/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>Linux 下的 AddressSanitizer | WolfcsTech</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-109419024-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-109419024-1');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WolfcsTech</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="http://www.ixirong.com/404.html" rel="section">
            <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />公益 404</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.wolfcstech.com/2019/05/19/AddressSanitizer_on_linux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Han Pengfei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/freesoft.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WolfcsTech">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Linux 下的 AddressSanitizer</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-19T11:05:49+08:00">2019-05-19</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/C-C-开发/" itemprop="url" rel="index"><span itemprop="name">C/C++开发</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/19/AddressSanitizer_on_linux/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/05/19/AddressSanitizer_on_linux/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/05/19/AddressSanitizer_on_linux/" class="leancloud_visitors" data-flag-title="Linux 下的 AddressSanitizer">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>AddressSanitizer 是一个性能非常好的 C/C++ 内存错误探测工具。它由编译器的插桩模块（目前，LLVM 通过）和替换了 <code>malloc</code> 函数的运行时库组成。这个工具可以探测如下这些类型的错误：<br><a id="more"></a></p>
<ul>
<li>对堆，栈和全局内存的访问越界（堆缓冲区溢出，栈缓冲区溢出，和全局缓冲区溢出）</li>
<li>UAP（Use-after-free，悬挂指针的解引用，或者说野指针）</li>
<li>Use-after-return（无效的栈上内存，运行时标记 <code>ASAN_OPTIONS=detect_stack_use_after_return=1</code>）</li>
<li>Use-After-Scope（作用域外访问，clang 标记 -fsanitize-address-use-after-scope ）</li>
<li>内存的重复释放</li>
<li>初始化顺序的 bug</li>
<li>内存泄漏</li>
</ul>
<p>这个工具非常快。通常情况下，内存问题探测这类调试工具的引入，会导致原有应用程序运行性能的大幅下降，比如大名鼎鼎的 valgrind 据说会导致应用程序性能下降到正常情况的十几分之一，但引入 AddressSanitizer 只会减慢运行速度的一半。</p>
<h1 id="AddressSanitizer-的使用"><a href="#AddressSanitizer-的使用" class="headerlink" title="AddressSanitizer 的使用"></a>AddressSanitizer 的使用</h1><p>自 LLVM 的版本 3.1 和 GCC 的版本 4.8 开始，<a href="https://github.com/google/sanitizers/wiki/AddressSanitizer" target="_blank" rel="external">AddressSanitizer</a> 就是它们的一部分。如果需要的话，也可以从源码编译 <a href="https://github.com/google/sanitizers/wiki/AddressSanitizerHowToBuild" target="_blank" rel="external">AddressSanitizerHowToBuild</a>。</p>
<p>查看自己的 LLVM 版本和 GCC 版本来确认是否内置了对 AddressSanitizer 的支持：<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">$</span> clang --version</div><div class="line">clang version <span class="number">3.9</span><span class="number">.1</span><span class="number">-4</span>ubuntu3~<span class="number">16.04</span><span class="number">.2</span> (tags/RELEASE_391/rc2)</div><div class="line">Target: x86_64-pc-linux-gnu</div><div class="line">Thread <span class="keyword">model</span>: posix</div><div class="line">InstalledDir: /usr/bin</div><div class="line"></div><div class="line"><span class="symbol">$</span> gcc --version</div><div class="line">gcc (Ubuntu <span class="number">5.4</span><span class="number">.0</span><span class="number">-6</span>ubuntu1~<span class="number">16.04</span><span class="number">.10</span>) <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span></div><div class="line">Copyright (C) <span class="number">2015</span> <span class="keyword">Free</span> Software Foundation, Inc.</div><div class="line">This is <span class="keyword">free</span> software; see the source <span class="keyword">for</span> copying conditions.  There is <span class="keyword">NO</span></div><div class="line">warranty; <span class="keyword">not</span> even <span class="keyword">for</span> MERCHANTABILITY <span class="keyword">or</span> FITNESS <span class="keyword">FOR</span> A PARTICULAR PURPOSE.</div></pre></td></tr></table></figure></p>
<p>我本地的工具虽然版本比较老，但对 AddressSanitizer 还是支持的。</p>
<p>看一下前面提到的 AddressSanitizer 的运行时库：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">$ locate asan</div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/5/<span class="title">libasan</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/5/<span class="title">libasan</span>.<span class="title">so</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/5/<span class="title">libasan_preinit</span>.<span class="title">o</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/5/32/<span class="title">libasan</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/5/32/<span class="title">libasan</span>.<span class="title">so</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/5/32/<span class="title">libasan_preinit</span>.<span class="title">o</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/5/<span class="title">include</span>/<span class="title">sanitizer</span>/<span class="title">asan_interface</span>.<span class="title">h</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/5/<span class="title">x32</span>/<span class="title">libasan</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/5/<span class="title">x32</span>/<span class="title">libasan</span>.<span class="title">so</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/5/<span class="title">x32</span>/<span class="title">libasan_preinit</span>.<span class="title">o</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/7/<span class="title">libasan</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/7/<span class="title">libasan</span>.<span class="title">so</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/7/<span class="title">libasan_preinit</span>.<span class="title">o</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/7/<span class="title">include</span>/<span class="title">sanitizer</span>/<span class="title">asan_interface</span>.<span class="title">h</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>-<span class="title">cross</span>/<span class="title">arm</span>-<span class="title">linux</span>-<span class="title">gnueabihf</span>/5/<span class="title">libasan</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>-<span class="title">cross</span>/<span class="title">arm</span>-<span class="title">linux</span>-<span class="title">gnueabihf</span>/5/<span class="title">libasan</span>.<span class="title">so</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>-<span class="title">cross</span>/<span class="title">arm</span>-<span class="title">linux</span>-<span class="title">gnueabihf</span>/5/<span class="title">libasan_preinit</span>.<span class="title">o</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>-<span class="title">cross</span>/<span class="title">arm</span>-<span class="title">linux</span>-<span class="title">gnueabihf</span>/5/<span class="title">include</span>/<span class="title">sanitizer</span>/<span class="title">asan_interface</span>.<span class="title">h</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>-<span class="title">cross</span>/<span class="title">arm</span>-<span class="title">linux</span>-<span class="title">gnueabihf</span>/5/<span class="title">sf</span>/<span class="title">libasan</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>-<span class="title">cross</span>/<span class="title">arm</span>-<span class="title">linux</span>-<span class="title">gnueabihf</span>/5/<span class="title">sf</span>/<span class="title">libasan</span>.<span class="title">so</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">gcc</span>-<span class="title">cross</span>/<span class="title">arm</span>-<span class="title">linux</span>-<span class="title">gnueabihf</span>/5/<span class="title">sf</span>/<span class="title">libasan_preinit</span>.<span class="title">o</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">asan_blacklist</span>.<span class="title">txt</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">include</span>/<span class="title">sanitizer</span>/<span class="title">asan_interface</span>.<span class="title">h</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">i386</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">i386</span>.<span class="title">so</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">i686</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">i686</span>.<span class="title">so</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">preinit</span>-<span class="title">i386</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">preinit</span>-<span class="title">i686</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">preinit</span>-<span class="title">x86_64</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">x86_64</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">x86_64</span>.<span class="title">a</span>.<span class="title">syms</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">x86_64</span>.<span class="title">so</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan_cxx</span>-<span class="title">i386</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan_cxx</span>-<span class="title">i686</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan_cxx</span>-<span class="title">x86_64</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-3.9/<span class="title">lib</span>/<span class="title">clang</span>/3.9.1/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan_cxx</span>-<span class="title">x86_64</span>.<span class="title">a</span>.<span class="title">syms</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">asan_blacklist</span>.<span class="title">txt</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">include</span>/<span class="title">sanitizer</span>/<span class="title">asan_interface</span>.<span class="title">h</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">i386</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">i386</span>.<span class="title">so</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">i686</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">i686</span>.<span class="title">so</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">preinit</span>-<span class="title">i386</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">preinit</span>-<span class="title">i686</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">preinit</span>-<span class="title">x86_64</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">x86_64</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">x86_64</span>.<span class="title">a</span>.<span class="title">syms</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan</span>-<span class="title">x86_64</span>.<span class="title">so</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan_cxx</span>-<span class="title">i386</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan_cxx</span>-<span class="title">i686</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan_cxx</span>-<span class="title">x86_64</span>.<span class="title">a</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">llvm</span>-5.0/<span class="title">lib</span>/<span class="title">clang</span>/5.0.2/<span class="title">lib</span>/<span class="title">linux</span>/<span class="title">libclang_rt</span>.<span class="title">asan_cxx</span>-<span class="title">x86_64</span>.<span class="title">a</span>.<span class="title">syms</span></span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">libasan</span>.<span class="title">so</span>.2</span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">libasan</span>.<span class="title">so</span>.2.0.0</span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">libasan</span>.<span class="title">so</span>.4</span></div><div class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">libasan</span>.<span class="title">so</span>.4.0.0</span></div><div class="line">/usr/lib32/libasan.so.<span class="number">2</span></div><div class="line">/usr/lib32/libasan.so.<span class="number">2.0</span>.<span class="number">0</span></div><div class="line">/usr/libx32/libasan.so.<span class="number">2</span></div><div class="line">/usr/libx32/libasan.so.<span class="number">2.0</span>.<span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>为了使用 <a href="https://github.com/google/sanitizers/wiki/AddressSanitizer" target="_blank" rel="external">AddressSanitizer</a>，需要在使用 GCC 或 Clang 编译链接程序时加上 <code>-fsanitize=address</code> 开关。为了获得合理的性能，可以加上 <code>-O1</code> 或更高。为了在错误信息中获得更友好的栈追踪信息可以加上 <code>-fno-omit-frame-pointer</code>。为了获得完美的栈追踪信息，还可以禁用内联（使用 <code>-O1</code>）和尾调用消除（<code>-fno-optimize-sibling-calls</code>）</p>
<p>下面是一段存在内存访问错误的代码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// main.cpp</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> *<span class="built_in">array</span> = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">100</span>];</div><div class="line">  <span class="keyword">delete</span> [] <span class="built_in">array</span>;</div><div class="line">  <span class="keyword">return</span> <span class="built_in">array</span>[argc];  <span class="comment">// BOOM</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用 GCC 编译并运行：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">$ gcc -fsanitize=address -fno-omit-frame-pointer -O1 -g -o main main.cpp</div><div class="line">$ ./main </div><div class="line">=================================================================</div><div class="line">==5385==ERROR: AddressSanitizer: heap-<span class="keyword">use</span>-<span class="keyword">after</span>-free <span class="keyword">on</span> address <span class="number">0x61400000fe44</span> <span class="keyword">at</span> pc <span class="number">0x0000004007d4</span> bp <span class="number">0x7ffddf0bafb0</span> sp <span class="number">0x7ffddf0bafa0</span></div><div class="line"><span class="keyword">READ</span> <span class="keyword">of</span> <span class="keyword">size</span> <span class="number">4</span> <span class="keyword">at</span> <span class="number">0x61400000fe44</span> <span class="keyword">thread</span> T0</div><div class="line">    #<span class="number">0</span> <span class="number">0x4007d3</span> <span class="keyword">in</span> <span class="keyword">main</span> addresssanitizer_demo/main.cpp:<span class="number">4</span></div><div class="line">    #<span class="number">1</span> <span class="number">0x7f297fc2282f</span> <span class="keyword">in</span> __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x2082f</span>)</div><div class="line">    #<span class="number">2</span> <span class="number">0x4006b8</span> <span class="keyword">in</span> _start (addresssanitizer_demo/<span class="keyword">main</span>+<span class="number">0x4006b8</span>)</div><div class="line"></div><div class="line"><span class="number">0x61400000fe44</span> <span class="keyword">is</span> located <span class="number">4</span> <span class="keyword">bytes</span> inside <span class="keyword">of</span> <span class="number">400</span>-<span class="keyword">byte</span> region [<span class="number">0x61400000fe40</span>,<span class="number">0x61400000ffd0</span>)</div><div class="line">freed <span class="keyword">by</span> <span class="keyword">thread</span> T0 here:</div><div class="line">    #<span class="number">0</span> <span class="number">0x7f2980065caa</span> <span class="keyword">in</span> <span class="keyword">operator</span> <span class="keyword">delete</span>[](<span class="built_in">void</span>*) (/usr/lib/x86_64-linux-gnu/libasan.so<span class="number">.2</span>+<span class="number">0x99caa</span>)</div><div class="line">    #<span class="number">1</span> <span class="number">0x4007a8</span> <span class="keyword">in</span> <span class="keyword">main</span> /home/hanpfei0306/<span class="keyword">data</span>/MyProjects/addresssanitizer_demo/main.cpp:<span class="number">3</span></div><div class="line">    #<span class="number">2</span> <span class="number">0x7f297fc2282f</span> <span class="keyword">in</span> __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x2082f</span>)</div><div class="line"></div><div class="line">previously allocated <span class="keyword">by</span> <span class="keyword">thread</span> T0 here:</div><div class="line">    #<span class="number">0</span> <span class="number">0x7f29800656b2</span> <span class="keyword">in</span> <span class="keyword">operator</span> <span class="keyword">new</span>[](<span class="keyword">unsigned</span> <span class="keyword">long</span>) (/usr/lib/x86_64-linux-gnu/libasan.so<span class="number">.2</span>+<span class="number">0x996b2</span>)</div><div class="line">    #<span class="number">1</span> <span class="number">0x400798</span> <span class="keyword">in</span> <span class="keyword">main</span> /home/hanpfei0306/<span class="keyword">data</span>/MyProjects/addresssanitizer_demo/main.cpp:<span class="number">2</span></div><div class="line">    #<span class="number">2</span> <span class="number">0x7f297fc2282f</span> <span class="keyword">in</span> __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x2082f</span>)</div><div class="line"></div><div class="line">SUMMARY: AddressSanitizer: <span class="keyword">heap</span>-<span class="keyword">use</span>-<span class="keyword">after</span>-free addresssanitizer_demo/main.cpp:<span class="number">4</span> <span class="keyword">main</span></div><div class="line">Shadow <span class="keyword">bytes</span> around the buggy address:</div><div class="line">  <span class="number">0x0c287fff9f70</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9f80</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9f90</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9fa0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9fb0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">=&gt;<span class="number">0x0c287fff9fc0</span>: fa fa fa fa fa fa fa fa[fd]fd fd fd fd fd fd fd</div><div class="line">  <span class="number">0x0c287fff9fd0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</div><div class="line">  <span class="number">0x0c287fff9fe0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</div><div class="line">  <span class="number">0x0c287fff9ff0</span>: fd fd fd fd fd fd fd fd fd fd fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fffa000</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fffa010</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">Shadow <span class="keyword">byte</span> legend (one shadow <span class="keyword">byte</span> represents <span class="number">8</span> application <span class="keyword">bytes</span>):</div><div class="line">  Addressable:           <span class="number">00</span></div><div class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </div><div class="line">  <span class="keyword">Heap</span> <span class="keyword">left</span> redzone:       fa</div><div class="line">  <span class="keyword">Heap</span> <span class="keyword">right</span> redzone:      fb</div><div class="line">  Freed <span class="keyword">heap</span> region:       fd</div><div class="line">  Stack <span class="keyword">left</span> redzone:      f1</div><div class="line">  Stack <span class="keyword">mid</span> redzone:       f2</div><div class="line">  Stack <span class="keyword">right</span> redzone:     f3</div><div class="line">  Stack <span class="keyword">partial</span> redzone:   f4</div><div class="line">  Stack <span class="keyword">after</span> <span class="keyword">return</span>:      f5</div><div class="line">  Stack <span class="keyword">use</span> <span class="keyword">after</span> <span class="keyword">scope</span>:   f8</div><div class="line">  <span class="keyword">Global</span> redzone:          f9</div><div class="line">  <span class="keyword">Global</span> init <span class="keyword">order</span>:       f6</div><div class="line">  Poisoned <span class="keyword">by</span> <span class="keyword">user</span>:        f7</div><div class="line">  <span class="keyword">Container</span> <span class="keyword">overflow</span>:      fc</div><div class="line">  <span class="built_in">Array</span> cookie:            ac</div><div class="line">  Intra <span class="keyword">object</span> redzone:    bb</div><div class="line">  ASan internal:           fe</div><div class="line">==<span class="number">5385</span>==ABORTING</div></pre></td></tr></table></figure></p>
<p>AddressSanitizer 在探测到内存错误之后，向 stderr 打印了错误信息并以非 0 值返回码退出。AddressSanitizer 在发现第一个错误时退出程序。这主要是基于如下的设计：</p>
<ul>
<li>这种方法允许 AddressSanitizer 产生更快和更小的生成码（总共 ~5%）。</li>
<li>解决 bug 变得无法避免。AddressSanitizer 不产生误报。一旦内存崩溃发生，则程序进入不一致的状态，这可能导致令人费解的结果和潜在的误导性的后续报告。</li>
</ul>
<p>如果进程运行在沙盒中且运行在 OS X 10.10 或更早的版本上，则需要设置<code>DYLD_INSERT_LIBRARIES</code> 环境变量并把它指向由编译器打包用于构建可执行文件的 ASan 库。（可以搜索名字中包含 <code>asan</code> 的动态链接库来找到这个库。）如果没有设置环境变量，则进程将试图重新执行。同时记住，当把可执行文件移动到另一台机器时，ASan 库也需要复制过去。</p>
<p>编译时如果遗漏了 <code>-g</code> 参数，导致可执行文件中缺乏调试信息，则探测到内存错误时，AddressSanitizer 吐出来的错误信息中，无法显示具体的出错的代码行，就像下面这样：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">$ gcc -fsanitize=address -fno-omit-frame-pointer -O1  -o main main.cpp </div><div class="line">$ ./main </div><div class="line">=================================================================</div><div class="line">==5403==ERROR: AddressSanitizer: heap-<span class="keyword">use</span>-<span class="keyword">after</span>-free <span class="keyword">on</span> address <span class="number">0x61400000fe44</span> <span class="keyword">at</span> pc <span class="number">0x0000004007d4</span> bp <span class="number">0x7ffd981fce20</span> sp <span class="number">0x7ffd981fce10</span></div><div class="line"><span class="keyword">READ</span> <span class="keyword">of</span> <span class="keyword">size</span> <span class="number">4</span> <span class="keyword">at</span> <span class="number">0x61400000fe44</span> <span class="keyword">thread</span> T0</div><div class="line">    #<span class="number">0</span> <span class="number">0x4007d3</span> <span class="keyword">in</span> <span class="keyword">main</span> (addresssanitizer_demo/<span class="keyword">main</span>+<span class="number">0x4007d3</span>)</div><div class="line">    #<span class="number">1</span> <span class="number">0x7f9de8af482f</span> <span class="keyword">in</span> __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x2082f</span>)</div><div class="line">    #<span class="number">2</span> <span class="number">0x4006b8</span> <span class="keyword">in</span> _start (addresssanitizer_demo/<span class="keyword">main</span>+<span class="number">0x4006b8</span>)</div><div class="line"></div><div class="line"><span class="number">0x61400000fe44</span> <span class="keyword">is</span> located <span class="number">4</span> <span class="keyword">bytes</span> inside <span class="keyword">of</span> <span class="number">400</span>-<span class="keyword">byte</span> region [<span class="number">0x61400000fe40</span>,<span class="number">0x61400000ffd0</span>)</div><div class="line">freed <span class="keyword">by</span> <span class="keyword">thread</span> T0 here:</div><div class="line">    #<span class="number">0</span> <span class="number">0x7f9de8f37caa</span> <span class="keyword">in</span> <span class="keyword">operator</span> <span class="keyword">delete</span>[](<span class="built_in">void</span>*) (/usr/lib/x86_64-linux-gnu/libasan.so<span class="number">.2</span>+<span class="number">0x99caa</span>)</div><div class="line">    #<span class="number">1</span> <span class="number">0x4007a8</span> <span class="keyword">in</span> <span class="keyword">main</span> (addresssanitizer_demo/<span class="keyword">main</span>+<span class="number">0x4007a8</span>)</div><div class="line">    #<span class="number">2</span> <span class="number">0x7f9de8af482f</span> <span class="keyword">in</span> __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x2082f</span>)</div><div class="line"></div><div class="line">previously allocated <span class="keyword">by</span> <span class="keyword">thread</span> T0 here:</div><div class="line">    #<span class="number">0</span> <span class="number">0x7f9de8f376b2</span> <span class="keyword">in</span> <span class="keyword">operator</span> <span class="keyword">new</span>[](<span class="keyword">unsigned</span> <span class="keyword">long</span>) (/usr/lib/x86_64-linux-gnu/libasan.so<span class="number">.2</span>+<span class="number">0x996b2</span>)</div><div class="line">    #<span class="number">1</span> <span class="number">0x400798</span> <span class="keyword">in</span> <span class="keyword">main</span> (addresssanitizer_demo/<span class="keyword">main</span>+<span class="number">0x400798</span>)</div><div class="line">    #<span class="number">2</span> <span class="number">0x7f9de8af482f</span> <span class="keyword">in</span> __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x2082f</span>)</div><div class="line"></div><div class="line">SUMMARY: AddressSanitizer: <span class="keyword">heap</span>-<span class="keyword">use</span>-<span class="keyword">after</span>-free ??:<span class="number">0</span> <span class="keyword">main</span></div><div class="line">Shadow <span class="keyword">bytes</span> around the buggy address:</div><div class="line">  <span class="number">0x0c287fff9f70</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9f80</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9f90</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9fa0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9fb0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">=&gt;<span class="number">0x0c287fff9fc0</span>: fa fa fa fa fa fa fa fa[fd]fd fd fd fd fd fd fd</div><div class="line">  <span class="number">0x0c287fff9fd0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</div><div class="line">  <span class="number">0x0c287fff9fe0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</div><div class="line">  <span class="number">0x0c287fff9ff0</span>: fd fd fd fd fd fd fd fd fd fd fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fffa000</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fffa010</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">Shadow <span class="keyword">byte</span> legend (one shadow <span class="keyword">byte</span> represents <span class="number">8</span> application <span class="keyword">bytes</span>):</div><div class="line">  Addressable:           <span class="number">00</span></div><div class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </div><div class="line">  <span class="keyword">Heap</span> <span class="keyword">left</span> redzone:       fa</div><div class="line">  <span class="keyword">Heap</span> <span class="keyword">right</span> redzone:      fb</div><div class="line">  Freed <span class="keyword">heap</span> region:       fd</div><div class="line">  Stack <span class="keyword">left</span> redzone:      f1</div><div class="line">  Stack <span class="keyword">mid</span> redzone:       f2</div><div class="line">  Stack <span class="keyword">right</span> redzone:     f3</div><div class="line">  Stack <span class="keyword">partial</span> redzone:   f4</div><div class="line">  Stack <span class="keyword">after</span> <span class="keyword">return</span>:      f5</div><div class="line">  Stack <span class="keyword">use</span> <span class="keyword">after</span> <span class="keyword">scope</span>:   f8</div><div class="line">  <span class="keyword">Global</span> redzone:          f9</div><div class="line">  <span class="keyword">Global</span> init <span class="keyword">order</span>:       f6</div><div class="line">  Poisoned <span class="keyword">by</span> <span class="keyword">user</span>:        f7</div><div class="line">  <span class="keyword">Container</span> <span class="keyword">overflow</span>:      fc</div><div class="line">  <span class="built_in">Array</span> cookie:            ac</div><div class="line">  Intra <span class="keyword">object</span> redzone:    bb</div><div class="line">  ASan internal:           fe</div><div class="line">==<span class="number">5403</span>==ABORTING</div></pre></td></tr></table></figure></p>
<p>上面的 <code>-g</code> 选项也可以用 <code>-ggdb</code> 选项（尽可能的生成 gdb 的可以使用的调试信息）替换。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">$ gcc -fsanitize=address -fno-omit-frame-pointer -O1 -ggdb -o main main.cpp </div><div class="line">$ ./main </div><div class="line">=================================================================</div><div class="line">==5495==ERROR: AddressSanitizer: heap-<span class="keyword">use</span>-<span class="keyword">after</span>-free <span class="keyword">on</span> address <span class="number">0x61400000fe44</span> <span class="keyword">at</span> pc <span class="number">0x0000004007d4</span> bp <span class="number">0x7fff7014ca10</span> sp <span class="number">0x7fff7014ca00</span></div><div class="line"><span class="keyword">READ</span> <span class="keyword">of</span> <span class="keyword">size</span> <span class="number">4</span> <span class="keyword">at</span> <span class="number">0x61400000fe44</span> <span class="keyword">thread</span> T0</div><div class="line">    #<span class="number">0</span> <span class="number">0x4007d3</span> <span class="keyword">in</span> <span class="keyword">main</span> /home/hanpfei0306/<span class="keyword">data</span>/MyProjects/addresssanitizer_demo/main.cpp:<span class="number">4</span></div><div class="line">    #<span class="number">1</span> <span class="number">0x7fdddb19982f</span> <span class="keyword">in</span> __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x2082f</span>)</div><div class="line">    #<span class="number">2</span> <span class="number">0x4006b8</span> <span class="keyword">in</span> _start (addresssanitizer_demo/<span class="keyword">main</span>+<span class="number">0x4006b8</span>)</div><div class="line"></div><div class="line"><span class="number">0x61400000fe44</span> <span class="keyword">is</span> located <span class="number">4</span> <span class="keyword">bytes</span> inside <span class="keyword">of</span> <span class="number">400</span>-<span class="keyword">byte</span> region [<span class="number">0x61400000fe40</span>,<span class="number">0x61400000ffd0</span>)</div><div class="line">freed <span class="keyword">by</span> <span class="keyword">thread</span> T0 here:</div><div class="line">    #<span class="number">0</span> <span class="number">0x7fdddb5dccaa</span> <span class="keyword">in</span> <span class="keyword">operator</span> <span class="keyword">delete</span>[](<span class="built_in">void</span>*) (/usr/lib/x86_64-linux-gnu/libasan.so<span class="number">.2</span>+<span class="number">0x99caa</span>)</div><div class="line">    #<span class="number">1</span> <span class="number">0x4007a8</span> <span class="keyword">in</span> <span class="keyword">main</span> /home/hanpfei0306/<span class="keyword">data</span>/MyProjects/addresssanitizer_demo/main.cpp:<span class="number">3</span></div><div class="line">    #<span class="number">2</span> <span class="number">0x7fdddb19982f</span> <span class="keyword">in</span> __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x2082f</span>)</div><div class="line"></div><div class="line">previously allocated <span class="keyword">by</span> <span class="keyword">thread</span> T0 here:</div><div class="line">    #<span class="number">0</span> <span class="number">0x7fdddb5dc6b2</span> <span class="keyword">in</span> <span class="keyword">operator</span> <span class="keyword">new</span>[](<span class="keyword">unsigned</span> <span class="keyword">long</span>) (/usr/lib/x86_64-linux-gnu/libasan.so<span class="number">.2</span>+<span class="number">0x996b2</span>)</div><div class="line">    #<span class="number">1</span> <span class="number">0x400798</span> <span class="keyword">in</span> <span class="keyword">main</span> /home/hanpfei0306/<span class="keyword">data</span>/MyProjects/addresssanitizer_demo/main.cpp:<span class="number">2</span></div><div class="line">    #<span class="number">2</span> <span class="number">0x7fdddb19982f</span> <span class="keyword">in</span> __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x2082f</span>)</div><div class="line"></div><div class="line">SUMMARY: AddressSanitizer: <span class="keyword">heap</span>-<span class="keyword">use</span>-<span class="keyword">after</span>-free /home/hanpfei0306/<span class="keyword">data</span>/MyProjects/addresssanitizer_demo/main.cpp:<span class="number">4</span> <span class="keyword">main</span></div><div class="line">Shadow <span class="keyword">bytes</span> around the buggy address:</div><div class="line">  <span class="number">0x0c287fff9f70</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9f80</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9f90</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9fa0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9fb0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">=&gt;<span class="number">0x0c287fff9fc0</span>: fa fa fa fa fa fa fa fa[fd]fd fd fd fd fd fd fd</div><div class="line">  <span class="number">0x0c287fff9fd0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</div><div class="line">  <span class="number">0x0c287fff9fe0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</div><div class="line">  <span class="number">0x0c287fff9ff0</span>: fd fd fd fd fd fd fd fd fd fd fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fffa000</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fffa010</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">Shadow <span class="keyword">byte</span> legend (one shadow <span class="keyword">byte</span> represents <span class="number">8</span> application <span class="keyword">bytes</span>):</div><div class="line">  Addressable:           <span class="number">00</span></div><div class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </div><div class="line">  <span class="keyword">Heap</span> <span class="keyword">left</span> redzone:       fa</div><div class="line">  <span class="keyword">Heap</span> <span class="keyword">right</span> redzone:      fb</div><div class="line">  Freed <span class="keyword">heap</span> region:       fd</div><div class="line">  Stack <span class="keyword">left</span> redzone:      f1</div><div class="line">  Stack <span class="keyword">mid</span> redzone:       f2</div><div class="line">  Stack <span class="keyword">right</span> redzone:     f3</div><div class="line">  Stack <span class="keyword">partial</span> redzone:   f4</div><div class="line">  Stack <span class="keyword">after</span> <span class="keyword">return</span>:      f5</div><div class="line">  Stack <span class="keyword">use</span> <span class="keyword">after</span> <span class="keyword">scope</span>:   f8</div><div class="line">  <span class="keyword">Global</span> redzone:          f9</div><div class="line">  <span class="keyword">Global</span> init <span class="keyword">order</span>:       f6</div><div class="line">  Poisoned <span class="keyword">by</span> <span class="keyword">user</span>:        f7</div><div class="line">  <span class="keyword">Container</span> <span class="keyword">overflow</span>:      fc</div><div class="line">  <span class="built_in">Array</span> cookie:            ac</div><div class="line">  Intra <span class="keyword">object</span> redzone:    bb</div><div class="line">  ASan internal:           fe</div><div class="line">==<span class="number">5495</span>==ABORTING</div></pre></td></tr></table></figure></p>
<p>使用 LLVM/Clang 编译与上面使用 GCC 编译基本相同：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">$ clang++ -fsanitize=address -fno-omit-frame-pointer -O1 -g -o test main.cpp</div><div class="line">$ ./test </div><div class="line">=================================================================</div><div class="line">==5508==ERROR: AddressSanitizer: heap-<span class="keyword">use</span>-<span class="keyword">after</span>-free <span class="keyword">on</span> address <span class="number">0x61400000fe44</span> <span class="keyword">at</span> pc <span class="number">0x00000050770f</span> bp <span class="number">0x7ffea20137b0</span> sp <span class="number">0x7ffea20137a8</span></div><div class="line"><span class="keyword">READ</span> <span class="keyword">of</span> <span class="keyword">size</span> <span class="number">4</span> <span class="keyword">at</span> <span class="number">0x61400000fe44</span> <span class="keyword">thread</span> T0</div><div class="line">    #<span class="number">0</span> <span class="number">0x50770e</span> <span class="keyword">in</span> <span class="keyword">main</span> /home/hanpfei0306/<span class="keyword">data</span>/MyProjects/addresssanitizer_demo/main.cpp:<span class="number">4</span>:<span class="number">10</span></div><div class="line">    #<span class="number">1</span> <span class="number">0x7fdeb802382f</span> <span class="keyword">in</span> __libc_start_main /<span class="keyword">build</span>/glibc-Cl5G7W/glibc<span class="number">-2.23</span>/csu/../csu/libc-start.c:<span class="number">291</span></div><div class="line">    #<span class="number">2</span> <span class="number">0x4192b8</span> <span class="keyword">in</span> _start (addresssanitizer_demo/<span class="keyword">test</span>+<span class="number">0x4192b8</span>)</div><div class="line"></div><div class="line"><span class="number">0x61400000fe44</span> <span class="keyword">is</span> located <span class="number">4</span> <span class="keyword">bytes</span> inside <span class="keyword">of</span> <span class="number">400</span>-<span class="keyword">byte</span> region [<span class="number">0x61400000fe40</span>,<span class="number">0x61400000ffd0</span>)</div><div class="line">freed <span class="keyword">by</span> <span class="keyword">thread</span> T0 here:</div><div class="line">    #<span class="number">0</span> <span class="number">0x504c20</span> <span class="keyword">in</span> <span class="keyword">operator</span> <span class="keyword">delete</span>[](<span class="built_in">void</span>*) (addresssanitizer_demo/<span class="keyword">test</span>+<span class="number">0x504c20</span>)</div><div class="line">    #<span class="number">1</span> <span class="number">0x5076de</span> <span class="keyword">in</span> <span class="keyword">main</span> /home/hanpfei0306/<span class="keyword">data</span>/MyProjects/addresssanitizer_demo/main.cpp:<span class="number">3</span>:<span class="number">3</span></div><div class="line">    #<span class="number">2</span> <span class="number">0x7fdeb802382f</span> <span class="keyword">in</span> __libc_start_main /<span class="keyword">build</span>/glibc-Cl5G7W/glibc<span class="number">-2.23</span>/csu/../csu/libc-start.c:<span class="number">291</span></div><div class="line"></div><div class="line">previously allocated <span class="keyword">by</span> <span class="keyword">thread</span> T0 here:</div><div class="line">    #<span class="number">0</span> <span class="number">0x5045a0</span> <span class="keyword">in</span> <span class="keyword">operator</span> <span class="keyword">new</span>[](<span class="keyword">unsigned</span> <span class="keyword">long</span>) (addresssanitizer_demo/<span class="keyword">test</span>+<span class="number">0x5045a0</span>)</div><div class="line">    #<span class="number">1</span> <span class="number">0x5076d3</span> <span class="keyword">in</span> <span class="keyword">main</span> /home/hanpfei0306/<span class="keyword">data</span>/MyProjects/addresssanitizer_demo/main.cpp:<span class="number">2</span>:<span class="number">16</span></div><div class="line">    #<span class="number">2</span> <span class="number">0x7fdeb802382f</span> <span class="keyword">in</span> __libc_start_main /<span class="keyword">build</span>/glibc-Cl5G7W/glibc<span class="number">-2.23</span>/csu/../csu/libc-start.c:<span class="number">291</span></div><div class="line"></div><div class="line">SUMMARY: AddressSanitizer: <span class="keyword">heap</span>-<span class="keyword">use</span>-<span class="keyword">after</span>-free /home/hanpfei0306/<span class="keyword">data</span>/MyProjects/addresssanitizer_demo/main.cpp:<span class="number">4</span>:<span class="number">10</span> <span class="keyword">in</span> <span class="keyword">main</span></div><div class="line">Shadow <span class="keyword">bytes</span> around the buggy address:</div><div class="line">  <span class="number">0x0c287fff9f70</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9f80</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9f90</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9fa0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fff9fb0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">=&gt;<span class="number">0x0c287fff9fc0</span>: fa fa fa fa fa fa fa fa[fd]fd fd fd fd fd fd fd</div><div class="line">  <span class="number">0x0c287fff9fd0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</div><div class="line">  <span class="number">0x0c287fff9fe0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</div><div class="line">  <span class="number">0x0c287fff9ff0</span>: fd fd fd fd fd fd fd fd fd fd fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fffa000</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">  <span class="number">0x0c287fffa010</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</div><div class="line">Shadow <span class="keyword">byte</span> legend (one shadow <span class="keyword">byte</span> represents <span class="number">8</span> application <span class="keyword">bytes</span>):</div><div class="line">  Addressable:           <span class="number">00</span></div><div class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </div><div class="line">  <span class="keyword">Heap</span> <span class="keyword">left</span> redzone:       fa</div><div class="line">  <span class="keyword">Heap</span> <span class="keyword">right</span> redzone:      fb</div><div class="line">  Freed <span class="keyword">heap</span> region:       fd</div><div class="line">  Stack <span class="keyword">left</span> redzone:      f1</div><div class="line">  Stack <span class="keyword">mid</span> redzone:       f2</div><div class="line">  Stack <span class="keyword">right</span> redzone:     f3</div><div class="line">  Stack <span class="keyword">partial</span> redzone:   f4</div><div class="line">  Stack <span class="keyword">after</span> <span class="keyword">return</span>:      f5</div><div class="line">  Stack <span class="keyword">use</span> <span class="keyword">after</span> <span class="keyword">scope</span>:   f8</div><div class="line">  <span class="keyword">Global</span> redzone:          f9</div><div class="line">  <span class="keyword">Global</span> init <span class="keyword">order</span>:       f6</div><div class="line">  Poisoned <span class="keyword">by</span> <span class="keyword">user</span>:        f7</div><div class="line">  <span class="keyword">Container</span> <span class="keyword">overflow</span>:      fc</div><div class="line">  <span class="built_in">Array</span> cookie:            ac</div><div class="line">  Intra <span class="keyword">object</span> redzone:    bb</div><div class="line">  ASan internal:           fe</div><div class="line">  <span class="keyword">Left</span> alloca redzone:     ca</div><div class="line">  <span class="keyword">Right</span> alloca redzone:    cb</div><div class="line">==<span class="number">5508</span>==ABORTING</div></pre></td></tr></table></figure></p>
<p>可以通过 readelf 看一下 GCC 和 LLVM 生成的可执行文件有什么差别：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># GCC 生成的可执行文件</span></div><div class="line">$ readelf -s -W main | grep asan</div><div class="line">Symbol table '.dynsym' contains<span class="number"> 15 </span>entries:</div><div class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</div><div class="line">     1:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>FUNC    GLOBAL DEFAULT  UND __asan_report_load4</div><div class="line">    10:<span class="number"> 0000000000400650 </span>   <span class="number"> 0 </span>FUNC    GLOBAL DEFAULT  UND __asan_init_v4</div><div class="line">    44:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>FILE    LOCAL  DEFAULT  ABS asan_preinit.cc</div><div class="line">    57:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>FUNC    GLOBAL DEFAULT  UND __asan_report_load4</div><div class="line">    62:<span class="number"> 0000000000400650 </span>   <span class="number"> 0 </span>FUNC    GLOBAL DEFAULT  UND __asan_init_v4</div><div class="line">    69: 0000000000600dd0    <span class="number"> 8 </span>OBJECT  GLOBAL HIDDEN   <span class="number"> 19 </span>__local_asan_preinit</div><div class="line"></div><div class="line"><span class="comment"># LLVM 生成的可执行文件</span></div><div class="line">$ readelf -s -W test | grep asan</div><div class="line">     3:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  WEAK   DEFAULT  UND __asan_default_options</div><div class="line">    16:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  WEAK   DEFAULT  UND __asan_on_error</div><div class="line">    49:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  WEAK   DEFAULT  UND __asan_default_suppressions</div><div class="line">    66:<span class="number"> 0000000000426740 </span> <span class="number"> 466 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_stack_malloc_0</div><div class="line">    70: 00000000004269b0  <span class="number"> 504 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_stack_malloc_1</div><div class="line">. . . . . .</div><div class="line">   271:<span class="number"> 0000000000428000 </span> <span class="number"> 134 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_stack_free_8</div><div class="line">   272: 000000000042b1e0   <span class="number"> 44 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_register_image_globals</div><div class="line">   273: 00000000004d7550   <span class="number"> 44 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_report_load4_noabort</div><div class="line">   275: 00000000004282a0  <span class="number"> 134 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_stack_free_9</div><div class="line">. . . . . .</div><div class="line">   635: 00000000004d7460   <span class="number"> 44 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_report_load2</div><div class="line">   636: 00000000004d74f0   <span class="number"> 44 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_report_load4</div><div class="line">   644: 00000000004d7580   <span class="number"> 44 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_report_load8</div><div class="line">. . . . . .</div><div class="line">    37:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>FILE    LOCAL  DEFAULT  ABS asan_allocator.cc.o</div><div class="line">    38:<span class="number"> 0000000000419370 </span> <span class="number"> 254 </span>FUNC    LOCAL  DEFAULT  <span class="number"> 13 </span>_ZN6__asanL10RZSize2LogEj</div><div class="line">    39: 0000000000421c90  <span class="number"> 214 </span>FUNC    LOCAL  DEFAULT  <span class="number"> 13 </span>_ZN11__sanitizer20SizeClassAllocator64ILm105553116266496ELm4398046511104ELm0ENS_12SizeClassMapILm17ELm128ELm16EEEN6__asan20AsanMapUnmapCallbackEE15DeallocateBatchEPNS_14AllocatorStatsEmPNS2_13TransferBatchE.isra.32</div><div class="line">    40:<span class="number"> 0000000000419470 </span><span class="number"> 1241 </span>FUNC    LOCAL  DEFAULT  <span class="number"> 13 </span>_ZN6__asan9AsanChunk8UsedSizeEb.part.19</div><div class="line">  1162:<span class="number"> 0000000000422670 </span><span class="number"> 1101 </span>FUNC    WEAK   HIDDEN   <span class="number"> 13 </span>_ZN11__sanitizer28SizeClassAllocatorLocalCacheINS_20SizeClassAllocator64ILm105553116266496ELm4398046511104ELm0ENS_12SizeClassMapILm17ELm128ELm16EEEN6__asan20AsanMapUnmapCallbackEEEE6RefillEPS6_m</div><div class="line">  1178: 00000000004d74f0   <span class="number"> 44 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_report_load4</div><div class="line">  1194: 00000000004cff10   <span class="number"> 57 </span>FUNC    GLOBAL HIDDEN   <span class="number"> 13 </span>_ZN6__asan10AsanTSDGetEv</div><div class="line">  1196: 00000000004d6ea0    <span class="number"> 8 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_get_report_sp</div><div class="line">  1202: 00000000004a75e0   <span class="number"> 63 </span>FUNC    GLOBAL HIDDEN   <span class="number"> 13 </span>_ZN6__asan13SetThreadNameEPKc</div><div class="line">  1212: 00000000004d7b50   <span class="number"> 96 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_load1_noabort</div><div class="line">. . . . . .</div><div class="line">  2202: 00000000004d9780   <span class="number"> 96 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 13 </span>__asan_init</div><div class="line">  2208: 000000000041a720 <span class="number"> 2468 </span>FUNC    GLOBAL HIDDEN   <span class="number"> 13 </span>_ZN6__asan22FindHeapChunkByAddressEm</div><div class="line">  2219: 00000000004d9800    <span class="number"> 7 </span>FUNC    GLOBAL HIDDEN   <span class="number"> 13 </span>_ZN6__asan20GetMallocContextSizeEv</div><div class="line">. . . . . .</div><div class="line">  3790: 0000000000419ac0   <span class="number"> 19 </span>FUNC    GLOBAL HIDDEN   <span class="number"> 13 </span>_ZN6__asan13AsanChunkView11IsAllocatedEv</div><div class="line">  3796: 00000000004d08e0   <span class="number"> 97 </span>FUNC    GLOBAL HIDDEN   <span class="number"> 13 </span>_ZN6__asan25ThreadNameWithParenthesisEPNS_17AsanThreadContextEPcm</div></pre></td></tr></table></figure></p>
<p>主要看两个可执行文件中都有的符号 <code>__asan_report_load4</code> 和 <code>__asan_init</code>，可以看到 GCC 生成的可执行文件动态链接 ASan 库，LLVM 静态链接。</p>
<h1 id="符号化输出"><a href="#符号化输出" class="headerlink" title="符号化输出"></a>符号化输出</h1><p><a href="https://github.com/google/sanitizers/wiki/AddressSanitizer" target="_blank" rel="external">AddressSanitizer</a> 收集如下事件的调用栈：</p>
<ul>
<li><code>malloc</code> 和 <code>malloc</code></li>
<li>线程创建</li>
<li>失败</li>
</ul>
<p><code>malloc</code> 和 <code>malloc</code> 发生的相对频繁，且它对于快速解开调用栈非常重要。<a href="https://github.com/google/sanitizers/wiki/AddressSanitizer" target="_blank" rel="external">AddressSanitizer</a> 使用一个依赖帧指针的简单的 unwinder。</p>
<p>如果不关心 <code>malloc</code>/<code>free</code> 调用栈，简单地完全禁用（使用 <code>malloc_context_size=0</code> 运行时标记）unwinder。</p>
<p>每个栈帧需要被符号化（当然，如果二进制文件编译时带有调试信息）。给定一台 PC，我们需要输出：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-id">#0xabcdf</span> <span class="selector-tag">function_name</span> <span class="selector-tag">file_name</span><span class="selector-class">.cc</span><span class="selector-pseudo">:1234</span></div></pre></td></tr></table></figure></p>
<p>AddressSanitizer 使用 Clang 包中的 <a href="http://llvm.org/docs/CommandGuide/llvm-symbolizer.html" target="_blank" rel="external">llvm-symbolizer</a> 符号化栈追踪信息（注意理想的 llvm-symbolizer  版本必须与 ASan 运行时库匹配）。为了使 AddressSanitizer 符号化它的输出，需要设置 <code>ASAN_SYMBOLIZER_PATH</code> 环境变量指向 <code>llvm-symbolizer</code> 二进制文件，或确保 <code>llvm-symbolizer</code> 在 <code>$PATH</code> 中：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ ASAN_SYMBOLIZER_PATH=/usr/local/bin/llvm-symbolizer ./a.out</div><div class="line">==9442== ERROR: AddressSanitizer heap-<span class="keyword">use</span>-<span class="keyword">after</span>-free <span class="keyword">on</span> address <span class="number">0x7f7ddab8c084</span> <span class="keyword">at</span> pc <span class="number">0x403c8c</span> bp <span class="number">0x7fff87fb82d0</span> sp <span class="number">0x7fff87fb82c8</span></div><div class="line"><span class="keyword">READ</span> <span class="keyword">of</span> <span class="keyword">size</span> <span class="number">4</span> <span class="keyword">at</span> <span class="number">0x7f7ddab8c084</span> <span class="keyword">thread</span> T0</div><div class="line">    #<span class="number">0</span> <span class="number">0x403c8c</span> <span class="keyword">in</span> <span class="keyword">main</span> example_UseAfterFree.cc:<span class="number">4</span></div><div class="line">    #<span class="number">1</span> <span class="number">0x7f7ddabcac4d</span> <span class="keyword">in</span> __libc_start_main ??:<span class="number">0</span></div><div class="line"><span class="number">0x7f7ddab8c084</span> <span class="keyword">is</span> located <span class="number">4</span> <span class="keyword">bytes</span> inside <span class="keyword">of</span> <span class="number">400</span>-<span class="keyword">byte</span> region [<span class="number">0x7f7ddab8c080</span>,<span class="number">0x7f7ddab8c210</span>)</div><div class="line">freed <span class="keyword">by</span> <span class="keyword">thread</span> T0 here:</div><div class="line">    #<span class="number">0</span> <span class="number">0x404704</span> <span class="keyword">in</span> <span class="keyword">operator</span> <span class="keyword">delete</span>[](<span class="built_in">void</span>*) ??:<span class="number">0</span></div><div class="line">    #<span class="number">1</span> <span class="number">0x403c53</span> <span class="keyword">in</span> <span class="keyword">main</span> example_UseAfterFree.cc:<span class="number">4</span></div><div class="line">    #<span class="number">2</span> <span class="number">0x7f7ddabcac4d</span> <span class="keyword">in</span> __libc_start_main ??:<span class="number">0</span></div><div class="line">previously allocated <span class="keyword">by</span> <span class="keyword">thread</span> T0 here:</div><div class="line">    #<span class="number">0</span> <span class="number">0x404544</span> <span class="keyword">in</span> <span class="keyword">operator</span> <span class="keyword">new</span>[](<span class="keyword">unsigned</span> <span class="keyword">long</span>) ??:<span class="number">0</span></div><div class="line">    #<span class="number">1</span> <span class="number">0x403c43</span> <span class="keyword">in</span> <span class="keyword">main</span> example_UseAfterFree.cc:<span class="number">2</span></div><div class="line">    #<span class="number">2</span> <span class="number">0x7f7ddabcac4d</span> <span class="keyword">in</span> __libc_start_main ??:<span class="number">0</span></div><div class="line">==<span class="number">9442</span>== ABORTING</div></pre></td></tr></table></figure></p>
<p><code>llvm-symbolizer</code> 符号化工具属于 llvm 包，Ubuntu 下具体的安装方法可以参考 <a href="http://apt.llvm.org/" target="_blank" rel="external">LLVM Debian/Ubuntu nightly packages</a>。</p>
<p>如果上面的方法不起作用，可以使用一个单独的脚本来离线地符号化结果（在线的符号化可以通过设置 <code>ASAN_OPTIONS=symbolize=0</code>，或者设置一个空的 <code>ASAN_SYMBOLIZER_PATH</code> 环境变量（<code>$ export ASAN_SYMBOLIZER_PATH=</code>）来强制禁用）：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ ASAN_OPTIONS=symbolize=<span class="number">0</span> ./a.<span class="keyword">out</span> <span class="number">2</span>&gt; log</div><div class="line">$ projects/compiler-rt/<span class="class"><span class="keyword">lib</span>/<span class="title">asan</span>/<span class="title">scripts</span>/<span class="title">asan_symbolize</span>.<span class="title">py</span> / &lt; <span class="title">log</span> | <span class="title">c</span>++<span class="title">filt</span></span></div><div class="line">==<span class="number">9442</span>== <span class="symbol">ERROR:</span> AddressSanitizer heap-use-after-free on address <span class="number">0x7f7ddab8c084</span> at pc <span class="number">0x403c8c</span> bp <span class="number">0x7fff87fb82d0</span> sp <span class="number">0x7fff87fb82c8</span></div><div class="line">READ <span class="keyword">of</span> size <span class="number">4</span> at <span class="number">0x7f7ddab8c084</span> thread T0</div><div class="line">    <span class="comment">#0 0x403c8c in main example_UseAfterFree.cc:4</span></div><div class="line">    <span class="comment">#1 0x7f7ddabcac4d in __libc_start_main ??:0</span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>这个脚本接收一个可选的参数 <code>-- a file prefix</code>。子串 <code>.*prefix</code> 将被从文件名中移除。</p>
<p>上面的 <code>c++filt</code> 用于解函数名的符号重组，这也可以通过给 <code>asan_symbolize.py</code> 脚本添加 <code>-d</code> 参数来完成。</p>
<p>在 OS X 上可能需要对二进制文件运行 <code>dsymutil</code> 以在 AddressSanitizer 报告中获得 <code>file:line</code> 信息。</p>
<p>还可以引入自己的栈追踪格式，使用 <code>stack_trace_format</code> 运行时标记完成。例如：<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">% ./a.<span class="keyword">out</span></div><div class="line">    ...</div><div class="line">    #<span class="number">0</span> <span class="number">0</span>x4b615d <span class="keyword">in</span> main /home/you/<span class="keyword">use</span>-<span class="keyword">after</span>-free.cc:<span class="number">12</span>:<span class="number">3</span></div><div class="line">    ...</div><div class="line">% ASAN_OPTIONS=<span class="symbol">'stack_trace_format</span>=<span class="string">"[frame=%n, function=%f, location=%S]"</span>' ./a.<span class="keyword">out</span></div><div class="line">    ...</div><div class="line">    [frame=<span class="number">0</span>, <span class="keyword">function</span>=main, location=/home/you/<span class="keyword">use</span>-<span class="keyword">after</span>-free.cc:<span class="number">12</span>:<span class="number">3</span>]</div></pre></td></tr></table></figure></p>
<h1 id="AddressSanitizer-算法"><a href="#AddressSanitizer-算法" class="headerlink" title="AddressSanitizer 算法"></a>AddressSanitizer 算法</h1><h2 id="简单的版本"><a href="#简单的版本" class="headerlink" title="简单的版本"></a>简单的版本</h2><p>运行时库替换 <code>malloc</code> 和 <code>free</code> 函数。把 malloc 分配的内存区域（红色区域）附近放入一些特定的字节（使中毒）。把 <code>free</code> 的内存放入隔离区，并且也放入一些特定的字节（使中毒）。程序中的每次内存访问由编译器以下面的方式做一个转换。<br>之前：<br><figure class="highlight excel"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">*<span class="built_in">address</span> = ...;  // <span class="symbol">or:</span> ... = *<span class="built_in">address</span>;</div></pre></td></tr></table></figure></p>
<p>之后：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">if (IsPoisoned(<span class="keyword">address)) </span>&#123;</div><div class="line">  ReportError(<span class="keyword">address, </span>kAccessSize, kIsWrite)<span class="comment">;</span></div><div class="line">&#125;</div><div class="line">*<span class="keyword">address </span>= ...<span class="comment">;  // or: ... = *address;</span></div></pre></td></tr></table></figure></p>
<p>棘手的部分是如何把 <code>IsPoisoned</code> 实现的高效，且 <code>ReportError</code> 紧凑。同时，对某些访问的插桩可能被证明是冗余的。</p>
<h2 id="内存映射"><a href="#内存映射" class="headerlink" title="内存映射"></a>内存映射</h2><p>虚拟地址空间被分割为 2 个互斥的类别：</p>
<ul>
<li>主应用内存（<code>Mem</code>）：这种内存由常规的应用代码使用。</li>
<li>阴影内存（<code>Shadow</code>）：这种内存包含阴影值（或元数据）。阴影和主应用程序内存之间存在对应关系。在主内存中 <strong>使中毒</strong> 一个字节意味着在对应的阴影区写入一些特殊的值。</li>
</ul>
<p>这两种类别的内存应该以阴影内存（<code>MemToShadow</code>）可以被快速计算出来的方式进行组织。</p>
<p>编译器执行的插桩如下：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">shadow_address </span>= MemToShadow(<span class="keyword">address);</span></div><div class="line">if (<span class="keyword">ShadowIsPoisoned(shadow_address)) </span>&#123;</div><div class="line">  ReportError(<span class="keyword">address, </span>kAccessSize, kIsWrite)<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h2><p><a href="https://github.com/google/sanitizers/wiki/AddressSanitizer" target="_blank" rel="external">AddressSanitizer</a> 把 8 个字节的应用内存映射为 1 个字节的阴影内存。</p>
<p>对于任何 8 字节对齐的应用内存只有 9 个不同的值：</p>
<ul>
<li>qword 中的所有 8 字节是未中毒的（比如，可寻址）。阴影值为 0。</li>
<li>qword 中的所有 8 字节是中毒的（比如，不可寻址）。阴影值为负数。</li>
<li>起始的 <code>k</code> 字节是未中毒的，其余的 <code>8-k</code> 字节是中毒的。阴影值为 <code>k</code>。这主要由 <code>malloc</code> 的行为保证，即 <code>malloc</code> 总是返回 8 字节对齐的内存块。一个 qword 对齐的不同字节具有不同状态的仅有的情况是 malloc 的区域的尾部。比如，如果我们调用 <code>malloc(13)</code>，我们将拥有一个完整的未中毒的 qword 和一个开头 5 字节未中毒的 qword。</li>
</ul>
<p>插桩看起来像下面这样：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">byte </span>*<span class="keyword">shadow_address </span>= MemToShadow(<span class="keyword">address);</span></div><div class="line"><span class="keyword">byte </span><span class="keyword">shadow_value </span>= *<span class="keyword">shadow_address;</span></div><div class="line">if (<span class="keyword">shadow_value) </span>&#123;</div><div class="line">  if (SlowPathCheck(<span class="keyword">shadow_value, </span><span class="keyword">address, </span>kAccessSize)) &#123;</div><div class="line">    ReportError(<span class="keyword">address, </span>kAccessSize, kIsWrite)<span class="comment">;</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Check the cases where we access first k bytes of the qword</span></div><div class="line"><span class="comment">// and these k bytes are unpoisoned.</span></div><div class="line"><span class="function"><span class="keyword">bool</span> <span class="title">SlowPathCheck</span><span class="params">(shadow_value, address, kAccessSize)</span> </span>&#123;</div><div class="line">  last_accessed_byte = (address &amp; <span class="number">7</span>) + kAccessSize - <span class="number">1</span>;</div><div class="line">  <span class="keyword">return</span> (last_accessed_byte &gt;= shadow_value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>MemToShadow(ShadowAddr)</code> 落入不可寻址的 <code>ShadowGap</code> 区域。因此，如果程序试图直接访问阴影区域中的内存位置，它将崩溃。</p>
<h2 id="64-bit"><a href="#64-bit" class="headerlink" title="64-bit"></a>64-bit</h2><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">Shadow</span> = (Mem &gt;&gt; 3) + 0x7fff8000;</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>[0x10007fff8000, 0x7fffffffffff]</th>
<th>HighMem</th>
</tr>
</thead>
<tbody>
<tr>
<td>[0x02008fff7000, 0x10007fff7fff]</td>
<td>HighShadow</td>
</tr>
<tr>
<td>[0x00008fff7000, 0x02008fff6fff]</td>
<td>ShadowGap</td>
</tr>
<tr>
<td>[0x00007fff8000, 0x00008fff6fff]</td>
<td>LowShadow</td>
</tr>
<tr>
<td>[0x000000000000, 0x00007fff7fff]</td>
<td>LowMem</td>
</tr>
</tbody>
</table>
<h2 id="32-bit"><a href="#32-bit" class="headerlink" title="32 bit"></a>32 bit</h2><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">Shadow</span> = (Mem &gt;&gt; 3) + 0x20000000;</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>[0x40000000, 0xffffffff]</th>
<th>HighMem</th>
</tr>
</thead>
<tbody>
<tr>
<td>[0x28000000, 0x3fffffff]</td>
<td>HighShadow</td>
</tr>
<tr>
<td>[0x24000000, 0x27ffffff]</td>
<td>ShadowGap</td>
</tr>
<tr>
<td>[0x20000000, 0x23ffffff]</td>
<td>LowShadow</td>
</tr>
<tr>
<td>[0x00000000, 0x1fffffff]</td>
<td>LowMem</td>
</tr>
</tbody>
</table>
<h2 id="超紧凑的阴影区"><a href="#超紧凑的阴影区" class="headerlink" title="超紧凑的阴影区"></a>超紧凑的阴影区</h2><p>使用更紧凑的阴影区内存也是可能的，比如：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">Shadow</span> = (Mem &gt;&gt; <span class="number">7</span>) | k<span class="literal">Off</span>set;</div></pre></td></tr></table></figure></p>
<p>还在实验中。</p>
<h2 id="报告错误"><a href="#报告错误" class="headerlink" title="报告错误"></a>报告错误</h2><p><code>ReportError</code> 可以被实现为一个调用（当前默认就是这样），但也有一些其它的，稍微更加高效和/或更加紧凑的方案。此刻默认的行为<strong>是</strong>：</p>
<ul>
<li>把失败地址拷贝到 <code>%rax</code> (<code>%eax</code>)</li>
<li>执行 <code>ud2</code> （产生 SIGILL）</li>
<li>在 <code>ud2</code> 之后的一个字节指令中编码访问类型和大小。整体上这 3 个指令需要 5-6 个字节的机器码。</li>
</ul>
<p>仅使用单个指令（比如 <code>ud2</code>）也是可能的，但这需要在运行时库中有一个完整的反汇编器（或一些其它的 hacks）。</p>
<h2 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h2><p>为了捕获栈溢出，<a href="https://github.com/google/sanitizers/wiki/AddressSanitizer" target="_blank" rel="external">AddressSanitizer</a> 插桩的代码像这样：</p>
<p>原始的代码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">char</span> a[<span class="number">8</span>];</div><div class="line">  ...</div><div class="line">  <span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>插桩后的代码：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">void foo() &#123;</div><div class="line">  char redzone1[<span class="number">32</span>];  <span class="comment">// 32-byte aligned</span></div><div class="line">  char a[<span class="number">8</span>];          <span class="comment">// 32-byte aligned</span></div><div class="line">  char redzone2[<span class="number">24</span>];</div><div class="line">  char redzone3[<span class="number">32</span>];  <span class="comment">// 32-byte aligned</span></div><div class="line">  int  *shadow_base = MemToShadow(redzone1);</div><div class="line">  shadow_base[<span class="number">0</span>] = <span class="number">0xffffffff</span>;  <span class="comment">// poison redzone1</span></div><div class="line">  shadow_base[<span class="number">1</span>] = <span class="number">0xffffff00</span>;  <span class="comment">// poison redzone2, unpoison 'a'</span></div><div class="line">  shadow_base[<span class="number">2</span>] = <span class="number">0xffffffff</span>;  <span class="comment">// poison redzone3</span></div><div class="line">  ...</div><div class="line">  shadow_base[<span class="number">0</span>] = shadow_base[<span class="number">1</span>] = shadow_base[<span class="number">2</span>] = <span class="number">0</span>; <span class="comment">// unpoison all</span></div><div class="line">  return;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="插桩的代码示例（x86-64）"><a href="#插桩的代码示例（x86-64）" class="headerlink" title="插桩的代码示例（x86_64）"></a>插桩的代码示例（x86_64）</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># long load8(long *a) &#123; return *a; &#125;</span></div><div class="line"><span class="number">0000000000000030</span> &lt;load8&gt;:</div><div class="line">  <span class="number">30</span>:	<span class="number">48</span> <span class="number">89</span> f8             	mov    %rdi,%rax</div><div class="line">  <span class="number">33</span>:	<span class="number">48</span> c1 e8 <span class="number">03</span>          	shr    $0x3,%rax</div><div class="line">  <span class="number">37</span>:	<span class="number">80</span> b8 <span class="number">00</span> <span class="number">80</span> ff <span class="number">7</span>f <span class="number">00</span> 	cmpb   $0<span class="keyword">x</span><span class="number">0</span>,<span class="number">0x7fff8000</span>(%rax)</div><div class="line">  <span class="number">3</span>e:	<span class="number">75</span> <span class="number">04</span>                	jne    <span class="number">44</span> &lt;load8+<span class="number">0x14</span>&gt;</div><div class="line">  <span class="number">40</span>:	<span class="number">48</span> <span class="number">8</span>b <span class="number">07</span>             	mov    (%rdi),%rax   &lt;&lt;&lt;&lt;&lt;&lt; original load</div><div class="line">  <span class="number">43</span>:	c3                   	retq   </div><div class="line">  <span class="number">44</span>:	<span class="number">52</span>                   	<span class="keyword">push</span>   %rdx</div><div class="line">  <span class="number">45</span>:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  __asan_report_load8</div></pre></td></tr></table></figure>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># int  load4(int *a)  &#123; return *a; &#125;</span></div><div class="line"><span class="number">0000000000000000</span> &lt;load4&gt;:</div><div class="line">   <span class="number">0</span>:	<span class="number">48</span> <span class="number">89</span> f8             	mov    %rdi,%rax</div><div class="line">   <span class="number">3</span>:	<span class="number">48</span> <span class="number">89</span> fa             	mov    %rdi,%rdx</div><div class="line">   <span class="number">6</span>:	<span class="number">48</span> c1 e8 <span class="number">03</span>          	shr    $0x3,%rax</div><div class="line">   a:	<span class="number">83</span> e2 <span class="number">07</span>             	<span class="keyword">and</span>    $0x7,%edx</div><div class="line">   d:	0f b6 <span class="number">80</span> <span class="number">00</span> <span class="number">80</span> ff <span class="number">7</span>f 	movzbl <span class="number">0x7fff8000</span>(%rax),%eax</div><div class="line">  <span class="number">14</span>:	<span class="number">83</span> c2 <span class="number">03</span>             	add    $0x3,%edx</div><div class="line">  <span class="number">17</span>:	<span class="number">38</span> c2                	cmp    %al,%dl</div><div class="line">  <span class="number">19</span>:	<span class="number">7</span>d <span class="number">03</span>                	jge    <span class="number">1</span>e &lt;load4+<span class="number">0x1e</span>&gt;</div><div class="line">  <span class="number">1</span>b:	<span class="number">8</span>b <span class="number">07</span>                	mov    (%rdi),%eax    &lt;&lt;&lt;&lt;&lt;&lt; original load</div><div class="line">  <span class="number">1</span>d:	c3                   	retq   </div><div class="line">  <span class="number">1</span>e:	<span class="number">84</span> c<span class="number">0</span>                	test   %al,%al</div><div class="line">  <span class="number">20</span>:	<span class="number">74</span> f9                	je     <span class="number">1</span>b &lt;load4+<span class="number">0x1b</span>&gt;</div><div class="line">  <span class="number">22</span>:	<span class="number">50</span>                   	<span class="keyword">push</span>   %rax</div><div class="line">  <span class="number">23</span>:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  __asan_report_load4</div></pre></td></tr></table></figure>
<h2 id="未对齐的访问"><a href="#未对齐的访问" class="headerlink" title="未对齐的访问"></a>未对齐的访问</h2><p>当前紧凑的映射将不捕获未对齐的部分越界访问：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> *x = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>]; <span class="comment">// 8 bytes: [0,7].</span></div><div class="line"><span class="keyword">int</span> *u = (<span class="keyword">int</span>*)((<span class="keyword">char</span>*)x + <span class="number">6</span>);</div><div class="line">*u = <span class="number">1</span>;  <span class="comment">// Access to range [6-9]</span></div></pre></td></tr></table></figure></p>
<p><a href="https://github.com/google/sanitizers/issues/100" target="_blank" rel="external">https://github.com/google/sanitizers/issues/100</a> 中描述了一个可行的方案，但它付出了性能的代价。</p>
<h2 id="运行时库"><a href="#运行时库" class="headerlink" title="运行时库"></a>运行时库</h2><h3 id="Malloc"><a href="#Malloc" class="headerlink" title="Malloc"></a>Malloc</h3><p>运行时库替换 <code>malloc</code>/<code>free</code>，并提供错误报告函数，如 <code>__asan_report_load8</code>。</p>
<p><code>malloc</code> 分配由红区围绕的请求数量的内存。阴影值对应的红区被下毒，主内存区域的阴影值被清除。</p>
<p><code>free</code> 用阴影值对整个区域下毒，并把内存块放入一个隔离区（这样在一定时间内这个内存块将不会再次被 malloc 返回）。</p>
<h2 id="二进制兼容性"><a href="#二进制兼容性" class="headerlink" title="二进制兼容性"></a>二进制兼容性</h2><p>二进制兼容性问题指的是，分别用 GCC 和 clang 编译的不同工程，它们之间存在依赖，或要一起使用时出现的问题。如本人遇到的场景，有一个用 clang 编译的动态链接库 A，有一个 GCC 编译的动态链接库 B，还有一个用 GCC 编译的 C/C++ 应用程序 C。它们之间的依赖关系为，B 依赖于 A，C 依赖于 A 和 B。其中只有编译 A 时，开启了 ASAN 以检查内存问题。</p>
<p>上述场景中，在用 CMake 通过 G++ 编译链接 C 应用程序时报出了如下的错误：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[<span class="number">100</span>%] Linking CXX executable AgoraSDKDemoApp</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_report_store4’未定义的引用</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_poison_cxx_array_cookie’未定义的引用</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_report_exp_store2’未定义的引用</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_stack_free_7’未定义的引用</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_report_exp_load_n’未定义的引用</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_load4’未定义的引用</div></pre></td></tr></table></figure></p>
<p>看上去是由于没有链接 ASAN 库的原因。通过为 G++ 加上对 ASAN 库的链接依赖（<code>-lasan</code>），再看一下。</p>
<p>这次的错误少了许多，但链接还是失败了：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">make</span></div><div class="line">[  <span class="number">5</span>%] Linking CXX shared library libAgoraSDKWrapper.<span class="keyword">so</span></div><div class="line">[ <span class="number">80</span>%] Built target AgoraSDKWrapper</div><div class="line">[ <span class="number">85</span>%] Linking CXX <span class="built_in">executable</span> AgoraSDKDemoDlApp</div><div class="line">[ <span class="number">90</span>%] Built target AgoraSDKDemoDlApp</div><div class="line">[ <span class="number">95</span>%] Linking CXX <span class="built_in">executable</span> AgoraSDKDemoApp</div><div class="line">/home/hanpfei/dev_data/home/hanpfei/data/CorpProjects/media_sdk_script/media_sdk3/app/linux/AgoraSDKDemo/libs/agora_media_sdk/libagora_rtc_sdk.<span class="keyword">so</span>：对‘__asan_unregister_elf_globals’未定义的引用</div><div class="line">/home/hanpfei/dev_data/home/hanpfei/data/CorpProjects/media_sdk_script/media_sdk3/app/linux/AgoraSDKDemo/libs/agora_media_sdk/libagora_rtc_sdk.<span class="keyword">so</span>：对‘__asan_register_elf_globals’未定义的引用</div><div class="line">collect2: error: ld returned <span class="number">1</span> <span class="keyword">exit</span> status</div><div class="line">CMakeFiles/AgoraSDKDemoApp.dir/build.<span class="keyword">make</span>:<span class="number">95</span>: recipe <span class="keyword">for</span> target <span class="string">'AgoraSDKDemoApp'</span> failed</div><div class="line"><span class="keyword">make</span>[<span class="number">2</span>]: *** [AgoraSDKDemoApp] Error <span class="number">1</span></div><div class="line">CMakeFiles/Makefile2:<span class="number">141</span>: recipe <span class="keyword">for</span> target <span class="string">'CMakeFiles/AgoraSDKDemoApp.dir/all'</span> failed</div><div class="line"><span class="keyword">make</span>[<span class="number">1</span>]: *** [CMakeFiles/AgoraSDKDemoApp.dir/<span class="keyword">all</span>] Error <span class="number">2</span></div><div class="line">Makefile:<span class="number">83</span>: recipe <span class="keyword">for</span> target <span class="string">'all'</span> failed</div><div class="line"><span class="keyword">make</span>: *** [<span class="keyword">all</span>] Error <span class="number">2</span></div></pre></td></tr></table></figure></p>
<p>为 B 和 C 工程的编译加上编译标记 <code>-fsanitize=address</code>，再次用 g++ 编译：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[<span class="number">100</span>%] Linking CXX <span class="built_in">executable</span> AgoraSDKDemoApp</div><div class="line">/home/hanpfei/dev_data/home/hanpfei/data/CorpProjects/media_sdk_script/media_sdk3/app/linux/AgoraSDKDemo/libs/agora_media_sdk/libagora_rtc_sdk.<span class="keyword">so</span>：对‘__asan_unregister_elf_globals’未定义的引用</div><div class="line">/home/hanpfei/dev_data/home/hanpfei/data/CorpProjects/media_sdk_script/media_sdk3/app/linux/AgoraSDKDemo/libs/agora_media_sdk/libagora_rtc_sdk.<span class="keyword">so</span>：对‘__asan_register_elf_globals’未定义的引用</div><div class="line">collect2: error: ld returned <span class="number">1</span> <span class="keyword">exit</span> status</div><div class="line">CMakeFiles/AgoraSDKDemoApp.dir/build.<span class="keyword">make</span>:<span class="number">95</span>: recipe <span class="keyword">for</span> target <span class="string">'AgoraSDKDemoApp'</span> failed</div><div class="line"><span class="keyword">make</span>[<span class="number">2</span>]: *** [AgoraSDKDemoApp] Error <span class="number">1</span></div><div class="line">CMakeFiles/Makefile2:<span class="number">141</span>: recipe <span class="keyword">for</span> target <span class="string">'CMakeFiles/AgoraSDKDemoApp.dir/all'</span> failed</div><div class="line"><span class="keyword">make</span>[<span class="number">1</span>]: *** [CMakeFiles/AgoraSDKDemoApp.dir/<span class="keyword">all</span>] Error <span class="number">2</span></div><div class="line">Makefile:<span class="number">83</span>: recipe <span class="keyword">for</span> target <span class="string">'all'</span> failed</div><div class="line"><span class="keyword">make</span>: *** [<span class="keyword">all</span>] Error <span class="number">2</span></div></pre></td></tr></table></figure></p>
<p>错误还是一样的。</p>
<p>为 g++ 添加 <code>-v</code> 参数，查看编译过程的详细信息，可以看到最后链接时执行的命令如下：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Configured <span class="symbol">with:</span> ../src/configure -v --with-pkgversion=<span class="string">'Ubuntu 7.4.0-1ubuntu1~18.04.1'</span> --with-bugurl=<span class="symbol">file:</span>/<span class="regexp">//usr</span><span class="regexp">/share/doc</span><span class="regexp">/gcc-7/</span>README.Bugs --enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++ --prefix=<span class="regexp">/usr --with-gcc-major-version-only --program-suffix=-7 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr</span><span class="regexp">/lib --without-included-gettext --enable-threads=posix --libdir=/usr</span><span class="regexp">/lib --enable-nls --with-sysroot=/</span> --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --enable-default-pie --with-system-zlib --with-target-system-zlib --enable-objc-gc=auto --enable-multiarch --disable-werror --with-arch-<span class="number">32</span>=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu</div><div class="line">Thread <span class="symbol">model:</span> posix</div><div class="line">gcc version <span class="number">7.4</span>.<span class="number">0</span> (Ubuntu <span class="number">7.4</span>.<span class="number">0</span>-<span class="number">1</span>ubuntu1~<span class="number">18.04</span>.<span class="number">1</span>) </div><div class="line">COMPILER_PATH=<span class="regexp">/usr/lib</span><span class="regexp">/gcc/x</span>86_64-linux-gnu/<span class="number">7</span>/<span class="symbol">:/usr/lib/gcc/x86_64-linux-gnu/</span><span class="number">7</span>/<span class="symbol">:/usr/lib/gcc/x86_64-linux-gnu/</span><span class="symbol">:/usr/lib/gcc/x86_64-linux-gnu/</span><span class="number">7</span>/<span class="symbol">:/usr/lib/gcc/x86_64-linux-gnu/</span></div><div class="line">LIBRARY_PATH=<span class="regexp">/usr/lib</span><span class="regexp">/gcc/x</span>86_64-linux-gnu/<span class="number">7</span>/<span class="symbol">:/usr/lib/gcc/x86_64-linux-gnu/</span><span class="number">7</span>/../../../x86_64-linux-gnu/<span class="symbol">:/usr/lib/gcc/x86_64-linux-gnu/</span><span class="number">7</span>/../../../../lib/<span class="symbol">:/lib/x86_64-linux-gnu/</span><span class="symbol">:/lib/</span>../lib/<span class="symbol">:/usr/lib/x86_64-linux-gnu/</span><span class="symbol">:/usr/lib/</span>../lib/<span class="symbol">:/usr/lib/gcc/x86_64-linux-gnu/</span><span class="number">7</span>/../../../<span class="symbol">:/lib/</span><span class="symbol">:/usr/lib/</span></div><div class="line">COLLECT_GCC_OPTIONS=<span class="string">'-std=c++11'</span> <span class="string">'-fsanitize=address'</span> <span class="string">'-v'</span> <span class="string">'-g'</span> <span class="string">'-o'</span> <span class="string">'AgoraSDKDemoApp'</span> <span class="string">'-L/usr/local/lib'</span> <span class="string">'-L/usr/local/lib64'</span> <span class="string">'-L/home/hanpfei/dev_data/home/hanpfei/data/CorpProjects/media_sdk_script/media_sdk3/app/linux/AgoraSDKDemo/libs/agora_media_sdk'</span> <span class="string">'-shared-libgcc'</span> <span class="string">'-mtune=generic'</span> <span class="string">'-march=x86-64'</span></div><div class="line"> /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7</span>/collect2 -plugin /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7</span>/liblto_plugin.so -plugin-opt=<span class="regexp">/usr/lib</span><span class="regexp">/gcc/x</span>86_64-linux-gnu/<span class="number">7</span>/lto-wrapper -plugin-opt=-fresolution=<span class="regexp">/tmp/ccz</span>W5GpK.res -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lgcc --sysroot=<span class="regexp">/ --build-id --eh-frame-hdr -m elf_x86_64 --hash-style=gnu --as-needed -dynamic-linker /lib</span>64/ld-linux-x86-<span class="number">64</span>.so.<span class="number">2</span> -pie -z now -z relro -o AgoraSDKDemoApp /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7</span>/../../../x86_64-linux-gnu/Scrt1.o /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7</span>/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7</span>/crtbeginS.o -L/usr/local/lib -L/usr/local/lib64 -L/home/hanpfei/dev_data/home/hanpfei/data/CorpProjects/media_sdk_script/media_sdk3/app/linux/AgoraSDKDemo/libs/agora_media_sdk -L/usr/lib/gcc/x86_64-linux-gnu/<span class="number">7</span> -L/usr/lib/gcc/x86_64-linux-gnu/<span class="number">7</span>/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/<span class="number">7</span>/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/<span class="number">7</span>/../../.. /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7</span>/libasan_preinit.o --push-state --no-as-needed -lasan --pop-state CMakeFiles/AgoraSDKDemoApp.dir/AgoraSDKDemoApp/src/main.cpp.o -rpath /usr/local/<span class="symbol">lib:</span>/usr/local/<span class="symbol">lib64:</span>/home/hanpfei/dev_data/home/hanpfei/data/CorpProjects/media_sdk_script/media_sdk3/app/linux/AgoraSDKDemo/libs/<span class="symbol">agora_media_sdk:</span>/home/hanpfei/dev_data/home/hanpfei/data/CorpProjects/media_sdk_script/media_sdk3/app/linux/AgoraSDKDemo/build -logg -lpthread -lopusfile -lopus -lagora_rtc_sdk -lpthread libAgoraSDKWrapper.so -lagora_rtc_sdk -logg -lpthread -lopusfile -lopus -lagora_rtc_sdk -lstdc++ -lm -lgcc_s -lgcc -lc -lgcc_s -lgcc /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7</span>/crtendS.o /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7</span>/../../../x86_64-linux-gnu/crtn.o</div><div class="line">/home/hanpfei/dev_data/home/hanpfei/data/CorpProjects/media_sdk_script/media_sdk3/app/linux/AgoraSDKDemo/libs/agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_unregister_elf_globals’未定义的引用</div><div class="line">/home/hanpfei/dev_data/home/hanpfei/data/CorpProjects/media_sdk_script/media_sdk3/app/linux/AgoraSDKDemo/libs/agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_register_elf_globals’未定义的引用</div><div class="line"><span class="symbol">collect2:</span> <span class="symbol">error:</span> ld returned <span class="number">1</span> exit status</div><div class="line">CMakeFiles/AgoraSDKDemoApp.dir/build.<span class="symbol">make:</span><span class="number">95</span>: recipe <span class="keyword">for</span> target <span class="string">'AgoraSDKDemoApp'</span> failed</div><div class="line">make[<span class="number">2</span>]: *** [AgoraSDKDemoApp] Error <span class="number">1</span></div><div class="line">CMakeFiles/<span class="symbol">Makefile2:</span><span class="number">141</span>: recipe <span class="keyword">for</span> target <span class="string">'CMakeFiles/AgoraSDKDemoApp.dir/all'</span> failed</div><div class="line">make[<span class="number">1</span>]: *** [CMakeFiles/AgoraSDKDemoApp.dir/all] Error <span class="number">2</span></div><div class="line"><span class="symbol">Makefile:</span><span class="number">83</span>: recipe <span class="keyword">for</span> target <span class="string">'all'</span> failed</div><div class="line"><span class="symbol">make:</span> *** [all] Error <span class="number">2</span></div></pre></td></tr></table></figure></p>
<p>通过 <code>readelf -s -W</code> 查看 g++ 链接的 asan 动态链接库中的符号：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ readelf -s -W /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">x86_64</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">libasan</span>.<span class="title">so</span>.4 | <span class="title">grep</span> <span class="title">asan_register</span></span></div><div class="line">   <span class="number">206</span>: <span class="number">0000000000036</span>cb0    <span class="number">21</span> FUNC    GLOBAL DEFAULT   <span class="number">12</span> __asan_register_globals</div><div class="line">   <span class="number">279</span>: <span class="number">0000000000037200</span>    <span class="number">44</span> FUNC    GLOBAL DEFAULT   <span class="number">12</span> __asan_register_image_globals</div></pre></td></tr></table></figure></p>
<p>确实没有看到上面报错信息中提到的 <code>__asan_unregister_elf_globals</code> 和 <code>__asan_register_elf_globals</code> 这两个符号。</p>
<p>不用 g++ 编译 B 和 C 工程，改用 clang，去掉对 ASAN 库的依赖：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span> warning generated.</div><div class="line">[ <span class="number">90</span>%] Linking CXX executable AgoraSDKDemoDlApp</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_report_store4’未定义的引用</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_poison_cxx_array_cookie’未定义的引用</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_report_exp_store2’未定义的引用</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_stack_free_7’未定义的引用</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_report_exp_load_n’未定义的引用</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_load4’未定义的引用</div></pre></td></tr></table></figure></p>
<p>遇到了和用 g++ 编译时遇到的同样的找不到 ASAN 的符号的问题。加上对 ASAN 库的依赖：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[ <span class="number">85</span>%] Linking CXX executable AgoraSDKDemoDlApp</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_unregister_elf_globals’未定义的引用</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk/libagora_rtc_sdk.so：对‘__asan_register_elf_globals’未定义的引用</div><div class="line"><span class="string">clang:</span> <span class="string">error:</span> linker command failed with exit code <span class="number">1</span> (use -v to see invocation)</div><div class="line">CMakeFiles<span class="regexp">/AgoraSDKDemoDlApp.dir/</span>build.<span class="string">make:</span><span class="number">95</span>: recipe <span class="keyword">for</span> target <span class="string">'AgoraSDKDemoDlApp'</span> failed</div></pre></td></tr></table></figure></p>
<p>遇到了和用 g++ 编译时遇到的相同的问题。为 B 和 C 工程的编译加上编译标记 <code>-fsanitize=address</code>，再次用 clang 编译，终于编译通过。然而在运行时却遇到了问题：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ build/AgoraSDKDemoDlApp  -m <span class="number">1</span> -h</div><div class="line">==<span class="number">33058</span>==Your <span class="built_in">application</span> <span class="keyword">is</span> linked <span class="keyword">against</span> incompatible ASan runtimes.</div></pre></td></tr></table></figure></p>
<p>用 clang 编译时，去掉对 ASAN 库的依赖。再次编译运行，终于 OK。给 clang++ 加上 <code>-v</code> 参数，可以看到最终的链接过程如下：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[<span class="number">100</span>%] Linking CXX executable AgoraSDKDemoApp</div><div class="line">clang version <span class="number">7.1</span><span class="number">.0</span>-svn353565<span class="number">-1</span>~exp1~<span class="number">20190406090509.61</span> (branches/release_70)</div><div class="line"><span class="string">Target:</span> x86_64-pc-linux-gnu</div><div class="line">Thread <span class="string">model:</span> posix</div><div class="line"><span class="string">InstalledDir:</span> <span class="regexp">/usr/</span>bin</div><div class="line">Found candidate GCC <span class="string">installation:</span> <span class="regexp">/usr/</span>bin<span class="regexp">/../</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu/<span class="number">7</span></div><div class="line">Found candidate GCC <span class="string">installation:</span> <span class="regexp">/usr/</span>bin<span class="regexp">/../</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span></div><div class="line">Found candidate GCC <span class="string">installation:</span> <span class="regexp">/usr/</span>bin<span class="regexp">/../</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu/<span class="number">8</span></div><div class="line">Found candidate GCC <span class="string">installation:</span> <span class="regexp">/usr/</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu/<span class="number">7</span></div><div class="line">Found candidate GCC <span class="string">installation:</span> <span class="regexp">/usr/</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span></div><div class="line">Found candidate GCC <span class="string">installation:</span> <span class="regexp">/usr/</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu/<span class="number">8</span></div><div class="line">Selected GCC <span class="string">installation:</span> <span class="regexp">/usr/</span>bin<span class="regexp">/../</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span></div><div class="line">Candidate <span class="string">multilib:</span> .;<span class="meta">@m</span>64</div><div class="line">Selected <span class="string">multilib:</span> .;<span class="meta">@m</span>64</div><div class="line"> <span class="string">"/usr/bin/ld"</span> -z relro --hash-style=gnu --build-id --eh-frame-hdr -m elf_x86_64 -dynamic-linker <span class="regexp">/lib64/</span>ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> -o AgoraSDKDemoApp <span class="regexp">/usr/</span>bin<span class="regexp">/../</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu<span class="regexp">/7.4.0/</span>..<span class="regexp">/../</span>..<span class="regexp">/x86_64-linux-gnu/</span>crt1.o <span class="regexp">/usr/</span>bin<span class="regexp">/../</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu<span class="regexp">/7.4.0/</span>..<span class="regexp">/../</span>..<span class="regexp">/x86_64-linux-gnu/</span>crti.o <span class="regexp">/usr/</span>bin<span class="regexp">/../</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu<span class="regexp">/7.4.0/</span>crtbegin.o -L<span class="regexp">/usr/</span>local<span class="regexp">/lib -L/</span>usr<span class="regexp">/local/</span>lib64 -L<span class="regexp">/home/</span>hanpfei<span class="regexp">/dev_data/</span>home<span class="regexp">/hanpfei/</span>data<span class="regexp">/CorpProjects/</span>media_sdk_script<span class="regexp">/media_sdk3/</span>app<span class="regexp">/linux/</span>AgoraSDKDemo<span class="regexp">/libs/</span>agora_media_sdk -L<span class="regexp">/usr/</span>bin<span class="regexp">/../</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu<span class="regexp">/7.4.0 -L/</span>usr<span class="regexp">/bin/</span>..<span class="regexp">/lib/</span>gcc<span class="regexp">/x86_64-linux-gnu/</span><span class="number">7.4</span><span class="number">.0</span><span class="regexp">/../</span>..<span class="regexp">/../</span>x86_64-linux-gnu -L<span class="regexp">/lib/</span>x86_64-linux-gnu -L<span class="regexp">/lib/</span>..<span class="regexp">/lib64 -L/</span>usr<span class="regexp">/lib/</span>x86_64-linux-gnu -L<span class="regexp">/usr/</span>bin<span class="regexp">/../</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu<span class="regexp">/7.4.0/</span>..<span class="regexp">/../</span>.. -L<span class="regexp">/usr/</span>lib<span class="regexp">/llvm-7/</span>bin<span class="regexp">/../</span>lib -L<span class="regexp">/lib -L/</span>usr<span class="regexp">/lib --whole-archive /</span>usr<span class="regexp">/lib/</span>llvm<span class="number">-7</span><span class="regexp">/lib/</span>clang<span class="regexp">/7.1.0/</span>lib<span class="regexp">/linux/</span>libclang_rt.asan-x86_64.a --no-whole-archive --dynamic-list=<span class="regexp">/usr/</span>lib<span class="regexp">/llvm-7/</span>lib<span class="regexp">/clang/</span><span class="number">7.1</span><span class="number">.0</span><span class="regexp">/lib/</span>linux<span class="regexp">/libclang_rt.asan-x86_64.a.syms --whole-archive /</span>usr<span class="regexp">/lib/</span>llvm<span class="number">-7</span><span class="regexp">/lib/</span>clang<span class="regexp">/7.1.0/</span>lib<span class="regexp">/linux/</span>libclang_rt.asan_cxx-x86_64.a --no-whole-archive --dynamic-list=<span class="regexp">/usr/</span>lib<span class="regexp">/llvm-7/</span>lib<span class="regexp">/clang/</span><span class="number">7.1</span><span class="number">.0</span><span class="regexp">/lib/</span>linux<span class="regexp">/libclang_rt.asan_cxx-x86_64.a.syms CMakeFiles/</span>AgoraSDKDemoApp.dir<span class="regexp">/AgoraSDKDemoApp/</span>src<span class="regexp">/main.cpp.o -rpath /</span>usr<span class="regexp">/local/</span><span class="string">lib:</span><span class="regexp">/usr/</span>local<span class="regexp">/lib64:/</span>home<span class="regexp">/hanpfei/</span>dev_data<span class="regexp">/home/</span>hanpfei<span class="regexp">/data/</span>CorpProjects<span class="regexp">/media_sdk_script/</span>media_sdk3<span class="regexp">/app/</span>linux<span class="regexp">/AgoraSDKDemo/</span>libs<span class="regexp">/agora_media_sdk:/</span>home<span class="regexp">/hanpfei/</span>dev_data<span class="regexp">/home/</span>hanpfei<span class="regexp">/data/</span>CorpProjects<span class="regexp">/media_sdk_script/</span>media_sdk3<span class="regexp">/app/</span>linux<span class="regexp">/AgoraSDKDemo/</span>build -logg -lpthread -lopusfile -lopus -lagora_rtc_sdk -lpthread libAgoraSDKWrapper.so -lagora_rtc_sdk -logg -lpthread -lopusfile -lopus -lagora_rtc_sdk -lstdc++ -lm --no-<span class="keyword">as</span>-needed -lpthread -lrt -lm -ldl -lgcc_s -lgcc -lc -lgcc_s -lgcc <span class="regexp">/usr/</span>bin<span class="regexp">/../</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu<span class="regexp">/7.4.0/</span>crtend.o <span class="regexp">/usr/</span>bin<span class="regexp">/../</span>lib<span class="regexp">/gcc/</span>x86_64-linux-gnu<span class="regexp">/7.4.0/</span>..<span class="regexp">/../</span>..<span class="regexp">/x86_64-linux-gnu/</span>crtn.o</div><div class="line">[<span class="number">100</span>%] Built target AgoraSDKDemoApp</div></pre></td></tr></table></figure></p>
<p>clang 链接了 <code>/usr/lib/llvm-7/lib/clang/7.1.0/lib/linux/libclang_rt.asan-x86_64.a</code>。</p>
<p>总结一下，有一个用 clang 编译，且开启了 ASAN debug 的库，在用 g++ 编译依赖该库的库和应用时遇到链接问题，尝试的几种方法的实际结果：</p>
<ul>
<li><ol>
<li>g++ 直接编译 ===&gt; 失败，找不到所有的 ASAN 符号</li>
</ol>
</li>
<li><ol>
<li>g++ + 链接 asan 库 ===&gt; 失败，找不到符号 <code>__asan_unregister_elf_globals</code> 和 <code>__asan_register_elf_globals</code>。</li>
</ol>
</li>
<li><ol>
<li>g++ + <code>-fsanitize=address</code> 标记 ===&gt; 失败，和链接 asan 库遇到相同的链接错误。</li>
</ol>
</li>
<li><ol>
<li>clang++ 直接编译 ===&gt; 失败，与 1 中遇到的相同的错误。</li>
</ol>
</li>
<li><ol>
<li>clang++ + 链接 asan 库 ===&gt; 失败，与 2 中遇到的相同的错误。</li>
</ol>
</li>
<li><ol>
<li>clang++ + 链接 asan 库 + <code>-fsanitize=address</code> 标记 ===&gt; 编译成功，但运行失败。</li>
</ol>
</li>
<li><ol>
<li><strong>clang++ + <code>-fsanitize=address</code> 标记 ===&gt; 编译成功，运行成功，PASS</strong>。</li>
</ol>
</li>
</ul>
<p>因而，需要用 clang++ + <code>-fsanitize=address</code> 标记编译。</p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li><a href="http://clang.llvm.org/docs/AddressSanitizer.html" target="_blank" rel="external">Clang AddressSanitizer</a></li>
<li><a href="https://github.com/google/sanitizers/wiki/AddressSanitizerAlgorithm" target="_blank" rel="external">AddressSanitizerAlgorithm</a></li>
<li><a href="http://llvm.org/docs/CommandGuide/llvm-symbolizer.html" target="_blank" rel="external">llvm-symbolizer</a></li>
<li><a href="https://www.jianshu.com/p/3a2df9b7c353" target="_blank" rel="external">Address Sanitizer 用法</a></li>
<li><a href="https://github.com/google/sanitizers" target="_blank" rel="external">sanitizers</a></li>
<li><a href="https://github.com/google/sanitizers/wiki/AddressSanitizerExampleHeapOutOfBounds" target="_blank" rel="external">AddressSanitizerExampleHeapOutOfBounds</a></li>
<li><a href="https://github.com/google/sanitizers/wiki/AddressSanitizerCallStack" target="_blank" rel="external">AddressSanitizerCallStack</a></li>
<li><a href="http://apt.llvm.org/" target="_blank" rel="external">LLVM Debian/Ubuntu nightly packages</a></li>
</ul>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wxpay.png" alt="Han Pengfei 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Han Pengfei 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/C-C-开发/" rel="tag"># C/C++开发</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/01/c_cpp_args_parsing/" rel="next" title="C/C++ 命令行参数解析库选型">
                <i class="fa fa-chevron-left"></i> C/C++ 命令行参数解析库选型
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/03/fetch_webrtc_source_code/" rel="prev" title="无需翻墙的 WebRTC 源码下载">
                无需翻墙的 WebRTC 源码下载 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/freesoft.jpg"
                alt="Han Pengfei" />
            
              <p class="site-author-name" itemprop="name">Han Pengfei</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">207</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/hanpfei" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.douban.com/people/3681478/" target="_blank" title="豆瓣"><i class="fa fa-fw fa-globe"></i>豆瓣</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/han-peng-fei-49" target="_blank" title="知乎"><i class="fa fa-fw fa-globe"></i>知乎</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:hanpfei@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#AddressSanitizer-的使用"><span class="nav-number">1.</span> <span class="nav-text">AddressSanitizer 的使用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#符号化输出"><span class="nav-number">2.</span> <span class="nav-text">符号化输出</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AddressSanitizer-算法"><span class="nav-number">3.</span> <span class="nav-text">AddressSanitizer 算法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#简单的版本"><span class="nav-number">3.1.</span> <span class="nav-text">简单的版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内存映射"><span class="nav-number">3.2.</span> <span class="nav-text">内存映射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#映射"><span class="nav-number">3.3.</span> <span class="nav-text">映射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#64-bit"><span class="nav-number">3.4.</span> <span class="nav-text">64-bit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#32-bit"><span class="nav-number">3.5.</span> <span class="nav-text">32 bit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#超紧凑的阴影区"><span class="nav-number">3.6.</span> <span class="nav-text">超紧凑的阴影区</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#报告错误"><span class="nav-number">3.7.</span> <span class="nav-text">报告错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#栈"><span class="nav-number">3.8.</span> <span class="nav-text">栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#插桩的代码示例（x86-64）"><span class="nav-number">3.9.</span> <span class="nav-text">插桩的代码示例（x86_64）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#未对齐的访问"><span class="nav-number">3.10.</span> <span class="nav-text">未对齐的访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行时库"><span class="nav-number">3.11.</span> <span class="nav-text">运行时库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Malloc"><span class="nav-number">3.11.1.</span> <span class="nav-text">Malloc</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二进制兼容性"><span class="nav-number">3.12.</span> <span class="nav-text">二进制兼容性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#参考文档"><span class="nav-number">3.12.1.</span> <span class="nav-text">参考文档</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016.09.16 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Han Pengfei</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.3"></script>



  



	





  





  









<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 's9sbM9ODdusCzKcm5JcIj6t8-gzGzoHsz',
    appKey: 'UoO9ia1DLNwOXRUsTBQ6QXxm',
    placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true,
    lang: '' || 'zh-cn'
  });
</script>


  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

</body>
</html>
