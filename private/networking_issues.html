<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Android 网络异常 | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android 网络异常</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Android 网络异常</h1><div class="post-content"><p>注：OkHttp 代码基于 OkHttp 3.4 分析。Android 代码基于 Android 6.0.0_r26 分析。</p>
<a id="more"></a>
<h1 id="UnknownHostException"><a href="#UnknownHostException" class="headerlink" title="UnknownHostException"></a>UnknownHostException</h1><p><strong>错误说明：</strong> 域名解析失败。</p>
<p><strong>错误消息：</strong> Unable to resolve host “m9.music.126.net”: No address associated with hostname</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>网络断开；</li>
<li>DNS 服务器意外挂掉；</li>
<li>DNS 服务器故障。</li>
</ul>
<p>DNS 服务器挂掉或者故障这种问题比较少见，然而之前确实发生过大范围的 DNS 服务器问题。</p>
<p>针对这些原因，我们可以做一些模拟测试。</p>
<h2 id="网络断开验证"><a href="#网络断开验证" class="headerlink" title="网络断开验证"></a>网络断开验证</h2><p>对于网络连接断开的情况，我们采用如下的方法来模拟测试：</p>
<ul>
<li>关闭手机的 WiFi 和移动网络，也就是使手机处于完全断网的情况；</li>
<li>执行一个 HTTP 请求。</li>
</ul>
<p>以 OkHttp 为例，在请求开始之后，立即就报出了如下的异常：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">java<span class="selector-class">.net</span><span class="selector-class">.UnknownHostException</span>: Unable to resolve host <span class="string">"www.wolfcstech.com"</span>: No <span class="selector-tag">address</span> associated with hostname</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.InetAddress</span><span class="selector-class">.lookupHostByName</span>(InetAddress<span class="selector-class">.java</span>:<span class="number">470</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.InetAddress</span><span class="selector-class">.getAllByNameImpl</span>(InetAddress<span class="selector-class">.java</span>:<span class="number">252</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.InetAddress</span><span class="selector-class">.getAllByName</span>(InetAddress<span class="selector-class">.java</span>:<span class="number">215</span>)</div><div class="line">    at okhttp3.Dns$<span class="number">1</span>.lookup(Dns<span class="selector-class">.java</span>:<span class="number">39</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.netlib</span><span class="selector-class">.OkHttp3Utils</span><span class="variable">$MyDns</span>.lookup(OkHttp3Utils<span class="selector-class">.java</span>:<span class="number">45</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RouteSelector</span><span class="selector-class">.resetNextInetSocketAddress</span>(RouteSelector<span class="selector-class">.java</span>:<span class="number">170</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RouteSelector</span><span class="selector-class">.nextProxy</span>(RouteSelector<span class="selector-class">.java</span>:<span class="number">136</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RouteSelector</span><span class="selector-class">.next</span>(RouteSelector<span class="selector-class">.java</span>:<span class="number">81</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">171</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findHealthyConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">121</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.newStream</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">100</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.ConnectInterceptor</span><span class="selector-class">.intercept</span>(ConnectInterceptor<span class="selector-class">.java</span>:<span class="number">42</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.cache</span><span class="selector-class">.CacheInterceptor</span><span class="selector-class">.intercept</span>(CacheInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.BridgeInterceptor</span><span class="selector-class">.intercept</span>(BridgeInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RetryAndFollowUpInterceptor</span><span class="selector-class">.intercept</span>(RetryAndFollowUpInterceptor<span class="selector-class">.java</span>:<span class="number">120</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.netlib</span><span class="selector-class">.OkHttp3Utils</span><span class="variable">$MyInterceptor</span>.intercept(OkHttp3Utils<span class="selector-class">.java</span>:<span class="number">29</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.RealCall</span><span class="selector-class">.getResponseWithInterceptorChain</span>(RealCall<span class="selector-class">.java</span>:<span class="number">179</span>)</div><div class="line">    at okhttp3.RealCall<span class="variable">$AsyncCall</span>.execute(RealCall<span class="selector-class">.java</span>:<span class="number">129</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.NamedRunnable</span><span class="selector-class">.run</span>(NamedRunnable<span class="selector-class">.java</span>:<span class="number">32</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1113</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.run(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">588</span>)</div><div class="line">    at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">833</span>)</div><div class="line">Caused by: android<span class="selector-class">.system</span><span class="selector-class">.GaiException</span>: android_getaddrinfo failed: EAI_NODATA (No <span class="selector-tag">address</span> associated with hostname)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.Posix</span><span class="selector-class">.android_getaddrinfo</span>(Native Method)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.ForwardingOs</span><span class="selector-class">.android_getaddrinfo</span>(ForwardingOs<span class="selector-class">.java</span>:<span class="number">55</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.InetAddress</span><span class="selector-class">.lookupHostByName</span>(InetAddress<span class="selector-class">.java</span>:<span class="number">451</span>)</div><div class="line">	... <span class="number">30</span> more</div></pre></td></tr></table></figure></p>
<h2 id="DNS-服务器意外挂掉验证"><a href="#DNS-服务器意外挂掉验证" class="headerlink" title="DNS 服务器意外挂掉验证"></a>DNS 服务器意外挂掉验证</h2><p>对于DNS 服务器意外挂掉的情况，我们采用如下的方法模拟测试：</p>
<ul>
<li>连接 WiFi，设置手机的 IP 地址为静态 IP 地址，不修改之前 DHCP 分配的 IP 地址，但设置 DNS 服务器地址为无效的地址；</li>
<li>执行一个 HTTP 请求。</li>
</ul>
<p>以 OkHttp 为例，在请求开始之后，将报出如下的异常：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">java<span class="selector-class">.net</span><span class="selector-class">.UnknownHostException</span>: Unable to resolve host <span class="string">"www.wolfcstech.com"</span>: No <span class="selector-tag">address</span> associated with hostname</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.InetAddress</span><span class="selector-class">.lookupHostByName</span>(InetAddress<span class="selector-class">.java</span>:<span class="number">470</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.InetAddress</span><span class="selector-class">.getAllByNameImpl</span>(InetAddress<span class="selector-class">.java</span>:<span class="number">252</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.InetAddress</span><span class="selector-class">.getAllByName</span>(InetAddress<span class="selector-class">.java</span>:<span class="number">215</span>)</div><div class="line">    at okhttp3.Dns$<span class="number">1</span>.lookup(Dns<span class="selector-class">.java</span>:<span class="number">39</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.netlib</span><span class="selector-class">.OkHttp3Utils</span><span class="variable">$MyDns</span>.lookup(OkHttp3Utils<span class="selector-class">.java</span>:<span class="number">45</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RouteSelector</span><span class="selector-class">.resetNextInetSocketAddress</span>(RouteSelector<span class="selector-class">.java</span>:<span class="number">170</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RouteSelector</span><span class="selector-class">.nextProxy</span>(RouteSelector<span class="selector-class">.java</span>:<span class="number">136</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RouteSelector</span><span class="selector-class">.next</span>(RouteSelector<span class="selector-class">.java</span>:<span class="number">81</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">171</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findHealthyConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">121</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.newStream</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">100</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.ConnectInterceptor</span><span class="selector-class">.intercept</span>(ConnectInterceptor<span class="selector-class">.java</span>:<span class="number">42</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.cache</span><span class="selector-class">.CacheInterceptor</span><span class="selector-class">.intercept</span>(CacheInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.BridgeInterceptor</span><span class="selector-class">.intercept</span>(BridgeInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RetryAndFollowUpInterceptor</span><span class="selector-class">.intercept</span>(RetryAndFollowUpInterceptor<span class="selector-class">.java</span>:<span class="number">120</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.netlib</span><span class="selector-class">.OkHttp3Utils</span><span class="variable">$MyInterceptor</span>.intercept(OkHttp3Utils<span class="selector-class">.java</span>:<span class="number">29</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.RealCall</span><span class="selector-class">.getResponseWithInterceptorChain</span>(RealCall<span class="selector-class">.java</span>:<span class="number">179</span>)</div><div class="line">    at okhttp3.RealCall<span class="variable">$AsyncCall</span>.execute(RealCall<span class="selector-class">.java</span>:<span class="number">129</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.NamedRunnable</span><span class="selector-class">.run</span>(NamedRunnable<span class="selector-class">.java</span>:<span class="number">32</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1113</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.run(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">588</span>)</div><div class="line">    at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">833</span>)</div><div class="line">Caused by: android<span class="selector-class">.system</span><span class="selector-class">.GaiException</span>: android_getaddrinfo failed: EAI_NODATA (No <span class="selector-tag">address</span> associated with hostname)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.Posix</span><span class="selector-class">.android_getaddrinfo</span>(Native Method)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.ForwardingOs</span><span class="selector-class">.android_getaddrinfo</span>(ForwardingOs<span class="selector-class">.java</span>:<span class="number">55</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.InetAddress</span><span class="selector-class">.lookupHostByName</span>(InetAddress<span class="selector-class">.java</span>:<span class="number">451</span>)</div><div class="line">	... <span class="number">30</span> more</div></pre></td></tr></table></figure></p>
<p>这个异常与网络断开情况下报出的异常一模一样，然而这一次从请求开始执行到异常报出，经历的时间则要长得多，如我们上面看到的，这段时间长达 40 s。</p>
<h2 id="DNS-服务器故障验证"><a href="#DNS-服务器故障验证" class="headerlink" title="DNS 服务器故障验证"></a>DNS 服务器故障验证</h2><p>DNS 服务器故障主要是指 DNS 服务器确实查不到所请求的域名，可能是 DNS 服务器出了问题，也可能是为域名做的 DNS 配置还没有生效等。</p>
<p>对于这种情况，我们采用如下方法模拟测试：</p>
<ul>
<li>手机正常连接网络；</li>
<li>以一个不存在的域名执行一个 HTTP 请求。</li>
</ul>
<p>请求执行之后，将报出如下异常：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">java<span class="selector-class">.net</span><span class="selector-class">.UnknownHostException</span>: Unable to resolve host <span class="string">"www.wolfcsteach.com"</span>: No <span class="selector-tag">address</span> associated with hostname</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.InetAddress</span><span class="selector-class">.lookupHostByName</span>(InetAddress<span class="selector-class">.java</span>:<span class="number">470</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.InetAddress</span><span class="selector-class">.getAllByNameImpl</span>(InetAddress<span class="selector-class">.java</span>:<span class="number">252</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.InetAddress</span><span class="selector-class">.getAllByName</span>(InetAddress<span class="selector-class">.java</span>:<span class="number">215</span>)</div><div class="line">    at okhttp3.Dns$<span class="number">1</span>.lookup(Dns<span class="selector-class">.java</span>:<span class="number">39</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.netlib</span><span class="selector-class">.OkHttp3Utils</span><span class="variable">$MyDns</span>.lookup(OkHttp3Utils<span class="selector-class">.java</span>:<span class="number">45</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RouteSelector</span><span class="selector-class">.resetNextInetSocketAddress</span>(RouteSelector<span class="selector-class">.java</span>:<span class="number">170</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RouteSelector</span><span class="selector-class">.nextProxy</span>(RouteSelector<span class="selector-class">.java</span>:<span class="number">136</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RouteSelector</span><span class="selector-class">.next</span>(RouteSelector<span class="selector-class">.java</span>:<span class="number">81</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">171</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findHealthyConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">121</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.newStream</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">100</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.ConnectInterceptor</span><span class="selector-class">.intercept</span>(ConnectInterceptor<span class="selector-class">.java</span>:<span class="number">42</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.cache</span><span class="selector-class">.CacheInterceptor</span><span class="selector-class">.intercept</span>(CacheInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.BridgeInterceptor</span><span class="selector-class">.intercept</span>(BridgeInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RetryAndFollowUpInterceptor</span><span class="selector-class">.intercept</span>(RetryAndFollowUpInterceptor<span class="selector-class">.java</span>:<span class="number">120</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.netlib</span><span class="selector-class">.OkHttp3Utils</span><span class="variable">$MyInterceptor</span>.intercept(OkHttp3Utils<span class="selector-class">.java</span>:<span class="number">29</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.RealCall</span><span class="selector-class">.getResponseWithInterceptorChain</span>(RealCall<span class="selector-class">.java</span>:<span class="number">179</span>)</div><div class="line">    at okhttp3.RealCall<span class="variable">$AsyncCall</span>.execute(RealCall<span class="selector-class">.java</span>:<span class="number">129</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.NamedRunnable</span><span class="selector-class">.run</span>(NamedRunnable<span class="selector-class">.java</span>:<span class="number">32</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1113</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.run(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">588</span>)</div><div class="line">    at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">833</span>)</div><div class="line">Caused by: android<span class="selector-class">.system</span><span class="selector-class">.GaiException</span>: android_getaddrinfo failed: EAI_NODATA (No <span class="selector-tag">address</span> associated with hostname)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.Posix</span><span class="selector-class">.android_getaddrinfo</span>(Native Method)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.ForwardingOs</span><span class="selector-class">.android_getaddrinfo</span>(ForwardingOs<span class="selector-class">.java</span>:<span class="number">55</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.InetAddress</span><span class="selector-class">.lookupHostByName</span>(InetAddress<span class="selector-class">.java</span>:<span class="number">451</span>)</div><div class="line">	... <span class="number">30</span> more</div></pre></td></tr></table></figure></p>
<p>可以看到，在这种情况下，异常报出与请求开始执行之间的时间差也非常小。如上面的例子，这个时间差只有 25 ms，甚至比网络断开情况下的 112 ms 还要短。</p>
<h2 id="所需诊断信息"><a href="#所需诊断信息" class="headerlink" title="所需诊断信息"></a>所需诊断信息</h2><p>依据上面的测试分析，诊断域名解析问题，需要如下诊断信息：</p>
<ul>
<li>请求开始时间；</li>
<li>异常报出时间；</li>
<li>网络是否连接；</li>
<li>DNS 服务器 IP 地址列表；</li>
<li>DNS 服务器是否可用（ping DNS 服务器 IP地址的结果）；</li>
<li>DNS 的结果（nslookup 结果）。</li>
</ul>
<h1 id="ConnectTimeoutException"><a href="#ConnectTimeoutException" class="headerlink" title="ConnectTimeoutException"></a>ConnectTimeoutException</h1><p><strong>等价异常类型：</strong> </p>
<ul>
<li>org.apache.http.conn.ConnectTimeoutException</li>
<li>com.netease.mam.org.apache.http.conn.ConnectTimeoutException</li>
</ul>
<p><strong>错误说明：</strong> 连接超时</p>
<p><strong>错误消息：</strong> Connect to /183.214.133.45:443 timed out</p>
<p><strong>异常分析：</strong></p>
<p>异常在 <code>external/apache-http/src/org/apache/http/conn/scheme/PlainSocketFactory.java</code> 的 <code>connectSocket()</code> 中，apache httpclient 抛出，由 <code>Socket.connect()</code> 中抛出的 <code>SocketTimeoutException</code> 引起。</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>设备接入的网络本身带宽比较低；</li>
<li>设备接入的网络本身延迟比较高；</li>
<li>设备与服务器的网络路径中存在比较拥堵、负载比较重的节点；</li>
<li>网络中路由节点的临时性异常。</li>
</ul>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>Traceroute 获取的网络路径信息。</li>
<li>网络路径上不同节点的繁忙程度，可通过丢包率来近似地反映。</li>
<li>网络连接条件（移动网络/WiFI），网络延时及带宽。</li>
</ul>
<h1 id="SocketTimeoutException"><a href="#SocketTimeoutException" class="headerlink" title="SocketTimeoutException"></a>SocketTimeoutException</h1><p><strong>异常：</strong> java.net.SocketTimeoutException</p>
<p><strong>错误说明：</strong> socket 超时</p>
<p><strong>异常分析：</strong></p>
<p>在 OkHttp 处理 HTTP/2 的逻辑 (<code>okhttp3.internal.http2.Http2Stream</code>) 中，会由于读超时、写超时而抛出该异常。<br>在 Android 中，<code>java.net.PlainSocketImpl</code> 的 <code>accept(SocketImpl newImpl)</code> 执行失败，如果 <code>errno</code> 为 <code>EAGAIN</code> 将抛出该异常，如果使用 nio 的 <code>ServerSocketChannelImpl</code>，异常将不会被实际抛出；此外，在阻塞 Socket 上读取长度为 0 的数据时抛出此异常。<br><code>libcore.io.IoBridge</code> 中，TCP 连接建立超时，将抛出该异常。<code>libcore.io.IoBridge</code> 中，接收数据失败，会由于 <code>errno</code> 为 <code>EAGAIN</code> 抛出该异常。<br>在 <code>external/conscrypt/src/main/native/org_conscrypt_NativeCrypto.cpp</code> 中执行 SSL/TLS 握手动作、数据读操作或数据写操作超时，会抛出该异常。</p>
<h2 id="子错误-读超时"><a href="#子错误-读超时" class="headerlink" title="子错误 - 读超时"></a>子错误 - 读超时</h2><p><strong>错误消息：</strong> Read timed out</p>
<p><strong>异常分析：</strong></p>
<p>在 <code>external/conscrypt/src/main/native/org_conscrypt_NativeCrypto.cpp</code> 中执行 SSL/TLS 数据读操作超时，抛出该异常。</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>设备接入的网络本身带宽比较低；</li>
<li>设备接入的网络本身延迟比较高；</li>
<li>设备与服务器的网络路径中存在比较拥堵、负载比较重的节点；</li>
<li>网络中路由节点的临时性异常。</li>
</ul>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>Traceroute 获取的网络路径信息。</li>
<li>网络路径上不同节点的繁忙程度，可通过丢包率来近似地反映。</li>
<li>网络连接条件（移动网络/WiFI），网络延时及带宽。</li>
</ul>
<h2 id="子错误-SSL-握手超时"><a href="#子错误-SSL-握手超时" class="headerlink" title="子错误 - SSL 握手超时"></a>子错误 - SSL 握手超时</h2><p><strong>错误消息：</strong> SSL handshake timed out</p>
<p><strong>异常分析：</strong></p>
<p>在 <code>external/conscrypt/src/main/native/org_conscrypt_NativeCrypto.cpp</code> 中执行 SSL/TLS 握手动作超时，抛出该异常。</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>设备接入的网络本身带宽比较低；</li>
<li>设备接入的网络本身延迟比较高；</li>
<li>设备与服务器的网络路径中存在比较拥堵、负载比较重的节点；</li>
<li>网络中路由节点的临时性异常。</li>
</ul>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>Traceroute 获取的网络路径信息。</li>
<li>网络路径上不同节点的繁忙程度，可通过丢包率来近似地反映。</li>
<li>网络连接条件（移动网络/WiFI），网络延时及带宽。</li>
</ul>
<h2 id="子错误-未知原因"><a href="#子错误-未知原因" class="headerlink" title="子错误 - 未知原因"></a>子错误 - 未知原因</h2><p><strong>错误消息：</strong> null</p>
<p><strong>异常分析：</strong></p>
<p>根据 <code>SocketTimeoutException</code> 抛出的所有情况综合来看，这种异常主要由 HTTP 请求读操作执行超时引起。</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>设备接入的网络本身带宽比较低；</li>
<li>设备接入的网络本身延迟比较高；</li>
<li>设备与服务器的网络路径中存在比较拥堵、负载比较重的节点；</li>
<li>网络中路由节点的临时性异常。</li>
</ul>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>更加完整的异常堆栈</li>
<li>Traceroute 获取的网络路径信息。</li>
<li>网络路径上不同节点的繁忙程度，可通过丢包率来近似地反映。</li>
<li>网络连接条件（移动网络/WiFI），网络延时及带宽。</li>
</ul>
<h1 id="HttpHostConnectException"><a href="#HttpHostConnectException" class="headerlink" title="HttpHostConnectException"></a>HttpHostConnectException</h1><p><strong>等价异常类型：</strong></p>
<ul>
<li>org.apache.http.conn.HttpHostConnectException</li>
<li>com.netease.mam.org.apache.http.conn.HttpHostConnectException</li>
</ul>
<p><strong>错误说明：</strong> 客户端的数据包可以到达目标主机，但由于各种原因，连接建立失败的问题。</p>
<p><strong>错误消息：</strong> Connection to <a href="http://m7.music.126.net" target="_blank" rel="external">http://m7.music.126.net</a> refused</p>
<p><strong>可能原因：</strong> </p>
<ul>
<li>连接的目标主机没有开对应的端口，可能服务器发生故障</li>
<li>客户端设置了代理，而代理进程并没有跑起来。</li>
</ul>
<p>针对这些原因，我们也可以做一些模拟和测试。</p>
<h2 id="服务器故障验证"><a href="#服务器故障验证" class="headerlink" title="服务器故障验证"></a>服务器故障验证</h2><p>对于这种情况，我们采用如下的方法来模拟测试，</p>
<ul>
<li>指定我们执行 HTTP 请求时访问的端口为一个无效的端口，如使用 <a href="https://www.wolfcstech.com:8080/2017/04/13/%E5%88%9D%E5%A7%8BDNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9C%B0%E5%9D%80%E6%98%AF%E5%93%AA%E9%87%8C%E6%9D%A5%E7%9A%84/">URL</a> ；</li>
<li>以 <strong>HttpClient</strong> 作为我们的 HttpStack 来执行 HTTP 请求。</li>
</ul>
<p>请求执行之后，将报出如下异常：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.conn</span><span class="selector-class">.HttpHostConnectException</span>: Connection to https:<span class="comment">//www.wolfcstech.com:8080 refused</span></div><div class="line">    at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.conn</span><span class="selector-class">.DefaultClientConnectionOperator</span><span class="selector-class">.openConnection</span>(DefaultClientConnectionOperator<span class="selector-class">.java</span>:<span class="number">193</span>)</div><div class="line">    at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.conn</span><span class="selector-class">.AbstractPoolEntry</span><span class="selector-class">.open</span>(AbstractPoolEntry<span class="selector-class">.java</span>:<span class="number">169</span>)</div><div class="line">    at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.conn</span><span class="selector-class">.AbstractPooledConnAdapter</span><span class="selector-class">.open</span>(AbstractPooledConnAdapter<span class="selector-class">.java</span>:<span class="number">124</span>)</div><div class="line">    at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.client</span><span class="selector-class">.DefaultRequestDirector</span><span class="selector-class">.execute</span>(DefaultRequestDirector<span class="selector-class">.java</span>:<span class="number">366</span>)</div><div class="line">    at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.client</span><span class="selector-class">.AbstractHttpClient</span><span class="selector-class">.execute</span>(AbstractHttpClient<span class="selector-class">.java</span>:<span class="number">596</span>)</div><div class="line">    at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.client</span><span class="selector-class">.AbstractHttpClient</span><span class="selector-class">.execute</span>(AbstractHttpClient<span class="selector-class">.java</span>:<span class="number">517</span>)</div><div class="line">    at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.client</span><span class="selector-class">.AbstractHttpClient</span><span class="selector-class">.execute</span>(AbstractHttpClient<span class="selector-class">.java</span>:<span class="number">495</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.volleydemo</span><span class="selector-class">.HttpClientUtils</span><span class="selector-class">.httpGet</span>(HttpClientUtils<span class="selector-class">.java</span>:<span class="number">21</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.volleydemo</span><span class="selector-class">.MainActivity</span><span class="variable">$HttpClientTask</span>.doInBackground(MainActivity<span class="selector-class">.java</span>:<span class="number">152</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.volleydemo</span><span class="selector-class">.MainActivity</span><span class="variable">$HttpClientTask</span>.doInBackground(MainActivity<span class="selector-class">.java</span>:<span class="number">142</span>)</div><div class="line">    at android<span class="selector-class">.os</span><span class="selector-class">.AsyncTask</span>$<span class="number">2</span>.call(AsyncTask<span class="selector-class">.java</span>:<span class="number">307</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.FutureTask</span><span class="selector-class">.run</span>(FutureTask<span class="selector-class">.java</span>:<span class="number">237</span>)</div><div class="line">    at android<span class="selector-class">.os</span><span class="selector-class">.AsyncTask</span><span class="variable">$SerialExecutor</span>$<span class="number">1</span>.run(AsyncTask<span class="selector-class">.java</span>:<span class="number">246</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1113</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.run(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">588</span>)</div><div class="line">    at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">833</span>)</div><div class="line">Caused by: java<span class="selector-class">.net</span><span class="selector-class">.ConnectException</span>: failed to connect to /<span class="number">139.196</span>.<span class="number">224.72</span> (port <span class="number">8080</span>): connect failed: ECONNREFUSED (Connection refused)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.connect</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">124</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.PlainSocketImpl</span><span class="selector-class">.connect</span>(PlainSocketImpl<span class="selector-class">.java</span>:<span class="number">183</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.PlainSocketImpl</span><span class="selector-class">.connect</span>(PlainSocketImpl<span class="selector-class">.java</span>:<span class="number">452</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.Socket</span><span class="selector-class">.connect</span>(Socket<span class="selector-class">.java</span>:<span class="number">938</span>)</div><div class="line">    at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.conn</span><span class="selector-class">.scheme</span><span class="selector-class">.PlainSocketFactory</span><span class="selector-class">.connectSocket</span>(PlainSocketFactory<span class="selector-class">.java</span>:<span class="number">124</span>)</div><div class="line">    at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.conn</span><span class="selector-class">.DefaultClientConnectionOperator</span><span class="selector-class">.openConnection</span>(DefaultClientConnectionOperator<span class="selector-class">.java</span>:<span class="number">149</span>)</div><div class="line">	... <span class="number">15</span> more</div><div class="line">Caused by: android<span class="selector-class">.system</span><span class="selector-class">.ErrnoException</span>: connect failed: ECONNREFUSED (Connection refused)</div><div class="line"><span class="number">04</span>-<span class="number">27</span> <span class="number">14</span>:<span class="number">45</span>:<span class="number">44.822</span>    at libcore<span class="selector-class">.io</span><span class="selector-class">.Posix</span><span class="selector-class">.connect</span>(Native Method)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.BlockGuardOs</span><span class="selector-class">.connect</span>(BlockGuardOs<span class="selector-class">.java</span>:<span class="number">111</span>)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.connectErrno</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">137</span>)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.connect</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">122</span>)</div><div class="line">	... <span class="number">20</span> more</div></pre></td></tr></table></figure></p>
<p><code>org.apache.http.conn.HttpHostConnectException</code> 的 errorMessage 向我们指出是服务器拒绝连接。</p>
<p>对于同样的问题，如果以 OkHttp 作为 HttpStack 来执行请求的话，则将报出稍有不同的异常：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">java<span class="selector-class">.net</span><span class="selector-class">.ConnectException</span>: Failed to connect to www<span class="selector-class">.wolfcstech</span><span class="selector-class">.com</span>/<span class="number">139.196</span>.<span class="number">224.72</span>:<span class="number">8080</span></div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connectSocket</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">222</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connect</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">146</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">186</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findHealthyConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">121</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.newStream</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">100</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.ConnectInterceptor</span><span class="selector-class">.intercept</span>(ConnectInterceptor<span class="selector-class">.java</span>:<span class="number">42</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.cache</span><span class="selector-class">.CacheInterceptor</span><span class="selector-class">.intercept</span>(CacheInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.BridgeInterceptor</span><span class="selector-class">.intercept</span>(BridgeInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RetryAndFollowUpInterceptor</span><span class="selector-class">.intercept</span>(RetryAndFollowUpInterceptor<span class="selector-class">.java</span>:<span class="number">120</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.netlib</span><span class="selector-class">.OkHttp3Utils</span><span class="variable">$MyInterceptor</span>.intercept(OkHttp3Utils<span class="selector-class">.java</span>:<span class="number">29</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.RealCall</span><span class="selector-class">.getResponseWithInterceptorChain</span>(RealCall<span class="selector-class">.java</span>:<span class="number">179</span>)</div><div class="line">    at okhttp3.RealCall<span class="variable">$AsyncCall</span>.execute(RealCall<span class="selector-class">.java</span>:<span class="number">129</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.NamedRunnable</span><span class="selector-class">.run</span>(NamedRunnable<span class="selector-class">.java</span>:<span class="number">32</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1113</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.run(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">588</span>)</div><div class="line">    at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">833</span>)</div><div class="line">Caused by: java<span class="selector-class">.net</span><span class="selector-class">.ConnectException</span>: failed to connect to www<span class="selector-class">.wolfcstech</span><span class="selector-class">.com</span>/<span class="number">139.196</span>.<span class="number">224.72</span> (port <span class="number">8080</span>) after <span class="number">10000ms</span>: isConnected failed: ECONNREFUSED (Connection refused)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.isConnected</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">234</span>)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.connectErrno</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">171</span>)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.connect</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">122</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.PlainSocketImpl</span><span class="selector-class">.connect</span>(PlainSocketImpl<span class="selector-class">.java</span>:<span class="number">183</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.PlainSocketImpl</span><span class="selector-class">.connect</span>(PlainSocketImpl<span class="selector-class">.java</span>:<span class="number">452</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.Socket</span><span class="selector-class">.connect</span>(Socket<span class="selector-class">.java</span>:<span class="number">938</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.platform</span><span class="selector-class">.AndroidPlatform</span><span class="selector-class">.connectSocket</span>(AndroidPlatform<span class="selector-class">.java</span>:<span class="number">63</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connectSocket</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">220</span>)</div><div class="line">	... <span class="number">24</span> more</div><div class="line">Caused by: android<span class="selector-class">.system</span><span class="selector-class">.ErrnoException</span>: isConnected failed: ECONNREFUSED (Connection refused)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.isConnected</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">223</span>)</div><div class="line">	... <span class="number">31</span> more</div></pre></td></tr></table></figure></p>
<p>OkHttp 抛出 <code>java.net.ConnectException</code>，仅仅简单地指出连接服务器失败。</p>
<h2 id="代理服务器故障验证"><a href="#代理服务器故障验证" class="headerlink" title="代理服务器故障验证"></a>代理服务器故障验证</h2><p>这主要是指代理服务器进程没有启动，或代理设置存在问题。</p>
<p>对于这种情况，我们通过如下的方法来模拟测试：</p>
<ul>
<li>使手机连接 WiFi；</li>
<li>为手机所连接的 WiFi 设备设置代理，其中代理服务器的地址为无效的 IP 地址，或端口为无效端口；</li>
<li>以 <strong>HttpClient</strong> 作为我们的 HttpStack 来执行 HTTP 请求。</li>
</ul>
<p>请求执行之后，将报出如下异常：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.conn</span><span class="selector-class">.HttpHostConnectException</span>: Connection to http:<span class="comment">//10.240.252.44:8888 refused</span></div><div class="line">     at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.conn</span><span class="selector-class">.DefaultClientConnectionOperator</span><span class="selector-class">.openConnection</span>(DefaultClientConnectionOperator<span class="selector-class">.java</span>:<span class="number">193</span>)</div><div class="line">     at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.conn</span><span class="selector-class">.AbstractPoolEntry</span><span class="selector-class">.open</span>(AbstractPoolEntry<span class="selector-class">.java</span>:<span class="number">169</span>)</div><div class="line">     at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.conn</span><span class="selector-class">.AbstractPooledConnAdapter</span><span class="selector-class">.open</span>(AbstractPooledConnAdapter<span class="selector-class">.java</span>:<span class="number">124</span>)</div><div class="line">     at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.client</span><span class="selector-class">.DefaultRequestDirector</span><span class="selector-class">.execute</span>(DefaultRequestDirector<span class="selector-class">.java</span>:<span class="number">366</span>)</div><div class="line">     at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.client</span><span class="selector-class">.AbstractHttpClient</span><span class="selector-class">.execute</span>(AbstractHttpClient<span class="selector-class">.java</span>:<span class="number">596</span>)</div><div class="line">     at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.client</span><span class="selector-class">.AbstractHttpClient</span><span class="selector-class">.execute</span>(AbstractHttpClient<span class="selector-class">.java</span>:<span class="number">517</span>)</div><div class="line">     at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.client</span><span class="selector-class">.AbstractHttpClient</span><span class="selector-class">.execute</span>(AbstractHttpClient<span class="selector-class">.java</span>:<span class="number">495</span>)</div><div class="line">     at com<span class="selector-class">.netease</span><span class="selector-class">.volleydemo</span><span class="selector-class">.HttpClientUtils</span><span class="selector-class">.httpGet</span>(HttpClientUtils<span class="selector-class">.java</span>:<span class="number">21</span>)</div><div class="line">     at com<span class="selector-class">.netease</span><span class="selector-class">.volleydemo</span><span class="selector-class">.MainActivity</span><span class="variable">$HttpClientTask</span>.doInBackground(MainActivity<span class="selector-class">.java</span>:<span class="number">152</span>)</div><div class="line">     at com<span class="selector-class">.netease</span><span class="selector-class">.volleydemo</span><span class="selector-class">.MainActivity</span><span class="variable">$HttpClientTask</span>.doInBackground(MainActivity<span class="selector-class">.java</span>:<span class="number">142</span>)</div><div class="line">     at android<span class="selector-class">.os</span><span class="selector-class">.AsyncTask</span>$<span class="number">2</span>.call(AsyncTask<span class="selector-class">.java</span>:<span class="number">307</span>)</div><div class="line">     at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.FutureTask</span><span class="selector-class">.run</span>(FutureTask<span class="selector-class">.java</span>:<span class="number">237</span>)</div><div class="line">     at android<span class="selector-class">.os</span><span class="selector-class">.AsyncTask</span><span class="variable">$SerialExecutor</span>$<span class="number">1</span>.run(AsyncTask<span class="selector-class">.java</span>:<span class="number">246</span>)</div><div class="line">     at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1113</span>)</div><div class="line">     at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.run(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">588</span>)</div><div class="line">     at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">833</span>)</div><div class="line"> Caused by: java<span class="selector-class">.net</span><span class="selector-class">.ConnectException</span>: failed to connect to /<span class="number">10.240</span>.<span class="number">252.44</span> (port <span class="number">8888</span>): connect failed: ECONNREFUSED (Connection refused)</div><div class="line">     at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.connect</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">124</span>)</div><div class="line">     at java<span class="selector-class">.net</span><span class="selector-class">.PlainSocketImpl</span><span class="selector-class">.connect</span>(PlainSocketImpl<span class="selector-class">.java</span>:<span class="number">183</span>)</div><div class="line">     at java<span class="selector-class">.net</span><span class="selector-class">.PlainSocketImpl</span><span class="selector-class">.connect</span>(PlainSocketImpl<span class="selector-class">.java</span>:<span class="number">452</span>)</div><div class="line">     at java<span class="selector-class">.net</span><span class="selector-class">.Socket</span><span class="selector-class">.connect</span>(Socket<span class="selector-class">.java</span>:<span class="number">938</span>)</div><div class="line">     at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.conn</span><span class="selector-class">.scheme</span><span class="selector-class">.PlainSocketFactory</span><span class="selector-class">.connectSocket</span>(PlainSocketFactory<span class="selector-class">.java</span>:<span class="number">124</span>)</div><div class="line">     at org<span class="selector-class">.apache</span><span class="selector-class">.http</span><span class="selector-class">.impl</span><span class="selector-class">.conn</span><span class="selector-class">.DefaultClientConnectionOperator</span><span class="selector-class">.openConnection</span>(DefaultClientConnectionOperator<span class="selector-class">.java</span>:<span class="number">149</span>)</div><div class="line"> 	... <span class="number">15</span> more</div><div class="line"> Caused by: android<span class="selector-class">.system</span><span class="selector-class">.ErrnoException</span>: connect failed: ECONNREFUSED (Connection refused)</div><div class="line">     at libcore<span class="selector-class">.io</span><span class="selector-class">.Posix</span><span class="selector-class">.connect</span>(Native Method)</div><div class="line">     at libcore<span class="selector-class">.io</span><span class="selector-class">.BlockGuardOs</span><span class="selector-class">.connect</span>(BlockGuardOs<span class="selector-class">.java</span>:<span class="number">111</span>)</div><div class="line">     at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.connectErrno</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">137</span>)</div><div class="line">     at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.connect</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">122</span>)</div><div class="line"> 	... <span class="number">20</span> more</div></pre></td></tr></table></figure></p>
<p>对于同样的问题，OkHttp 报出了不同的异常：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">java<span class="selector-class">.net</span><span class="selector-class">.ConnectException</span>: Failed to connect to /<span class="number">10.240</span>.<span class="number">252.44</span>:<span class="number">8888</span></div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connectSocket</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">222</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connectTunnel</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">195</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connect</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">144</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">186</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findHealthyConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">121</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.newStream</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">100</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.ConnectInterceptor</span><span class="selector-class">.intercept</span>(ConnectInterceptor<span class="selector-class">.java</span>:<span class="number">42</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.cache</span><span class="selector-class">.CacheInterceptor</span><span class="selector-class">.intercept</span>(CacheInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.BridgeInterceptor</span><span class="selector-class">.intercept</span>(BridgeInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RetryAndFollowUpInterceptor</span><span class="selector-class">.intercept</span>(RetryAndFollowUpInterceptor<span class="selector-class">.java</span>:<span class="number">120</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.netlib</span><span class="selector-class">.OkHttp3Utils</span><span class="variable">$MyInterceptor</span>.intercept(OkHttp3Utils<span class="selector-class">.java</span>:<span class="number">29</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.RealCall</span><span class="selector-class">.getResponseWithInterceptorChain</span>(RealCall<span class="selector-class">.java</span>:<span class="number">179</span>)</div><div class="line">    at okhttp3.RealCall<span class="variable">$AsyncCall</span>.execute(RealCall<span class="selector-class">.java</span>:<span class="number">129</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.NamedRunnable</span><span class="selector-class">.run</span>(NamedRunnable<span class="selector-class">.java</span>:<span class="number">32</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1113</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.run(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">588</span>)</div><div class="line">    at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">833</span>)</div><div class="line">Caused by: java<span class="selector-class">.net</span><span class="selector-class">.ConnectException</span>: failed to connect to /<span class="number">10.240</span>.<span class="number">252.44</span> (port <span class="number">8888</span>) after <span class="number">10000ms</span>: isConnected failed: ECONNREFUSED (Connection refused)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.isConnected</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">234</span>)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.connectErrno</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">171</span>)</div></pre></td></tr></table></figure></p>
<h2 id="所需诊断信息-1"><a href="#所需诊断信息-1" class="headerlink" title="所需诊断信息"></a>所需诊断信息</h2><p>为了确认所报出的异常产生的根源，需要下的诊断信息：</p>
<ul>
<li>连接的目标主机的 IP 地址；</li>
<li>连接建立的目标端口；</li>
<li>用户设置的代理服务器地址和端口；</li>
<li>TCP 连接目标 IP:端口 的结果。</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>针对这个异常，网络上有其它的一些资料和讨论，相关链接如下：</p>
<ul>
<li><a href="http://stackoverflow.com/questions/15546589/what-causes-httphostconnectexception" target="_blank" rel="external">Stack Overflow 讨论</a></li>
<li><a href="http://androidxref.com/5.0.0_r2/xref/external/apache-http/src/org/apache/http/impl/conn/DefaultClientConnectionOperator.java" target="_blank" rel="external">Android 5.0 抛出异常的相关源码</a></li>
<li><a href="https://developer.android.com/reference/org/apache/http/conn/HttpHostConnectException.html" target="_blank" rel="external">Android 官方文档对该异常的说明</a></li>
</ul>
<h1 id="NoRouteToHostException"><a href="#NoRouteToHostException" class="headerlink" title="NoRouteToHostException"></a>NoRouteToHostException</h1><p><strong>异常：</strong> java.net.NoRouteToHostException</p>
<p><strong>错误说明：</strong> 无法连接远程地址与端口。</p>
<p><strong>错误消息：</strong> No route to host</p>
<p><strong>可能原因：</strong> </p>
<ul>
<li>防火墙的规则设置导致数据包无法被发送出去；</li>
<li>中间路由节点挂掉。</li>
</ul>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>用户防火墙配置；</li>
<li>目标主机是否可以访问（ping）。</li>
</ul>
<p><strong>参考资料：</strong></p>
<ul>
<li><a href="http://stackoverflow.com/questions/15686445/noroutetohostexception-on-client-or-server" target="_blank" rel="external">Stack Overflow 的讨论</a></li>
<li><a href="https://developer.android.com/reference/java/net/NoRouteToHostException.html" target="_blank" rel="external">Android 官方对异常的说明</a></li>
</ul>
<h1 id="SSLException"><a href="#SSLException" class="headerlink" title="SSLException"></a>SSLException</h1><p><strong>异常：</strong> javax.net.ssl.SSLException</p>
<p><strong>错误说明：</strong> SSL 失败</p>
<h2 id="子错误-SSL-读期间连接重置"><a href="#子错误-SSL-读期间连接重置" class="headerlink" title="子错误 - SSL 读期间连接重置"></a>子错误 - SSL 读期间连接重置</h2><p><strong>错误消息：</strong> Read error: ssl=0xf49f7200: I/O error during system call, Connection reset by peer</p>
<p><strong>可能原因：</strong> </p>
<ul>
<li>在网络数据传输期间，TCP 连接被服务器异常结束。</li>
<li>遭受网络 TCP Reset 攻击。</li>
</ul>
<p><strong>异常分析：</strong></p>
<p>在网络数据传输期间，TCP 连接意外结束，由于服务器进程意外终止等原因，没有经过正常的 TCP 连接断开过程。后续客户端向服务器发送 TCP 包，如数据包、ACK 包等，服务器返回 RST 包所致。</p>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>与目标服务器目标端口的 TCP 连接测试结果，检查目标服务器进程是否存活。</li>
</ul>
<p><strong>参考资料：</strong></p>
<ul>
<li><a href="http://www.2cto.com/article/201202/118625.html" target="_blank" rel="external">从TCP协议的原理来谈谈rst复位攻击</a></li>
</ul>
<h2 id="子错误-SSL-握手期间连接重置"><a href="#子错误-SSL-握手期间连接重置" class="headerlink" title="子错误 - SSL 握手期间连接重置"></a>子错误 - SSL 握手期间连接重置</h2><p><strong>错误消息：</strong> SSL handshake aborted: ssl=0x79c484c0: I/O error during system call, Connection reset by peer</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>在网络数据传输期间，TCP 连接被服务器异常结束。</li>
<li>遭受网络 TCP Reset 攻击。</li>
</ul>
<p><strong>异常分析：</strong></p>
<p>以 Android 6.0.0_r1 为例，仅有的出现 “SSL handshake aborted” 的位置为 <a href="http://androidxref.com/6.0.0_r1/xref/external/conscrypt/src/main/native/org_conscrypt_NativeCrypto.cpp" target="_blank" rel="external">http://androidxref.com/6.0.0_r1/xref/external/conscrypt/src/main/native/org_conscrypt_NativeCrypto.cpp</a> — NativeCrypto_SSL_do_handshake()。</p>
<p>异常的 error message 构造过程为 NativeCrypto_SSL_do_handshake() -&gt; throwSSLExceptionWithSslErrors() -&gt; asprintf() （error code 为 SSL_ERROR_SYSCALL ）。</p>
<p>errorCode 由 SSL_do_handshake(SSL <em>s) 返回，但在 SSL_do_handshake(SSL </em>s) ，实际由 <code>SSL *s</code> 的回调函数 <code>s-&gt;handshake_func</code> 执行。handshake_func 在两个地方赋值，对于服务器而言，在 SSL_set_accept_state() 中，该回调等于 ssl-&gt;method-&gt;ssl_accept；对于客户端而言，该回调在 SSL_set_connect_state() 中赋值，等于 ssl-&gt;method-&gt;ssl_connect。 <code>SSL *s</code> 结构的 <code>SSL_PROTOCOL_METHOD *method</code>，在 SSL 结构创建时赋值，SSL 结构的创建主要在 <code>NativeCrypto_SSL_new()</code> -&gt; <code>SSL_new()</code> 完成。<code>SSL *s</code> 结构的 <code>SSL_PROTOCOL_METHOD *method</code> 来源于 <code>SSL_CTX</code> 的 <code>method</code>。<code>SSL_CTX</code> 结构在 NativeCrypto_SSL_CTX_new() 中创建，<code>SSL_CTX</code> 结构的 <code>method</code> 来自于 <code>SSLv23_method()</code>，实际为 <code>TLS_method(void)</code> 函数中的静态结构，<code>protocol_method</code> 为 <code>TLS_protocol_method</code>。</p>
<p>最终可以发现 <code>SSL *s</code> 的回调函数 <code>s-&gt;handshake_func</code> 为 <code>ssl3_connect(SSL *s)</code>。在 <code>ssl3_connect(SSL *s)</code> 中，以一种状态机模式的方式，逐步完成 SSL/TLS 握手，在遇到错误时退出。</p>
<p>因而错误的发生，是由于在 <code>ssl3_connect(SSL *s)</code> 执行期间，TCP 连接意外结束，可能由于服务器进程意外终止等原因，没有经过正常的 TCP 连接断开过程。后续客户端向服务器发送 TCP 包，如数据包、ACK 包等，服务器返回 RST 包所致。但具体在 SSL/TLS 握手的哪个阶段异常发生，则难以判断。</p>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>与目标服务器目标端口的 TCP 连接测试结果，检查目标服务器进程是否存活。</li>
</ul>
<h1 id="SSLHandshakeException"><a href="#SSLHandshakeException" class="headerlink" title="SSLHandshakeException"></a>SSLHandshakeException</h1><p><strong>异常：</strong> javax.net.ssl.SSLHandshakeException</p>
<p><strong>错误说明：</strong> SSL/TLS 握手失败</p>
<h2 id="子错误-握手失败"><a href="#子错误-握手失败" class="headerlink" title="子错误 - 握手失败"></a>子错误 - 握手失败</h2><p><strong>错误消息：</strong> Handshake failed</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>握手失败，证书验证失败<ul>
<li>未知证书颁发者；</li>
<li>不完整的证书链；</li>
<li>自签名证书；</li>
<li>服务器主机名不匹配；</li>
<li>严格安全重新协商失败；</li>
<li>遭遇了中间人攻击。</li>
</ul>
</li>
<li>握手失败，协议协商失败/握手格式不兼容</li>
<li>协议异常，服务器名称标识不匹配</li>
<li>某些版本 SSL 库的 bug</li>
</ul>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>异常的详细错误消息；</li>
<li>客户端支持的 SSL/TLS 版本；</li>
<li>客户端设置的 SNI 信息；</li>
<li>服务器下发的证书链；</li>
<li>客户端可用的加密套件。</li>
</ul>
<p>对于特定的操作系统版本，其 SSL 库的版本和根证书库是固定的，对于这些重要的信息不再需要移动端上传。此外，<strong><em>证书链消耗流量可能会比较大，大概在几 KBytes</em></strong>。</p>
<h2 id="子错误-连接超时"><a href="#子错误-连接超时" class="headerlink" title="子错误 - 连接超时"></a>子错误 - 连接超时</h2><p><strong>错误消息：</strong> SSL handshake aborted: ssl=0xeec6d600: I/O error during system call, Connection timed out</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>设备接入的网络本身带宽比较低；</li>
<li>设备接入的网络本身延迟比较高；</li>
<li>设备与服务器的网络路径中存在比较拥堵、负载比较重的节点；</li>
<li>网络中路由节点的临时性异常。</li>
</ul>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>Traceroute 获取的网络路径信息。</li>
<li>网络路径上不同节点的繁忙程度，可通过丢包率来近似地反映。</li>
<li>网络连接条件（移动网络/WiFI），网络延时及带宽。</li>
</ul>
<h2 id="子错误-连接重置"><a href="#子错误-连接重置" class="headerlink" title="子错误 - 连接重置"></a>子错误 - 连接重置</h2><p><strong>错误消息：</strong> SSL handshake aborted: ssl=0xea0e4f00: I/O error during system call, Connection reset by peer</p>
<p><strong>可能原因：</strong> </p>
<ul>
<li>在网络数据传输期间，TCP 连接被服务器异常结束。</li>
<li>遭受网络 TCP Reset 攻击。</li>
</ul>
<p><strong>错误原因分析：</strong></p>
<p>在网络数据传输期间，TCP 连接意外结束，可能由于服务器进程意外终止等原因，没有经过正常的 TCP 连接断开过程。后续客户端向服务器发送 TCP 包，如数据包、ACK 包等，服务器返回 RST 包所致。</p>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>与目标服务器目标端口的 TCP 连接测试结果，检查目标服务器进程是否存活。</li>
</ul>
<h2 id="子错误-连接被关闭"><a href="#子错误-连接被关闭" class="headerlink" title="子错误 - 连接被关闭"></a>子错误 - 连接被关闭</h2><p><strong>错误消息：</strong> Connection closed by peer</p>
<p><strong>可能原因：</strong> </p>
<ul>
<li>在网络数据传输期间，TCP 连接被服务器异常结束。</li>
</ul>
<p><strong>错误原因分析：</strong></p>
<p>在网络数据传输期间，由于服务器回收 TCP 连接，或服务器进程意外结束，连接被提前结束，正常的 TCP 连接断开过程完成所致。</p>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>与目标服务器目标端口的 TCP 连接测试结果，检查目标服务器进程是否存活。</li>
</ul>
<h1 id="SSLProtocolException"><a href="#SSLProtocolException" class="headerlink" title="SSLProtocolException"></a>SSLProtocolException</h1><p><strong>异常：</strong> javax.net.ssl.SSLProtocolException</p>
<p><strong>错误说明：</strong> 协议异常</p>
<h2 id="子错误-记录MAC无效的读失败"><a href="#子错误-记录MAC无效的读失败" class="headerlink" title="子错误 - 记录MAC无效的读失败"></a>子错误 - 记录MAC无效的读失败</h2><p><strong>错误消息：</strong> Read error: ssl=0xf475ee00: Failure in SSL library, usually a protocol error error:140943FC:SSL routines:SSL3_READ_BYTES:sslv3 alert bad record mac (external/openssl/ssl/s3_pkt.c:1308 0xe27a8ee0:0x00000003)</p>
<p><strong>可能原因：</strong> </p>
<ul>
<li>数据在传输过程中被篡改。</li>
<li>MAC 方式不支持。</li>
<li>某些版本SSL 库的 bug</li>
</ul>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>客户端支持的 SSL/TLS 版本；</li>
<li>客户端可用的加密套件。</li>
</ul>
<h2 id="子错误-协议版本导致的读失败"><a href="#子错误-协议版本导致的读失败" class="headerlink" title="子错误 - 协议版本导致的读失败"></a>子错误 - 协议版本导致的读失败</h2><p><strong>错误消息：</strong> Read error: ssl=0xdbab7300: Failure in SSL library, usually a protocol error error:100c542e:SSL routines:ssl3_read_bytes:TLSV1_ALERT_PROTOCOL_VERSION (external/boringssl/src/ssl/s3_pkt.c:972 0xd3fb2d20:0x00000001)</p>
<p><strong>可能原因：</strong> </p>
<ul>
<li>遭遇降级攻击</li>
<li>某些版本 SSL 库的 bug</li>
</ul>
<p><strong>所需诊断信息：</strong> </p>
<ul>
<li>客户端支持的 SSL/TLS 版本；</li>
<li>服务器下发的证书链；</li>
<li>客户端可用的加密套件。</li>
</ul>
<p>对于特定操作系统版本，其 SSL 库版本和根证书库是固定的，对于这些重要信息不再需要移动端上传。此外，<strong><em>证书链消耗流量可能会比较大，大概在几 KBytes</em></strong>。</p>
<h1 id="NoHttpResponseException"><a href="#NoHttpResponseException" class="headerlink" title="NoHttpResponseException"></a>NoHttpResponseException</h1><p><strong>等价异常类型：</strong></p>
<ul>
<li>org.apache.http.NoHttpResponseException</li>
<li>com.netease.mam.org.apache.http.NoHttpResponseException</li>
</ul>
<p><strong>错误说明：</strong> 服务器响应异常</p>
<p><strong>错误消息：</strong> The target server failed to respond</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>服务器故障</li>
</ul>
<h1 id="InterruptedIOException"><a href="#InterruptedIOException" class="headerlink" title="InterruptedIOException"></a>InterruptedIOException</h1><p><strong>异常：</strong> java.io.InterruptedIOException</p>
<p><strong>错误说明：</strong> IO 中断</p>
<h2 id="子错误-连接已关闭"><a href="#子错误-连接已关闭" class="headerlink" title="子错误 - 连接已关闭"></a>子错误 - 连接已关闭</h2><p><strong>错误消息：</strong> Connection has been shut down. </p>
<p><strong>异常分析：</strong></p>
<p>异常抛出的位置为 <code>external/apache-http/src/org/apache/http/impl/conn/AbstractClientConnAdapter.java</code> 的 <code>assertNotAborted()</code>。</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>客户端在发送请求或接收响应时，发现连接已经被终止，请求被终止/取消。</li>
</ul>
<h1 id="IOException"><a href="#IOException" class="headerlink" title="IOException"></a>IOException</h1><p><strong>异常：</strong> java.io.IOException</p>
<p><strong>错误说明：</strong> IO 失败</p>
<h2 id="子错误-连接关闭"><a href="#子错误-连接关闭" class="headerlink" title="子错误 - 连接关闭"></a>子错误 - 连接关闭</h2><p><strong>错误消息：</strong> Connection already shutdown</p>
<p><strong>异常分析：</strong></p>
<p>异常抛出的位置为 <code>external/apache-http/src/org/apache/http/impl/conn/DefaultClientConnection.java</code> 的 <code>opening()</code> 方法。 </p>
<p><strong>可能原因：</strong></p>
<ul>
<li>连接打开动作执行过程中，被客户端关闭，请求被终止/取消。</li>
</ul>
<h2 id="子错误-请求被终止"><a href="#子错误-请求被终止" class="headerlink" title="子错误 - 请求被终止"></a>子错误 - 请求被终止</h2><p><strong>错误消息：</strong> Request already aborted</p>
<p><strong>异常分析：</strong></p>
<p>异常抛出的位置为 <code>external/apache-http/src/org/apache/http/client/methods/HttpRequestBase.java</code> 的 <code>setConnectionRequest()</code> 和 <code>setReleaseTrigger()</code> 中，设置连接请求和 <code>ConnectionReleaseTrigger</code> 时执行检查，发现请求被客户端终止。</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>请求被终止/取消。</li>
</ul>
<h1 id="SocketException"><a href="#SocketException" class="headerlink" title="SocketException"></a>SocketException</h1><p><strong>异常：</strong> java.net.SocketException</p>
<p><strong>错误说明：</strong> Socket 异常</p>
<h2 id="子错误-读消息连接重置"><a href="#子错误-读消息连接重置" class="headerlink" title="子错误 - 读消息连接重置"></a>子错误 - 读消息连接重置</h2><p><strong>错误消息：</strong> recvfrom failed: ECONNRESET (Connection reset by peer)</p>
<p><strong>可能原因：</strong> </p>
<ul>
<li>在网络数据传输期间，TCP 连接被服务器异常结束。</li>
<li>遭受网络 TCP Reset 攻击。</li>
</ul>
<p><strong>错误原因分析：</strong></p>
<p>在网络数据传输期间，TCP 连接意外结束，由于服务器进程意外终止等原因，没有经过正常的 TCP 连接断开过程。后续客户端向服务器发送 TCP 包，如数据包、ACK 包等，服务器返回 RST 包所致。</p>
<p><strong>所需诊断信息</strong></p>
<ul>
<li>与目标服务器目标端口的 TCP 连接测试结果，检查目标服务器进程是否存活。</li>
</ul>
<h2 id="子错误-连接重置-1"><a href="#子错误-连接重置-1" class="headerlink" title="子错误 - 连接重置"></a>子错误 - 连接重置</h2><p><strong>错误消息：</strong> Connection reset</p>
<p><strong>可能原因：</strong> </p>
<ul>
<li>在网络数据传输期间，TCP 连接被服务器异常结束。</li>
<li>遭受网络 TCP Reset 攻击。</li>
</ul>
<p><strong>错误原因分析：</strong></p>
<p>在网络数据传输期间，TCP 连接意外结束，可能由于服务器进程意外终止等原因，没有经过正常的 TCP 连接断开过程。后续客户端向服务器发送 TCP 包，如数据包、ACK 包等，服务器返回 RST 包所致。</p>
<p><strong>所需诊断信息</strong></p>
<ul>
<li>与目标服务器目标端口的 TCP 连接测试结果，检查目标服务器进程是否存活。</li>
</ul>
<h2 id="子错误-Socket-关闭"><a href="#子错误-Socket-关闭" class="headerlink" title="子错误 - Socket 关闭"></a>子错误 - Socket 关闭</h2><p><strong>错误消息：</strong> Socket closed</p>
<p><strong>异常分析：</strong></p>
<p>异常抛出的位置为 <code>libcore/luni/src/main/java/libcore/io/IoBridge.java</code> 的 <code>isConnected()</code>。</p>
<p><strong>可能原因：</strong> </p>
<ul>
<li>连接被客户端关闭，请求被终止/取消。</li>
</ul>
<h1 id="ConnectException"><a href="#ConnectException" class="headerlink" title="ConnectException"></a>ConnectException</h1><p><strong>异常：</strong> java.net.ConnectException</p>
<p><strong>错误说明：</strong> 连接失败</p>
<p><strong>异常分析：</strong></p>
<p><code>ConnectException</code> 异常在 <code>libcore.io.IoBridge</code> 的 <code>connect(FileDescriptor fd, InetAddress inetAddress, int port, int timeoutMs)</code> 和 <code>isConnected()</code> 中抛出。在执行 socket 连接建立操作时，底层操作失败。错误信息中都会包含连接的目标主机的 IP，尝试连接的时间， <code>errno</code> 值及 <code>errno</code> 值对应的错误消息。通常可根据 errno 判断失败原因。</p>
<h2 id="子错误-连接被拒绝"><a href="#子错误-连接被拒绝" class="headerlink" title="子错误 - 连接被拒绝"></a>子错误 - 连接被拒绝</h2><p><strong>错误消息：</strong> failed to connect to /119.84.111.126 (port 80) after 30000ms: isConnected failed: ECONNREFUSED (Connection refused)</p>
<p>参考前面 <code>HttpHostConnectException</code> 相关说明。</p>
<h2 id="子错误-主机不可达"><a href="#子错误-主机不可达" class="headerlink" title="子错误 - 主机不可达"></a>子错误 - 主机不可达</h2><p><strong>错误消息：</strong> failed to connect to /153.101.65.23 (port 80) after 30000ms: isConnected failed: EHOSTUNREACH (No route to host)</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>防火墙的规则设置导致数据包无法被发送出去；</li>
<li>中间路由节点挂掉。</li>
</ul>
<p><strong>异常分析：</strong></p>
<p>引发了ICMP目的不可达错误，这认为是软错误。client核心保存消息并且荏苒发送SYN。。如果超出一个确定的时间。保存的ICMP错误返回给进程 EHOSTUNREACH或者ENETUNREACH。ENETUNREACH被认为是过时的。所以返回的应该是EHOSTUNREACH。</p>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>用户防火墙配置；</li>
<li>目标主机是否可以访问（ping）。</li>
</ul>
<h2 id="子错误-网络不可达"><a href="#子错误-网络不可达" class="headerlink" title="子错误 - 网络不可达"></a>子错误 - 网络不可达</h2><p><strong>错误消息：</strong> failed to connect to /59.111.160.195 (port 80) after 30000ms: connect failed: ENETUNREACH (Network is unreachable)</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>防火墙的规则设置导致数据包无法被发送出去；</li>
<li>中间路由节点挂掉。</li>
</ul>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>用户防火墙配置；</li>
<li>目标主机是否可以访问（ping）。</li>
</ul>
<h1 id="ClientProtocolException"><a href="#ClientProtocolException" class="headerlink" title="ClientProtocolException"></a>ClientProtocolException</h1><p><strong>等价异常类型：</strong> </p>
<ul>
<li>com.netease.mam.org.apache.http.client.ClientProtocolException</li>
</ul>
<p><strong>错误说明：</strong> 协议错误</p>
<p><strong>异常分析：</strong> </p>
<p>异常抛出的位置为 <code>external/apache-http/src/org/apache/http/impl/client/AbstractHttpClient.java</code> 的 <code>execute()</code> 中。在执行 <code>RequestDirector.execute()</code> 时，捕获到 <code>HttpException</code> 异常时抛出该异常。 <code>HttpException</code> 异常抛出的位置主要有以下几个：</p>
<ul>
<li><code>external/apache-http/src/org/apache/http/impl/client/DefaultRequestDirector.java</code> 的 <code>createTunnelToTarget()</code> 中通过 HTTP 的 CONNECT 方法建立隧道链接时，对端返回了小于 200 的响应码，隧道连接建立失败。</li>
<li><code>external/apache-http/src/org/apache/http/impl/conn/ProxySelectorRoutePlanner.java</code> 的 <code>determineProxy()</code> 中 URI 格式错误。URI 通过目标主机的 <code>scheme</code> ，主机名，端口等构造。</li>
<li><code>external/apache-http/src/org/apache/http/impl/conn/ProxySelectorRoutePlanner.java</code> 的 <code>determineProxy()</code> 中代理地址格式错误。</li>
</ul>
<h2 id="子错误-未知原因-1"><a href="#子错误-未知原因-1" class="headerlink" title="子错误 - 未知原因"></a>子错误 - 未知原因</h2><p><strong>错误消息：</strong> null</p>
<p><strong>可能原因：</strong></p>
<ul>
<li>这个错误主要与客户端的 HTTP 代理服务器设置有关。</li>
</ul>
<p><strong>所需诊断信息：</strong></p>
<ul>
<li>如果是 HTTPS 请求，通过 HTTP 的 CONNECT 方法建立隧道链接时，CONNECT 请求的完整响应内容。</li>
<li>代理服务器配置。</li>
</ul>
<p>Done。</p>
</div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android-图形系统/">Android 图形系统</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/31/qcow2_on_linux/">在 Linux 上如何挂载 qcow2 磁盘镜像</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/21/android_graphics_gralloc/">Android 图形系统之gralloc</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/20/android_graphics_bufferalloc/">Android 图形系统之图形缓冲区分配</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/16/opengles_android_emulation/">Android 硬件 OpenGL ES 模拟设计概述</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/15/egl_context_creation/">EGL Context 创建</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/14/egl_init_drivers/">Android 图形驱动初始化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/13/opengl_on_android_with_sv/">在 Android 中使用 OpenGL</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/12/android_debug_gdb/">使用 GDB 调试 Android 应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/11/android_emulator_dev/">Android 模拟器下载、编译及调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_start_streaming/">live555 源码分析：播放启动</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a><ul></ul><a href="http://www.tworice.com" title="亚马逊分类目录" target="_blank">亚马逊分类目录</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = 'private/networking_issues.html';
var disqus_title = 'Android 网络异常';
var disqus_url = 'https://www.wolfcstech.com/private/networking_issues.html';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>