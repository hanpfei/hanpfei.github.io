<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="mask-icon" href="/images/freesoft.jpg?v=6.0.3" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Android开发,chromium," />


<meta name="description" content="Chromium net是chromium浏览器及ChromeOS中，用于从网络获取资源的模块。这个网络库是用C++编写的，且用了大量的C++11特性。它广泛地支持当前互联网环境中用到的大量的网络协议，如HTTP/1.1,SPDY，HTTP/2，FTP，QUIC，WebSockets等；在安全性方面也有良好的支持，如SSL等；同时，针对性能，它也有诸多的优化，如引入libevent的基于事件驱动的">
<meta property="og:type" content="article">
<meta property="og:title" content="chromium net到android平台的移植">
<meta property="og:url" content="https://www.wolfcstech.com/2016/10/18/chromium-net-android-porting/index.html">
<meta property="og:site_name" content="WolfcsTech">
<meta property="og:description" content="Chromium net是chromium浏览器及ChromeOS中，用于从网络获取资源的模块。这个网络库是用C++编写的，且用了大量的C++11特性。它广泛地支持当前互联网环境中用到的大量的网络协议，如HTTP/1.1,SPDY，HTTP/2，FTP，QUIC，WebSockets等；在安全性方面也有良好的支持，如SSL等；同时，针对性能，它也有诸多的优化，如引入libevent的基于事件驱动的">
<meta property="og:updated_time" content="2019-10-25T03:39:45.633Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="chromium net到android平台的移植">
<meta name="twitter:description" content="Chromium net是chromium浏览器及ChromeOS中，用于从网络获取资源的模块。这个网络库是用C++编写的，且用了大量的C++11特性。它广泛地支持当前互联网环境中用到的大量的网络协议，如HTTP/1.1,SPDY，HTTP/2，FTP，QUIC，WebSockets等；在安全性方面也有良好的支持，如SSL等；同时，针对性能，它也有诸多的优化，如引入libevent的基于事件驱动的">






  <link rel="canonical" href="https://www.wolfcstech.com/2016/10/18/chromium-net-android-porting/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>chromium net到android平台的移植 | WolfcsTech</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-109419024-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-109419024-1');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WolfcsTech</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="http://www.ixirong.com/404.html" rel="section">
            <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />公益 404</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.wolfcstech.com/2016/10/18/chromium-net-android-porting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Han Pengfei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/freesoft.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WolfcsTech">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">chromium net到android平台的移植</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-18T16:05:49+08:00">2016-10-18</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android开发/" itemprop="url" rel="index"><span itemprop="name">Android开发</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/18/chromium-net-android-porting/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2016/10/18/chromium-net-android-porting/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/10/18/chromium-net-android-porting/" class="leancloud_visitors" data-flag-title="chromium net到android平台的移植">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>Chromium net是chromium浏览器及ChromeOS中，用于从网络获取资源的模块。这个网络库是用C++编写的，且用了大量的C++11特性。它广泛地支持当前互联网环境中用到的大量的网络协议，如HTTP/1.1,SPDY，HTTP/2，FTP，QUIC，WebSockets等；在安全性方面也有良好的支持，如SSL等；同时，针对性能，它也有诸多的优化，如引入libevent的基于事件驱动的设计。从而，将chromium net库移植到android平台上并用起来，以提升我们的APP的网络访问性能成为了一件非常有价值的事情。</p>
<a id="more"></a>
<p>这里我们就尝试将chromium net移植到android平台上并用起来。但由于庞大的chromium项目有着自己比较特别的开发流程，开发方式，而给我们的移植工作制造了一些障碍。具体地说是：</p>
<ul>
<li>gn/gyp + ninja的构建方式；</li>
<li>为了方便开发，chromium的仓库中包含了构建所需的完整的工具链，包括编译、链接的工具，android的SDK和NDK，甚至是STL。这个工具链与我们惯常用在项目中的工具链多少还是有一点点区别的，这会给我们的编译链接等制造一些困扰。</li>
</ul>
<p>但好在Google出品比较具有hack风，因而移植工作的难度变得可控。比如gn工具，可以让我们比较方便地对工程做更多的探索，我们可以通过这个工具来了解我们编译一个模块时，整个环境的配置，该模块具体包含了哪些源文件，模块导出的头文件，编译链接时都用了什么样的参数等等。</p>
<p>在具体移植开始之前，先设定我们移植的目标：</p>
<ul>
<li>让chromium的net模块可以单独地在android平台上跑起来，可以通过JNI的方式进行调用；</li>
<li>将chromium net模块从整个的chromium代码库中抽离，依然基于gn + ninja，建立独立的开发环境，可以进行配置、构建，以方便后续针对chromium net的开发。</li>
<li>针对与移动端上受限的资源，及项目的需要，对chromium net进行一些裁剪瘦身，比如对ftp协议的支持就没有太大的必要，砍掉这些用不到的东西以节省资源，提升效能。</li>
</ul>
<p>这里主要就基于我们的目标，来探索移植的方法。本文尝试逐步的探索整个的移植过程。本文会记录遇到的每个问题，并给出出错的提示，比如编译器报的error，链接器报的error，运行时崩溃抓到的backtrace等等，然后还会给出对问题的基本分析与定位，及问题的解决方法。</p>
<h1 id="编译net模块"><a href="#编译net模块" class="headerlink" title="编译net模块"></a>编译net模块</h1><p>首先要做的事情就是下载完整的chromium代码，这可以参考<a href="http://www.jianshu.com/p/5fce18cbe016" target="_blank" rel="external">Chromium Android编译指南</a>来完成。然后执行（假设当前目录是chromium代码库的根目录）命令：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ gclient runhooks</div><div class="line">$ cd src</div><div class="line">$ ./build/<span class="keyword">install</span>-<span class="keyword">build</span>-deps.sh</div><div class="line">$ ./<span class="keyword">build</span>/<span class="keyword">install</span>-<span class="keyword">build</span>-deps-android.sh</div></pre></td></tr></table></figure></p>
<p>下载构建chromium所需的系统工具。</p>
<p>之后需要对编译进行配置。编辑<code>out/Default/args.gn</code>文件，并参照<a href="http://www.jianshu.com/p/5fce18cbe016" target="_blank" rel="external">Chromium Android编译指南</a>中的说明，输入如下内容：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attr">target_os</span> = <span class="string">"android"</span></div><div class="line"><span class="attr">target_cpu</span> = <span class="string">"arm"</span>  # (default)</div><div class="line"><span class="attr">is_debug</span> = <span class="literal">true</span>  # (default)</div><div class="line"></div><div class="line"><span class="comment"># Other args you may want to set:</span></div><div class="line"><span class="attr">is_component_build</span> = <span class="literal">true</span></div><div class="line"><span class="attr">is_clang</span> = <span class="literal">true</span></div><div class="line"><span class="attr">symbol_level</span> = <span class="number">1</span>  # Faster build with fewer symbols. -g1 rather than -g2</div><div class="line"><span class="attr">enable_incremental_javac</span> = <span class="literal">true</span>  # Much faster; experimental</div></pre></td></tr></table></figure></p>
<p>保存退出之后，执行：<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ gn gen <span class="keyword">out</span>/<span class="keyword">Default</span></div></pre></td></tr></table></figure></p>
<p>产生ninja构建所需的各个模块的ninja文件。随后输入如下命令编译net模块：<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ninja -C <span class="keyword">out</span>/<span class="keyword">Default</span> net</div></pre></td></tr></table></figure></p>
<p>这个命令会编译net模块，及其依赖的所有模块，包括base，crypto，borringssl，protobuf，icu，url等。可以看一下我们编译的成果：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">ls</span> -alh out/Default/ | <span class="keyword">grep</span> <span class="keyword">so</span>$</div><div class="line">-rwxrwxr-<span class="keyword">x</span>  <span class="number">1</span> chrome chrome <span class="number">1.2</span>M <span class="number">8</span>月  <span class="number">10</span> <span class="number">20</span>:<span class="number">55</span> libbase.<span class="keyword">cr</span>.<span class="keyword">so</span></div><div class="line">-rwxrwxr-<span class="keyword">x</span>  <span class="number">1</span> chrome chrome  <span class="number">98</span>K <span class="number">8</span>月  <span class="number">10</span> <span class="number">20</span>:<span class="number">55</span> libbase_i18n.<span class="keyword">cr</span>.<span class="keyword">so</span></div><div class="line">-rwxrwxr-<span class="keyword">x</span>  <span class="number">1</span> chrome chrome <span class="number">773</span>K <span class="number">8</span>月  <span class="number">10</span> <span class="number">20</span>:<span class="number">54</span> libboringssl.<span class="keyword">cr</span>.<span class="keyword">so</span></div><div class="line">-rwxrwxr-<span class="keyword">x</span>  <span class="number">1</span> chrome chrome  <span class="number">74</span>K <span class="number">8</span>月  <span class="number">10</span> <span class="number">20</span>:<span class="number">55</span> libcrcrypto.<span class="keyword">cr</span>.<span class="keyword">so</span></div><div class="line">-rwxrwxr-<span class="keyword">x</span>  <span class="number">1</span> chrome chrome <span class="number">1.3</span>M <span class="number">8</span>月  <span class="number">10</span> <span class="number">20</span>:<span class="number">55</span> libicui18n.<span class="keyword">cr</span>.<span class="keyword">so</span></div><div class="line">-rwxrwxr-<span class="keyword">x</span>  <span class="number">1</span> chrome chrome <span class="number">902</span>K <span class="number">8</span>月  <span class="number">10</span> <span class="number">20</span>:<span class="number">55</span> libicuuc.<span class="keyword">cr</span>.<span class="keyword">so</span></div><div class="line">-rwxrwxr-<span class="keyword">x</span>  <span class="number">1</span> chrome chrome <span class="number">4.1</span>M <span class="number">8</span>月  <span class="number">10</span> <span class="number">20</span>:<span class="number">59</span> libnet.<span class="keyword">cr</span>.<span class="keyword">so</span></div><div class="line">-rwxrwxr-<span class="keyword">x</span>  <span class="number">1</span> chrome chrome <span class="number">122</span>K <span class="number">8</span>月  <span class="number">10</span> <span class="number">20</span>:<span class="number">55</span> libprefs.<span class="keyword">cr</span>.<span class="keyword">so</span></div><div class="line">-rwxrwxr-<span class="keyword">x</span>  <span class="number">1</span> chrome chrome <span class="number">182</span>K <span class="number">8</span>月  <span class="number">10</span> <span class="number">20</span>:<span class="number">55</span> libprotobuf_lite.<span class="keyword">cr</span>.<span class="keyword">so</span></div><div class="line">-rwxrwxr-<span class="keyword">x</span>  <span class="number">1</span> chrome chrome  <span class="number">90</span>K <span class="number">8</span>月  <span class="number">10</span> <span class="number">20</span>:<span class="number">59</span> liburl.<span class="keyword">cr</span>.<span class="keyword">so</span></div></pre></td></tr></table></figure></p>
<p>总共10个共享库文件。</p>
<p>在我们的工程的app模块的jni目录下为chromium创建文件夹<code>app/src/main/jni/third_party/chromium/libs</code>和<code>app/src/main/jni/third_party/chromium/include</code>，分别用于存放我们编译出来的共享库文件和net等模块导出的头文件及这些头文件include的其它头文件。</p>
<p>这里我们将编译出来的所有so文件拷贝到<code>app/src/main/jni/third_party/chromium/libs/armeabi</code>和<code>app/src/main/jni/third_party/chromium/libs/armeabi-v7a</code>目录下：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cp out<span class="regexp">/Default/</span>*.so <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/libs/</span>armeabi/</div><div class="line">cp out<span class="regexp">/Default/</span>*.so <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/libs/</span>armeabi-v7a/</div></pre></td></tr></table></figure></p>
<p>编译共享库<strong>似乎</strong>挺顺利。</p>
<h1 id="提取导出头文件"><a href="#提取导出头文件" class="headerlink" title="提取导出头文件"></a>提取导出头文件</h1><p>为了使用net模块提供的API，我们不可避免地要将net导出的头文件引入我们的项目。要做到这些，我们首先就需要从chromium工程中提取net导出的头文件。不像许多其它的C++项目，源代码文件、私有头文件及导出头文件存放的位置被很好地做了区隔，chromium各个模块的所有头文件和源代码文件都是放在一起的。这还是给我们提取导出头文件的工作带来了一点麻烦。</p>
<p>这里我们借助于gn工具提供的desc功能（关于gn工具的用法，可以参考<a href="http://my.oschina.net/wolfcs/blog/726696" target="_blank" rel="external">GN的使用 - GN工具</a>一文），输出中如下的这两段：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ gn desc out/Default/ net</div><div class="line">Target <span class="comment">//net:net</span></div><div class="line"><span class="keyword">Type</span>: shared_library</div><div class="line">Toolchain: <span class="comment">//build/toolchain/android:arm</span></div><div class="line"></div><div class="line">sources</div><div class="line">  <span class="comment">//net/base/address_family.cc</span></div><div class="line">  <span class="comment">//net/base/address_family.h</span></div><div class="line"><span class="params">...</span><span class="params">...</span></div><div class="line"></div><div class="line"><span class="keyword">public</span></div><div class="line">  <span class="meta">[</span><span class="literal">All</span> headers listed <span class="keyword">in</span> the sources are <span class="keyword">public</span>.<span class="meta">]</span></div></pre></td></tr></table></figure></p>
<p>编写脚本来实现。</p>
<p>我们可以传入<strong><em>[chromium代码库的src目录路径]</em></strong>，<strong><em>[输出目录的路径]</em></strong>，<strong><em>[模块名]</em></strong>，及<strong><em>[保存头文件的目标目录路径]</em></strong>作为参数，来提取模块的所有导出头文件，<strong><em>[保存头文件的目标目录路径]</em></strong>参数缺失时默认使用当前目录，比如：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cd <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium/include</div><div class="line">$ chromium_mod_headers_extracter.py <span class="regexp">~/data/</span>chromium_android<span class="regexp">/src  out/</span>Default net</div></pre></td></tr></table></figure></p>
<p>这里一并将该脚本的完整内容贴出来：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> shutil</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_usage_and_exit</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> sys.argv[<span class="number">0</span>] + <span class="string">" [chromium_src_root]"</span> + <span class="string">"[out_dir]"</span> + <span class="string">" [target_name]"</span> + <span class="string">" [targetroot]"</span></div><div class="line">    exit(<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy_file</span><span class="params">(src_file_path, target_file_path)</span>:</span></div><div class="line">    <span class="keyword">if</span> os.path.exists(target_file_path):</div><div class="line">        <span class="keyword">return</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(src_file_path):</div><div class="line">        <span class="keyword">return</span></div><div class="line">    target_dir_path = os.path.dirname(target_file_path)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(target_dir_path):</div><div class="line">        os.makedirs(target_dir_path)</div><div class="line"></div><div class="line">    shutil.copy(src_file_path, target_dir_path)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy_all_files</span><span class="params">(source_dir, all_files, target_dir)</span>:</span></div><div class="line">    <span class="keyword">for</span> one_file <span class="keyword">in</span> all_files:</div><div class="line">        source_path = source_dir + os.path.sep + one_file</div><div class="line">        target_path = target_dir + os.path.sep + one_file</div><div class="line">        copy_file(source_path, target_path)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">4</span> <span class="keyword">or</span> len(sys.argv) &gt; <span class="number">5</span>:</div><div class="line">        print_usage_and_exit()</div><div class="line">    chromium_src_root = sys.argv[<span class="number">1</span>]</div><div class="line">    out_dir = sys.argv[<span class="number">2</span>]</div><div class="line">    target_name = sys.argv[<span class="number">3</span>]</div><div class="line">    target_root_path = <span class="string">"."</span></div><div class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">5</span>:</div><div class="line">        target_root_path = sys.argv[<span class="number">4</span>]</div><div class="line">    target_root_path = os.path.abspath(target_root_path)</div><div class="line"></div><div class="line">    os.chdir(chromium_src_root)</div><div class="line"></div><div class="line">    cmd = <span class="string">"gn desc "</span> + out_dir + <span class="string">" "</span> + target_name</div><div class="line">    outputs = os.popen(cmd).readlines()</div><div class="line">    source_start = <span class="keyword">False</span></div><div class="line">    all_headers = []</div><div class="line"></div><div class="line">    public_start = <span class="keyword">False</span></div><div class="line">    public_headers = []</div><div class="line"></div><div class="line">    <span class="keyword">for</span> output_line <span class="keyword">in</span> outputs:</div><div class="line">        output_line = output_line.strip()</div><div class="line">        <span class="keyword">if</span> output_line.startswith(<span class="string">"sources"</span>):</div><div class="line">            source_start = <span class="keyword">True</span></div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">elif</span> source_start <span class="keyword">and</span> len(output_line) == <span class="number">0</span>:</div><div class="line">            source_start = <span class="keyword">False</span></div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">elif</span> source_start <span class="keyword">and</span> output_line.endswith(<span class="string">".h"</span>):</div><div class="line">            output_line = output_line[<span class="number">1</span>:]</div><div class="line">            all_headers.append(output_line)</div><div class="line">        <span class="keyword">elif</span> output_line == <span class="string">"public"</span>:</div><div class="line">            public_start = <span class="keyword">True</span></div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">elif</span> public_start <span class="keyword">and</span> len(output_line) == <span class="number">0</span>:</div><div class="line">            public_start = <span class="keyword">False</span></div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">elif</span> public_start:</div><div class="line">            public_headers.append(output_line)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> len(public_headers) == <span class="number">1</span>:</div><div class="line">        public_headers = all_headers</div><div class="line">    <span class="keyword">if</span> len(public_headers) &gt; <span class="number">1</span>:</div><div class="line">        copy_all_files(chromium_src_root, public_headers, target_dir=target_root_path)</div></pre></td></tr></table></figure></p>
<h1 id="Chromium-net的简单使用"><a href="#Chromium-net的简单使用" class="headerlink" title="Chromium net的简单使用"></a>Chromium net的简单使用</h1><p>参照<code>chromium/src/net/tools/get_server_time/get_server_time.cc</code>的代码，来编写简单的示例程序。首先是JNI（JNI的用法，可以参考<a href="http://my.oschina.net/wolfcs/blog/111309" target="_blank" rel="external">android app中使用JNI</a>）的Java层代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.example.hanpfei0306.myapplication;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetUtils</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.loadLibrary(<span class="string">"neteasenet"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeSendRequest</span><span class="params">(String url)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(String url)</span> </span>&#123;</div><div class="line">        nativeSendRequest(url);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后是native层的JNI代码，<code>MyApplication/app/src/main/jni/src/NetJni.cpp</code>：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Created by hanpfei0306 on 16-8-4.</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/base/network_delegate_impl.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"jni.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"base/at_exit.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"base/json/json_writer.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"base/message_loop/message_loop.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"base/memory/ptr_util.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"base/run_loop.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"base/values.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"net/http/http_response_headers.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"net/proxy/proxy_config_service_fixed.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"net/url_request/url_fetcher.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"net/url_request/url_fetcher_delegate.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"net/url_request/url_request_context.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"net/url_request/url_request_context_builder.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"net/url_request/url_request_context_getter.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"net/url_request/url_request.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"JNIHelper.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG <span class="meta-string">"NetUtils"</span></span></div><div class="line"></div><div class="line"><span class="comment">// Simply quits the current message loop when finished.  Used to make</span></div><div class="line"><span class="comment">// URLFetcher synchronous.</span></div><div class="line"><span class="keyword">class</span> QuitDelegate : <span class="keyword">public</span> net::URLFetcherDelegate &#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    QuitDelegate() &#123;&#125;</div><div class="line"></div><div class="line">    ~QuitDelegate() override &#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">// net::URLFetcherDelegate implementation.</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnURLFetchComplete</span><span class="params">(<span class="keyword">const</span> net::URLFetcher* source)</span> override </span>&#123;</div><div class="line">        LOGE(<span class="string">"OnURLFetchComplete"</span>);</div><div class="line">        base::MessageLoop::current()-&gt;QuitWhenIdle();</div><div class="line">        <span class="keyword">int</span> responseCode = source-&gt;GetResponseCode();</div><div class="line"></div><div class="line">        <span class="keyword">const</span> net::URLRequestStatus status = source-&gt;GetStatus();</div><div class="line">        <span class="keyword">if</span> (status.status() != net::URLRequestStatus::SUCCESS) &#123;</div><div class="line">            LOGW(<span class="string">"Request failed with error code: %s"</span>, net::ErrorToString(status.error()).c_str());</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">const</span> net::HttpResponseHeaders* <span class="keyword">const</span> headers = source-&gt;GetResponseHeaders();</div><div class="line">        <span class="keyword">if</span> (!headers) &#123;</div><div class="line">            LOGW(<span class="string">"Response does not have any headers"</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">size_t</span> iter = <span class="number">0</span>;</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> header_name;</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> date_header;</div><div class="line">        <span class="keyword">while</span> (headers-&gt;EnumerateHeaderLines(&amp;iter, &amp;header_name, &amp;date_header)) &#123;</div><div class="line">            LOGW(<span class="string">"Got %s header: %s\n"</span>, header_name.c_str(), date_header.c_str());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> responseStr;</div><div class="line">        <span class="keyword">if</span>(!source-&gt;GetResponseAsString(&amp;responseStr)) &#123;</div><div class="line">            LOGW(<span class="string">"Get response as string failed!"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        LOGI(<span class="string">"Content len = %lld, response code = %d, response = %s"</span>,</div><div class="line">             source-&gt;GetReceivedResponseContentLength(),</div><div class="line">             source-&gt;GetResponseCode(),</div><div class="line">             responseStr.c_str());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnURLFetchDownloadProgress</span><span class="params">(<span class="keyword">const</span> net::URLFetcher* source,</span></span></div><div class="line">                                    <span class="keyword">int64_t</span> current,</div><div class="line">                                    <span class="keyword">int64_t</span> total) override &#123;</div><div class="line">        LOGE(<span class="string">"OnURLFetchDownloadProgress"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnURLFetchUploadProgress</span><span class="params">(<span class="keyword">const</span> net::URLFetcher* source,</span></span></div><div class="line">                                  <span class="keyword">int64_t</span> current,</div><div class="line">                                  <span class="keyword">int64_t</span> total) override &#123;</div><div class="line">        LOGE(<span class="string">"OnURLFetchUploadProgress"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    DISALLOW_COPY_AND_ASSIGN(QuitDelegate);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// NetLog::ThreadSafeObserver implementation that simply prints events</span></div><div class="line"><span class="comment">// to the logs.</span></div><div class="line"><span class="keyword">class</span> PrintingLogObserver : <span class="keyword">public</span> net::NetLog::ThreadSafeObserver &#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    PrintingLogObserver() &#123;&#125;</div><div class="line"></div><div class="line">    ~PrintingLogObserver() override &#123;</div><div class="line">        <span class="comment">// This is guaranteed to be safe as this program is single threaded.</span></div><div class="line">        net_log()-&gt;DeprecatedRemoveObserver(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// NetLog::ThreadSafeObserver implementation:</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnAddEntry</span><span class="params">(<span class="keyword">const</span> net::NetLog::Entry&amp; entry)</span> override </span>&#123;</div><div class="line">        <span class="comment">// The log level of the entry is unknown, so just assume it maps</span></div><div class="line">        <span class="comment">// to VLOG(1).</span></div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> source_type = net::NetLog::SourceTypeToString(entry.source().type);</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> event_type = net::NetLog::EventTypeToString(entry.type());</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> event_phase = net::NetLog::EventPhaseToString(entry.phase());</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;base::Value&gt; params(entry.ParametersToValue());</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> params_str;</div><div class="line">        <span class="keyword">if</span> (params.get()) &#123;</div><div class="line">            base::JSONWriter::Write(*params, &amp;params_str);</div><div class="line">            params_str.insert(<span class="number">0</span>, <span class="string">": "</span>);</div><div class="line">        &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG_ALL</span></div><div class="line">        LOGI(<span class="string">"source_type = %s (id = %u): entry_type = %s : event_phase = %s params_str = %s"</span>,</div><div class="line">             source_type, entry.source().id, event_type, event_phase, params_str.c_str());</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    DISALLOW_COPY_AND_ASSIGN(PrintingLogObserver);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// Builds a URLRequestContext assuming there's only a single loop.</span></div><div class="line"><span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;net::URLRequestContext&gt; BuildURLRequestContext(net::NetLog *net_log) &#123;</div><div class="line">    net::URLRequestContextBuilder builder;</div><div class="line">    builder.set_net_log(net_log);</div><div class="line"><span class="comment">//#if defined(OS_LINUX)</span></div><div class="line">    <span class="comment">// On Linux, use a fixed ProxyConfigService, since the default one</span></div><div class="line">  <span class="comment">// depends on glib.</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// TODO(akalin): Remove this once http://crbug.com/146421 is fixed.</span></div><div class="line">  builder.set_proxy_config_service(</div><div class="line">          base::WrapUnique(<span class="keyword">new</span> net::ProxyConfigServiceFixed(net::ProxyConfig())));</div><div class="line"><span class="comment">//#endif</span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;net::URLRequestContext&gt; context(builder.Build());</div><div class="line">    context-&gt;set_net_log(net_log);</div><div class="line">    <span class="keyword">return</span> context;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">NetUtils_nativeSendRequest</span><span class="params">(JNIEnv* env, jclass, jstring javaUrl)</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* native_url = env-&gt;GetStringUTFChars(javaUrl, <span class="literal">NULL</span>);</div><div class="line">    LOGW(<span class="string">"Url: %s"</span>, native_url);</div><div class="line">    base::AtExitManager exit_manager;</div><div class="line">    LOGW(<span class="string">"Url: %s"</span>, native_url);</div><div class="line"></div><div class="line">    <span class="function">GURL <span class="title">url</span><span class="params">(native_url)</span></span>;</div><div class="line">    <span class="keyword">if</span> (!url.is_valid() || (url.scheme() != <span class="string">"http"</span> &amp;&amp; url.scheme() != <span class="string">"https"</span>)) &#123;</div><div class="line">        LOGW(<span class="string">"Not valid url: %s"</span>, native_url);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    LOGW(<span class="string">"Url: %s"</span>, native_url);</div><div class="line"></div><div class="line">    base::MessageLoopForIO main_loop;</div><div class="line"></div><div class="line">    QuitDelegate delegate;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;net::URLFetcher&gt; fetcher =</div><div class="line">            net::URLFetcher::Create(url, net::URLFetcher::GET, &amp;delegate);</div><div class="line"></div><div class="line">    net::NetLog *net_log = <span class="literal">nullptr</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG_ALL</span></div><div class="line">    net_log = <span class="keyword">new</span> net::NetLog;</div><div class="line">    PrintingLogObserver printing_log_observer;</div><div class="line">    net_log-&gt;DeprecatedAddObserver(&amp;printing_log_observer,</div><div class="line">                                  net::NetLogCaptureMode::IncludeSocketBytes());</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;net::URLRequestContext&gt; url_request_context(BuildURLRequestContext(net_log));</div><div class="line">    fetcher-&gt;SetRequestContext(</div><div class="line">            <span class="comment">// Since there's only a single thread, there's no need to worry</span></div><div class="line">            <span class="comment">// about when the URLRequestContext gets created.</span></div><div class="line">            <span class="comment">// The URLFetcher will take a reference on the object, and hence</span></div><div class="line">            <span class="comment">// implicitly take ownership.</span></div><div class="line">            <span class="keyword">new</span> net::TrivialURLRequestContextGetter(url_request_context.get(),</div><div class="line">                                                    main_loop.task_runner()));</div><div class="line">    fetcher-&gt;Start();</div><div class="line">    <span class="comment">// |delegate| quits |main_loop| when the request is done.</span></div><div class="line">    main_loop.Run();</div><div class="line"></div><div class="line">    env-&gt;ReleaseStringUTFChars(javaUrl, native_url);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">jniRegisterNativeMethods</span><span class="params">(JNIEnv* env, <span class="keyword">const</span> <span class="keyword">char</span> *classPathName, JNINativeMethod *nativeMethods, jint nMethods)</span> </span>&#123;</div><div class="line">    jclass clazz;</div><div class="line">    clazz = env-&gt;FindClass(classPathName);</div><div class="line">    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span> JNI_FALSE;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (env-&gt;RegisterNatives(clazz, nativeMethods, nMethods) &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> JNI_FALSE;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> JNI_TRUE;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> JNINativeMethod gNetUtilsMethods[] = &#123;</div><div class="line">        NATIVE_METHOD(NetUtils, nativeSendRequest, <span class="string">"(Ljava/lang/String;)V"</span>),</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_com_netease_volleydemo_NetUtils</span><span class="params">(JNIEnv* env)</span> </span>&#123;</div><div class="line">    jniRegisterNativeMethods(env, <span class="string">"com/example/hanpfei0306/myapplication/NetUtils"</span>,</div><div class="line">                             gNetUtilsMethods, NELEM(gNetUtilsMethods));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// DalvikVM calls this on startup, so we can statically register all our native methods.</span></div><div class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span>*)</span> </span>&#123;</div><div class="line">    JNIEnv* env;</div><div class="line">    <span class="keyword">if</span> (vm-&gt;GetEnv(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>**&gt;(&amp;env), JNI_VERSION_1_6) != JNI_OK) &#123;</div><div class="line">        LOGE(<span class="string">"JavaVM::GetEnv() failed"</span>);</div><div class="line">        <span class="built_in">abort</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    register_com_netease_volleydemo_NetUtils(env);</div><div class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个文件里，在nativeSendRequest()函数中调用chromium net做了网络请求，获取响应，并打印出响应的headers及响应的content。</p>
<p><code>MyApplication/app/src/main/jni/src/JNIHelper.h</code>中定义了一些宏，以方便native methods的注册，其具体内容则为：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CANDYWEBCACHE_JNIHELPER_H</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> CANDYWEBCACHE_JNIHELPER_H</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG,TAG ,__VA_ARGS__)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO,TAG ,__VA_ARGS__)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGW(...) __android_log_print(ANDROID_LOG_WARN,TAG ,__VA_ARGS__)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR,TAG ,__VA_ARGS__)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGF(...) __android_log_print(ANDROID_LOG_FATAL,TAG ,__VA_ARGS__)</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> NELEM</span></div><div class="line"><span class="meta"># <span class="meta-keyword">define</span> NELEM(x) ((int) (sizeof(x) / sizeof((x)[0])))</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NATIVE_METHOD(className, functionName, signature) \</span></div><div class="line">    &#123; #functionName, signature, reinterpret_cast<span class="meta-string">&lt;void*&gt;</span>(className ## _ ## functionName) &#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//CANDYWEBCACHE_JNIHELPER_H</span></span></div></pre></td></tr></table></figure></p>
<h1 id="配置Gradle"><a href="#配置Gradle" class="headerlink" title="配置Gradle"></a>配置Gradle</h1><p>要在Android Studio中使用JNI，还需要对Gralde做一些特别的配置，具体可以参考<a href="http://my.oschina.net/wolfcs/blog/550677" target="_blank" rel="external">在Android Studio中使用NDK/JNI - 实验版插件用户指南</a>一文。这里需要对<strong><em><code>MyApplication/build.gradle</code></em></strong>、<strong><em><code>MyApplication/gradle/wrapper/gradle-wrapper.properties</code></em></strong>，和<strong><em><code>MyApplication/app/build.gradle</code></em></strong>这几个文件做修改。</p>
<p>修改<strong><em><code>MyApplication/build.gradle</code></em></strong>文件，最终的内容为：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span></div><div class="line"></div><div class="line"><span class="keyword">buildscript</span> &#123;</div><div class="line">    <span class="keyword">repositories</span> &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">dependencies</span> &#123;</div><div class="line">        <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle-experimental:0.7.0'</span></div><div class="line"></div><div class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></div><div class="line">        <span class="comment">// in the individual module build.gradle files</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">allprojects</span> &#123;</div><div class="line">    <span class="keyword">repositories</span> &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">task</span> clean(type: <span class="keyword">Delete</span>) &#123;</div><div class="line">    <span class="keyword">delete</span> rootProject.buildDir</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这个文件中配置gradle插件的版本为<strong><code>gradle-experimental:0.7.0</code></strong>。</p>
<p>修改<strong><em><code>MyApplication/gradle/wrapper/gradle-wrapper.properties</code></em></strong>文件，最终的内容为：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Mon Dec 28 10:00:20 PST 2015</span></div><div class="line"><span class="attr">distributionBase</span>=GRADLE_USER_HOME</div><div class="line"><span class="attr">distributionPath</span>=wrapper/dists</div><div class="line"><span class="attr">zipStoreBase</span>=GRADLE_USER_HOME</div><div class="line"><span class="attr">zipStorePath</span>=wrapper/dists</div><div class="line"><span class="attr">distributionUrl</span>=https\://services.gradle.org/distributions/gradle-<span class="number">2.10</span>-all.zip</div></pre></td></tr></table></figure></p>
<p>在这个文件中配置gradle的版本。</p>
<p>修改<strong><em><code>MyApplication/app/build.gradle</code></em></strong>文件，最终的内容为：<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.model.application'</span></div><div class="line"></div><div class="line">model &#123;</div><div class="line">    repositories &#123;</div><div class="line">        libs(PrebuiltLibraries) &#123;</div><div class="line">            chromium_net &#123;</div><div class="line">                headers.srcDir <span class="string">"src/main/jni/third_party/chromium/include"</span></div><div class="line">                binaries.withType(SharedLibraryBinary) &#123;</div><div class="line">                    sharedLibraryFile = file(<span class="string">"src/main/jni/third_party/chromium/libs/$&#123;targetPlatform.getName()&#125;/libnet.cr.so"</span>)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    android &#123;</div><div class="line">        compileSdkVersion <span class="number">23</span></div><div class="line">        buildToolsVersion <span class="string">"23.0.3"</span></div><div class="line"></div><div class="line">        defaultConfig &#123;</div><div class="line">            applicationId <span class="string">"com.example.hanpfei0306.myapplication"</span></div><div class="line">            minSdkVersion.apiLevel <span class="number">19</span></div><div class="line">            targetSdkVersion.apiLevel <span class="number">21</span></div><div class="line">            versionCode <span class="number">1</span></div><div class="line">            versionName <span class="string">"1.0"</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ndk &#123;</div><div class="line">            moduleName <span class="string">"neteasenet"</span></div><div class="line"></div><div class="line">            CFlags.addAll([<span class="string">'-I'</span> + file(<span class="string">'src/main/jni/third_party/chromium/include/'</span>),])</div><div class="line"></div><div class="line">            cppFlags.addAll([<span class="string">'-I'</span> + file(<span class="string">'src/main/jni/third_party/chromium/include'</span>),])</div><div class="line"></div><div class="line">            ldLibs.add(<span class="string">"android"</span>)</div><div class="line">            ldLibs.add(<span class="string">"log"</span>)</div><div class="line">            ldLibs.add(<span class="string">"z"</span>)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        sources &#123;</div><div class="line">            main &#123;</div><div class="line">                java &#123;</div><div class="line">                    source &#123;</div><div class="line">                        srcDir <span class="string">"src/main/java"</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                jni &#123;</div><div class="line">                    source &#123;</div><div class="line">                        srcDirs = [<span class="string">"src/main/jni"</span>,]</div><div class="line">                    &#125;</div><div class="line">                    dependencies &#123;</div><div class="line">                        library <span class="string">'chromium_net'</span> linkage <span class="string">'shared'</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                jniLibs &#123;</div><div class="line">                    source &#123;</div><div class="line">                        srcDirs =[<span class="string">"src/main/jni/third_party/chromium/libs"</span>,]</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        buildTypes &#123;</div><div class="line">            debug &#123;</div><div class="line">                ndk &#123;</div><div class="line">                    abiFilters.add(<span class="string">"armeabi"</span>)</div><div class="line">                    abiFilters.add(<span class="string">"armeabi-v7a"</span>)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            release &#123;</div><div class="line">                minifyEnabled false</div><div class="line">                proguardFiles.add(file(<span class="string">"proguard-rules.pro"</span>))</div><div class="line">                ndk &#123;</div><div class="line">                    abiFilters.add(<span class="string">"armeabi"</span>)</div><div class="line">                    abiFilters.add(<span class="string">"armeabi-v7a"</span>)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    android.packagingOptions &#123;</div><div class="line">        exclude <span class="string">'META-INF/INDEX.LIST'</span></div><div class="line">        exclude <span class="string">'META-INF/io.netty.versions.properties'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">dependencies &#123;</div><div class="line">    compile fileTree(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</div><div class="line">    testCompile <span class="string">'junit:junit:4.12'</span></div><div class="line"></div><div class="line">    compile <span class="string">'com.jcraft:jzlib:1.1.2'</span></div><div class="line">    compile <span class="string">'com.android.support:appcompat-v7:23.4.0'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们在这里对native代码的整个编译、链接做配置。这包括，编译要包含哪些源文件，编译时头文件的搜索路径，我们的native代码依赖的要链接的系统共享库/静态库，我们的native代码依赖的要链接的预编译的共享库/静态库，比如我们的chromium net等。配置编译出来的共享库的文件名。同时还要为<code>buildTypes</code>配置<code>abiFilters</code>，以防止构建系统尝试为其它我们不打算支持的ABI，如arm64-v8a、mips、mips64、x86和x86_64，构建共享库，而发生找不到响应的chromium net的so文件的错误。</p>
<h1 id="应用工程编译"><a href="#应用工程编译" class="headerlink" title="应用工程编译"></a>应用工程编译</h1><p>做了上面的配置之后，我们怀着激动的心情，小心翼翼地点击“Rebuild Project”菜单项，并期待奇迹发生。编译过程启动之后，很快就终止了，报出了如下的error：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">:<span class="string">app:</span>compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.cpp</div><div class="line"><span class="string">Information:</span>(<span class="number">6</span>) (Unknown) In file included</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>net<span class="regexp">/base/</span>network_delegate_impl.h</div><div class="line"><span class="string">Error:</span>(<span class="number">10</span>, <span class="number">35</span>) base<span class="regexp">/strings/</span>string16.<span class="string">h:</span> No such file or directory</div><div class="line">compilation terminated.</div><div class="line"><span class="string">Error:</span>Execution failed <span class="keyword">for</span> task <span class="string">':app:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp'</span>.</div><div class="line">&gt; A build operation failed.</div><div class="line">      C++ compiler failed <span class="keyword">while</span> compiling NetJni.cpp.</div><div class="line">  See the complete log <span class="string">at:</span> <span class="string">file:</span><span class="comment">///media/data/MyProjects/MyApplication/app/build/tmp/compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp/output.txt</span></div><div class="line"><span class="string">Information:</span>BUILD FAILED</div><div class="line"><span class="string">Information:</span>Total <span class="string">time:</span> <span class="number">4.239</span> secs</div><div class="line"><span class="string">Information:</span><span class="number">2</span> errors</div><div class="line"><span class="string">Information:</span><span class="number">0</span> warnings</div><div class="line"><span class="string">Information:</span>See complete output <span class="keyword">in</span> console</div></pre></td></tr></table></figure></p>
<p>提示找不到base模块的头文件<strong><code>base/strings/string16.h</code></strong>。base模块是chromium项目中大多数模块都会依赖的模块，它提供了许多基本的功能，比如字符串，文件操作，消息队列MessageQueue，内存管理的一些操作等等。net模块的头文件include了base的头文件的地方还不少，而在我们自己的JNI native层代码中，也难免要引用到base定义的一些组件，因而我们需要将base模块导出的头文件一并引入我们的工程。提取base的头文件并引入我们的工程：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cd <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium/include</div><div class="line">$ chromium_mod_headers_extracter.py <span class="regexp">~/data/</span>chromium_android<span class="regexp">/src  out/</span>Default base</div></pre></td></tr></table></figure></p>
<h2 id="配置stl："><a href="#配置stl：" class="headerlink" title="配置stl："></a>配置stl：</h2><p>引入了base模块的头文件之后，再次编译我们的应用工程。又报error了：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">:<span class="string">app:</span>compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>net<span class="regexp">/base/</span>network_delegate_impl.h</div><div class="line"><span class="string">Information:</span>(<span class="number">10</span>) (Unknown) In file included</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base<span class="regexp">/strings/</span>string16.h</div><div class="line"><span class="string">Error:</span>(<span class="number">33</span>, <span class="number">22</span>) <span class="string">functional:</span> No such file or directory</div><div class="line">compilation terminated.</div><div class="line"><span class="string">Error:</span>Execution failed <span class="keyword">for</span> task <span class="string">':app:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp'</span>.</div><div class="line">&gt; A build operation failed.</div><div class="line">      C++ compiler failed <span class="keyword">while</span> compiling NetJni.cpp.</div><div class="line">  See the complete log <span class="string">at:</span> <span class="string">file:</span><span class="comment">///media/data/MyProjects/MyApplication/app/build/tmp/compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp/output.txt</span></div><div class="line"><span class="string">Information:</span>BUILD FAILED</div><div class="line"><span class="string">Information:</span>Total <span class="string">time:</span> <span class="number">10.702</span> secs</div><div class="line"><span class="string">Information:</span><span class="number">2</span> errors</div><div class="line"><span class="string">Information:</span><span class="number">0</span> warnings</div><div class="line"><span class="string">Information:</span>See complete output <span class="keyword">in</span> console</div></pre></td></tr></table></figure></p>
<p>这里是提示找不到STL的头文件。在MyApplication/app/build.gradle中配置stl：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">stl</span> <span class="string">"gnustl_static"</span></div></pre></td></tr></table></figure></p>
<h2 id="引入chromium的build配置头文件"><a href="#引入chromium的build配置头文件" class="headerlink" title="引入chromium的build配置头文件"></a>引入chromium的build配置头文件</h2><p>配置了stl之后，再次编译我们的应用工程。接着报error：<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="number">18</span>:<span class="number">52</span>:<span class="number">21</span>: Executing external task <span class="string">'assembleDebug'</span>...</div><div class="line">Observed package id <span class="string">'build-tools;20.0.0'</span> <span class="keyword">in</span> inconsistent location <span class="string">'/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/android-4.4W'</span> (Expected <span class="string">'/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/20.0.0'</span>)</div><div class="line">Incremental java compilation is <span class="keyword">an</span> incubating feature.</div><div class="line">In <span class="built_in">file</span> included <span class="built_in">from</span> /media/data/MyProjects/MyApplication/app/src/main/jni/third_party/chromium/<span class="built_in">include</span>/net/base/network_delegate_impl.h:<span class="number">10</span>:<span class="number">0</span>,</div><div class="line">                 <span class="built_in">from</span> /media/data/MyProjects/MyApplication/app/src/main/jni/src/NetJni.cpp:<span class="number">6</span>:</div><div class="line">/media/data/MyProjects/MyApplication/app/src/main/jni/third_party/chromium/<span class="built_in">include</span>/base/strings/string16.h:<span class="number">37</span>:<span class="number">32</span>: fatal error: build/build_config.h: No such <span class="built_in">file</span> <span class="keyword">or</span> <span class="built_in">directory</span></div><div class="line"> <span class="comment">#include "build/build_config.h"</span></div><div class="line">                                ^</div><div class="line">compilation terminated.</div><div class="line"></div><div class="line">:app:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp FAILED</div><div class="line"></div><div class="line">FAILURE: Build failed <span class="keyword">with</span> <span class="keyword">an</span> exception.</div><div class="line"></div><div class="line">* What went wrong:</div><div class="line">Execution failed <span class="keyword">for</span> task <span class="string">':app:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp'</span>.</div><div class="line">&gt; A build operation failed.</div><div class="line">      C++ compiler failed <span class="keyword">while</span> compiling NetJni.cpp.</div><div class="line">  See <span class="keyword">the</span> complete <span class="built_in">log</span> <span class="keyword">at</span>: <span class="built_in">file</span>:<span class="comment">///media/data/MyProjects/MyApplication/app/build/tmp/compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp/output.txt</span></div><div class="line"></div><div class="line">* Try:</div><div class="line">Run <span class="keyword">with</span> <span class="comment">--stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.</span></div><div class="line"></div><div class="line">BUILD FAILED</div><div class="line"></div><div class="line">Total <span class="built_in">time</span>: <span class="number">2.773</span> <span class="built_in">secs</span></div><div class="line">C++ compiler failed <span class="keyword">while</span> compiling NetJni.cpp.</div><div class="line"><span class="number">18</span>:<span class="number">52</span>:<span class="number">24</span>: External task execution finished <span class="string">'assembleDebug'</span>.</div></pre></td></tr></table></figure></p>
<p>提示找不到”build/build_config.h”文件。这个文件定义了一些全局性的宏，以对编译做一些全局的控制。这次直接将chromium代码库中的对应文件拷贝过来。</p>
<h2 id="引入遗漏的头文件"><a href="#引入遗漏的头文件" class="headerlink" title="引入遗漏的头文件"></a>引入遗漏的头文件</h2><p>再次编译我们的应用工程。接着报error：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="number">18</span>:<span class="number">55</span>:<span class="number">46</span>: Executing external <span class="keyword">task</span> <span class="string">'assembleDebug'</span>...</div><div class="line">Observed <span class="keyword">package</span> id <span class="string">'build-tools;20.0.0'</span> in inconsistent location <span class="string">'/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/android-4.4W'</span> (Expected <span class="string">'/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/20.0.0'</span>)</div><div class="line">Incremental java compilation is an incubating feature.</div><div class="line">In <span class="keyword">file</span> included <span class="keyword">from</span> <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>net<span class="regexp">/base/</span>completion_callback.h:<span class="number">10</span>:<span class="number">0</span>,</div><div class="line">                 <span class="keyword">from</span> <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>net<span class="regexp">/base/</span>network_delegate_impl.h:<span class="number">11</span>,</div><div class="line">                 <span class="keyword">from</span> <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.cpp:<span class="number">6</span>:</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base<span class="regexp">/callback.h:8:35: fatal error: base/</span>callback_forward.h: No such <span class="keyword">file</span> or directory</div><div class="line"> #<span class="keyword">include</span> <span class="string">"base/callback_forward.h"</span></div><div class="line">                                   ^</div><div class="line">compilation terminated.</div><div class="line"></div><div class="line">:app:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp FAILED</div><div class="line"></div><div class="line">FAILURE: Build failed with an exception.</div><div class="line"></div><div class="line">* What went wrong:</div><div class="line">Execution failed <span class="keyword">for</span> <span class="keyword">task</span> <span class="string">':app:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp'</span>.</div><div class="line">&gt; A build operation failed.</div><div class="line">      C++ compiler failed <span class="keyword">while</span> compiling NetJni.cpp.</div><div class="line">  See the complete log at: <span class="keyword">file</span>:<span class="comment">///media/data/MyProjects/MyApplication/app/build/tmp/compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp/output.txt</span></div><div class="line"></div><div class="line">* <span class="keyword">Try</span>:</div><div class="line">Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.</div><div class="line"></div><div class="line">BUILD FAILED</div><div class="line"></div><div class="line">Total time: <span class="number">0.663</span> secs</div><div class="line">C++ compiler failed <span class="keyword">while</span> compiling NetJni.cpp.</div><div class="line"><span class="number">18</span>:<span class="number">55</span>:<span class="number">47</span>: External <span class="keyword">task</span> execution finished <span class="string">'assembleDebug'</span>.</div></pre></td></tr></table></figure></p>
<p>提示找不到base模块的头文件<strong><code>base/callback_forward.h</code></strong>。直接将chromium代码库中的对应文件拷贝过来。我们似乎是被<code>gn desc</code>的输出欺骗了，它似乎并没有将一个模块导出的所有的头文件都告诉我们。像 <strong><code>base/callback_forward.h</code></strong> 一样，逃过了<code>gn desc</code> 的眼睛，同时也逃过了我们提取模块头文件的脚本的眼睛的头文件还有如下的这些：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">base/message_loop/timer_slack.<span class="built_in">h</span></div><div class="line">base/files/<span class="keyword">file</span>.<span class="built_in">h</span></div><div class="line"><span class="keyword">net</span>/cert/cert_status_flags_list.<span class="built_in">h</span></div><div class="line"><span class="keyword">net</span>/cert/cert_type.<span class="built_in">h</span></div><div class="line"><span class="keyword">net</span>/base/privacy_mode.<span class="built_in">h</span></div><div class="line"><span class="keyword">net</span>/websockets/websocket_event_interface.<span class="built_in">h</span></div><div class="line"><span class="keyword">net</span>/quic/quic_alarm_factory.<span class="built_in">h</span></div></pre></td></tr></table></figure></p>
<p>这里我们就不将缺少这些文件导致的错误的错误输出列出来了，内容与前面看到的缺少<strong><code>base/callback_forward.h</code></strong>文件导致的错误的错误输出类似，解决的方法也相同。</p>
<p>算下来，我们提取模块的头文件的脚本遗漏了8个头文件。不能不让人感慨，移植这个事情真是个体力活啊。不过还好遗漏的不是80个文件，或800个，要不然真是要把人逼疯了。</p>
<h2 id="引入url模块的导出头文件"><a href="#引入url模块的导出头文件" class="headerlink" title="引入url模块的导出头文件"></a>引入url模块的导出头文件</h2><p>引入了那些遗漏的头文件之后，再次编译。继续报错：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">18:57:46: Executing external task 'assembleDebug'...</div><div class="line">Observed package id 'build-tools;20.0.0' <span class="keyword">in</span> inconsistent location '/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/android-4.4W' (Expected '/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/20.0.0')</div><div class="line">Incremental java compilation is <span class="keyword">an</span> incubating feature.</div><div class="line"><span class="keyword">In</span> <span class="keyword">file</span> included from /home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/sources/cxx-stl/gnu-libstdc++/4.9/<span class="keyword">include</span>/atomic:38:0,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/base/atomicops_internals_portable.<span class="keyword">h</span>:35,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/base/atomicops.<span class="keyword">h</span>:152,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/base/atomic_ref_count.<span class="keyword">h</span>:11,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/base/callback_internal.<span class="keyword">h</span>:11,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/base/callback.<span class="keyword">h</span>:9,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/<span class="keyword">net</span>/base/completion_callback.<span class="keyword">h</span>:10,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/<span class="keyword">net</span>/base/network_delegate_impl.<span class="keyword">h</span>:11,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/src/NetJni.cpp:6:</div><div class="line">/home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/sources/cxx-stl/gnu-libstdc++/4.9/<span class="keyword">include</span>/bits/c++0x_warning.<span class="keyword">h</span>:32:2: <span class="keyword">error</span>: #<span class="keyword">error</span> This <span class="keyword">file</span> requires compiler and library support <span class="keyword">for</span> the ISO C++ 2011 standard. This support is currently experimental, and must be enabled with the -std=c++11 or -std=gnu++11 compiler options.</div><div class="line"> #<span class="keyword">error</span> This <span class="keyword">file</span> requires compiler and library support <span class="keyword">for</span> the \</div><div class="line">  ^</div><div class="line"><span class="keyword">In</span> <span class="keyword">file</span> included from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/<span class="keyword">net</span>/base/network_delegate.<span class="keyword">h</span>:15:0,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/<span class="keyword">net</span>/base/network_delegate_impl.<span class="keyword">h</span>:12,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/src/NetJni.cpp:6:</div><div class="line">/media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/<span class="keyword">net</span>/base/auth.<span class="keyword">h</span>:13:24: fatal <span class="keyword">error</span>: url/origin.<span class="keyword">h</span>: <span class="keyword">No</span> such <span class="keyword">file</span> or directory</div><div class="line"> #<span class="keyword">include</span> <span class="string">"url/origin.h"</span></div><div class="line">                        ^</div><div class="line">compilation terminated.</div><div class="line"></div><div class="line">:<span class="keyword">app</span>:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp FAILED</div><div class="line"></div><div class="line">FAILURE: Build failed with <span class="keyword">an</span> exception.</div><div class="line"></div><div class="line"><span class="comment">* What went wrong:</span></div><div class="line">Execution failed <span class="keyword">for</span> task ':<span class="keyword">app</span>:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp'.</div><div class="line">&gt; A build operation failed.</div><div class="line">      C++ compiler failed <span class="keyword">while</span> compiling NetJni.cpp.</div><div class="line">  See the complete <span class="keyword">log</span> at: <span class="keyword">file</span>:<span class="comment">///media/data/MyProjects/MyApplication/app/build/tmp/compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp/output.txt</span></div><div class="line"></div><div class="line"><span class="comment">* Try:</span></div><div class="line"><span class="keyword">Run</span> with --stacktrace option to get the <span class="keyword">stack</span> trace. <span class="keyword">Run</span> with --info or --debug option to get <span class="keyword">more</span> <span class="keyword">log</span> output.</div><div class="line"></div><div class="line">BUILD FAILED</div><div class="line"></div><div class="line"><span class="keyword">Total</span> time: 0.722 secs</div><div class="line">C++ compiler failed <span class="keyword">while</span> compiling NetJni.cpp.</div><div class="line">18:57:47: External task execution finished 'assembleDebug'.</div></pre></td></tr></table></figure></p>
<p>这次是提示找不到url模块的头文件<strong><code>url/origin.h</code></strong>。url模块与我们要用的net联系紧密，同样不可避免地要在我们的native层代码中引用到。因而我们要将url模块导出的头文件一并引入我们的工程。提取url的导出头文件并引入我们的工程：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cd <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium/include</div><div class="line">$ chromium_mod_headers_extracter.py <span class="regexp">~/data/</span>chromium_android<span class="regexp">/src  out/</span>Default url</div></pre></td></tr></table></figure></p>
<h1 id="注释掉gtest相关代码"><a href="#注释掉gtest相关代码" class="headerlink" title="注释掉gtest相关代码"></a>注释掉gtest相关代码</h1><p>引入了url模块的导出头文件之后，再次编译。继续报错：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">19:00:48: Executing external task 'assembleDebug'...</div><div class="line">Observed package id 'build-tools;20.0.0' <span class="keyword">in</span> inconsistent location '/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/android-4.4W' (Expected '/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/20.0.0')</div><div class="line">Incremental java compilation is <span class="keyword">an</span> incubating feature.</div><div class="line"><span class="keyword">In</span> <span class="keyword">file</span> included from /home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/sources/cxx-stl/gnu-libstdc++/4.9/<span class="keyword">include</span>/atomic:38:0,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/base/atomicops_internals_portable.<span class="keyword">h</span>:35,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/base/atomicops.<span class="keyword">h</span>:152,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/base/atomic_ref_count.<span class="keyword">h</span>:11,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/base/callback_internal.<span class="keyword">h</span>:11,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/base/callback.<span class="keyword">h</span>:9,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/<span class="keyword">net</span>/base/completion_callback.<span class="keyword">h</span>:10,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/<span class="keyword">net</span>/base/network_delegate_impl.<span class="keyword">h</span>:11,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/src/NetJni.cpp:6:</div><div class="line">/home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/sources/cxx-stl/gnu-libstdc++/4.9/<span class="keyword">include</span>/bits/c++0x_warning.<span class="keyword">h</span>:32:2: <span class="keyword">error</span>: #<span class="keyword">error</span> This <span class="keyword">file</span> requires compiler and library support <span class="keyword">for</span> the ISO C++ 2011 standard. This support is currently experimental, and must be enabled with the -std=c++11 or -std=gnu++11 compiler options.</div><div class="line"> #<span class="keyword">error</span> This <span class="keyword">file</span> requires compiler and library support <span class="keyword">for</span> the \</div><div class="line">  ^</div><div class="line"><span class="keyword">In</span> <span class="keyword">file</span> included from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/<span class="keyword">net</span>/cookies/canonical_cookie.<span class="keyword">h</span>:12:0,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/<span class="keyword">net</span>/base/network_delegate.<span class="keyword">h</span>:17,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/<span class="keyword">net</span>/base/network_delegate_impl.<span class="keyword">h</span>:12,</div><div class="line">                 from /media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/src/NetJni.cpp:6:</div><div class="line">/media/data/MyProjects/MyApplication/<span class="keyword">app</span>/src/main/jni/third_party/chromium/<span class="keyword">include</span>/base/gtest_prod_util.<span class="keyword">h</span>:8:52: fatal <span class="keyword">error</span>: testing/gtest/<span class="keyword">include</span>/gtest/gtest_prod.<span class="keyword">h</span>: <span class="keyword">No</span> such <span class="keyword">file</span> or directory</div><div class="line"> #<span class="keyword">include</span> <span class="string">"testing/gtest/include/gtest/gtest_prod.h"</span></div><div class="line">                                                    ^</div><div class="line">compilation terminated.</div><div class="line"></div><div class="line">:<span class="keyword">app</span>:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp FAILED</div><div class="line"></div><div class="line">FAILURE: Build failed with <span class="keyword">an</span> exception.</div><div class="line"></div><div class="line"><span class="comment">* What went wrong:</span></div><div class="line">Execution failed <span class="keyword">for</span> task ':<span class="keyword">app</span>:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp'.</div><div class="line">&gt; A build operation failed.</div><div class="line">      C++ compiler failed <span class="keyword">while</span> compiling NetJni.cpp.</div><div class="line">  See the complete <span class="keyword">log</span> at: <span class="keyword">file</span>:<span class="comment">///media/data/MyProjects/MyApplication/app/build/tmp/compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp/output.txt</span></div><div class="line"></div><div class="line"><span class="comment">* Try:</span></div><div class="line"><span class="keyword">Run</span> with --stacktrace option to get the <span class="keyword">stack</span> trace. <span class="keyword">Run</span> with --info or --debug option to get <span class="keyword">more</span> <span class="keyword">log</span> output.</div><div class="line"></div><div class="line">BUILD FAILED</div><div class="line"></div><div class="line"><span class="keyword">Total</span> time: 0.66 secs</div><div class="line">C++ compiler failed <span class="keyword">while</span> compiling NetJni.cpp.</div><div class="line">19:00:49: External task execution finished 'assembleDebug'.</div></pre></td></tr></table></figure></p>
<p>这一次是提示找不到gtest的头文件。暂时我们还无需借助于gtest来做单元测试，因而这个include显得没有必要。我们将<strong><code>MyApplication/app/src/main/jni/third_party/chromium/include/base/gtest_prod_util.h</code></strong>文件中对<strong><code>&quot;testing/gtest/include/gtest/gtest_prod.h&quot;</code></strong>的include注释掉，同时修改<strong><code>FRIEND_TEST_ALL_PREFIXES</code></strong>宏的定义：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FRIEND_TEST_ALL_PREFIXES(test_case_name, test_name) \</span></div><div class="line">  FRIEND_TEST(test_case_name, test_name); \</div><div class="line">  FRIEND_TEST(test_case_name, DISABLED_<span class="meta">##test_name); \</span></div><div class="line">  FRIEND_TEST(test_case_name, FLAKY_<span class="meta">##test_name)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FRIEND_TEST_ALL_PREFIXES(test_case_name, test_name)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p>这样就可以注释掉类定义中专门为gtest插入的那些代码了。</p>
<h2 id="配置C-11"><a href="#配置C-11" class="headerlink" title="配置C++11"></a>配置C++11</h2><p>再次编译，继续报错：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">166</span>:<span class="number">5</span>: <span class="string">error:</span> <span class="string">'unique_ptr'</span> is not a member of <span class="string">'std'</span></div><div class="line"><span class="symbol">     std:</span>:unique_ptr&lt;<span class="string">net:</span>:URLRequestContext&gt; url_request_context(BuildURLRequestContext(net_log));</div><div class="line">     ^</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">166</span>:<span class="number">43</span>: <span class="string">error:</span> expected primary-expression before <span class="string">'&gt;'</span> token</div><div class="line"><span class="symbol">     std:</span>:unique_ptr&lt;<span class="string">net:</span>:URLRequestContext&gt; url_request_context(BuildURLRequestContext(net_log));</div><div class="line">                                           ^</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">166</span>:<span class="number">95</span>: <span class="string">error:</span> <span class="string">'BuildURLRequestContext'</span> was not declared <span class="keyword">in</span> <span class="keyword">this</span> scope</div><div class="line"><span class="symbol">     std:</span>:unique_ptr&lt;<span class="string">net:</span>:URLRequestContext&gt; url_request_context(BuildURLRequestContext(net_log));</div><div class="line">                                                                                               ^</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">166</span>:<span class="number">96</span>: <span class="string">error:</span> <span class="string">'url_request_context'</span> was not declared <span class="keyword">in</span> <span class="keyword">this</span> scope</div><div class="line"><span class="symbol">     std:</span>:unique_ptr&lt;<span class="string">net:</span>:URLRequestContext&gt; url_request_context(BuildURLRequestContext(net_log));</div><div class="line">                                                                                                ^</div><div class="line">In file included from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base<span class="regexp">/files/</span>file_path.<span class="string">h:</span><span class="number">113</span>:<span class="number">0</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base<span class="regexp">/files/</span>file.<span class="string">h:</span><span class="number">13</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>net<span class="regexp">/base/</span>net_errors.<span class="string">h:</span><span class="number">11</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>net<span class="regexp">/proxy/</span>proxy_config_service_fixed.<span class="string">h:</span><span class="number">9</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">16</span>:</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base<span class="regexp">/containers/</span>hash_tables.<span class="string">h:</span> In instantiation of <span class="string">'std::size_t base_hash::hash&lt;T&gt;::operator()(const T&amp;) const [with T = std::basic_string&lt;char&gt;; std::size_t = unsigned int]'</span>:</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base<span class="regexp">/files/</span>file_path.<span class="string">h:</span><span class="number">473</span>:<span class="number">56</span>:   required from here</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base<span class="regexp">/containers/</span>hash_tables.<span class="string">h:</span><span class="number">28</span>:<span class="number">77</span>: <span class="string">error:</span> no match <span class="keyword">for</span> call to <span class="string">'(std::hash) (const std::basic_string&lt;char&gt;&amp;)'</span></div><div class="line"><span class="symbol">   std:</span>:size_t operator()(const T&amp; value) const &#123; <span class="keyword">return</span> <span class="string">std:</span>:hash&lt;T&gt;()(value); &#125;</div><div class="line">                                                                             ^</div><div class="line">In file included from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>net<span class="regexp">/base/</span>network_delegate_impl.<span class="string">h:</span><span class="number">10</span>:<span class="number">0</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">6</span>:</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base<span class="regexp">/strings/</span>string16.<span class="string">h:</span><span class="number">194</span>:<span class="number">8</span>: <span class="string">note:</span> candidate <span class="string">is:</span></div><div class="line"> struct hash&lt;<span class="string">base:</span>:string16&gt; &#123;</div><div class="line">        ^</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base<span class="regexp">/strings/</span>string16.<span class="string">h:</span><span class="number">195</span>:<span class="number">15</span>: <span class="string">note:</span> <span class="string">std:</span>:size_t <span class="string">std:</span>:<span class="string">hash:</span>:operator()(const string16&amp;) const</div><div class="line"><span class="symbol">   std:</span>:size_t operator()(const <span class="string">base:</span>:string16&amp; s) const &#123;</div><div class="line">               ^</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base<span class="regexp">/strings/</span>string16.<span class="string">h:</span><span class="number">195</span>:<span class="number">15</span>: <span class="string">note:</span>   no known conversion <span class="keyword">for</span> argument <span class="number">1</span> from <span class="string">'const std::basic_string&lt;char&gt;'</span> to <span class="string">'const string16&amp; &#123;aka const std::basic_string&lt;short unsigned int, base::string16_char_traits&gt;&amp;&#125;'</span></div><div class="line">In file included from <span class="regexp">/home/</span>hanpfei0306<span class="regexp">/data/</span>dev_tools<span class="regexp">/Android/</span>android-ndk-r12b<span class="regexp">/sources/</span>cxx-stl<span class="regexp">/gnu-libstdc++/</span><span class="number">4.9</span><span class="regexp">/include/</span><span class="string">atomic:</span><span class="number">41</span>:<span class="number">0</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base/atomicops_internals_portable.<span class="string">h:</span><span class="number">35</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base/atomicops.<span class="string">h:</span><span class="number">152</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base/atomic_ref_count.<span class="string">h:</span><span class="number">11</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base/callback_internal.<span class="string">h:</span><span class="number">11</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base/callback.<span class="string">h:</span><span class="number">9</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>net<span class="regexp">/base/</span>completion_callback.<span class="string">h:</span><span class="number">10</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>net<span class="regexp">/base/</span>network_delegate_impl.<span class="string">h:</span><span class="number">11</span>,</div><div class="line">                 from <span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">6</span>:</div><div class="line"><span class="regexp">/home/</span>hanpfei0306<span class="regexp">/data/</span>dev_tools<span class="regexp">/Android/</span>android-ndk-r12b<span class="regexp">/sources/</span>cxx-stl<span class="regexp">/gnu-libstdc++/</span><span class="number">4.9</span><span class="regexp">/include/</span>bits/atomic_base.<span class="string">h:</span> At global <span class="string">scope:</span></div><div class="line"><span class="regexp">/home/</span>hanpfei0306<span class="regexp">/data/</span>dev_tools<span class="regexp">/Android/</span>android-ndk-r12b<span class="regexp">/sources/</span>cxx-stl<span class="regexp">/gnu-libstdc++/</span><span class="number">4.9</span><span class="regexp">/include/</span>bits/atomic_base.<span class="string">h:</span><span class="number">588</span>:<span class="number">7</span>: <span class="string">warning:</span> inline function <span class="string">'bool std::__atomic_base&lt;_IntTp&gt;::compare_exchange_strong(std::__atomic_base&lt;_IntTp&gt;::__int_type&amp;, std::__atomic_base&lt;_IntTp&gt;::__int_type, std::memory_order, std::memory_order) volatile [with _ITp = int; std::__atomic_base&lt;_IntTp&gt;::__int_type = int; std::memory_order = std::memory_order]'</span> used but never defined</div><div class="line">       compare_exchange_strong(__int_type&amp; __i1, __int_type __i2,</div><div class="line">       ^</div><div class="line"><span class="regexp">/home/</span>hanpfei0306<span class="regexp">/data/</span>dev_tools<span class="regexp">/Android/</span>android-ndk-r12b<span class="regexp">/sources/</span>cxx-stl<span class="regexp">/gnu-libstdc++/</span><span class="number">4.9</span><span class="regexp">/include/</span>bits/atomic_base.<span class="string">h:</span><span class="number">525</span>:<span class="number">7</span>: <span class="string">warning:</span> inline function <span class="string">'std::__atomic_base&lt;_IntTp&gt;::__int_type std::__atomic_base&lt;_IntTp&gt;::exchange(std::__atomic_base&lt;_IntTp&gt;::__int_type, std::memory_order) volatile [with _ITp = int; std::__atomic_base&lt;_IntTp&gt;::__int_type = int; std::memory_order = std::memory_order]'</span> used but never defined</div><div class="line">       exchange(__int_type __i,</div><div class="line">       ^</div><div class="line"><span class="regexp">/home/</span>hanpfei0306<span class="regexp">/data/</span>dev_tools<span class="regexp">/Android/</span>android-ndk-r12b<span class="regexp">/sources/</span>cxx-stl<span class="regexp">/gnu-libstdc++/</span><span class="number">4.9</span><span class="regexp">/include/</span>bits/atomic_base.<span class="string">h:</span><span class="number">624</span>:<span class="number">7</span>: <span class="string">warning:</span> inline function <span class="string">'std::__atomic_base&lt;_IntTp&gt;::__int_type std::__atomic_base&lt;_IntTp&gt;::fetch_add(std::__atomic_base&lt;_IntTp&gt;::__int_type, std::memory_order) volatile [with _ITp = int; std::__atomic_base&lt;_IntTp&gt;::__int_type = int; std::memory_order = std::memory_order]'</span> used but never defined</div><div class="line">       fetch_add(__int_type __i,</div><div class="line">       ^</div><div class="line"><span class="regexp">/home/</span>hanpfei0306<span class="regexp">/data/</span>dev_tools<span class="regexp">/Android/</span>android-ndk-r12b<span class="regexp">/sources/</span>cxx-stl<span class="regexp">/gnu-libstdc++/</span><span class="number">4.9</span><span class="regexp">/include/</span>bits/atomic_base.<span class="string">h:</span><span class="number">485</span>:<span class="number">7</span>: <span class="string">warning:</span> inline function <span class="string">'void std::__atomic_base&lt;_IntTp&gt;::store(std::__atomic_base&lt;_IntTp&gt;::__int_type, std::memory_order) volatile [with _ITp = int; std::__atomic_base&lt;_IntTp&gt;::__int_type = int; std::memory_order = std::memory_order]'</span> used but never defined</div><div class="line">       store(__int_type __i,</div><div class="line">       ^</div><div class="line"><span class="regexp">/home/</span>hanpfei0306<span class="regexp">/data/</span>dev_tools<span class="regexp">/Android/</span>android-ndk-r12b<span class="regexp">/sources/</span>cxx-stl<span class="regexp">/gnu-libstdc++/</span><span class="number">4.9</span><span class="regexp">/include/</span>bits/atomic_base.<span class="string">h:</span><span class="number">507</span>:<span class="number">7</span>: <span class="string">warning:</span> inline function <span class="string">'std::__atomic_base&lt;_IntTp&gt;::__int_type std::__atomic_base&lt;_IntTp&gt;::load(std::memory_order) const volatile [with _ITp = int; std::__atomic_base&lt;_IntTp&gt;::__int_type = int; std::memory_order = std::memory_order]'</span> used but never defined</div><div class="line">       load(memory_order __m = memory_order_seq_cst) const <span class="keyword">volatile</span> noexcept</div><div class="line">       ^</div><div class="line"></div><div class="line">:<span class="string">app:</span>compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp FAILED</div><div class="line"><span class="symbol"></span></div><div class="line">FAILURE: Build failed with an exception.</div><div class="line"></div><div class="line">* What went <span class="string">wrong:</span></div><div class="line">Execution failed <span class="keyword">for</span> task <span class="string">':app:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp'</span>.</div><div class="line">&gt; A build operation failed.</div><div class="line">      C++ compiler failed <span class="keyword">while</span> compiling NetJni.cpp.</div><div class="line">  See the complete log <span class="string">at:</span> <span class="string">file:</span><span class="comment">///media/data/MyProjects/MyApplication/app/build/tmp/compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp/output.txt</span></div><div class="line"></div><div class="line">* <span class="string">Try:</span></div><div class="line">Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.</div><div class="line"></div><div class="line">BUILD FAILED</div><div class="line"></div><div class="line">Total <span class="string">time:</span> <span class="number">1.482</span> secs</div><div class="line">C++ compiler failed <span class="keyword">while</span> compiling NetJni.cpp.</div><div class="line"><span class="number">19</span>:<span class="number">19</span>:<span class="number">25</span>: External task execution finished <span class="string">'assembleDebug'</span>.</div></pre></td></tr></table></figure></p>
<p>这里提示std命名空间中没有<strong><code>unique_ptr</code></strong>，没有<strong><code>hash</code></strong>等，前者是C++11中新添加的智能指针模板，而后者则是哈希模板，它定义一个函数对象，实现散列函数。chromium net中，像这样用到了C++11的特性的地方还有很多，这里的这个错误是由于build.gradle中没有进行C++11的配置。我们在MyApplication/app/build.gradle中配置C++11：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">cppFlags</span><span class="selector-class">.addAll</span>(<span class="selector-attr">['-std=gnu++11']</span>)</div></pre></td></tr></table></figure></p>
<p>不过在前面，我们也有看到如下这样的错误消息：<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/sources/cxx-stl/gnu-libstdc++/<span class="number">4.9</span>/include/bits/c++<span class="number">0</span>x_warning.h:<span class="number">32</span>:<span class="number">2</span>: <span class="literal">error</span>: #<span class="literal">error</span> This <span class="keyword">file</span> requires compiler <span class="keyword">and</span> <span class="keyword">library</span> support <span class="keyword">for</span> the ISO C++ <span class="number">2011</span> standard. This support <span class="keyword">is</span> currently experimental, <span class="keyword">and</span> must be enabled <span class="keyword">with</span> the -std=c++<span class="number">11</span> <span class="keyword">or</span> -std=gnu++<span class="number">11</span> compiler options.</div><div class="line"> #<span class="literal">error</span> This <span class="keyword">file</span> requires compiler <span class="keyword">and</span> <span class="keyword">library</span> support <span class="keyword">for</span> the \</div><div class="line">  ^</div></pre></td></tr></table></figure></p>
<p>如果我们能早些注意到这样的错误消息，做了C++11的配置，大概这里的这个error还是可以避免的。</p>
<h1 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h1><p>做了C++11的配置之后，再次编译，继续报错：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="number">19</span>:<span class="number">29</span>:<span class="number">04</span>: Executing external task <span class="string">'assembleDebug'</span>...</div><div class="line">Observed <span class="keyword">package</span> id <span class="string">'build-tools;20.0.0'</span> <span class="keyword">in</span> inconsistent location <span class="string">'/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/android-4.4W'</span> (Expected <span class="string">'/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/20.0.0'</span>)</div><div class="line">Incremental java compilation is an incubating feature.</div><div class="line">:<span class="string">app:</span>compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base<span class="regexp">/message_loop/</span>message_loop.<span class="string">h:</span><span class="number">650</span>: <span class="string">error:</span> undefined reference to <span class="string">'base::MessageLoop::MessageLoop(base::MessageLoop::Type)'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">39</span>: <span class="string">error:</span> undefined reference to <span class="string">'base::MessageLoop::current()'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">39</span>: <span class="string">error:</span> undefined reference to <span class="string">'base::MessageLoop::QuitWhenIdle()'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">56</span>: <span class="string">error:</span> undefined reference to <span class="string">'net::HttpResponseHeaders::EnumerateHeaderLines(unsigned int*, std::string*, std::string*) const'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">140</span>: <span class="string">error:</span> undefined reference to <span class="string">'base::BasicStringPiece&lt;std::string&gt;::BasicStringPiece(char const*)'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">140</span>: <span class="string">error:</span> undefined reference to <span class="string">'GURL::GURL(base::BasicStringPiece&lt;std::string&gt;)'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">171</span>: <span class="string">error:</span> undefined reference to <span class="string">'base::MessageLoop::Run()'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">147</span>: <span class="string">error:</span> undefined reference to <span class="string">'GURL::~GURL()'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>build<span class="regexp">/intermediates/</span>objectFiles<span class="regexp">/armeabi-v7aDebugSharedLibrary/</span>neteasenetMainCpp<span class="regexp">/9a4xqrdajtunvcxs263gsxl2i/</span>NetJni.<span class="string">o:</span>NetJni.<span class="string">cpp:</span>vtable <span class="keyword">for</span> <span class="string">base:</span>:<span class="string">MessageLoopForIO:</span> <span class="string">error:</span> undefined reference to <span class="string">'base::MessageLoop::DoWork()'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>build<span class="regexp">/intermediates/</span>objectFiles<span class="regexp">/armeabi-v7aDebugSharedLibrary/</span>neteasenetMainCpp<span class="regexp">/9a4xqrdajtunvcxs263gsxl2i/</span>NetJni.<span class="string">o:</span>NetJni.<span class="string">cpp:</span>vtable <span class="keyword">for</span> <span class="string">base:</span>:<span class="string">MessageLoopForIO:</span> <span class="string">error:</span> undefined reference to <span class="string">'base::MessageLoop::DoDelayedWork(base::TimeTicks*)'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>build<span class="regexp">/intermediates/</span>objectFiles<span class="regexp">/armeabi-v7aDebugSharedLibrary/</span>neteasenetMainCpp<span class="regexp">/9a4xqrdajtunvcxs263gsxl2i/</span>NetJni.<span class="string">o:</span>NetJni.<span class="string">cpp:</span>vtable <span class="keyword">for</span> <span class="string">base:</span>:<span class="string">MessageLoopForIO:</span> <span class="string">error:</span> undefined reference to <span class="string">'base::MessageLoop::DoIdleWork()'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>build<span class="regexp">/intermediates/</span>objectFiles<span class="regexp">/armeabi-v7aDebugSharedLibrary/</span>neteasenetMainCpp<span class="regexp">/9a4xqrdajtunvcxs263gsxl2i/</span>NetJni.<span class="string">o:</span>NetJni.<span class="string">cpp:</span>vtable <span class="keyword">for</span> <span class="string">base:</span>:<span class="string">MessageLoopForIO:</span> <span class="string">error:</span> undefined reference to <span class="string">'base::MessageLoop::IsType(base::MessageLoop::Type) const'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/third_party/</span>chromium<span class="regexp">/include/</span>base<span class="regexp">/message_loop/</span>message_loop.<span class="string">h:</span><span class="number">645</span>: <span class="string">error:</span> undefined reference to <span class="string">'base::MessageLoop::~MessageLoop()'</span></div><div class="line"><span class="string">collect2:</span> <span class="string">error:</span> ld returned <span class="number">1</span> exit status</div><div class="line"></div><div class="line">:<span class="string">app:</span>linkNeteasenetArmeabi-v7aDebugSharedLibrary FAILED</div><div class="line"><span class="symbol"></span></div><div class="line">FAILURE: Build failed with an exception.</div><div class="line"></div><div class="line">* What went <span class="string">wrong:</span></div><div class="line">Execution failed <span class="keyword">for</span> task <span class="string">':app:linkNeteasenetArmeabi-v7aDebugSharedLibrary'</span>.</div><div class="line">&gt; A build operation failed.</div><div class="line">      Linker failed <span class="keyword">while</span> linking libneteasenet.so.</div><div class="line">  See the complete log <span class="string">at:</span> <span class="string">file:</span><span class="comment">///media/data/MyProjects/MyApplication/app/build/tmp/linkNeteasenetArmeabi-v7aDebugSharedLibrary/output.txt</span></div><div class="line"></div><div class="line">* <span class="string">Try:</span></div><div class="line">Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.</div><div class="line"></div><div class="line">BUILD FAILED</div><div class="line"></div><div class="line">Total <span class="string">time:</span> <span class="number">4.835</span> secs</div><div class="line">Linker failed <span class="keyword">while</span> linking libneteasenet.so.</div><div class="line"><span class="number">19</span>:<span class="number">29</span>:<span class="number">09</span>: External task execution finished <span class="string">'assembleDebug'</span>.</div></pre></td></tr></table></figure></p>
<p>这次是链接错误，提示找不到base库和url库中的符号<strong><code>base::MessageLoop::MessageLoop(base::MessageLoop::Type)</code></strong>、<strong><code>GURL::~GURL()</code></strong>和<strong><code>base::MessageLoop::DoIdleWork()</code></strong>等。看来经过前面的各种艰难险阻，我们总算是将native层的cpp文件编译为了.o文件。</p>
<p>为了解决这个问题，我们还需要在<strong><code>MyApplication/app/build.gradle</code></strong>中添加对base和url这两个库的依赖：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">chromium_base &#123;</div><div class="line">    headers.srcDir <span class="string">"src/main/jni/third_party/chromium/include"</span></div><div class="line">    binaries.withType(SharedLibraryBinary) &#123;</div><div class="line">        sharedLibraryFile = file(<span class="string">"src/main/jni/third_party/chromium/libs/<span class="subst">$&#123;targetPlatform.getName()&#125;</span>/libbase.cr.so"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">chromium_url &#123;</div><div class="line">    headers.srcDir <span class="string">"src/main/jni/third_party/chromium/include"</span></div><div class="line">    binaries.withType(SharedLibraryBinary) &#123;</div><div class="line">        sharedLibraryFile = file(<span class="string">"src/main/jni/third_party/chromium/libs/<span class="subst">$&#123;targetPlatform.getName()&#125;</span>/liburl.cr.so"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">            dependencies &#123;</div><div class="line">                <span class="keyword">library</span> <span class="string">'chromium_base'</span> linkage <span class="string">'shared'</span></div><div class="line">                <span class="keyword">library</span> <span class="string">'chromium_url'</span> linkage <span class="string">'shared'</span></div><div class="line">                <span class="keyword">library</span> <span class="string">'chromium_net'</span> linkage <span class="string">'shared'</span></div><div class="line">            &#125;</div></pre></td></tr></table></figure></p>
<h2 id="选择正确的STL库"><a href="#选择正确的STL库" class="headerlink" title="选择正确的STL库"></a>选择正确的STL库</h2><p>经过了前面的修改，再次编译，然而……继续报错：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="number">19</span>:<span class="number">35</span>:<span class="number">16</span>: Executing external task <span class="string">'assembleDebug'</span>...</div><div class="line">Observed <span class="keyword">package</span> id <span class="string">'build-tools;20.0.0'</span> <span class="keyword">in</span> inconsistent location <span class="string">'/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/android-4.4W'</span> (Expected <span class="string">'/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/20.0.0'</span>)</div><div class="line">Incremental java compilation is an incubating feature.</div><div class="line">:<span class="string">app:</span>compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp UP-TO-DATE</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">56</span>: <span class="string">error:</span> undefined reference to <span class="string">'net::HttpResponseHeaders::EnumerateHeaderLines(unsigned int*, std::string*, std::string*) const'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">140</span>: <span class="string">error:</span> undefined reference to <span class="string">'base::BasicStringPiece&lt;std::string&gt;::BasicStringPiece(char const*)'</span></div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/MyProjects/</span>MyApplication<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni<span class="regexp">/src/</span>NetJni.<span class="string">cpp:</span><span class="number">140</span>: <span class="string">error:</span> undefined reference to <span class="string">'GURL::GURL(base::BasicStringPiece&lt;std::string&gt;)'</span></div><div class="line"><span class="string">collect2:</span> <span class="string">error:</span> ld returned <span class="number">1</span> exit status</div><div class="line"></div><div class="line">:<span class="string">app:</span>linkNeteasenetArmeabi-v7aDebugSharedLibrary FAILED</div><div class="line"><span class="symbol"></span></div><div class="line">FAILURE: Build failed with an exception.</div><div class="line"></div><div class="line">* What went <span class="string">wrong:</span></div><div class="line">Execution failed <span class="keyword">for</span> task <span class="string">':app:linkNeteasenetArmeabi-v7aDebugSharedLibrary'</span>.</div><div class="line">&gt; A build operation failed.</div><div class="line">      Linker failed <span class="keyword">while</span> linking libneteasenet.so.</div><div class="line">  See the complete log <span class="string">at:</span> <span class="string">file:</span><span class="comment">///media/data/MyProjects/MyApplication/app/build/tmp/linkNeteasenetArmeabi-v7aDebugSharedLibrary/output.txt</span></div><div class="line"></div><div class="line">* <span class="string">Try:</span></div><div class="line">Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.</div><div class="line"></div><div class="line">BUILD FAILED</div><div class="line"></div><div class="line">Total <span class="string">time:</span> <span class="number">1.171</span> secs</div><div class="line">Linker failed <span class="keyword">while</span> linking libneteasenet.so.</div><div class="line"><span class="number">19</span>:<span class="number">35</span>:<span class="number">17</span>: External task execution finished <span class="string">'assembleDebug'</span>.</div></pre></td></tr></table></figure></p>
<p>这次是提示找不到符号<strong>‘net::HttpResponseHeaders::EnumerateHeaderLines(unsigned int<em>, std::string</em>, std::string*) const’</strong>， <strong>‘base::BasicStringPiece<std::string>::BasicStringPiece(char const*)’</std::string></strong>，<strong>‘GURL::GURL(base::BasicStringPiece<std::string>)’</std::string></strong>。这个问题还真够诡异。我们对相关的这些模块，base，net和url的gn配置文件，gypi配置文件进行反复的检查，可以百分百地确认，相关的这些文件都是有被编译进so的。</p>
<p>可是為什麼能引用不到这些符号呢？那so中到底有没有相关的这些class呢？通过GNU的binutils工具包中的readelf工具可以查看so中的所有符号，无论是函数符号，还是引用的未定义符号。而且编译器在编译C++文件时，符号都是会被修饰的，以便于支持函数重载等C++的一些特性。binutils工具包还提供了工具c++filt，以帮助我们将修饰后的符号，还原回编译前的样子。</p>
<p>我们利用这些工具，来检查那些so中是否真的没有包含未找到的那些符号：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>readelf -s -W libbase.cr.so | grep BasicStringPiece | xargs c++filt | grep BasicStringPiece</div><div class="line"></div><div class="line"><span class="symbol">base:</span><span class="symbol">:BasicStringPiece&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; &gt;<span class="symbol">:</span><span class="symbol">:BasicStringPiece</span>(char const*)</div><div class="line"><span class="symbol">base:</span><span class="symbol">:BasicStringPiece&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; &gt;<span class="symbol">:</span><span class="symbol">:BasicStringPiece</span>(char const*, unsigned int)</div><div class="line"><span class="symbol">base:</span><span class="symbol">:BasicStringPiece&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; &gt;<span class="symbol">:</span><span class="symbol">:BasicStringPiece</span>(<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:__wrap_iter&lt;char</span> const*&gt; const&amp;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:__wrap_iter&lt;char</span> const*&gt; const&amp;)</div><div class="line"><span class="symbol">base:</span><span class="symbol">:BasicStringPiece&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; &gt;<span class="symbol">:</span><span class="symbol">:BasicStringPiece</span>(<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; const&amp;)</div><div class="line"><span class="symbol">base:</span><span class="symbol">:BasicStringPiece&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; &gt;<span class="symbol">:</span><span class="symbol">:BasicStringPiece</span>()</div><div class="line"><span class="symbol">base:</span><span class="symbol">:BasicStringPiece&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; &gt;<span class="symbol">:</span><span class="symbol">:BasicStringPiece</span>(char const*)</div><div class="line"><span class="symbol">base:</span><span class="symbol">:BasicStringPiece&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; &gt;<span class="symbol">:</span><span class="symbol">:BasicStringPiece</span>(char const*, unsigned int)</div><div class="line"><span class="symbol">base:</span><span class="symbol">:BasicStringPiece&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; &gt;<span class="symbol">:</span><span class="symbol">:BasicStringPiece</span>(<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:__wrap_iter&lt;char</span> const*&gt; const&amp;, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:__wrap_iter&lt;char</span> const*&gt; const&amp;)</div><div class="line"><span class="symbol">base:</span><span class="symbol">:BasicStringPiece&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; &gt;<span class="symbol">:</span><span class="symbol">:BasicStringPiece</span>(<span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; const&amp;)</div><div class="line"><span class="symbol">base:</span><span class="symbol">:BasicStringPiece&lt;std</span><span class="symbol">:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:basic_string&lt;char</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:char_traits&lt;char&gt;</span>, <span class="symbol">std:</span><span class="symbol">:__1</span><span class="symbol">:</span><span class="symbol">:allocator&lt;char&gt;</span> &gt; &gt;<span class="symbol">:</span><span class="symbol">:BasicStringPiece</span>()</div></pre></td></tr></table></figure></p>
<p>so还真的没有我们的代码中要引用的那些符号。那到底是怎么一回事呢？对比编译我们的工程时报的错，实际情况似乎是，在so中包含了我们需要的函数，但两边修饰后的符号不一致，从而导致链接出错。主要是std中的符号，在so中引用的std的符号，其命名空间都增加了一级”__1”。</p>
<p>这似乎与stl有关。NDK可用的<a href="https://developer.android.com/ndk/guides/cpp-support.html" target="_blank" rel="external">stl库</a>大体有如下的这些：<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">libstdc</span><span class="literal">+</span><span class="literal">+</span></div><div class="line"><span class="comment">gabi</span><span class="literal">+</span><span class="literal">+</span><span class="comment">_static</span></div><div class="line"><span class="comment">gabi</span><span class="literal">+</span><span class="literal">+</span><span class="comment">_shared</span></div><div class="line"><span class="comment">stlport_static</span></div><div class="line"><span class="comment">stlport_shared</span></div><div class="line"><span class="comment">gnustl_static</span></div><div class="line"><span class="comment">gnustl_shared</span></div><div class="line"><span class="comment">c</span><span class="literal">+</span><span class="literal">+</span><span class="comment">_static</span></div><div class="line"><span class="comment">c</span><span class="literal">+</span><span class="literal">+</span><span class="comment">_shared</span></div></pre></td></tr></table></figure></p>
<p>逐个地对这些标准库进行尝试。除了我们前面配置的<code>gnustl_static</code>，上面列出的前面的5种，甚至都找不到头文件<code>&lt;atomic&gt;</code>，<code>gnustl_shared</code>报出了与<code>gnustl_static</code>相同的问题。这就只剩下<code>c++_static</code>和<code>c++_shared</code>可选了。</p>
<p>我们首先尝试c++_static，但依然报了错：<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="number">20</span>:<span class="number">00</span>:<span class="number">36</span>: Executing external task <span class="symbol">'assembleDebug</span>'...</div><div class="line">Observed package id <span class="symbol">'build</span>-tools;<span class="number">20.0</span>.<span class="number">0</span>' <span class="keyword">in</span> inconsistent location '/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/android-<span class="number">4.4</span>W' (Expected '/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/<span class="number">20.0</span>.<span class="number">0</span>')</div><div class="line">Incremental java compilation is an incubating feature.</div><div class="line">:app:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp</div><div class="line">/media/data/MyProjects/MyApplication/app/src/main/jni/src/NetJni.cpp:<span class="number">56</span>: error: undefined reference to <span class="symbol">'net</span>::HttpResponseHeaders::EnumerateHeaderLines(unsigned <span class="keyword">int</span>*, std::__ndk1::basic_string&lt;<span class="keyword">char</span>, std::__ndk1::char_traits&lt;<span class="keyword">char</span>&gt;, std::__ndk1::allocator&lt;<span class="keyword">char</span>&gt; &gt;*, std::__ndk1::basic_string&lt;<span class="keyword">char</span>, std::__ndk1::char_traits&lt;<span class="keyword">char</span>&gt;, std::__ndk1::allocator&lt;<span class="keyword">char</span>&gt; &gt;*) <span class="keyword">const</span>'</div><div class="line">/media/data/MyProjects/MyApplication/app/src/main/jni/src/NetJni.cpp:<span class="number">140</span>: error: undefined reference to <span class="symbol">'base</span>::BasicStringPiece&lt;std::__ndk1::basic_string&lt;<span class="keyword">char</span>, std::__ndk1::char_traits&lt;<span class="keyword">char</span>&gt;, std::__ndk1::allocator&lt;<span class="keyword">char</span>&gt; &gt; &gt;::BasicStringPiece(<span class="keyword">char</span> <span class="keyword">const</span>*)'</div><div class="line">/media/data/MyProjects/MyApplication/app/src/main/jni/src/NetJni.cpp:<span class="number">140</span>: error: undefined reference to <span class="symbol">'GURL</span>::GURL(base::BasicStringPiece&lt;std::__ndk1::basic_string&lt;<span class="keyword">char</span>, std::__ndk1::char_traits&lt;<span class="keyword">char</span>&gt;, std::__ndk1::allocator&lt;<span class="keyword">char</span>&gt; &gt; &gt;)'</div><div class="line">collect2: error: ld returned <span class="number">1</span> exit status</div><div class="line"></div><div class="line">:app:linkNeteasenetArmeabi-v7aDebugSharedLibrary FAILED</div><div class="line"></div><div class="line">FAILURE: Build failed with an exception.</div><div class="line"></div><div class="line">* What went wrong:</div><div class="line">Execution failed <span class="keyword">for</span> task ':app:linkNeteasenetArmeabi-v7aDebugSharedLibrary'.</div><div class="line">&gt; A build operation failed.</div><div class="line">      Linker failed <span class="keyword">while</span> linking libneteasenet.so.</div><div class="line">  See the complete log at: file:<span class="comment">///media/data/MyProjects/MyApplication/app/build/tmp/linkNeteasenetArmeabi-v7aDebugSharedLibrary/output.txt</span></div><div class="line"></div><div class="line">* Try:</div><div class="line">Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.</div><div class="line"></div><div class="line">BUILD FAILED</div><div class="line"></div><div class="line">Total time: <span class="number">4.385</span> secs</div><div class="line">Linker failed <span class="keyword">while</span> linking libneteasenet.so.</div><div class="line"><span class="number">20</span>:<span class="number">00</span>:<span class="number">41</span>: External task execution finished <span class="symbol">'assembleDebug</span>'.</div></pre></td></tr></table></figure></p>
<p>情况发生了变化。尽管依然报了<code>undefined reference to</code>的error，但这次引用不到的符号却已经与我们在so中抓出来的那些符号非常接近了。<code>c++_static</code>和<code>c++_shared</code>是LLVM libc++ runtime，编译我们的JNI时使用的这个STL的实现似乎与编译chromium代码时使用的那个不太一样，但无疑编译chromium时使用的是LLVM libc++ runtime。</p>
<p>我们随便打开一个std的头文件来一窥究竟，比如声明std::string的头文件android-ndk-r12b/sources/cxx-stl/llvm-libc++/libcxx/include/iosfwd，我们注意到了如下的这几行：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">_LIBCPP_BEGIN_NAMESPACE_STD</div><div class="line"></div><div class="line"><span class="params">...</span><span class="params">...</span></div><div class="line">_LIBCPP_END_NAMESPACE_STD</div></pre></td></tr></table></figure></p>
<p>这个宏的定义在android-ndk-r12b/sources/cxx-stl/llvm-libc++/libcxx/include/__config：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _LIBCPP_ABI_VERSION 1</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _LIBCPP_CONCAT1(_LIBCPP_X,_LIBCPP_Y) _LIBCPP_X##_LIBCPP_Y</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _LIBCPP_CONCAT(_LIBCPP_X,_LIBCPP_Y) _LIBCPP_CONCAT1(_LIBCPP_X,_LIBCPP_Y)</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _LIBCPP_NAMESPACE _LIBCPP_CONCAT(__ndk,_LIBCPP_ABI_VERSION)</span></div><div class="line"></div><div class="line">......</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _LIBCPP_BEGIN_NAMESPACE_STD namespace std &#123; namespace _LIBCPP_NAMESPACE &#123;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _LIBCPP_END_NAMESPACE_STD  &#125; &#125;</span></div></pre></td></tr></table></figure></p>
<p>由此我们终于揭开了引用的符号，中间插入的那一级命名空间<code>__ndk1</code>的秘密。这是LLVM libc++ runtime加的。</p>
<p>但编译出来的so中的符号又是怎么回事呢？chromium的代码库中，有完整的构建工具链，包括android的NDK和SDK，它们位于<code>chromium/src/third_party/android_tools</code>。我们打开文件chromium/src/third_party/android_tools/ndk/sources/cxx-stl/llvm-libc++/libcxx/include/__config，可以看到如下这样的宏定义：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-id">#define</span> <span class="selector-tag">_LIBCPP_ABI_VERSION</span> <span class="selector-tag">1</span></div><div class="line"></div><div class="line"><span class="selector-id">#define</span> <span class="selector-tag">_LIBCPP_CONCAT1</span>(_LIBCPP_X,_LIBCPP_Y) <span class="selector-tag">_LIBCPP_X</span>#<span class="selector-id">#_LIBCPP_Y</span></div><div class="line"><span class="selector-id">#define</span> <span class="selector-tag">_LIBCPP_CONCAT</span>(_LIBCPP_X,_LIBCPP_Y) <span class="selector-tag">_LIBCPP_CONCAT1</span>(_LIBCPP_X,_LIBCPP_Y)</div><div class="line"></div><div class="line"><span class="selector-id">#define</span> <span class="selector-tag">_LIBCPP_NAMESPACE</span> <span class="selector-tag">_LIBCPP_CONCAT</span>(__,_LIBCPP_ABI_VERSION)</div></pre></td></tr></table></figure></p>
<p>至此，这个链接过程中符号找不到的问题终于被厘清——chromium中的NDK不是标准NDK。</p>
<p>这样的话解法也就显而易见了，编译我们的工程时，stl用c++_static，同时定制编译chromium所用的NDK。</p>
<h1 id="采用标准NDK编译chromium-net"><a href="#采用标准NDK编译chromium-net" class="headerlink" title="采用标准NDK编译chromium net"></a>采用标准NDK编译chromium net</h1><p>为了解决编译chromium时所用的NDK与编译我们的工程时所用的NDK不一致，导致的链接错误，我们需要定制编译chromium时所用的NDK。这需要重新对chromium的构建进行配置，并再次编译chromium net。首先需要修改out/Default/args.gn，修改后的样子如下：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="attr">target_os</span> = <span class="string">"android"</span></div><div class="line"><span class="attr">target_cpu</span> = <span class="string">"arm"</span>  # (default)</div><div class="line"><span class="attr">is_debug</span> = <span class="literal">true</span>  # (default)</div><div class="line"></div><div class="line"><span class="comment"># Other args you may want to set:</span></div><div class="line"><span class="attr">is_component_build</span> = <span class="literal">true</span></div><div class="line"><span class="attr">is_clang</span> = <span class="literal">true</span></div><div class="line"><span class="attr">symbol_level</span> = <span class="number">1</span>  # Faster build with fewer symbols. -g1 rather than -g2</div><div class="line"><span class="attr">enable_incremental_javac</span> = <span class="literal">true</span>  # Much faster; experimental</div><div class="line"><span class="attr">android_ndk_root</span> = <span class="string">"~/data/dev_tools/Android/android-ndk-r12b"</span></div></pre></td></tr></table></figure></p>
<p>然后，通过如下的命令，再次编译chromium net。但出错了：<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ gn gen <span class="keyword">out</span>/<span class="keyword">Default</span>/</div><div class="line">Generating files...</div><div class="line">Done. Wrote <span class="number">11150</span> targets from <span class="number">881</span> files <span class="keyword">in</span> <span class="number">2166</span>ms</div><div class="line">$ ninja -C <span class="keyword">out</span>/<span class="keyword">Default</span>/ net</div><div class="line">ninja: Entering directory `<span class="keyword">out</span>/<span class="keyword">Default</span>/'</div><div class="line">ninja: <span class="literal">error</span>: '../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/toolchains/arm-linux-androideabi-<span class="number">4.9</span>/prebuilt/linux-x86_64/lib/gcc/arm-linux-androideabi/<span class="number">4.9</span>/libgcc.a', needed by <span class="symbol">'obj</span>/base/third_party/dynamic_annotations/libdynamic_annotations.a', missing <span class="keyword">and</span> no known rule <span class="keyword">to</span> make it</div></pre></td></tr></table></figure></p>
<p>这次是找不到ndk的一个文件<strong><code>android-ndk-r12b/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/lib/gcc/arm-linux-androideabi/4.9/libgcc.a</code></strong>。我们发现<strong><code>android-ndk-r12b/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/lib/gcc/arm-linux-androideabi/4.9</code></strong>目录不存在，但是<strong><code>android-ndk-r12b/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/lib/gcc/arm-linux-androideabi/4.9.x</code></strong>是存在的，我们直接将4.9.x复制到4.9。</p>
<p>再次编译，在链接生成libbase.cr.so时，出错了：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ ninja -C <span class="keyword">out</span>/Default/ <span class="keyword">net</span></div><div class="line">ninja: Entering directory `<span class="keyword">out</span>/Default/'</div><div class="line">[1349/2009] SOLINK ./libbase.cr.<span class="keyword">so</span></div><div class="line">FAILED: libbase.cr.<span class="keyword">so</span> libbase.cr.<span class="keyword">so</span>.TOC lib.unstripped/libbase.cr.<span class="keyword">so</span> </div><div class="line">python <span class="string">"/media/data/chromium_android/src/build/toolchain/gcc_solink_wrapper.py"</span> --readelf=<span class="string">"../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin/arm-linux-androideabi-readelf"</span> --nm=<span class="string">"../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin/arm-linux-androideabi-nm"</span> --strip=../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin/arm-linux-androideabi-strip --sofile=<span class="string">"./lib.unstripped/libbase.cr.so"</span> --tocfile=<span class="string">"./libbase.cr.so.TOC"</span> --output=<span class="string">"./libbase.cr.so"</span> -- ../../third_party/llvm-build/Release+Asserts/bin/clang++ -shared -Wl,--fatal-warnings -fPIC -Wl,-z,noexecstack -Wl,-z,now -Wl,-z,relro -Wl,-z,defs -fuse-ld=gold --gcc-toolchain=../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64 -Wl,--icf=all -Wl,--build-id=sha1 -Wl,--<span class="keyword">no</span>-undefined -Wl,--exclude-libs=libgcc.a -Wl,--exclude-libs=libc++_static.a -Wl,--exclude-libs=libvpx_assembly_arm.a --target=arm-linux-androideabi -Wl,--warn-shared-textrel -Wl,-O1 -Wl,--<span class="keyword">as</span>-needed -nostdlib -Wl,--warn-shared-textrel --sysroot=../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/platforms/android-16/<span class="keyword">arch</span>-arm  -Wl,-wrap,calloc -Wl,-wrap,free -Wl,-wrap,malloc -Wl,-wrap,memalign -Wl,-wrap,posix_memalign -Wl,-wrap,pvalloc -Wl,-wrap,realloc -Wl,-wrap,valloc -<span class="keyword">L</span>/home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a -o <span class="string">"./lib.unstripped/libbase.cr.so"</span> -Wl,-soname=<span class="string">"libbase.cr.so"</span> @<span class="string">"./libbase.cr.so.rsp"</span></div><div class="line">../../base/debug/stack_trace_android.<span class="keyword">cc</span>:39: <span class="keyword">error</span>: undefined reference to '_Unwind_GetIP'</div><div class="line">clang: <span class="keyword">error</span>: linker command failed with <span class="keyword">exit</span> code 1 (<span class="keyword">use</span> -v to see invocation)</div><div class="line">[1358/2009] CXX obj/third_party/protobuf/protobuf_lite/extension_set.o</div><div class="line">ninja: build stopped: subcommand failed.</div></pre></td></tr></table></figure></p>
<p>这次提示找不到符号_Unwind_GetIP，这个符号是libunwind中的。我们还需要修改<code>base/BUILD.gn</code>，在为android编译时，添加对libunwind的依赖：<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (is_android) &#123;</div><div class="line">  config(<span class="string">"android_system_libs"</span>) &#123;</div><div class="line">    <span class="attr">libs</span> = [ <span class="string">"log"</span>, <span class="string">"unwind"</span> ]  <span class="comment"># Used by logging.cc.</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再次编译时依然出错了：<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$ gn args out/<span class="keyword">Default</span>/</div><div class="line">Waiting <span class="keyword">for</span> editor <span class="keyword">on</span> <span class="string">"/media/data/chromium_android/src/out/Default/args.gn"</span>...</div><div class="line">Generating files...</div><div class="line">Done. Wrote <span class="number">11150</span> targets <span class="keyword">from</span> <span class="number">881</span> files <span class="keyword">in</span> <span class="number">2196</span>ms</div><div class="line">$ ninja -C out/<span class="keyword">Default</span>/ net</div><div class="line">ninja: Entering directory `out/<span class="keyword">Default</span>/<span class="comment">'</span></div><div class="line">[<span class="number">27</span>/<span class="number">640</span>] SOLINK ./libicuuc.cr.so</div><div class="line">FAILED: libicuuc.cr.so libicuuc.cr.so.TOC <span class="keyword">lib</span>.unstripped/libicuuc.cr.so </div><div class="line">python <span class="string">"/media/data/chromium_android/src/build/toolchain/gcc_solink_wrapper.py"</span> --readelf=<span class="string">"../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin/arm-linux-androideabi-readelf"</span> --nm=<span class="string">"../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin/arm-linux-androideabi-nm"</span> --strip=../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/toolchains/arm-linux-androideabi<span class="number">-4.9</span>/prebuilt/linux-x86_64/bin/arm-linux-androideabi-strip --sofile=<span class="string">"./lib.unstripped/libicuuc.cr.so"</span> --tocfile=<span class="string">"./libicuuc.cr.so.TOC"</span> --output=<span class="string">"./libicuuc.cr.so"</span> -- ../../third_party/llvm-build/Release+Asserts/bin/clang++ -<span class="keyword">shared</span> -Wl,--fatal-warnings -fPIC -Wl,-z,noexecstack -Wl,-z,now -Wl,-z,relro -Wl,-z,defs -fuse-ld=gold --gcc-toolchain=../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/toolchains/arm-linux-androideabi<span class="number">-4.9</span>/prebuilt/linux-x86_64 -Wl,--icf=all -Wl,--build-id=sha1 -Wl,--no-undefined -Wl,--exclude-libs=libgcc.a -Wl,--exclude-libs=libc++_static.a -Wl,--exclude-libs=libvpx_assembly_arm.a --target=arm-linux-androideabi -Wl,--warn-<span class="keyword">shared</span>-textrel -Wl,-O1 -Wl,--<span class="keyword">as</span>-needed -nostdlib -Wl,--warn-<span class="keyword">shared</span>-textrel --sysroot=../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/platforms/android<span class="number">-16</span>/arch-arm  -L/home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a -o <span class="string">"./lib.unstripped/libicuuc.cr.so"</span> -Wl,-soname=<span class="string">"libicuuc.cr.so"</span> @<span class="string">"./libicuuc.cr.so.rsp"</span></div><div class="line">../../third_party/icu/source/common/rbbi.cpp:<span class="number">324</span>: <span class="keyword">error</span>: undefined reference <span class="keyword">to</span> <span class="comment">'__cxa_bad_typeid'</span></div><div class="line">../../third_party/icu/source/common/schriter.cpp:<span class="number">90</span>: <span class="keyword">error</span>: undefined reference <span class="keyword">to</span> <span class="comment">'__cxa_bad_typeid'</span></div><div class="line">../../third_party/icu/source/common/stringtriebuilder.cpp:<span class="number">386</span>: <span class="keyword">error</span>: undefined reference <span class="keyword">to</span> <span class="comment">'__cxa_bad_typeid'</span></div><div class="line">../../third_party/icu/source/common/uchriter.cpp:<span class="number">72</span>: <span class="keyword">error</span>: undefined reference <span class="keyword">to</span> <span class="comment">'__cxa_bad_typeid'</span></div><div class="line">clang: <span class="keyword">error</span>: linker command failed <span class="keyword">with</span> <span class="keyword">exit</span> code <span class="number">1</span> (use -v <span class="keyword">to</span> see invocation)</div><div class="line">[<span class="number">36</span>/<span class="number">640</span>] CXX obj/url/url/url_util.o</div><div class="line">ninja: build stopped: subcommand failed.</div></pre></td></tr></table></figure></p>
<p>这是在编译icu时，找不到符号__cxa_bad_typeid。这需要重新配置编译环境，更改所用的工具链，不能是clang，修改之后的out/Default/args.gn如下：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="attr">target_os</span> = <span class="string">"android"</span></div><div class="line"><span class="attr">target_cpu</span> = <span class="string">"arm"</span>  # (default)</div><div class="line"><span class="attr">is_debug</span> = <span class="literal">true</span>  # (default)</div><div class="line"></div><div class="line"><span class="comment"># Other args you may want to set:</span></div><div class="line"><span class="attr">is_component_build</span> = <span class="literal">true</span></div><div class="line"><span class="attr">is_clang</span> = <span class="literal">false</span></div><div class="line"><span class="attr">symbol_level</span> = <span class="number">1</span>  # Faster build with fewer symbols. -g1 rather than -g2</div><div class="line"><span class="attr">enable_incremental_javac</span> = <span class="literal">true</span>  # Much faster; experimental</div><div class="line"><span class="attr">android_ndk_root</span> = <span class="string">"/home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b"</span></div></pre></td></tr></table></figure></p>
<p>重新配置chromium的构建环境，并再次编译net。</p>
<p>这终于编译好了。将编译出来的so文件拷贝进我们的工程。再次编译我们的工程。但依然在报错：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">21:02:17: Executing external task <span class="emphasis">'assembleDebug'</span>...</div><div class="line">Observed package id <span class="emphasis">'build-tools;20.0.0'</span> in inconsistent location <span class="emphasis">'/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/android-4.4W'</span> (Expected <span class="emphasis">'/home/hanpfei0306/data/dev_tools/Android/sdk/build-tools/20.0.0'</span>)</div><div class="line">Incremental java compilation is an incubating feature.</div><div class="line"><span class="meta">:app:compileNeteasenetArmeabi-v7aDebugSharedLibraryNeteasenetMainCpp</span></div><div class="line"><span class="meta">:app:linkNeteasenetArmeabi-v7aDebugSharedLibrary</span></div><div class="line"><span class="meta">:app:neteasenetArmeabi-v7aDebugSharedLibrary</span></div><div class="line"><span class="meta">:app:stripSymbolsArmeabi-v7aDebugSharedLibrary</span></div><div class="line"><span class="meta">:app:ndkBuildArmeabi-v7aDebugSharedLibrary</span></div><div class="line"><span class="meta">:app:ndkBuildArmeabi-v7aDebugStaticLibrary</span> UP-TO-DATE</div><div class="line"><span class="meta">:app:compileNeteasenetArmeabiDebugSharedLibraryNeteasenetMainCpp</span></div><div class="line">/usr/local/google/buildbot/src/android/ndk-r12-release/ndk/sources/cxx-stl/llvm-libc++/libcxx/include/atomic:922: error: undefined reference to <span class="emphasis">'__atomic_fetch_add_4'</span></div><div class="line">/usr/local/google/buildbot/src/android/ndk-r12-release/ndk/sources/cxx-stl/llvm-libc++abi/libcxxabi/src/cxa<span class="emphasis">_handlers.cpp:112: error: undefined reference to '_</span><span class="emphasis">_atomic_</span>exchange<span class="emphasis">_4'</span></div><div class="line">/usr/local/google/buildbot/src/android/ndk-r12-release/ndk/sources/cxx-stl/llvm-libc++abi/libcxxabi/src/cxa_default<span class="emphasis">_handlers.cpp:106: error: undefined reference to '_</span><span class="emphasis">_atomic_</span>exchange<span class="emphasis">_4'</span></div><div class="line">/usr/local/google/buildbot/src/android/ndk-r12-release/ndk/sources/cxx-stl/llvm-libc++abi/libcxxabi/src/cxa_default<span class="emphasis">_handlers.cpp:117: error: undefined reference to '_</span><span class="emphasis">_atomic_</span>exchange<span class="emphasis">_4'</span></div><div class="line">collect2: error: ld returned 1 exit status</div><div class="line"></div><div class="line"><span class="meta">:app:linkNeteasenetArmeabiDebugSharedLibrary</span> FAILED</div><div class="line"></div><div class="line">FAILURE: Build failed with an exception.</div><div class="line"></div><div class="line"><span class="bullet">* </span>What went wrong:</div><div class="line">Execution failed for task <span class="emphasis">':app:linkNeteasenetArmeabiDebugSharedLibrary'</span>.</div><div class="line">&gt; A build operation failed.</div><div class="line"><span class="code">      Linker failed while linking libneteasenet.so.</span></div><div class="line"><span class="code">  See the complete log at: file:///media/data/MyProjects/MyApplication/app/build/tmp/linkNeteasenetArmeabiDebugSharedLibrary/output.txt</span></div><div class="line"></div><div class="line"><span class="bullet">* </span>Try:</div><div class="line">Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.</div><div class="line"></div><div class="line">BUILD FAILED</div><div class="line"></div><div class="line">Total time: 6.648 secs</div><div class="line">Linker failed while linking libneteasenet.so.</div><div class="line">21:02:24: External task execution finished <span class="emphasis">'assembleDebug'</span>.</div></pre></td></tr></table></figure></p>
<p>不过这次已经不是找不到chromium的库中的符号了，而是标准库中的一些符号。这需要我们修改依赖的stl为<code>c++_shared</code>，而不是<code>c++_static</code>。再次编译，终于build pass。</p>
<h1 id="编译链接的标记设置"><a href="#编译链接的标记设置" class="headerlink" title="编译链接的标记设置"></a>编译链接的标记设置</h1><p>chromium中，有许多feature的开关是通过预定义宏来控制的，它的整个的编译链接都有它独特的参数。如果在编译我们的工程时，预定义的宏与编译chromium时预定义的宏不一致，就很容易出现两边的class实际的定义不一样的问题。比如net::URLRequestContextBuilder类的定义：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">private</span>:</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> accept_language_;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> user_agent_;</div><div class="line">  <span class="comment">// Include support for data:// requests.</span></div><div class="line">  <span class="keyword">bool</span> data_enabled_;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(DISABLE_FILE_SUPPORT)</span></div><div class="line">  <span class="comment">// Include support for file:// requests.</span></div><div class="line">  <span class="keyword">bool</span> file_enabled_;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(DISABLE_FTP_SUPPORT)</span></div><div class="line">  <span class="comment">// Include support for ftp:// requests.</span></div><div class="line">  <span class="keyword">bool</span> ftp_enabled_;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">  <span class="keyword">bool</span> http_cache_enabled_;</div><div class="line">  <span class="keyword">bool</span> throttling_enabled_;</div><div class="line">  <span class="keyword">bool</span> backoff_enabled_;</div><div class="line">  <span class="keyword">bool</span> sdch_enabled_;</div><div class="line">  <span class="keyword">bool</span> cookie_store_set_by_client_;</div><div class="line"></div><div class="line">  scoped_refptr&lt;base::SingleThreadTaskRunner&gt; file_task_runner_;</div><div class="line">  HttpCacheParams http_cache_params_;</div><div class="line">  HttpNetworkSessionParams http_network_session_params_;</div><div class="line">  base::FilePath transport_security_persister_path_;</div><div class="line">  NetLog* net_log_;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;HostResolver&gt; host_resolver_;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ChannelIDService&gt; channel_id_service_;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ProxyConfigService&gt; proxy_config_service_;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ProxyService&gt; proxy_service_;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;NetworkDelegate&gt; network_delegate_;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ProxyDelegate&gt; proxy_delegate_;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;CookieStore&gt; cookie_store_;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(DISABLE_FTP_SUPPORT)</span></div><div class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;FtpTransactionFactory&gt; ftp_transaction_factory_;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p>会根据宏定义来确定某些字段是否存在，如<strong><code>ftp_enabled_</code></strong>等。如果两边的宏定义不同，则会导致两边对net::URLRequestContextBuilder对象的处理不同。对于定义了宏DISABLE_FTP_SUPPORT的一边，它在为net::URLRequestContextBuilder对象分配内存空间时，将小于另一边看到的相同类对象的内存空间大小，可想而知，在运行期该会要出现什么样的奇怪问题了。</p>
<p>比如，我们在我们的工程中，定义了宏DISABLE_FTP_SUPPORT，而在编译chromium net时没有定义这个宏。在我们的native代码里，在栈上创建了一个net::URLRequestContextBuilder对象，内存将由我们的工程的编译器分配。而在运行期，分配的这块内存会被传递给类的构造函数，该构造函数则是在chromium net的so中，而它对这块内存空间的预期要大于我们的工程的编译器分配的大小，则在初始化的过程中，难免要踩坏周围的内存的。</p>
<p>为了避免这个问题，最好的方法就是将相关的这些编译、连接，预定义宏等，在两边保持一致。gn工具在这个问题上也可以帮到我们，同样是gn desc，我们需要从输出的如下这些段中提取我们要的参数：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div></pre></td><td class="code"><pre><div class="line">$ gn desc out/Default/ net</div><div class="line">......</div><div class="line">cflags</div><div class="line">  -<span class="ruby">fno-strict-aliasing</span></div><div class="line">  -<span class="ruby">-param=ssp-buffer-size=<span class="number">4</span></span></div><div class="line">  -<span class="ruby">fstack-protector</span></div><div class="line">  -<span class="ruby">funwind-tables</span></div><div class="line">  -<span class="ruby">fPIC</span></div><div class="line">  -<span class="ruby">pipe</span></div><div class="line">  -<span class="ruby">ffunction-sections</span></div><div class="line">  -<span class="ruby">fno-short-enums</span></div><div class="line">  -<span class="ruby">finline-limit=<span class="number">64</span></span></div><div class="line">  -<span class="ruby">march=armv7-a</span></div><div class="line">  -<span class="ruby">mfloat-abi=softfp</span></div><div class="line">  -<span class="ruby">mthumb</span></div><div class="line">  -<span class="ruby">mthumb-interwork</span></div><div class="line">  -<span class="ruby">mtune=generic-armv7-a</span></div><div class="line">  -<span class="ruby">fno-tree-sra</span></div><div class="line">  -<span class="ruby">fno-caller-saves</span></div><div class="line">  -<span class="ruby">mfpu=neon</span></div><div class="line">  -<span class="ruby">Wall</span></div><div class="line">  -<span class="ruby">Werror</span></div><div class="line">  -<span class="ruby">Wno-psabi</span></div><div class="line">  -<span class="ruby">Wno-unused-local-typedefs</span></div><div class="line">  -<span class="ruby">Wno-maybe-uninitialized</span></div><div class="line">  -<span class="ruby">Wno-missing-field-initializers</span></div><div class="line">  -<span class="ruby">Wno-unused-parameter</span></div><div class="line">  -<span class="ruby">Os</span></div><div class="line">  -<span class="ruby">fdata-sections</span></div><div class="line">  -<span class="ruby">ffunction-sections</span></div><div class="line">  -<span class="ruby">fomit-frame-pointer</span></div><div class="line">  -<span class="ruby">g1</span></div><div class="line">  -<span class="ruby">-sysroot=../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/platforms/android-<span class="number">16</span>/arch-arm</span></div><div class="line">  -<span class="ruby">fvisibility=hidden</span></div><div class="line"></div><div class="line">cflags_cc</div><div class="line">  -<span class="ruby">fno-threadsafe-statics</span></div><div class="line">  -<span class="ruby">fvisibility-inlines-hidden</span></div><div class="line">  -<span class="ruby">std=gnu++<span class="number">11</span></span></div><div class="line">  -<span class="ruby">Wno-narrowing</span></div><div class="line">  -<span class="ruby">fno-rtti</span></div><div class="line">  -<span class="ruby">isystem../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/sources/cxx-stl/llvm-libc++<span class="regexp">/libcxx/include</span></span></div><div class="line">  -<span class="ruby">isystem../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/sources/cxx-stl/llvm-libc++abi/libcxxabi/<span class="keyword">include</span></span></div><div class="line">  -<span class="ruby">isystem../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/sources/android/support/<span class="keyword">include</span></span></div><div class="line">  -<span class="ruby">fno-exceptions</span></div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">defines</div><div class="line">  V8_DEPRECATION_WARNINGS</div><div class="line">  ENABLE_NOTIFICATIONS</div><div class="line">  ENABLE_BROWSER_CDMS</div><div class="line">  ENABLE_PRINTING=1</div><div class="line">  ENABLE_BASIC_PRINTING=1</div><div class="line">  ENABLE_SPELLCHECK=1</div><div class="line">  USE_BROWSER_SPELLCHECKER=1</div><div class="line">  USE_OPENSSL_CERTS=1</div><div class="line">  NO_TCMALLOC</div><div class="line">  USE_EXTERNAL_POPUP_MENU=1</div><div class="line">  ENABLE_WEBRTC=1</div><div class="line">  DISABLE_NACL</div><div class="line">  ENABLE_SUPERVISED_USERS=1</div><div class="line">  VIDEO_HOLE=1</div><div class="line">  SAFE_BROWSING_DB_REMOTE</div><div class="line">  CHROMIUM_BUILD</div><div class="line">  ENABLE_MEDIA_ROUTER=1</div><div class="line">  ENABLE_WEBVR</div><div class="line">  FIELDTRIAL_TESTING_ENABLED</div><div class="line">  _FILE_OFFSET_BITS=64</div><div class="line">  ANDROID</div><div class="line">  HAVE_SYS_UIO_H</div><div class="line">  ANDROID_NDK_VERSION=r10e</div><div class="line">  __STDC_CONSTANT_MACROS</div><div class="line">  __STDC_FORMAT_MACROS</div><div class="line">  COMPONENT_BUILD</div><div class="line">  __GNU_SOURCE=1</div><div class="line">  _DEBUG</div><div class="line">  DYNAMIC_ANNOTATIONS_ENABLED=1</div><div class="line">  WTF_USE_DYNAMIC_ANNOTATIONS=1</div><div class="line">  DLOPEN_KERBEROS</div><div class="line">  NET_IMPLEMENTATION</div><div class="line">  USE_KERBEROS</div><div class="line">  ENABLE_BUILT_IN_DNS</div><div class="line">  POSIX_AVOID_MMAP</div><div class="line">  ENABLE_WEBSOCKETS</div><div class="line">  GOOGLE_PROTOBUF_NO_RTTI</div><div class="line">  GOOGLE_PROTOBUF_NO_STATIC_INITIALIZER</div><div class="line">  HAVE_PTHREAD</div><div class="line">  PROTOBUF_USE_DLLS</div><div class="line">  BORINGSSL_SHARED_LIBRARY</div><div class="line">  U_USING_ICU_NAMESPACE=0</div><div class="line">  U_ENABLE_DYLOAD=0</div><div class="line">  U_NOEXCEPT=</div><div class="line">  ICU_UTIL_DATA_IMPL=ICU_UTIL_DATA_FILE</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">ldflags</div><div class="line">  -<span class="ruby">Wl,--fatal-warnings</span></div><div class="line">  -<span class="ruby">fPIC</span></div><div class="line">  -<span class="ruby">Wl,-z,noexecstack</span></div><div class="line">  -<span class="ruby">Wl,-z,now</span></div><div class="line">  -<span class="ruby">Wl,-z,relro</span></div><div class="line">  -<span class="ruby">Wl,-z,defs</span></div><div class="line">  -<span class="ruby">fuse-ld=gold</span></div><div class="line">  -<span class="ruby">Wl,--icf=all</span></div><div class="line">  -<span class="ruby">Wl,--build-id=sha1</span></div><div class="line">  -<span class="ruby">Wl,--no-undefined</span></div><div class="line">  -<span class="ruby">Wl,--exclude-libs=libgcc.a</span></div><div class="line">  -<span class="ruby">Wl,--exclude-libs=libc++_static.a</span></div><div class="line">  -<span class="ruby">Wl,--exclude-libs=libvpx_assembly_arm.a</span></div><div class="line">  -<span class="ruby">Wl,--warn-shared-textrel</span></div><div class="line">  -<span class="ruby">Wl,-O1</span></div><div class="line">  -<span class="ruby">Wl,--as-needed</span></div><div class="line">  -<span class="ruby">nostdlib</span></div><div class="line">  -<span class="ruby">Wl,--warn-shared-textrel</span></div><div class="line">  -<span class="ruby">-sysroot=../../../../../../home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/platforms/android-<span class="number">16</span>/arch-arm</span></div><div class="line">  </div><div class="line">  -<span class="ruby">Wl,-wrap,calloc</span></div><div class="line">  -<span class="ruby">Wl,-wrap,free</span></div><div class="line">  -<span class="ruby">Wl,-wrap,malloc</span></div><div class="line">  -<span class="ruby">Wl,-wrap,memalign</span></div><div class="line">  -<span class="ruby">Wl,-wrap,posix_memalign</span></div><div class="line">  -<span class="ruby">Wl,-wrap,pvalloc</span></div><div class="line">  -<span class="ruby">Wl,-wrap,realloc</span></div><div class="line">  -<span class="ruby">Wl,-wrap,valloc</span></div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">libs</div><div class="line">  c++_shared</div><div class="line"><span class="comment">  /home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/lib/gcc/arm-linux-androideabi/4.9/libgcc.a</span></div><div class="line">  c</div><div class="line">  atomic</div><div class="line">  dl</div><div class="line">  m</div><div class="line">  log</div><div class="line">  unwind</div><div class="line"></div><div class="line">lib_dirs</div><div class="line"><span class="comment">  /home/hanpfei0306/data/dev_tools/Android/android-ndk-r12b/sources/cxx-stl/llvm-libc++/libs/armeabi-v7a/</span></div></pre></td></tr></table></figure></p>
<p>最终，我们的<strong><em><code>MyApplication/app/build.gradle</code></em></strong>文件将如下面这样：<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.model.application'</span></div><div class="line"></div><div class="line">model &#123;</div><div class="line">    repositories &#123;</div><div class="line">        libs(PrebuiltLibraries) &#123;</div><div class="line">            chromium_net &#123;</div><div class="line">                headers.srcDir <span class="string">"src/main/jni/third_party/chromium/include"</span></div><div class="line">                binaries.withType(SharedLibraryBinary) &#123;</div><div class="line">                    sharedLibraryFile = file(<span class="string">"src/main/jni/third_party/chromium/libs/$&#123;targetPlatform.getName()&#125;/libnet.cr.so"</span>)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            chromium_base &#123;</div><div class="line">                headers.srcDir <span class="string">"src/main/jni/third_party/chromium/include"</span></div><div class="line">                binaries.withType(SharedLibraryBinary) &#123;</div><div class="line">                    sharedLibraryFile = file(<span class="string">"src/main/jni/third_party/chromium/libs/$&#123;targetPlatform.getName()&#125;/libbase.cr.so"</span>)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            chromium_url &#123;</div><div class="line">                headers.srcDir <span class="string">"src/main/jni/third_party/chromium/include"</span></div><div class="line">                binaries.withType(SharedLibraryBinary) &#123;</div><div class="line">                    sharedLibraryFile = file(<span class="string">"src/main/jni/third_party/chromium/libs/$&#123;targetPlatform.getName()&#125;/liburl.cr.so"</span>)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    android &#123;</div><div class="line">        compileSdkVersion <span class="number">23</span></div><div class="line">        buildToolsVersion <span class="string">"23.0.3"</span></div><div class="line"></div><div class="line">        defaultConfig &#123;</div><div class="line">            applicationId <span class="string">"com.example.hanpfei0306.myapplication"</span></div><div class="line">            minSdkVersion.apiLevel <span class="number">19</span></div><div class="line">            targetSdkVersion.apiLevel <span class="number">21</span></div><div class="line">            versionCode <span class="number">1</span></div><div class="line">            versionName <span class="string">"1.0"</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ndk &#123;</div><div class="line">            moduleName <span class="string">"neteasenet"</span></div><div class="line">            toolchain <span class="string">"clang"</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">            CFlags.addAll([<span class="string">"-fno-strict-aliasing"</span>,</div><div class="line">                           <span class="string">"--param=ssp-buffer-size=4"</span>,</div><div class="line">                           <span class="string">"-fstack-protector"</span>,</div><div class="line">                           <span class="string">"-funwind-tables"</span>,</div><div class="line">                           <span class="string">"-fPIC"</span>,</div><div class="line">                           <span class="string">"-pipe"</span>,</div><div class="line">                           <span class="string">"-ffunction-sections"</span>,</div><div class="line">                           <span class="string">"-fno-short-enums"</span>,</div><div class="line">                           <span class="string">"-finline-limit=64"</span>,</div><div class="line">                           <span class="string">"-mfloat-abi=softfp"</span>,</div><div class="line">                           <span class="string">"-mfpu=neon"</span>,</div><div class="line">                           <span class="string">"-Os"</span>,</div><div class="line">                           <span class="string">"-fdata-sections"</span>,</div><div class="line">                           <span class="string">"-ffunction-sections"</span>,</div><div class="line">                           <span class="string">"-fomit-frame-pointer"</span>,</div><div class="line">                           <span class="string">"-g1"</span>,</div><div class="line">                           <span class="string">"-fvisibility=hidden"</span></div><div class="line">            ])</div><div class="line">            CFlags.addAll([<span class="string">'-I'</span> + file(<span class="string">'src/main/jni/third_party/chromium/include/'</span>),])</div><div class="line"></div><div class="line">            cppFlags.addAll([<span class="string">"-fno-threadsafe-statics"</span>,</div><div class="line">                             <span class="string">"-fvisibility-inlines-hidden"</span>,</div><div class="line">                             <span class="string">"-std=gnu++11"</span>,</div><div class="line">                             <span class="string">"-Wno-narrowing"</span>,</div><div class="line">                             <span class="string">"-fno-rtti"</span>,</div><div class="line">            ])</div><div class="line">            cppFlags.addAll([<span class="string">"-DV8_DEPRECATION_WARNINGS"</span>,</div><div class="line">                             <span class="string">"-DENABLE_NOTIFICATIONS"</span>,</div><div class="line">                             <span class="string">"-DENABLE_BROWSER_CDMS"</span>,</div><div class="line">                             <span class="string">"-DENABLE_PRINTING=1"</span>,</div><div class="line">                             <span class="string">"-DENABLE_BASIC_PRINTING=1"</span>,</div><div class="line">                             <span class="string">"-DENABLE_SPELLCHECK=1"</span>,</div><div class="line">                             <span class="string">"-DUSE_BROWSER_SPELLCHECKER=1"</span>,</div><div class="line">                             <span class="string">"-DUSE_OPENSSL_CERTS=1"</span>,</div><div class="line">                             <span class="string">"-DNO_TCMALLOC"</span>,</div><div class="line">                             <span class="string">"-DUSE_EXTERNAL_POPUP_MENU=1"</span>,</div><div class="line">                             <span class="string">"-DDISABLE_NACL"</span>,</div><div class="line">                             <span class="string">"-DENABLE_SUPERVISED_USERS=1"</span>,</div><div class="line">                             <span class="string">"-DCHROMIUM_BUILD"</span>,</div><div class="line">                             <span class="string">"-D_FILE_OFFSET_BITS=64"</span>,</div><div class="line">                             <span class="string">"-DANDROID"</span>,</div><div class="line">                             <span class="string">"-DHAVE_SYS_UIO_H"</span>,</div><div class="line">                             <span class="string">"-D__STDC_CONSTANT_MACROS"</span>,</div><div class="line">                             <span class="string">"-D__STDC_FORMAT_MACROS"</span>,</div><div class="line">                             <span class="string">"-D_FORTIFY_SOURCE=2"</span>,</div><div class="line">                             <span class="string">"-DCOMPONENT_BUILD"</span>,</div><div class="line">                             <span class="string">"-D__GNU_SOURCE=1"</span>,</div><div class="line">                             <span class="string">"-D_DEBUG"</span>,</div><div class="line">                             <span class="string">"-DDYNAMIC_ANNOTATIONS_ENABLED=1"</span>,</div><div class="line">                             <span class="string">"-DWTF_USE_DYNAMIC_ANNOTATIONS=1"</span>,</div><div class="line">                             <span class="string">"-DDLOPEN_KERBEROS"</span>,</div><div class="line">                             <span class="string">"-DNET_IMPLEMENTATION"</span>,</div><div class="line">                             <span class="string">"-DUSE_KERBEROS"</span>,</div><div class="line">                             <span class="string">"-DENABLE_BUILT_IN_DNS"</span>,</div><div class="line">                             <span class="string">"-DPOSIX_AVOID_MMAP"</span>,</div><div class="line">                             <span class="string">"-DENABLE_WEBSOCKETS"</span>,</div><div class="line">                             <span class="string">"-DGOOGLE_PROTOBUF_NO_RTTI"</span>,</div><div class="line">                             <span class="string">"-DGOOGLE_PROTOBUF_NO_STATIC_INITIALIZER"</span>,</div><div class="line">                             <span class="string">"-DHAVE_PTHREAD"</span>,</div><div class="line">                             <span class="string">"-DPROTOBUF_USE_DLLS"</span>,</div><div class="line">                             <span class="string">"-DBORINGSSL_SHARED_LIBRARY"</span>,</div><div class="line">                             <span class="string">"-DU_USING_ICU_NAMESPACE=0"</span>,</div><div class="line">                             <span class="string">"-DU_ENABLE_DYLOAD=0"</span>,</div><div class="line">            ])</div><div class="line">            cppFlags.addAll([<span class="string">'-I'</span> + file(<span class="string">'src/main/jni/third_party/chromium/include'</span>), ])</div><div class="line"></div><div class="line">            ldLibs.add(<span class="string">"android"</span>)</div><div class="line">            ldLibs.add(<span class="string">"log"</span>)</div><div class="line">            ldLibs.add(<span class="string">"z"</span>)</div><div class="line">            stl <span class="string">"c++_shared"</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        sources &#123;</div><div class="line">            main &#123;</div><div class="line">                java &#123;</div><div class="line">                    source &#123;</div><div class="line">                        srcDir <span class="string">"src/main/java"</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                jni &#123;</div><div class="line">                    source &#123;</div><div class="line">                        srcDirs = [<span class="string">"src/main/jni"</span>,]</div><div class="line">                    &#125;</div><div class="line">                    dependencies &#123;</div><div class="line">                        library <span class="string">'chromium_base'</span> linkage <span class="string">'shared'</span></div><div class="line">                        library <span class="string">'chromium_url'</span> linkage <span class="string">'shared'</span></div><div class="line">                        library <span class="string">'chromium_net'</span> linkage <span class="string">'shared'</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                jniLibs &#123;</div><div class="line">                    source &#123;</div><div class="line">                        srcDirs =[<span class="string">"src/main/jni/third_party/chromium/libs"</span>,]</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        buildTypes &#123;</div><div class="line">            debug &#123;</div><div class="line">                ndk &#123;</div><div class="line">                    abiFilters.add(<span class="string">"armeabi"</span>)</div><div class="line">                    abiFilters.add(<span class="string">"armeabi-v7a"</span>)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            release &#123;</div><div class="line">                minifyEnabled false</div><div class="line">                proguardFiles.add(file(<span class="string">"proguard-rules.pro"</span>))</div><div class="line">                ndk &#123;</div><div class="line">                    abiFilters.add(<span class="string">"armeabi"</span>)</div><div class="line">                    abiFilters.add(<span class="string">"armeabi-v7a"</span>)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">dependencies &#123;</div><div class="line">    compile fileTree(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</div><div class="line">    testCompile <span class="string">'junit:junit:4.12'</span></div><div class="line"></div><div class="line">    compile <span class="string">'com.android.support:appcompat-v7:23.4.0'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wxpay.png" alt="Han Pengfei 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Han Pengfei 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android开发/" rel="tag"># Android开发</a>
          
            <a href="/tags/chromium/" rel="tag"># chromium</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/10/16/Chromium_Android编译指南/" rel="next" title="Chromium Android编译指南">
                <i class="fa fa-chevron-left"></i> Chromium Android编译指南
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/10/27/OkHttp3连接建立过程分析/" rel="prev" title="OkHttp3连接建立过程分析">
                OkHttp3连接建立过程分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/freesoft.jpg"
                alt="Han Pengfei" />
            
              <p class="site-author-name" itemprop="name">Han Pengfei</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">207</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/hanpfei" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.douban.com/people/3681478/" target="_blank" title="豆瓣"><i class="fa fa-fw fa-globe"></i>豆瓣</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/han-peng-fei-49" target="_blank" title="知乎"><i class="fa fa-fw fa-globe"></i>知乎</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:hanpfei@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#编译net模块"><span class="nav-number">1.</span> <span class="nav-text">编译net模块</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#提取导出头文件"><span class="nav-number">2.</span> <span class="nav-text">提取导出头文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chromium-net的简单使用"><span class="nav-number">3.</span> <span class="nav-text">Chromium net的简单使用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置Gradle"><span class="nav-number">4.</span> <span class="nav-text">配置Gradle</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#应用工程编译"><span class="nav-number">5.</span> <span class="nav-text">应用工程编译</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置stl："><span class="nav-number">5.1.</span> <span class="nav-text">配置stl：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#引入chromium的build配置头文件"><span class="nav-number">5.2.</span> <span class="nav-text">引入chromium的build配置头文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#引入遗漏的头文件"><span class="nav-number">5.3.</span> <span class="nav-text">引入遗漏的头文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#引入url模块的导出头文件"><span class="nav-number">5.4.</span> <span class="nav-text">引入url模块的导出头文件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#注释掉gtest相关代码"><span class="nav-number">6.</span> <span class="nav-text">注释掉gtest相关代码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置C-11"><span class="nav-number">6.1.</span> <span class="nav-text">配置C++11</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#链接"><span class="nav-number">7.</span> <span class="nav-text">链接</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#选择正确的STL库"><span class="nav-number">7.1.</span> <span class="nav-text">选择正确的STL库</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#采用标准NDK编译chromium-net"><span class="nav-number">8.</span> <span class="nav-text">采用标准NDK编译chromium net</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编译链接的标记设置"><span class="nav-number">9.</span> <span class="nav-text">编译链接的标记设置</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016.09.16 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Han Pengfei</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.3"></script>



  



	





  





  









<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 's9sbM9ODdusCzKcm5JcIj6t8-gzGzoHsz',
    appKey: 'UoO9ia1DLNwOXRUsTBQ6QXxm',
    placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true,
    lang: '' || 'zh-cn'
  });
</script>


  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

</body>
</html>
