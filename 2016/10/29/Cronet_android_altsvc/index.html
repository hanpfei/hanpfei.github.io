<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="mask-icon" href="/images/freesoft.jpg?v=6.0.3" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="网络协议,Android开发,源码分析,chromium," />


<meta name="description" content="前面我们分析到，在URLRequestHttpJob::StartTransactionInternal()中，会通过URLRequestContext的HttpTransactionFactory创建HttpTransaction，在URLRequestContextBuilder::Build()中创建HttpTransactionFactory的过程如下：">
<meta property="og:type" content="article">
<meta property="og:title" content="Cronet android 设计与实现分析——备选服务机制">
<meta property="og:url" content="https://www.wolfcstech.com/2016/10/29/Cronet_android_altsvc/index.html">
<meta property="og:site_name" content="WolfcsTech">
<meta property="og:description" content="前面我们分析到，在URLRequestHttpJob::StartTransactionInternal()中，会通过URLRequestContext的HttpTransactionFactory创建HttpTransaction，在URLRequestContextBuilder::Build()中创建HttpTransactionFactory的过程如下：">
<meta property="og:image" content="https://www.wolfcstech.com/images/1315506-9747918544dc1c4e.png">
<meta property="og:image" content="https://www.wolfcstech.com/images/1315506-7a5e27d49cadf278.png">
<meta property="og:image" content="https://www.wolfcstech.com/images/1315506-dd573ba5d84ca413.png">
<meta property="og:updated_time" content="2017-02-16T06:59:36.169Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cronet android 设计与实现分析——备选服务机制">
<meta name="twitter:description" content="前面我们分析到，在URLRequestHttpJob::StartTransactionInternal()中，会通过URLRequestContext的HttpTransactionFactory创建HttpTransaction，在URLRequestContextBuilder::Build()中创建HttpTransactionFactory的过程如下：">
<meta name="twitter:image" content="https://www.wolfcstech.com/images/1315506-9747918544dc1c4e.png">






  <link rel="canonical" href="https://www.wolfcstech.com/2016/10/29/Cronet_android_altsvc/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>Cronet android 设计与实现分析——备选服务机制 | WolfcsTech</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-109419024-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-109419024-1');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WolfcsTech</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="http://www.ixirong.com/404.html" rel="section">
            <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />Commonweal 404</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.wolfcstech.com/2016/10/29/Cronet_android_altsvc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Han Pengfei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/freesoft.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WolfcsTech">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Cronet android 设计与实现分析——备选服务机制</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-29T14:07:49+08:00">2016-10-29</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络协议/" itemprop="url" rel="index"><span itemprop="name">网络协议</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/29/Cronet_android_altsvc/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2016/10/29/Cronet_android_altsvc/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/10/29/Cronet_android_altsvc/" class="leancloud_visitors" data-flag-title="Cronet android 设计与实现分析——备选服务机制">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>前面我们分析到，在<code>URLRequestHttpJob::StartTransactionInternal()</code>中，会通过<code>URLRequestContext</code>的<code>HttpTransactionFactory</code>创建<code>HttpTransaction</code>，在<code>URLRequestContextBuilder::Build()</code>中创建<code>HttpTransactionFactory</code>的过程如下：</p>
<a id="more"></a>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">storage-&gt;set_http_network_session(</div><div class="line">    base::WrapUnique(<span class="keyword">new</span> HttpNetworkSession(network_session_params)));</div><div class="line"></div><div class="line">std::unique_ptr&lt;HttpTransactionFactory&gt; http_transaction_factory;</div><div class="line"><span class="keyword">if</span> (http_cache_enabled_) &#123;</div><div class="line">  std::unique_ptr&lt;HttpCache::BackendFactory&gt; http_cache_backend;</div><div class="line">  <span class="keyword">if</span> (http_cache_params_.type != HttpCacheParams::IN_MEMORY) &#123;</div><div class="line">    BackendType backend_type =</div><div class="line">        http_cache_params_.type == HttpCacheParams::DISK</div><div class="line">            ? CACHE_BACKEND_DEFAULT</div><div class="line">            : CACHE_BACKEND_SIMPLE;</div><div class="line">    http_cache_backend.reset(<span class="keyword">new</span> HttpCache::DefaultBackend(</div><div class="line">        DISK_CACHE, backend_type, http_cache_params_.path,</div><div class="line">        http_cache_params_.max_size, context-&gt;GetFileTaskRunner()));</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    http_cache_backend =</div><div class="line">        HttpCache::DefaultBackend::InMemory(http_cache_params_.max_size);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  LOG(INFO) &lt;&lt; <span class="string">"Cache is enabled, to create HttpCache"</span>;</div><div class="line">  http_transaction_factory.reset(<span class="keyword">new</span> HttpCache(</div><div class="line">      storage-&gt;http_network_session(), std::move(http_cache_backend), <span class="keyword">true</span>));</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    LOG(INFO) &lt;&lt; <span class="string">"Cache is disabled, to create HttpNetworkLayer"</span>;</div><div class="line">  http_transaction_factory.reset(</div><div class="line">      <span class="keyword">new</span> HttpNetworkLayer(storage-&gt;http_network_session()));</div><div class="line">&#125;</div><div class="line">storage-&gt;set_http_transaction_factory(std::move(http_transaction_factory));</div></pre></td></tr></table></figure>
<p>Chromium net中有两个<code>HttpTransactionFactory</code>的实现，分别是<code>HttpCache</code>和<code>HttpNetworkLayer</code>，它们分别在cache被打开和被关闭时用到。这里还会创建<code>HttpNetworkSession</code>。而在cache打开时，在创建<code>HttpCache</code>的同时，还会为它创建http_cache_backend。</p>
<p>HttpCache的创建过程(chromium_android/src/net/http/http_cache.cc)如下：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//-----------------------------------------------------------------------------</span></div><div class="line">HttpCache::HttpCache(HttpNetworkSession* session,</div><div class="line">                     std::unique_ptr&lt;BackendFactory&gt; backend_factory,</div><div class="line">                     bool set_up_quic_server_info)</div><div class="line">    : HttpCache(base::WrapUnique(<span class="keyword">new</span> HttpNetworkLayer(session)),</div><div class="line">                std::move(backend_factory),</div><div class="line">                set_up_quic_server_info) &#123;&#125;</div><div class="line"></div><div class="line">HttpCache::HttpCache(std::unique_ptr&lt;HttpTransactionFactory&gt; network_layer,</div><div class="line">                     std::unique_ptr&lt;BackendFactory&gt; backend_factory,</div><div class="line">                     bool set_up_quic_server_info)</div><div class="line">    : net_log_(nullptr),</div><div class="line">      backend_factory_(std::move(backend_factory)),</div><div class="line">      building_backend_(<span class="keyword">false</span>),</div><div class="line">      bypass_lock_for_test_(<span class="keyword">false</span>),</div><div class="line">      fail_conditionalization_for_test_(<span class="keyword">false</span>),</div><div class="line">      mode_(NORMAL),</div><div class="line">      network_layer_(std::move(network_layer)),</div><div class="line">      clock_(<span class="keyword">new</span> base::DefaultClock()),</div><div class="line">      weak_factory_(<span class="keyword">this</span>) &#123;</div><div class="line">  HttpNetworkSession* session = network_layer_-&gt;GetSession();</div><div class="line">  <span class="comment">// Session may be NULL in unittests.</span></div><div class="line">  <span class="comment">// TODO(mmenke): Seems like tests could be changed to provide a session,</span></div><div class="line">  <span class="comment">// rather than having logic only used in unit tests here.</span></div><div class="line">  <span class="keyword">if</span> (session) &#123;</div><div class="line">    net_log_ = session-&gt;net_log();</div><div class="line">    <span class="keyword">if</span> (set_up_quic_server_info &amp;&amp;</div><div class="line">        !session-&gt;quic_stream_factory()-&gt;has_quic_server_info_factory()) &#123;</div><div class="line">      <span class="comment">// QuicStreamFactory takes ownership of QuicServerInfoFactoryAdaptor.</span></div><div class="line">      session-&gt;quic_stream_factory()-&gt;set_quic_server_info_factory(</div><div class="line">          <span class="keyword">new</span> QuicServerInfoFactoryAdaptor(<span class="keyword">this</span>));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里还是会创建<code>HttpNetworkLayer</code>。HttpTransactionFactory相关的几个类之间的关系如下：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-9747918544dc1c4e.png" alt="HttpTransactionFactory"></p>
<p><strong>HttpNetworkTransaction</strong>表示一个直接的网络事务，可以理解为一个网络连接。<strong>HttpNetworkSession</strong>用于管理网络连接。<strong>HttpNetworkLayer</strong>主要用于创建<strong>HttpNetworkTransaction</strong>。<strong>HttpCache</strong>和<strong>HttpCache::Transaction</strong>用于处理缓存。<strong>HttpCache::Transaction</strong>表示一个启用了缓存的网络事务，它会借助于<strong>HttpCache</strong>保存的<strong>HttpNetworkLayer</strong>引用创建<strong>HttpNetworkTransaction</strong>，借助于<strong>HttpNetworkTransaction</strong>访问网络，并根据需要将结果缓存起来。<strong>HttpCache</strong>则对缓存进行管理。<strong>HttpNetworkLayer</strong>和<strong>HttpCache</strong>都是<strong>HttpTransactionFactory</strong>，而<strong>HttpNetworkTransaction</strong>和<strong>HttpCache::Transaction</strong>都是<strong>HttpTransaction</strong>。</p>
<p>我们先不关心启用cache时，HTTP请求的处理流程，来看<strong>HttpNetworkLayer</strong>。则在<code>URLRequestHttpJob::StartTransactionInternal()</code>中将通过<strong>HttpNetworkLayer</strong>创建类型为<strong>HttpNetworkTransaction</strong>的<strong>HttpTransaction</strong>：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">HttpNetworkLayer::HttpNetworkLayer(HttpNetworkSession* session)</div><div class="line">    : session_(session),</div><div class="line">      suspended_(<span class="literal">false</span>) &#123;</div><div class="line">  DCHECK(session_);</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></div><div class="line">  base::PowerMonitor* power_monitor = base::PowerMonitor::Get();</div><div class="line">  <span class="keyword">if</span> (power_monitor)</div><div class="line">    power_monitor-&gt;AddObserver(<span class="keyword">this</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line">HttpNetworkLayer::~HttpNetworkLayer() &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></div><div class="line">  base::PowerMonitor* power_monitor = base::PowerMonitor::Get();</div><div class="line">  <span class="keyword">if</span> (power_monitor)</div><div class="line">    power_monitor-&gt;RemoveObserver(<span class="keyword">this</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> HttpNetworkLayer::CreateTransaction(</div><div class="line">    RequestPriority priority,</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;HttpTransaction&gt;* trans) &#123;</div><div class="line">  <span class="keyword">if</span> (suspended_)</div><div class="line">    <span class="keyword">return</span> ERR_NETWORK_IO_SUSPENDED;</div><div class="line"></div><div class="line">  trans-&gt;reset(<span class="keyword">new</span> HttpNetworkTransaction(priority, GetSession()));</div><div class="line">  <span class="keyword">return</span> OK;</div><div class="line">&#125;</div><div class="line"></div><div class="line">HttpCache* HttpNetworkLayer::GetCache() &#123;</div><div class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">HttpNetworkSession* HttpNetworkLayer::GetSession() &#123;</div><div class="line">  <span class="keyword">return</span> session_;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> HttpNetworkLayer::OnSuspend() &#123;</div><div class="line">  suspended_ = <span class="literal">true</span>;</div><div class="line">  session_-&gt;CloseIdleConnections();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> HttpNetworkLayer::OnResume() &#123;</div><div class="line">  suspended_ = <span class="literal">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>URLRequestHttpJob::StartTransactionInternal()</code>创建了<strong>HttpTransaction</strong>之后，它会执行<strong>HttpTransaction</strong>的Start()来启动对HTTP事务的处理，<strong>HttpNetworkTransaction</strong>的Start()定义如下：<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> HttpNetworkTransaction::Start(<span class="keyword">const</span> HttpRequestInfo* request_info,</div><div class="line">                                  <span class="keyword">const</span> CompletionCallback&amp; callback,</div><div class="line">                                  <span class="keyword">const</span> BoundNetLog&amp; net_log) &#123;</div><div class="line">  net_log_ = net_log;</div><div class="line">  request_ = request_info;</div><div class="line"></div><div class="line">  <span class="comment">// Now that we have an HttpRequestInfo object, update server_ssl_config_.</span></div><div class="line">  session_-&gt;GetSSLConfig(*request_, &amp;server_ssl_config_, &amp;proxy_ssl_config_);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (request_-&gt;load_flags &amp; LOAD_DISABLE_CERT_REVOCATION_CHECKING) &#123;</div><div class="line">    server_ssl_config_.rev_checking_enabled = <span class="literal">false</span>;</div><div class="line">    proxy_ssl_config_.rev_checking_enabled = <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (request_-&gt;load_flags &amp; LOAD_PREFETCH)</div><div class="line">    response_.unused_since_prefetch = <span class="literal">true</span>;</div><div class="line"></div><div class="line">  next_state_ = STATE_NOTIFY_BEFORE_CREATE_STREAM;</div><div class="line">  <span class="keyword">int</span> rv = DoLoop(OK);</div><div class="line">  <span class="keyword">if</span> (rv == ERR_IO_PENDING)</div><div class="line">    callback_ = callback;</div><div class="line">  <span class="keyword">return</span> rv;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Chromium net将所有HTTP请求的处理抽象为几个步骤，并通过一个循环DoLoop()来一步一步地执行。DoLoop()的定义 (chromium_android/src/net/http/http_network_transaction.cc) 如下：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> <span class="string">HttpNetworkTransaction:</span>:DoLoop(<span class="keyword">int</span> result) &#123;</div><div class="line">  DCHECK(next_state_ != STATE_NONE);</div><div class="line"></div><div class="line">  <span class="keyword">int</span> rv = result;</div><div class="line">  do &#123;</div><div class="line">    State state = next_state_;</div><div class="line">    next_state_ = STATE_NONE;</div><div class="line">    <span class="keyword">switch</span> (state) &#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_NOTIFY_BEFORE_CREATE_STREAM:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoNotifyBeforeCreateStream();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_CREATE_STREAM:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoCreateStream();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_CREATE_STREAM_COMPLETE:</span></div><div class="line">        rv = DoCreateStreamComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_INIT_STREAM:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoInitStream();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_INIT_STREAM_COMPLETE:</span></div><div class="line">        rv = DoInitStreamComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_GENERATE_PROXY_AUTH_TOKEN:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoGenerateProxyAuthToken();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_GENERATE_PROXY_AUTH_TOKEN_COMPLETE:</span></div><div class="line">        rv = DoGenerateProxyAuthTokenComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_GENERATE_SERVER_AUTH_TOKEN:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoGenerateServerAuthToken();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_GENERATE_SERVER_AUTH_TOKEN_COMPLETE:</span></div><div class="line">        rv = DoGenerateServerAuthTokenComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_GET_PROVIDED_TOKEN_BINDING_KEY:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoGetProvidedTokenBindingKey();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_GET_PROVIDED_TOKEN_BINDING_KEY_COMPLETE:</span></div><div class="line">        rv = DoGetProvidedTokenBindingKeyComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_GET_REFERRED_TOKEN_BINDING_KEY:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoGetReferredTokenBindingKey();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_GET_REFERRED_TOKEN_BINDING_KEY_COMPLETE:</span></div><div class="line">        rv = DoGetReferredTokenBindingKeyComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_INIT_REQUEST_BODY:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoInitRequestBody();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_INIT_REQUEST_BODY_COMPLETE:</span></div><div class="line">        rv = DoInitRequestBodyComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_BUILD_REQUEST:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        net_log_.BeginEvent(<span class="string">NetLog:</span>:TYPE_HTTP_TRANSACTION_SEND_REQUEST);</div><div class="line">        rv = DoBuildRequest();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_BUILD_REQUEST_COMPLETE:</span></div><div class="line">        rv = DoBuildRequestComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_SEND_REQUEST:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoSendRequest();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_SEND_REQUEST_COMPLETE:</span></div><div class="line">        rv = DoSendRequestComplete(rv);</div><div class="line">        net_log_.EndEventWithNetErrorCode(</div><div class="line"><span class="symbol">            NetLog:</span>:TYPE_HTTP_TRANSACTION_SEND_REQUEST, rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_READ_HEADERS:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        net_log_.BeginEvent(<span class="string">NetLog:</span>:TYPE_HTTP_TRANSACTION_READ_HEADERS);</div><div class="line">        rv = DoReadHeaders();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_READ_HEADERS_COMPLETE:</span></div><div class="line">        rv = DoReadHeadersComplete(rv);</div><div class="line">        net_log_.EndEventWithNetErrorCode(</div><div class="line"><span class="symbol">            NetLog:</span>:TYPE_HTTP_TRANSACTION_READ_HEADERS, rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_READ_BODY:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        net_log_.BeginEvent(<span class="string">NetLog:</span>:TYPE_HTTP_TRANSACTION_READ_BODY);</div><div class="line">        rv = DoReadBody();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_READ_BODY_COMPLETE:</span></div><div class="line">        rv = DoReadBodyComplete(rv);</div><div class="line">        net_log_.EndEventWithNetErrorCode(</div><div class="line"><span class="symbol">            NetLog:</span>:TYPE_HTTP_TRANSACTION_READ_BODY, rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_DRAIN_BODY_FOR_AUTH_RESTART:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        net_log_.BeginEvent(</div><div class="line"><span class="symbol">            NetLog:</span>:TYPE_HTTP_TRANSACTION_DRAIN_BODY_FOR_AUTH_RESTART);</div><div class="line">        rv = DoDrainBodyForAuthRestart();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_DRAIN_BODY_FOR_AUTH_RESTART_COMPLETE:</span></div><div class="line">        rv = DoDrainBodyForAuthRestartComplete(rv);</div><div class="line">        net_log_.EndEventWithNetErrorCode(</div><div class="line"><span class="symbol">            NetLog:</span>:TYPE_HTTP_TRANSACTION_DRAIN_BODY_FOR_AUTH_RESTART, rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line"><span class="symbol">      default:</span></div><div class="line">        NOTREACHED() &lt;&lt; <span class="string">"bad state"</span>;</div><div class="line">        rv = ERR_FAILED;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">while</span> (rv != ERR_IO_PENDING &amp;&amp; next_state_ != STATE_NONE);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> rv;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们逐个地分析这些步骤。</p>
<h1 id="Stream的创建"><a href="#Stream的创建" class="headerlink" title="Stream的创建"></a>Stream的创建</h1><p>DoNotifyBeforeCreateStream()执行before_network_start_callback：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> HttpNetworkTransaction::DoNotifyBeforeCreateStream() &#123;</div><div class="line">  next_state_ = STATE_CREATE_STREAM;</div><div class="line">  <span class="keyword">bool</span> <span class="keyword">defer</span> = <span class="literal">false</span>;</div><div class="line">  <span class="keyword">if</span> (!before_network_start_callback_.is_null())</div><div class="line">    before_network_start_callback_.Run(&amp;<span class="keyword">defer</span>);</div><div class="line">  <span class="keyword">if</span> (!<span class="keyword">defer</span>)</div><div class="line">    <span class="keyword">return</span> OK;</div><div class="line">  <span class="keyword">return</span> ERR_IO_PENDING;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在DoCreateStream()中创建Stream：<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> HttpNetworkTransaction::DoCreateStream() &#123;</div><div class="line">  <span class="comment">// TODO(mmenke): Remove ScopedTracker below once crbug.com/424359 is fixed.</span></div><div class="line">  tracked_objects::ScopedTracker tracking_profile(</div><div class="line">      FROM_HERE_WITH_EXPLICIT_FUNCTION(</div><div class="line">          <span class="string">"424359 HttpNetworkTransaction::DoCreateStream"</span>));</div><div class="line"></div><div class="line">  response_.network_accessed = <span class="literal">true</span>;</div><div class="line"></div><div class="line">  next_state_ = STATE_CREATE_STREAM_COMPLETE;</div><div class="line">  <span class="keyword">if</span> (ForWebSocketHandshake()) &#123;</div><div class="line">    stream_request_.reset(</div><div class="line">        session_-&gt;http_stream_factory_for_websocket()</div><div class="line">            -&gt;RequestWebSocketHandshakeStream(</div><div class="line">                  *request_,</div><div class="line">                  priority_,</div><div class="line">                  server_ssl_config_,</div><div class="line">                  proxy_ssl_config_,</div><div class="line">                  this,</div><div class="line">                  websocket_handshake_stream_base_create_helper_,</div><div class="line">                  net_log_));</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    stream_request_.reset(</div><div class="line">        session_-&gt;http_stream_factory()-&gt;RequestStream(</div><div class="line">            *request_,</div><div class="line">            priority_,</div><div class="line">            server_ssl_config_,</div><div class="line">            proxy_ssl_config_,</div><div class="line">            this,</div><div class="line">            net_log_));</div><div class="line">  &#125;</div><div class="line">  DCHECK(stream_request_.get());</div><div class="line">  <span class="keyword">return</span> ERR_IO_PENDING;</div><div class="line">&#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line"><span class="keyword">bool</span> HttpNetworkTransaction::ForWebSocketHandshake() <span class="keyword">const</span> &#123;</div><div class="line">  <span class="keyword">return</span> websocket_handshake_stream_base_create_helper_ &amp;&amp;</div><div class="line">         request_-&gt;url.SchemeIsWSOrWSS();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当请求是一个Websocket请求时，通过HttpNetworkSession的http_stream_factory_for_websocket创建Stream，而其他情况下，则会通过HttpNetworkSession的http_stream_factory创建Stream。</p>
<p>由<strong>HttpNetworkSession</strong>的创建过程 (chromium_android/src/net/http/http_network_session.cc) 可以看到，http_stream_factory_for_websocket和http_stream_factory都是<strong>HttpStreamFactoryImpl</strong>：<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http_stream_factory_(<span class="keyword">new</span> HttpStreamFactoryImpl(<span class="keyword">this</span>, <span class="literal">false</span>)),</div><div class="line">http_stream_factory_for_websocket_(<span class="keyword">new</span> HttpStreamFactoryImpl(<span class="keyword">this</span>, <span class="literal">true</span>)),</div></pre></td></tr></table></figure></p>
<p>为Websocket之外的其它请求创建Stream的过程 (chromium_android/src/net/http/http_stream_factory_impl.cc) 为：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">HttpStreamFactoryImpl::HttpStreamFactoryImpl(HttpNetworkSession* session,</div><div class="line">                                             <span class="keyword">bool</span> for_websockets)</div><div class="line">    : session_(session),</div><div class="line">      job_factory_(<span class="keyword">new</span> DefaultJobFactory()),</div><div class="line">      for_websockets_(for_websockets) &#123;&#125;</div><div class="line"></div><div class="line">HttpStreamRequest* HttpStreamFactoryImpl::RequestStream(</div><div class="line">    <span class="keyword">const</span> HttpRequestInfo&amp; request_info,</div><div class="line">    RequestPriority priority,</div><div class="line">    <span class="keyword">const</span> SSLConfig&amp; server_ssl_config,</div><div class="line">    <span class="keyword">const</span> SSLConfig&amp; proxy_ssl_config,</div><div class="line">    HttpStreamRequest::Delegate* delegate,</div><div class="line">    <span class="keyword">const</span> BoundNetLog&amp; net_log) &#123;</div><div class="line">  DCHECK(!for_websockets_);</div><div class="line">  <span class="keyword">return</span> RequestStreamInternal(request_info, priority, server_ssl_config,</div><div class="line">                               proxy_ssl_config, delegate, nullptr,</div><div class="line">                               HttpStreamRequest::HTTP_STREAM, net_log);</div><div class="line">&#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">HttpStreamRequest* HttpStreamFactoryImpl::RequestStreamInternal(</div><div class="line">    <span class="keyword">const</span> HttpRequestInfo&amp; request_info,</div><div class="line">    RequestPriority priority,</div><div class="line">    <span class="keyword">const</span> SSLConfig&amp; server_ssl_config,</div><div class="line">    <span class="keyword">const</span> SSLConfig&amp; proxy_ssl_config,</div><div class="line">    HttpStreamRequest::Delegate* delegate,</div><div class="line">    WebSocketHandshakeStreamBase::CreateHelper*</div><div class="line">        websocket_handshake_stream_create_helper,</div><div class="line">    HttpStreamRequest::StreamType stream_type,</div><div class="line">    <span class="keyword">const</span> BoundNetLog&amp; net_log) &#123;</div><div class="line">  JobController* job_controller =</div><div class="line">      <span class="keyword">new</span> JobController(this, delegate, session_, job_factory_.get());</div><div class="line">  job_controller_set_.insert(base::WrapUnique(job_controller));</div><div class="line"></div><div class="line">  Request* request = job_controller-&gt;Start(</div><div class="line">      request_info, delegate, websocket_handshake_stream_create_helper, net_log,</div><div class="line">      stream_type, priority, server_ssl_config, proxy_ssl_config);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> request;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在HttpStreamFactoryImpl::RequestStreamInternal()中，主要是创建了一个JobController，然后用job_controller-&gt;Start()创建了Request，也就是HttpStreamRequest。</p>
<p>由HttpStreamFactoryImpl的构造函数可以看到，<strong>job<em>factory</em></strong>是DefaultJobFactory，这个类的实现也相当简单(chromium_android/src/net/http/http_stream_factory_impl.cc) ：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="title">namespace</span> &#123;</div><div class="line">// <span class="type">Default</span> <span class="type">JobFactory</span> for creating <span class="type">HttpStreamFactoryImpl</span>::<span class="type">Jobs</span>.</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="type">DefaultJobFactory</span> : public <span class="type">HttpStreamFactoryImpl</span>::<span class="type">JobFactory</span> &#123;</span></div><div class="line"> public:</div><div class="line">  <span class="type">DefaultJobFactory</span>() &#123;&#125;</div><div class="line"></div><div class="line">  ~<span class="type">DefaultJobFactory</span>() override &#123;&#125;</div><div class="line"></div><div class="line">  <span class="type">HttpStreamFactoryImpl</span>::<span class="type">Job</span>* <span class="type">CreateJob</span>(</div><div class="line">      <span class="type">HttpStreamFactoryImpl</span>::<span class="type">Job</span>::<span class="type">Delegate</span>* <span class="title">delegate</span>,</div><div class="line">      <span class="type">HttpStreamFactoryImpl</span>::<span class="type">JobType</span> <span class="title">job_type</span>,</div><div class="line">      <span class="type">HttpNetworkSession</span>* <span class="title">session</span>,</div><div class="line">      <span class="title">const</span> <span class="type">HttpRequestInfo</span>&amp; <span class="title">request_info</span>,</div><div class="line">      <span class="type">RequestPriority</span> <span class="title">priority</span>,</div><div class="line">      <span class="title">const</span> <span class="type">SSLConfig</span>&amp; <span class="title">server_ssl_config</span>,</div><div class="line">      <span class="title">const</span> <span class="type">SSLConfig</span>&amp; <span class="title">proxy_ssl_config</span>,</div><div class="line">      <span class="type">HostPortPair</span> <span class="title">destination</span>,</div><div class="line">      <span class="type">GURL</span> <span class="title">origin_url</span>,</div><div class="line">      <span class="type">NetLog</span>* <span class="title">net_log</span>) override &#123;</div><div class="line">    return new <span class="type">HttpStreamFactoryImpl</span>::<span class="type">Job</span>(</div><div class="line">        <span class="title">delegate</span>, <span class="title">job_type</span>, <span class="title">session</span>, <span class="title">request_info</span>, <span class="title">priority</span>, <span class="title">server_ssl_config</span>,</div><div class="line">        <span class="title">proxy_ssl_config</span>, <span class="title">destination</span>, <span class="title">origin_url</span>, <span class="title">net_log</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="type">HttpStreamFactoryImpl</span>::<span class="type">Job</span>* <span class="type">CreateJob</span>(</div><div class="line">      <span class="type">HttpStreamFactoryImpl</span>::<span class="type">Job</span>::<span class="type">Delegate</span>* <span class="title">delegate</span>,</div><div class="line">      <span class="type">HttpStreamFactoryImpl</span>::<span class="type">JobType</span> <span class="title">job_type</span>,</div><div class="line">      <span class="type">HttpNetworkSession</span>* <span class="title">session</span>,</div><div class="line">      <span class="title">const</span> <span class="type">HttpRequestInfo</span>&amp; <span class="title">request_info</span>,</div><div class="line">      <span class="type">RequestPriority</span> <span class="title">priority</span>,</div><div class="line">      <span class="title">const</span> <span class="type">SSLConfig</span>&amp; <span class="title">server_ssl_config</span>,</div><div class="line">      <span class="title">const</span> <span class="type">SSLConfig</span>&amp; <span class="title">proxy_ssl_config</span>,</div><div class="line">      <span class="type">HostPortPair</span> <span class="title">destination</span>,</div><div class="line">      <span class="type">GURL</span> <span class="title">origin_url</span>,</div><div class="line">      <span class="type">AlternativeService</span> <span class="title">alternative_service</span>,</div><div class="line">      <span class="type">NetLog</span>* <span class="title">net_log</span>) override &#123;</div><div class="line">    return new <span class="type">HttpStreamFactoryImpl</span>::<span class="type">Job</span>(</div><div class="line">        <span class="title">delegate</span>, <span class="title">job_type</span>, <span class="title">session</span>, <span class="title">request_info</span>, <span class="title">priority</span>, <span class="title">server_ssl_config</span>,</div><div class="line">        <span class="title">proxy_ssl_config</span>, <span class="title">destination</span>, <span class="title">origin_url</span>, <span class="title">alternative_service</span>,</div><div class="line">        <span class="title">net_log</span>);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">&#125;  // anonymous namespace</div></pre></td></tr></table></figure></p>
<p>JobController的Start()定义 (chromium_android/src/net/http/http_stream_factory_impl_job_controller.cc) 如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">HttpStreamFactoryImpl::Request* HttpStreamFactoryImpl::JobController::Start(</div><div class="line">    <span class="keyword">const</span> HttpRequestInfo&amp; request_info,</div><div class="line">    HttpStreamRequest::Delegate* delegate,</div><div class="line">    WebSocketHandshakeStreamBase::CreateHelper*</div><div class="line">        websocket_handshake_stream_create_helper,</div><div class="line">    <span class="keyword">const</span> BoundNetLog&amp; net_log,</div><div class="line">    HttpStreamRequest::StreamType stream_type,</div><div class="line">    RequestPriority priority,</div><div class="line">    <span class="keyword">const</span> SSLConfig&amp; server_ssl_config,</div><div class="line">    <span class="keyword">const</span> SSLConfig&amp; proxy_ssl_config) &#123;</div><div class="line">  DCHECK(factory_);</div><div class="line">  DCHECK(!request_);</div><div class="line"></div><div class="line">  request_ = <span class="keyword">new</span> Request(request_info.url, this, delegate,</div><div class="line">                         websocket_handshake_stream_create_helper, net_log,</div><div class="line">                         stream_type);</div><div class="line"></div><div class="line">  CreateJobs(request_info, priority, server_ssl_config, proxy_ssl_config,</div><div class="line">             delegate, stream_type, net_log);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> request_;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这里主要是创建了一个Request，然后调用CreateJobs()创建了一些Jobs：<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">void HttpStreamFactoryImpl::JobController::CreateJobs(</div><div class="line">    <span class="keyword">const</span> HttpRequestInfo&amp; request_info,</div><div class="line">    RequestPriority priority,</div><div class="line">    <span class="keyword">const</span> SSLConfig&amp; server_ssl_config,</div><div class="line">    <span class="keyword">const</span> SSLConfig&amp; proxy_ssl_config,</div><div class="line">    HttpStreamRequest::Delegate* delegate,</div><div class="line">    HttpStreamRequest::StreamType stream_type,</div><div class="line">    <span class="keyword">const</span> BoundNetLog&amp; net_log) &#123;</div><div class="line">  DCHECK(!main_job_);</div><div class="line">  DCHECK(!alternative_job_);</div><div class="line">  HostPortPair destination(HostPortPair::FromURL(request_info.url));</div><div class="line">  GURL origin_url = ApplyHostMappingRules(request_info.url, &amp;destination);</div><div class="line"></div><div class="line">  main_job_.reset(job_factory_-&gt;CreateJob(</div><div class="line">      this, MAIN, session_, request_info, priority, server_ssl_config,</div><div class="line">      proxy_ssl_config, destination, origin_url, net_log.net_log()));</div><div class="line">  AttachJob(main_job_.get());</div><div class="line"></div><div class="line">  <span class="comment">// Create an alternative job if alternative service is set up for this domain.</span></div><div class="line">  <span class="keyword">const</span> AlternativeService alternative_service =</div><div class="line">      GetAlternativeServiceFor(request_info, delegate, stream_type);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (alternative_service.protocol != UNINITIALIZED_ALTERNATE_PROTOCOL) &#123;</div><div class="line">    <span class="comment">// Never share connection with other jobs for FTP requests.</span></div><div class="line">    DVLOG(<span class="number">1</span>) &lt;&lt; <span class="string">"Selected alternative service (host: "</span></div><div class="line">             &lt;&lt; alternative_service.host_port_pair().host()</div><div class="line">             &lt;&lt; <span class="string">" port: "</span> &lt;&lt; alternative_service.host_port_pair().port() &lt;&lt; <span class="string">")"</span>;</div><div class="line"></div><div class="line">    DCHECK(!request_info.url.SchemeIs(<span class="string">"ftp"</span>));</div><div class="line">    HostPortPair alternative_destination(alternative_service.host_port_pair());</div><div class="line">    ignore_result(</div><div class="line">        ApplyHostMappingRules(request_info.url, &amp;alternative_destination));</div><div class="line"></div><div class="line">    alternative_job_.reset(job_factory_-&gt;CreateJob(</div><div class="line">        this, ALTERNATIVE, session_, request_info, priority, server_ssl_config,</div><div class="line">        proxy_ssl_config, alternative_destination, origin_url,</div><div class="line">        alternative_service, net_log.net_log()));</div><div class="line">    AttachJob(alternative_job_.get());</div><div class="line"></div><div class="line">    main_job_is_blocked_ = <span class="literal">true</span>;</div><div class="line">    alternative_job_-&gt;Start(request_-&gt;stream_type());</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// Even if |alternative_job| has already finished, it will not have notified</span></div><div class="line">  <span class="comment">// the request yet, since we defer that to the next iteration of the</span></div><div class="line">  <span class="comment">// MessageLoop, so starting |main_job_| is always safe.</span></div><div class="line">  main_job_-&gt;Start(request_-&gt;stream_type());</div><div class="line">&#125;</div><div class="line"></div><div class="line"> ......</div><div class="line"></div><div class="line">GURL HttpStreamFactoryImpl::JobController::ApplyHostMappingRules(</div><div class="line">    <span class="keyword">const</span> GURL&amp; url,</div><div class="line">    HostPortPair* endpoint) &#123;</div><div class="line">  <span class="keyword">const</span> HostMappingRules* mapping_rules = session_-&gt;params().host_mapping_rules;</div><div class="line">  <span class="keyword">if</span> (mapping_rules &amp;&amp; mapping_rules-&gt;RewriteHost(endpoint)) &#123;</div><div class="line">    url::Replacements&lt;<span class="keyword">char</span>&gt; replacements;</div><div class="line">    <span class="keyword">const</span> std::string port_str = base::UintToString(endpoint-&gt;port());</div><div class="line">    replacements.SetPort(port_str.c_str(), url::Component(<span class="number">0</span>, port_str.size()));</div><div class="line">    replacements.SetHost(endpoint-&gt;host().c_str(),</div><div class="line">                         url::Component(<span class="number">0</span>, endpoint-&gt;host().size()));</div><div class="line">    <span class="keyword">return</span> url.ReplaceComponents(replacements);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> url;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里的过程如下：</p>
<ol>
<li>应用主机映射规则，对url做修饰。</li>
<li>通过job_factory创建main_job。</li>
<li>查找备选服务。</li>
<li>找到了备选服务，则创建alternative_job，并Start它。</li>
<li>Start main_job。</li>
</ol>
<p>我们前面提到的<strong>一些Jobs</strong>主要是指main_job，和可能会创建的alternative_job。</p>
<p>接着我们来看Job的Start()方法(chromium_android/src/net/http/http_stream_factory_impl_job.cc) ：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line">void HttpStreamFactoryImpl::Job::Start(</div><div class="line">    HttpStreamRequest::StreamType stream_type) &#123;</div><div class="line">  stream_type_ = stream_type;</div><div class="line">  StartInternal();</div><div class="line">&#125;</div><div class="line"></div><div class="line">.......</div><div class="line"></div><div class="line"><span class="keyword">int</span> HttpStreamFactoryImpl::Job::RunLoop(<span class="keyword">int</span> result) &#123;</div><div class="line">  TRACE_EVENT0(TRACE_DISABLED_BY_DEFAULT(<span class="string">"net"</span>),</div><div class="line">               <span class="string">"HttpStreamFactoryImpl::Job::RunLoop"</span>);</div><div class="line">  LOG(INFO) &lt;&lt; <span class="string">"HttpStreamFactoryImpl Job DoLoop start "</span> &lt;&lt; <span class="string">"job type "</span> &lt;&lt; job_type_;</div><div class="line">  result = DoLoop(result);</div><div class="line">  LOG(INFO) &lt;&lt; <span class="string">"HttpStreamFactoryImpl Job DoLoop end "</span> &lt;&lt; <span class="string">"result "</span> &lt;&lt; result;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (result == ERR_IO_PENDING)</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (job_type_ == PRECONNECT) &#123;</div><div class="line">    base::ThreadTaskRunnerHandle::Get()-&gt;PostTask(</div><div class="line">        FROM_HERE,</div><div class="line">        base::Bind(&amp;HttpStreamFactoryImpl::Job::OnPreconnectsComplete,</div><div class="line">                   ptr_factory_.GetWeakPtr()));</div><div class="line">    <span class="keyword">return</span> ERR_IO_PENDING;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (IsCertificateError(result)) &#123;</div><div class="line">    <span class="comment">// Retrieve SSL information from the socket.</span></div><div class="line">    GetSSLInfo();</div><div class="line"></div><div class="line">    next_state_ = STATE_WAITING_USER_ACTION;</div><div class="line">    base::ThreadTaskRunnerHandle::Get()-&gt;PostTask(</div><div class="line">        FROM_HERE,</div><div class="line">        base::Bind(&amp;HttpStreamFactoryImpl::Job::OnCertificateErrorCallback,</div><div class="line">                   ptr_factory_.GetWeakPtr(), result, ssl_info_));</div><div class="line">    <span class="keyword">return</span> ERR_IO_PENDING;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">switch</span> (result) &#123;</div><div class="line">    <span class="keyword">case</span> ERR_PROXY_AUTH_REQUESTED: &#123;</div><div class="line">      UMA_HISTOGRAM_BOOLEAN(<span class="string">"Net.ProxyAuthRequested.HasConnection"</span>,</div><div class="line">                            connection_.get() != <span class="keyword">NULL</span>);</div><div class="line">      <span class="keyword">if</span> (!connection_.get())</div><div class="line">        <span class="keyword">return</span> ERR_PROXY_AUTH_REQUESTED_WITH_NO_CONNECTION;</div><div class="line">      CHECK(connection_-&gt;socket());</div><div class="line">      CHECK(establishing_tunnel_);</div><div class="line"></div><div class="line">      next_state_ = STATE_WAITING_USER_ACTION;</div><div class="line">      ProxyClientSocket* proxy_socket =</div><div class="line">          static_cast&lt;ProxyClientSocket*&gt;(connection_-&gt;socket());</div><div class="line">      base::ThreadTaskRunnerHandle::Get()-&gt;PostTask(</div><div class="line">          FROM_HERE,</div><div class="line">          base::Bind(&amp;Job::OnNeedsProxyAuthCallback, ptr_factory_.GetWeakPtr(),</div><div class="line">                     *proxy_socket-&gt;GetConnectResponseInfo(),</div><div class="line">                     base::RetainedRef(proxy_socket-&gt;GetAuthController())));</div><div class="line">      <span class="keyword">return</span> ERR_IO_PENDING;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> ERR_SSL_CLIENT_AUTH_CERT_NEEDED:</div><div class="line">      base::ThreadTaskRunnerHandle::Get()-&gt;PostTask(</div><div class="line">          FROM_HERE,</div><div class="line">          base::Bind(</div><div class="line">              &amp;Job::OnNeedsClientAuthCallback, ptr_factory_.GetWeakPtr(),</div><div class="line">              base::RetainedRef(</div><div class="line">                  connection_-&gt;ssl_error_response_info().cert_request_info)));</div><div class="line">      <span class="keyword">return</span> ERR_IO_PENDING;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> ERR_HTTPS_PROXY_TUNNEL_RESPONSE: &#123;</div><div class="line">      DCHECK(connection_.get());</div><div class="line">      DCHECK(connection_-&gt;socket());</div><div class="line">      DCHECK(establishing_tunnel_);</div><div class="line"></div><div class="line">      ProxyClientSocket* proxy_socket =</div><div class="line">          static_cast&lt;ProxyClientSocket*&gt;(connection_-&gt;socket());</div><div class="line">      base::ThreadTaskRunnerHandle::Get()-&gt;PostTask(</div><div class="line">          FROM_HERE, base::Bind(&amp;Job::OnHttpsProxyTunnelResponseCallback,</div><div class="line">                                ptr_factory_.GetWeakPtr(),</div><div class="line">                                *proxy_socket-&gt;GetConnectResponseInfo(),</div><div class="line">                                proxy_socket-&gt;CreateConnectResponseStream()));</div><div class="line">      <span class="keyword">return</span> ERR_IO_PENDING;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> OK:</div><div class="line">      job_status_ = STATUS_SUCCEEDED;</div><div class="line">      MaybeMarkAlternativeServiceBroken();</div><div class="line">      next_state_ = STATE_DONE;</div><div class="line">      <span class="keyword">if</span> (new_spdy_session_.get()) &#123;</div><div class="line">        base::ThreadTaskRunnerHandle::Get()-&gt;PostTask(</div><div class="line">            FROM_HERE, base::Bind(&amp;Job::OnNewSpdySessionReadyCallback,</div><div class="line">                                  ptr_factory_.GetWeakPtr()));</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (delegate_-&gt;for_websockets()) &#123;</div><div class="line">        DCHECK(websocket_stream_);</div><div class="line">        base::ThreadTaskRunnerHandle::Get()-&gt;PostTask(</div><div class="line">            FROM_HERE, base::Bind(&amp;Job::OnWebSocketHandshakeStreamReadyCallback,</div><div class="line">                                  ptr_factory_.GetWeakPtr()));</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (stream_type_ == HttpStreamRequest::BIDIRECTIONAL_STREAM) &#123;</div><div class="line">        <span class="keyword">if</span> (!bidirectional_stream_impl_) &#123;</div><div class="line">          base::ThreadTaskRunnerHandle::Get()-&gt;PostTask(</div><div class="line">              FROM_HERE, base::Bind(&amp;Job::OnStreamFailedCallback,</div><div class="line">                                    ptr_factory_.GetWeakPtr(), ERR_FAILED));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          base::ThreadTaskRunnerHandle::Get()-&gt;PostTask(</div><div class="line">              FROM_HERE,</div><div class="line">              base::Bind(&amp;Job::OnBidirectionalStreamImplReadyCallback,</div><div class="line">                         ptr_factory_.GetWeakPtr()));</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        DCHECK(stream_.get());</div><div class="line">        job_stream_ready_start_time_ = base::TimeTicks::Now();</div><div class="line">        base::ThreadTaskRunnerHandle::Get()-&gt;PostTask(</div><div class="line">            FROM_HERE,</div><div class="line">            base::Bind(&amp;Job::OnStreamReadyCallback, ptr_factory_.GetWeakPtr()));</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> ERR_IO_PENDING;</div><div class="line"></div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      <span class="keyword">if</span> (job_status_ != STATUS_BROKEN) &#123;</div><div class="line">        DCHECK_EQ(STATUS_RUNNING, job_status_);</div><div class="line">        job_status_ = STATUS_FAILED;</div><div class="line">        MaybeMarkAlternativeServiceBroken();</div><div class="line">      &#125;</div><div class="line">      base::ThreadTaskRunnerHandle::Get()-&gt;PostTask(</div><div class="line">          FROM_HERE, base::Bind(&amp;Job::OnStreamFailedCallback,</div><div class="line">                                ptr_factory_.GetWeakPtr(), result));</div><div class="line">      <span class="keyword">return</span> ERR_IO_PENDING;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line"><span class="keyword">int</span> HttpStreamFactoryImpl::Job::StartInternal() &#123;</div><div class="line">  CHECK_EQ(STATE_NONE, next_state_);</div><div class="line">  next_state_ = STATE_START;</div><div class="line">  <span class="keyword">int</span> rv = RunLoop(OK);</div><div class="line">  DCHECK_EQ(ERR_IO_PENDING, rv);</div><div class="line">  <span class="keyword">return</span> rv;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>执行调用流程大体如下：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-7a5e27d49cadf278.png" alt="HttpStreamFactoryImpl_Job"></p>
<p>在<strong>HttpStreamFactoryImpl::Job::RunLoop()</strong>中，主要是调用了<strong>HttpStreamFactoryImpl::Job::DoLoop()</strong>，并针对其执行结果，调用响应的回调函数，如：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> HttpStreamFactoryImpl::Job::OnStreamFailedCallback(<span class="keyword">int</span> result) &#123;</div><div class="line">  DCHECK_NE(job_type_, PRECONNECT);</div><div class="line"></div><div class="line">  MaybeCopyConnectionAttemptsFromSocketOrHandle();</div><div class="line"></div><div class="line">  delegate_-&gt;OnStreamFailed(<span class="keyword">this</span>, result, server_ssl_config_);</div><div class="line">  <span class="comment">// |this| may be deleted after this call.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> HttpStreamFactoryImpl::Job::OnCertificateErrorCallback(</div><div class="line">    <span class="keyword">int</span> result, <span class="keyword">const</span> SSLInfo&amp; ssl_info) &#123;</div><div class="line">  DCHECK_NE(job_type_, PRECONNECT);</div><div class="line"></div><div class="line">  MaybeCopyConnectionAttemptsFromSocketOrHandle();</div><div class="line"></div><div class="line">  delegate_-&gt;OnCertificateError(<span class="keyword">this</span>, result, server_ssl_config_, ssl_info);</div><div class="line">  <span class="comment">// |this| may be deleted after this call.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从前面的<strong>HttpStreamFactoryImpl::JobController::CreateJobs()</strong>中可以看到，<strong>delegate_</strong>正是<strong>HttpStreamFactoryImpl::JobController</strong>。</p>
<p>而在<strong>HttpStreamFactoryImpl::Job::DoLoop()</strong>中，则是处理Stream建立的事情。与<strong>HttpNetworkTransaction</strong>的 <strong>Start()</strong> 执行的<strong>DoLoop()</strong>类似，<strong>HttpStreamFactoryImpl::Job::DoLoop()</strong>也是将Stream创建的过程抽象为一系列的步骤，通过一个循环，以一种类似于状态机模式的方式逐步骤执行：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> HttpStreamFactoryImpl::Job::DoLoop(<span class="keyword">int</span> result) &#123;</div><div class="line">  DCHECK_NE(next_state_, STATE_NONE);</div><div class="line">  <span class="keyword">int</span> rv = result;</div><div class="line">  do &#123;</div><div class="line">    State state = next_state_;</div><div class="line">    next_state_ = STATE_NONE;</div><div class="line">    <span class="keyword">switch</span> (state) &#123;</div><div class="line">      <span class="keyword">case</span> STATE_START:</div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoStart();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> STATE_RESOLVE_PROXY:</div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoResolveProxy();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> STATE_RESOLVE_PROXY_COMPLETE:</div><div class="line">        rv = DoResolveProxyComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> STATE_WAIT:</div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoWait();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> STATE_WAIT_COMPLETE:</div><div class="line">        rv = DoWaitComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> STATE_INIT_CONNECTION:</div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoInitConnection();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> STATE_INIT_CONNECTION_COMPLETE:</div><div class="line">        rv = DoInitConnectionComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> STATE_WAITING_USER_ACTION:</div><div class="line">        rv = DoWaitingUserAction(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> STATE_RESTART_TUNNEL_AUTH:</div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoRestartTunnelAuth();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> STATE_RESTART_TUNNEL_AUTH_COMPLETE:</div><div class="line">        rv = DoRestartTunnelAuthComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> STATE_CREATE_STREAM:</div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoCreateStream();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> STATE_CREATE_STREAM_COMPLETE:</div><div class="line">        rv = DoCreateStreamComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">default</span>:</div><div class="line">        NOTREACHED() &lt;&lt; <span class="string">"bad state"</span>;</div><div class="line">        rv = ERR_FAILED;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">while</span> (rv != ERR_IO_PENDING &amp;&amp; next_state_ != STATE_NONE);</div><div class="line">  <span class="keyword">return</span> rv;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以执行一个QUIC请求为例，创建Stream的整个执行流程大体如下：<br><img src="https://www.wolfcstech.com/images/1315506-dd573ba5d84ca413.png" alt="CreateStream"></p>
<h1 id="备选服务机制"><a href="#备选服务机制" class="headerlink" title="备选服务机制"></a>备选服务机制</h1><p>在<strong>HttpStreamFactoryImpl::JobController</strong>的<strong>CreateJobs()</strong>中我们看到，在通过job_factory创建main_job之后，会查找备选服务，在找到了备选服务时，还会为它创建job，并Start。那备选服务又是一套什么样的机制呢？</p>
<p>我们从两个方面来探究这套机制究竟是什么样的，及它又被用来做什么，一是备选服务的信息是从哪里及如何获取的，二是备选服务对<strong>HttpStreamFactoryImpl::Job::Job</strong>的操作的影响。</p>
<h2 id="获取备选服务信息"><a href="#获取备选服务信息" class="headerlink" title="获取备选服务信息"></a>获取备选服务信息</h2><p>我们先来看备选服务信息的获取。在<strong>HttpStreamFactoryImpl::JobController</strong>的<strong>CreateJobs()</strong>中，通过GetAlternativeServiceFor()来获取备选服务的信息：<br><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">AlternativeService</div><div class="line">HttpStreamFactoryImpl::JobController::GetAlternativeServiceFor(</div><div class="line">    const HttpRequestInfo&amp; request_info,</div><div class="line">    HttpStreamRequest::Delegate* <span class="keyword">delegate</span>,</div><div class="line">    HttpStreamRequest::StreamType stream_type) &#123;</div><div class="line">  AlternativeService alternative_service =</div><div class="line">      GetAlternativeServiceForInternal(request_info, <span class="keyword">delegate</span>, stream_type);</div><div class="line">  AlternativeServiceType <span class="class"><span class="keyword">type</span>;</span></div><div class="line">  <span class="keyword">if</span> (alternative_service.protocol == UNINITIALIZED_ALTERNATE_PROTOCOL) &#123;</div><div class="line">    <span class="class"><span class="keyword">type</span> </span>= NO_ALTERNATIVE_SERVICE;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (alternative_service.protocol == QUIC) &#123;</div><div class="line">    <span class="keyword">if</span> (request_info.url.host() == alternative_service.host) &#123;</div><div class="line">      <span class="class"><span class="keyword">type</span> </span>= QUIC_SAME_DESTINATION;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="class"><span class="keyword">type</span> </span>= QUIC_DIFFERENT_DESTINATION;</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">if</span> (request_info.url.host() == alternative_service.host) &#123;</div><div class="line">      <span class="class"><span class="keyword">type</span> </span>= NOT_QUIC_SAME_DESTINATION;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="class"><span class="keyword">type</span> </span>= NOT_QUIC_DIFFERENT_DESTINATION;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  UMA_HISTOGRAM_ENUMERATION(<span class="string">"Net.AlternativeServiceTypeForRequest"</span>, <span class="class"><span class="keyword">type</span>,</span></div><div class="line">                            MAX_ALTERNATIVE_SERVICE_TYPE);</div><div class="line">  <span class="keyword">return</span> alternative_service;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里主要通过GetAlternativeServiceForInternal()获取备选服务的信息：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line">AlternativeService</div><div class="line">HttpStreamFactoryImpl::JobController::GetAlternativeServiceForInternal(</div><div class="line">    <span class="keyword">const</span> HttpRequestInfo&amp; request_info,</div><div class="line">    HttpStreamRequest::Delegate* delegate,</div><div class="line">    HttpStreamRequest::StreamType stream_type) &#123;</div><div class="line">  GURL original_url = request_info.url;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!original_url.SchemeIs(<span class="string">"https"</span>))</div><div class="line">    <span class="keyword">return</span> AlternativeService();</div><div class="line"></div><div class="line">  url::SchemeHostPort origin(original_url);</div><div class="line">  HttpServerProperties&amp; http_server_properties =</div><div class="line">      *session_-&gt;http_server_properties();</div><div class="line">  <span class="keyword">const</span> AlternativeServiceVector alternative_service_vector =</div><div class="line">      http_server_properties.GetAlternativeServices(origin);</div><div class="line">  <span class="keyword">if</span> (alternative_service_vector.<span class="keyword">empty</span>())</div><div class="line">    <span class="keyword">return</span> AlternativeService();</div><div class="line"></div><div class="line">  <span class="keyword">bool</span> quic_advertised = <span class="keyword">false</span>;</div><div class="line">  <span class="keyword">bool</span> quic_all_broken = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">  <span class="comment">// First Alt-Svc that is not marked as broken.</span></div><div class="line">  AlternativeService first_alternative_service;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> AlternativeService&amp; alternative_service :</div><div class="line">       alternative_service_vector) &#123;</div><div class="line">    DCHECK(IsAlternateProtocolValid(alternative_service.protocol));</div><div class="line">    <span class="keyword">if</span> (!quic_advertised &amp;&amp; alternative_service.protocol == QUIC)</div><div class="line">      quic_advertised = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">if</span> (http_server_properties.IsAlternativeServiceBroken(</div><div class="line">            alternative_service)) &#123;</div><div class="line">      HistogramAlternateProtocolUsage(ALTERNATE_PROTOCOL_USAGE_BROKEN);</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Some shared unix systems may have user home directories (like</span></div><div class="line">    <span class="comment">// http://foo.com/~mike) which allow users to emit headers.  This is a bad</span></div><div class="line">    <span class="comment">// idea already, but with Alternate-Protocol, it provides the ability for a</span></div><div class="line">    <span class="comment">// single user on a multi-user system to hijack the alternate protocol.</span></div><div class="line">    <span class="comment">// These systems also enforce ports &lt;1024 as restricted ports.  So don't</span></div><div class="line">    <span class="comment">// allow protocol upgrades to user-controllable ports.</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> kUnrestrictedPort = <span class="number">1024</span>;</div><div class="line">    <span class="keyword">if</span> (!session_-&gt;params().enable_user_alternate_protocol_ports &amp;&amp;</div><div class="line">        (alternative_service.port &gt;= kUnrestrictedPort &amp;&amp;</div><div class="line">         origin.port() &lt; kUnrestrictedPort))</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (alternative_service.protocol &gt;= NPN_SPDY_MINIMUM_VERSION &amp;&amp;</div><div class="line">        alternative_service.protocol &lt;= NPN_SPDY_MAXIMUM_VERSION) &#123;</div><div class="line">      <span class="keyword">if</span> (origin.host() != alternative_service.host &amp;&amp;</div><div class="line">          !session_-&gt;params()</div><div class="line">               .enable_http2_alternative_service_with_different_host) &#123;</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// Cache this entry if we don't have a non-broken Alt-Svc yet.</span></div><div class="line">      <span class="keyword">if</span> (first_alternative_service.protocol ==</div><div class="line">          UNINITIALIZED_ALTERNATE_PROTOCOL)</div><div class="line">        first_alternative_service = alternative_service;</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    DCHECK_EQ(QUIC, alternative_service.protocol);</div><div class="line">    <span class="keyword">if</span> (origin.host() != alternative_service.host &amp;&amp;</div><div class="line">        !session_-&gt;params()</div><div class="line">             .enable_quic_alternative_service_with_different_host) &#123;</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    quic_all_broken = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (!session_-&gt;params().enable_quic)</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!IsQuicWhitelistedForHost(origin.host()))</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (stream_type == HttpStreamRequest::BIDIRECTIONAL_STREAM &amp;&amp;</div><div class="line">        session_-&gt;params().quic_disable_bidirectional_streams) &#123;</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (session_-&gt;quic_stream_factory()-&gt;IsQuicDisabled(</div><div class="line">            alternative_service.port))</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!original_url.SchemeIs(<span class="string">"https"</span>))</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Check whether there is an existing QUIC session to use for this origin.</span></div><div class="line">    HostPortPair mapped_origin(origin.host(), origin.port());</div><div class="line">    ignore_result(ApplyHostMappingRules(original_url, &amp;mapped_origin));</div><div class="line">    QuicServerId server_id(mapped_origin, request_info.privacy_mode);</div><div class="line"></div><div class="line">    HostPortPair destination(alternative_service.host_port_pair());</div><div class="line">    ignore_result(ApplyHostMappingRules(original_url, &amp;destination));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (session_-&gt;quic_stream_factory()-&gt;CanUseExistingSession(server_id,</div><div class="line">                                                               destination)) &#123;</div><div class="line">      <span class="keyword">return</span> alternative_service;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Cache this entry if we don't have a non-broken Alt-Svc yet.</span></div><div class="line">    <span class="keyword">if</span> (first_alternative_service.protocol == UNINITIALIZED_ALTERNATE_PROTOCOL)</div><div class="line">      first_alternative_service = alternative_service;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Ask delegate to mark QUIC as broken for the origin.</span></div><div class="line">  <span class="keyword">if</span> (quic_advertised &amp;&amp; quic_all_broken &amp;&amp; delegate != nullptr)</div><div class="line">    delegate-&gt;OnQuicBroken();</div><div class="line"></div><div class="line">  <span class="keyword">return</span> first_alternative_service;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个函数的执行流程如下：</p>
<ol>
<li>检查Url的scheme是否为https，若不是，直接返回空的AlternativeService。即备选服务只用于https。</li>
<li>从session_获取HttpServerProperties http_server_properties。</li>
<li>从http_server_properties获取所有的备选服务信息。</li>
<li>遍历上一步找到的备选服务，找到一个可用的。</li>
</ol>
<p>在Chromium net中，以https为scheme的请求有多种，一是常规的HTTP/1.1 + TLS的请求，二是SPDY/HTTP2请求，三是QUIC协议的请求。备选服务主要用于后两种协议的请求。这里会根据同源策略、端口、协议是否打开及主机是否在白名单等判断一个备选服务是否可用。</p>
<p>我们可以看到，备选服务的所有信息，都来源于http_server_properties。http_server_properties来源于HttpNetworkSession。HttpNetworkSession的http_server_properties在URLRequestContextBuilder::Build()中创建：<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">void URLRequestContextBuilder::SetHttpNetworkSessionComponents(</div><div class="line">    const URLRequestContext* context,</div><div class="line">    HttpNetworkSession::Params* params) &#123;</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">host_resolver</span> = context-&gt;</span>host_resolver();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">cert_verifier</span> = context-&gt;</span>cert_verifier();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">transport_security_state</span> = context-&gt;</span>transport_security_state();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">cert_transparency_verifier</span> = context-&gt;</span>cert_transparency_verifier();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">ct_policy_enforcer</span> = context-&gt;</span>ct_policy_enforcer();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">proxy_service</span> = context-&gt;</span>proxy_service();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">ssl_config_service</span> = context-&gt;</span>ssl_config_service();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">http_auth_handler_factory</span> = context-&gt;</span>http_auth_handler_factory();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">http_server_properties</span> = context-&gt;</span>http_server_properties();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">net_log</span> = context-&gt;</span>net_log();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">channel_id_service</span> = context-&gt;</span>channel_id_service();</div><div class="line">&#125;</div><div class="line"></div><div class="line">std::unique_ptr&lt;URLRequestContext&gt; URLRequestContextBuilder::Build() &#123;</div><div class="line">......</div><div class="line">  <span class="keyword">if</span> (http_server_properties_) &#123;</div><div class="line">    <span class="function"><span class="title">storage</span>-&gt;</span>set_http_server_properties(std::move(http_server_properties_));</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="function"><span class="title">storage</span>-&gt;</span>set_http_server_properties(</div><div class="line">        std::unique_ptr&lt;HttpServerProperties&gt;(new HttpServerPropertiesImpl()));</div><div class="line">  &#125;</div><div class="line">......</div><div class="line">  <span class="function"><span class="title">storage</span>-&gt;</span>set_http_network_session(</div><div class="line">      base::WrapUnique(new HttpNetworkSession(network_session_params)));</div></pre></td></tr></table></figure></p>
<p>Cronet库的初始化过程中，会执行CronetURLRequestContextAdapter::InitializeOnNetworkThread()，在这个方法中，通过URLRequestContextBuilder构建了URLRequestContext之后，会向其中添加备选服务的信息：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">void <span class="symbol">CronetURLRequestContextAdapter:</span><span class="symbol">:InitializeOnNetworkThread</span>(</div><div class="line">    <span class="symbol">std:</span><span class="symbol">:unique_ptr&lt;URLRequestContextConfig&gt;</span> config,</div><div class="line">    const <span class="symbol">base:</span><span class="symbol">:android</span><span class="symbol">:</span><span class="symbol">:ScopedJavaGlobalRef&lt;jobject&gt;&amp;</span></div><div class="line">        jcronet_url_request_context) &#123;</div><div class="line">......</div><div class="line">  if (config-&gt;enable_quic) &#123;</div><div class="line">    <span class="keyword">for</span> (auto hint = config-&gt;quic_hints.<span class="keyword">begin</span>();</div><div class="line">         hint != config-&gt;quic_hints.<span class="keyword">end</span>(); ++hint) &#123;</div><div class="line">      const <span class="symbol">URLRequestContextConfig:</span><span class="symbol">:QuicHint&amp;</span> quic_hint = **hint;</div><div class="line">      if (quic_hint.host.empty()) &#123;</div><div class="line">        LOG(ERROR) &lt;&lt; <span class="string">"Empty QUIC hint host: "</span> &lt;&lt; quic_hint.host;</div><div class="line">        continue;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="symbol">url:</span><span class="symbol">:CanonHostInfo</span> host_info;</div><div class="line">      <span class="symbol">std:</span><span class="symbol">:string</span> canon_host(<span class="symbol">net:</span><span class="symbol">:CanonicalizeHost</span>(quic_hint.host, &amp;host_info));</div><div class="line">      if (!host_info.IsIPAddress() &amp;&amp;</div><div class="line">          !<span class="symbol">net:</span><span class="symbol">:IsCanonicalizedHostCompliant</span>(canon_host)) &#123;</div><div class="line">        LOG(ERROR) &lt;&lt; <span class="string">"Invalid QUIC hint host: "</span> &lt;&lt; quic_hint.host;</div><div class="line">        continue;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (quic_hint.port &lt;= <span class="symbol">std:</span><span class="symbol">:numeric_limits&lt;uint16_t&gt;</span><span class="symbol">:</span><span class="symbol">:min</span>() ||</div><div class="line">          quic_hint.port &gt; <span class="symbol">std:</span><span class="symbol">:numeric_limits&lt;uint16_t&gt;</span><span class="symbol">:</span><span class="symbol">:max</span>()) &#123;</div><div class="line">        LOG(ERROR) &lt;&lt; <span class="string">"Invalid QUIC hint port: "</span></div><div class="line">                   &lt;&lt; quic_hint.port;</div><div class="line">        continue;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (quic_hint.alternate_port &lt;= <span class="symbol">std:</span><span class="symbol">:numeric_limits&lt;uint16_t&gt;</span><span class="symbol">:</span><span class="symbol">:min</span>() ||</div><div class="line">          quic_hint.alternate_port &gt; <span class="symbol">std:</span><span class="symbol">:numeric_limits&lt;uint16_t&gt;</span><span class="symbol">:</span><span class="symbol">:max</span>()) &#123;</div><div class="line">        LOG(ERROR) &lt;&lt; <span class="string">"Invalid QUIC hint alternate port: "</span></div><div class="line">                   &lt;&lt; quic_hint.alternate_port;</div><div class="line">        continue;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="symbol">url:</span><span class="symbol">:SchemeHostPort</span> quic_server(<span class="string">"https"</span>, canon_host, quic_hint.port);</div><div class="line">      <span class="symbol">net:</span><span class="symbol">:AlternativeService</span> alternative_service(</div><div class="line">          <span class="symbol">net:</span><span class="symbol">:AlternateProtocol</span><span class="symbol">:</span><span class="symbol">:QUIC</span>, <span class="string">""</span>,</div><div class="line">          static_cast&lt;uint16_t&gt;(quic_hint.alternate_port));</div><div class="line">      context<span class="number">_</span>-&gt;http_server_properties()-&gt;SetAlternativeService(</div><div class="line">          quic_server, alternative_service, <span class="symbol">base:</span><span class="symbol">:Time</span><span class="symbol">:</span><span class="symbol">:Max</span>());</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这里更是限定了只允许给QUIC协议添加备选服务。而这里添加的备选服务的信息都来自于URLRequestContextConfig。</p>
<p>继续来看给HttpServerProperties添加备选服务信息的过程 (chromium_android/src/net/http/http_server_properties_impl.cc)：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> HttpServerPropertiesImpl::SetAlternativeService(</div><div class="line">    <span class="keyword">const</span> url::SchemeHostPort&amp; origin,</div><div class="line">    <span class="keyword">const</span> AlternativeService&amp; alternative_service,</div><div class="line">    base::Time expiration) &#123;</div><div class="line">  <span class="keyword">return</span> SetAlternativeServices(</div><div class="line">      origin,</div><div class="line">      AlternativeServiceInfoVector(</div><div class="line">          <span class="comment">/*size=*/</span><span class="number">1</span>, AlternativeServiceInfo(alternative_service, expiration)));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">bool</span> HttpServerPropertiesImpl::SetAlternativeServices(</div><div class="line">    <span class="keyword">const</span> url::SchemeHostPort&amp; origin,</div><div class="line">    <span class="keyword">const</span> AlternativeServiceInfoVector&amp; alternative_service_info_vector) &#123;</div><div class="line">  AlternativeServiceMap::iterator it = alternative_service_map_.Peek(origin);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (alternative_service_info_vector.<span class="keyword">empty</span>()) &#123;</div><div class="line">    RemoveCanonicalHost(origin);</div><div class="line">    <span class="keyword">if</span> (it == alternative_service_map_.end())</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    alternative_service_map_.Erase(it);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">bool</span> changed = <span class="keyword">true</span>;</div><div class="line">  <span class="keyword">if</span> (it != alternative_service_map_.end()) &#123;</div><div class="line">    DCHECK(!it-&gt;second.<span class="keyword">empty</span>());</div><div class="line">    <span class="keyword">if</span> (it-&gt;second.size() == alternative_service_info_vector.size()) &#123;</div><div class="line">      <span class="keyword">const</span> base::Time now = base::Time::Now();</div><div class="line">      changed = <span class="keyword">false</span>;</div><div class="line">      auto new_it = alternative_service_info_vector.begin();</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> auto&amp; old : it-&gt;second) &#123;</div><div class="line">        <span class="comment">// Persist to disk immediately if new entry has different scheme, host,</span></div><div class="line">        <span class="comment">// or port.</span></div><div class="line">        <span class="keyword">if</span> (old.alternative_service != new_it-&gt;alternative_service) &#123;</div><div class="line">          changed = <span class="keyword">true</span>;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Also persist to disk if new expiration it more that twice as far or</span></div><div class="line">        <span class="comment">// less than half as far in the future.</span></div><div class="line">        base::Time old_time = old.expiration;</div><div class="line">        base::Time new_time = new_it-&gt;expiration;</div><div class="line">        <span class="keyword">if</span> (new_time - now &gt; <span class="number">2</span> * (old_time - now) ||</div><div class="line">            <span class="number">2</span> * (new_time - now) &lt; (old_time - now)) &#123;</div><div class="line">          changed = <span class="keyword">true</span>;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        ++new_it;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> previously_no_alternative_services =</div><div class="line">      (GetAlternateProtocolIterator(origin) == alternative_service_map_.end());</div><div class="line"></div><div class="line">  alternative_service_map_.Put(origin, alternative_service_info_vector);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (previously_no_alternative_services &amp;&amp;</div><div class="line">      !GetAlternativeServices(origin).<span class="keyword">empty</span>()) &#123;</div><div class="line">    <span class="comment">// TODO(rch): Consider the case where multiple requests are started</span></div><div class="line">    <span class="comment">// before the first completes. In this case, only one of the jobs</span></div><div class="line">    <span class="comment">// would reach this code, whereas all of them should should have.</span></div><div class="line">    HistogramAlternateProtocolUsage(ALTERNATE_PROTOCOL_USAGE_MAPPING_MISSING);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// If this host ends with a canonical suffix, then set it as the</span></div><div class="line">  <span class="comment">// canonical host.</span></div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* kCanonicalScheme = <span class="string">"https"</span>;</div><div class="line">  <span class="keyword">if</span> (origin.scheme() == kCanonicalScheme) &#123;</div><div class="line">    <span class="keyword">const</span> std::string* canonical_suffix = GetCanonicalSuffix(origin.host());</div><div class="line">    <span class="keyword">if</span> (canonical_suffix != nullptr) &#123;</div><div class="line">      url::SchemeHostPort canonical_server(kCanonicalScheme, *canonical_suffix,</div><div class="line">                                           origin.port());</div><div class="line">      canonical_host_to_origin_map_[canonical_server] = origin;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> changed;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>HttpServerPropertiesImpl用一个Map来管理备选服务的信息，key为原始服务的scheme+host+port，用url::SchemeHostPort来表示，而value则为AlternativeServiceInfoVector，即备选服务信息的列表。</p>
<h3 id="用户添加备选服务信息"><a href="#用户添加备选服务信息" class="headerlink" title="用户添加备选服务信息"></a>用户添加备选服务信息</h3><p>在CronetEngine.Builder中 (chromium_android/src/components/cronet/android/api/src/org/chromium/net/CronetEngine.java)，提供了接口，来添加QUIC服务器的一些信息：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CronetEngine</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A builder for &#123;<span class="doctag">@link</span> CronetEngine&#125;s, which allows runtime configuration of</div><div class="line">     * &#123;<span class="doctag">@code</span> CronetEngine&#125;. Configuration options are set on the builder and</div><div class="line">     * then &#123;<span class="doctag">@link</span> #build&#125; is called to create the &#123;<span class="doctag">@code</span> CronetEngine&#125;.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * A hint that a host supports QUIC.</div><div class="line">         * <span class="doctag">@hide</span> only used by internal implementation.</div><div class="line">         */</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">QuicHint</span> </span>&#123;</div><div class="line">            <span class="comment">// The host.</span></div><div class="line">            <span class="keyword">public</span> <span class="keyword">final</span> String mHost;</div><div class="line">            <span class="comment">// Port of the server that supports QUIC.</span></div><div class="line">            <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> mPort;</div><div class="line">            <span class="comment">// Alternate protocol port.</span></div><div class="line">            <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> mAlternatePort;</div><div class="line"></div><div class="line">            QuicHint(String host, <span class="keyword">int</span> port, <span class="keyword">int</span> alternatePort) &#123;</div><div class="line">                mHost = host;</div><div class="line">                mPort = port;</div><div class="line">                mAlternatePort = alternatePort;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Adds hint that &#123;<span class="doctag">@code</span> host&#125; supports QUIC.</div><div class="line">         * Note that &#123;<span class="doctag">@link</span> #enableHttpCache enableHttpCache&#125;</div><div class="line">         * (&#123;<span class="doctag">@link</span> #HTTP_CACHE_DISK&#125;) is needed to take advantage of 0-RTT</div><div class="line">         * connection establishment between sessions.</div><div class="line">         *</div><div class="line">         * <span class="doctag">@param</span> host hostname of the server that supports QUIC.</div><div class="line">         * <span class="doctag">@param</span> port host of the server that supports QUIC.</div><div class="line">         * <span class="doctag">@param</span> alternatePort alternate port to use for QUIC.</div><div class="line">         * <span class="doctag">@return</span> the builder to facilitate chaining.</div><div class="line">         */</div><div class="line">        <span class="keyword">public</span> Builder addQuicHint(String host, <span class="keyword">int</span> port, <span class="keyword">int</span> alternatePort) &#123;</div><div class="line">            <span class="keyword">if</span> (host.contains(<span class="string">"/"</span>)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal QUIC Hint Host: "</span> + host);</div><div class="line">            &#125;</div><div class="line">            mQuicHints.add(<span class="keyword">new</span> QuicHint(host, port, alternatePort));</div><div class="line">            <span class="keyword">return</span> this;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * <span class="doctag">@hide</span> only used by internal implementation.</div><div class="line">         */</div><div class="line">        <span class="keyword">public</span> <span class="keyword">List</span>&lt;QuicHint&gt; quicHints() &#123;</div><div class="line">            <span class="keyword">return</span> mQuicHints;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>在CronetUrlRequestContext创建中，创建native UrlRequestContextConfig时会将所有的QUIC hint信息传递给native层。<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">@VisibleForTesting</div><div class="line">public static long createNativeUrlRequestContextConfig(</div><div class="line">        final <span class="built_in">Context</span> <span class="built_in">context</span>, CronetEngine.<span class="keyword">Builder </span><span class="keyword">builder) </span>&#123;</div><div class="line">    final long urlRequestContextConfig = nativeCreateRequestContextConfig(</div><div class="line">            <span class="keyword">builder.getUserAgent(), </span><span class="keyword">builder.storagePath(), </span><span class="keyword">builder.quicEnabled(),</span></div><div class="line">            <span class="keyword">builder.getDefaultQuicUserAgentId(context), </span><span class="keyword">builder.http2Enabled(),</span></div><div class="line">            <span class="keyword">builder.sdchEnabled(), </span><span class="keyword">builder.dataReductionProxyKey(),</span></div><div class="line">            <span class="keyword">builder.dataReductionProxyPrimaryProxy(), </span><span class="keyword">builder.dataReductionProxyFallbackProxy(),</span></div><div class="line">            <span class="keyword">builder.dataReductionProxySecureProxyCheckUrl(), </span><span class="keyword">builder.cacheDisabled(),</span></div><div class="line">            <span class="keyword">builder.httpCacheMode(), </span><span class="keyword">builder.httpCacheMaxSize(), </span><span class="keyword">builder.experimentalOptions(),</span></div><div class="line">            <span class="keyword">builder.mockCertVerifier(), </span><span class="keyword">builder.networkQualityEstimatorEnabled(),</span></div><div class="line">            <span class="keyword">builder.publicKeyPinningBypassForLocalTrustAnchorsEnabled(),</span></div><div class="line">            <span class="keyword">builder.certVerifierData());</span></div><div class="line">    for (<span class="keyword">Builder.QuicHint </span>quicHint : <span class="keyword">builder.quicHints()) </span>&#123;</div><div class="line">        nativeAddQuicHint(urlRequestContextConfig, quicHint.mHost, quicHint.mPort,</div><div class="line">                quicHint.mAlternatePort)<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line">    for (<span class="keyword">Builder.Pkp </span>pkp : <span class="keyword">builder.publicKeyPins()) </span>&#123;</div><div class="line">        nativeAddPkp(urlRequestContextConfig, pkp.mHost, pkp.mHashes, pkp.mIncludeSubdomains,</div><div class="line">                pkp.mExpirationDate.getTime())<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line">    return urlRequestContextConfig<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>nativeAddQuicHint()在chromium_android/src/components/cronet/android/cronet_url_request_context_adapter.cc中定义：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Add a QUIC hint to a URLRequestContextConfig.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> AddQuicHint(JNIEnv* env,</div><div class="line">                        <span class="keyword">const</span> JavaParamRef&lt;jclass&gt;&amp; jcaller,</div><div class="line">                        jlong jurl_request_context_config,</div><div class="line">                        <span class="keyword">const</span> JavaParamRef&lt;jstring&gt;&amp; jhost,</div><div class="line">                        jint jport,</div><div class="line">                        jint jalternate_port) &#123;</div><div class="line">  URLRequestContextConfig* <span class="built_in">config</span> =</div><div class="line">      <span class="keyword">reinterpret_cast</span>&lt;URLRequestContextConfig*&gt;(jurl_request_context_config);</div><div class="line">  <span class="built_in">config</span>-&gt;quic_hints.push_back(</div><div class="line">      base::WrapUnique(<span class="keyword">new</span> URLRequestContextConfig::QuicHint(</div><div class="line">          base::android::ConvertJavaStringToUTF8(env, jhost), jport,</div><div class="line">          jalternate_port)));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="备选服务对HttpStreamFactoryImpl-Job-Job的操作的影响"><a href="#备选服务对HttpStreamFactoryImpl-Job-Job的操作的影响" class="headerlink" title="备选服务对HttpStreamFactoryImpl::Job::Job的操作的影响"></a>备选服务对<strong>HttpStreamFactoryImpl::Job::Job</strong>的操作的影响</h2><p>为备选服务和为常规服务会以略有不同的方式创建Job：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">HttpStreamFactoryImpl::Job::Job(Delegate* delegate,</div><div class="line">                                JobType job_type,</div><div class="line">                                HttpNetworkSession* session,</div><div class="line">                                <span class="keyword">const</span> HttpRequestInfo&amp; request_info,</div><div class="line">                                RequestPriority priority,</div><div class="line">                                <span class="keyword">const</span> SSLConfig&amp; server_ssl_config,</div><div class="line">                                <span class="keyword">const</span> SSLConfig&amp; proxy_ssl_config,</div><div class="line">                                HostPortPair destination,</div><div class="line">                                GURL origin_url,</div><div class="line">                                NetLog* net_log)</div><div class="line">    : Job(delegate,</div><div class="line">          job_type,</div><div class="line">          session,</div><div class="line">          request_info,</div><div class="line">          priority,</div><div class="line">          server_ssl_config,</div><div class="line">          proxy_ssl_config,</div><div class="line">          destination,</div><div class="line">          origin_url,</div><div class="line">          AlternativeService(),</div><div class="line">          net_log) &#123;&#125;</div><div class="line"></div><div class="line">HttpStreamFactoryImpl::Job::Job(Delegate* delegate,</div><div class="line">                                JobType job_type,</div><div class="line">                                HttpNetworkSession* session,</div><div class="line">                                <span class="keyword">const</span> HttpRequestInfo&amp; request_info,</div><div class="line">                                RequestPriority priority,</div><div class="line">                                <span class="keyword">const</span> SSLConfig&amp; server_ssl_config,</div><div class="line">                                <span class="keyword">const</span> SSLConfig&amp; proxy_ssl_config,</div><div class="line">                                HostPortPair destination,</div><div class="line">                                GURL origin_url,</div><div class="line">                                AlternativeService alternative_service,</div><div class="line">                                NetLog* net_log)</div><div class="line">    : request_info_(request_info),</div><div class="line">      priority_(priority),</div><div class="line">      server_ssl_config_(server_ssl_config),</div><div class="line">      proxy_ssl_config_(proxy_ssl_config),</div><div class="line">      net_log_(BoundNetLog::Make(net_log, NetLog::SOURCE_HTTP_STREAM_JOB)),</div><div class="line">      io_callback_(base::Bind(&amp;Job::OnIOComplete, base::Unretained(<span class="keyword">this</span>))),</div><div class="line">      connection_(<span class="keyword">new</span> ClientSocketHandle),</div><div class="line">      session_(session),</div><div class="line">      next_state_(STATE_NONE),</div><div class="line">      pac_request_(NULL),</div><div class="line">      destination_(destination),</div><div class="line">      origin_url_(origin_url),</div><div class="line">      alternative_service_(alternative_service),</div><div class="line">      delegate_(delegate),</div><div class="line">      job_type_(job_type),</div><div class="line">      using_ssl_(<span class="keyword">false</span>),</div><div class="line">      using_spdy_(<span class="keyword">false</span>),</div><div class="line">      using_quic_(<span class="keyword">false</span>),</div><div class="line">      quic_request_(session_-&gt;quic_stream_factory()),</div><div class="line">      using_existing_quic_session_(<span class="keyword">false</span>),</div><div class="line">      spdy_certificate_error_(OK),</div><div class="line">      establishing_tunnel_(<span class="keyword">false</span>),</div><div class="line">      was_npn_negotiated_(<span class="keyword">false</span>),</div><div class="line">      protocol_negotiated_(kProtoUnknown),</div><div class="line">      num_streams_(0),</div><div class="line">      spdy_session_direct_(<span class="keyword">false</span>),</div><div class="line">      job_status_(STATUS_RUNNING),</div><div class="line">      other_job_status_(STATUS_RUNNING),</div><div class="line">      stream_type_(HttpStreamRequest::BIDIRECTIONAL_STREAM),</div><div class="line">      ptr_factory_(<span class="keyword">this</span>) &#123;</div><div class="line">  DCHECK(session);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (IsSpdyAlternative()) &#123;</div><div class="line">    DCHECK(origin_url_.SchemeIs(<span class="string">"https"</span>));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (IsQuicAlternative()) &#123;</div><div class="line">    DCHECK(session_-&gt;params().enable_quic);</div><div class="line">    using_quic_ = <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">bool HttpStreamFactoryImpl::Job::IsQuicAlternative() <span class="keyword">const</span> &#123;</div><div class="line">  <span class="keyword">return</span> alternative_service_.protocol == QUIC;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为QUIC备选服务创建的Job，在创建时期，就会将using<em>quic</em>置为true。这个标记的设置将对后续创建Stream的过程产生决定性的影响。</p>
<p>总结一下，备选服务机制像是一种过渡方案，用于在协议开发早期，还没有确定协议协商机制的情况下。在chromium net中，scheme为https的请求所用的协议有可能是HTTP/1.1+TLS、HTTP2和QUIC这三种的任一种，其中前两种都是基于TCP的，而QUIC是基于UDP的。当前前面的两种协议已经有了NPN和ALPN这样的协议协商的机制，而传给chromium net一个scheme为https的QUIC请求的URL，它也是不知道要用QUIC协议来做请求的。而备选服务机制，则允许chromium net的用户指定，对某些主机的访问采用特定的协议进行。此外，在<strong>HttpStreamFactoryImpl::JobController</strong>的CreateJobs()中，在为备选服务创建Job之外，还是会创建main_job，即是说，传给chromium net一个以https为scheme的Url，它一定会尝试用TCP的方式建立连接的，只是对于请求QUIC协议的服务，这个连接将会失败，而真正取回数据的将是alternative_job。</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wxpay.png" alt="Han Pengfei WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Han Pengfei Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/网络协议/" rel="tag"># 网络协议</a>
          
            <a href="/tags/Android开发/" rel="tag"># Android开发</a>
          
            <a href="/tags/源码分析/" rel="tag"># 源码分析</a>
          
            <a href="/tags/chromium/" rel="tag"># chromium</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/10/29/Cronet_android设计与实现分析__HTTP请求启动/" rel="next" title="Cronet android设计与实现分析--HTTP请求启动">
                <i class="fa fa-chevron-left"></i> Cronet android设计与实现分析--HTTP请求启动
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/11/02/在Android中使用FlatBuffers - 简介/" rel="prev" title="在Android中使用FlatBuffers - 简介">
                在Android中使用FlatBuffers - 简介 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/freesoft.jpg"
                alt="Han Pengfei" />
            
              <p class="site-author-name" itemprop="name">Han Pengfei</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">163</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/hanpfei" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.douban.com/people/3681478/" target="_blank" title="豆瓣"><i class="fa fa-fw fa-globe"></i>豆瓣</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/han-peng-fei-49" target="_blank" title="知乎"><i class="fa fa-fw fa-globe"></i>知乎</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:hanpfei@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.trinea.cn/" title="Trinea" target="_blank">Trinea</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Stream的创建"><span class="nav-number">1.</span> <span class="nav-text">Stream的创建</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#备选服务机制"><span class="nav-number">2.</span> <span class="nav-text">备选服务机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#获取备选服务信息"><span class="nav-number">2.1.</span> <span class="nav-text">获取备选服务信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#用户添加备选服务信息"><span class="nav-number">2.1.1.</span> <span class="nav-text">用户添加备选服务信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#备选服务对HttpStreamFactoryImpl-Job-Job的操作的影响"><span class="nav-number">2.2.</span> <span class="nav-text">备选服务对HttpStreamFactoryImpl::Job::Job的操作的影响</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016.09.16 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Han Pengfei</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.3"></script>



  



	





  





  






<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname,
            owner: 'hanpfei',
            repo: 'blog_comment',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '2e5e06c86dfee4177d58dd4660d1ed4bce4f155d',
            
                client_id: '0ec580f0a999fbe77a63'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("KUAjB88PxNQR5DOgg6jhgdp7-gzGzoHsz", "3c3yzt2EN31aXwYgVdmzDUUk");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

</body>
</html>
