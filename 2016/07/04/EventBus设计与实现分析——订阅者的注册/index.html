<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>EventBus设计与实现分析——订阅者的注册 | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">EventBus设计与实现分析——订阅者的注册</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">EventBus设计与实现分析——订阅者的注册</h1><div class="post-meta">Jul 4, 2016<span> | </span><span class="category"><a href="/categories/Android开发/">Android开发</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/07/04/EventBus设计与实现分析——订阅者的注册/" href="/2016/07/04/EventBus设计与实现分析——订阅者的注册/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>前面在 <a href="https://www.wolfcstech.com/2016/07/03/EventBus%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90%E2%80%94%E2%80%94%E7%89%B9%E6%80%A7%E4%BB%8B%E7%BB%8D/">EventBus设计与实现分析——特性介绍</a> 一文中介绍了EventBus的基本用法，及其提供的大多数特性的用法，这让我们对EventBus为用户提供的主要功能有了大体的了解，为我们后续理解EventBus的设计决策提供了良好的基础。这里我们就开始深入到EventBus的实现细节，先来了解其中的订阅者注册的过程。</p>
<a id="more"></a>
<h1 id="订阅者的注册"><a href="#订阅者的注册" class="headerlink" title="订阅者的注册"></a>订阅者的注册</h1><p>EventBus使用了一种类似于闭包的机制来描述订阅者。即对于EventBus而言，一个订阅者由<code>一个方法</code>＋<code>该方法绑定的上下文（也就是该方法绑定的对象</code>）＋<code>订阅者感兴趣的事件的类型</code>来描述。具体到实现，即是通过<code>SubscriberMethod</code>＋<code>SubscriberMethod</code>这样几个类来描述。</p>
<p>我们可以看一下这几个类的定义，首先是<code>Subscription</code>类：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">package <span class="keyword">org.greenrobot.eventbus;</span></div><div class="line"></div><div class="line">final class <span class="keyword">Subscription </span>&#123;</div><div class="line">    final Object <span class="keyword">subscriber;</span></div><div class="line">    final <span class="keyword">SubscriberMethod </span><span class="keyword">subscriberMethod;</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Becomes false as soon as &#123;@link EventBus#unregister(Object)&#125; is called, which is checked by queued event delivery</div><div class="line">     * &#123;@link EventBus#invokeSubscriber(PendingPost)&#125; to prevent race conditions.</div><div class="line">     */</div><div class="line">    volatile <span class="keyword">boolean </span>active<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">Subscription(Object </span><span class="keyword">subscriber, </span><span class="keyword">SubscriberMethod </span><span class="keyword">subscriberMethod) </span>&#123;</div><div class="line">        this.<span class="keyword">subscriber </span>= <span class="keyword">subscriber;</span></div><div class="line">        this.<span class="keyword">subscriberMethod </span>= <span class="keyword">subscriberMethod;</span></div><div class="line">        active = true<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public <span class="keyword">boolean </span>equals(Object other) &#123;</div><div class="line">        if (other <span class="keyword">instanceof </span><span class="keyword">Subscription) </span>&#123;</div><div class="line">            <span class="keyword">Subscription </span>otherSubscription = (<span class="keyword">Subscription) </span>other<span class="comment">;</span></div><div class="line">            return <span class="keyword">subscriber </span>== otherSubscription.<span class="keyword">subscriber</span></div><div class="line">                    &amp;&amp; <span class="keyword">subscriberMethod.equals(otherSubscription.subscriberMethod);</span></div><div class="line">        &#125; else &#123;</div><div class="line">            return false<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public int hashCode() &#123;</div><div class="line">        return <span class="keyword">subscriber.hashCode() </span>+ <span class="keyword">subscriberMethod.methodString.hashCode();</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>subscriberMethod</code>即是我们前面提到的方法，而<code>subscriber</code>则是上下文object。</p>
<p>然后是<code>SubscriberMethod</code>类：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.greenrobot.eventbus;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"></div><div class="line"><span class="comment">/** Used internally by EventBus and generated subscriber indexes. */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> SubscriberMethod &#123;</div><div class="line">    <span class="keyword">final</span> Method method;</div><div class="line">    <span class="keyword">final</span> ThreadMode threadMode;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">Class</span>&lt;?&gt; eventType;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> priority;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> sticky;</div><div class="line">    <span class="comment">/** Used for efficient comparison */</span></div><div class="line">    String methodString;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> SubscriberMethod(Method method, <span class="keyword">Class</span>&lt;?&gt; eventType, ThreadMode threadMode, <span class="keyword">int</span> priority, <span class="keyword">boolean</span> sticky) &#123;</div><div class="line">        <span class="keyword">this</span>.method = method;</div><div class="line">        <span class="keyword">this</span>.threadMode = threadMode;</div><div class="line">        <span class="keyword">this</span>.eventType = eventType;</div><div class="line">        <span class="keyword">this</span>.priority = priority;</div><div class="line">        <span class="keyword">this</span>.sticky = sticky;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> equals(Object other) &#123;</div><div class="line">        <span class="keyword">if</span> (other == <span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (other <span class="keyword">instanceof</span> SubscriberMethod) &#123;</div><div class="line">            checkMethodString();</div><div class="line">            SubscriberMethod otherSubscriberMethod = (SubscriberMethod)other;</div><div class="line">            otherSubscriberMethod.checkMethodString();</div><div class="line">            <span class="comment">// Don't use method.equals because of http://code.google.com/p/android/issues/detail?id=7811#c6</span></div><div class="line">            <span class="keyword">return</span> methodString.equals(otherSubscriberMethod.methodString);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> checkMethodString() &#123;</div><div class="line">        <span class="keyword">if</span> (methodString == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Method.toString has more overhead, just take relevant parts of the method</span></div><div class="line">            StringBuilder builder = <span class="keyword">new</span> StringBuilder(<span class="number">64</span>);</div><div class="line">            builder.<span class="keyword">append</span>(method.getDeclaringClass().getName());</div><div class="line">            builder.<span class="keyword">append</span>(<span class="string">'#'</span>).<span class="keyword">append</span>(method.getName());</div><div class="line">            builder.<span class="keyword">append</span>(<span class="string">'('</span>).<span class="keyword">append</span>(eventType.getName());</div><div class="line">            methodString = builder.toString();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> hashCode() &#123;</div><div class="line">        <span class="keyword">return</span> method.hashCode();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>订阅者的注册过程，即是构造<code>SubscriberMethod</code>，继而构造<code>Subscription</code>，并对这些对象进行存储管理的过程。我们可以通过<code>EventBus.register()</code>方法的定义具体看一下在EventBus中是怎么做：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Registers the given subscriber to receive events. Subscribers must call &#123;@link #unregister(Object)&#125; once they</div><div class="line"> * are no longer interested in receiving events.</div><div class="line"> * &lt;p/&gt;</div><div class="line"> * Subscribers have event handling methods that must be annotated by &#123;@link Subscribe&#125;.</div><div class="line"> * The &#123;@link Subscribe&#125; annotation also allows configuration like &#123;@link</div><div class="line"> * ThreadMode&#125; and priority.</div><div class="line"> */</div><div class="line"><span class="symbol">public</span> void register(Object <span class="keyword">subscriber) </span>&#123;</div><div class="line">    Class&lt;?&gt; <span class="keyword">subscriberClass </span>= <span class="keyword">subscriber.getClass();</span></div><div class="line">    List&lt;<span class="keyword">SubscriberMethod&gt; </span><span class="keyword">subscriberMethods </span>= <span class="keyword">subscriberMethodFinder.findSubscriberMethods(subscriberClass);</span></div><div class="line">    synchronized (this) &#123;</div><div class="line">        for (<span class="keyword">SubscriberMethod </span><span class="keyword">subscriberMethod </span>: <span class="keyword">subscriberMethods) </span>&#123;</div><div class="line">            <span class="keyword">subscribe(subscriber, </span><span class="keyword">subscriberMethod);</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// Must <span class="keyword">be </span>called in synchronized <span class="keyword">block</span></div><div class="line"><span class="symbol">private</span> void <span class="keyword">subscribe(Object </span><span class="keyword">subscriber, </span><span class="keyword">SubscriberMethod </span><span class="keyword">subscriberMethod) </span>&#123;</div><div class="line">    Class&lt;?&gt; eventType = <span class="keyword">subscriberMethod.eventType;</span></div><div class="line">    <span class="keyword">Subscription </span>newSubscription = new <span class="keyword">Subscription(subscriber, </span><span class="keyword">subscriberMethod);</span></div><div class="line">    CopyOnWriteArrayList&lt;<span class="keyword">Subscription&gt; </span><span class="keyword">subscriptions </span>= <span class="keyword">subscriptionsByEventType.get(eventType);</span></div><div class="line">    <span class="meta">if</span> (<span class="keyword">subscriptions </span>== null) &#123;</div><div class="line">        <span class="keyword">subscriptions </span>= new CopyOnWriteArrayList&lt;&gt;()<span class="comment">;</span></div><div class="line">        <span class="keyword">subscriptionsByEventType.put(eventType, </span><span class="keyword">subscriptions);</span></div><div class="line">    &#125; <span class="meta">else</span> &#123;</div><div class="line">        <span class="meta">if</span> (<span class="keyword">subscriptions.contains(newSubscription)) </span>&#123;</div><div class="line">            throw new EventBusException(<span class="string">"Subscriber "</span> + <span class="keyword">subscriber.getClass() </span>+ <span class="string">" already registered to event "</span></div><div class="line">                    + eventType)<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    int size = <span class="keyword">subscriptions.size();</span></div><div class="line">    for (int i = <span class="number">0</span><span class="comment">; i &lt;= size; i++) &#123;</span></div><div class="line">        <span class="meta">if</span> (i == size <span class="title">||</span> <span class="keyword">subscriberMethod.priority </span>&gt; <span class="keyword">subscriptions.get(i).subscriberMethod.priority) </span>&#123;</div><div class="line">            <span class="keyword">subscriptions.add(i, </span>newSubscription)<span class="comment">;</span></div><div class="line">            <span class="keyword">break;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    List&lt;Class&lt;?&gt;&gt; <span class="keyword">subscribedEvents </span>= typesBySubscriber.get(<span class="keyword">subscriber);</span></div><div class="line">    <span class="meta">if</span> (<span class="keyword">subscribedEvents </span>== null) &#123;</div><div class="line">        <span class="keyword">subscribedEvents </span>= new ArrayList&lt;&gt;()<span class="comment">;</span></div><div class="line">        typesBySubscriber.put(<span class="keyword">subscriber, </span><span class="keyword">subscribedEvents);</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">subscribedEvents.add(eventType);</span></div><div class="line"></div><div class="line">    <span class="meta">if</span> (<span class="keyword">subscriberMethod.sticky) </span>&#123;</div><div class="line">        <span class="meta">if</span> (eventInheritance) &#123;</div><div class="line">            // Existing sticky events of all <span class="keyword">subclasses </span>of eventType have to <span class="keyword">be </span>considered.</div><div class="line">            // Note: <span class="keyword">Iterating </span>over all events may <span class="keyword">be </span>inefficient with lots of sticky events,</div><div class="line">            // thus <span class="meta">data</span> <span class="keyword">structure </span>should <span class="keyword">be </span>changed to allow a more efficient lookup</div><div class="line">            // (e.g. an <span class="keyword">additional </span><span class="meta">map</span> storing <span class="keyword">sub </span>classes of super classes: Class -&gt; List&lt;Class&gt;).</div><div class="line">            Set&lt;<span class="meta">Map</span>.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet()<span class="comment">;</span></div><div class="line">            for (<span class="meta">Map</span>.Entry&lt;Class&lt;?&gt;, Object&gt; <span class="meta">entry</span> : entries) &#123;</div><div class="line">                Class&lt;?&gt; candidateEventType = <span class="meta">entry</span>.getKey()<span class="comment">;</span></div><div class="line">                <span class="meta">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</div><div class="line">                    Object stickyEvent = <span class="meta">entry</span>.getValue()<span class="comment">;</span></div><div class="line">                    checkPostStickyEventToSubscription(newSubscription, stickyEvent)<span class="comment">;</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="meta">else</span> &#123;</div><div class="line">            Object stickyEvent = stickyEvents.get(eventType)<span class="comment">;</span></div><div class="line">            checkPostStickyEventToSubscription(newSubscription, stickyEvent)<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过<code>EventBus.register()</code>和<code>EventBus.subscribe()</code>可以看到，register的过程主要做了这样一些事情：</p>
<ol>
<li>查找订阅者对象的所有订阅者方法。方法隶属于类，不以对象的改变而改变，应用程序的一次生命周期中，这些方法总是不变的。</li>
<li>构造<code>Subscription</code>来描述每一个订阅者，也就是<code>订阅者对象</code>＋<code>一个订阅者方法</code>。</li>
<li>建立事件类型与订阅者之间的映射关系，这主要通过<code>subscriptionsByEventType</code>数据结构来描述。对于每一个事件类型，其订阅者会依优先级而排序。不难看出，这个结构主要用于事件的发布，在事件发布时，可以通过这个结构快速地找到每一个订阅者。<br>这个地方查找正确的插入位置是用的顺序查找的方法，估计是考虑到对于一个事件类型，订阅者一般不会太多，而订阅者的优先级一般不会很分散的缘故。</li>
<li>建立订阅者对象与该对象监听的事件类型之间的映射关系，这主要由<code>typesBySubscriber</code>数据结构来描述。这个结构则主要用于注销一个对象对事件的监听。注销一个对象对事件得监听时，可以通过这个结构快速地将监听者对象得信息从EventBus中整个的移除出去。</li>
<li>处理对Sticky事件的监听。如我们前面所见，这种类型的事件在发布时会通知到每个监听者，同时还会被保存起来，当后面再次注册对这种事件的监听时，监听者会直接得到通知。</li>
</ol>
<p><code>EventBus</code>使用<code>SubscriberMethodFinder</code>来查找一个类中所有的监听者方法，主要即是<code>findSubscriberMethods()</code>方法。</p>
<p>如我们前面所见，要使一个类的某个方法成为监听者方法，需要给该方法添加<strong>Subscribe</strong> annotation，在<code>SubscriberMethodFinder.findSubscriberMethods()</code>中会查找加了这个annotation的方法。但老版本的EventBus并不是通过annotation来标识一个监听者方法的，而是通过命名模式等方法，因而这里可以看到一种更为灵活的设计，来给用户提供空间，以支持不同的标识监听者方法的方法：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> SubscriberMethodFinder &#123;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * In newer class files, compilers may add methods. Those are called bridge or synthetic methods.</div><div class="line">     * EventBus must ignore both. There modifiers are not public but defined in the Java class file format:</div><div class="line">     * http://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html#jvms-4.6-200-A.1</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BRIDGE = <span class="number">0</span>x40;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SYNTHETIC = <span class="number">0</span>x1000;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODIFIERS_IGNORE = Modifier.<span class="keyword">ABSTRACT</span> | Modifier.<span class="keyword">STATIC</span> | BRIDGE | SYNTHETIC;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;<span class="keyword">Class</span>&lt;?&gt;, List&lt;SubscriberMethod&gt;&gt; METHOD_CACHE = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;SubscriberInfoIndex&gt; subscriberInfoIndexes;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> strictMethodVerification;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> ignoreGeneratedIndex;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> POOL_SIZE = <span class="number">4</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> FindState[] FIND_STATE_POOL = <span class="keyword">new</span> FindState[POOL_SIZE];</div><div class="line"></div><div class="line">    SubscriberMethodFinder(List&lt;SubscriberInfoIndex&gt; subscriberInfoIndexes, <span class="keyword">boolean</span> strictMethodVerification,</div><div class="line">                           <span class="keyword">boolean</span> ignoreGeneratedIndex) &#123;</div><div class="line">        <span class="keyword">this</span>.subscriberInfoIndexes = subscriberInfoIndexes;</div><div class="line">        <span class="keyword">this</span>.strictMethodVerification = strictMethodVerification;</div><div class="line">        <span class="keyword">this</span>.ignoreGeneratedIndex = ignoreGeneratedIndex;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    List&lt;SubscriberMethod&gt; findSubscriberMethods(<span class="keyword">Class</span>&lt;?&gt; subscriberClass) &#123;</div><div class="line">        List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.get(subscriberClass);</div><div class="line">        <span class="keyword">if</span> (subscriberMethods != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> subscriberMethods;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ignoreGeneratedIndex) &#123;</div><div class="line">            subscriberMethods = findUsingReflection(subscriberClass);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            subscriberMethods = findUsingInfo(subscriberClass);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (subscriberMethods.isEmpty()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriberClass</div><div class="line">                    + <span class="string">" and its super classes have no public methods with the @Subscribe annotation"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            METHOD_CACHE.put(subscriberClass, subscriberMethods);</div><div class="line">            <span class="keyword">return</span> subscriberMethods;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>由于在应用程序的整个生命周期中，一个类的监听者方法总是不会变的，因而可以看到在<code>SubscriberMethodFinder</code>中有创建一个缓存<em>METHOD_CACHE</em>，以监听者类为key，以监听者方法的列表为值。在<code>SubscriberMethodFinder.findSubscriberMethods()</code>方法中会首先检查这个缓存中是否已经有了对应类的监听者方法，如果有的话会直接返回给调用者，没有的时候才会通过反射等机制来查找。</p>
<p><code>ignoreGeneratedIndex</code>用来标记是否要忽略用户定制的监听者方法标识方法。若忽略则直接利用反射机制，也就是<strong>Subscribe</strong> annotation机制来查找监听者方法，即调用<code>findUsingReflection()</code>方法；否则会先尝试使用用户定制的机制来查找，查找失败时才会使用反射机制来查找，这也就是调用<code>findUsingInfo()</code>方法。</p>
<p>在<code>findUsingReflection()</code>方法中实现了如我们前面提到的用annotation标识监听者方法的方式下，查找监听者方法的过程：<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; findUsingReflection(<span class="class"><span class="keyword">Class</span>&lt;?&gt; <span class="title">subscriberClass</span>) &#123;</span></div><div class="line">    FindState findState = prepareFindState();</div><div class="line">    findState.initForSubscriber(subscriberClass);</div><div class="line">    <span class="keyword">while</span> (findState.clazz != <span class="literal">null</span>) &#123;</div><div class="line">        findUsingReflectionInSingleClass(findState);</div><div class="line">        findState.moveToSuperclass();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> getMethodsAndRelease(findState);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> void findUsingReflectionInSingleClass(FindState findState) &#123;</div><div class="line">    <span class="function"><span class="keyword">Method</span>[] <span class="title">methods</span>;</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        // This is faster than getMethods, especially when subscribers are fat classes like Activities</div><div class="line">        methods = findState.clazz.getDeclaredMethods();</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line">        // Workaround <span class="keyword">for</span> java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/<span class="number">149</span></div><div class="line">        methods = findState.clazz.getMethods();</div><div class="line">        findState.skipSuperClasses = <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="function"><span class="keyword">Method</span> <span class="title">method</span> :</span> methods) &#123;</div><div class="line">        int modifiers = <span class="function"><span class="keyword">method</span>.<span class="title">getModifiers</span>(</span>);</div><div class="line">        <span class="keyword">if</span> ((modifiers &amp; Modifier.<span class="keyword">PUBLIC</span>) != <span class="number">0</span> &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == <span class="number">0</span>) &#123;</div><div class="line">            <span class="class"><span class="keyword">Class</span>&lt;?&gt;[] <span class="title">parameterTypes</span> = <span class="title">method</span>.<span class="title">getParameterTypes</span>();</span></div><div class="line">            <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span>) &#123;</div><div class="line">                Subscribe subscribeAnnotation = <span class="function"><span class="keyword">method</span>.<span class="title">getAnnotation</span>(</span>Subscribe.class);</div><div class="line">                <span class="keyword">if</span> (subscribeAnnotation != <span class="literal">null</span>) &#123;</div><div class="line">                    <span class="class"><span class="keyword">Class</span>&lt;?&gt; <span class="title">eventType</span> = <span class="title">parameterTypes</span>[0];</span></div><div class="line">                    <span class="keyword">if</span> (findState.checkAdd(<span class="function"><span class="keyword">method</span>, <span class="title">eventType</span>)) &#123;</span></div><div class="line">                        ThreadMode threadMode = subscribeAnnotation.threadMode();</div><div class="line">                        findState.subscriberMethods.add(<span class="keyword">new</span> SubscriberMethod(<span class="function"><span class="keyword">method</span>, <span class="title">eventType</span>, <span class="title">threadMode</span>,</span></div><div class="line">                                subscribeAnnotation.priority(), subscribeAnnotation.sticky()));</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; <span class="function"><span class="keyword">method</span>.<span class="title">isAnnotationPresent</span>(</span>Subscribe.class)) &#123;</div><div class="line">                String methodName = <span class="function"><span class="keyword">method</span>.<span class="title">getDeclaringClass</span>(</span>).getName() + <span class="string">"."</span> + <span class="function"><span class="keyword">method</span>.<span class="title">getName</span>(</span>);</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"@Subscribe method "</span> + methodName +</div><div class="line">                        <span class="string">"must have exactly 1 parameter but has "</span> + parameterTypes.length);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; <span class="function"><span class="keyword">method</span>.<span class="title">isAnnotationPresent</span>(</span>Subscribe.class)) &#123;</div><div class="line">            String methodName = <span class="function"><span class="keyword">method</span>.<span class="title">getDeclaringClass</span>(</span>).getName() + <span class="string">"."</span> + <span class="function"><span class="keyword">method</span>.<span class="title">getName</span>(</span>);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(methodName +</div><div class="line">                    <span class="string">" is a illegal @Subscribe method: must be public, non-static, and non-abstract"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>findUsingReflection()</code>中，会借助于<code>FindState</code>来查找所有的监听者方法。<code>FindState</code>类的角色主要有三个，一是迭代器，用于在监听者类的整个继承体系中遍历每一个类；二是容器，用来存放找到的每一个监听者方法；三是对找到的方法做验证。</p>
<p><code>findUsingReflectionInSingleClass()</code>方法找到一个特定类中所有的监听者方法。这里可以清楚地看到<code>EventBus</code>对于监听者方法的声明的完整限制。一个方法被认定为监听者方法的条件为：</p>
<ol>
<li>方法的可见性被声明为全局可见<code>public</code>，同时没有<code>abstract</code>、<code>static</code>、<code>bridge</code>及<code>synthetic</code>修饰。</li>
<li>方法的参数只有一个。</li>
<li>有annotation <strong>Subscribe</strong>的声明。</li>
<li><code>FindState.checkAdd()</code>会实施一些额外的限制。主要是关于，类中声明了多个方法监听相同事件的处理；及方法override的处理，即在类的继承体系中，有多个类声明了相同的方法，对相同的事件进行监听。</li>
</ol>
<p><code>strictMethodVerification</code>是一个调试开关，如果开关打开，则当一个类声明了annotation <strong>Subscribe</strong>，但modifier或参数列表不满足要求时，会直接抛出异常。</p>
<p>我们再来详细地看一下FindState的定义：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">class</span> FindState &#123;</div><div class="line">    <span class="keyword">final</span> List&lt;SubscriberMethod&gt; subscriberMethods = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">final</span> Map&lt;<span class="keyword">Class</span>, Object&gt; anyMethodByEventType = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    <span class="keyword">final</span> Map&lt;String, <span class="keyword">Class</span>&gt; subscriberClassByMethodKey = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    <span class="keyword">final</span> StringBuilder methodKeyBuilder = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</div><div class="line"></div><div class="line">    <span class="keyword">Class</span>&lt;?&gt; subscriberClass;</div><div class="line">    <span class="keyword">Class</span>&lt;?&gt; clazz;</div><div class="line">    <span class="keyword">boolean</span> skipSuperClasses;</div><div class="line">    SubscriberInfo subscriberInfo;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> initForSubscriber(<span class="keyword">Class</span>&lt;?&gt; subscriberClass) &#123;</div><div class="line">        <span class="keyword">this</span>.subscriberClass = clazz = subscriberClass;</div><div class="line">        skipSuperClasses = <span class="keyword">false</span>;</div><div class="line">        subscriberInfo = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> recycle() &#123;</div><div class="line">        subscriberMethods.clear();</div><div class="line">        anyMethodByEventType.clear();</div><div class="line">        subscriberClassByMethodKey.clear();</div><div class="line">        methodKeyBuilder.setLength(<span class="number">0</span>);</div><div class="line">        subscriberClass = <span class="keyword">null</span>;</div><div class="line">        clazz = <span class="keyword">null</span>;</div><div class="line">        skipSuperClasses = <span class="keyword">false</span>;</div><div class="line">        subscriberInfo = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> checkAdd(Method method, <span class="keyword">Class</span>&lt;?&gt; eventType) &#123;</div><div class="line">        <span class="comment">// 2 level check: 1st level with event type only (fast), 2nd level with complete signature when required.</span></div><div class="line">        <span class="comment">// Usually a subscriber doesn't have methods listening to the same event type.</span></div><div class="line">        Object existing = anyMethodByEventType.put(eventType, method);</div><div class="line">        <span class="keyword">if</span> (existing == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (existing <span class="keyword">instanceof</span> Method) &#123;</div><div class="line">                <span class="keyword">if</span> (!checkAddWithMethodSignature((Method) existing, eventType)) &#123;</div><div class="line">                    <span class="comment">// Paranoia check</span></div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Put any non-Method object to "consume" the existing Method</span></div><div class="line">                anyMethodByEventType.put(eventType, <span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> checkAddWithMethodSignature(method, eventType);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> checkAddWithMethodSignature(Method method, <span class="keyword">Class</span>&lt;?&gt; eventType) &#123;</div><div class="line">        methodKeyBuilder.setLength(<span class="number">0</span>);</div><div class="line">        methodKeyBuilder.<span class="keyword">append</span>(method.getName());</div><div class="line">        methodKeyBuilder.<span class="keyword">append</span>(<span class="string">'&gt;'</span>).<span class="keyword">append</span>(eventType.getName());</div><div class="line"></div><div class="line">        String methodKey = methodKeyBuilder.toString();</div><div class="line">        <span class="keyword">Class</span>&lt;?&gt; methodClass = method.getDeclaringClass();</div><div class="line">        <span class="keyword">Class</span>&lt;?&gt; methodClassOld = subscriberClassByMethodKey.put(methodKey, methodClass);</div><div class="line">        <span class="keyword">if</span> (methodClassOld == <span class="keyword">null</span> || methodClassOld.isAssignableFrom(methodClass)) &#123;</div><div class="line">            <span class="comment">// Only add if not already found in a sub class</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Revert the put, old class is further down the class hierarchy</span></div><div class="line">            subscriberClassByMethodKey.put(methodKey, methodClassOld);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> moveToSuperclass() &#123;</div><div class="line">        <span class="keyword">if</span> (skipSuperClasses) &#123;</div><div class="line">            clazz = <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            clazz = clazz.getSuperclass();</div><div class="line">            String clazzName = clazz.getName();</div><div class="line">            <span class="comment">/** Skip system classes, this just degrades performance. */</span></div><div class="line">            <span class="keyword">if</span> (clazzName.startsWith(<span class="string">"java."</span>) || clazzName.startsWith(<span class="string">"javax."</span>) || clazzName.startsWith(<span class="string">"android."</span>)) &#123;</div><div class="line">                clazz = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>moveToSuperclass()是迭代器方法，用于帮助SubscriberMethodFinder在订阅者类的整个继承层次中进行遍历。这里可以看到，这个遍历过程一般不会遍历到Object才停止，如果订阅者类直接或间接继承了java标准库或android框架层的类的话，遍历到那些类的时候就会终止了。checkAdd(Method method, Class&lt;?&gt; eventType)方法施加我们前面提到的额外限制，这个过程大体为：</p>
<ol>
<li>订阅者类的整个继承层次中只有一个方法订阅了某个特定类型的事件，则该方法直接被认定为订阅者方法。</li>
<li>继承层次中对同一个事件类型有多个订阅者方法的，只要不同方法的方法名不同，则都会被认定为订阅者方法。</li>
<li>继承层次中某个被override的方法被声明了订阅者方法，则继承层次中深度最深的类的方法被认定为订阅者方法。子类比父类在继承层次中的深度要深。</li>
</ol>
<p>SubscriberMethodFinder中FindState对象并不会总是被重新创建，而是有一个缓冲池，需要的时候从这个池子中获取所需得对象，而在对象用完之后，又会被重新归还到池子中，这些操作的详细过程可以在prepareFindState()和getMethodsAndRelease()这两个方法中看到：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">getMethodsAndRelease</span><span class="params">(FindState findState)</span> </span>&#123;</div><div class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = <span class="keyword">new</span> ArrayList&lt;&gt;(findState.subscriberMethods);</div><div class="line">    findState.recycle();</div><div class="line">    <span class="keyword">synchronized</span> (FIND_STATE_POOL) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; POOL_SIZE; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (FIND_STATE_POOL[i] == <span class="keyword">null</span>) &#123;</div><div class="line">                FIND_STATE_POOL[i] = findState;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> subscriberMethods;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> FindState <span class="title">prepareFindState</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (FIND_STATE_POOL) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; POOL_SIZE; i++) &#123;</div><div class="line">            FindState state = FIND_STATE_POOL[i];</div><div class="line">            <span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</div><div class="line">                FIND_STATE_POOL[i] = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">return</span> state;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FindState();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>findUsingInfo()和getSubscriberInfo()方法则允许用户插入自定义的订阅者方法声明机制：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">    private List&lt;<span class="keyword">SubscriberMethod&gt; </span>findUsingInfo(Class&lt;?&gt; <span class="keyword">subscriberClass) </span>&#123;</div><div class="line">        FindState findState = prepareFindState()<span class="comment">;</span></div><div class="line">        findState.initForSubscriber(<span class="keyword">subscriberClass);</span></div><div class="line">        <span class="meta">while</span> (findState.clazz != null) &#123;</div><div class="line">            findState.<span class="keyword">subscriberInfo </span>= getSubscriberInfo(findState)<span class="comment">;</span></div><div class="line">            <span class="meta">if</span> (findState.<span class="keyword">subscriberInfo </span>!= null) &#123;</div><div class="line">                <span class="keyword">SubscriberMethod[] </span>array = findState.<span class="keyword">subscriberInfo.getSubscriberMethods();</span></div><div class="line">                for (<span class="keyword">SubscriberMethod </span><span class="keyword">subscriberMethod </span>: array) &#123;</div><div class="line">                    <span class="meta">if</span> (findState.checkAdd(<span class="keyword">subscriberMethod.method, </span><span class="keyword">subscriberMethod.eventType)) </span>&#123;</div><div class="line">                        findState.<span class="keyword">subscriberMethods.add(subscriberMethod);</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="meta">else</span> &#123;</div><div class="line">                findUsingReflectionInSingleClass(findState)<span class="comment">;</span></div><div class="line">            &#125;</div><div class="line">            findState.<span class="keyword">moveToSuperclass();</span></div><div class="line">        &#125;</div><div class="line">        return getMethodsAndRelease(findState)<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line"><span class="symbol">......</span></div><div class="line">    private <span class="keyword">SubscriberInfo </span>getSubscriberInfo(FindState findState) &#123;</div><div class="line">        <span class="meta">if</span> (findState.<span class="keyword">subscriberInfo </span>!= null &amp;&amp; findState.<span class="keyword">subscriberInfo.getSuperSubscriberInfo() </span>!= null) &#123;</div><div class="line">            <span class="keyword">SubscriberInfo </span>superclassInfo = findState.<span class="keyword">subscriberInfo.getSuperSubscriberInfo();</span></div><div class="line">            <span class="meta">if</span> (findState.clazz == superclassInfo.getSubscriberClass()) &#123;</div><div class="line">                return superclassInfo<span class="comment">;</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="meta">if</span> (<span class="keyword">subscriberInfoIndexes </span>!= null) &#123;</div><div class="line">            for (<span class="keyword">SubscriberInfoIndex </span>index : <span class="keyword">subscriberInfoIndexes) </span>&#123;</div><div class="line">                <span class="keyword">SubscriberInfo </span><span class="meta">info</span> = index.getSubscriberInfo(findState.clazz)<span class="comment">;</span></div><div class="line">                <span class="meta">if</span> (<span class="meta">info</span> != null) &#123;</div><div class="line">                    return <span class="meta">info</span><span class="comment">;</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return null<span class="comment">;</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>所谓的用户自定义订阅者方法声明机制，需要通过实现SubscriberInfoIndex和SubscriberInfo接口来实现，并通过EventBusBuilder在创建EventBus对象时传递进来。SubscriberInfoIndex和SubscriberInfo接口的定义为：<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> <span class="title">org.greenrobot.eventbus.meta;</span></div><div class="line"></div><div class="line">/**</div><div class="line"> * <span class="keyword">Interface</span> <span class="keyword">for</span> generated indexes.</div><div class="line"> */</div><div class="line">public <span class="keyword">interface</span> SubscriberInfoIndex &#123;</div><div class="line">    SubscriberInfo getSubscriberInfo(Class&lt;?&gt; subscriberClass);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>和<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">package <span class="keyword">org.greenrobot.eventbus.meta;</span></div><div class="line"></div><div class="line">import <span class="keyword">org.greenrobot.eventbus.SubscriberMethod;</span></div><div class="line"></div><div class="line"><span class="comment">/** Base class for generated index classes created by annotation processing. */</span></div><div class="line">public interface <span class="keyword">SubscriberInfo </span>&#123;</div><div class="line">    Class&lt;?&gt; getSubscriberClass()<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">SubscriberMethod[] </span>getSubscriberMethods()<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">SubscriberInfo </span>getSuperSubscriberInfo()<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">boolean </span><span class="keyword">shouldCheckSuperclass();</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>至此，EventBus中，注册订阅者的过程就分析完了。</p>
</div><div class="tags"><a href="/tags/Android开发/">Android开发</a><a href="/tags/源码分析/">源码分析</a></div><div class="post-nav"><a href="/2016/08/04/EventBus设计与实现分析——事件的发布/" class="pre">EventBus设计与实现分析——事件的发布</a><a href="/2016/07/03/EventBus设计与实现分析——特性介绍/" class="next">EventBus设计与实现分析——特性介绍</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android-图形系统/">Android 图形系统</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android-开发/">Android 开发</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/11/android_emulator_dev/">Android 模拟器下载、编译及调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_start_streaming/">live555 源码分析：播放启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_subsession_setup/">live555 源码分析：子会话 SETUP</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/live555_src_analysis_subsession_sdp/">live555 源码分析：子会话 SDP 行生成</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/live555_src_analysis_servermediasession/">live555 源码分析：ServerMediaSession</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/06/live555_src_analysis_rtspserver_arch/">live555 源码分析：RTSPServer 组件结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/live555_src_analysis_play/">live555 源码分析： PLAY 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/live555_src_analysis_setup/">live555 源码分析： SETUP 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/04/live555_src_analysis_describe/">live555 源码分析： DESCRIBE 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/03/live555_src_analysis_rtspserver/">live555 源码分析：RTSPServer</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2016/07/04/EventBus设计与实现分析——订阅者的注册/';
var disqus_title = 'EventBus设计与实现分析——订阅者的注册';
var disqus_url = 'https://www.wolfcstech.com/2016/07/04/EventBus设计与实现分析——订阅者的注册/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>