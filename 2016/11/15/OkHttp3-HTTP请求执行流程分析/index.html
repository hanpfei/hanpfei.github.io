<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>OkHttp3 HTTP请求执行流程分析 | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">OkHttp3 HTTP请求执行流程分析</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">OkHttp3 HTTP请求执行流程分析</h1><div class="post-meta">Nov 15, 2016<span> | </span><span class="category"><a href="/categories/网络协议/">网络协议</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/11/15/OkHttp3-HTTP请求执行流程分析/" href="/2016/11/15/OkHttp3-HTTP请求执行流程分析/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h1 id="OkHttp3的基本用法"><a href="#OkHttp3的基本用法" class="headerlink" title="OkHttp3的基本用法"></a>OkHttp3的基本用法</h1><p>使用OkHttp3发送Http请求并获得响应的过程大体为：</p>
<ol>
<li>创建OkHttpClient对象。OkHttpClient为网络请求执行的一个中心，它会管理连接池，缓存，SocketFactory，代理，各种超时时间，DNS，请求执行结果的分发等许多内容。</li>
<li>创建Request对象。Request用于描述一个HTTP请求，比如请求的方法是”GET”还是”POST”，请求的URL，请求的header，请求的body，请求的缓存策略等。</li>
<li>利用前面创建的OkHttpClient对象和Request对象创建Call对象。Call是一次HTTP请求的Task，它会执行网络请求以获得响应。OkHttp中的网络请求执行Call既可以同步进行，也可以异步进行。调用call.execute()将直接执行网络请求，阻塞直到获得响应。而调用call.enqueue()传入回调，则会将Call放入一个异步执行队列，由ExecutorService在后台执行。</li>
<li>执行网络请求并获取响应。</li>
</ol>
<a id="more"></a>
<p>通过一段示例代码来看一下具体要如何操作：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">startRequestWithOkHttp3</span><span class="params">(String url)</span> </span>&#123;</div><div class="line">    <span class="comment">//创建okHttpClient对象</span></div><div class="line">    okhttp3.OkHttpClient mOkHttpClient = <span class="keyword">new</span> okhttp3.OkHttpClient();</div><div class="line">    <span class="comment">//创建一个Request</span></div><div class="line">    <span class="keyword">final</span> okhttp3.Request request = <span class="keyword">new</span> okhttp3.Request.Builder()</div><div class="line">            .url(url)</div><div class="line">            .build();</div><div class="line">    <span class="comment">//new call</span></div><div class="line">    okhttp3.Call call = mOkHttpClient.newCall(request);</div><div class="line">    <span class="comment">//请求加入调度</span></div><div class="line">    call.enqueue(<span class="keyword">new</span> okhttp3.Callback() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(okhttp3.Call call, <span class="keyword">final</span> IOException e)</span> </span>&#123;</div><div class="line">            mTextScreen.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    mTextScreen.setText(e.toString());</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            <span class="keyword">final</span> String str = response.body().string();</div><div class="line">            mTextScreen.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    mTextScreen.setText(str);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Call的执行"><a href="#Call的执行" class="headerlink" title="Call的执行"></a>Call的执行</h1><p>(后面所有的代码分析都基于正式的发布版本3.4.0进行，’com.squareup.okhttp3:okhttp:3.4.0’，由于OkHttp当前依然处于比较活跃的开发状态，因而不同版本的内部实现相对于我们当前分析的这一版有可能会有比较大的变化。)</p>
<p>Call是一个接口，其定义如下：<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">package okhttp3;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line"></div><div class="line">/**</div><div class="line"> * A <span class="keyword">call</span> <span class="keyword">is</span> a <span class="built_in">request</span> that has been prepared <span class="keyword">for</span> execution. A <span class="keyword">call</span> can be canceled. As this object</div><div class="line"> * represents a single <span class="built_in">request</span>/<span class="built_in">response</span> pair (stream), it cannot be executed twice.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> interface <span class="keyword">Call</span> &#123;</div><div class="line">  /** Returns the original <span class="built_in">request</span> that initiated this <span class="keyword">call</span>. */</div><div class="line">  <span class="built_in">Request</span> <span class="built_in">request</span>();</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Invokes the <span class="built_in">request</span> immediately, <span class="keyword">and</span> blocks until the <span class="built_in">response</span> can be processed <span class="keyword">or</span> <span class="keyword">is</span> <span class="keyword">in</span></div><div class="line">   * <span class="keyword">error</span>.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;The caller may read the <span class="built_in">response</span> body <span class="keyword">with</span> the <span class="built_in">response</span><span class="comment">'s &#123;@link Response#body&#125; method. To</span></div><div class="line">   * avoid leaking resources callers must &#123;@linkplain ResponseBody close the <span class="built_in">response</span> body&#125;.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;Note that transport-layer success (receiving a HTTP <span class="built_in">response</span> code, headers <span class="keyword">and</span> body) does</div><div class="line">   * <span class="keyword">not</span> necessarily indicate application-layer success: &#123;@code <span class="built_in">response</span>&#125; may still indicate an</div><div class="line">   * unhappy HTTP <span class="built_in">response</span> code like <span class="number">404</span> <span class="keyword">or</span> <span class="number">500.</span></div><div class="line">   *</div><div class="line">   * @throws IOException <span class="keyword">if</span> the <span class="built_in">request</span> could <span class="keyword">not</span> be executed due <span class="keyword">to</span> cancellation, a connectivity</div><div class="line">   * problem <span class="keyword">or</span> timeout. Because networks can fail during an exchange, it <span class="keyword">is</span> possible that the</div><div class="line">   * remote <span class="built_in">server</span> accepted the <span class="built_in">request</span> before the failure.</div><div class="line">   * @throws IllegalStateException when the <span class="keyword">call</span> has already been executed.</div><div class="line">   */</div><div class="line">  <span class="built_in">Response</span> <span class="keyword">execute</span>() throws IOException;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Schedules the <span class="built_in">request</span> <span class="keyword">to</span> be executed at some point <span class="keyword">in</span> the future.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;The &#123;@link OkHttpClient#dispatcher dispatcher&#125; defines when the <span class="built_in">request</span> will run: usually</div><div class="line">   * immediately unless there are several other requests currently being executed.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;This client will later <span class="keyword">call</span> back &#123;@code responseCallback&#125; <span class="keyword">with</span> either an HTTP <span class="built_in">response</span> <span class="keyword">or</span> a</div><div class="line">   * failure exception.</div><div class="line">   *</div><div class="line">   * @throws IllegalStateException when the <span class="keyword">call</span> has already been executed.</div><div class="line">   */</div><div class="line">  void enqueue(Callback responseCallback);</div><div class="line"></div><div class="line">  /** Cancels the <span class="built_in">request</span>, <span class="keyword">if</span> possible. Requests that are already complete cannot be canceled. */</div><div class="line">  void cancel();</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Returns <span class="literal">true</span> <span class="keyword">if</span> this <span class="keyword">call</span> has been either &#123;@linkplain #<span class="keyword">execute</span>() executed&#125; <span class="keyword">or</span> &#123;@linkplain</div><div class="line">   * #enqueue(Callback) enqueued&#125;. It <span class="keyword">is</span> an <span class="keyword">error</span> <span class="keyword">to</span> <span class="keyword">execute</span> a <span class="keyword">call</span> more than once.</div><div class="line">   */</div><div class="line">  boolean isExecuted();</div><div class="line"></div><div class="line">  boolean isCanceled();</div><div class="line"></div><div class="line">  interface Factory &#123;</div><div class="line">    <span class="keyword">Call</span> newCall(<span class="built_in">Request</span> <span class="built_in">request</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Call中还定义了一个Factory接口。</p>
<p>那在OkHttp中，我们调用的Call方法的实际执行过程是怎样的呢？这就需要扒出来在OkHttp中实际使用的Call实现了。OkHttpClient实现了Call.Factory接口，通过接口方法OkHttpClient.newCall()可以看到具体使用的Call实现是哪个类：<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Prepares <span class="keyword">the</span> &#123;@code request&#125; <span class="keyword">to</span> <span class="keyword">be</span> <span class="keyword">executed</span> <span class="keyword">at</span> <span class="keyword">some</span> <span class="keyword">point</span> <span class="keyword">in</span> <span class="keyword">the</span> <span class="keyword">future</span>.</div><div class="line"> */</div><div class="line">@Override public Call newCall(Request request) &#123;</div><div class="line">  return new RealCall(this, request);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在OkHttp中使用了RealCall来执行整个Http请求。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> okhttp3;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> okhttp3.internal.NamedRunnable;</div><div class="line"><span class="keyword">import</span> okhttp3.internal.cache.CacheInterceptor;</div><div class="line"><span class="keyword">import</span> okhttp3.internal.connection.ConnectInterceptor;</div><div class="line"><span class="keyword">import</span> okhttp3.internal.connection.StreamAllocation;</div><div class="line"><span class="keyword">import</span> okhttp3.internal.http.BridgeInterceptor;</div><div class="line"><span class="keyword">import</span> okhttp3.internal.http.CallServerInterceptor;</div><div class="line"><span class="keyword">import</span> okhttp3.internal.http.RealInterceptorChain;</div><div class="line"><span class="keyword">import</span> okhttp3.internal.http.RetryAndFollowUpInterceptor;</div><div class="line"><span class="keyword">import</span> okhttp3.internal.platform.Platform;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> okhttp3.internal.platform.Platform.INFO;</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RealCall</span> <span class="keyword">implements</span> <span class="title">Call</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> RetryAndFollowUpInterceptor retryAndFollowUpInterceptor;</div><div class="line"></div><div class="line">  <span class="comment">// Guarded by this.</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> executed;</div><div class="line"></div><div class="line">  <span class="comment">/** The application's original request unadulterated by redirects or auth headers. */</span></div><div class="line">  Request originalRequest;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">RealCall</span><span class="params">(OkHttpClient client, Request originalRequest)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.client = client;</div><div class="line">    <span class="keyword">this</span>.originalRequest = originalRequest;</div><div class="line">    <span class="keyword">this</span>.retryAndFollowUpInterceptor = <span class="keyword">new</span> RetryAndFollowUpInterceptor(client);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function">Request <span class="title">request</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> originalRequest;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function">Response <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);</div><div class="line">      executed = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      client.dispatcher().executed(<span class="keyword">this</span>);</div><div class="line">      Response result = getResponseWithInterceptorChain();</div><div class="line">      <span class="keyword">if</span> (result == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>);</div><div class="line">      <span class="keyword">return</span> result;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      client.dispatcher().finished(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">synchronized</span> <span class="function"><span class="keyword">void</span> <span class="title">setForWebSocket</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);</div><div class="line">    <span class="keyword">this</span>.retryAndFollowUpInterceptor.setForWebSocket(<span class="keyword">true</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Callback responseCallback)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);</div><div class="line">      executed = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    client.dispatcher().enqueue(<span class="keyword">new</span> AsyncCall(responseCallback));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</div><div class="line">    retryAndFollowUpInterceptor.cancel();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="function"><span class="keyword">boolean</span> <span class="title">isExecuted</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> executed;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">isCanceled</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">return</span> retryAndFollowUpInterceptor.<span class="title">isCanceled</span><span class="params">()</span></span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function">StreamAllocation <span class="title">streamAllocation</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">return</span> retryAndFollowUpInterceptor.<span class="title">streamAllocation</span><span class="params">()</span></span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCall</span> <span class="keyword">extends</span> <span class="title">NamedRunnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Callback responseCallback;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AsyncCall</span><span class="params">(Callback responseCallback)</span> </span>&#123;</div><div class="line">      <span class="keyword">super</span>(<span class="string">"OkHttp %s"</span>, redactedUrl().toString());</div><div class="line">      <span class="keyword">this</span>.responseCallback = responseCallback;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function">String <span class="title">host</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> originalRequest.url().host();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function">Request <span class="title">request</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> originalRequest;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function">RealCall <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> RealCall.<span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">boolean</span> signalledCallback = <span class="keyword">false</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        Response response = getResponseWithInterceptorChain();</div><div class="line">        <span class="keyword">if</span> (retryAndFollowUpInterceptor.isCanceled()) &#123;</div><div class="line">          signalledCallback = <span class="keyword">true</span>;</div><div class="line">          responseCallback.onFailure(RealCall.<span class="keyword">this</span>, <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          signalledCallback = <span class="keyword">true</span>;</div><div class="line">          responseCallback.onResponse(RealCall.<span class="keyword">this</span>, response);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="keyword">if</span> (signalledCallback) &#123;</div><div class="line">          <span class="comment">// Do not signal the callback twice!</span></div><div class="line">          Platform.get().log(INFO, <span class="string">"Callback failure for "</span> + toLoggableString(), e);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          responseCallback.onFailure(RealCall.<span class="keyword">this</span>, e);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        client.dispatcher().finished(<span class="keyword">this</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Returns a string that describes this call. Doesn't include a full URL as that might contain</div><div class="line">   * sensitive information.</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="function">String <span class="title">toLoggableString</span><span class="params">()</span> </span>&#123;</div><div class="line">    String string = retryAndFollowUpInterceptor.isCanceled() ? <span class="string">"canceled call"</span> : <span class="string">"call"</span>;</div><div class="line">    <span class="keyword">return</span> string + <span class="string">" to "</span> + redactedUrl();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function">HttpUrl <span class="title">redactedUrl</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> originalRequest.url().resolve(<span class="string">"/..."</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="function">Response <span class="title">getResponseWithInterceptorChain</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">// Build a full stack of interceptors.</span></div><div class="line">    List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    interceptors.addAll(client.interceptors());</div><div class="line">    interceptors.add(retryAndFollowUpInterceptor);</div><div class="line">    interceptors.add(<span class="keyword">new</span> BridgeInterceptor(client.cookieJar()));</div><div class="line">    interceptors.add(<span class="keyword">new</span> CacheInterceptor(client.internalCache()));</div><div class="line">    interceptors.add(<span class="keyword">new</span> ConnectInterceptor(client));</div><div class="line">    <span class="keyword">if</span> (!retryAndFollowUpInterceptor.isForWebSocket()) &#123;</div><div class="line">      interceptors.addAll(client.networkInterceptors());</div><div class="line">    &#125;</div><div class="line">    interceptors.add(<span class="keyword">new</span> CallServerInterceptor(</div><div class="line">        retryAndFollowUpInterceptor.isForWebSocket()));</div><div class="line"></div><div class="line">    Interceptor.Chain chain = <span class="keyword">new</span> RealInterceptorChain(</div><div class="line">        interceptors, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, originalRequest);</div><div class="line">    <span class="function"><span class="keyword">return</span> chain.<span class="title">proceed</span><span class="params">(originalRequest)</span></span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过调用RealCall.execute()同步执行Http请求的过程大体为：</p>
<ol>
<li>调用client.dispatcher().executed(this)向client的dispatcher注册当前Call。</li>
<li>调用getResponseWithInterceptorChain()执行网络请求并获得响应。</li>
<li>调用client.dispatcher().finished(this)向client的dispatcher注销当前Call。</li>
</ol>
<p>通过调用RealCall.enqueue()异步执行Http请求的过程则为，创建AsyncCall并将之丢给client的dispatcher。而在RealCall.AsyncCall的execute()中执行Http请求的过程与RealCall.execute()中的过程有些类似：</p>
<ol>
<li>调用getResponseWithInterceptorChain()执行网络请求并获得响应。</li>
<li>调用Callback回调通知用户执行的结果。可以看到这里对回调接口是同步调用，也就是回调方法将在后台线程中被调用。</li>
<li>调用client.dispatcher().finished(this)向client的dispatcher注销当前Call。</li>
</ol>
<p>这里再通过Dispatcher的定义来看一下在OkHttp中，请求的执行管理及异步执行是怎么做的：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> okhttp3;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.ArrayDeque;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.Collections;</div><div class="line"><span class="keyword">import</span> java.util.Deque;</div><div class="line"><span class="keyword">import</span> java.util.Iterator;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.SynchronousQueue;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"><span class="keyword">import</span> okhttp3.RealCall.AsyncCall;</div><div class="line"><span class="keyword">import</span> okhttp3.internal.Util;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Policy on when async requests are executed.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Each dispatcher uses an &#123;@link ExecutorService&#125; to run calls internally. If you supply your</div><div class="line"> * own executor, it should be able to run &#123;@linkplain #getMaxRequests the configured maximum&#125; number</div><div class="line"> * of calls concurrently.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> Dispatcher &#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> maxRequests = <span class="number">64</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> maxRequestsPerHost = <span class="number">5</span>;</div><div class="line">  <span class="keyword">private</span> Runnable idleCallback;</div><div class="line"></div><div class="line">  <span class="comment">/** Executes calls. Created lazily. */</span></div><div class="line">  <span class="keyword">private</span> ExecutorService executorService;</div><div class="line"></div><div class="line">  <span class="comment">/** Ready async calls in the order they'll be run. */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;AsyncCall&gt; readyAsyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line"></div><div class="line">  <span class="comment">/** Running asynchronous calls. Includes canceled calls that haven't finished yet. */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;AsyncCall&gt; runningAsyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line"></div><div class="line">  <span class="comment">/** Running synchronous calls. Includes canceled calls that haven't finished yet. */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;RealCall&gt; runningSyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line"></div><div class="line">  <span class="keyword">public</span> Dispatcher(ExecutorService executorService) &#123;</div><div class="line">    <span class="keyword">this</span>.executorService = executorService;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> Dispatcher() &#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> ExecutorService executorService() &#123;</div><div class="line">    <span class="keyword">if</span> (executorService == <span class="keyword">null</span>) &#123;</div><div class="line">      executorService = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60</span>, TimeUnit.SECONDS,</div><div class="line">          <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(), Util.threadFactory(<span class="string">"OkHttp Dispatcher"</span>, <span class="keyword">false</span>));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> executorService;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Set the maximum number of requests to execute concurrently. Above this requests queue in</div><div class="line">   * memory, waiting for the running calls to complete.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;If more than &#123;@code maxRequests&#125; requests are in flight when this is invoked, those requests</div><div class="line">   * will remain in flight.</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> setMaxRequests(<span class="keyword">int</span> maxRequests) &#123;</div><div class="line">    <span class="keyword">if</span> (maxRequests &lt; <span class="number">1</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"max &lt; 1: "</span> + maxRequests);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.maxRequests = maxRequests;</div><div class="line">    promoteCalls();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> getMaxRequests() &#123;</div><div class="line">    <span class="keyword">return</span> maxRequests;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Set the maximum number of requests for each host to execute concurrently. This limits requests</div><div class="line">   * by the URL's host name. Note that concurrent requests to a single IP address may still exceed</div><div class="line">   * this limit: multiple hostnames may share an IP address or be routed through the same HTTP</div><div class="line">   * proxy.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;If more than &#123;@code maxRequestsPerHost&#125; requests are in flight when this is invoked, those</div><div class="line">   * requests will remain in flight.</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> setMaxRequestsPerHost(<span class="keyword">int</span> maxRequestsPerHost) &#123;</div><div class="line">    <span class="keyword">if</span> (maxRequestsPerHost &lt; <span class="number">1</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"max &lt; 1: "</span> + maxRequestsPerHost);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.maxRequestsPerHost = maxRequestsPerHost;</div><div class="line">    promoteCalls();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> getMaxRequestsPerHost() &#123;</div><div class="line">    <span class="keyword">return</span> maxRequestsPerHost;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Set a callback to be invoked each time the dispatcher becomes idle (when the number of running</div><div class="line">   * calls returns to zero).</div><div class="line">   *</div><div class="line">   * &lt;p&gt;Note: The time at which a &#123;@linkplain Call call&#125; is considered idle is different depending</div><div class="line">   * on whether it was run &#123;@linkplain Call#enqueue(Callback) asynchronously&#125; or</div><div class="line">   * &#123;@linkplain Call#execute() synchronously&#125;. Asynchronous calls become idle after the</div><div class="line">   * &#123;@link Callback#onResponse onResponse&#125; or &#123;@link Callback#onFailure onFailure&#125; callback has</div><div class="line">   * returned. Synchronous calls become idle once &#123;@link Call#execute() execute()&#125; returns. This</div><div class="line">   * means that if you are doing synchronous calls the network layer will not truly be idle until</div><div class="line">   * every returned &#123;@link Response&#125; has been closed.</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> setIdleCallback(Runnable idleCallback) &#123;</div><div class="line">    <span class="keyword">this</span>.idleCallback = idleCallback;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">synchronized</span> <span class="keyword">void</span> enqueue(AsyncCall <span class="keyword">call</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (runningAsyncCalls.<span class="keyword">size</span>() &lt; maxRequests &amp;&amp; runningCallsForHost(<span class="keyword">call</span>) &lt; maxRequestsPerHost) &#123;</div><div class="line">      runningAsyncCalls.add(<span class="keyword">call</span>);</div><div class="line">      executorService().execute(<span class="keyword">call</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      readyAsyncCalls.add(<span class="keyword">call</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Cancel all calls currently enqueued or executing. Includes calls executed both &#123;@linkplain</div><div class="line">   * Call#execute() synchronously&#125; and &#123;@linkplain Call#enqueue asynchronously&#125;.</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> cancelAll() &#123;</div><div class="line">    <span class="keyword">for</span> (AsyncCall <span class="keyword">call</span> : readyAsyncCalls) &#123;</div><div class="line">      <span class="keyword">call</span>.get().cancel();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (AsyncCall <span class="keyword">call</span> : runningAsyncCalls) &#123;</div><div class="line">      <span class="keyword">call</span>.get().cancel();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (RealCall <span class="keyword">call</span> : runningSyncCalls) &#123;</div><div class="line">      <span class="keyword">call</span>.cancel();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">void</span> promoteCalls() &#123;</div><div class="line">    <span class="keyword">if</span> (runningAsyncCalls.<span class="keyword">size</span>() &gt;= maxRequests) <span class="keyword">return</span>; <span class="comment">// Already running max capacity.</span></div><div class="line">    <span class="keyword">if</span> (readyAsyncCalls.isEmpty()) <span class="keyword">return</span>; <span class="comment">// No ready calls to promote.</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> (Iterator&lt;AsyncCall&gt; i = readyAsyncCalls.iterator(); i.hasNext(); ) &#123;</div><div class="line">      AsyncCall <span class="keyword">call</span> = i.<span class="keyword">next</span>();</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (runningCallsForHost(<span class="keyword">call</span>) &lt; maxRequestsPerHost) &#123;</div><div class="line">        i.remove();</div><div class="line">        runningAsyncCalls.add(<span class="keyword">call</span>);</div><div class="line">        executorService().execute(<span class="keyword">call</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (runningAsyncCalls.<span class="keyword">size</span>() &gt;= maxRequests) <span class="keyword">return</span>; <span class="comment">// Reached max capacity.</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns the number of running calls that share a host with &#123;@code call&#125;. */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> runningCallsForHost(AsyncCall <span class="keyword">call</span>) &#123;</div><div class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (AsyncCall c : runningAsyncCalls) &#123;</div><div class="line">      <span class="keyword">if</span> (c.host().equals(<span class="keyword">call</span>.host())) result++;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Used by &#123;@code Call#execute&#125; to signal it is in-flight. */</span></div><div class="line">  <span class="keyword">synchronized</span> <span class="keyword">void</span> executed(RealCall <span class="keyword">call</span>) &#123;</div><div class="line">    runningSyncCalls.add(<span class="keyword">call</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Used by &#123;@code AsyncCall#run&#125; to signal completion. */</span></div><div class="line">  <span class="keyword">void</span> finished(AsyncCall <span class="keyword">call</span>) &#123;</div><div class="line">    finished(runningAsyncCalls, <span class="keyword">call</span>, <span class="keyword">true</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Used by &#123;@code Call#execute&#125; to signal completion. */</span></div><div class="line">  <span class="keyword">void</span> finished(RealCall <span class="keyword">call</span>) &#123;</div><div class="line">    finished(runningSyncCalls, <span class="keyword">call</span>, <span class="keyword">false</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> &lt;T&gt; <span class="keyword">void</span> finished(Deque&lt;T&gt; calls, T <span class="keyword">call</span>, <span class="keyword">boolean</span> promoteCalls) &#123;</div><div class="line">    <span class="keyword">int</span> runningCallsCount;</div><div class="line">    Runnable idleCallback;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (!calls.remove(<span class="keyword">call</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Call wasn't in-flight!"</span>);</div><div class="line">      <span class="keyword">if</span> (promoteCalls) promoteCalls();</div><div class="line">      runningCallsCount = runningCallsCount();</div><div class="line">      idleCallback = <span class="keyword">this</span>.idleCallback;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (runningCallsCount == <span class="number">0</span> &amp;&amp; idleCallback != <span class="keyword">null</span>) &#123;</div><div class="line">      idleCallback.run();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns a snapshot of the calls currently awaiting execution. */</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> List&lt;<span class="keyword">Call</span>&gt; queuedCalls() &#123;</div><div class="line">    List&lt;<span class="keyword">Call</span>&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">for</span> (AsyncCall asyncCall : readyAsyncCalls) &#123;</div><div class="line">      result.add(asyncCall.get());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> Collections.unmodifiableList(result);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns a snapshot of the calls currently being executed. */</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> List&lt;<span class="keyword">Call</span>&gt; runningCalls() &#123;</div><div class="line">    List&lt;<span class="keyword">Call</span>&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    result.addAll(runningSyncCalls);</div><div class="line">    <span class="keyword">for</span> (AsyncCall asyncCall : runningAsyncCalls) &#123;</div><div class="line">      result.add(asyncCall.get());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> Collections.unmodifiableList(result);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> queuedCallsCount() &#123;</div><div class="line">    <span class="keyword">return</span> readyAsyncCalls.<span class="keyword">size</span>();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> runningCallsCount() &#123;</div><div class="line">    <span class="keyword">return</span> runningAsyncCalls.<span class="keyword">size</span>() + runningSyncCalls.<span class="keyword">size</span>();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在Call的同步执行过程中，调用client.dispatcher().executed(this)向client的dispatcher注册当前Call，Dispatcher仅仅是将Call放进了runningSyncCalls，其它便什么也没做，目测同步执行Call时向Dispatcher注册的主要目的是方便全局性的cancel所有的Call。</p>
<p>Dispatcher中异步的AsyncCall是被放在一个ExecutorService中执行的。默认情况下，这是一个不限容量的线程池。但Dispatcher会限制每个host同时执行的最大请求数量，默认为5，同时也会限制同时执行的总的最大请求数量。runningAsyncCalls中保存所有正在被ExecutorService执行的AsyncCall，而readyAsyncCalls则用于存放由于对单个host同时执行的最大请求数量的限制，或总的同时执行最大请求数量的限制，而暂时得不到执行的AsyncCall。</p>
<p>finished()中，除了会将执行结束的AsyncCall从runningAsyncCalls移除之外，还会检查是否存在由于 单host同时进行的最大请求数量限制 或 总的同时执行最大请求数量限制，而暂时得不到执行的AsyncCall，若存在则满足限制条件的请求会被执行。</p>
<p>所有的Call，不管是异步的AsyncCall还是同步的Call在执行结束后都会检查是否没有正在进行的Http请求了。若没有了，则存在idle 回调时，该回调会被调用。</p>
<p>用户可以通过Dispatcher的构造函数来定制ExecutorService，这需要通过OkHttpClient.Builder在OkHttpClient的构建过程中间接的做到。</p>
<p>回到RealCall，继续来追Call的网络请求及响应处理。来看一下RealCall.getResponseWithInterceptorChain()：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Response <span class="title">getResponseWithInterceptorChain</span>(<span class="params"></span>) throws IOException </span>&#123;</div><div class="line">  <span class="comment">// Build a full stack of interceptors.</span></div><div class="line">  List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">  interceptors.addAll(client.interceptors());</div><div class="line">  interceptors.<span class="keyword">add</span>(retryAndFollowUpInterceptor);</div><div class="line">  interceptors.<span class="keyword">add</span>(<span class="keyword">new</span> BridgeInterceptor(client.cookieJar()));</div><div class="line">  interceptors.<span class="keyword">add</span>(<span class="keyword">new</span> CacheInterceptor(client.internalCache()));</div><div class="line">  interceptors.<span class="keyword">add</span>(<span class="keyword">new</span> ConnectInterceptor(client));</div><div class="line">  <span class="keyword">if</span> (!retryAndFollowUpInterceptor.isForWebSocket()) &#123;</div><div class="line">    interceptors.addAll(client.networkInterceptors());</div><div class="line">  &#125;</div><div class="line">  interceptors.<span class="keyword">add</span>(<span class="keyword">new</span> CallServerInterceptor(</div><div class="line">      retryAndFollowUpInterceptor.isForWebSocket()));</div><div class="line"></div><div class="line">  Interceptor.Chain chain = <span class="keyword">new</span> RealInterceptorChain(</div><div class="line">      interceptors, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>, originalRequest);</div><div class="line">  <span class="keyword">return</span> chain.proceed(originalRequest);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里主要是创建了一个Interceptor的列表，继而创建了一个Interceptor.Chain对象来处理请求并获得响应。我们继续追踪一下RealInterceptorChain：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> okhttp3.internal.http;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> okhttp3.Connection;</div><div class="line"><span class="keyword">import</span> okhttp3.HttpUrl;</div><div class="line"><span class="keyword">import</span> okhttp3.Interceptor;</div><div class="line"><span class="keyword">import</span> okhttp3.Request;</div><div class="line"><span class="keyword">import</span> okhttp3.Response;</div><div class="line"><span class="keyword">import</span> okhttp3.internal.connection.StreamAllocation;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * A concrete interceptor chain that carries the entire interceptor chain: all application</div><div class="line"> * interceptors, the OkHttp core, all network interceptors, and finally the network caller.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RealInterceptorChain</span> <span class="keyword">implements</span> <span class="title">Interceptor</span>.<span class="title">Chain</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Interceptor&gt; interceptors;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> StreamAllocation streamAllocation;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> HttpStream httpStream;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Connection connection;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Request request;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> calls;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RealInterceptorChain</span><span class="params">(List&lt;Interceptor&gt; interceptors, StreamAllocation streamAllocation,</span></span></div><div class="line">      HttpStream httpStream, Connection connection, <span class="keyword">int</span> index, Request request) &#123;</div><div class="line">    <span class="keyword">this</span>.interceptors = interceptors;</div><div class="line">    <span class="keyword">this</span>.connection = connection;</div><div class="line">    <span class="keyword">this</span>.streamAllocation = streamAllocation;</div><div class="line">    <span class="keyword">this</span>.httpStream = httpStream;</div><div class="line">    <span class="keyword">this</span>.index = index;</div><div class="line">    <span class="keyword">this</span>.request = request;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function">Connection <span class="title">connection</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> connection;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function">StreamAllocation <span class="title">streamAllocation</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> streamAllocation;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function">HttpStream <span class="title">httpStream</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> httpStream;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function">Request <span class="title">request</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> request;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function">Response <span class="title">proceed</span><span class="params">(Request request)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">return</span> <span class="title">proceed</span><span class="params">(request, streamAllocation, httpStream, connection)</span></span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function">Response <span class="title">proceed</span><span class="params">(Request request, StreamAllocation streamAllocation, HttpStream httpStream,</span></span></div><div class="line">      Connection connection) <span class="keyword">throws</span> IOException &#123;</div><div class="line">    <span class="keyword">if</span> (index &gt;= interceptors.size()) <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line"></div><div class="line">    calls++;</div><div class="line"></div><div class="line">    <span class="comment">// If we already have a stream, confirm that the incoming request will use it.</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.httpStream != <span class="keyword">null</span> &amp;&amp; !sameConnection(request.url())) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"network interceptor "</span> + interceptors.get(index - <span class="number">1</span>)</div><div class="line">          + <span class="string">" must retain the same host and port"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If we already have a stream, confirm that this is the only call to chain.proceed().</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.httpStream != <span class="keyword">null</span> &amp;&amp; calls &gt; <span class="number">1</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"network interceptor "</span> + interceptors.get(index - <span class="number">1</span>)</div><div class="line">          + <span class="string">" must call proceed() exactly once"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Call the next interceptor in the chain.</span></div><div class="line">    RealInterceptorChain next = <span class="keyword">new</span> RealInterceptorChain(</div><div class="line">        interceptors, streamAllocation, httpStream, connection, index + <span class="number">1</span>, request);</div><div class="line">    Interceptor interceptor = interceptors.get(index);</div><div class="line">    Response response = interceptor.intercept(next);</div><div class="line"></div><div class="line">    <span class="comment">// Confirm that the next interceptor made its required call to chain.proceed().</span></div><div class="line">    <span class="keyword">if</span> (httpStream != <span class="keyword">null</span> &amp;&amp; index + <span class="number">1</span> &lt; interceptors.size() &amp;&amp; next.calls != <span class="number">1</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"network interceptor "</span> + interceptor</div><div class="line">          + <span class="string">" must call proceed() exactly once"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Confirm that the intercepted response isn't null.</span></div><div class="line">    <span class="keyword">if</span> (response == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"interceptor "</span> + interceptor + <span class="string">" returned null"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> response;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">boolean</span> <span class="title">sameConnection</span><span class="params">(HttpUrl url)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> url.host().equals(connection.route().address().url().host())</div><div class="line">        &amp;&amp; url.port() == connection.route().address().url().port();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在RealInterceptorChain.proceed()中，除了对状态及获取的reponse做检查之外，最主要的事情即是构造新的RealInterceptorChain对象，获取对应Interceptor，并调用Interceptor的intercept(next)了。在这里，index充当迭代器或指示器的角色，用于指出当前正在处理的Interceptor。</p>
<p>RealInterceptorChain ＋ Interceptor实现了装饰器模式，实现了请求/响应的串式或流式处理。只不过内层装饰器不是外层装饰器的成员变量，而是接口方法中创建的临时变量。</p>
<p>但Interceptor链中具体都有哪些Interceptor呢？我们就在RealCall.getResponseWithInterceptorChain()中打个断点来看一下：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">this = &#123;RealCall@<span class="number">830033700784</span>&#125; </div><div class="line">interceptors = &#123;ArrayList@<span class="number">830033704824</span>&#125;  size = <span class="number">5</span></div><div class="line"> <span class="number">0</span> = &#123;RetryAndFollowUpInterceptor@<span class="number">830033700816</span>&#125; </div><div class="line"> <span class="number">1</span> = &#123;BridgeInterceptor@<span class="number">830033705520</span>&#125; </div><div class="line"> <span class="number">2</span> = &#123;CacheInterceptor@<span class="number">830033705536</span>&#125; </div><div class="line"> <span class="number">3</span> = &#123;ConnectInterceptor@<span class="number">830033705696</span>&#125; </div><div class="line"> <span class="number">4</span> = &#123;CallServerInterceptor@<span class="number">830033706024</span>&#125; </div><div class="line">originalRequest = &#123;Request@<span class="number">830033700704</span>&#125; <span class="string">"Request&#123;method=GET, url=http://ip.taobao.com//service/getIpInfo.php?ip=123.58.191.68, tag=null&#125;"</span></div><div class="line">retryAndFollowUpInterceptor = &#123;RetryAndFollowUpInterceptor@<span class="number">830033700816</span>&#125;</div></pre></td></tr></table></figure></p>
<p>由此可见OkHttp中，Http请求的实际处理流程将大致如下图这样：<br><img src="https://www.wolfcstech.com/images/1315506-10e49a8770cec26b.jpg" alt="okhttp3.jpg"></p>
<h2 id="RetryAndFollowUpInterceptor"><a href="#RetryAndFollowUpInterceptor" class="headerlink" title="RetryAndFollowUpInterceptor"></a>RetryAndFollowUpInterceptor</h2><p>具体这些Interceptor中每一个都会做些什么事情呢？我们后面再来详细地做分析。</p>
<p>首先来看RetryAndFollowUpInterceptor：<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This interceptor recovers from failures and follows redirects as necessary. It may throw an</div><div class="line"> * &#123;@link IOException&#125; if the call was canceled.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RetryAndFollowUpInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line">   * How many redirects and auth challenges should we attempt? Chrome follows 21 redirects; Firefox,</div><div class="line">   * curl, and wget follow 20; Safari follows 16; and HTTP/1.0 recommends 5.</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_FOLLOW_UPS = <span class="number">20</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient <span class="keyword">client</span>;</div><div class="line">  <span class="keyword">private</span> StreamAllocation streamAllocation;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> forWebSocket;</div><div class="line">  <span class="keyword">private</span> volatile <span class="keyword">boolean</span> canceled;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> RetryAndFollowUpInterceptor(OkHttpClient <span class="keyword">client</span>) &#123;</div><div class="line">    <span class="keyword">this</span>.<span class="keyword">client</span> = <span class="keyword">client</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">  @Override <span class="keyword">public</span> Response intercept(Chain chain) throws IOException &#123;</div><div class="line">    Request request = chain.request();</div><div class="line"></div><div class="line">    streamAllocation = <span class="keyword">new</span> StreamAllocation(</div><div class="line">        <span class="keyword">client</span>.connectionPool(), createAddress(request.url()));</div><div class="line"></div><div class="line">    <span class="keyword">int</span> followUpCount = <span class="number">0</span>;</div><div class="line">    Response priorResponse = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (canceled) &#123;</div><div class="line">        streamAllocation.release();</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      Response response = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">boolean</span> releaseConnection = <span class="keyword">true</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        response = ((RealInterceptorChain) chain).proceed(request, streamAllocation, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">        releaseConnection = <span class="keyword">false</span>;</div><div class="line">      &#125; <span class="keyword">catch</span> (RouteException e) &#123;</div><div class="line">        <span class="comment">// The attempt to connect via a route failed. The request will not have been sent.</span></div><div class="line">        <span class="keyword">if</span> (!recover(e.getLastConnectException(), <span class="keyword">true</span>, request)) <span class="keyword">throw</span> e.getLastConnectException();</div><div class="line">        releaseConnection = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="comment">// An attempt to communicate with a server failed. The request may have been sent.</span></div><div class="line">        <span class="keyword">if</span> (!recover(e, <span class="keyword">false</span>, request)) <span class="keyword">throw</span> e;</div><div class="line">        releaseConnection = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="comment">// We're throwing an unchecked exception. Release any resources.</span></div><div class="line">        <span class="keyword">if</span> (releaseConnection) &#123;</div><div class="line">          streamAllocation.streamFailed(<span class="keyword">null</span>);</div><div class="line">          streamAllocation.release();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// Attach the prior response if it exists. Such responses never have a body.</span></div><div class="line">      <span class="keyword">if</span> (priorResponse != <span class="keyword">null</span>) &#123;</div><div class="line">        response = response.newBuilder()</div><div class="line">            .priorResponse(priorResponse.newBuilder()</div><div class="line">                .body(<span class="keyword">null</span>)</div><div class="line">                .build())</div><div class="line">            .build();</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      Request followUp = followUpRequest(response);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (followUp == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!forWebSocket) &#123;</div><div class="line">          streamAllocation.release();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> response;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      closeQuietly(response.body());</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (++followUpCount &gt; MAX_FOLLOW_UPS) &#123;</div><div class="line">        streamAllocation.release();</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolException(<span class="string">"Too many follow-up requests: "</span> + followUpCount);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (followUp.body() instanceof UnrepeatableRequestBody) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HttpRetryException(<span class="string">"Cannot retry streamed HTTP body"</span>, response.code());</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!sameConnection(response, followUp.url())) &#123;</div><div class="line">        streamAllocation.release();</div><div class="line">        streamAllocation = <span class="keyword">new</span> StreamAllocation(</div><div class="line">            <span class="keyword">client</span>.connectionPool(), createAddress(followUp.url()));</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (streamAllocation.stream() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Closing the body of "</span> + response</div><div class="line">            + <span class="string">" didn't close its backing stream. Bad interceptor?"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      request = followUp;</div><div class="line">      priorResponse = response;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Address createAddress(HttpUrl url) &#123;</div><div class="line">    SSLSocketFactory sslSocketFactory = <span class="keyword">null</span>;</div><div class="line">    HostnameVerifier hostnameVerifier = <span class="keyword">null</span>;</div><div class="line">    CertificatePinner certificatePinner = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (url.isHttps()) &#123;</div><div class="line">      sslSocketFactory = <span class="keyword">client</span>.sslSocketFactory();</div><div class="line">      hostnameVerifier = <span class="keyword">client</span>.hostnameVerifier();</div><div class="line">      certificatePinner = <span class="keyword">client</span>.certificatePinner();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Address(url.host(), url.port(), <span class="keyword">client</span>.dns(), <span class="keyword">client</span>.socketFactory(),</div><div class="line">        sslSocketFactory, hostnameVerifier, certificatePinner, <span class="keyword">client</span>.proxyAuthenticator(),</div><div class="line">        <span class="keyword">client</span>.proxy(), <span class="keyword">client</span>.protocols(), <span class="keyword">client</span>.connectionSpecs(), <span class="keyword">client</span>.proxySelector());</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p><code>RetryAndFollowUpInterceptor</code>在<code>intercept()</code>中首先从client取得connection pool，用所请求的URL创建Address对象，并以此创建StreamAllocation对象。</p>
<p>Address描述某一个特定的服务器地址。StreamAllocation对象则用于分配一个到特定的服务器地址的流HttpStream，这个HttpStream可能是从connection pool中取得的之前没有释放的连接，也可能是重新分配的。RetryAndFollowUpInterceptor这里算是为后面的操作准备执行条件StreamAllocation。</p>
<p>随后<code>RetryAndFollowUpInterceptor.intercept()</code>利用Interceptor链中后面的Interceptor来获取网络响应。并检查是否为重定向响应。若不是就将响应返回，若是则做进一步处理。</p>
<p>对于重定向的响应，<code>RetryAndFollowUpInterceptor.intercept()</code>会利用响应的信息创建一个新的请求。并检查新请求的服务器地址与老地址是否相同，若不相同则会根据新的地址创建Address对象及StreamAllocation对象。</p>
<p> <code>RetryAndFollowUpInterceptor</code>对重定向的响应也不会无休止的处理下去，它处理的最多的重定向级数为20次，超过20次时，它会抛异常出来。</p>
<p><code>RetryAndFollowUpInterceptor</code>通过followUpRequest()从响应的信息中提取出重定向的信息，并构造新的网络请求：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Figures out the HTTP request to make in response to receiving &#123;<span class="doctag">@code</span> userResponse&#125;. This will</div><div class="line"> * either add authentication headers, follow redirects or handle a client request timeout. If a</div><div class="line"> * follow-up is either unnecessary or not applicable, this returns null.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> Request followUpRequest(Response userResponse) <span class="keyword">throws</span> IOException &#123;</div><div class="line">  <span class="keyword">if</span> (userResponse == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line">  Connection connection = streamAllocation.connection();</div><div class="line">  Route route = connection != <span class="literal">null</span></div><div class="line">      ? connection.route()</div><div class="line">      : <span class="literal">null</span>;</div><div class="line">  <span class="keyword">int</span> responseCode = userResponse.code();</div><div class="line"></div><div class="line">  <span class="keyword">final</span> String method = userResponse.request().method();</div><div class="line">  <span class="keyword">switch</span> (responseCode) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">HTTP_PROXY_AUTH:</span></div><div class="line">      Proxy selectedProxy = route != <span class="literal">null</span></div><div class="line">          ? route.proxy()</div><div class="line">          : client.proxy();</div><div class="line">      <span class="keyword">if</span> (selectedProxy.type() != Proxy.Type.HTTP) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolException(<span class="string">"Received HTTP_PROXY_AUTH (407) code while not using proxy"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> client.proxyAuthenticator().authenticate(route, userResponse);</div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="string">HTTP_UNAUTHORIZED:</span></div><div class="line">      <span class="keyword">return</span> client.authenticator().authenticate(route, userResponse);</div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="string">HTTP_PERM_REDIRECT:</span></div><div class="line">    <span class="keyword">case</span> <span class="string">HTTP_TEMP_REDIRECT:</span></div><div class="line">      <span class="comment">// "If the 307 or 308 status code is received in response to a request other than GET</span></div><div class="line">      <span class="comment">// or HEAD, the user agent MUST NOT automatically redirect the request"</span></div><div class="line">      <span class="keyword">if</span> (!method.equals(<span class="string">"GET"</span>) &amp;&amp; !method.equals(<span class="string">"HEAD"</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// fall-through</span></div><div class="line">    <span class="keyword">case</span> <span class="string">HTTP_MULT_CHOICE:</span></div><div class="line">    <span class="keyword">case</span> <span class="string">HTTP_MOVED_PERM:</span></div><div class="line">    <span class="keyword">case</span> <span class="string">HTTP_MOVED_TEMP:</span></div><div class="line">    <span class="keyword">case</span> <span class="string">HTTP_SEE_OTHER:</span></div><div class="line">      <span class="comment">// Does the client allow redirects?</span></div><div class="line">      <span class="keyword">if</span> (!client.followRedirects()) <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line"></div><div class="line">      String location = userResponse.header(<span class="string">"Location"</span>);</div><div class="line">      <span class="keyword">if</span> (location == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">      HttpUrl url = userResponse.request().url().resolve(location);</div><div class="line"></div><div class="line">      <span class="comment">// Don't follow redirects to unsupported protocols.</span></div><div class="line">      <span class="keyword">if</span> (url == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line"></div><div class="line">      <span class="comment">// If configured, don't follow redirects between SSL and non-SSL.</span></div><div class="line">      <span class="keyword">boolean</span> sameScheme = url.scheme().equals(userResponse.request().url().scheme());</div><div class="line">      <span class="keyword">if</span> (!sameScheme &amp;&amp; !client.followSslRedirects()) <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line"></div><div class="line">      <span class="comment">// Redirects don't include a request body.</span></div><div class="line">      Request.Builder requestBuilder = userResponse.request().newBuilder();</div><div class="line">      <span class="keyword">if</span> (HttpMethod.permitsRequestBody(method)) &#123;</div><div class="line">        <span class="keyword">if</span> (HttpMethod.redirectsToGet(method)) &#123;</div><div class="line">          requestBuilder.method(<span class="string">"GET"</span>, <span class="literal">null</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          requestBuilder.method(method, <span class="literal">null</span>);</div><div class="line">        &#125;</div><div class="line">        requestBuilder.removeHeader(<span class="string">"Transfer-Encoding"</span>);</div><div class="line">        requestBuilder.removeHeader(<span class="string">"Content-Length"</span>);</div><div class="line">        requestBuilder.removeHeader(<span class="string">"Content-Type"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// When redirecting across hosts, drop all authentication headers. This</span></div><div class="line">      <span class="comment">// is potentially annoying to the application layer since they have no</span></div><div class="line">      <span class="comment">// way to retain them.</span></div><div class="line">      <span class="keyword">if</span> (!sameConnection(userResponse, url)) &#123;</div><div class="line">        requestBuilder.removeHeader(<span class="string">"Authorization"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> requestBuilder.url(url).build();</div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="string">HTTP_CLIENT_TIMEOUT:</span></div><div class="line">      <span class="comment">// 408's are rare in practice, but some servers like HAProxy use this response code. The</span></div><div class="line">      <span class="comment">// spec says that we may repeat the request without modifications. Modern browsers also</span></div><div class="line">      <span class="comment">// repeat the request (even non-idempotent ones.)</span></div><div class="line">      <span class="keyword">if</span> (userResponse.request().body() <span class="keyword">instanceof</span> UnrepeatableRequestBody) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> userResponse.request();</div><div class="line"><span class="symbol"></span></div><div class="line">    default:</div><div class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们知道OkHttp提供了非常好用的容错功能，它可以从某些类型的网络错误中恢复，即出错重试机制。这种出错重试机制主要由recover()来实现：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Report and attempt to recover from a failure to communicate with a server. Returns true if</div><div class="line"> * &#123;<span class="doctag">@code</span> e&#125; is recoverable, or false if the failure is permanent. Requests with a body can only</div><div class="line"> * be recovered if the body is buffered.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">boolean</span> <span class="title">recover</span><span class="params">(IOException e, <span class="keyword">boolean</span> routeException, Request userRequest)</span> </span>&#123;</div><div class="line">  streamAllocation.streamFailed(e);</div><div class="line"></div><div class="line">  <span class="comment">// The application layer has forbidden retries.</span></div><div class="line">  <span class="keyword">if</span> (!client.retryOnConnectionFailure()) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">  <span class="comment">// We can't send the request body again.</span></div><div class="line">  <span class="keyword">if</span> (!routeException &amp;&amp; userRequest.body() <span class="keyword">instanceof</span> UnrepeatableRequestBody) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">  <span class="comment">// This exception is fatal.</span></div><div class="line">  <span class="keyword">if</span> (!isRecoverable(e, routeException)) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">  <span class="comment">// No more routes to attempt.</span></div><div class="line">  <span class="keyword">if</span> (!streamAllocation.hasMoreRoutes()) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">  <span class="comment">// For failure recovery, use the same route selector with a new connection.</span></div><div class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">boolean</span> <span class="title">isRecoverable</span><span class="params">(IOException e, <span class="keyword">boolean</span> routeException)</span> </span>&#123;</div><div class="line">  <span class="comment">// If there was a protocol problem, don't recover.</span></div><div class="line">  <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ProtocolException) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// If there was an interruption don't recover, but if there was a timeout connecting to a route</span></div><div class="line">  <span class="comment">// we should try the next route (if there is one).</span></div><div class="line">  <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InterruptedIOException) &#123;</div><div class="line">    <span class="keyword">return</span> e <span class="keyword">instanceof</span> SocketTimeoutException &amp;&amp; routeException;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Look for known client-side or negotiation errors that are unlikely to be fixed by trying</span></div><div class="line">  <span class="comment">// again with a different route.</span></div><div class="line">  <span class="keyword">if</span> (e <span class="keyword">instanceof</span> SSLHandshakeException) &#123;</div><div class="line">    <span class="comment">// If the problem was a CertificateException from the X509TrustManager,</span></div><div class="line">    <span class="comment">// do not retry.</span></div><div class="line">    <span class="keyword">if</span> (e.getCause() <span class="keyword">instanceof</span> CertificateException) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (e <span class="keyword">instanceof</span> SSLPeerUnverifiedException) &#123;</div><div class="line">    <span class="comment">// e.g. a certificate pinning error.</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// An example of one we might want to retry with a different route is a problem connecting to a</span></div><div class="line">  <span class="comment">// proxy and would manifest as a standard IOException. Unless it is one we know we should not</span></div><div class="line">  <span class="comment">// retry, we return true and try a new route.</span></div><div class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>主要是对某些类型IOException的恢复，恢复的次数会由StreamAllocation控制。</p>
<p>总结一下<code>RetryAndFollowUpInterceptor</code>做的事情：</p>
<ol>
<li>创建StreamAllocation对象，为后面流程的执行准备条件。</li>
<li>处理重定向的HTTP响应。</li>
<li>错误恢复。</li>
</ol>
<h2 id="BridgeInterceptor"><a href="#BridgeInterceptor" class="headerlink" title="BridgeInterceptor"></a>BridgeInterceptor</h2><p>如我们在<code>RealCall.getResponseWithInterceptorChain()</code>中所见，紧接在<code>RetryAndFollowUpInterceptor</code>之后的<code>Interceptor</code>是<code>BridgeInterceptor</code>：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> okhttp3.internal.http;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> okhttp3.Cookie;</div><div class="line"><span class="keyword">import</span> okhttp3.CookieJar;</div><div class="line"><span class="keyword">import</span> okhttp3.Headers;</div><div class="line"><span class="keyword">import</span> okhttp3.Interceptor;</div><div class="line"><span class="keyword">import</span> okhttp3.MediaType;</div><div class="line"><span class="keyword">import</span> okhttp3.Request;</div><div class="line"><span class="keyword">import</span> okhttp3.RequestBody;</div><div class="line"><span class="keyword">import</span> okhttp3.Response;</div><div class="line"><span class="keyword">import</span> okhttp3.internal.Version;</div><div class="line"><span class="keyword">import</span> okio.GzipSource;</div><div class="line"><span class="keyword">import</span> okio.Okio;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> okhttp3.internal.Util.hostHeader;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Bridges from application code to network code. First it builds a network request from a user</div><div class="line"> * request. Then it proceeds to call the network. Finally it builds a user response from the network</div><div class="line"> * response.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> BridgeInterceptor <span class="keyword">implements</span> Interceptor &#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> CookieJar cookieJar;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> BridgeInterceptor(CookieJar cookieJar) &#123;</div><div class="line">    <span class="keyword">this</span>.cookieJar = cookieJar;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override <span class="keyword">public</span> Response intercept(Chain chain) <span class="keyword">throws</span> IOException &#123;</div><div class="line">    Request userRequest = chain.request();</div><div class="line">    Request.Builder requestBuilder = userRequest.newBuilder();</div><div class="line"></div><div class="line">    RequestBody body = userRequest.body();</div><div class="line">    <span class="keyword">if</span> (body != <span class="keyword">null</span>) &#123;</div><div class="line">      MediaType contentType = body.contentType();</div><div class="line">      <span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</div><div class="line">        requestBuilder.header(<span class="string">"Content-Type"</span>, contentType.toString());</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">long</span> contentLength = body.contentLength();</div><div class="line">      <span class="keyword">if</span> (contentLength != -<span class="number">1</span>) &#123;</div><div class="line">        requestBuilder.header(<span class="string">"Content-Length"</span>, <span class="keyword">Long</span>.toString(contentLength));</div><div class="line">        requestBuilder.removeHeader(<span class="string">"Transfer-Encoding"</span>);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        requestBuilder.header(<span class="string">"Transfer-Encoding"</span>, <span class="string">"chunked"</span>);</div><div class="line">        requestBuilder.removeHeader(<span class="string">"Content-Length"</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"Host"</span>) == <span class="keyword">null</span>) &#123;</div><div class="line">      requestBuilder.header(<span class="string">"Host"</span>, hostHeader(userRequest.url(), <span class="keyword">false</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"Connection"</span>) == <span class="keyword">null</span>) &#123;</div><div class="line">      requestBuilder.header(<span class="string">"Connection"</span>, <span class="string">"Keep-Alive"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If we add an "Accept-Encoding: gzip" header field we're responsible for also decompressing</span></div><div class="line">    <span class="comment">// the transfer stream.</span></div><div class="line">    <span class="keyword">boolean</span> transparentGzip = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"Accept-Encoding"</span>) == <span class="keyword">null</span>) &#123;</div><div class="line">      transparentGzip = <span class="keyword">true</span>;</div><div class="line">      requestBuilder.header(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    List&lt;Cookie&gt; cookies = cookieJar.loadForRequest(userRequest.url());</div><div class="line">    <span class="keyword">if</span> (!cookies.isEmpty()) &#123;</div><div class="line">      requestBuilder.header(<span class="string">"Cookie"</span>, cookieHeader(cookies));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"User-Agent"</span>) == <span class="keyword">null</span>) &#123;</div><div class="line">      requestBuilder.header(<span class="string">"User-Agent"</span>, Version.userAgent());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Response networkResponse = chain.proceed(requestBuilder.build());</div><div class="line"></div><div class="line">    HttpHeaders.receiveHeaders(cookieJar, userRequest.url(), networkResponse.headers());</div><div class="line"></div><div class="line">    Response.Builder responseBuilder = networkResponse.newBuilder()</div><div class="line">        .request(userRequest);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (transparentGzip</div><div class="line">        &amp;&amp; <span class="string">"gzip"</span>.equalsIgnoreCase(networkResponse.header(<span class="string">"Content-Encoding"</span>))</div><div class="line">        &amp;&amp; HttpHeaders.hasBody(networkResponse)) &#123;</div><div class="line">      GzipSource responseBody = <span class="keyword">new</span> GzipSource(networkResponse.body().<span class="keyword">source</span>());</div><div class="line">      Headers strippedHeaders = networkResponse.headers().newBuilder()</div><div class="line">          .removeAll(<span class="string">"Content-Encoding"</span>)</div><div class="line">          .removeAll(<span class="string">"Content-Length"</span>)</div><div class="line">          .build();</div><div class="line">      responseBuilder.headers(strippedHeaders);</div><div class="line">      responseBuilder.body(<span class="keyword">new</span> RealResponseBody(strippedHeaders, Okio.buffer(responseBody)));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> responseBuilder.build();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns a 'Cookie' HTTP request header with all cookies, like &#123;@code a=b; c=d&#125;. */</span></div><div class="line">  <span class="keyword">private</span> String cookieHeader(List&lt;Cookie&gt; cookies) &#123;</div><div class="line">    StringBuilder cookieHeader = <span class="keyword">new</span> StringBuilder();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, <span class="keyword">size</span> = cookies.<span class="keyword">size</span>(); i &lt; <span class="keyword">size</span>; i++) &#123;</div><div class="line">      <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</div><div class="line">        cookieHeader.<span class="keyword">append</span>(<span class="string">"; "</span>);</div><div class="line">      &#125;</div><div class="line">      Cookie cookie = cookies.get(i);</div><div class="line">      cookieHeader.<span class="keyword">append</span>(cookie.name()).<span class="keyword">append</span>(<span class="string">'='</span>).<span class="keyword">append</span>(cookie.value());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> cookieHeader.toString();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个Interceptor做的事情比较简单。可以分为发送请求和收到响应两个阶段来看。在发送请求阶段，BridgeInterceptor补全一些http header，这主要包括<code>Content-Type</code>、<code>Content-Length</code>、<code>Transfer-Encoding</code>、<code>Host</code>、<code>Connection</code>、<code>Accept-Encoding</code>、<code>User-Agent</code>，还加载<code>Cookie</code>，随后创建新的Request，并交给后续的Interceptor处理，以获取响应。</p>
<p>而在从后续的Interceptor获取响应之后，会首先保存<code>Cookie</code>。如果服务器返回的响应的content是以gzip压缩过的，则会先进行解压缩，移除响应中的header <code>Content-Encoding</code>和<code>Content-Length</code>，构造新的响应并返回；否则直接返回响应。</p>
<p><code>CookieJar</code>来自于<code>OkHttpClient</code>，它是OkHttp的<code>Cookie</code>管理器，负责<code>Cookie</code>的存取：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">package okhttp3;</div><div class="line"></div><div class="line">import java.util.Collections;</div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Provides &lt;strong&gt;policy&lt;/strong&gt; <span class="keyword">and</span> &lt;strong&gt;persistence&lt;/strong&gt; <span class="keyword">for</span> HTTP cookies.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;As policy, implementations <span class="keyword">of</span> this interface are responsible <span class="keyword">for</span> selecting which cookies <span class="keyword">to</span></div><div class="line"> * accept <span class="keyword">and</span> which <span class="keyword">to</span> reject. A reasonable policy <span class="keyword">is</span> <span class="keyword">to</span> reject all cookies, though <span class="keyword">that</span> may be</div><div class="line"> * interfere <span class="keyword">with</span> session-based authentication schemes <span class="keyword">that</span> require cookies.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;As persistence, implementations <span class="keyword">of</span> this interface must also provide storage <span class="keyword">of</span> cookies. Simple</div><div class="line"> * implementations may store cookies <span class="keyword">in</span> memory; sophisticated ones may use <span class="keyword">the</span> <span class="built_in">file</span> system <span class="keyword">or</span></div><div class="line"> * database <span class="keyword">to</span> hold accepted cookies. The &lt;a</div><div class="line"> * href=<span class="string">"https://tools.ietf.org/html/rfc6265#section-5.3"</span>&gt;cookie storage model&lt;/a&gt; specifies</div><div class="line"> * policies <span class="keyword">for</span> updating <span class="keyword">and</span> expiring cookies.</div><div class="line"> */</div><div class="line">public interface CookieJar &#123;</div><div class="line">  /** A cookie jar <span class="keyword">that</span> never accepts any cookies. */</div><div class="line">  CookieJar NO_COOKIES = new CookieJar() &#123;</div><div class="line">    @Override public void saveFromResponse(HttpUrl url, List&lt;Cookie&gt; cookies) &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override public List&lt;Cookie&gt; loadForRequest(HttpUrl url) &#123;</div><div class="line"><span class="built_in">      return</span> Collections.emptyList();</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Saves &#123;@code cookies&#125; <span class="keyword">from</span> an HTTP response <span class="keyword">to</span> this store according <span class="keyword">to</span> this jar's policy.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;Note <span class="keyword">that</span> this method may be called a <span class="keyword">second</span> <span class="built_in">time</span> <span class="keyword">for</span> a single HTTP response <span class="keyword">if</span> <span class="keyword">the</span> response</div><div class="line">   * includes a trailer. For this obscure HTTP feature, &#123;@code cookies&#125; <span class="keyword">contains</span> only <span class="keyword">the</span> trailer's</div><div class="line">   * cookies.</div><div class="line">   */</div><div class="line">  void saveFromResponse(HttpUrl url, List&lt;Cookie&gt; cookies);</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Load cookies <span class="keyword">from</span> <span class="keyword">the</span> jar <span class="keyword">for</span> an HTTP request <span class="keyword">to</span> &#123;@code url&#125;. This method returns a possibly</div><div class="line">   * empty <span class="built_in">list</span> <span class="keyword">of</span> cookies <span class="keyword">for</span> <span class="keyword">the</span> network request.</div><div class="line">   *</div><div class="line">   * &lt;p&gt;Simple implementations will <span class="literal">return</span> <span class="keyword">the</span> accepted cookies <span class="keyword">that</span> have <span class="keyword">not</span> yet expired <span class="keyword">and</span> <span class="keyword">that</span></div><div class="line">   * &#123;@linkplain Cookie<span class="comment">#matches match&#125; &#123;@code url&#125;.</span></div><div class="line">   */</div><div class="line">  List&lt;Cookie&gt; loadForRequest(HttpUrl url);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由<code>OkHttpClient</code>默认的构造过程可以看到，OkHttp中默认是没有提供Cookie管理功能的。由这里的代码，我们大概也能知道要支持Cookie的话，需要做些什么事情。</p>
<h2 id="CacheInterceptor"><a href="#CacheInterceptor" class="headerlink" title="CacheInterceptor"></a>CacheInterceptor</h2><p>CacheInterceptor紧接于BridgeInterceptor之后，它主要用来处理缓存：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ResponseBody EMPTY_BODY = <span class="keyword">new</span> ResponseBody() &#123;</div><div class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function">MediaType <span class="title">contentType</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function"><span class="keyword">long</span> <span class="title">contentLength</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function">BufferedSource <span class="title">source</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Buffer();</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">final</span> InternalCache cache;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CacheInterceptor</span><span class="params">(InternalCache cache)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.cache = cache;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function">Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Response cacheCandidate = cache != <span class="keyword">null</span></div><div class="line">        ? cache.get(chain.request())</div><div class="line">        : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"></div><div class="line">    CacheStrategy strategy = <span class="keyword">new</span> CacheStrategy.Factory(now, chain.request(), cacheCandidate).get();</div><div class="line">    Request networkRequest = strategy.networkRequest;</div><div class="line">    Response cacheResponse = strategy.cacheResponse;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</div><div class="line">      cache.trackResponse(strategy);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (cacheCandidate != <span class="keyword">null</span> &amp;&amp; cacheResponse == <span class="keyword">null</span>) &#123;</div><div class="line">      closeQuietly(cacheCandidate.body()); <span class="comment">// The cache candidate wasn't applicable. Close it.</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If we're forbidden from using the network and the cache is insufficient, fail.</span></div><div class="line">    <span class="keyword">if</span> (networkRequest == <span class="keyword">null</span> &amp;&amp; cacheResponse == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Response.Builder()</div><div class="line">          .request(chain.request())</div><div class="line">          .protocol(Protocol.HTTP_1_1)</div><div class="line">          .code(<span class="number">504</span>)</div><div class="line">          .message(<span class="string">"Unsatisfiable Request (only-if-cached)"</span>)</div><div class="line">          .body(EMPTY_BODY)</div><div class="line">          .sentRequestAtMillis(<span class="number">-1</span>L)</div><div class="line">          .receivedResponseAtMillis(System.currentTimeMillis())</div><div class="line">          .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If we don't need the network, we're done.</span></div><div class="line">    <span class="keyword">if</span> (networkRequest == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> cacheResponse.newBuilder()</div><div class="line">          .cacheResponse(stripBody(cacheResponse))</div><div class="line">          .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Response networkResponse = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      networkResponse = chain.<span class="keyword">proceed</span>(networkRequest);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      <span class="comment">// If we're crashing on I/O or otherwise, don't leak the cache body.</span></div><div class="line">      <span class="keyword">if</span> (networkResponse == <span class="keyword">null</span> &amp;&amp; cacheCandidate != <span class="keyword">null</span>) &#123;</div><div class="line">        closeQuietly(cacheCandidate.body());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If we have a cache response too, then we're doing a conditional get.</span></div><div class="line">    <span class="keyword">if</span> (cacheResponse != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (validate(cacheResponse, networkResponse)) &#123;</div><div class="line">        Response response = cacheResponse.newBuilder()</div><div class="line">            .headers(combine(cacheResponse.headers(), networkResponse.headers()))</div><div class="line">            .cacheResponse(stripBody(cacheResponse))</div><div class="line">            .networkResponse(stripBody(networkResponse))</div><div class="line">            .build();</div><div class="line">        networkResponse.body().close();</div><div class="line"></div><div class="line">        <span class="comment">// Update the cache after combining headers but before stripping the</span></div><div class="line">        <span class="comment">// Content-Encoding header (as performed by initContentStream()).</span></div><div class="line">        cache.trackConditionalCacheHit();</div><div class="line">        cache.update(cacheResponse, response);</div><div class="line">        <span class="keyword">return</span> response;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        closeQuietly(cacheResponse.body());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Response response = networkResponse.newBuilder()</div><div class="line">        .cacheResponse(stripBody(cacheResponse))</div><div class="line">        .networkResponse(stripBody(networkResponse))</div><div class="line">        .build();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (HttpHeaders.hasBody(response)) &#123;</div><div class="line">      CacheRequest cacheRequest = maybeCache(response, networkResponse.request(), cache);</div><div class="line">      response = cacheWritingResponse(cacheRequest, response);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> response;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>对于<code>CacheInterceptor.intercept(Chain chain)</code>的分析同样可以分为两个阶段，即请求发送阶段和响应获取之后的阶段。这两个阶段由<code>chain.proceed(networkRequest)</code>来分割。</p>
<p>在请求发送阶段，主要是尝试从cache中获取响应，获取成功的话，且响应可用未过期，则响应会被直接返回；否则通过后续的Interceptor来从网络获取，获取到响应之后，若需要缓存的，则缓存起来。</p>
<p>关于HTTP具体的缓存策略这里暂时不再详述。</p>
<p>由<code>RealCall.getResponseWithInterceptorChain()</code>可见CacheInterceptor的cache同样来自于OkHttpClient。OkHttp已经有实现Cache的整套策略，在Cache类，但默认情况下不会被用起来，需要自己在创建OkHttpClient时，手动创建并传给OkHttpClient.Builder。</p>
<h2 id="ConnectInterceptor"><a href="#ConnectInterceptor" class="headerlink" title="ConnectInterceptor"></a>ConnectInterceptor</h2><p>CacheInterceptor接下来是ConnectInterceptor：<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">final</span> OkHttpClient <span class="keyword">client</span>;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> ConnectInterceptor(OkHttpClient <span class="keyword">client</span>) &#123;</div><div class="line">    <span class="keyword">this</span>.<span class="keyword">client</span> = <span class="keyword">client</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override <span class="keyword">public</span> Response intercept(Chain chain) throws IOException &#123;</div><div class="line">    RealInterceptorChain realChain = (RealInterceptorChain) chain;</div><div class="line">    Request request = realChain.request();</div><div class="line">    StreamAllocation streamAllocation = realChain.streamAllocation();</div><div class="line"></div><div class="line">    <span class="comment">// We need the network to satisfy this request. Possibly for validating a conditional GET.</span></div><div class="line">    <span class="keyword">boolean</span> doExtensiveHealthChecks = !request.method().equals(<span class="string">"GET"</span>);</div><div class="line">    HttpStream httpStream = streamAllocation.newStream(<span class="keyword">client</span>, doExtensiveHealthChecks);</div><div class="line">    RealConnection connection = streamAllocation.connection();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> realChain.proceed(request, streamAllocation, httpStream, connection);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个类的定义看上去倒是蛮简洁的。ConnectInterceptor的主要职责是建立与服务器之间的连接，但这个事情它主要是委托给StreamAllocation来完成的。如我们前面看到的，StreamAllocation对象是在RetryAndFollowUpInterceptor中分配的。</p>
<p>ConnectInterceptor通过StreamAllocation创建了HttpStream对象和RealConnection对象，随后便调用了realChain.proceed()，向连接中写入HTTP请求，并从服务器读回响应。</p>
<p>连接建立过程的更多细节我们这里先不详述。</p>
<h2 id="CallServerInterceptor"><a href="#CallServerInterceptor" class="headerlink" title="CallServerInterceptor"></a>CallServerInterceptor</h2><p>ConnectInterceptor之后是CallServerInterceptor，这也是这个链中的最后一个Interceptor，它的主要职责是处理IO：<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">package okhttp3.internal.http;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line">import java.net.ProtocolException;</div><div class="line">import okhttp3.Interceptor;</div><div class="line">import okhttp3.<span class="built_in">Request</span>;</div><div class="line">import okhttp3.<span class="built_in">Response</span>;</div><div class="line">import okhttp3.internal.connection.StreamAllocation;</div><div class="line">import okio.BufferedSink;</div><div class="line">import okio.Okio;</div><div class="line">import okio.Sink;</div><div class="line"></div><div class="line">/** This <span class="keyword">is</span> the last interceptor <span class="keyword">in</span> the chain. It makes a network <span class="keyword">call</span> <span class="keyword">to</span> the <span class="built_in">server</span>. */</div><div class="line"><span class="keyword">public</span> final <span class="keyword">class</span> CallServerInterceptor implements Interceptor &#123;</div><div class="line">  <span class="keyword">private</span> final boolean forWebSocket;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> CallServerInterceptor(boolean forWebSocket) &#123;</div><div class="line">    this.forWebSocket = forWebSocket;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override <span class="keyword">public</span> <span class="built_in">Response</span> intercept(Chain chain) throws IOException &#123;</div><div class="line">    HttpStream httpStream = ((RealInterceptorChain) chain).httpStream();</div><div class="line">    StreamAllocation streamAllocation = ((RealInterceptorChain) chain).streamAllocation();</div><div class="line">    <span class="built_in">Request</span> <span class="built_in">request</span> = chain.<span class="built_in">request</span>();</div><div class="line"></div><div class="line">    long sentRequestMillis = System.currentTimeMillis();</div><div class="line">    httpStream.writeRequestHeaders(<span class="built_in">request</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (HttpMethod.permitsRequestBody(<span class="built_in">request</span>.method()) &amp;&amp; <span class="built_in">request</span>.body() != <span class="literal">null</span>) &#123;</div><div class="line">      Sink requestBodyOut = httpStream.createRequestBody(<span class="built_in">request</span>, <span class="built_in">request</span>.body().contentLength());</div><div class="line">      BufferedSink bufferedRequestBody = Okio.buffer(requestBodyOut);</div><div class="line">      <span class="built_in">request</span>.body().writeTo(bufferedRequestBody);</div><div class="line">      bufferedRequestBody.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    httpStream.finishRequest();</div><div class="line"></div><div class="line">    <span class="built_in">Response</span> <span class="built_in">response</span> = httpStream.readResponseHeaders()</div><div class="line">        .<span class="built_in">request</span>(<span class="built_in">request</span>)</div><div class="line">        .handshake(streamAllocation.connection().handshake())</div><div class="line">        .sentRequestAtMillis(sentRequestMillis)</div><div class="line">        .receivedResponseAtMillis(System.currentTimeMillis())</div><div class="line">        .build();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!forWebSocket || <span class="built_in">response</span>.code() != <span class="number">101</span>) &#123;</div><div class="line">      <span class="built_in">response</span> = <span class="built_in">response</span>.newBuilder()</div><div class="line">          .body(httpStream.openResponseBody(<span class="built_in">response</span>))</div><div class="line">          .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"close"</span>.equalsIgnoreCase(<span class="built_in">response</span>.<span class="built_in">request</span>().header(<span class="string">"Connection"</span>))</div><div class="line">        || <span class="string">"close"</span>.equalsIgnoreCase(<span class="built_in">response</span>.header(<span class="string">"Connection"</span>))) &#123;</div><div class="line">      streamAllocation.noNewStreams();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">int</span> code = <span class="built_in">response</span>.code();</div><div class="line">    <span class="keyword">if</span> ((code == <span class="number">204</span> || code == <span class="number">205</span>) &amp;&amp; <span class="built_in">response</span>.body().contentLength() &gt; <span class="number">0</span>) &#123;</div><div class="line">      throw <span class="keyword">new</span> ProtocolException(</div><div class="line">          <span class="string">"HTTP "</span> + code + <span class="string">" had non-zero Content-Length: "</span> + <span class="built_in">response</span>.body().contentLength());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return <span class="built_in">response</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>CallServerInterceptor</code>首先将http请求头部发给服务器，如果http请求有body的话，会再将body发送给服务器，继而通过<code>httpStream.finishRequest()</code>结束http请求的发送。</p>
<p>随后便是从连接中读取服务器返回的http响应，并构造Response。</p>
<p>如果请求的header或服务器响应的header中，<code>Connection</code>值为<code>close</code>，<code>CallServerInterceptor</code>还会关闭连接。</p>
<p>最后便是返回Response。</p>
<p>总结一下这几个Interceptor的职责：<br>RetryAndFollowUpInterceptor —&gt;创建StreamAllocation对象，处理http的redirect，出错重试。对后续Interceptor的执行的影响：修改request及StreamAllocation。<br>BridgeInterceptor————–&gt;补全缺失的一些http header。对后续Interceptor的执行的影响：修改request。<br>CacheInterceptor————–&gt;处理http缓存。对后续Interceptor的执行的影响：若缓存中有所需请求的响应，则后续Interceptor不再执行。<br>ConnectInterceptor————&gt;借助于前面分配的StreamAllocation对象建立与服务器之间的连接，并选定交互所用的协议是HTTP 1.1还是HTTP 2。对后续Interceptor的执行的影响：创建了httpStream和connection。<br>CallServerInterceptor———–&gt;处理IO，与服务器进行数据交换。对后续Interceptor的执行的影响：为Interceptor链中的最后一个Interceptor，没有后续Interceptor。</p>
<p>End。</p>
</div><div class="tags"><a href="/tags/网络协议/">网络协议</a><a href="/tags/Android开发/">Android开发</a><a href="/tags/源码分析/">源码分析</a></div><div class="post-nav"><a href="/2016/11/16/ChromiumGN构建工具的使用/" class="pre">Chromium GN构建工具的使用</a><a href="/2016/11/14/curl_for_HTTP2_on_ubuntu/" class="next">为curl命令启用HTTP2支持</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android-图形系统/">Android 图形系统</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android-开发/">Android 开发</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/11/android_emulator_dev/">Android 模拟器下载、编译及调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_start_streaming/">live555 源码分析：播放启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_subsession_setup/">live555 源码分析：子会话 SETUP</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/live555_src_analysis_subsession_sdp/">live555 源码分析：子会话 SDP 行生成</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/live555_src_analysis_servermediasession/">live555 源码分析：ServerMediaSession</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/06/live555_src_analysis_rtspserver_arch/">live555 源码分析：RTSPServer 组件结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/live555_src_analysis_play/">live555 源码分析： PLAY 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/live555_src_analysis_setup/">live555 源码分析： SETUP 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/04/live555_src_analysis_describe/">live555 源码分析： DESCRIBE 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/03/live555_src_analysis_rtspserver/">live555 源码分析：RTSPServer</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2016/11/15/OkHttp3-HTTP请求执行流程分析/';
var disqus_title = 'OkHttp3 HTTP请求执行流程分析';
var disqus_url = 'https://www.wolfcstech.com/2016/11/15/OkHttp3-HTTP请求执行流程分析/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>