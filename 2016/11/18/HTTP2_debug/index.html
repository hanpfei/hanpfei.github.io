<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>HTTP/2 流量调试 | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">HTTP/2 流量调试</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">HTTP/2 流量调试</h1><div class="post-meta">Nov 18, 2016<span> | </span><span class="category"><a href="/categories/网络调试/">网络调试</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/11/18/HTTP2_debug/" href="/2016/11/18/HTTP2_debug/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>当前主要可以通过浏览器和Wireshark等工具调试HTTP/2流量。</p>
<h1 id="使用浏览器调试HTTP-2流量"><a href="#使用浏览器调试HTTP-2流量" class="headerlink" title="使用浏览器调试HTTP/2流量"></a>使用浏览器调试HTTP/2流量</h1><p>HTTP/2 引入二进制分帧层（Binary Framing），将每个请求和响应分割为更小的帧，并对它们进行二进制编码。与此同时，HTTP/2 沿用之前 HTTP/1.1中的绝大部分语义，上层应用基本上感知不到 HTTP/2 的存在。通过浏览器提供的网络调试工具我们可以清晰地看到请求和响应的详细信息。</p>
<a id="more"></a>
<p>对于Chromium浏览器，打开”更多工具(L) -&gt; 开发者工具(D)”，然后选中”Network”，并选中要查看的文件，就可以清晰地看到HTTP/2请求及响应的信息了。如：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-af5d812ebf583fa3.png" alt=""></p>
<p>从上图可以看到，HTTP/2资源的内容，与HTTP/1.1资源的内容相比，只有一些细微的变化，如所有的头部字段名都是小写的，引入了以”:”开头的伪首部字段等。</p>
<p>然而，浏览器的调试工具只能看到请求和响应的信息。对于连接建立、数据传输，及流控这样的过程信息，浏览器的调试工具就显得无能为力了。这些更细节的信息可以通过Wireshark来看。</p>
<h1 id="使用-Wireshark-调试-HTTP-2-流量"><a href="#使用-Wireshark-调试-HTTP-2-流量" class="headerlink" title="使用 Wireshark 调试 HTTP/2 流量"></a>使用 Wireshark 调试 HTTP/2 流量</h1><p>尽管HTTP/2规范并没有严格要求只能基于TLS传输HTTP/2流量，然而目前基于TLS传输HTTP/2已然成为事实的标准了。绝大部分提供HTTP/2服务器的网站都基于TLS来提供，常见的客户端浏览器，如Chrome，Firefox更是完全不提供对明文传输的HTTP/2的支持。因而通过Wireshark调试HTTP/2流量最主要的即是解密HTTPS流量，进而借助Wireshark对HTTP/2数据的解析，看到客户端与服务器之间详细的帧交互过程。</p>
<p>Wireshark 的抓包原理是直接读取并分析网卡数据，要想让它解密 HTTPS 流量，有两个办法：1）如果拥有 HTTPS 网站的加密私钥，可以用来解密这个网站的加密流量；2）某些浏览器支持将 TLS 会话中使用的对称加密密钥保存在外部文件中，可供 Wireshark 解密之用。</p>
<h2 id="设置SSLKEYLOGFILE环境变量解密HTTPS流量"><a href="#设置SSLKEYLOGFILE环境变量解密HTTPS流量" class="headerlink" title="设置SSLKEYLOGFILE环境变量解密HTTPS流量"></a>设置<code>SSLKEYLOGFILE</code>环境变量解密HTTPS流量</h2><p>Firefox 和 Chrome 都支持生成上述第二种解密方式所需的文件，具体格式见 <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/Key_Log_Format" target="_blank" rel="external">NSS Key Log Format</a>。但只有设置了系统环境变量<code>SSLKEYLOGFILE</code>，Firefox 和 Chrome 才会生成该文件，它们将这个系统变量的值作为文件保存的路径。先来加上这个环境变量（Ubuntu）：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ mkdir ~/sslkeylogfile &amp;&amp; touch ~/sslkeylogfile/keylogfile<span class="selector-class">.log</span></div><div class="line"></div><div class="line">$ echo -e <span class="string">'\nexport SSLKEYLOGFILE=~/sslkeylogfile/keylogfile.log'</span> &gt;&gt; ~/<span class="selector-class">.bash_profile</span> &amp;&amp; . ~/.bash_profile</div></pre></td></tr></table></figure></p>
<p>接着，通过选择<code>Edit -&gt; Preferences... -&gt; Protocols -&gt; SSL</code>打开Wireshark 的 SSL 配置面板(Ubunut版，Mac版通过<code>Wireshark -&gt; Preferences...</code>打开首选项)，在「(Pre)-Master-Secret log filename」选项中选择<code>SSLKEYLOGFILE</code>文件，或输入该文件的路径。如下图：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-20425d67971ec92b.png" alt="ssl_config.png"></p>
<p>最好将「SSL debug file」也配上，这样解密过程中的日志都会记录下来，便于调试分析。</p>
<p>通过 <strong>终端</strong> 启动 Firefox 或 Chrome（<strong>确保这些浏览器能读取到环境变量</strong>）：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>chromium-browser</div></pre></td></tr></table></figure></p>
<p>这时再访问 HTTPS 网站，<code>sslkeylog.log</code>文件中应该包含浏览器写入的数据。如下面这样：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$ cat ~/sslkeylogfile/keylogfile.log</div><div class="line"></div><div class="line">CLIENT_RANDOM <span class="number">24103980248</span>f266808400da7e48058f6c779b4b98fe8cae45981bafe7502b8ff <span class="number">5e7</span>e3a526fbf8c5a3567758f6aa412ea6c36c52d98e9a3dfde1d16f09714551bc64f62ca3cd9df2448b12dbf995d0b14</div><div class="line">CLIENT_RANDOM <span class="number">31</span>c9cac267465543d6ea1ea358dd41fc9ed02aa8af45b0238b82e50915bc3360 dadf649c846b125dad5b1215e9d45ee34ba5241ecbc4856820ea7843177dc424a575fd788f007241c0252c718426dd92</div><div class="line">CLIENT_RANDOM <span class="number">36</span>b8759c3bbb3df2645382240384675f1615f4a432ca7c58bf142776f752ee05 <span class="number">365</span>c321e8d91834da7e8d44cbb963b2bc1b90f100a50fb7831bd5b9b7ec62d94c9a6de99da78c3c6aac93568cc675113</div><div class="line">CLIENT_RANDOM <span class="number">24</span>a461fc4ae2295b81dc4eab6aff2e520e0fc2623091b249f59bfb46b1c3567d e2c8b46febbb61f0fa3e6a6857cd27fe95aa1a7616a522115488f35f30c3092d05b295cba99429d7c16d857cfb87953e</div><div class="line">CLIENT_RANDOM dcc1b0688d4dd99b3b5a4cacccfb9fa5d4861c439385abfb37cd4f98ed212091 <span class="number">3</span>c6bb8767ddb4e6797880aadf5f59f39edaf15bc17c7a3632603803bffec45239261b9ae87d42495952c86c65158dbb4</div><div class="line">CLIENT_RANDOM c96b42c46769d87fc06884da879a2f274047356ee3516f944aa0f37f72bbed0e <span class="number">758e59</span>ee207ff1667ee6643eb31d62aacb4a3fde3e39ab0654a003b0b015acd7e53de41ea754255e4bade1f25897643a</div><div class="line">CLIENT_RANDOM <span class="number">766</span>c0a2f84030be01513ffff1c36bff61872f0a8e039a40694eeee5b3a65c4ca efbdbc6cafdd32891df40daaa8d2c4778db889512c4e6ccd8a15a7f1e34ab55d7a657021eb9954883dc320cc632e8755</div><div class="line">CLIENT_RANDOM b91cbe5fb40149006dbf95a74f1a8f9f0999a78c27dae42d169ca50521477c2c b3e9963f25598e9841ae58857ce13a891c22275f7f2d5c260446cba7355ccdcf41eeabe8f050350078ffe7a16a7c5219</div><div class="line">CLIENT_RANDOM de8e0dbdc518459724cf5ed3cc09802c96fa558abe7c95ec4f0748700bc3e229 <span class="number">0</span>cda6e9665758c54819cc00a09eb5f4249eb33519a16ae62911ffff090539aebd3138ebb4ee0ba7cab6630b3e255fffc</div><div class="line">CLIENT_RANDOM <span class="number">6798</span>fa4e2396f700f6309d55721badf73081ed2a8066db2f7bf652245c61076c <span class="number">025</span>a4679f2d399433a7dc9604f1b1a970dcc54b6da5166a188b061ece87cac1919e7b56be8455cf24ddffe1083694bb1</div><div class="line">CLIENT_RANDOM d89d9e38c21af551d816f451ac3b25d29899f5623fa375f7c55897c06310e784 e9d56f1b084327850c96e30fa87488e7d83fcca7e5cd2200876aa8354d841d5432f339db04041fda5f79202c528e5399</div><div class="line">CLIENT_RANDOM <span class="number">5</span>db78a4b93747b795867ed5800ed2f0c763d74f40fd9859e358689efcc3082c3 <span class="number">3e8</span>edf030deae2d2ff78858b96d7525527e4bbdffe4caf62014a1977f008a7a9a6e96f08e07624a48ad45d45a3ef13c5</div><div class="line">CLIENT_RANDOM <span class="number">2902990</span>ba00c5ad72fddf9a82fd78bdc40e347d423f5aaff71956780683b4df7 f51e107ad5db85ff16da162abb050482b196ffa0f99c2c1e834b73dd46454d322b53a85c14e5a266e05be20d19b1fd2a</div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>检查无误后，就可以开启 Wireshark，选择合适的网卡开始抓包。为了减少不必要的数据包对我们分析的干扰，我们可以只针对某个域名的TCP 443端口来抓包，以减少抓取的数据包的数量，如：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-c7a4380946f99370.png" alt="Capture Filter"></p>
<p>新版 Wireshark (如我目前在用的Version 2.0.2) 在配置了 TLS 解密后，会自动识别并解析 HTTP/2 流量。访问想要抓包的 HTTP/2 网站，就可以轻松看到想要的 HTTP/2 数据包了。如下图：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-76a735cc794a4722.png" alt="wireshark_http2.png"></p>
<p>这种方法也可以用在解密使用 HTTP/1 的 HTTPS 网站上。</p>
<p>每次都要从终端启动浏览器还是挺麻烦的，我们也可以为GUI设置环境变量，以便于我们不在命令行终端启动浏览器也可以解密HTTPS流量。方法是：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo echo -e <span class="string">'\nexport SSLKEYLOGFILE=~/sslkeylogfile/keylogfile.log'</span> <span class="meta">&gt;&gt; </span>/etc/profile</div></pre></td></tr></table></figure></p>
<p>也可以通过其它任何个人偏好的编辑器为<code>/etc/profile</code>添加<code>export</code>那一行。更新了<code>/etc/profile</code>之后，注销当前登录并重新登录。在GUI中启动chromium浏览器，也可以通过Wireshark解密HTTPS流量了。不过要注意，这个设置对所有用户均全局生效。为了系统安全最好在利用Wireshark调试HTTPS流量之后移除这一设置。</p>
<p>Wireshark就像一副眼镜一样，戴上它之后，可以让我们对网络世界发生的一切看得更加清楚，然而即使有了这样强大好用的工具，要想对协议有真正的理解，仔细地阅读协议规范文件也是必不可少的，关于HTTP/2协议的细节，可以参考<a href="https://www.wolfcstech.com/2016/10/29/http2-spec/">HTTP2规范（RFC7540）</a>、<a href="https://www.wolfcstech.com/2016/10/29/hpack-spec/">HPACK：HTTP/2的首部压缩 (RFC7541)</a>和<a href="https://www.wolfcstech.com/2016/10/29/alpn-spec/">应用层协议协商（ALPN）规范（RFC7301）</a>。</p>
<h2 id="导入服务器私钥解密HTTPS流量"><a href="#导入服务器私钥解密HTTPS流量" class="headerlink" title="导入服务器私钥解密HTTPS流量"></a>导入服务器私钥解密HTTPS流量</h2><p>还可以通过为Wireshark导入服务器RSA私钥来解密HTTPS流量。方法是选择<code>Edit -&gt; Preferences... -&gt; Protocols -&gt; SSL</code>打开Wireshark 的 SSL 配置面板，点击”RSA keys list”后的”Edit…”按钮：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-478ea8593495d286.png" alt="rsa_key_record.png"></p>
<p>添加一个RSA私钥项，输入适当的IP地址，端口，解密后的协议，及私钥文件的路径，其中私钥必须存为 PEM 格式，这种格式的私钥文件类似于下面这样：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">----<span class="params">-BEGIN</span> RSA <span class="keyword">PRIVATE</span> KEY-----</div><div class="line">MIIJKQIBAAKCAgEAw5JweP8ACiLHFAs9syY0yzdjJh3WQntcq1HM9xJXJrHRT1+n</div><div class="line">Als88+bh7HxmYbrYXtZhYEjW00wjmlB1Sy0biX17VS8SY7Ssx7XRRJXtovSd7nc8</div><div class="line">KwZI2Rgh0e7PXCatwhEonCdlEZTEHQ9eTE8Acc9dH0BLml47sEJFxWgBYinCkrWt</div><div class="line">jRMR234CZRRqXUtmFgjUq5DcBignzYTAtzAi/<span class="number">1</span>RxwjuNfYtSw6jx7mNCKt1Np3Bm</div><div class="line"><span class="params">...</span><span class="params">...</span>. some <span class="number">20</span><span class="number">-100</span> lines of base64 encoded <span class="built_in">data</span> <span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span></div><div class="line">+TtJwCHfBRGIyI3hGA1eBa8Lc3nhXPjUwtp7q+<span class="number">2</span>gwpsq/<span class="number">25</span>gt2tiUfSak7frhFal</div><div class="line"><span class="number">9</span>gP00/d9nJXwh2UR3G/oEsXWORfRUVAgjyzhXrrJ+uQJBgUVEZ1D0lI6qfdc</div><div class="line">----<span class="params">-END</span> RSA <span class="keyword">PRIVATE</span> KEY-----</div></pre></td></tr></table></figure></p>
<p>对于nginx服务器来说，通常通过<code>ssl_certificate_key</code>项配置的是站点私钥，这个私钥通常是在申请证书时，通过类似于如下这样的方式产生：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ openssl genrsa <span class="number">4096</span> &gt; domain.<span class="type">key</span></div></pre></td></tr></table></figure></p>
<p>关于私钥格式的更多信息，可以参考<a href="https://wiki.wireshark.org/SSL#Wireshark" target="_blank" rel="external">Wireshark的SSL Wiki</a>。</p>
<p>但这种方法对客户端与服务器协商的加密套件有要求。如果加密套件的密钥交换算法是ECDHE，也就是当前大多数HTTPS流量所选择的算法，则解密HTTPS流量将失败。可以通过Wireshark抓取的TLS握手的<code>Server Hello</code>消息来查看客户端与服务器协商的加密套件：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-1fc6886778b7c893.png" alt="Server Hello.png"></p>
<p>客户端与服务器协商加密套件的过程大体为，客户端在其TLS握手的<code>Client Hello</code>消息的<code>Cipher Suites</code>字段中发送自己支持的加密套件。如通过curl访问http2资源：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>curl --http2 -v <span class="symbol">https:</span>/<span class="regexp">/www.wolfcstech.com/</span></div></pre></td></tr></table></figure></p>
<p>可以看到curl支持的加密套件集：<br><img src="https://www.wolfcstech.com/images/1315506-9762724006f3c3d2.png" alt="client_cipher_suites.png"></p>
<p>对于nginx，我们通过<code>ssl_ciphers</code>选项为其配置加密套件，如：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">	# <span class="selector-tag">https</span>:<span class="comment">//github.com/cloudflare/sslconfig/blob/master/conf</span></div><div class="line"><span class="selector-tag">ssl_ciphers</span>                <span class="selector-tag">EECDH</span>+<span class="selector-tag">CHACHA20</span><span class="selector-pseudo">:EECDH+CHACHA20-draft</span><span class="selector-pseudo">:EECDH+AES128</span><span class="selector-pseudo">:RSA+AES128</span><span class="selector-pseudo">:EECDH+AES256</span><span class="selector-pseudo">:RSA+AES256</span><span class="selector-pseudo">:EECDH+3DES</span><span class="selector-pseudo">:RSA+3DES</span>:!<span class="selector-tag">MD5</span>;</div><div class="line"><span class="selector-tag">ssl_prefer_server_ciphers</span>  <span class="selector-tag">on</span>;</div></pre></td></tr></table></figure></p>
<p>加密套件以”:”分隔。服务器从为其配置的加密套件集中选择排序最靠前的客户端支持的加密套件。对于上面的服务器加密套件集配置，用curl访问服务器，协商出来的加密套件为<code>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)</code>，这种加密套件的密钥交换算法正是ECDHE，也即不支持Wireshark加密的算法。</p>
<p>我们可以通过修改服务器的配置，以便Wireshark可以解密HTTPS流量。修改之后nginx服务器的加密套件配置为：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">	# <span class="selector-tag">https</span>:<span class="comment">//github.com/cloudflare/sslconfig/blob/master/conf</span></div><div class="line"><span class="selector-tag">ssl_ciphers</span>                <span class="selector-tag">EECDH</span>+<span class="selector-tag">CHACHA20</span><span class="selector-pseudo">:EECDH+CHACHA20-draft</span><span class="selector-pseudo">:RSA+AES128</span><span class="selector-pseudo">:EECDH+AES128</span><span class="selector-pseudo">:EECDH+AES256</span><span class="selector-pseudo">:RSA+AES256</span><span class="selector-pseudo">:EECDH+3DES</span><span class="selector-pseudo">:RSA+3DES</span>:!<span class="selector-tag">MD5</span>;</div><div class="line"><span class="selector-tag">ssl_prefer_server_ciphers</span>  <span class="selector-tag">on</span>;</div></pre></td></tr></table></figure></p>
<p>与前面那个配置相比，仅有的改动是对调了<code>RSA+AES128</code>和<code>EECDH+AES128</code>两个加密套件的位置。再次通过curl访问服务器，可以看到HTTP2流量被解密了：<br><img src="https://www.wolfcstech.com/images/1315506-88cc08373bee2950.png" alt="curl_http2.png"><br>这次协商的加密套件为<code>TLS_RSA_WITH_AES_128_GCM_SHA256 (0x009c)</code>，其密钥加密算法为RSA。</p>
<p>不过此时通过chrome浏览器访问网站，就会发现页面已经打不开了，如下图所示：<br><img src="https://www.wolfcstech.com/images/1315506-5ebd6b734aa28bf5.png" alt="cipher_suite_config_error_for_http2.png"></p>
<p>仔细看的话，可以看到<code>ERR_SPDY_INADEQUATE_TRANSPORT_SECURITY</code>。这是由于为了安全性考虑，HTTP/2规范建立了<a href="http://http2.github.io/http2-spec/#BadCipherSuites" target="_blank" rel="external">加密套件黑名单</a>，并强制要求HTTP/2服务不得配置这样的加密套件。Chromium浏览器严格遵守HTTP/2规范，且在TLS协商阶段，服务器选择了加密套件黑名单中的<code>TLS_RSA_WITH_AES_128_GCM_SHA256 (0x009c)</code>，因而连接直接被断开了。通过Wireshark抓包来看：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-2c7fc5a87c6557ec.png" alt="http2_goaway.png"></p>
<p>可见是HTTP2层，在与服务器建立连接之后，浏览器就立即发送<code>GOAWAY</code>帧断开了连接。</p>
<p>然而curl似乎并没有严格遵守HTTP/2规范。</p>
<p>是否可以通过为Wireshark添加RSA私钥解密HTTPS流量的决定性因素，在于客户端与服务器协商的加密套件，而不在于通过HTTPS传输的流量是HTTP/1.1的还是HTTP/2的。不过可以通过这种方法让Wireshark解密的所有加密套件都已经进了HTTP/2规范的加密套件黑名单，因而对于符合规范的HTTP/2流量传输，都是无法通过这种方法来解密流量的。</p>
<h2 id="判断HTTP2是否启用"><a href="#判断HTTP2是否启用" class="headerlink" title="判断HTTP2是否启用"></a>判断HTTP2是否启用</h2><p>如前面所述，在某些情况下，直接解密HTTP/2流量确实是难以实现的。而如果我们的需求仅仅是判断HTTP/2是否启用的话，则还是可以通过Wireshark实现的。</p>
<p>HTTP/2在TCP连接建立完成之后，TLS握手的过程中，会进行协议协商，以确定客户端和服务器之间通信最终所用的应用层协议。这个协议协商协议成为ALPN。ALPN是TLS的特性，客户端的SSL/TLS库及使用SSL/TLS库的模块，如HTTP栈，只要支持这一扩展，在发送Client Hello消息时，就会带上相关消息，如：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-77c5dff03d4e7e02.png" alt="ALPN Extension(Client Hello)"></p>
<p>服务器的SSL/TLS库及Web服务器如果能识别这一扩展，会在Server Hello消息中的相同扩展处放上服务器所选择的用户双方通信的协议标识。如果为服务器配置了支持HTTP/2时，Server Hello消息的ALPN扩展值将为<code>h2</code>，否则将是<code>http/1.1</code>，如：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-1ef3e4bf0fc2538c.png" alt="ALPN Extension(Server Hello)"></p>
<p>因而尽管对于无法解密TLS流的HTTP/2流，在Wireshark中无法查看传输更多的细节过程，但还是可以通过Wireshark抓取到的<code>Server Hello</code>消息的ALPN扩展值判断协议协商的结果。</p>
<p>参考文档：<br><a href="https://wiki.wireshark.org/SSL#Wireshark" target="_blank" rel="external">SSL - The Wireshark Wiki</a><br><a href="http://blog.csdn.net/netwalk/article/details/9455893" target="_blank" rel="external">Ubuntu系统环境变量详解</a><br><a href="https://imququ.com/post/http2-traffic-in-wireshark.html" target="_blank" rel="external">使用 Wireshark 调试 HTTP/2 流量</a><br><a href="https://imququ.com/post/how-to-decrypt-https.html" target="_blank" rel="external">三种解密 HTTPS 流量的方法介绍</a><br><a href="https://www.wolfcstech.com/2016/11/14/curl_for_HTTP2_on_ubuntu/">为curl命令启用HTTP2支持</a></p>
</div><div class="tags"><a href="/tags/HTTP2/">HTTP2</a><a href="/tags/网络调试/">网络调试</a></div><div class="post-nav"><a href="/2016/11/22/Protobuf_Developers_Guide/" class="pre">Protobuf开发者指南</a><a href="/2016/11/18/asymmetric_encryption_and_certificate/" class="next">非对称加密与证书</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">34</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/04/live555_src_analysis_describe/">live555 源码分析： DESCRIBE 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/01/live555_src_analysis_rtsp_rtp_rtcp_wireshark/">Wireshark 抓包分析 RTSP/RTP/RTCP 基本工作过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/01/live555_src_analysis_rtspserver/">live555 源码分析：RTSPServer</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/31/live555_src_analysis_mediaserver/">live555 源码分析：MediaSever</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/30/live555_src_analysis_infrasture/">live555 源码分析：基础设施</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/24/h264_send_with_ortp/">使用 ortp 发送原始 H.264 码流</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/23/h264_play/">原始 H.264 码流播放</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/18/h264_on_rtp/">H.264 视频的 RTP 载荷格式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/12/working/">从工作中得到了什么？</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/03/sdp/">会话描述协议</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2016/11/18/HTTP2_debug/';
var disqus_title = 'HTTP/2 流量调试';
var disqus_url = 'https://www.wolfcstech.com/2016/11/18/HTTP2_debug/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>