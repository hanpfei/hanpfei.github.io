<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>在Android中使用FlatBuffers | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">在Android中使用FlatBuffers</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">在Android中使用FlatBuffers</h1><div class="post-meta">Dec 8, 2016<span> | </span><span class="category"><a href="/categories/Android开发/">Android开发</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/12/08/在Android中使用FlatBuffers/" href="/2016/12/08/在Android中使用FlatBuffers/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><p>先来看一下 <strong>FlatBuffers</strong> 项目已经为我们提供了什么，而我们在将 <strong>FlatBuffers</strong> 用到我们的项目中时又需要做什么的整体流程。如下图：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-5314761d842bf10f.jpg" alt=""></p>
<p>在使用 <strong>FlatBuffers</strong> 时，我们需要以特殊的格式定义我们的结构化数据，保存为 .fbs 文件。<strong>FlatBuffers</strong> 项目为我们提供了编译器，可用于将 .fbs 文件编译为Java文件，C++文件等，以用于我们的项目。<strong>FlatBuffers</strong> 编译器在我们的开发机，比如Ubuntu，Mac上运行。这些源代码文件是基于 <strong>FlatBuffers</strong> 提供的Java库生成的，同时我们也需要利用这个Java库的一些接口来序列化或解析数据。</p>
<a id="more"></a>
<p>我们将 <strong>FlatBuffers</strong> 编译器生成的Java文件及 <strong>FlatBuffers</strong> 的Java库导入我们的项目，就可以用 <strong>FlatBuffers</strong> 来对我们的结构化数据执行序列化和反序列化了。尽管每次手动执行 <strong>FlatBuffers</strong> 编译器生成Java文件非常麻烦，但不像 <strong>Protocol Buffers</strong> 那样，当前还没有Google官方提供的gradle插件可用。不过，我们这边开发了一个简单的 <strong>FlatBuffers</strong> gradle插件，后面会简单介绍一下，欢迎大家使用。</p>
<p>接下来我们更详细地看一下上面流程中的各个部分。</p>
<h1 id="下载、编译-FlatBuffers-编译器"><a href="#下载、编译-FlatBuffers-编译器" class="headerlink" title="下载、编译 FlatBuffers 编译器"></a>下载、编译 <strong>FlatBuffers</strong> 编译器</h1><p>我们可以在如下位置：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/google/</span>flatbuffers<span class="regexp">/releases</span></div></pre></td></tr></table></figure></p>
<p>获取官方发布的打包好的版本。针对Windows平台有编译好的可执行安装文件，对其它平台还是打包的源文件。我们也可以指向clone repo的代码，进行手动编译。这里我们从GitHub上clone代码并手动编译编译器：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ git clone <span class="string">https:</span><span class="comment">//github.com/google/flatbuffers.git</span></div><div class="line">Cloning into <span class="string">'flatbuffers'</span>...</div><div class="line"><span class="string">remote:</span> Counting <span class="string">objects:</span> <span class="number">7340</span>, done.</div><div class="line"><span class="string">remote:</span> Compressing <span class="string">objects:</span> <span class="number">100</span>% (<span class="number">46</span>/<span class="number">46</span>), done.</div><div class="line"><span class="string">remote:</span> Total <span class="number">7340</span> (delta <span class="number">16</span>), reused <span class="number">0</span> (delta <span class="number">0</span>), pack-reused <span class="number">7290</span></div><div class="line">Receiving <span class="string">objects:</span> <span class="number">100</span>% (<span class="number">7340</span><span class="regexp">/7340), 3.64 MiB | 115.00 KiB/</span>s, done.</div><div class="line">Resolving <span class="string">deltas:</span> <span class="number">100</span>% (<span class="number">4692</span>/<span class="number">4692</span>), done.</div><div class="line">Checking connectivity... done.</div></pre></td></tr></table></figure></p>
<p>下载代码之后，我们需要用cmake工具来为flatbuffers生成Makefile文件并编译：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">$ cd flatbuffers/</div><div class="line">$ cmake CMakeLists.txt </div><div class="line">-<span class="ruby">- The C compiler identification is AppleClang <span class="number">7.3</span>.<span class="number">0</span>.<span class="number">7030031</span></span></div><div class="line">-<span class="ruby">- The CXX compiler identification is AppleClang <span class="number">7.3</span>.<span class="number">0</span>.<span class="number">7030031</span></span></div><div class="line">-<span class="ruby">- Check <span class="keyword">for</span> working C <span class="symbol">compiler:</span> /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/cc</span></div><div class="line">-<span class="ruby">- Check <span class="keyword">for</span> working C <span class="symbol">compiler:</span> /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/cc -- works</span></div><div class="line">-<span class="ruby">- Detecting C compiler ABI info</span></div><div class="line">-<span class="ruby">- Detecting C compiler ABI info - done</span></div><div class="line">-<span class="ruby">- Detecting C compile features</span></div><div class="line">-<span class="ruby">- Detecting C compile features - done</span></div><div class="line">-<span class="ruby">- Check <span class="keyword">for</span> working CXX <span class="symbol">compiler:</span> /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/c++</span></div><div class="line">-<span class="ruby">- Check <span class="keyword">for</span> working CXX <span class="symbol">compiler:</span> /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/c++ -- works</span></div><div class="line">-<span class="ruby">- Detecting CXX compiler ABI info</span></div><div class="line">-<span class="ruby">- Detecting CXX compiler ABI info - done</span></div><div class="line">-<span class="ruby">- Detecting CXX compile features</span></div><div class="line">-<span class="ruby">- Detecting CXX compile features - done</span></div><div class="line">-<span class="ruby">- Configuring done</span></div><div class="line">-<span class="ruby">- Generating done</span></div><div class="line">-<span class="ruby">- Build files have been written <span class="symbol">to:</span> /Users/netease/Projects/OpenSource/flatbuffers</span></div><div class="line">$ make &amp;&amp; make install</div></pre></td></tr></table></figure></p>
<p>安装之后执行如下命令以确认已经装好：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ flatc --version</div><div class="line">flatc version <span class="number">1.4</span><span class="number">.0</span> (Dec  <span class="number">7</span> <span class="number">2016</span>)</div></pre></td></tr></table></figure></p>
<p>flatc没有为我们提供 <strong>–help</strong> 选项，不过加了错误的参数时这个工具会为我们展示详细的用法：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">$ flatc --help</div><div class="line">flatc: unknown commandline argument: --help</div><div class="line">usage: flatc [OPTION]... FILE... [-- FILE...]</div><div class="line">  -<span class="ruby">-binary     -b Generate wire format binaries <span class="keyword">for</span> any data definitions.</span></div><div class="line">  -<span class="ruby">-json       -t Generate text output <span class="keyword">for</span> any data definitions.</span></div><div class="line">  -<span class="ruby">-cpp        -c Generate C++ headers <span class="keyword">for</span> tables/structs.</span></div><div class="line">  -<span class="ruby">-go         -g Generate Go files <span class="keyword">for</span> tables/structs.</span></div><div class="line">  -<span class="ruby">-java       -j Generate Java classes <span class="keyword">for</span> tables/structs.</span></div><div class="line">  -<span class="ruby">-js         -s Generate JavaScript code <span class="keyword">for</span> tables/structs.</span></div><div class="line">  -<span class="ruby">-csharp     -n Generate C<span class="comment"># classes for tables/structs.</span></span></div><div class="line">  -<span class="ruby">-python     -p Generate Python files <span class="keyword">for</span> tables/structs.</span></div><div class="line">  -<span class="ruby">-php           Generate PHP files <span class="keyword">for</span> tables/structs.</span></div><div class="line">  -<span class="ruby">o PATH            Prefix PATH to all generated files.</span></div><div class="line">  -<span class="ruby">I PATH            Search <span class="keyword">for</span> includes <span class="keyword">in</span> the specified path.</span></div><div class="line">  -<span class="ruby">M                 Print make rules <span class="keyword">for</span> generated files.</span></div><div class="line">  -<span class="ruby">-version          Print the version number of flatc <span class="keyword">and</span> exit.</span></div><div class="line">  -<span class="ruby">-strict-json      Strict <span class="symbol">JSON:</span> field names must be / will be quoted,</span></div><div class="line">                     no trailing commas in tables/vectors.</div><div class="line">  -<span class="ruby">-allow-non-utf8   Pass non-UTF-<span class="number">8</span> input through parser <span class="keyword">and</span> emit nonstandard</span></div><div class="line">                     \x escapes in JSON. (Default is to raise parse error on</div><div class="line">                     non-UTF-8 input.)</div><div class="line">  -<span class="ruby">-defaults-json    Output fields whose value is the default <span class="keyword">when</span></span></div><div class="line">                     writing JSON</div><div class="line">  -<span class="ruby">-unknown-json     Allow fields <span class="keyword">in</span> JSON that are <span class="keyword">not</span> <span class="keyword">defined</span> <span class="keyword">in</span> the</span></div><div class="line">                     schema. These fields will be discared when generating</div><div class="line">                     binaries.</div><div class="line">  -<span class="ruby">-no-prefix        Don<span class="string">'t prefix enum values with the enum type in C++.</span></span></div><div class="line">  -<span class="ruby"><span class="string">-scoped-enums     Use C++11 style scoped and strongly typed enums.</span></span></div><div class="line">                     also implies --no-prefix.</div><div class="line">  -<span class="ruby"><span class="string">-gen-includes     (deprecated), this is the default behavior.</span></span></div><div class="line">                     If the original behavior is required (no include</div><div class="line">                     statements) use --no-includes.</div><div class="line">  -<span class="ruby"><span class="string">-no-includes      Don'</span>t generate <span class="keyword">include</span> statements <span class="keyword">for</span> included</span></div><div class="line">                     schemas the generated file depends on (C++).</div><div class="line">  -<span class="ruby">-gen-mutable      Generate accessors that can mutate buffers <span class="keyword">in</span>-place.</span></div><div class="line">  -<span class="ruby">-gen-onefile      Generate single output file <span class="keyword">for</span> C<span class="comment">#.</span></span></div><div class="line">  -<span class="ruby">-gen-name-strings Generate type name functions <span class="keyword">for</span> C++.</span></div><div class="line">  -<span class="ruby">-escape-proto-ids Disable appending <span class="string">'_'</span> <span class="keyword">in</span> namespaces names.</span></div><div class="line">  -<span class="ruby">-gen-object-api   Generate an additional object-based API.</span></div><div class="line">  -<span class="ruby">-cpp-ptr-type T   Set object API pointer type (default std::unique_ptr)</span></div><div class="line">  -<span class="ruby">-raw-binary       Allow binaries without file_indentifier to be read.</span></div><div class="line">                     This may crash flatc given a mismatched schema.</div><div class="line">  -<span class="ruby">-proto            Input is a .proto, translate to .fbs.</span></div><div class="line">  -<span class="ruby">-schema           Serialize schemas instead of JSON (use with -b)</span></div><div class="line">  -<span class="ruby">-conform FILE     Specify a schema the following schemas should be</span></div><div class="line">                     an evolution of. Gives errors if not.</div><div class="line">  -<span class="ruby">-conform-includes Include path <span class="keyword">for</span> the schema given with --conform</span></div><div class="line">    PATH             </div><div class="line">FILEs may be schemas, or JSON files (conforming to preceding schema)</div><div class="line">FILEs after the -- must be binary flatbuffer format files.</div><div class="line">Output files are named using the base file name of the input,</div><div class="line">and written to the current directory or the path given by -o.</div><div class="line">example: flatc -c -b schema1.fbs schema2.fbs data.json</div></pre></td></tr></table></figure></p>
<h1 id="创建-fbs-文件"><a href="#创建-fbs-文件" class="headerlink" title="创建 .fbs 文件"></a>创建 .fbs 文件</h1><p>flatc支持将为  <strong>Protocol Buffers</strong> 编写的 .proto 文件转换为 .fbs 文件，如：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ ls</div><div class="line">addressbook<span class="selector-class">.proto</span></div><div class="line">$ flatc --proto addressbook<span class="selector-class">.proto</span> </div><div class="line">$ ls -l</div><div class="line">total <span class="number">16</span></div><div class="line">-rw-r--r--  <span class="number">1</span> netease  staff  <span class="number">431</span> <span class="number">12</span>  <span class="number">7</span> <span class="number">17</span>:<span class="number">21</span> addressbook<span class="selector-class">.fbs</span></div><div class="line">-rw-r--r--@ <span class="number">1</span> netease  staff  <span class="number">486</span> <span class="number">12</span>  <span class="number">1</span> <span class="number">15</span>:<span class="number">18</span> addressbook.proto</div></pre></td></tr></table></figure></p>
<p><strong>Protocol Buffers</strong> 消息文件中的一些写法，<strong>FlatBuffers</strong> 编译器还不能很好的支持，如option java_package，option java_outer_classname，和嵌套类。这里我们基于 <strong>FlatBuffers</strong> 编译器转换的 .proto 文件来获得我们的 .fbs 文件：<br><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">// Generated from addressbook.proto</div><div class="line"></div><div class="line">namespace com.example.tutorial;</div><div class="line"></div><div class="line">enum PhoneType : int &#123;</div><div class="line">  <span class="attribute">MOBILE = 0,</span></div><div class="line">  HOME = 1,</div><div class="line">  WORK = 2,</div><div class="line">&#125;</div><div class="line"></div><div class="line">namespace com.example.tutorial;</div><div class="line"></div><div class="line">table Person &#123;</div><div class="line">  name:string (required);</div><div class="line">  <span class="attribute">id</span>:int;</div><div class="line">  <span class="attribute">email</span>:string;</div><div class="line">  <span class="attribute">phone</span>:[com<span class="variable">.example</span><span class="variable">.tutorial</span><span class="variable">._Person</span><span class="variable">.PhoneNumber</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">namespace com.example.tutorial._Person;</div><div class="line"></div><div class="line">table PhoneNumber &#123;</div><div class="line">  <span class="attribute">number</span>:string (required);</div><div class="line">  <span class="attribute">type</span>:int;</div><div class="line">&#125;</div><div class="line"></div><div class="line">namespace com.example.tutorial;</div><div class="line"></div><div class="line">table AddressBook &#123;</div><div class="line">  <span class="attribute">person</span>:[com<span class="variable">.example</span><span class="variable">.tutorial</span><span class="variable">.Person</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">root_type AddressBook;</div></pre></td></tr></table></figure></p>
<p>可以参考 <a href="https://google.github.io/flatbuffers/flatbuffers_guide_writing_schema.html" target="_blank" rel="external">官方的文档</a> 来了解 .fbs 文件的详细的写法。</p>
<h1 id="编译-fbs-文件"><a href="#编译-fbs-文件" class="headerlink" title="编译 .fbs 文件"></a>编译 .fbs 文件</h1><p>可以通过如下命令编译 .fbs 文件：<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ flatc <span class="comment">--java -o out addressbook.fbs</span></div></pre></td></tr></table></figure></p>
<p>–java用于指定编译的目标编程语言。-o  参数则用于指定输出文件的路径，如过没有提供则将当前目录用作输出目录。<strong>FlatBuffers</strong> 编译器按照为不同的数据结构声明的namespace生成目录结构。对于上面的例子，会生成如下的这些文件：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ find <span class="keyword">out</span></div><div class="line">p.p1 &#123;<span class="symbol">margin:</span> <span class="number">0.0</span>px <span class="number">0.0</span>px <span class="number">0.0</span>px <span class="number">0.0</span>px; <span class="symbol">font:</span> <span class="number">11.0</span>px Menlo&#125;span.s1 &#123;font-variant-<span class="symbol">ligatures:</span> no-common-ligatures&#125;</div><div class="line"></div><div class="line">$ find <span class="keyword">out</span>/</div><div class="line"><span class="keyword">out</span>/</div><div class="line"><span class="keyword">out</span>/<span class="regexp">/com</span></div><div class="line">out/<span class="regexp">/com/example</span></div><div class="line"><span class="keyword">out</span>/<span class="regexp">/com/example</span><span class="regexp">/tutorial</span></div><div class="line">out/<span class="regexp">/com/example</span><span class="regexp">/tutorial/</span>_Person</div><div class="line"><span class="keyword">out</span>/<span class="regexp">/com/example</span><span class="regexp">/tutorial/</span>_Person/PhoneNumber.java</div><div class="line"><span class="keyword">out</span>/<span class="regexp">/com/example</span><span class="regexp">/tutorial/</span>AddressBook.java</div><div class="line"><span class="keyword">out</span>/<span class="regexp">/com/example</span><span class="regexp">/tutorial/</span>Person.java</div><div class="line"><span class="keyword">out</span>/<span class="regexp">/com/example</span><span class="regexp">/tutorial/</span>PhoneType.java</div></pre></td></tr></table></figure></p>
<h1 id="在Android项目中使用-FlatBuffers"><a href="#在Android项目中使用-FlatBuffers" class="headerlink" title="在Android项目中使用 FlatBuffers"></a>在Android项目中使用 <strong>FlatBuffers</strong></h1><p>我们将前面由 .fbs 文件生成的Java文件拷贝到我们的项目中。我们前面提到的，<strong>FlatBuffers</strong> 的Java库比较薄，当前并没有发不到jcenter这样的maven仓库中，因而我们需要将这部分代码也拷贝到我们的额项目中。<strong>FlatBuffers</strong> 的Java库在其repo仓库的 java 目录下。引入这些文件之后，我们的代码结构如下：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-b60d4b8f8ec73a0e.jpg" alt=""></p>
<p>添加访问 <strong>FlatBuffers</strong> 的类：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">package com.netease.volleydemo<span class="comment">;</span></div><div class="line"></div><div class="line">import com.example.tutorial.<span class="keyword">AddressBook;</span></div><div class="line">import com.example.tutorial.Person<span class="comment">;</span></div><div class="line">import com.example.tutorial._Person.PhoneNumber<span class="comment">;</span></div><div class="line">import com.google.flatbuffers.FlatBufferBuilder<span class="comment">;</span></div><div class="line"></div><div class="line">import <span class="keyword">java.nio.ByteBuffer;</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by hanpfei0306 on 16-12-5.</div><div class="line"> */</div><div class="line"></div><div class="line">public class <span class="keyword">AddressBookFlatBuffers </span>&#123;</div><div class="line">    public static <span class="keyword">byte[] </span>encodeTest(String[] names) &#123;</div><div class="line">        FlatBufferBuilder <span class="keyword">builder </span>= new FlatBufferBuilder(<span class="number">0</span>)<span class="comment">;</span></div><div class="line"></div><div class="line">        int[] personOffsets = new int[names.length]<span class="comment">;</span></div><div class="line"></div><div class="line">        for (int i = <span class="number">0</span><span class="comment">; i &lt; names.length; ++ i) &#123;</span></div><div class="line">            int name = <span class="keyword">builder.createString(names[i]);</span></div><div class="line">            int email = <span class="keyword">builder.createString("zhangsan@gmail.com");</span></div><div class="line"></div><div class="line">            int number1 = <span class="keyword">builder.createString("0157-23443276");</span></div><div class="line">            int type1 = <span class="number">1</span><span class="comment">;</span></div><div class="line">            int phoneNumber1 = PhoneNumber.createPhoneNumber(<span class="keyword">builder, </span>number1, type1)<span class="comment">;</span></div><div class="line"></div><div class="line">            int number2 = <span class="keyword">builder.createString("136183667387");</span></div><div class="line">            int type2 = <span class="number">0</span><span class="comment">;</span></div><div class="line">            int phoneNumber2 = PhoneNumber.createPhoneNumber(<span class="keyword">builder, </span>number2, type2)<span class="comment">;</span></div><div class="line"></div><div class="line">            int[] phoneNubers = new int[<span class="number">2</span>]<span class="comment">;</span></div><div class="line">            phoneNubers[<span class="number">0</span>] = phoneNumber1<span class="comment">;</span></div><div class="line">            phoneNubers[<span class="number">1</span>] = phoneNumber2<span class="comment">;</span></div><div class="line"></div><div class="line">            int phoneNumbersPos = Person.createPhoneVector(<span class="keyword">builder, </span>phoneNubers)<span class="comment">;</span></div><div class="line"></div><div class="line">            int person = Person.createPerson(<span class="keyword">builder, </span>name, <span class="number">13958235</span>, email, phoneNumbersPos)<span class="comment">;</span></div><div class="line"></div><div class="line">            personOffsets[i] = person<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">        int persons = <span class="keyword">AddressBook.createPersonVector(builder, </span>personOffsets)<span class="comment">;</span></div><div class="line"></div><div class="line">        <span class="keyword">AddressBook.startAddressBook(builder);</span></div><div class="line">        <span class="keyword">AddressBook.addPerson(builder, </span>persons)<span class="comment">;</span></div><div class="line">        int eab = <span class="keyword">AddressBook.endAddressBook(builder);</span></div><div class="line">        <span class="keyword">builder.finish(eab);</span></div><div class="line">        <span class="keyword">byte[] </span>data = <span class="keyword">builder.sizedByteArray();</span></div><div class="line">        return data<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static <span class="keyword">byte[] </span>encodeTest(String[] names, int times) &#123;</div><div class="line">        for (int i = <span class="number">0</span><span class="comment">; i &lt; times - 1; ++ i) &#123;</span></div><div class="line">            encodeTest(names)<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">        return encodeTest(names)<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static <span class="keyword">AddressBook </span>decodeTest(<span class="keyword">byte[] </span>data) &#123;</div><div class="line">        <span class="keyword">AddressBook </span><span class="keyword">addressBook </span>= null<span class="comment">;</span></div><div class="line">        <span class="keyword">ByteBuffer </span><span class="keyword">byteBuffer </span>= <span class="keyword">ByteBuffer.wrap(data);</span></div><div class="line">        <span class="keyword">addressBook </span>= <span class="keyword">AddressBook.getRootAsAddressBook(byteBuffer);</span></div><div class="line">        return <span class="keyword">addressBook;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static <span class="keyword">AddressBook </span>decodeTest(<span class="keyword">byte[] </span>data, int times) &#123;</div><div class="line">        <span class="keyword">AddressBook </span><span class="keyword">addressBook </span>= null<span class="comment">;</span></div><div class="line">        for (int i = <span class="number">0</span><span class="comment">; i &lt; times; ++ i) &#123;</span></div><div class="line">            <span class="keyword">addressBook </span>= decodeTest(data)<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">        return <span class="keyword">addressBook;</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="使用-flatbuf-gradle-plugin"><a href="#使用-flatbuf-gradle-plugin" class="headerlink" title="使用 flatbuf-gradle-plugin"></a>使用 flatbuf-gradle-plugin</h1><p>我们有开发一个 <strong>FlatBuffers</strong> 的gradle插件，以方便开发，<a href="https://github.com/hanpfei/flatbuffers" target="_blank" rel="external">项目位置</a>。这个插件的设计有参考Google的protobuf-gradle-plugin，功能与用法也与protobuf-gradle-plugin类似。在这个项目中，我们也有为 <strong>FlatBuffers</strong> 的Java库创建一个module。</p>
<h2 id="编译并发布flatbuf-gradle-plugin"><a href="#编译并发布flatbuf-gradle-plugin" class="headerlink" title="编译并发布flatbuf-gradle-plugin"></a>编译并发布flatbuf-gradle-plugin</h2><p>从github上下载代码：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git <span class="keyword">clone</span> <span class="title">https</span>://github.com/hanpfei/flatbuffers.git</div></pre></td></tr></table></figure></p>
<p>然后将代码导入Android Studio，将看到如下的代码结构：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-7c687933f10571d7.jpg" alt=""></p>
<p>app 模块是一个demo程序，flatbuf-gradle-plugin 模块是 <strong>FlatBuffers</strong> 的gradle插件，而flatbuffers模块则是 <strong>FlatBuffers</strong> 的Java库。</p>
<p>为了使用 flatbuf-gradle-plugin，可以将插件发布到本地文件系统。这可以通过修改flatbuf-gradle-plugin/build.gradle来完成，修改 uploadArchives task 的 repository 指向本地文件系统，如：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">uploadArchives &#123;</div><div class="line">    repositories &#123;</div><div class="line">        mavenDeployer &#123;</div><div class="line">            pom<span class="selector-class">.groupId</span> = <span class="string">'com.netease.hearttouch'</span></div><div class="line">            pom<span class="selector-class">.artifactId</span> = <span class="string">'ht-flatbuf-gradle-plugin'</span></div><div class="line">            pom<span class="selector-class">.version</span> = <span class="string">'0.0.1-SNAPSHOT'</span></div><div class="line">            repository(url: <span class="string">'file:///Users/netease/Projects/CorpProjects/ht-flatbuffers/app/plugin'</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>执行uploadArchives task，编译并发布flatbuf-gradle-plugin到本地文件系统。</p>
<h2 id="应用flatbuf-gradle-plugin"><a href="#应用flatbuf-gradle-plugin" class="headerlink" title="应用flatbuf-gradle-plugin"></a>应用flatbuf-gradle-plugin</h2><p>修改应用程序的 build.gradle 以应用<code>flatbuf-gradle-plugin</code>。</p>
<ol>
<li><p>为buildscript添加对<code>flatbuf-gradle-plugin</code>的依赖：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">buildscript</span> &#123;</div><div class="line">    <span class="comment">//目前先发布在本地，后面会通过maven进行引用</span></div><div class="line">    <span class="keyword">repositories</span> &#123;</div><div class="line">        maven &#123;</div><div class="line">            url <span class="string">"file:///Users/netease/Projects/CorpProjects/ht-flatbuffers/app/plugin"</span></div><div class="line">        &#125;</div><div class="line">        jcenter()</div><div class="line">        mavenCentral()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">dependencies</span> &#123;</div><div class="line">        <span class="keyword">classpath</span> <span class="string">'com.netease.hearttouch:ht-flatbuf-gradle-plugin:0.0.1-SNAPSHOT'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在<code>apply plugin: &#39;com.android.application&#39;</code>后面应用flatbuf的plugin：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></div><div class="line">apply <span class="string">plugin:</span> <span class="string">'com.netease.flatbuf'</span></div></pre></td></tr></table></figure>
</li>
<li><p>添加flatbuf块，对flatbuf-gradle-plugin的执行做配置：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">flatbuf &#123;</div><div class="line">    flatc &#123;</div><div class="line">        path = <span class="string">'/usr/local/bin/flatc'</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    generateFlatTasks &#123;</div><div class="line">        all().each &#123; task -&gt;</div><div class="line">            task.builtins &#123;</div><div class="line">                remove java</div><div class="line">            &#125;</div><div class="line">            task.builtins &#123;</div><div class="line">                java &#123; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p><code>flatc</code>块用于配置 <strong>FlatBuffers</strong> 编译器，这里我们指定用我们之前手动编译的编译器。<br><code>task.builtins</code>的块必不可少，这个块用于指定我们要为那些编程语言生成代码，这里我们为Java生成代码。</p>
<ol>
<li>指定 .fbs 文件的路径<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="section">sourceSets</span> &#123;</div><div class="line">    <span class="section">main</span> &#123;</div><div class="line">        <span class="section">flat</span> &#123;</div><div class="line">            <span class="attribute">srcDir</span> <span class="string">'src/main/flat'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>我们将 <strong>FlatBuffers</strong> 的IDL文件放在src/main/flat目录下。</p>
<p>这样我们就不用再那么麻烦每次手动执行flatc了。</p>
<h1 id="FlatBuffers、Protobuf及JSON对比测试"><a href="#FlatBuffers、Protobuf及JSON对比测试" class="headerlink" title="FlatBuffers、Protobuf及JSON对比测试"></a>FlatBuffers、Protobuf及JSON对比测试</h1><p>FlatBuffers相对于Protobuf的表现又如何呢？这里我们用数据说话，对比一下FlatBuffers格式、JSON格式与Protobuf的表现。测试同样用fastjson作为JSON的编码解码工具。</p>
<p>测试用的数据结构所有的数据结构，Protobuf相关的测试代码，及JSON的测试代码同 <a href="http://www.jianshu.com/p/e8712962f0e9" target="_blank" rel="external">在Android中使用Protocol Buffers</a> 一文所述，FlatBuffers的测试代码如上面看到的 <strong>AddressBookFlatBuffers</strong>。</p>
<p>通过如下的这段代码来执行测试：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">class</span> ProtoTestTask <span class="keyword">extends</span> AsyncTask&lt;<span class="keyword">Void</span>, <span class="keyword">Void</span>, <span class="keyword">Void</span>&gt; &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_LEN = <span class="number">8192</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> compress(InputStream is, OutputStream os)</div><div class="line">            <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">        GZIPOutputStream gos = <span class="keyword">new</span> GZIPOutputStream(os);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> <span class="keyword">count</span>;</div><div class="line">        <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER_LEN];</div><div class="line">        <span class="keyword">while</span> ((<span class="keyword">count</span> = is.<span class="keyword">read</span>(data, <span class="number">0</span>, BUFFER_LEN)) != -<span class="number">1</span>) &#123;</div><div class="line">            gos.<span class="keyword">write</span>(data, <span class="number">0</span>, <span class="keyword">count</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        gos.finish();</div><div class="line">        gos.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> getCompressedDataLength(<span class="keyword">byte</span>[] data) &#123;</div><div class="line">        ByteArrayInputStream bais =<span class="keyword">new</span> ByteArrayInputStream(data);</div><div class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            compress(bais, baos);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> baos.toByteArray().length;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> dumpDataLengthInfo(<span class="keyword">byte</span>[] protobufData, String jsonData, <span class="keyword">byte</span>[] flatbufData) &#123;</div><div class="line">        <span class="keyword">int</span> compressedProtobufLength = getCompressedDataLength(protobufData);</div><div class="line">        <span class="keyword">int</span> compressedJSONLength = getCompressedDataLength(jsonData.getBytes());</div><div class="line">        <span class="keyword">int</span> compressedFlatbufLength = getCompressedDataLength(flatbufData);</div><div class="line">        Log.i(TAG, String.format(<span class="string">"%-120s"</span>, <span class="string">"Data length"</span>));</div><div class="line">        Log.i(TAG, String.format(<span class="string">"%-20s%-20s%-20s%-20s%-20s%-20s"</span>, <span class="string">"Protobuf"</span>, <span class="string">"Protobuf (GZIP)"</span>,</div><div class="line">                <span class="string">"JSON"</span>, <span class="string">"JSON (GZIP)"</span>, <span class="string">"Flatbuf"</span>, <span class="string">"Flatbuf (GZIP)"</span>));</div><div class="line">        Log.i(TAG, String.format(<span class="string">"%-20s%-20s%-20s%-20s%-20s%-20s"</span>,</div><div class="line">                String.valueOf(protobufData.length), compressedProtobufLength,</div><div class="line">                String.valueOf(jsonData.getBytes().length), compressedJSONLength,</div><div class="line">                String.valueOf(flatbufData.length), compressedFlatbufLength));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doEncodeTest(String[] names, <span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        <span class="keyword">long</span> startTime = System.nanoTime();</div><div class="line">        <span class="keyword">byte</span>[] protobufData = AddressBookProtobuf.encodeTest(names, <span class="keyword">times</span>);</div><div class="line">        <span class="keyword">long</span> protobufTime = System.nanoTime();</div><div class="line">        protobufTime = protobufTime - startTime;</div><div class="line"></div><div class="line">        startTime = System.nanoTime();</div><div class="line">        String jsonData = AddressBookJson.encodeTest(names, <span class="keyword">times</span>);</div><div class="line">        <span class="keyword">long</span> jsonTime = System.nanoTime();</div><div class="line">        jsonTime = jsonTime - startTime;</div><div class="line"></div><div class="line">        startTime = System.nanoTime();</div><div class="line">        <span class="keyword">byte</span>[] flatbufData = AddressBookFlatBuffers.encodeTest(names, <span class="keyword">times</span>);</div><div class="line">        <span class="keyword">long</span> flatbufTime = System.nanoTime();</div><div class="line">        flatbufTime = flatbufTime - startTime;</div><div class="line"></div><div class="line">        dumpDataLengthInfo(protobufData, jsonData, flatbufData);</div><div class="line"></div><div class="line">        Log.i(TAG, String.format(<span class="string">"%-20s%-20s%-20s%-20s"</span>, <span class="string">"Encode Times"</span>, String.valueOf(<span class="keyword">times</span>),</div><div class="line">                <span class="string">"Names Length"</span>, String.valueOf(names.length)));</div><div class="line"></div><div class="line">        Log.i(TAG, String.format(<span class="string">"%-20s%-20s%-20s%-20s%-20s%-20s"</span>,</div><div class="line">                <span class="string">"ProtobufTime"</span>, String.valueOf(protobufTime),</div><div class="line">                <span class="string">"JsonTime"</span>, String.valueOf(jsonTime),</div><div class="line">                <span class="string">"FlatbufTime"</span>, String.valueOf(flatbufTime)));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doEncodeTest10(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doEncodeTest(TestUtils.sTestNames10, <span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doEncodeTest50(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doEncodeTest(TestUtils.sTestNames50, <span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doEncodeTest100(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doEncodeTest(TestUtils.sTestNames100, <span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doEncodeTest(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doEncodeTest10(<span class="keyword">times</span>);</div><div class="line">        doEncodeTest50(<span class="keyword">times</span>);</div><div class="line">        doEncodeTest100(<span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doDecodeTest(String[] names, <span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        <span class="keyword">byte</span>[] protobufBytes = AddressBookProtobuf.encodeTest(names);</div><div class="line">        ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(protobufBytes);</div><div class="line">        <span class="keyword">long</span> startTime = System.nanoTime();</div><div class="line">        AddressBookProtobuf.decodeTest(bais, <span class="keyword">times</span>);</div><div class="line">        <span class="keyword">long</span> protobufTime = System.nanoTime();</div><div class="line">        protobufTime = protobufTime - startTime;</div><div class="line"></div><div class="line">        String jsonStr = AddressBookJson.encodeTest(names);</div><div class="line">        startTime = System.nanoTime();</div><div class="line">        AddressBookJson.decodeTest(jsonStr, <span class="keyword">times</span>);</div><div class="line">        <span class="keyword">long</span> jsonTime = System.nanoTime();</div><div class="line">        jsonTime = jsonTime - startTime;</div><div class="line"></div><div class="line">        <span class="keyword">byte</span>[] flatbufData = AddressBookFlatBuffers.encodeTest(names);</div><div class="line">        startTime = System.nanoTime();</div><div class="line">        AddressBookFlatBuffers.decodeTest(flatbufData, <span class="keyword">times</span>);</div><div class="line">        <span class="keyword">long</span> flatbufTime = System.nanoTime();</div><div class="line">        flatbufTime = flatbufTime - startTime;</div><div class="line"></div><div class="line">        Log.i(TAG, String.format(<span class="string">"%-20s%-20s%-20s%-20s"</span>, <span class="string">"Decode Times"</span>, String.valueOf(<span class="keyword">times</span>),</div><div class="line">                <span class="string">"Names Length"</span>, String.valueOf(names.length)));</div><div class="line">        Log.i(TAG, String.format(<span class="string">"%-20s%-20s%-20s%-20s%-20s%-20s"</span>,</div><div class="line">                <span class="string">"ProtobufTime"</span>, String.valueOf(protobufTime),</div><div class="line">                <span class="string">"JsonTime"</span>, String.valueOf(jsonTime),</div><div class="line">                <span class="string">"FlatbufTime"</span>, String.valueOf(flatbufTime)));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doDecodeTest10(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doDecodeTest(TestUtils.sTestNames10, <span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doDecodeTest50(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doDecodeTest(TestUtils.sTestNames50, <span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doDecodeTest100(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doDecodeTest(TestUtils.sTestNames100, <span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doDecodeTest(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doDecodeTest10(<span class="keyword">times</span>);</div><div class="line">        doDecodeTest50(<span class="keyword">times</span>);</div><div class="line">        doDecodeTest100(<span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">Void</span> doInBackground(<span class="keyword">Void</span>... params) &#123;</div><div class="line">        TestUtils.initTest();</div><div class="line">        doEncodeTest(<span class="number">5000</span>);</div><div class="line"></div><div class="line">        doDecodeTest(<span class="number">5000</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> onPostExecute(<span class="keyword">Void</span> aVoid) &#123;</div><div class="line">        <span class="keyword">super</span>.onPostExecute(aVoid);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我们执行3组编码测试及3组解码测试。对于编码测试，第一组的单个数据中包含10个Person，第二组的包含50个，第三组的包含100个，然后对每个数据分别执行5000次的编码操作。</p>
<p>对于解码测试，三组中单个数据同样包含10个Person、50个及100个，然后对每个数据分别执行5000次的解码码操作。</p>
<p>在Galaxy Nexus的Android 4.4.4 CM平台上执行上述测试，最终得到如下结果：</p>
<h4 id="编码后数据长度对比-Bytes"><a href="#编码后数据长度对比-Bytes" class="headerlink" title="编码后数据长度对比 (Bytes)"></a>编码后数据长度对比 (Bytes)</h4><table>
<thead>
<tr>
<th>Person个数</th>
<th style="text-align:center">Protobuf</th>
<th>Protobuf（GZIP）</th>
<th style="text-align:right">JSON</th>
<th style="text-align:right">JSON（GZIP）</th>
<th style="text-align:right">Flatbuf</th>
<th style="text-align:right">Flatbuf（GZIP)</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td style="text-align:center">860</td>
<td>288</td>
<td style="text-align:right">1703</td>
<td style="text-align:right">343</td>
<td style="text-align:right">1532</td>
<td style="text-align:right">513</td>
</tr>
<tr>
<td>50</td>
<td style="text-align:center">4300</td>
<td>986</td>
<td style="text-align:right">8463</td>
<td style="text-align:right">1048</td>
<td style="text-align:right">7452</td>
<td style="text-align:right">1814</td>
</tr>
<tr>
<td>100</td>
<td style="text-align:center">8600</td>
<td>1841</td>
<td style="text-align:right">16913</td>
<td style="text-align:right">1918</td>
<td style="text-align:right">14852</td>
<td style="text-align:right">3416</td>
</tr>
</tbody>
</table>
<p>相同的数据，经过编码，在压缩前JSON的数据最长，FlatBuffers的数据长度与JSON的短大概10 ％，而Protobuf的数据长度则大概只有JSON的一半。而在用GZIP压缩后，Protobuf的数据长度与JSON的接近，FlatBuffers的数据长度则接近两者的两倍。</p>
<h4 id="编码性能对比-S"><a href="#编码性能对比-S" class="headerlink" title="编码性能对比 (S)"></a>编码性能对比 (S)</h4><table>
<thead>
<tr>
<th>Person个数</th>
<th>Protobuf</th>
<th>JSON</th>
<th>FlatBuffers</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>6.000</td>
<td>8.952</td>
<td>12.464</td>
</tr>
<tr>
<td>50</td>
<td>26.847</td>
<td>45.782</td>
<td>56.752</td>
</tr>
<tr>
<td>100</td>
<td>50.602</td>
<td>73.688</td>
<td>108.426</td>
</tr>
</tbody>
</table>
<p>编码性能Protobuf相对于JSON有较大幅度的提高，而FlatBuffers则有较大幅度的降低。</p>
<h4 id="解码性能对比-S"><a href="#解码性能对比-S" class="headerlink" title="解码性能对比 (S)"></a>解码性能对比 (S)</h4><table>
<thead>
<tr>
<th>Person个数</th>
<th>Protobuf</th>
<th>JSON</th>
<th>FlatBuffers</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>0.255</td>
<td>10.766</td>
<td>0.014</td>
</tr>
<tr>
<td>50</td>
<td>0.245</td>
<td>51.134</td>
<td>0.014</td>
</tr>
<tr>
<td>100</td>
<td>0.323</td>
<td>101.070</td>
<td>0.006</td>
</tr>
</tbody>
</table>
<p>解码性能方面，Protobuf相对于JSON，有着惊人的提升。Protobuf的解码时间几乎不随着数据长度的增长而有太大的增长，而JSON则随着数据长度的增加，解码所需要的时间也越来越长。而FlatBuffers则由于无需解码，在性能方面相对于前两者更有着非常大的提升。</p>
<h1 id="FlatBuffers-编码原理"><a href="#FlatBuffers-编码原理" class="headerlink" title="FlatBuffers 编码原理"></a>FlatBuffers 编码原理</h1><p>FlatBuffers的Java库只提供了如下的4个类：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">.<span class="regexp">/com/g</span>oogle<span class="regexp">/flatbuffers/</span>Constants.java</div><div class="line">.<span class="regexp">/com/g</span>oogle<span class="regexp">/flatbuffers/</span>FlatBufferBuilder.java</div><div class="line">.<span class="regexp">/com/g</span>oogle<span class="regexp">/flatbuffers/</span>Struct.java</div><div class="line">.<span class="regexp">/com/g</span>oogle<span class="regexp">/flatbuffers/</span>Table.java</div></pre></td></tr></table></figure></p>
<p><strong>Constants</strong> 类定义FlatBuffers中可用的基本原始数据类型的长度：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Constants</span> </span>&#123;</div><div class="line">    <span class="comment">// Java doesn't seem to have these.</span></div><div class="line">    <span class="comment">/** The number of bytes in an `byte`. */</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZEOF_BYTE = <span class="number">1</span>;</div><div class="line">    <span class="comment">/** The number of bytes in a `short`. */</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZEOF_SHORT = <span class="number">2</span>;</div><div class="line">    <span class="comment">/** The number of bytes in an `int`. */</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZEOF_INT = <span class="number">4</span>;</div><div class="line">    <span class="comment">/** The number of bytes in an `float`. */</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZEOF_FLOAT = <span class="number">4</span>;</div><div class="line">    <span class="comment">/** The number of bytes in an `long`. */</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZEOF_LONG = <span class="number">8</span>;</div><div class="line">    <span class="comment">/** The number of bytes in an `double`. */</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZEOF_DOUBLE = <span class="number">8</span>;</div><div class="line">    <span class="comment">/** The number of bytes in a file identifier. */</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FILE_IDENTIFIER_LENGTH = <span class="number">4</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>FlatBufferBuilder</strong> 用于FlatBuffers编码，它会将我们的结构化数据序列化为字节数组。我们借助于 <strong>FlatBufferBuilder</strong> 在 ByteBuffer 中放置基本数据类型的数据、数组、字符串及对象。ByteBuffer 用于处理字节序，在序列化时，它将数据按适当的字节序进行序列化，在发序列化时，它将多个字节转换为适当的数据类型。在 .fbs 文件中定义的 table 和 struct，为它们生成的Java 类会继承 <strong>Table</strong> 和 <strong>Struct</strong>。</p>
<p>在反序列化时，输入的ByteBuffer数据被当作字节数组，Table提供了针对字节数组的操作，生成的Java类负责对这些数据进行解释。对于FlatBuffers编码的数据，无需进行解码，只需进行解释。在编译 .fbs 文件时，每个字段在这段数据中的位置将被确定。每个字段的类型及长度将被硬编码进生成的Java类。</p>
<p> <strong>Struct</strong> 类的代码也比较简洁：<br><figure class="highlight d"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.google.flatbuffers;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</div><div class="line"></div><div class="line"><span class="comment">/// @cond FLATBUFFERS_INTERNAL</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * All structs in the generated code derive from this class, and add their own accessors.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> Struct &#123;</div><div class="line">  <span class="comment">/** Used to hold the position of the `bb` buffer. */</span></div><div class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> bb_pos;</div><div class="line">  <span class="comment">/** The underlying ByteBuffer to hold the data of the Struct. */</span></div><div class="line">  <span class="keyword">protected</span> ByteBuffer bb;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>整体的结构如下图：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-6696c8be5e0ed785.jpg" alt=""></p>
<p>在序列化结构化数据时，我们首先需要创建一个 <strong>FlatBufferBuilder</strong> ，在这个对象的创建过程中会分配或从调用者那里获取 <strong>ByteBuffer</strong>，序列化的数据将保存在这个 <strong>ByteBuffer</strong>中：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Start with a buffer of size `initial_size`, then grow as required.</div><div class="line"> *</div><div class="line"> * @param initial_size The initial size of the internal buffer to use.</div><div class="line"> */</div><div class="line"> public FlatBufferBuilder(int initial_size) &#123;</div><div class="line">     if (initial_size &lt;= <span class="number">0</span>) initial_size = <span class="number">1</span><span class="comment">;</span></div><div class="line">     space = initial_size<span class="comment">;</span></div><div class="line">     <span class="keyword">bb </span>= newByteBuffer(initial_size)<span class="comment">;</span></div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Start with a buffer of 1KiB, then grow as required.</div><div class="line"> */</div><div class="line"> public FlatBufferBuilder() &#123;</div><div class="line">     this(<span class="number">1024</span>)<span class="comment">;</span></div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="comment">/**</span></div><div class="line">  * Alternative constructor allowing reuse of &#123;@link ByteBuffer&#125;s.  The builder</div><div class="line">  * can still grow the buffer as necessary.  User classes should make sure</div><div class="line">  * to call &#123;@link #dataBuffer()&#125; to obtain the resulting encoded message.</div><div class="line">  *</div><div class="line">  * @param existing_bb The byte buffer to reuse.</div><div class="line">  */</div><div class="line"> public FlatBufferBuilder(<span class="keyword">ByteBuffer </span>existing_bb) &#123;</div><div class="line">     init(existing_bb)<span class="comment">;</span></div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="comment">/**</span></div><div class="line">  * Alternative initializer that allows reusing this object on an existing</div><div class="line">  * `ByteBuffer`. This method resets the builder's internal state, but keeps</div><div class="line">  * objects that have been allocated for temporary storage.</div><div class="line">  *</div><div class="line">  * @param existing_bb The byte buffer to reuse.</div><div class="line">  * @return Returns `this`.</div><div class="line">  */</div><div class="line"> public FlatBufferBuilder init(<span class="keyword">ByteBuffer </span>existing_bb)&#123;</div><div class="line">     <span class="keyword">bb </span>= existing_bb<span class="comment">;</span></div><div class="line">     <span class="keyword">bb.clear();</span></div><div class="line">     <span class="keyword">bb.order(ByteOrder.LITTLE_ENDIAN);</span></div><div class="line">     minalign = <span class="number">1</span><span class="comment">;</span></div><div class="line">     space = <span class="keyword">bb.capacity();</span></div><div class="line">     vtable_in_use = <span class="number">0</span><span class="comment">;</span></div><div class="line">     nested = false<span class="comment">;</span></div><div class="line">     finished = false<span class="comment">;</span></div><div class="line">     object_start = <span class="number">0</span><span class="comment">;</span></div><div class="line">     num_vtables = <span class="number">0</span><span class="comment">;</span></div><div class="line">     vector_num_elems = <span class="number">0</span><span class="comment">;</span></div><div class="line">     return this<span class="comment">;</span></div><div class="line"> &#125;</div><div class="line"></div><div class="line"> static <span class="keyword">ByteBuffer </span>newByteBuffer(int capacity) &#123;</div><div class="line">     <span class="keyword">ByteBuffer </span>newbb = <span class="keyword">ByteBuffer.allocate(capacity);</span></div><div class="line">     newbb.<span class="keyword">order(ByteOrder.LITTLE_ENDIAN);</span></div><div class="line">     return newbb<span class="comment">;</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>下面我们更详细地分析基本数据类型数据、数组及对象的序列化过程。ByteBuffer 为小尾端的。</p>
<h2 id="FlatBuffers编码基本数据类型"><a href="#FlatBuffers编码基本数据类型" class="headerlink" title="FlatBuffers编码基本数据类型"></a>FlatBuffers编码基本数据类型</h2><p>FlatBuffer 的基本数据类型主要包括如下这些：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Boolean</span></div><div class="line"><span class="keyword">Byte</span></div><div class="line"><span class="keyword">Short</span></div><div class="line"><span class="keyword">Int</span></div><div class="line"><span class="keyword">Long</span></div><div class="line"><span class="keyword">Float</span></div><div class="line"><span class="keyword">Double</span></div></pre></td></tr></table></figure></p>
<p> <strong>FlatBufferBuilder</strong> 提供了三组方法用于操作这些数据：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">putBoolean</span><span class="params">(<span class="keyword">boolean</span> x)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">putByte</span>   <span class="params">(<span class="keyword">byte</span>    x)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">putShort</span>  <span class="params">(<span class="keyword">short</span>   x)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">putInt</span>    <span class="params">(<span class="keyword">int</span>     x)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">putLong</span>   <span class="params">(<span class="keyword">long</span>    x)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">putFloat</span>  <span class="params">(<span class="keyword">float</span>   x)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">putDouble</span> <span class="params">(<span class="keyword">double</span>  x)</span></span>;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addBoolean</span><span class="params">(<span class="keyword">boolean</span> x)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addByte</span>   <span class="params">(<span class="keyword">byte</span>    x)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addShort</span>  <span class="params">(<span class="keyword">short</span>   x)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addInt</span>    <span class="params">(<span class="keyword">int</span>     x)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addLong</span>   <span class="params">(<span class="keyword">long</span>    x)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addFloat</span>  <span class="params">(<span class="keyword">float</span>   x)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addDouble</span> <span class="params">(<span class="keyword">double</span>  x)</span></span>;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addBoolean</span><span class="params">(<span class="keyword">int</span> o, <span class="keyword">boolean</span> x, <span class="keyword">boolean</span> d)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addByte</span><span class="params">(<span class="keyword">int</span> o, <span class="keyword">byte</span> x, <span class="keyword">int</span> d)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addShort</span><span class="params">(<span class="keyword">int</span> o, <span class="keyword">short</span> x, <span class="keyword">int</span> d)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addInt</span>    <span class="params">(<span class="keyword">int</span> o, <span class="keyword">int</span>     x, <span class="keyword">int</span>     d)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addLong</span>   <span class="params">(<span class="keyword">int</span> o, <span class="keyword">long</span>    x, <span class="keyword">long</span>    d)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addFloat</span>  <span class="params">(<span class="keyword">int</span> o, <span class="keyword">float</span>   x, <span class="keyword">double</span>  d)</span></span>;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addDouble</span> <span class="params">(<span class="keyword">int</span> o, <span class="keyword">double</span>  x, <span class="keyword">double</span>  d)</span></span>;</div></pre></td></tr></table></figure></p>
<p>putXXX 那一组，直接地将一个数据放入 ByteBuffer 中，它们的实现基本如下面这样：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">putBoolean</span><span class="params">(<span class="keyword">boolean</span> x)</span> </span>&#123;</div><div class="line">    bb.put(space -= Constants.SIZEOF_BYTE, (<span class="keyword">byte</span>) (x ? <span class="number">1</span> : 0));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">putByte</span><span class="params">(<span class="keyword">byte</span> x)</span> </span>&#123;</div><div class="line">    bb.put(space -= Constants.SIZEOF_BYTE, x);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">putShort</span><span class="params">(<span class="keyword">short</span> x)</span> </span>&#123;</div><div class="line">    bb.putShort(space -= Constants.SIZEOF_SHORT, x);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Boolean值会被先转为byte类型再放入 ByteBuffer。另外一点值得注意的是，数据是从 ByteBuffer 的结尾处开始放置的，space用于记录最近放入的数据的位置及剩余的空间。</p>
<p>addXXX(XXX x) 那一组在放入数据之前会先做对齐处理，并在需要时扩展 ByteBuffer 的容量：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">static</span> ByteBuffer growByteBuffer(ByteBuffer bb) &#123;</div><div class="line">     <span class="keyword">int</span> old_buf_size = bb.capacity();</div><div class="line">     <span class="built_in">if</span> ((old_buf_size &amp; <span class="number">0xC0000000</span>) != <span class="number">0</span>)  <span class="comment">// Ensure we don't grow beyond what fits in an int.</span></div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"FlatBuffers: cannot grow buffer beyond 2 gigabytes."</span>);</div><div class="line">     <span class="keyword">int</span> new_buf_size = old_buf_size &lt;&lt; <span class="number">1</span>;</div><div class="line">     bb.<span class="built_in">position</span>(<span class="number">0</span>);</div><div class="line">     ByteBuffer nbb = newByteBuffer(new_buf_size);</div><div class="line">     nbb.<span class="built_in">position</span>(new_buf_size - old_buf_size);</div><div class="line">     nbb.<span class="built_in">put</span>(bb);</div><div class="line">     <span class="built_in">return</span> nbb;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> pad(<span class="keyword">int</span> byte_size) &#123;</div><div class="line">    <span class="built_in">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; byte_size; i++) bb.<span class="built_in">put</span>(--space, (<span class="keyword">byte</span>) <span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"> <span class="keyword">public</span> <span class="keyword">void</span> prep(<span class="keyword">int</span> <span class="built_in">size</span>, <span class="keyword">int</span> additional_bytes) &#123;</div><div class="line">     <span class="comment">// Track the biggest thing we've ever aligned to.</span></div><div class="line">     <span class="built_in">if</span> (<span class="built_in">size</span> &gt; minalign) minalign = <span class="built_in">size</span>;</div><div class="line">     <span class="comment">// Find the amount of alignment needed such that `size` is properly</span></div><div class="line">     <span class="comment">// aligned after `additional_bytes`</span></div><div class="line">     <span class="keyword">int</span> align_size = ((~(bb.capacity() - space + additional_bytes)) + <span class="number">1</span>) &amp; (<span class="built_in">size</span> - <span class="number">1</span>);</div><div class="line">     <span class="comment">// Reallocate the buffer if needed.</span></div><div class="line">     <span class="built_in">while</span> (space &lt; align_size + <span class="built_in">size</span> + additional_bytes) &#123;</div><div class="line">         <span class="keyword">int</span> old_buf_size = bb.capacity();</div><div class="line">         bb = growByteBuffer(bb);</div><div class="line">         space += bb.capacity() - old_buf_size;</div><div class="line">     &#125;</div><div class="line">     pad(align_size);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="keyword">public</span> <span class="keyword">void</span> addBoolean(<span class="keyword">boolean</span> x) &#123;</div><div class="line">     prep(Constants.SIZEOF_BYTE, <span class="number">0</span>);</div><div class="line">     putBoolean(x);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="keyword">public</span> <span class="keyword">void</span> addInt(<span class="keyword">int</span> x) &#123;</div><div class="line">     prep(Constants.SIZEOF_INT, <span class="number">0</span>);</div><div class="line">     putInt(x);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>对齐是数据存放的起始位置相对于ByteBuffer的结束位置的对齐，additional bytes被认为是不需要对齐的，且在必要的时候会在ByteBuffer可用空间的结尾处填充值为0的字节。在扩展 ByteBuffer 的空间时，老的ByteBuffer被放在新ByteBuffer的结尾处。</p>
<p>addXXX(int o, XXX x, YYY y) 这一组方法在放入数据之后，会将 vtable 中对应位置的值更新为最近放入的数据的offset。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addShort</span><span class="params">(<span class="keyword">int</span> o, <span class="keyword">short</span> x, <span class="keyword">int</span> d)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (force_defaults || x != d) &#123;</div><div class="line">        addShort(x);</div><div class="line">        slot(o);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">slot</span><span class="params">(<span class="keyword">int</span> voffset)</span> </span>&#123;</div><div class="line">    vtable[voffset] = offset();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>后面我们在分析编码对象时再来详细地了解vtable。</p>
<p>基本上，在我们的应用程序代码中不要直接调用这些方法，它们主要在构造对象时用于存储对象的基本数据类型字段。</p>
<h2 id="FlatBuffers编码数组"><a href="#FlatBuffers编码数组" class="headerlink" title="FlatBuffers编码数组"></a>FlatBuffers编码数组</h2><p>编码数组的过程如下：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-75aefc809e8aaa89.jpg" alt="Encode vector"></p>
<p>先执行 startVector()，这个方法会记录数组的长度，处理元素的对齐，准备足够的空间，并设置nested，用于指示记录的开始。<br>然后逐个添加元素。<br>最后 执行 endVector()，将nested复位，并记录数组的长度。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">startVector</span><span class="params">(<span class="keyword">int</span> elem_size, <span class="keyword">int</span> num_elems, <span class="keyword">int</span> alignment)</span> </span>&#123;</div><div class="line">    notNested();</div><div class="line">    vector_num_elems = num_elems;</div><div class="line">    prep(SIZEOF_INT, elem_size * num_elems);</div><div class="line">    prep(alignment, elem_size * num_elems); <span class="comment">// Just in case alignment &gt; int.</span></div><div class="line">    nested = <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">endVector</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!nested)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"FlatBuffers: endVector called without startVector"</span>);</div><div class="line">    nested = <span class="keyword">false</span>;</div><div class="line">    putInt(vector_num_elems);</div><div class="line">    <span class="function"><span class="keyword">return</span> <span class="title">offset</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们前面的AddressBook例子中有如下这样的生成代码：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">int</span> <span class="title">createPersonVector</span><span class="params">(FlatBufferBuilder builder, <span class="keyword">int</span>[] data)</span> </span>&#123;</div><div class="line">  builder.startVector(<span class="number">4</span>, data.length, <span class="number">4</span>);</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = data.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) builder.addOffset(data[i]);</div><div class="line">  <span class="function"><span class="keyword">return</span> builder.<span class="title">endVector</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编码后的数组将有如下的内存分布：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-e4bd7955764cf949.jpg" alt="Encoded Vector"></p>
<p>其中的Vector Length为4字节的int型值。</p>
<h2 id="FlatBuffers编码字符串"><a href="#FlatBuffers编码字符串" class="headerlink" title="FlatBuffers编码字符串"></a>FlatBuffers编码字符串</h2><p> <strong>FlatBufferBuilder</strong> 创建字符串的过程如下：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">createString</span><span class="params">(CharSequence s)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> length = s.length();</div><div class="line">    <span class="keyword">int</span> estimatedDstCapacity = (<span class="keyword">int</span>) (length * encoder.maxBytesPerChar());</div><div class="line">    <span class="keyword">if</span> (dst == <span class="keyword">null</span> || dst.capacity() &lt; estimatedDstCapacity) &#123;</div><div class="line">        dst = ByteBuffer.allocate(Math.max(<span class="number">128</span>, estimatedDstCapacity));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    dst.clear();</div><div class="line"></div><div class="line">    CharBuffer src = s <span class="keyword">instanceof</span> CharBuffer ? (CharBuffer) s :</div><div class="line">        CharBuffer.wrap(s);</div><div class="line">    CoderResult result = encoder.encode(src, dst, <span class="keyword">true</span>);</div><div class="line">    <span class="keyword">if</span> (result.isError()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            result.throwException();</div><div class="line">        &#125; <span class="keyword">catch</span> (CharacterCodingException x) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    dst.flip();</div><div class="line">    <span class="function"><span class="keyword">return</span> <span class="title">createString</span><span class="params">(dst)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">createString</span><span class="params">(ByteBuffer s)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> length = s.remaining();</div><div class="line">    addByte((<span class="keyword">byte</span>)<span class="number">0</span>);</div><div class="line">    startVector(<span class="number">1</span>, length, <span class="number">1</span>);</div><div class="line">    bb.position(space -= length);</div><div class="line">    bb.put(s);</div><div class="line">    <span class="function"><span class="keyword">return</span> <span class="title">endVector</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">createByteVector</span><span class="params">(<span class="keyword">byte</span>[] arr)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> length = arr.length;</div><div class="line">    startVector(<span class="number">1</span>, length, <span class="number">1</span>);</div><div class="line">    bb.position(space -= length);</div><div class="line">    bb.put(arr);</div><div class="line">    <span class="function"><span class="keyword">return</span> <span class="title">endVector</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编码字符串的过程如下：</p>
<ol>
<li>对字符串进行编码，比如 UTF-8 ，编码后的数据保存在另一个 ByteBuffer 中。</li>
<li>在可用空间的结尾处添加值为 0 的byte。</li>
<li>将第 1 步中创建的 ByteBuffer 作为一个字节数组添加到 <strong>FlatBufferBuilder</strong> 的 ByteBuffer 中。这里不是逐个元素，也就是字节，添加，而是将 ByteBuffer 整体一次性添加，以保证字符串中各个字节的相对顺序不会被颠倒过来，这一点与我们前面在AddressBook 中看到的稍有区别。</li>
</ol>
<p>编码后的字符串将有如下的内存分布：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-c4038fa7add1b462.jpg" alt="Encoded String"></p>
<h2 id="FlatBuffers编码对象"><a href="#FlatBuffers编码对象" class="headerlink" title="FlatBuffers编码对象"></a>FlatBuffers编码对象</h2><p>对象的编码与数组的编码有点类似。编码对象的过程为：</p>
<ol>
<li>先执行 startObject()，创建 vtable并初始化，记录对象的字段个数及对象数据的起始位置，并设置nested，指示对象编码的开始。</li>
<li>然后为对象逐个添加每个字段的值。</li>
<li>最后执行 endObject() 结束对象的编码。<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">startObject</span><span class="params">(<span class="keyword">int</span> numfields)</span> </span>&#123;</div><div class="line">    notNested();</div><div class="line">    <span class="keyword">if</span> (vtable == <span class="keyword">null</span> || vtable.length &lt; numfields) vtable = <span class="keyword">new</span> <span class="keyword">int</span>[numfields];</div><div class="line">    vtable_in_use = numfields;</div><div class="line">    Arrays.fill(vtable, <span class="number">0</span>, vtable_in_use, <span class="number">0</span>);</div><div class="line">    nested = <span class="keyword">true</span>;</div><div class="line">    object_start = offset();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">endObject</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (vtable == <span class="keyword">null</span> || !nested)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"FlatBuffers: endObject called without startObject"</span>);</div><div class="line">    addInt(<span class="number">0</span>);</div><div class="line">    <span class="keyword">int</span> vtableloc = offset();</div><div class="line">    <span class="comment">// Write out the current vtable.</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = vtable_in_use - <span class="number">1</span>; i &gt;= <span class="number">0</span> ; i--) &#123;</div><div class="line">        <span class="comment">// Offset relative to the start of the table.</span></div><div class="line">        <span class="keyword">short</span> off = (<span class="keyword">short</span>)(vtable[i] != <span class="number">0</span> ? vtableloc - vtable[i] : 0);</div><div class="line">        addShort(off);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> standard_fields = <span class="number">2</span>; <span class="comment">// The fields below:</span></div><div class="line">    addShort((<span class="keyword">short</span>)(vtableloc - object_start));</div><div class="line">    addShort((<span class="keyword">short</span>)((vtable_in_use + standard_fields) * SIZEOF_SHORT));</div><div class="line"></div><div class="line">    <span class="comment">// Search for an existing vtable that matches the current one.</span></div><div class="line">    <span class="keyword">int</span> existing_vtable = <span class="number">0</span>;</div><div class="line">    outer_loop:</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = 0; i &lt; num_vtables; i++) &#123;</div><div class="line">        <span class="keyword">int</span> vt1 = bb.capacity() - vtables[i];</div><div class="line">        <span class="keyword">int</span> vt2 = space;</div><div class="line">        <span class="keyword">short</span> len = bb.getShort(vt1);</div><div class="line">        <span class="keyword">if</span> (len == bb.getShort(vt2)) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = SIZEOF_SHORT; j &lt; len; j += SIZEOF_SHORT) &#123;</div><div class="line">                <span class="keyword">if</span> (bb.getShort(vt1 + j) != bb.getShort(vt2 + j)) &#123;</div><div class="line">                    <span class="keyword">continue</span> outer_loop;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            existing_vtable = vtables[i];</div><div class="line">            <span class="keyword">break</span> outer_loop;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (existing_vtable != <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// Found a match:</span></div><div class="line">        <span class="comment">// Remove the current vtable.</span></div><div class="line">        space = bb.capacity() - vtableloc;</div><div class="line">        <span class="comment">// Point table to existing vtable.</span></div><div class="line">        bb.putInt(space, existing_vtable - vtableloc);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// No match:</span></div><div class="line">        <span class="comment">// Add the location of the current vtable to the list of vtables.</span></div><div class="line">        <span class="keyword">if</span> (num_vtables == vtables.length) vtables = Arrays.copyOf(vtables, num_vtables * <span class="number">2</span>);</div><div class="line">        vtables[num_vtables++] = offset();</div><div class="line">        <span class="comment">// Point table to current vtable.</span></div><div class="line">        bb.putInt(bb.capacity() - vtableloc, offset() - vtableloc);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    nested = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">return</span> vtableloc;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>结束对象编码的过程比较有意思：</p>
<ol>
<li>在可用空间的结尾处添加值为 0 的int。</li>
<li>记录下当前的offset值 vtableloc，也就是 ByteBuffer中已经保存的数据的长度。</li>
<li>编码vtable。vtable用于记录对象每个字段的存储位置，在为对象添加字段时会被更新。在这里会用 vtableloc - vtable[i]，找到每个对象的保存位置相对于对象起始位置的偏移，并将这个偏移量保存到ByteBuffer中。</li>
<li>记录对象所有字段的总长度，包含对象开始初值为0的int数据。</li>
<li>记录元数据的长度。这包括vtable的长度，记录 对象所有字段的总长度 的short型值，以及这个长度本身所消耗的存储空间。</li>
<li>查找是否有一个vtable与正在创建的这个一致。</li>
<li>找到了匹配的vtable，则清除创建的元数据。第 1 步中放0的那个位置的值，被更新为找到的vtable相对于对象的数据起始位置的偏移。</li>
<li>没有找到匹配的vtable。记下vtable的位置，第 1 步中放0的那个位置的值，被更新为新创建的vtable相对于对象的数据起始位置的偏移。</li>
</ol>
<p>就像C++中的vtable，这里的vtable也是针对类创建的，而不是对象。</p>
<p>编码后的对象有如下的内存分布：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-3e932cbec3515261.jpg" alt="Encoded"></p>
<p>图中值为0的那个位置的值实际不是0，它指向vtable，图中是指向在创建对象时创建的vtable，但它也可以相同类已经存在的vtable。</p>
<h2 id="结束编码"><a href="#结束编码" class="headerlink" title="结束编码"></a>结束编码</h2><p>编码数据之后，需要执行 FlatBufferBuilder 的 finish() 结束编码：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">offset</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> bb.capacity() - space;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addOffset</span><span class="params">(<span class="keyword">int</span> off)</span> </span>&#123;</div><div class="line">    prep(SIZEOF_INT, <span class="number">0</span>);  <span class="comment">// Ensure alignment is already done.</span></div><div class="line">    <span class="keyword">assert</span> off &lt;= offset();</div><div class="line">    off = offset() - off + SIZEOF_INT;</div><div class="line">    putInt(off);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">finish</span><span class="params">(<span class="keyword">int</span> root_table)</span> </span>&#123;</div><div class="line">    prep(minalign, SIZEOF_INT);</div><div class="line">    addOffset(root_table);</div><div class="line">    bb.position(space);</div><div class="line">    finished = <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">finish</span><span class="params">(<span class="keyword">int</span> root_table, String file_identifier)</span> </span>&#123;</div><div class="line">    prep(minalign, SIZEOF_INT + FILE_IDENTIFIER_LENGTH);</div><div class="line">    <span class="keyword">if</span> (file_identifier.length() != FILE_IDENTIFIER_LENGTH)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"FlatBuffers: file identifier must be length "</span> +</div><div class="line">                                 FILE_IDENTIFIER_LENGTH);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = FILE_IDENTIFIER_LENGTH - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        addByte((<span class="keyword">byte</span>)file_identifier.charAt(i));</div><div class="line">    &#125;</div><div class="line">    finish(root_table);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法主要是记录根对象的位置。给 <strong>finish()</strong> 传入的的根对象的位置是相对于ByteBuffer结尾处的偏移，但是在 addOffset() 中，这个偏移会被转换为相对于整个数据块开始处的偏移。计算off值时，最后加的SIZEOF_INT是要给后面放入的off留出空间。</p>
<p>整个编码后的数据有如下的内存分布：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-9cd4c809e7c8da16.jpg" alt="Encoded data"></p>
<h1 id="FlatBuffers-解码原理"><a href="#FlatBuffers-解码原理" class="headerlink" title="FlatBuffers 解码原理"></a>FlatBuffers 解码原理</h1><p>这里我们通过一个生成的比较简单的类 PhoneNumber 来了解FlatBuffers的解码。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">PhoneNumber <span class="title">getRootAsPhoneNumber</span><span class="params">(ByteBuffer _bb)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> getRootAsPhoneNumber(_bb, <span class="keyword">new</span> PhoneNumber());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">PhoneNumber <span class="title">getRootAsPhoneNumber</span><span class="params">(ByteBuffer _bb, PhoneNumber obj)</span> </span>&#123;</div><div class="line">    _bb.order(ByteOrder.LITTLE_ENDIAN);</div><div class="line">    <span class="keyword">return</span> (obj.__assign(_bb.getInt(_bb.position()) + _bb.position(), _bb));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">__init</span><span class="params">(<span class="keyword">int</span> _i, ByteBuffer _bb)</span> </span>&#123;</div><div class="line">    bb_pos = _i;</div><div class="line">    bb = _bb;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function">PhoneNumber <span class="title">__assign</span><span class="params">(<span class="keyword">int</span> _i, ByteBuffer _bb)</span> </span>&#123;</div><div class="line">    __init(_i, _bb);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>创建对象的时候，会初始化 bb 为保存有对象数据的ByteBuffer，bb_pos 为对象数据在ByteBuffer中的偏移。在 getRootAsPhoneNumber() 中会从 ByteBuffer的position处获取根对象的偏移，并加上position，以计算出对象在ByteBuffer中的位置。</p>
<p>通过生成的PhoneNumber类中的number()、type()两个方法来看， FlatBuffers 中是怎么访问成员的：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function">String <span class="title">number</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> o = __offset(<span class="number">4</span>);</div><div class="line">    <span class="keyword">return</span> o != <span class="number">0</span> ? __string(o + bb_pos) : <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">type</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> o = __offset(<span class="number">6</span>);</div><div class="line">    <span class="keyword">return</span> o != <span class="number">0</span> ? bb.getInt(o + bb_pos) : 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>过程大体为：</p>
<ol>
<li>获得对应字段在对象中的偏移位置。</li>
<li>根据字段的偏移位置及对象的原点位置计算出对象的位置。</li>
<li>通过ByteBuffer等提供的一些方法得到字段的值。</li>
</ol>
<p>计算字段相对于对象原点位置的偏移的方法 __offset(4) 在com.google.flatbuffers.Table中定义：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">int</span> <span class="title">__offset</span><span class="params">(<span class="keyword">int</span> vtable_offset)</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> vtable = bb_pos - bb.getInt(bb_pos);</div><div class="line">  <span class="keyword">return</span> vtable_offset &lt; bb.getShort(vtable) ? bb.getShort(vtable + vtable_offset) : 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这个方法中，先是根据对象的原点处保存的vtable的偏移得到vtable的位置，然后在从vtable中获取对象字段相对于对象原点位置的偏移。</p>
<p>得到字符串字段的过程如下：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">String</span> __string(<span class="built_in">int</span> offset) &#123;</div><div class="line">  CharsetDecoder decoder = UTF8_DECODER.<span class="built_in">get</span>();</div><div class="line">  decoder.reset();</div><div class="line"></div><div class="line">  offset += bb.getInt(offset);</div><div class="line">  ByteBuffer src = bb.duplicate().order(ByteOrder.LITTLE_ENDIAN);</div><div class="line">  <span class="built_in">int</span> length = src.getInt(offset);</div><div class="line">  src.position(offset + SIZEOF_INT);</div><div class="line">  src.limit(offset + SIZEOF_INT + length);</div><div class="line"></div><div class="line">  <span class="built_in">int</span> required = (<span class="built_in">int</span>)((<span class="built_in">float</span>)length * decoder.maxCharsPerByte());</div><div class="line">  CharBuffer dst = CHAR_BUFFER.<span class="built_in">get</span>();</div><div class="line">  <span class="keyword">if</span> (dst == <span class="keyword">null</span> || dst.capacity() &lt; required) &#123;</div><div class="line">    dst = CharBuffer.allocate(required);</div><div class="line">    CHAR_BUFFER.<span class="built_in">set</span>(dst);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  dst.<span class="built_in">clear</span>();</div><div class="line"></div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    CoderResult cr = decoder.decode(src, dst, <span class="keyword">true</span>);</div><div class="line">    <span class="keyword">if</span> (!cr.isUnderflow()) &#123;</div><div class="line">      cr.throwException();</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">catch</span> (CharacterCodingException x) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> dst.flip().toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>了解了前面字符串编码的过程之后，相信也不难了解这里解码字符串的过程，这里完全是那个过程的相反过程。 </p>
<p>如我们所见，FlatBuffers编码后的数据其实无需解码，只要通过生成的Java类对这些数据进行解释就可以了。</p>
<p>FlatBuffers的原理大体如此。</p>
<p>Done。</p>
</div><div class="tags"><a href="/tags/Android开发/">Android开发</a></div><div class="post-nav"><a href="/2016/12/15/OkHttp3中的HTTP2首部压缩/" class="pre">OkHttp3中的HTTP2首部压缩</a><a href="/2016/12/02/在Android中使用ProtocolBuffers/" class="next">在Android中使用Protocol Buffers</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android-图形系统/">Android 图形系统</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">31</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/01/anbox_container_manager_service/">Anbox 容器管理服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/28/run_anbox/">运行 Anbox</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/28/Anbox/">Anbox</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/24/gerrit_codereview/">Gerrit代码审核服务器搭建全过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/20/adb_overview/">关于 ADB 实现的说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/adb-standalone/">adb standalone</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/31/qcow2_on_linux/">在 Linux 上如何挂载 qcow2 磁盘镜像</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/21/android_graphics_gralloc/">Android 图形系统之gralloc</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/20/android_graphics_bufferalloc/">Android 图形系统之图形缓冲区分配</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/16/opengles_android_emulation/">Android 硬件 OpenGL ES 模拟设计概述</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2016/12/08/在Android中使用FlatBuffers/';
var disqus_title = '在Android中使用FlatBuffers';
var disqus_url = 'https://www.wolfcstech.com/2016/12/08/在Android中使用FlatBuffers/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-109419024-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>