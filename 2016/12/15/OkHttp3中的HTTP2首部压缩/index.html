<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>OkHttp3中的HTTP2首部压缩 | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">OkHttp3中的HTTP2首部压缩</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">OkHttp3中的HTTP2首部压缩</h1><div class="post-meta">Dec 15, 2016<span> | </span><span class="category"><a href="/categories/网络协议/">网络协议</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/12/15/OkHttp3中的HTTP2首部压缩/" href="/2016/12/15/OkHttp3中的HTTP2首部压缩/#comments" class="ds-thread-count"></a><div class="post-content"><p>当前网络环境中，同一个页面发出几十个HTTP请求已经是司空见惯的事情了。在HTTP/1.1中，请求之间完全相互独立，使得请求中冗余的首部字段不必要地浪费了大量的网络带宽，并增加了网络延时。以对某站点的一次页面访问为例：</p>
<a id="more"></a>
<p><img src="https://www.wolfcstech.com/images/1315506-b172bdb63e325d50.jpg" alt="Header 1"></p>
<p><img src="https://www.wolfcstech.com/images/1315506-7b62c9574493209c.jpg" alt="Header 2"></p>
<p>如上图，同一个页面中对不同资源的请求，请求中的头部字段绝大部分是完全相同的。特别是 “User-Agent” 等头部字段通常还会消耗大量的带宽。</p>
<p>HTTP/2的首部压缩正是为了解决这个问题而设计。</p>
<p>首部压缩是HTTP/2中一个非常重要的特性，它大大减少了网络中HTTP请求/响应头部传输所需的带宽。HTTP/2的首部压缩，主要从两个方面实现，一是首部表示，二是请求间首部字段内容的复用。</p>
<h1 id="首部表示"><a href="#首部表示" class="headerlink" title="首部表示"></a>首部表示</h1><p>在HTTP中，首部字段是一个名值对，所有的首部字段组成首部字段列表。在HTTP/1.x中，首部字段都被表示为字符串，一行一行的首部字段字符串组成首部字段列表。而在HTTP/2的首部压缩HPACK算法中，则有着不同的表示方法。</p>
<p>HPACK算法表示的对象，主要有原始数据类型的整型值和字符串，头部字段，以及头部字段列表。</p>
<h2 id="整数的表示"><a href="#整数的表示" class="headerlink" title="整数的表示"></a>整数的表示</h2><p>在HPACK中，整数用于表示 <strong><em>头部字段的名字的索引</em></strong>，<strong><em>头部字段索引</em></strong> 或 <strong><em>字符串长度</em></strong>。整数的表示可在字节内的任何位置开始。但为了处理上的优化，整数的表示总是在字节的结尾处结束。</p>
<p>整数由两部分表示：填满当前字节的前缀，以及在前缀不足以表示整数时的一个可选字节列表。如果整数值足够小，比如，小于2^N-1，那么把它编码进前缀即可，而不需要额外的空间。如：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="section">  0   1   2   3   4   5   6   7</span></div><div class="line">+---+---+---+---+---+---+---+---+</div><div class="line"><span class="section">| ? | ? | ? |       Value       |</span></div><div class="line">+---+---+---+-------------------+</div></pre></td></tr></table></figure></p>
<p>在这个图中，前缀有5位，而要表示的数足够小，因此无需更多空间就可以表示整数了。</p>
<p>当前缀不足以表示整数时，前缀的所有位被置为1，再将值减去2^N-1之后用一个或多个字节编码。每个字节的最高有效位被用作连续标记：除列表的最后一个字节外，该位的值都被设为1。字节中剩余的位被用于编码减小后的值。<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="section">  0   1   2   3   4   5   6   7</span></div><div class="line">+---+---+---+---+---+---+---+---+</div><div class="line"><span class="section">| ? | ? | ? | 1   1   1   1   1 |</span></div><div class="line">+---+---+---+-------------------+</div><div class="line"><span class="section">| 1 |    Value-(2^N-1) LSB      |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">               ...</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">| 0 |    Value-(2^N-1) MSB      |</span></div><div class="line">+---+---------------------------+</div></pre></td></tr></table></figure></p>
<p>要由字节列表解码出整数值，首先需要将列表中的字节顺序反过来。然后，移除每个字节的最高有效位。连接字节的剩余位，再将结果加2^N-1获得整数值。</p>
<p>前缀大小N，总是在1到8之间。从字节边界处开始编码的整数值其前缀为8位。</p>
<p>这种整数表示法允许编码无限大的值。</p>
<p>表示整数I的伪代码如下：<br><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">if <span class="keyword">I</span> &lt; <span class="number">2</span>^<span class="keyword">N</span> - <span class="number">1</span>, encode <span class="keyword">I</span> on <span class="keyword">N</span> bits</div><div class="line">else</div><div class="line">    encode (<span class="number">2</span>^<span class="keyword">N</span> - <span class="number">1</span>) on <span class="keyword">N</span> bits</div><div class="line">    <span class="keyword">I</span> = <span class="keyword">I</span> - (<span class="number">2</span>^<span class="keyword">N</span> - <span class="number">1</span>)</div><div class="line">    while <span class="keyword">I</span> &gt;= <span class="number">128</span></div><div class="line">         encode (<span class="keyword">I</span> % <span class="number">128</span> + <span class="number">128</span>) on <span class="number">8</span> bits</div><div class="line">         <span class="keyword">I</span> = <span class="keyword">I</span> / <span class="number">128</span></div><div class="line">    encode <span class="keyword">I</span> on <span class="number">8</span> bits</div></pre></td></tr></table></figure></p>
<p><strong><em>encode (I % 128 + 128) on 8 bits</em></strong> 一行中，加上128的意思是，最高有效位是1。如果要编码的整数值等于 (2^N - 1)，则用前缀和紧跟在前缀后面的值位0的一个字节来表示。</p>
<p>OkHttp中，这个算法的实现在 <strong><em>okhttp3.internal.http2.Hpack.Writer</em></strong> 中：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// http://tools.ietf.org/html/draft-ietf-httpbis-header-compression-12#section-4.1.1</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeInt</span>(<span class="params"><span class="keyword">int</span> <span class="keyword">value</span>, <span class="keyword">int</span> prefixMask, <span class="keyword">int</span> bits</span>) </span>&#123;</div><div class="line">  <span class="comment">// Write the raw value for a single byte value.</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">value</span> &lt; prefixMask) &#123;</div><div class="line">    <span class="keyword">out</span>.writeByte(bits | <span class="keyword">value</span>);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Write the mask to start a multibyte value.</span></div><div class="line">  <span class="keyword">out</span>.writeByte(bits | prefixMask);</div><div class="line">  <span class="keyword">value</span> -= prefixMask;</div><div class="line"></div><div class="line">  <span class="comment">// Write 7 bits at a time 'til we're done.</span></div><div class="line">  <span class="keyword">while</span> (<span class="keyword">value</span> &gt;= <span class="number">0x80</span>) &#123;</div><div class="line">    <span class="keyword">int</span> b = <span class="keyword">value</span> &amp; <span class="number">0x7f</span>;</div><div class="line">    <span class="keyword">out</span>.writeByte(b | <span class="number">0x80</span>);</div><div class="line">    <span class="keyword">value</span> &gt;&gt;&gt;= <span class="number">7</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">out</span>.writeByte(<span class="keyword">value</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里给最高有效位置 1 的方法就不是加上128，而是与0x80执行或操作。</p>
<p>解码整数I的伪代码如下：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">decode</span> I from the next <span class="keyword">N</span> bits</div><div class="line"><span class="keyword">if</span> I &lt; 2^<span class="keyword">N</span> - 1, <span class="keyword">return</span> <span class="built_in">I</span></div><div class="line"><span class="keyword">else</span></div><div class="line">    <span class="keyword">M</span> = 0</div><div class="line">    <span class="keyword">repeat</span></div><div class="line">        B = next octet</div><div class="line">        I = I + (B &amp; 127) * 2^<span class="built_in">M</span></div><div class="line">        <span class="keyword">M</span> = <span class="keyword">M</span> + 7</div><div class="line">    <span class="keyword">while</span> B &amp; 128 == 128</div><div class="line">    <span class="keyword">return</span> <span class="built_in">I</span></div></pre></td></tr></table></figure></p>
<p><strong><em>decode I from the next N bits</em></strong> 这一行等价于一个赋值语句 <strong><em>*I = byteValue &amp; (2^N - 1)</em></strong></p>
<p>OkHttp中，这个算法的实现在 <strong><em>okhttp3.internal.http2.Hpack.Reader</em></strong> ：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">readInt</span><span class="params">(<span class="keyword">int</span> firstByte, <span class="keyword">int</span> prefixMask)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  <span class="keyword">int</span> prefix = firstByte &amp; prefixMask;</div><div class="line">  <span class="keyword">if</span> (prefix &lt; prefixMask) &#123;</div><div class="line">    <span class="keyword">return</span> prefix; <span class="comment">// This was a single byte value.</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// This is a multibyte value. Read 7 bits at a time.</span></div><div class="line">  <span class="keyword">int</span> result = prefixMask;</div><div class="line">  <span class="keyword">int</span> shift = <span class="number">0</span>;</div><div class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">    <span class="keyword">int</span> b = readByte();</div><div class="line">    <span class="keyword">if</span> ((b &amp; <span class="number">0x80</span>) != <span class="number">0</span>) &#123; <span class="comment">// Equivalent to (b &gt;= 128) since b is in [0..255].</span></div><div class="line">      result += (b &amp; <span class="number">0x7f</span>) &lt;&lt; shift;</div><div class="line">      shift += <span class="number">7</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      result += b &lt;&lt; shift; <span class="comment">// Last byte.</span></div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>尽管HPACK的整数表示方法可以表示无限大的数，但实际的实现中并不会将整数当做无限大的整数来处理。</p>
<h2 id="字符串字面量的编码"><a href="#字符串字面量的编码" class="headerlink" title="字符串字面量的编码"></a>字符串字面量的编码</h2><p>头部字段名和头部字段值可使用字符串字面量表示。字符串字面量有两种表示方式，一种是直接用UTF-8这样的字符串编码方式表示，另一种是将字符串编码用Huffman 码表示。 字符串表示的格式如下：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="section">  0   1   2   3   4   5   6   7</span></div><div class="line">+---+---+---+---+---+---+---+---+</div><div class="line"><span class="section">| H |    String Length (7+)     |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">|  String Data (Length octets)  |</span></div><div class="line">+-------------------------------+</div></pre></td></tr></table></figure></p>
<p>先是标记位 <strong>H</strong> + 字符串长度，然后是字符串的实际数据。各部分说明如下：</p>
<ul>
<li><strong>H：</strong> 一位的标记，指示字符串的字节是否为Huffman编码。</li>
<li><strong>字符串长度：</strong> 编码字符串字面量的字节数，一个整数，编码方式可以参考前面 <strong>整数的表示</strong> 的部分，一个7位前缀的整数编码。</li>
<li><strong>字符串数据：</strong> 字符串的实际数据。如果H是’0’，则数据是字符串字面量的原始字节。如果H是’1’，则数据是字符串字面量的Huffman编码。</li>
</ul>
<p>在OkHttp3中，总是会使用直接的字符串编码，而不是Huffman编码， <strong><em>okhttp3.internal.http2.Hpack.Writer</em></strong> 中编码字符串的过程如下：<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">void writeByteString(ByteString <span class="keyword">data</span>) throws IOException &#123;</div><div class="line">  writeInt(<span class="keyword">data</span>.<span class="built_in">size</span>(), PREFIX_7_BITS, <span class="number">0</span>);</div><div class="line">  <span class="keyword">out</span>.<span class="built_in">write</span>(<span class="keyword">data</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>OkHttp中，解码字符串在 <strong><em>okhttp3.internal.http2.Hpack.Reader</em></strong> 中实现：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Reads a potentially Huffman encoded byte string. */</span></div><div class="line">ByteString readByteString() <span class="keyword">throws</span> IOException &#123;</div><div class="line">  <span class="keyword">int</span> firstByte = readByte();</div><div class="line">  <span class="keyword">boolean</span> huffmanDecode = (firstByte &amp; <span class="number">0</span>x80) == <span class="number">0</span>x80; <span class="comment">// 1NNNNNNN</span></div><div class="line">  <span class="keyword">int</span> length = readInt(firstByte, PREFIX_7_BITS);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (huffmanDecode) &#123;</div><div class="line">    <span class="keyword">return</span> ByteString.of(Huffman.get().decode(<span class="keyword">source</span>.readByteArray(length)));</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">source</span>.readByteString(length);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>字符串编码没有使用Huffman编码时，解码过程比较简单，而使用了Huffman编码时会借助于<strong><em>Huffman</em></strong>类来解码。</p>
<p>Huffman编码是一种变长字节编码，对于使用频率高的字节，使用更少的位数，对于使用频率低的字节则使用更多的位数。每个字节的Huffman码是根据统计经验值分配的。为每个字节分配Huffman码的方法可以参考 <a href="http://www.cnblogs.com/kubixuesheng/p/4397798.html" target="_blank" rel="external">哈夫曼（huffman）树和哈夫曼编码</a> 。</p>
<h3 id="哈夫曼树的构造"><a href="#哈夫曼树的构造" class="headerlink" title="哈夫曼树的构造"></a>哈夫曼树的构造</h3><p><strong><em>Huffman</em></strong> 类被设计为一个单例类。对象在创建时构造一个哈夫曼树以用于编码和解码操作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Huffman INSTANCE = <span class="keyword">new</span> Huffman();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Huffman <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> INSTANCE;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Node root = <span class="keyword">new</span> Node();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Huffman</span><span class="params">()</span> </span>&#123;</div><div class="line">    buildTree();</div><div class="line">  &#125;</div><div class="line">......</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildTree</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CODE_LENGTHS.length; i++) &#123;</div><div class="line">      addCode(i, CODES[i], CODE_LENGTHS[i]);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addCode</span><span class="params">(<span class="keyword">int</span> sym, <span class="keyword">int</span> code, <span class="keyword">byte</span> len)</span> </span>&#123;</div><div class="line">    Node terminal = <span class="keyword">new</span> Node(sym, len);</div><div class="line"></div><div class="line">    Node current = root;</div><div class="line">    <span class="keyword">while</span> (len &gt; <span class="number">8</span>) &#123;</div><div class="line">      len -= <span class="number">8</span>;</div><div class="line">      <span class="keyword">int</span> i = ((code &gt;&gt;&gt; len) &amp; <span class="number">0xFF</span>);</div><div class="line">      <span class="keyword">if</span> (current.children == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"invalid dictionary: prefix not unique"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (current.children[i] == <span class="keyword">null</span>) &#123;</div><div class="line">        current.children[i] = <span class="keyword">new</span> Node();</div><div class="line">      &#125;</div><div class="line">      current = current.children[i];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> shift = <span class="number">8</span> - len;</div><div class="line">    <span class="keyword">int</span> start = (code &lt;&lt; shift) &amp; <span class="number">0xFF</span>;</div><div class="line">    <span class="keyword">int</span> end = <span class="number">1</span> &lt;&lt; shift;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; start + end; i++) &#123;</div><div class="line">      current.children[i] = terminal;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">......</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// Null if terminal.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node[] children;</div><div class="line"></div><div class="line">    <span class="comment">// Terminal nodes have a symbol.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> symbol;</div><div class="line"></div><div class="line">    <span class="comment">// Number of bits represented in the terminal node.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> terminalBits;</div><div class="line"></div><div class="line">    <span class="comment">/** Construct an internal node. */</span></div><div class="line">    Node() &#123;</div><div class="line">      <span class="keyword">this</span>.children = <span class="keyword">new</span> Node[<span class="number">256</span>];</div><div class="line">      <span class="keyword">this</span>.symbol = <span class="number">0</span>; <span class="comment">// Not read.</span></div><div class="line">      <span class="keyword">this</span>.terminalBits = <span class="number">0</span>; <span class="comment">// Not read.</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Construct a terminal node.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> symbol symbol the node represents</div><div class="line">     * <span class="doctag">@param</span> bits length of Huffman code in bits</div><div class="line">     */</div><div class="line">    Node(<span class="keyword">int</span> symbol, <span class="keyword">int</span> bits) &#123;</div><div class="line">      <span class="keyword">this</span>.children = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">this</span>.symbol = symbol;</div><div class="line">      <span class="keyword">int</span> b = bits &amp; <span class="number">0x07</span>;</div><div class="line">      <span class="keyword">this</span>.terminalBits = b == <span class="number">0</span> ? <span class="number">8</span> : b;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>OkHttp3中的 哈夫曼树 并不是一个二叉树，它的每个节点最多都可以有256个字节点。OkHttp3用这种方式来优化Huffman编码解码的效率。用一个图来表示，将是下面这个样子的：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-b03c870c6cdcd44c.jpg" alt="Huffman Tree"></p>
<h3 id="Huffman-编码"><a href="#Huffman-编码" class="headerlink" title="Huffman 编码"></a>Huffman 编码</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">encode</span>(<span class="params"><span class="keyword">byte</span>[] data, OutputStream <span class="keyword">out</span></span>) throws IOException </span>&#123;</div><div class="line">  <span class="keyword">long</span> current = <span class="number">0</span>;</div><div class="line">  <span class="keyword">int</span> n = <span class="number">0</span>;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</div><div class="line">    <span class="keyword">int</span> b = data[i] &amp; <span class="number">0xFF</span>;</div><div class="line">    <span class="keyword">int</span> code = CODES[b];</div><div class="line">    <span class="keyword">int</span> nbits = CODE_LENGTHS[b];</div><div class="line"></div><div class="line">    current &lt;&lt;= nbits;</div><div class="line">    current |= code;</div><div class="line">    n += nbits;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (n &gt;= <span class="number">8</span>) &#123;</div><div class="line">      n -= <span class="number">8</span>;</div><div class="line">      <span class="keyword">out</span>.write(((<span class="keyword">int</span>) (current &gt;&gt; n)));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</div><div class="line">    current &lt;&lt;= (<span class="number">8</span> - n);</div><div class="line">    current |= (<span class="number">0xFF</span> &gt;&gt;&gt; n);</div><div class="line">    <span class="keyword">out</span>.write((<span class="keyword">int</span>) current);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>逐个字节地编码数据。编码的最后一个字节没有字节对齐时，会在低位填充1。</p>
<h3 id="Huffman-解码"><a href="#Huffman-解码" class="headerlink" title="Huffman 解码"></a>Huffman 解码</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">byte[] decode(byte[] buf) &#123;</div><div class="line">  ByteArrayOutputStream baos = new ByteArrayOutputStream();</div><div class="line">  <span class="keyword">Node</span> <span class="title">node</span> = root;</div><div class="line">  int current = <span class="number">0</span>;</div><div class="line">  int nbits = <span class="number">0</span>;</div><div class="line">  for (int i = <span class="number">0</span>; i <span class="tag">&lt; buf.length; i++) &#123;</span></div><div class="line">    int b = buf[i] &amp; 0xFF;</div><div class="line">    current = (current &lt;&lt; 8) | b;</div><div class="line">    nbits += 8;</div><div class="line">    while (nbits &gt;= <span class="number">8</span>) &#123;</div><div class="line">      int c = (current &gt;&gt;&gt; (nbits - <span class="number">8</span>)) &amp; <span class="number">0</span>xFF;</div><div class="line">      <span class="keyword">node</span> <span class="title">= node</span>.children[c];</div><div class="line">      if (<span class="keyword">node</span>.<span class="title">children</span> == null) &#123;</div><div class="line">        // terminal <span class="keyword">node</span></div><div class="line">        <span class="title">baos</span>.<span class="keyword">write</span>(<span class="keyword">node</span>.<span class="title">symbol</span>);</div><div class="line">        nbits -= <span class="keyword">node</span>.<span class="title">terminalBits</span>;</div><div class="line">        <span class="keyword">node</span> <span class="title">= root</span>;</div><div class="line">      &#125; else &#123;</div><div class="line">        // non-terminal <span class="keyword">node</span></div><div class="line">        <span class="title">nbits</span> -= <span class="number">8</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  while (nbits &gt; <span class="number">0</span>) &#123;</div><div class="line">    int c = (current <span class="tag">&lt;&lt; (8 - nbits)) &amp; 0xFF;</span></div><div class="line">    node = node.children[c];</div><div class="line">    if (node.children != null || node.terminalBits &gt; nbits) &#123;</div><div class="line">      break;</div><div class="line">    &#125;</div><div class="line">    baos.<span class="keyword">write</span>(<span class="keyword">node</span>.<span class="title">symbol</span>);</div><div class="line">    nbits -= <span class="keyword">node</span>.<span class="title">terminalBits</span>;</div><div class="line">    <span class="keyword">node</span> <span class="title">= root</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  return baos.toByteArray();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配合Huffman树的构造过程，分几种情况来看。Huffman码自己对齐时；Huffman码没有字节对齐，最后一个字节的最低有效位包含了数据流中下一个Huffman码的最高有效位；Huffman码没有字节对齐，最后一个字节的最低有效位包含了填充的1。</p>
<p>有兴趣的可以参考其它文档对Huffman编码算法做更多了解。</p>
<h2 id="首部字段及首部块的表示"><a href="#首部字段及首部块的表示" class="headerlink" title="首部字段及首部块的表示"></a>首部字段及首部块的表示</h2><p>首部字段主要有两种表示方法，分别是索引表示和字面量表示。字面量表示又分为首部字段的名字用索引表示值用字面量表示和名字及值都用字面量表示等方法。</p>
<p>说到用索引表示首部字段，就不能不提一下HPACK的动态表和静态表。</p>
<p>HPACK使用两个表将 头部字段 与 索引 关联起来。 静态表 是预定义的，它包含了常见的头部字段（其中的大多数值为空）。 动态表 是动态的，它可被编码器用于编码重复的头部字段。</p>
<p>静态表由一个预定义的头部字段静态列表组成。它的条目在 HPACK规范的 <a href="https://tools.ietf.org/html/rfc7541#appendix-A" target="_blank" rel="external">附录 A</a> 中定义。</p>
<p>动态表由以先进先出顺序维护的 <strong>头部字段列表</strong> 组成。动态表中第一个且最新的条目索引值最低，动态表最旧的条目索引值最高。</p>
<p>动态表最初是空的。条目随着每个头部块的解压而添加。</p>
<p>静态表和动态表被组合为统一的索引地址空间。</p>
<p>在 (1 ~ 静态表的长度(包含)) 之间的索引值指向静态表中的元素。</p>
<p>大于静态表长度的索引值指向动态表中的元素。通过将头部字段的索引减去静态表的长度来查找指向动态表的索引。</p>
<p>对于静态表大小为 s，动态表大小为 k 的情况，下图展示了完整的有效索引地址空间。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="variable">&lt;----------  Index Address Space ----------&gt;</span></div><div class="line"><span class="variable">&lt;-- Static  Table --&gt;</span>  <span class="variable">&lt;-- Dynamic Table --&gt;</span></div><div class="line">+---+-----------+---+  +---+-----------+---+</div><div class="line">|<span class="string"> 1 </span>|<span class="string">    ...    </span>|<span class="string"> s </span>|<span class="string">  </span>|<span class="string">s+1</span>|<span class="string">    ...    </span>|<span class="string">s+k</span>|</div><div class="line">+---+-----------+---+  +---+-----------+---+</div><div class="line">                       ^                   |<span class="string"></span></div><div class="line">                       |<span class="string">                   V</span></div><div class="line">                Insertion Point      Dropping Point</div></pre></td></tr></table></figure>
<h3 id="用索引表示头部字段"><a href="#用索引表示头部字段" class="headerlink" title="用索引表示头部字段"></a>用索引表示头部字段</h3><p>当一个头部字段的名-值已经包含在了静态表或动态表中时，就可以用一个指向静态表或动态表的索引来表示它了。表示方法如下：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="section">  0   1   2   3   4   5   6   7</span></div><div class="line">+---+---+---+---+---+---+---+---+</div><div class="line"><span class="section">| 1 |        Index (7+)         |</span></div><div class="line">+---+---------------------------+</div></pre></td></tr></table></figure></p>
<p>头部字段表示的最高有效位置1，然后用前面看到的表示整数的方法表示索引，即索引是一个7位前缀编码的整数。</p>
<h3 id="用字面量表示头部字段"><a href="#用字面量表示头部字段" class="headerlink" title="用字面量表示头部字段"></a>用字面量表示头部字段</h3><p>在这种表示法中，头部字段的值是用字面量表示的，但头部字段的名字则不一定。根据名字的表示方法的差异，以及是否将头部字段加进动态表等，而分为多种情况。</p>
<h4 id="增量索引的字面量表示"><a href="#增量索引的字面量表示" class="headerlink" title="增量索引的字面量表示"></a>增量索引的字面量表示</h4><p>以这种方法表示的头部字段需要被 加进动态表中。在这种表示方法下，头部字段的值用索引表示时，头部字段的表示如下：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="section">  0   1   2   3   4   5   6   7</span></div><div class="line">+---+---+---+---+---+---+---+---+</div><div class="line"><span class="section">| 0 | 1 |      Index (6+)       |</span></div><div class="line">+---+---+-----------------------+</div><div class="line"><span class="section">| H |     Value Length (7+)     |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">| Value String (Length octets)  |</span></div><div class="line">+-------------------------------+</div></pre></td></tr></table></figure></p>
<p>头部字段的名字和值都用字面量表示时，表示如下：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="section">  0   1   2   3   4   5   6   7</span></div><div class="line">+---+---+---+---+---+---+---+---+</div><div class="line"><span class="section">| 0 | 1 |           0           |</span></div><div class="line">+---+---+-----------------------+</div><div class="line"><span class="section">| H |     Name Length (7+)      |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">|  Name String (Length octets)  |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">| H |     Value Length (7+)     |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">| Value String (Length octets)  |</span></div><div class="line">+-------------------------------+</div></pre></td></tr></table></figure></p>
<p>增量索引的字面量头部字段表示以’01’ 的2位模式开始。</p>
<p>如果头部字段名与静态表或动态表中存储的条目的头部字段名匹配，则头部字段名称可用那个条目的索引表示。在这种情况下，条目的索引以一个具有6位前缀的整数 表示。这个值总是非0。否则，头部字段名由一个字符串字面量 表示，使用0值代替6位索引，其后是头部字段名。</p>
<p>两种形式的 <strong>头部字段名表示</strong> 之后是字符串字面量表示的头部字段值。</p>
<h4 id="无索引的字面量头部字段"><a href="#无索引的字面量头部字段" class="headerlink" title="无索引的字面量头部字段"></a>无索引的字面量头部字段</h4><p>这种表示方法不改变动态表。头部字段名用索引表示时的头部字段表示如下：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="section">  0   1   2   3   4   5   6   7</span></div><div class="line">+---+---+---+---+---+---+---+---+</div><div class="line"><span class="section">| 0 | 0 | 0 | 0 |  Index (4+)   |</span></div><div class="line">+---+---+-----------------------+</div><div class="line"><span class="section">| H |     Value Length (7+)     |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">| Value String (Length octets)  |</span></div><div class="line">+-------------------------------+</div></pre></td></tr></table></figure></p>
<p>头部字段名不用索引表示时的头部字段表示如下：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="section">  0   1   2   3   4   5   6   7</span></div><div class="line">+---+---+---+---+---+---+---+---+</div><div class="line"><span class="section">| 0 | 0 | 0 | 0 |       0       |</span></div><div class="line">+---+---+-----------------------+</div><div class="line"><span class="section">| H |     Name Length (7+)      |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">|  Name String (Length octets)  |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">| H |     Value Length (7+)     |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">| Value String (Length octets)  |</span></div><div class="line">+-------------------------------+</div></pre></td></tr></table></figure></p>
<p>无索引的字面量头部字段表示以’0000’ 的4位模式开始，其它方面与 增量索引的字面量表示 类似。</p>
<h4 id="从不索引的字面量头部字段"><a href="#从不索引的字面量头部字段" class="headerlink" title="从不索引的字面量头部字段"></a>从不索引的字面量头部字段</h4><p>这种表示方法与 无索引的字面量头部字段 类似，但它主要影响网络中的中间节点。头部字段名用索引表示时的头部字段如：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="section">  0   1   2   3   4   5   6   7</span></div><div class="line">+---+---+---+---+---+---+---+---+</div><div class="line"><span class="section">| 0 | 0 | 0 | 1 |  Index (4+)   |</span></div><div class="line">+---+---+-----------------------+</div><div class="line"><span class="section">| H |     Value Length (7+)     |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">| Value String (Length octets)  |</span></div><div class="line">+-------------------------------+</div></pre></td></tr></table></figure></p>
<p>头部字段名不用索引表示时的头部字段如：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="section">  0   1   2   3   4   5   6   7</span></div><div class="line">+---+---+---+---+---+---+---+---+</div><div class="line"><span class="section">| 0 | 0 | 0 | 1 |       0       |</span></div><div class="line">+---+---+-----------------------+</div><div class="line"><span class="section">| H |     Name Length (7+)      |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">|  Name String (Length octets)  |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">| H |     Value Length (7+)     |</span></div><div class="line">+---+---------------------------+</div><div class="line"><span class="section">| Value String (Length octets)  |</span></div><div class="line">+-------------------------------+</div></pre></td></tr></table></figure></p>
<h3 id="首部列表的表示"><a href="#首部列表的表示" class="headerlink" title="首部列表的表示"></a>首部列表的表示</h3><p>各个首部字段表示合并起来形成首部列表。在 okhttp3.internal.framed.Hpack.Writer 的writeHeaders() 中完成编码首部块的动作：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** This does not use "never indexed" semantics for sensitive headers. */</span></div><div class="line"><span class="comment">// http://tools.ietf.org/html/draft-ietf-httpbis-header-compression-12#section-6.2.3</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeHeaders</span>(<span class="params">List&lt;Header&gt; headerBlock</span>) throws IOException </span>&#123;</div><div class="line">  <span class="keyword">if</span> (emitDynamicTableSizeUpdate) &#123;</div><div class="line">    <span class="keyword">if</span> (smallestHeaderTableSizeSetting &lt; maxDynamicTableByteCount) &#123;</div><div class="line">      <span class="comment">// Multiple dynamic table size updates!</span></div><div class="line">      writeInt(smallestHeaderTableSizeSetting, PREFIX_5_BITS, <span class="number">0x20</span>);</div><div class="line">    &#125;</div><div class="line">    emitDynamicTableSizeUpdate = <span class="literal">false</span>;</div><div class="line">    smallestHeaderTableSizeSetting = Integer.MAX_VALUE;</div><div class="line">    writeInt(maxDynamicTableByteCount, PREFIX_5_BITS, <span class="number">0x20</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// <span class="doctag">TODO:</span> implement index tracking</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = headerBlock.size(); i &lt; size; i++) &#123;</div><div class="line">    Header header = headerBlock.<span class="keyword">get</span>(i);</div><div class="line">    ByteString name = header.name.toAsciiLowercase();</div><div class="line">    ByteString <span class="keyword">value</span> = header.<span class="keyword">value</span>;</div><div class="line">    Integer staticIndex = NAME_TO_FIRST_INDEX.<span class="keyword">get</span>(name);</div><div class="line">    <span class="keyword">if</span> (staticIndex != <span class="literal">null</span>) &#123;</div><div class="line">      <span class="comment">// Literal Header Field without Indexing - Indexed Name.</span></div><div class="line">      writeInt(staticIndex + <span class="number">1</span>, PREFIX_4_BITS, <span class="number">0</span>);</div><div class="line">      writeByteString(<span class="keyword">value</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">int</span> dynamicIndex = Util.indexOf(dynamicTable, header);</div><div class="line">      <span class="keyword">if</span> (dynamicIndex != <span class="number">-1</span>) &#123;</div><div class="line">        <span class="comment">// Indexed Header.</span></div><div class="line">        writeInt(dynamicIndex - nextHeaderIndex + STATIC_HEADER_TABLE.length, PREFIX_7_BITS,</div><div class="line">            <span class="number">0x80</span>);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Literal Header Field with Incremental Indexing - New Name</span></div><div class="line">        <span class="keyword">out</span>.writeByte(<span class="number">0x40</span>);</div><div class="line">        writeByteString(name);</div><div class="line">        writeByteString(<span class="keyword">value</span>);</div><div class="line">        insertIntoDynamicTable(header);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>HPACK的规范描述了多种头部字段的表示方法，但并没有指明各个表示方法的适用场景。</p>
<p>在OkHttp3中，实现了3种表示头部字段的表示方法：</p>
<ol>
<li>头部字段名在静态表中，头部字段名用指向静态表的索引表示，值用字面量表示。头部字段无需加入动态表。</li>
<li>头部字段的 名-值 对在动态表中，用指向动态表的索引表示头部字段。</li>
<li>其它情况，用字面量表示头部字段名和值，头部字段需要加入动态表。</li>
</ol>
<p>如果头部字段的 名-值 对在静态表中，OkHttp3也不会用索引表示。</p>
<h1 id="请求间首部字段内容的复用"><a href="#请求间首部字段内容的复用" class="headerlink" title="请求间首部字段内容的复用"></a>请求间首部字段内容的复用</h1><p>HPACK中，最重要的优化就是消除请求间冗余的首部字段。在实现上，主要有两个方面，一是前面看到的首部字段的索引表示，另一方面则是动态表的维护。</p>
<p>HTTP/2中数据发送方向和数据接收方向各有一个动态表。通信的双方，一端发送方向的动态表需要与另一端接收方向的动态表保持一致，反之亦然。</p>
<p>HTTP/2的连接复用及请求并发执行指的是逻辑上的并发。由于底层传输还是用的TCP协议，因而，发送方发送数据的顺序，与接收方接收数据的顺序是一致的。</p>
<p>数据发送方在发送一个请求的首部数据时会顺便维护自己的动态表，接收方在收到首部数据时，也需要立马维护自己接收方向的动态表，然后将解码之后的首部字段列表dispatch出去。</p>
<p>如果通信双方同时在进行2个HTTP请求，分别称为Req1和Req2，假设在发送方Req1的头部字段列表先发送，Req2的头部字段后发送。接收方必然先收到Req1的头部字段列表，然后是Req2的。如果接收方在收到Req1的头部字段列表后，没有立即解码，而是等Req2的首部字段列表接收并处理完成之后，再来处理Req1的，则两端的动态表必然是不一致的。</p>
<p>这里来看一下OkHttp3中的动态表维护。</p>
<p>发送方向的动态表，在  okhttp3.internal.framed.Hpack.Writer 中维护。在HTTP/2中，动态表的最大大小在连接建立的初期会进行协商，后面在数据收发过程中也会进行更新。</p>
<p>在编码头部字段列表的 writeHeaders(List<header> headerBlock) 中，会在需要的时候，将头部字段插入动态表，具体来说，就是在头部字段的名字不在静态表中，同时 名-值对不在动态表中的情况。</header></p>
<p>将头部字段插入动态表的过程如下：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearDynamicTable</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  Arrays.fill(dynamicTable, <span class="literal">null</span>);</div><div class="line">  nextHeaderIndex = dynamicTable.length - <span class="number">1</span>;</div><div class="line">  headerCount = <span class="number">0</span>;</div><div class="line">  dynamicTableByteCount = <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/** Returns the count of entries evicted. */</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">evictToRecoverBytes</span>(<span class="params"><span class="keyword">int</span> bytesToRecover</span>) </span>&#123;</div><div class="line">  <span class="keyword">int</span> entriesToEvict = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> (bytesToRecover &gt; <span class="number">0</span>) &#123;</div><div class="line">    <span class="comment">// determine how many headers need to be evicted.</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = dynamicTable.length - <span class="number">1</span>; j &gt;= nextHeaderIndex &amp;&amp; bytesToRecover &gt; <span class="number">0</span>; j--) &#123;</div><div class="line">      bytesToRecover -= dynamicTable[j].hpackSize;</div><div class="line">      dynamicTableByteCount -= dynamicTable[j].hpackSize;</div><div class="line">      headerCount--;</div><div class="line">      entriesToEvict++;</div><div class="line">    &#125;</div><div class="line">    System.arraycopy(dynamicTable, nextHeaderIndex + <span class="number">1</span>, dynamicTable,</div><div class="line">        nextHeaderIndex + <span class="number">1</span> + entriesToEvict, headerCount);</div><div class="line">    Arrays.fill(dynamicTable, nextHeaderIndex + <span class="number">1</span>, nextHeaderIndex + <span class="number">1</span> + entriesToEvict, <span class="literal">null</span>);</div><div class="line">    nextHeaderIndex += entriesToEvict;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> entriesToEvict;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insertIntoDynamicTable</span>(<span class="params">Header entry</span>) </span>&#123;</div><div class="line">  <span class="keyword">int</span> delta = entry.hpackSize;</div><div class="line"></div><div class="line">  <span class="comment">// if the new or replacement header is too big, drop all entries.</span></div><div class="line">  <span class="keyword">if</span> (delta &gt; maxDynamicTableByteCount) &#123;</div><div class="line">    clearDynamicTable();</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Evict headers to the required length.</span></div><div class="line">  <span class="keyword">int</span> bytesToRecover = (dynamicTableByteCount + delta) - maxDynamicTableByteCount;</div><div class="line">  evictToRecoverBytes(bytesToRecover);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (headerCount + <span class="number">1</span> &gt; dynamicTable.length) &#123; <span class="comment">// Need to grow the dynamic table.</span></div><div class="line">    Header[] doubled = <span class="keyword">new</span> Header[dynamicTable.length * <span class="number">2</span>];</div><div class="line">    System.arraycopy(dynamicTable, <span class="number">0</span>, doubled, dynamicTable.length, dynamicTable.length);</div><div class="line">    nextHeaderIndex = dynamicTable.length - <span class="number">1</span>;</div><div class="line">    dynamicTable = doubled;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">int</span> index = nextHeaderIndex--;</div><div class="line">  dynamicTable[index] = entry;</div><div class="line">  headerCount++;</div><div class="line">  dynamicTableByteCount += delta;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>动态表占用的空间超出限制时，老的头部字段将被移除。在OkHttp3中，动态表是一个自后向前生长的表。</p>
<p>在数据的接收防线，okhttp3.internal.http2.Http2Reader 的 nextFrame(Handler handler) 会不停从网络读取一帧帧的数据：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">nextFrame</span><span class="params">(Handler <span class="keyword">handler</span>)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    source.require(<span class="number">9</span>); <span class="comment">// Frame header size</span></div><div class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// This might be a normal socket close.</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*  0                   1                   2                   3</span></div><div class="line">     *  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</div><div class="line">     * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">     * |                 Length (24)                   |</div><div class="line">     * +---------------+---------------+---------------+</div><div class="line">     * |   Type (8)    |   Flags (8)   |</div><div class="line">     * +-+-+-----------+---------------+-------------------------------+</div><div class="line">     * |R|                 Stream Identifier (31)                      |</div><div class="line">     * +=+=============================================================+</div><div class="line">     * |                   Frame Payload (0...)                      ...</div><div class="line">     * +---------------------------------------------------------------+</div><div class="line">     */</div><div class="line">  <span class="keyword">int</span> length = readMedium(source);</div><div class="line">  <span class="keyword">if</span> (length &lt; <span class="number">0</span> || length &gt; INITIAL_MAX_FRAME_SIZE) &#123;</div><div class="line">    <span class="keyword">throw</span> ioException(<span class="string">"FRAME_SIZE_ERROR: %s"</span>, length);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">byte</span> type = (<span class="keyword">byte</span>) (source.readByte() &amp; <span class="number">0xff</span>);</div><div class="line">  <span class="keyword">byte</span> flags = (<span class="keyword">byte</span>) (source.readByte() &amp; <span class="number">0xff</span>);</div><div class="line">  <span class="keyword">int</span> streamId = (source.readInt() &amp; <span class="number">0x7fffffff</span>); <span class="comment">// Ignore reserved bit.</span></div><div class="line">  <span class="keyword">if</span> (logger.isLoggable(FINE)) logger.fine(frameLog(<span class="keyword">true</span>, streamId, length, type, flags));</div><div class="line"></div><div class="line">  <span class="keyword">switch</span> (type) &#123;</div><div class="line">    <span class="keyword">case</span> TYPE_DATA:</div><div class="line">      readData(<span class="keyword">handler</span>, length, flags, streamId);</div><div class="line">      <span class="keyword">break</span>;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> TYPE_HEADERS:</div><div class="line">      readHeaders(<span class="keyword">handler</span>, length, flags, streamId);</div><div class="line">      <span class="keyword">break</span>;</div></pre></td></tr></table></figure></p>
<p>读到头部块时，会立即维护本地接收方向的动态表：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">readHeaders</span><span class="params">(Handler <span class="keyword">handler</span>, <span class="keyword">int</span> length, <span class="keyword">byte</span> flags, <span class="keyword">int</span> streamId)</span></span></div><div class="line">    <span class="keyword">throws</span> IOException &#123;</div><div class="line">  <span class="keyword">if</span> (streamId == <span class="number">0</span>) <span class="keyword">throw</span> ioException(<span class="string">"PROTOCOL_ERROR: TYPE_HEADERS streamId == 0"</span>);</div><div class="line"></div><div class="line">  <span class="keyword">boolean</span> endStream = (flags &amp; FLAG_END_STREAM) != <span class="number">0</span>;</div><div class="line"></div><div class="line">  <span class="keyword">short</span> padding = (flags &amp; FLAG_PADDED) != <span class="number">0</span> ? (<span class="keyword">short</span>) (source.readByte() &amp; <span class="number">0xff</span>) : 0;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> ((flags &amp; FLAG_PRIORITY) != <span class="number">0</span>) &#123;</div><div class="line">    readPriority(<span class="keyword">handler</span>, streamId);</div><div class="line">    length -= <span class="number">5</span>; <span class="comment">// account for above read.</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  length = lengthWithoutPadding(length, flags, padding);</div><div class="line"></div><div class="line">  List&lt;Header&gt; headerBlock = readHeaderBlock(length, padding, flags, streamId);</div><div class="line"></div><div class="line">  <span class="keyword">handler</span>.headers(endStream, streamId, <span class="number">-1</span>, headerBlock);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> List&lt;Header&gt; readHeaderBlock(<span class="keyword">int</span> length, <span class="keyword">short</span> padding, <span class="keyword">byte</span> flags, <span class="keyword">int</span> streamId)</div><div class="line">    <span class="keyword">throws</span> IOException &#123;</div><div class="line">  continuation.length = continuation.left = length;</div><div class="line">  continuation.padding = padding;</div><div class="line">  continuation.flags = flags;</div><div class="line">  continuation.streamId = streamId;</div><div class="line"></div><div class="line">  <span class="comment">// <span class="doctag">TODO:</span> Concat multi-value headers with 0x0, except COOKIE, which uses 0x3B, 0x20.</span></div><div class="line">  <span class="comment">// http://tools.ietf.org/html/draft-ietf-httpbis-http2-17#section-8.1.2.5</span></div><div class="line">  hpackReader.readHeaders();</div><div class="line">  <span class="function"><span class="keyword">return</span> hpackReader.<span class="title">getAndResetHeaderList</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>okhttp3.internal.http2.Hpack.Reader的readHeaders()如下：<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Reader</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Header&gt; headerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BufferedSource source;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> headerTableSizeSetting;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> maxDynamicTableByteCount;</div><div class="line"></div><div class="line">  <span class="comment">// Visible for testing.</span></div><div class="line">  Header[] dynamicTable = <span class="keyword">new</span> Header[<span class="number">8</span>];</div><div class="line">  <span class="comment">// Array is populated back to front, so new entries always have lowest index.</span></div><div class="line">  <span class="keyword">int</span> nextHeaderIndex = dynamicTable.length - <span class="number">1</span>;</div><div class="line">  <span class="keyword">int</span> headerCount = <span class="number">0</span>;</div><div class="line">  <span class="keyword">int</span> dynamicTableByteCount = <span class="number">0</span>;</div><div class="line"></div><div class="line">  Reader(<span class="keyword">int</span> headerTableSizeSetting, Source source) &#123;</div><div class="line">    <span class="keyword">this</span>(headerTableSizeSetting, headerTableSizeSetting, source);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  Reader(<span class="keyword">int</span> headerTableSizeSetting, <span class="keyword">int</span> maxDynamicTableByteCount, Source source) &#123;</div><div class="line">    <span class="keyword">this</span>.headerTableSizeSetting = headerTableSizeSetting;</div><div class="line">    <span class="keyword">this</span>.maxDynamicTableByteCount = maxDynamicTableByteCount;</div><div class="line">    <span class="keyword">this</span>.source = Okio.buffer(source);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">int</span> maxDynamicTableByteCount() &#123;</div><div class="line">    <span class="keyword">return</span> maxDynamicTableByteCount;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">void</span> adjustDynamicTableByteCount() &#123;</div><div class="line">    <span class="keyword">if</span> (maxDynamicTableByteCount &lt; dynamicTableByteCount) &#123;</div><div class="line">      <span class="keyword">if</span> (maxDynamicTableByteCount == <span class="number">0</span>) &#123;</div><div class="line">        clearDynamicTable();</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        evictToRecoverBytes(dynamicTableByteCount - maxDynamicTableByteCount);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">void</span> clearDynamicTable() &#123;</div><div class="line">    headerList.clear();</div><div class="line">    Arrays.fill(dynamicTable, <span class="keyword">null</span>);</div><div class="line">    nextHeaderIndex = dynamicTable.length - <span class="number">1</span>;</div><div class="line">    headerCount = <span class="number">0</span>;</div><div class="line">    dynamicTableByteCount = <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns the count of entries evicted. */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> evictToRecoverBytes(<span class="keyword">int</span> bytesToRecover) &#123;</div><div class="line">    <span class="keyword">int</span> entriesToEvict = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (bytesToRecover &gt; <span class="number">0</span>) &#123;</div><div class="line">      <span class="comment">// determine how many headers need to be evicted.</span></div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = dynamicTable.length - <span class="number">1</span>; j &gt;= nextHeaderIndex &amp;&amp; bytesToRecover &gt; <span class="number">0</span>; j--) &#123;</div><div class="line">        bytesToRecover -= dynamicTable[j].hpackSize;</div><div class="line">        dynamicTableByteCount -= dynamicTable[j].hpackSize;</div><div class="line">        headerCount--;</div><div class="line">        entriesToEvict++;</div><div class="line">      &#125;</div><div class="line">      System.arraycopy(dynamicTable, nextHeaderIndex + <span class="number">1</span>, dynamicTable,</div><div class="line">          nextHeaderIndex + <span class="number">1</span> + entriesToEvict, headerCount);</div><div class="line">      nextHeaderIndex += entriesToEvict;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> entriesToEvict;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Read &#123;@code byteCount&#125; bytes of headers from the source stream. This implementation does not</div><div class="line">   * propagate the never indexed flag of a header.</div><div class="line">   */</div><div class="line">  <span class="keyword">void</span> readHeaders() throws IOException &#123;</div><div class="line">    <span class="keyword">while</span> (!source.exhausted()) &#123;</div><div class="line">      <span class="keyword">int</span> b = source.readByte() &amp; <span class="number">0xff</span>;</div><div class="line">      <span class="keyword">if</span> (b == <span class="number">0x80</span>) &#123; <span class="comment">// 10000000</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"index == 0"</span>);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((b &amp; <span class="number">0x80</span>) == <span class="number">0x80</span>) &#123; <span class="comment">// 1NNNNNNN</span></div><div class="line">        <span class="keyword">int</span> <span class="keyword">index</span> = readInt(b, PREFIX_7_BITS);</div><div class="line">        readIndexedHeader(<span class="keyword">index</span> - <span class="number">1</span>);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (b == <span class="number">0x40</span>) &#123; <span class="comment">// 01000000</span></div><div class="line">        readLiteralHeaderWithIncrementalIndexingNewName();</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((b &amp; <span class="number">0x40</span>) == <span class="number">0x40</span>) &#123;  <span class="comment">// 01NNNNNN</span></div><div class="line">        <span class="keyword">int</span> <span class="keyword">index</span> = readInt(b, PREFIX_6_BITS);</div><div class="line">        readLiteralHeaderWithIncrementalIndexingIndexedName(<span class="keyword">index</span> - <span class="number">1</span>);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((b &amp; <span class="number">0x20</span>) == <span class="number">0x20</span>) &#123;  <span class="comment">// 001NNNNN</span></div><div class="line">        maxDynamicTableByteCount = readInt(b, PREFIX_5_BITS);</div><div class="line">        <span class="keyword">if</span> (maxDynamicTableByteCount &lt; <span class="number">0</span></div><div class="line">            || maxDynamicTableByteCount &gt; headerTableSizeSetting) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Invalid dynamic table size update "</span> + maxDynamicTableByteCount);</div><div class="line">        &#125;</div><div class="line">        adjustDynamicTableByteCount();</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (b == <span class="number">0x10</span> || b == <span class="number">0</span>) &#123; <span class="comment">// 000?0000 - Ignore never indexed bit.</span></div><div class="line">        readLiteralHeaderWithoutIndexingNewName();</div><div class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">// 000?NNNN - Ignore never indexed bit.</span></div><div class="line">        <span class="keyword">int</span> <span class="keyword">index</span> = readInt(b, PREFIX_4_BITS);</div><div class="line">        readLiteralHeaderWithoutIndexingIndexedName(<span class="keyword">index</span> - <span class="number">1</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> List&lt;Header&gt; getAndResetHeaderList() &#123;</div><div class="line">    List&lt;Header&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(headerList);</div><div class="line">    headerList.clear();</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">void</span> readIndexedHeader(<span class="keyword">int</span> <span class="keyword">index</span>) throws IOException &#123;</div><div class="line">    <span class="keyword">if</span> (isStaticHeader(<span class="keyword">index</span>)) &#123;</div><div class="line">      Header staticEntry = STATIC_HEADER_TABLE[<span class="keyword">index</span>];</div><div class="line">      headerList.add(staticEntry);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">int</span> dynamicTableIndex = dynamicTableIndex(<span class="keyword">index</span> - STATIC_HEADER_TABLE.length);</div><div class="line">      <span class="keyword">if</span> (dynamicTableIndex &lt; <span class="number">0</span> || dynamicTableIndex &gt; dynamicTable.length - <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Header index too large "</span> + (<span class="keyword">index</span> + <span class="number">1</span>));</div><div class="line">      &#125;</div><div class="line">      headerList.add(dynamicTable[dynamicTableIndex]);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// referencedHeaders is relative to nextHeaderIndex + 1.</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> dynamicTableIndex(<span class="keyword">int</span> <span class="keyword">index</span>) &#123;</div><div class="line">    <span class="keyword">return</span> nextHeaderIndex + <span class="number">1</span> + <span class="keyword">index</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">void</span> readLiteralHeaderWithoutIndexingIndexedName(<span class="keyword">int</span> <span class="keyword">index</span>) throws IOException &#123;</div><div class="line">    ByteString name = getName(<span class="keyword">index</span>);</div><div class="line">    ByteString value = readByteString();</div><div class="line">    headerList.add(<span class="keyword">new</span> Header(name, value));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">void</span> readLiteralHeaderWithoutIndexingNewName() throws IOException &#123;</div><div class="line">    ByteString name = checkLowercase(readByteString());</div><div class="line">    ByteString value = readByteString();</div><div class="line">    headerList.add(<span class="keyword">new</span> Header(name, value));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">void</span> readLiteralHeaderWithIncrementalIndexingIndexedName(<span class="keyword">int</span> nameIndex)</div><div class="line">      throws IOException &#123;</div><div class="line">    ByteString name = getName(nameIndex);</div><div class="line">    ByteString value = readByteString();</div><div class="line">    insertIntoDynamicTable(<span class="number">-1</span>, <span class="keyword">new</span> Header(name, value));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">void</span> readLiteralHeaderWithIncrementalIndexingNewName() throws IOException &#123;</div><div class="line">    ByteString name = checkLowercase(readByteString());</div><div class="line">    ByteString value = readByteString();</div><div class="line">    insertIntoDynamicTable(<span class="number">-1</span>, <span class="keyword">new</span> Header(name, value));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> ByteString getName(<span class="keyword">int</span> <span class="keyword">index</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (isStaticHeader(<span class="keyword">index</span>)) &#123;</div><div class="line">      <span class="keyword">return</span> STATIC_HEADER_TABLE[<span class="keyword">index</span>].name;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> dynamicTable[dynamicTableIndex(<span class="keyword">index</span> - STATIC_HEADER_TABLE.length)].name;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> isStaticHeader(<span class="keyword">int</span> <span class="keyword">index</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">index</span> &gt;= <span class="number">0</span> &amp;&amp; <span class="keyword">index</span> &lt;= STATIC_HEADER_TABLE.length - <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** index == -1 when new. */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">void</span> insertIntoDynamicTable(<span class="keyword">int</span> <span class="keyword">index</span>, Header entry) &#123;</div><div class="line">    headerList.add(entry);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> delta = entry.hpackSize;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">index</span> != <span class="number">-1</span>) &#123; <span class="comment">// Index -1 == new header.</span></div><div class="line">      delta -= dynamicTable[dynamicTableIndex(<span class="keyword">index</span>)].hpackSize;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// if the new or replacement header is too big, drop all entries.</span></div><div class="line">    <span class="keyword">if</span> (delta &gt; maxDynamicTableByteCount) &#123;</div><div class="line">      clearDynamicTable();</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Evict headers to the required length.</span></div><div class="line">    <span class="keyword">int</span> bytesToRecover = (dynamicTableByteCount + delta) - maxDynamicTableByteCount;</div><div class="line">    <span class="keyword">int</span> entriesEvicted = evictToRecoverBytes(bytesToRecover);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">index</span> == <span class="number">-1</span>) &#123; <span class="comment">// Adding a value to the dynamic table.</span></div><div class="line">      <span class="keyword">if</span> (headerCount + <span class="number">1</span> &gt; dynamicTable.length) &#123; <span class="comment">// Need to grow the dynamic table.</span></div><div class="line">        Header[] doubled = <span class="keyword">new</span> Header[dynamicTable.length * <span class="number">2</span>];</div><div class="line">        System.arraycopy(dynamicTable, <span class="number">0</span>, doubled, dynamicTable.length, dynamicTable.length);</div><div class="line">        nextHeaderIndex = dynamicTable.length - <span class="number">1</span>;</div><div class="line">        dynamicTable = doubled;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">index</span> = nextHeaderIndex--;</div><div class="line">      dynamicTable[<span class="keyword">index</span>] = entry;</div><div class="line">      headerCount++;</div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// Replace value at same position.</span></div><div class="line">      <span class="keyword">index</span> += dynamicTableIndex(<span class="keyword">index</span>) + entriesEvicted;</div><div class="line">      dynamicTable[<span class="keyword">index</span>] = entry;</div><div class="line">    &#125;</div><div class="line">    dynamicTableByteCount += delta;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>HTTP/2中数据收发两端的动态表一致性主要是依赖TCP来实现的。</p>
<p>Done。</p>
</div><div class="tags"><a href="/tags/网络协议/">网络协议</a><a href="/tags/HTTP2/">HTTP2</a><a href="/tags/Android开发/">Android开发</a><a href="/tags/源码分析/">源码分析</a></div><div class="post-nav"><a href="/2017/01/09/Caddy Web服务器QUIC部署/" class="pre">Caddy Web服务器QUIC部署</a><a href="/2016/12/08/在Android中使用FlatBuffers/" class="next">在Android中使用FlatBuffers</a></div><div data-thread-key="2016/12/15/OkHttp3中的HTTP2首部压缩/" data-title="OkHttp3中的HTTP2首部压缩" data-url="https://www.wolfcstech.com/2016/12/15/OkHttp3中的HTTP2首部压缩/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到:</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/12/15/OkHttp3中的HTTP2首部压缩/" data-title="OkHttp3中的HTTP2首部压缩" data-url="https://www.wolfcstech.com/2016/12/15/OkHttp3中的HTTP2首部压缩/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">34</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/02/24/Networking_optimization_study/">网络优化实践探索文章</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/23/OkHttp实现分析之Websocket/">OkHttp实现分析之Websocket</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/introduction_to_android_things/">Android Things介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/21/Simpleperf_Introduction/">Simpleperf介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/16/Wireshark源码安装/">Wireshark源码安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/09/Android平台Chromium net中的代理配置信息获取/">Android平台Chromium net中的代理配置信息获取</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/06/Android端打开HttpDns的正确姿势/">Android端打开HttpDns的正确姿势</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/05/虹桥火车站的卫生间/">虹桥火车站的卫生间</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/05/做自己喜欢的事/">做自己喜欢的事</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/24/QUIC及HTTP2相关资料整理/">QUIC及HTTP2相关资料整理</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-commt"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="null" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var duoshuoQuery = {short_name:'wolfcstech'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    document.getElementsByTagName('body')[0].appendChild(ds);
})();
</script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script></body></html>