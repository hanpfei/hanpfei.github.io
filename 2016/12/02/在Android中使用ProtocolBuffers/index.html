<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>在Android中使用Protocol Buffers | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">在Android中使用Protocol Buffers</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">在Android中使用Protocol Buffers</h1><div class="post-meta">Dec 2, 2016<span> | </span><span class="category"><a href="/categories/Android开发/">Android开发</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/12/02/在Android中使用ProtocolBuffers/" href="/2016/12/02/在Android中使用ProtocolBuffers/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>网络性能优化的终极手法就是不通过网络传输，但这常常是不可能的。但我们还是可以通过对网络传输的数据本身做优化，来获得更好的性能，性能就应该从每一个可能的地方榨取。这里来看一下 <strong>Protocol Buffers</strong> 。</p>
<p><strong>Protocol Buffers</strong> 是一个序列化结构数据的灵活、高效且自动化的机制——类似于XML，但<strong><em>更小</em></strong>，<strong><em>更快</em></strong>，<strong><em>更简单</em></strong>。定义一次结构化数据的方式，然后就可以使用专门生成的代码简单地写入，或用不同的语言从大量的数据流读出结构化数据。甚至可以更新数据结构而不破坏已部署的基于 <strong>老</strong> 格式编译的程序。我们看一下要如何将 <strong>Protocol Buffers</strong> 用到我们的Android项目中。</p>
<a id="more"></a>
<p>#总览<br>先来看一下 <strong>Protocol Buffers</strong> 项目已经为我们提供了什么，我们在使用 <strong>Protocol Buffers</strong> 时需要做什么的整体流程。如下图：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-b9bc1c0cc87c80e4.jpg" alt="Protocol Buffers Architecture"></p>
<p>在使用 <strong>Protocol Buffers</strong> 时，我们需要以特殊的方式定义我们的结构化数据，保存为 .proto 消息定义文件。 <strong>Protocol Buffers</strong> 项目为我们提供了编译器，可以将 .proto 文件编译为Java文件以用于我们的Java 或 Android应用项目。这个编译器在我们的PC机上编译并运行。产生的Java文件是依赖于 <strong>Protocol Buffers</strong> 的Java库的，比如这些文件实现了库的借口等。我们将生成的这些Java文件和 <strong>Protocol Buffers</strong> 的Java库引入我们的Android应用项目，就可以方便地以 <strong>Protocol Buffers</strong> 的二进制格式操作结构化数据了。</p>
<p>每次手动执行 <strong>Protocol Buffers</strong> 编译器将 .proto 文件转换为Java文件显然有点太麻烦了。 <strong>Protocol Buffers</strong> 项目的开发者显然也想到了这一点，因而他们还为我们提供了一个Android Studio gradle插件 <strong>protobuf-gradle-plugin</strong> ，以便于在我们项目的编译期间自动地执行 <strong>Protocol Buffers</strong> 编译器。</p>
<p>我们可以为 <strong>protobuf-gradle-plugin</strong> 指定本地 <strong>Protocol Buffers</strong> 编译器的路径让它使用本地的编译执行编译，也可以使用 <strong>Protocol Buffers</strong> 项目提供的另外一个工具，在编译时动态地下载并执行编译过程。</p>
<p>后面我们详细地来看这个过程。</p>
<h1 id="下载编译Protocol编译器"><a href="#下载编译Protocol编译器" class="headerlink" title="下载编译Protocol编译器"></a>下载编译Protocol编译器</h1><p>我们可以在如下位置：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/google/</span>protobuf<span class="regexp">/releases</span></div></pre></td></tr></table></figure></p>
<p>下载打包好的protobuf，也可以直接clone protobuf的代码，自己手动编译编译器。这里我们从GitHub上clone代码并手动编译编译器：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ git clone <span class="string">https:</span><span class="comment">//github.com/google/protobuf.git</span></div><div class="line">正克隆到 <span class="string">'protobuf'</span>...</div><div class="line"><span class="string">remote:</span> Counting <span class="string">objects:</span> <span class="number">38993</span>, done.</div><div class="line"><span class="string">remote:</span> Compressing <span class="string">objects:</span> <span class="number">100</span>% (<span class="number">17</span>/<span class="number">17</span>), done.</div><div class="line"><span class="string">remote:</span> Total <span class="number">38993</span> (delta <span class="number">4</span>), reused <span class="number">0</span> (delta <span class="number">0</span>), pack-reused <span class="number">38974</span></div><div class="line">接收对象中: <span class="number">100</span>% (<span class="number">38993</span><span class="regexp">/38993), 36.14 MiB | 239.00 KiB/</span>s, 完成.</div><div class="line">处理 delta 中: <span class="number">100</span>% (<span class="number">26220</span>/<span class="number">26220</span>), 完成.</div><div class="line">检查连接... 完成。</div></pre></td></tr></table></figure></p>
<p>下载代码之后，进入protobuf目录并执行 <strong>autogen.sh</strong> ：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>cd protobuf</div><div class="line"><span class="variable">$ </span>./autogen.sh </div><div class="line">Google Mock <span class="keyword">not</span> present.  Fetching gmock-<span class="number">1.7</span>.<span class="number">0</span> from the web...</div><div class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                                 Dload  Upload   Total   Spent    Left  Speed</div><div class="line"><span class="number">100</span>   <span class="number">129</span>    <span class="number">0</span>   <span class="number">129</span>    <span class="number">0</span>     <span class="number">0</span>    <span class="number">111</span>      <span class="number">0</span> --<span class="symbol">:--</span><span class="symbol">:--</span>  <span class="number">0</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">01</span> --<span class="symbol">:--</span><span class="symbol">:--</span>   <span class="number">112</span></div><div class="line"><span class="number">100</span>  <span class="number">362</span>k  <span class="number">100</span>  <span class="number">362</span>k    <span class="number">0</span>     <span class="number">0</span>  <span class="number">67764</span>      <span class="number">0</span>  <span class="number">0</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">05</span>  <span class="number">0</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">05</span> --<span class="symbol">:--</span><span class="symbol">:--</span> <span class="number">92816</span></div><div class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                                 Dload  Upload   Total   Spent    Left  Speed</div><div class="line"><span class="number">100</span>   <span class="number">129</span>    <span class="number">0</span>   <span class="number">129</span>    <span class="number">0</span>     <span class="number">0</span>    <span class="number">112</span>      <span class="number">0</span> --<span class="symbol">:--</span><span class="symbol">:--</span>  <span class="number">0</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">01</span> --<span class="symbol">:--</span><span class="symbol">:--</span>   <span class="number">112</span></div><div class="line"><span class="number">100</span>  <span class="number">618</span>k  <span class="number">100</span>  <span class="number">618</span>k    <span class="number">0</span>     <span class="number">0</span>  <span class="number">56321</span>      <span class="number">0</span>  <span class="number">0</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">11</span>  <span class="number">0</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">11</span> --<span class="symbol">:--</span><span class="symbol">:--</span>  <span class="number">115</span>k</div><div class="line">+ autoreconf -f -i -Wall,no-obsolete</div><div class="line"><span class="symbol">libtoolize:</span> putting auxiliary files <span class="keyword">in</span> AC_CONFIG_AUX_DIR, <span class="string">'build-aux'</span>.</div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>这个脚本主要用于下载测试用的gmock-1.7.0，并生成用于编译配置的 <strong>configure</strong> 等文件。可以通过如下命令了解我们可以对protobuf的编译做哪些配置，以及默认配置的信息：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">$ ./configure --<span class="keyword">help</span></div><div class="line"><span class="symbol">`configure'</span> configures Protocol Buffers 3.1.0 to adapt to many kinds of systems.</div><div class="line"></div><div class="line">Usage: ./configure [OPTION]... [<span class="keyword">VAR</span>=VALUE]...</div><div class="line"></div><div class="line">To assign environment variables (<span class="keyword">e</span>.<span class="keyword">g</span>., <span class="keyword">CC</span>, CFLAGS...), specify them <span class="keyword">as</span></div><div class="line"><span class="keyword">VAR</span>=VALUE.  See below <span class="keyword">for</span> descriptions of some of the useful variables.</div><div class="line"></div><div class="line">Defaults <span class="keyword">for</span> the options are specified <span class="keyword">in</span> brackets.</div><div class="line"></div><div class="line">Configuration:</div><div class="line">  -<span class="keyword">h</span>, --<span class="keyword">help</span>              <span class="keyword">display</span> this <span class="keyword">help</span> and <span class="keyword">exit</span></div><div class="line">      --<span class="keyword">help</span>=short        <span class="keyword">display</span> options specific to this package</div><div class="line">      --<span class="keyword">help</span>=recursive    <span class="keyword">display</span> the short <span class="keyword">help</span> of all the included packages</div><div class="line">  -V, --<span class="keyword">version</span>           <span class="keyword">display</span> <span class="keyword">version</span> information and <span class="keyword">exit</span></div><div class="line">  -q, --quiet, --silent   <span class="keyword">do</span> not <span class="keyword">print</span> `checking ...' messages</div><div class="line">      --cache-<span class="keyword">file</span>=<span class="keyword">FILE</span>   cache <span class="keyword">test</span> results <span class="keyword">in</span> <span class="keyword">FILE</span> [disabled]</div><div class="line">  -C, --config-cache      alias <span class="keyword">for</span> `--cache-<span class="keyword">file</span>=config.cache'</div><div class="line">  -<span class="keyword">n</span>, --<span class="keyword">no</span>-create         <span class="keyword">do</span> not create output files</div><div class="line">      --srcdir=<span class="keyword">DIR</span>        find the sources <span class="keyword">in</span> <span class="keyword">DIR</span> [configure <span class="keyword">dir</span> or `..']</div><div class="line"></div><div class="line">Installation directories:</div><div class="line">  --prefix=PREFIX         install architecture-independent files <span class="keyword">in</span> PREFIX</div><div class="line">                          [/usr/<span class="keyword">local</span>]</div><div class="line">  --exec-prefix=EPREFIX   install architecture-dependent files <span class="keyword">in</span> EPREFIX</div><div class="line">                          [PREFIX]</div><div class="line"></div><div class="line"><span class="keyword">By</span> default, `make install' will install all the files <span class="keyword">in</span></div><div class="line">`/usr/<span class="keyword">local</span>/bin', `/usr/<span class="keyword">local</span>/lib' etc.  You can specify</div><div class="line"><span class="keyword">an</span> installation prefix other than `/usr/<span class="keyword">local</span>' using `--prefix',</div><div class="line"><span class="keyword">for</span> instance `--prefix=<span class="variable">$HOME</span>'.</div><div class="line"></div><div class="line"><span class="keyword">For</span> better control, <span class="keyword">use</span> the options below.</div><div class="line"></div><div class="line">Fine tuning of the installation directories:</div><div class="line">  --bindir=<span class="keyword">DIR</span>            user executables [EPREFIX/bin]</div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>执行configure对编译进行配置：<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">$</span> ./configure </div><div class="line"><span class="function"><span class="title">checking</span></span> whether to enable maintainer-specific portions of Makefiles... <span class="keyword">yes</span></div><div class="line"><span class="function"><span class="title">checking</span></span> build <span class="keyword">system</span> type... x86_64-pc-linux-gnu</div><div class="line"><span class="function"><span class="title">checking</span></span> host <span class="keyword">system</span> type... x86_64-pc-linux-gnu</div><div class="line"><span class="function"><span class="title">checking</span></span> target <span class="keyword">system</span> type... x86_64-pc-linux-gnu</div><div class="line"><span class="function"><span class="title">checking</span></span> <span class="keyword">for</span> a BSD-compatible install... /usr/bin/install -c</div><div class="line"><span class="function"><span class="title">checking</span></span> whether build environment is sane... <span class="keyword">yes</span></div><div class="line"><span class="function"><span class="title">checking</span></span> <span class="keyword">for</span> a thread-safe mkdir -p... /bin/mkdir -p</div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>这样就生成了makefile文件，编译并安装：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>make</div><div class="line"><span class="variable">$ </span>sudo make install</div></pre></td></tr></table></figure></p>
<p>这个过程在编译并安装 <strong>Protocol Buffers</strong> 编译器之外，还会为host编译用于支持在C++中使用 <strong>Protocol Buffers</strong> 的库。（编译生成的二进制文加在 <strong>protobuf/src/.libs</strong> 下。）</p>
<p>安装之后执行如下命令以确认已经装好：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ protoc --version</div><div class="line">libprotoc <span class="number">3.1</span><span class="number">.0</span></div></pre></td></tr></table></figure></p>
<p>在执行protoc时通过给它加上 <strong>–help</strong> 参数可以了解到这个工具更多的用法。<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">$ protoc <span class="comment">--help</span></div><div class="line">Usage: protoc [OPTION] PROTO_FILES</div><div class="line">Parse PROTO_FILES <span class="keyword">and</span> generate output based <span class="keyword">on</span> <span class="keyword">the</span> options <span class="keyword">given</span>:</div><div class="line">  -IPATH, <span class="comment">--proto_path=PATH   Specify the directory in which to search for</span></div><div class="line">                              imports.  May be specified multiple <span class="keyword">times</span>;</div><div class="line">                              directories will be searched <span class="keyword">in</span> order.  If <span class="keyword">not</span></div><div class="line">                              <span class="keyword">given</span>, <span class="keyword">the</span> current working directory <span class="keyword">is</span> used.</div><div class="line">  <span class="comment">--version                   Show version info and exit.</span></div><div class="line">  -h, <span class="comment">--help                  Show this text and exit.</span></div><div class="line">  <span class="comment">--encode=MESSAGE_TYPE       Read a text-format message of the given type</span></div><div class="line">                              <span class="keyword">from</span> standard input <span class="keyword">and</span> <span class="built_in">write</span> <span class="keyword">it</span> <span class="keyword">in</span> binary</div><div class="line">                              <span class="keyword">to</span> standard output.  The message type must</div><div class="line">                              be defined <span class="keyword">in</span> PROTO_FILES <span class="keyword">or</span> their imports.</div><div class="line">  <span class="comment">--decode=MESSAGE_TYPE       Read a binary message of the given type from</span></div><div class="line">                              standard input <span class="keyword">and</span> <span class="built_in">write</span> <span class="keyword">it</span> <span class="keyword">in</span> <span class="built_in">text</span> format</div><div class="line">                              <span class="keyword">to</span> standard output.  The message type must</div><div class="line">                              be defined <span class="keyword">in</span> PROTO_FILES <span class="keyword">or</span> their imports.</div><div class="line">  <span class="comment">--decode_raw                Read an arbitrary protocol message from</span></div><div class="line">                              standard input <span class="keyword">and</span> <span class="built_in">write</span> <span class="keyword">the</span> raw tag/value</div><div class="line">                              pairs <span class="keyword">in</span> <span class="built_in">text</span> format <span class="keyword">to</span> standard output.  No</div><div class="line">                              PROTO_FILES should be <span class="keyword">given</span> when using this</div><div class="line">                              flag.</div><div class="line">  -oFILE,                     Writes a FileDescriptorSet (a protocol buffer,</div><div class="line">    <span class="comment">--descriptor_set_out=FILE defined in descriptor.proto) containing all of</span></div><div class="line">                              <span class="keyword">the</span> input files <span class="keyword">to</span> FILE.</div><div class="line">  <span class="comment">--include_imports           When using --descriptor_set_out, also include</span></div><div class="line">                              all dependencies <span class="keyword">of</span> <span class="keyword">the</span> input files <span class="keyword">in</span> <span class="keyword">the</span></div><div class="line">                              <span class="keyword">set</span>, so <span class="keyword">that</span> <span class="keyword">the</span> <span class="keyword">set</span> <span class="keyword">is</span> self-contained.</div><div class="line">  <span class="comment">--include_source_info       When using --descriptor_set_out, do not strip</span></div><div class="line">                              SourceCodeInfo <span class="keyword">from</span> <span class="keyword">the</span> FileDescriptorProto.</div><div class="line">                              This results <span class="keyword">in</span> vastly larger descriptors <span class="keyword">that</span></div><div class="line">                              include information <span class="keyword">about</span> <span class="keyword">the</span> original</div><div class="line">                              location <span class="keyword">of</span> each decl <span class="keyword">in</span> <span class="keyword">the</span> source <span class="built_in">file</span> <span class="keyword">as</span></div><div class="line">                              well <span class="keyword">as</span> surrounding comments.</div><div class="line">  <span class="comment">--dependency_out=FILE       Write a dependency output file in the format</span></div><div class="line">                              expected <span class="keyword">by</span> make. This writes <span class="keyword">the</span> transitive</div><div class="line">                              <span class="keyword">set</span> <span class="keyword">of</span> input <span class="built_in">file</span> paths <span class="keyword">to</span> FILE</div><div class="line">  <span class="comment">--error_format=FORMAT       Set the format in which to print errors.</span></div><div class="line">                              FORMAT may be 'gcc' (<span class="keyword">the</span> default) <span class="keyword">or</span> 'msvs'</div><div class="line">                              (Microsoft Visual Studio format).</div><div class="line">  <span class="comment">--print_free_field_numbers  Print the free field numbers of the messages</span></div><div class="line">                              defined <span class="keyword">in</span> <span class="keyword">the</span> <span class="keyword">given</span> proto files. Groups share</div><div class="line">                              <span class="keyword">the</span> same field <span class="built_in">number</span> <span class="literal">space</span> <span class="keyword">with</span> <span class="keyword">the</span> parent </div><div class="line">                              message. Extension ranges are counted <span class="keyword">as</span> </div><div class="line">                              occupied fields numbers.</div><div class="line"></div><div class="line">  <span class="comment">--plugin=EXECUTABLE         Specifies a plugin executable to use.</span></div><div class="line">                              Normally, protoc searches <span class="keyword">the</span> PATH <span class="keyword">for</span></div><div class="line">                              plugins, <span class="keyword">but</span> you may specify additional</div><div class="line">                              executables <span class="keyword">not</span> <span class="keyword">in</span> <span class="keyword">the</span> path using this flag.</div><div class="line">                              Additionally, EXECUTABLE may be <span class="keyword">of</span> <span class="keyword">the</span> form</div><div class="line">                              NAME=PATH, <span class="keyword">in</span> which case <span class="keyword">the</span> <span class="keyword">given</span> plugin <span class="built_in">name</span></div><div class="line">                              <span class="keyword">is</span> mapped <span class="keyword">to</span> <span class="keyword">the</span> <span class="keyword">given</span> executable even <span class="keyword">if</span></div><div class="line">                              <span class="keyword">the</span> executable's own <span class="built_in">name</span> differs.</div><div class="line">  <span class="comment">--cpp_out=OUT_DIR           Generate C++ header and source.</span></div><div class="line">  <span class="comment">--csharp_out=OUT_DIR        Generate C# source file.</span></div><div class="line">  <span class="comment">--java_out=OUT_DIR          Generate Java source file.</span></div><div class="line">  <span class="comment">--javanano_out=OUT_DIR      Generate Java Nano source file.</span></div><div class="line">  <span class="comment">--js_out=OUT_DIR            Generate JavaScript source.</span></div><div class="line">  <span class="comment">--objc_out=OUT_DIR          Generate Objective C header and source.</span></div><div class="line">  <span class="comment">--php_out=OUT_DIR           Generate PHP source file.</span></div><div class="line">  <span class="comment">--python_out=OUT_DIR        Generate Python source file.</span></div><div class="line">  <span class="comment">--ruby_out=OUT_DIR          Generate Ruby source file.</span></div></pre></td></tr></table></figure></p>
<h1 id="创建-proto-文件"><a href="#创建-proto-文件" class="headerlink" title="创建 .proto 文件"></a>创建 .proto 文件</h1><p> .proto 文件中的定义很简单：为每个想要序列化的数据结构添加一个 <em>消息(message)</em> ，然后为消息中的每个字段指定一个名字和类型以及一个tag数字。如官方提供的一个例子addressbook.proto：<br><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> tutorial;</div><div class="line"></div><div class="line"><span class="keyword">option</span> java_package = <span class="string">"com.example.tutorial"</span>;</div><div class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">"AddressBookProtos"</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">message</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">required</span> <span class="built_in">string</span> name = <span class="number">1</span>;</div><div class="line">  <span class="keyword">required</span> <span class="built_in">int32</span> id = <span class="number">2</span>;</div><div class="line">  <span class="keyword">optional</span> <span class="built_in">string</span> email = <span class="number">3</span>;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">PhoneType</span> </span>&#123;</div><div class="line">    MOBILE = <span class="number">0</span>;</div><div class="line">    HOME = <span class="number">1</span>;</div><div class="line">    WORK = <span class="number">2</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">message</span> <span class="title">PhoneNumber</span> </span>&#123;</div><div class="line">    <span class="keyword">required</span> <span class="built_in">string</span> number = <span class="number">1</span>;</div><div class="line">    <span class="keyword">optional</span> PhoneType type = <span class="number">2</span> [default = HOME];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">repeated</span> PhoneNumber phone = <span class="number">4</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">message</span> <span class="title">AddressBook</span> </span>&#123;</div><div class="line">  <span class="keyword">repeated</span> Person person = <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以参考 <a href="http://www.jianshu.com/p/1bf426a9f8f4" target="_blank" rel="external">在Java中使用Protocol Buffers</a> 一文了解更多关于创建 .proto 文件的基础知识。</p>
<h1 id="编译-proto-文件"><a href="#编译-proto-文件" class="headerlink" title="编译 .proto 文件"></a>编译 .proto 文件</h1><p>可以通过如下命令编译 .proto 文件：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">protoc</span> -I=<span class="variable">$SRC_DIR</span> --java_out=<span class="variable">$DST_DIR</span> <span class="variable">$SRC_DIR</span>/addressbook.proto</div></pre></td></tr></table></figure></p>
<p>-I，–java_out 分别用于指定源目录 (放置应用程序源代码的地方 —— 如果没有提供则使用当前目录)，目的目录 (希望放置生成的代码的位置；通常与$SRC_DIR相同)，最后的参数为 .proto 文件的路径。protoc会按照标准Java风格，生成Java类及目录结构。如对于上面的例子，会生成 <strong>com/example/tutorial/</strong> 目录结构，及 <strong>AddressBookProtos.java</strong> 文件。</p>
<h1 id="在Android项目中使用-Protocol-Buffers"><a href="#在Android项目中使用-Protocol-Buffers" class="headerlink" title="在Android项目中使用 Protocol Buffers"></a>在Android项目中使用 Protocol Buffers</h1><p>我们将 由 .proto 文件生成的Java文件复制到我们的Android项目中：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-a61387d76b3fb420.png" alt=""></p>
<p>在我们app的build.gradle中添加对 <strong>protobuf-java</strong> 的依赖，就像依赖其它那些Java库一样：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</div><div class="line">    testCompile <span class="string">'junit:junit:4.12'</span></div><div class="line"></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:appcompat-v7:23.4.0'</span></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.google.protobuf:protobuf-java:3.0.0'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>添加访问Protocol Buffers的类的类。这里我们添加两个类，AddPerson用于构造Person对象：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">package com.netease.volleydemo<span class="comment">;</span></div><div class="line"></div><div class="line">import com.example.tutorial.<span class="keyword">AddressBookProtos.Person;</span></div><div class="line"></div><div class="line">public class <span class="keyword">AddPerson </span>&#123;</div><div class="line">    static Person createPerson(String personName) &#123;</div><div class="line">        Person.<span class="keyword">Builder </span>person = Person.newBuilder()<span class="comment">;</span></div><div class="line"></div><div class="line">        int id = <span class="number">13958235</span><span class="comment">;</span></div><div class="line">        person.setId(id)<span class="comment">;</span></div><div class="line"></div><div class="line">        String name = personName<span class="comment">;</span></div><div class="line">        person.setName(name)<span class="comment">;</span></div><div class="line"></div><div class="line">        String email = <span class="string">"zhangsan@gmail.com"</span><span class="comment">;</span></div><div class="line">        person.setEmail(email)<span class="comment">;</span></div><div class="line"></div><div class="line">        Person.PhoneNumber.<span class="keyword">Builder </span>phoneNumber = Person.PhoneNumber.newBuilder()<span class="comment">;</span></div><div class="line">        phoneNumber.setType(Person.PhoneType.HOME)<span class="comment">;</span></div><div class="line">        phoneNumber.setNumber(<span class="string">"0157-23443276"</span>)<span class="comment">;</span></div><div class="line"></div><div class="line">        person.<span class="keyword">addPhone(phoneNumber.build());</span></div><div class="line"></div><div class="line">        phoneNumber = Person.PhoneNumber.newBuilder()<span class="comment">;</span></div><div class="line">        phoneNumber.setType(Person.PhoneType.MOBILE)<span class="comment">;</span></div><div class="line">        phoneNumber.setNumber(<span class="string">"136183667387"</span>)<span class="comment">;</span></div><div class="line"></div><div class="line">        person.<span class="keyword">addPhone(phoneNumber.build());</span></div><div class="line"></div><div class="line">        return person.<span class="keyword">build();</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AddressBookProtobuf类则用于编码/解码AddressBook对象：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.netease.volleydemo;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.example.tutorial.AddressBookProtos;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddressBookProtobuf</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encodeTest(String[] names) &#123;</div><div class="line"></div><div class="line">        AddressBookProtos.AddressBook.Builder addressBook = AddressBookProtos.AddressBook.newBuilder();</div><div class="line"></div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; names.length; ++ i) &#123;</div><div class="line">            addressBook.addPerson(AddPerson.createPerson(names[i]));</div><div class="line">        &#125;</div><div class="line">        AddressBookProtos.AddressBook book = addressBook.build();</div><div class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            book.writeTo(baos);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">return</span> baos.<span class="title">toByteArray</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encodeTest(String[] names, <span class="keyword">int</span> times) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; times - <span class="number">1</span>; ++ i) &#123;</div><div class="line">            encodeTest(names);</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">return</span> <span class="title">encodeTest</span><span class="params">(names)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AddressBookProtos.<span class="function">AddressBook <span class="title">decodeTest</span><span class="params">(InputStream is)</span> </span>&#123;</div><div class="line">        AddressBookProtos.AddressBook addressBook = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            addressBook = AddressBookProtos.AddressBook.parseFrom(is);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> addressBook;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AddressBookProtos.<span class="function">AddressBook <span class="title">decodeTest</span><span class="params">(InputStream is, <span class="keyword">int</span> times)</span> </span>&#123;</div><div class="line">        AddressBookProtos.AddressBook addressBook = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; times; ++ i) &#123;</div><div class="line">            addressBook = decodeTest(is);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> addressBook;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="使用protobuf-gradle-plugin"><a href="#使用protobuf-gradle-plugin" class="headerlink" title="使用protobuf-gradle-plugin"></a>使用protobuf-gradle-plugin</h1><p>每次单独执行protoc编译 .proto 文件总是太麻烦，通过protobuf-gradle-plugin可以在编译我们的app时自动地编译 .proto 文件，这样就大大降低了我们在Android项目中使用 <strong>Protocol Buffers</strong> 的难度。</p>
<p>首先我们需要将 .proto 文件添加进我们的项目中，如：<br><img src="https://www.wolfcstech.com/images/1315506-ec51f69a6134805e.png" alt=""></p>
<p>然后修改 <strong>app/build.gradle</strong> 对protobuf gradle插件做配置：</p>
<ol>
<li><p>为buildscript添加对<code>protobuf-gradle-plugin</code>的依赖：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">buildscript</span> &#123;</div><div class="line">    <span class="keyword">repositories</span> &#123;</div><div class="line">        jcenter()</div><div class="line">        mavenCentral()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">dependencies</span> &#123;</div><div class="line">        <span class="keyword">classpath</span> <span class="string">'com.google.protobuf:protobuf-gradle-plugin:0.8.0'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在<code>apply plugin: &#39;com.android.application&#39;</code>后面应用protobuf的plugin：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></div><div class="line">apply <span class="string">plugin:</span> <span class="string">'com.google.protobuf'</span></div></pre></td></tr></table></figure>
</li>
<li><p>添加protobuf块，对protobuf-gradle-plugin的执行做配置：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">protobuf &#123;</div><div class="line">    protoc &#123;</div><div class="line">        path = <span class="string">'/usr/local/bin/protoc'</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    generateProtoTasks &#123;</div><div class="line">        all()<span class="selector-class">.each</span> &#123; task -&gt;</div><div class="line">            task<span class="selector-class">.builtins</span> &#123;</div><div class="line">                remove java</div><div class="line">            &#125;</div><div class="line">            task<span class="selector-class">.builtins</span> &#123;</div><div class="line">                java &#123; &#125;</div><div class="line">                <span class="comment">// Add cpp output without any option.</span></div><div class="line">                <span class="comment">// DO NOT omit the braces if you want this builtin to be added.</span></div><div class="line">                cpp &#123; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p><code>protoc</code>块用于配置Protocol Buffers编译器，这里我们指定用我们之前手动编译的编译器。<br><code>task.builtins</code>的块必不可少，这个块用于指定我们要为那些编程语言生成代码，这里我们为C++和Java生成代码。缺少这个块的话，在编译时会报出如下的错误：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="string">Information:</span>Gradle tasks [:<span class="string">app:</span>generateDebugSources, :<span class="string">app:</span>mockableAndroidJar, :<span class="string">app:</span>prepareDebugUnitTestDependencies, :<span class="string">app:</span>generateDebugAndroidTestSources, :<span class="string">netlib:</span>generateDebugSources, :<span class="string">netlib:</span>mockableAndroidJar, :<span class="string">netlib:</span>prepareDebugUnitTestDependencies, :<span class="string">netlib:</span>generateDebugAndroidTestSources]</div><div class="line"><span class="string">Error:</span>Execution failed <span class="keyword">for</span> task <span class="string">':app:generateDebugProto'</span>.</div><div class="line">&gt; <span class="string">protoc:</span> <span class="string">stdout:</span> . <span class="string">stderr:</span> <span class="regexp">/media/</span>data<span class="regexp">/CorpProjects/</span>netlibdemo<span class="regexp">/app/</span>build<span class="regexp">/extracted-protos/</span><span class="string">main:</span> <span class="string">warning:</span> directory does not exist.</div><div class="line">  <span class="regexp">/media/</span>data<span class="regexp">/CorpProjects/</span>netlibdemo<span class="regexp">/app/</span>src<span class="regexp">/debug/</span><span class="string">proto:</span> <span class="string">warning:</span> directory does not exist.</div><div class="line">  <span class="regexp">/media/</span>data<span class="regexp">/CorpProjects/</span>netlibdemo<span class="regexp">/app/</span>build<span class="regexp">/extracted-protos/</span><span class="string">debug:</span> <span class="string">warning:</span> directory does not exist.</div><div class="line">  <span class="regexp">/media/</span>data<span class="regexp">/CorpProjects/</span>netlibdemo<span class="regexp">/app/</span>build<span class="regexp">/extracted-include-protos/</span><span class="string">debug:</span> <span class="string">warning:</span> directory does not exist.</div><div class="line">  <span class="regexp">/media/</span>data<span class="regexp">/CorpProjects/</span>netlibdemo<span class="regexp">/app/</span>src<span class="regexp">/debug/</span><span class="string">proto:</span> <span class="string">warning:</span> directory does not exist.</div><div class="line">  <span class="regexp">/media/</span>data<span class="regexp">/CorpProjects/</span>netlibdemo<span class="regexp">/app/</span>build<span class="regexp">/extracted-protos/</span><span class="string">debug:</span> <span class="string">warning:</span> directory does not exist.</div><div class="line">  <span class="regexp">/media/</span>data<span class="regexp">/CorpProjects/</span>netlibdemo<span class="regexp">/app/</span>build<span class="regexp">/extracted-include-protos/</span><span class="string">debug:</span> <span class="string">warning:</span> directory does not exist.</div><div class="line">  Missing output directives.</div></pre></td></tr></table></figure></p>
<p>提示说没有指定输出目录的路径。<br>这是由于 protobuf-gradle-plugin 执行的protobuf编译器命令的参数是在<code>protobuf-gradle-plugin/src/main/groovy/com/google/protobuf/gradle/GenerateProtoTask.groovy</code>中构造的：<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">def <span class="keyword">cmd</span><span class="bash"> = [ tools.protoc.path ]</span></div><div class="line"><span class="keyword">cmd</span>.<span class="bash">addAll(<span class="built_in">dirs</span>)</span></div><div class="line"></div><div class="line">// Handle code generation built-ins</div><div class="line">builtins.each &#123; builtin -&gt;</div><div class="line">  String outPrefix = makeOptionsPrefix(builtin.options)</div><div class="line">  <span class="keyword">cmd</span><span class="bash"> += <span class="string">"--<span class="variable">$&#123;builtin.name&#125;</span>_out=<span class="variable">$&#123;outPrefix&#125;</span><span class="variable">$&#123;getOutputDir(builtin)&#125;</span>"</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line">// Handle code generation plugins</div><div class="line">plugins.each &#123; plugin -&gt;</div><div class="line">  String name = plugin.name</div><div class="line">  ExecutableLocator locator = tools.plugins.findByName(name)</div><div class="line">  if (locator == null) &#123;</div><div class="line">    throw new GradleException(<span class="string">"Codegen plugin $&#123;name&#125; not defined"</span>)</div><div class="line">  &#125;</div><div class="line">  String pluginOutPrefix = makeOptionsPrefix(plugin.options)</div><div class="line">  <span class="keyword">cmd</span><span class="bash"> += <span class="string">"--<span class="variable">$&#123;name&#125;</span>_out=<span class="variable">$&#123;pluginOutPrefix&#125;</span><span class="variable">$&#123;getOutputDir(plugin)&#125;</span>"</span></span></div><div class="line">  <span class="keyword">cmd</span><span class="bash"> += <span class="string">"--plugin=protoc-gen-<span class="variable">$&#123;name&#125;</span>=<span class="variable">$&#123;locator.path&#125;</span>"</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line">if (generateDescriptorSet) &#123;</div><div class="line">  def path = getDescriptorPath()</div><div class="line">  // Ensure that the folder for the descriptor exists;</div><div class="line">  // the <span class="keyword">user</span> may have set it to point outside an existing tree</div><div class="line">  def folder = new File(path).parentFile</div><div class="line">  if (!folder.exists()) &#123;</div><div class="line">    folder.mkdirs()</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">cmd</span><span class="bash"> += <span class="string">"--descriptor_set_out=<span class="variable">$&#123;path&#125;</span>"</span></span></div><div class="line">  if (descriptorSetOptions.includeImports) &#123;</div><div class="line">    <span class="keyword">cmd</span><span class="bash"> += <span class="string">"--include_imports"</span></span></div><div class="line">  &#125;</div><div class="line">  if (descriptorSetOptions.includeSourceInfo) &#123;</div><div class="line">    <span class="keyword">cmd</span><span class="bash"> += <span class="string">"--include_source_info"</span></span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">cmd</span>.<span class="bash">addAll protoFiles</span></div><div class="line">logger.log(LogLevel.INFO, <span class="keyword">cmd</span>.<span class="bash">toString())</span></div><div class="line">def stdout = new StringBuffer()</div><div class="line">def stderr = new StringBuffer()</div><div class="line">Process result = <span class="keyword">cmd</span>.<span class="bash">execute()</span></div><div class="line">result.waitForProcessOutput(stdout, stderr)</div><div class="line">def output = <span class="string">"protoc: stdout: $&#123;stdout&#125;. stderr: $&#123;stderr&#125;"</span></div><div class="line">logger.log(LogLevel.INFO, <span class="keyword">cmd</span><span class="bash">)</span></div><div class="line">if (result.exitValue() == <span class="number">0</span>) &#123;</div><div class="line">  logger.log(LogLevel.INFO, output)</div><div class="line">&#125; else &#123;</div><div class="line">  throw new GradleException(output)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，输出目录是由builtins构造的。</p>
<ol>
<li>指定 .proto 文件的路径<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="section">sourceSets</span> &#123;</div><div class="line">    <span class="section">main</span> &#123;</div><div class="line">        <span class="section">java</span> &#123;</div><div class="line">            <span class="attribute">srcDir</span> <span class="string">'src/main/java'</span></div><div class="line">        &#125;</div><div class="line">        proto &#123;</div><div class="line">            <span class="attribute">srcDir</span> <span class="string">'src/main/proto'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>这样我们就不用那么麻烦每次手动执行protoc了。</p>
<p>对前面的protobuf块做一点点修改，我们甚至来编译protobuf编译器都不需要了。修改如下：<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">protobuf &#123;</div><div class="line">    protoc &#123;</div><div class="line">        artifact = <span class="string">'com.google.protobuf:protoc:3.0.0'</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    generateProtoTasks &#123;</div><div class="line">        all().each &#123; task -&gt;</div><div class="line">            task.builtins &#123;</div><div class="line">                remove java</div><div class="line">            &#125;</div><div class="line">            task.builtins &#123;</div><div class="line">                java &#123; &#125;</div><div class="line">                cpp &#123; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于 .proto 文件的编写方法，Protocol Buffers API等更多内容，可以参考 <a href="http://www.jianshu.com/p/3ab14a2cb477" target="_blank" rel="external">Protobuf开发者指南</a>、<a href="http://www.jianshu.com/p/1bf426a9f8f4" target="_blank" rel="external">在Java中使用Protocol Buffers</a>及其它相关官方文档。</p>
<h1 id="Protobuf-与-JSON-对比测试"><a href="#Protobuf-与-JSON-对比测试" class="headerlink" title="Protobuf 与 JSON 对比测试"></a>Protobuf 与 JSON 对比测试</h1><p>说了半天，Protobuf的表现究竟如何呢？这里我们就对比一下我们最常用到的JSON格式与Protobuf的表现。测试基于在开发者中一向有着良好口碑的fastjson进行。</p>
<p>测试用的数据结构如我们前面看到的AddressBook。我们通过构造包含不同个数Person的AddressBook数据，并对这些数据执行多次编码解码操作，来测试Protobuf 与 JSON的表现。Protobuf的编码/解码测试代码如前面看到的AddressBookProtobuf。JSON的测试代码则如下面这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.netease.volleydemo;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddressBookJson</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> PhoneType &#123;</div><div class="line">        MOBILE,</div><div class="line">        HOME,</div><div class="line">        WORK</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Phone</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> String number;</div><div class="line">        <span class="keyword">private</span> PhoneType type;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Phone</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNumber</span><span class="params">(String number)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.number = number;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> number;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(PhoneType phoneType)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.type = phoneType;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> PhoneType <span class="title">getType</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> type;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> String name;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">        <span class="keyword">private</span> String email;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> List&lt;Phone&gt; phones;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</div><div class="line">            phones = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.name = name;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> name;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.id = id;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> id;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmail</span><span class="params">(String email)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.email = email;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getEmail</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> email;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPhone</span><span class="params">(Phone phone)</span> </span>&#123;</div><div class="line">            phones.add(phone);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> List&lt;Phone&gt; <span class="title">getPhones</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> phones;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AddressBook</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> List&lt;Person&gt; persons;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AddressBook</span><span class="params">()</span> </span>&#123;</div><div class="line">            persons = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPerson</span><span class="params">(Person person)</span> </span>&#123;</div><div class="line">            persons.add(person);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">getPersons</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> persons;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encodeTest</span><span class="params">(String[] names)</span> </span>&#123;</div><div class="line">        AddressBook addressBook = <span class="keyword">new</span> AddressBook();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; names.length; ++ i) &#123;</div><div class="line">            Person person = <span class="keyword">new</span> Person();</div><div class="line">            person.setName(names[i]);</div><div class="line">            person.setEmail(<span class="string">"zhangsan@gmail.com"</span>);</div><div class="line">            person.setId(<span class="number">13958235</span>);</div><div class="line"></div><div class="line">            Phone phone = <span class="keyword">new</span> Phone();</div><div class="line">            phone.setNumber(<span class="string">"0157-23443276"</span>);</div><div class="line">            phone.setType(PhoneType.HOME);</div><div class="line">            person.addPhone(phone);</div><div class="line"></div><div class="line">            phone = <span class="keyword">new</span> Phone();</div><div class="line">            phone.setNumber(<span class="string">"136183667387"</span>);</div><div class="line">            phone.setType(PhoneType.MOBILE);</div><div class="line">            person.addPhone(phone);</div><div class="line"></div><div class="line">            addressBook.addPerson(person);</div><div class="line">        &#125;</div><div class="line">        String jsonString = JSON.toJSONString(addressBook);</div><div class="line">        <span class="keyword">return</span> jsonString;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encodeTest</span><span class="params">(String[] names, <span class="keyword">int</span> times)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; times - <span class="number">1</span>; ++ i) &#123;</div><div class="line">            encodeTest(names);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> encodeTest(names);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AddressBook <span class="title">decodeTest</span><span class="params">(String jsonStr, <span class="keyword">int</span> times)</span> </span>&#123;</div><div class="line">        AddressBook addressBook = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; times; ++ i) &#123;</div><div class="line">            addressBook = JSON.parseObject(jsonStr, AddressBook.class);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> addressBook;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过如下的这段代码来执行测试：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">class</span> ProtobufTestTask <span class="keyword">extends</span> AsyncTask&lt;<span class="keyword">Void</span>, <span class="keyword">Void</span>, <span class="keyword">Void</span>&gt; &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_LEN = <span class="number">8192</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doEncodeTest(String[] names, <span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        <span class="keyword">long</span> startTime = System.nanoTime();</div><div class="line">        AddressBookProtobuf.encodeTest(names, <span class="keyword">times</span>);</div><div class="line">        <span class="keyword">long</span> protobufTime = System.nanoTime();</div><div class="line">        protobufTime = protobufTime - startTime;</div><div class="line"></div><div class="line">        startTime = System.nanoTime();</div><div class="line">        AddressBookJson.encodeTest(names, <span class="keyword">times</span>);</div><div class="line">        <span class="keyword">long</span> jsonTime = System.nanoTime();</div><div class="line">        jsonTime = jsonTime - startTime;</div><div class="line">        Log.i(TAG, String.format(<span class="string">"%-20s%-20s%-20s%-20s"</span>, <span class="string">"ProtobufTime"</span>, String.valueOf(protobufTime),</div><div class="line">                <span class="string">"JsonTime"</span>, String.valueOf(jsonTime)));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doEncodeTest10(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doEncodeTest(TestUtils.sTestNames10, <span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doEncodeTest50(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doEncodeTest(TestUtils.sTestNames50, <span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doEncodeTest100(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doEncodeTest(TestUtils.sTestNames100, <span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doEncodeTest(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doEncodeTest10(<span class="keyword">times</span>);</div><div class="line">        doEncodeTest50(<span class="keyword">times</span>);</div><div class="line">        doEncodeTest100(<span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> compress(InputStream is, OutputStream os)</div><div class="line">            <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">        GZIPOutputStream gos = <span class="keyword">new</span> GZIPOutputStream(os);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> <span class="keyword">count</span>;</div><div class="line">        <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER_LEN];</div><div class="line">        <span class="keyword">while</span> ((<span class="keyword">count</span> = is.<span class="keyword">read</span>(data, <span class="number">0</span>, BUFFER_LEN)) != -<span class="number">1</span>) &#123;</div><div class="line">            gos.<span class="keyword">write</span>(data, <span class="number">0</span>, <span class="keyword">count</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        gos.finish();</div><div class="line">        gos.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doDecodeTest(String[] names, <span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        <span class="keyword">byte</span>[] protobufBytes = AddressBookProtobuf.encodeTest(names);</div><div class="line">        ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(protobufBytes);</div><div class="line"></div><div class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            compress(bais, baos);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        Log.i(TAG, String.format(<span class="string">"%-20s%-20s%-20s%-20s"</span>, <span class="string">"Protobuf Length"</span>, String.valueOf(protobufBytes.length),</div><div class="line">                <span class="string">"Protobuf(GZIP) Length"</span>, String.valueOf(baos.toByteArray().length)));</div><div class="line"></div><div class="line">        bais = <span class="keyword">new</span> ByteArrayInputStream(protobufBytes);</div><div class="line">        <span class="keyword">long</span> startTime = System.nanoTime();</div><div class="line">        AddressBookProtobuf.decodeTest(bais, <span class="keyword">times</span>);</div><div class="line">        <span class="keyword">long</span> protobufTime = System.nanoTime();</div><div class="line">        protobufTime = protobufTime - startTime;</div><div class="line"></div><div class="line">        String jsonStr = AddressBookJson.encodeTest(names);</div><div class="line">        ByteArrayInputStream jsonBais = <span class="keyword">new</span> ByteArrayInputStream(jsonStr.getBytes());</div><div class="line">        ByteArrayOutputStream jsonBaos = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            compress(jsonBais, jsonBaos);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        Log.i(TAG, String.format(<span class="string">"%-20s%-20s%-20s%-20s"</span>, <span class="string">"Json Length"</span>, String.valueOf(jsonStr.getBytes().length),</div><div class="line">                <span class="string">"Json(GZIP) Length"</span>, String.valueOf(jsonBaos.toByteArray().length)));</div><div class="line"></div><div class="line">        startTime = System.nanoTime();</div><div class="line">        AddressBookJson.decodeTest(jsonStr, <span class="keyword">times</span>);</div><div class="line">        <span class="keyword">long</span> jsonTime = System.nanoTime();</div><div class="line">        jsonTime = jsonTime - startTime;</div><div class="line"></div><div class="line">        Log.i(TAG, String.format(<span class="string">"%-20s%-20s%-20s%-20s"</span>, <span class="string">"ProtobufTime"</span>, String.valueOf(protobufTime),</div><div class="line">                <span class="string">"JsonTime"</span>, String.valueOf(jsonTime)));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doDecodeTest10(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doDecodeTest(TestUtils.sTestNames10, <span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doDecodeTest50(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doDecodeTest(TestUtils.sTestNames50, <span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doDecodeTest100(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doDecodeTest(TestUtils.sTestNames100, <span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doDecodeTest(<span class="keyword">int</span> <span class="keyword">times</span>) &#123;</div><div class="line">        doDecodeTest10(<span class="keyword">times</span>);</div><div class="line">        doDecodeTest50(<span class="keyword">times</span>);</div><div class="line">        doDecodeTest100(<span class="keyword">times</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">Void</span> doInBackground(<span class="keyword">Void</span>... params) &#123;</div><div class="line">        TestUtils.initTest();</div><div class="line">        doEncodeTest(<span class="number">5000</span>);</div><div class="line"></div><div class="line">        doDecodeTest(<span class="number">5000</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> onPostExecute(<span class="keyword">Void</span> aVoid) &#123;</div><div class="line">        <span class="keyword">super</span>.onPostExecute(aVoid);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我们执行3组编码测试及3组解码测试。对于编码测试，第一组的单个数据中包含10个Person，第二组的包含50个，第三组的包含100个，然后对每个数据分别执行5000次的编码操作。</p>
<p>对于解码测试，三组中单个数据同样包含10个Person、50个及100个，然后对每个数据分别执行5000次的解码码操作。</p>
<p>在Galaxy Nexus的Android 4.4.4 CM平台上执行上述测试，最终得到如下结果：</p>
<h4 id="编码后数据长度对比-Bytes"><a href="#编码后数据长度对比-Bytes" class="headerlink" title="编码后数据长度对比 (Bytes)"></a>编码后数据长度对比 (Bytes)</h4><table>
<thead>
<tr>
<th>Person个数</th>
<th style="text-align:center">Protobuf</th>
<th style="text-align:right">Protobuf（GZIP）</th>
<th style="text-align:right">JSON</th>
<th style="text-align:right">JSON（GZIP）</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td style="text-align:center">860</td>
<td style="text-align:right">291</td>
<td style="text-align:right">1703</td>
<td style="text-align:right">344</td>
</tr>
<tr>
<td>50</td>
<td style="text-align:center">4300</td>
<td style="text-align:right">984</td>
<td style="text-align:right">8463</td>
<td style="text-align:right">1047</td>
</tr>
<tr>
<td>100</td>
<td style="text-align:center">8600</td>
<td style="text-align:right">1840</td>
<td style="text-align:right">16913</td>
<td style="text-align:right">1913</td>
</tr>
</tbody>
</table>
<p>相同的数据，经过Protobuf编码的数据长度，大概只有JSON编码的数据长度的一半。但对编码后的数据再进行压缩，两者则差别比较小。</p>
<h4 id="编码性能对比-S"><a href="#编码性能对比-S" class="headerlink" title="编码性能对比 (S)"></a>编码性能对比 (S)</h4><table>
<thead>
<tr>
<th>Person个数</th>
<th>Protobuf</th>
<th>JSON</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>4.687</td>
<td>6.558</td>
</tr>
<tr>
<td>50</td>
<td>23.728</td>
<td>41.315</td>
</tr>
<tr>
<td>100</td>
<td>45.604</td>
<td>81.667</td>
</tr>
</tbody>
</table>
<p>编码性能最少提高了 28.5%，最多则提高了44.2%。Protobuf在编码性能上，相对于JSON还是有较大幅度的提升的。</p>
<h4 id="解码性能对比-S"><a href="#解码性能对比-S" class="headerlink" title="解码性能对比 (S)"></a>解码性能对比 (S)</h4><table>
<thead>
<tr>
<th>Person个数</th>
<th>Protobuf</th>
<th>JSON</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>0.226</td>
<td>8.839</td>
</tr>
<tr>
<td>50</td>
<td>0.291</td>
<td>43.869</td>
</tr>
<tr>
<td>100</td>
<td>0.220</td>
<td>85.444</td>
</tr>
</tbody>
</table>
<p>解码性能方面，Protobuf相对于JSON，则更是有惊人的提升。Protobuf的解码时间几乎不随着数据长度的增长而有太大的增长，而JSON则随着数据长度的增加，解码所需要的时间也越来越长。</p>
<p>Done。</p>
</div><div class="tags"><a href="/tags/Android开发/">Android开发</a></div><div class="post-nav"><a href="/2016/12/08/在Android中使用FlatBuffers/" class="pre">在Android中使用FlatBuffers</a><a href="/2016/12/02/在Java中使用ProtocolBuffers/" class="next">在Java中使用Protocol Buffers</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android-图形系统/">Android 图形系统</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">31</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/01/anbox_container_manager_service/">Anbox 容器管理服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/28/run_anbox/">运行 Anbox</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/28/Anbox/">Anbox</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/24/gerrit_codereview/">Gerrit代码审核服务器搭建全过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/20/adb_overview/">关于 ADB 实现的说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/adb-standalone/">adb standalone</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/31/qcow2_on_linux/">在 Linux 上如何挂载 qcow2 磁盘镜像</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/21/android_graphics_gralloc/">Android 图形系统之gralloc</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/20/android_graphics_bufferalloc/">Android 图形系统之图形缓冲区分配</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/16/opengles_android_emulation/">Android 硬件 OpenGL ES 模拟设计概述</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2016/12/02/在Android中使用ProtocolBuffers/';
var disqus_title = '在Android中使用Protocol Buffers';
var disqus_url = 'https://www.wolfcstech.com/2016/12/02/在Android中使用ProtocolBuffers/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-109419024-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>