<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="mask-icon" href="/images/freesoft.jpg?v=6.0.3" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Android开发,安全,HTTPS," />


<meta name="description" content="PKI 体系依赖证书执行极为关键的身份验证，以此确认服务端的可信任性。证书验证在 SSL/TLS 握手过程中完成，验证过程通常包含三个步骤：

验证证书的合法性：这一步主要是验证证书是由合法有效的 CA 签发的。在客户端预先保存一个可靠的 CA 的根证书库，比如 FiexFox、Chrome、Android、Microsoft 等都有维护自己的根证书库，并据此验证服务端证书链的合法性。PKI 体系">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 根证书管理与证书验证">
<meta property="og:url" content="https://www.wolfcstech.com/2018/03/20/android_cert_mgr_and_verify/index.html">
<meta property="og:site_name" content="WolfcsTech">
<meta property="og:description" content="PKI 体系依赖证书执行极为关键的身份验证，以此确认服务端的可信任性。证书验证在 SSL/TLS 握手过程中完成，验证过程通常包含三个步骤：

验证证书的合法性：这一步主要是验证证书是由合法有效的 CA 签发的。在客户端预先保存一个可靠的 CA 的根证书库，比如 FiexFox、Chrome、Android、Microsoft 等都有维护自己的根证书库，并据此验证服务端证书链的合法性。PKI 体系">
<meta property="og:image" content="https://www.wolfcstech.com/images/1315506-03eeb26ab6b4fa1d.png">
<meta property="og:image" content="https://www.wolfcstech.com/images/1315506-6eb297cdb8af12d2.jpg">
<meta property="og:image" content="https://www.wolfcstech.com/images/1315506-32a5c3c78d634e3a.jpg">
<meta property="og:updated_time" content="2018-03-22T08:33:48.941Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 根证书管理与证书验证">
<meta name="twitter:description" content="PKI 体系依赖证书执行极为关键的身份验证，以此确认服务端的可信任性。证书验证在 SSL/TLS 握手过程中完成，验证过程通常包含三个步骤：

验证证书的合法性：这一步主要是验证证书是由合法有效的 CA 签发的。在客户端预先保存一个可靠的 CA 的根证书库，比如 FiexFox、Chrome、Android、Microsoft 等都有维护自己的根证书库，并据此验证服务端证书链的合法性。PKI 体系">
<meta name="twitter:image" content="https://www.wolfcstech.com/images/1315506-03eeb26ab6b4fa1d.png">






  <link rel="canonical" href="https://www.wolfcstech.com/2018/03/20/android_cert_mgr_and_verify/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>Android 根证书管理与证书验证 | WolfcsTech</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-109419024-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-109419024-1');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WolfcsTech</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="http://www.ixirong.com/404.html" rel="section">
            <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />公益 404</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.wolfcstech.com/2018/03/20/android_cert_mgr_and_verify/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Han Pengfei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/freesoft.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WolfcsTech">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android 根证书管理与证书验证</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-20T21:17:49+08:00">2018-03-20</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/安全/" itemprop="url" rel="index"><span itemprop="name">安全</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/20/android_cert_mgr_and_verify/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/03/20/android_cert_mgr_and_verify/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/03/20/android_cert_mgr_and_verify/" class="leancloud_visitors" data-flag-title="Android 根证书管理与证书验证">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>PKI 体系依赖证书执行极为关键的身份验证，以此确认服务端的可信任性。证书验证在 SSL/TLS 握手过程中完成，验证过程通常包含三个步骤：</p>
<ol>
<li><p>验证证书的合法性：这一步主要是验证证书是由合法有效的 CA 签发的。在客户端预先保存一个可靠的 CA 的根证书库，比如 FiexFox、Chrome、Android、Microsoft 等都有维护自己的根证书库，并据此验证服务端证书链的合法性。PKI 体系借助于可靠的中心化身份验证系统，即 CA，为服务端的身份合法性背书。根证书库的安全是 PKI 系统正常工作非常关键的部分。</p>
</li>
<li><p>验证证书域名的匹配性：服务端的证书都是为特定域名签发的，证书就像是网站的身份证一样。通过验证域名匹配性，可以有效的防止身份的仿冒，比如经营着 A 网站的经营者，拦截用户请求，并冒充 B 网站的身份，盗取信息。如果客户端不对域名的匹配性做检查，则将造成极大的攻击面，拿到任何一个域名的合法证书的人都将可以仿冒目标服务器。</p>
</li>
<li><p>证书钉扎验证：这是 PKI 体系中比较新的一种增强安全性的机制。目前的证书签发机构 CA 非常多，总数大概有几百个上千个，每个 CA 都可以为任何域名签发合法有效的证书，因而众多的 CA 就造成了非常大的攻击面。比如某个 CA 被攻破，或者犯了其它什么错误，为攻击者签发了 www.google.com 等域名的证书，则攻击者将可以仿冒这些网站。证书钉扎机制正是为了解决这一问题而产生——证书钉扎机制中，在客户端将特定域名的证书与特定的签发者绑定，即客户端只承认特定签发者签发的某个域名的证书，而不承认其它 CA 为该域名签发的证书。通过这种方式，来解除大量 CA 这个攻击面的威胁。</p>
<a id="more"></a>
</li>
</ol>
<p>在 Android 系统的 Java 应用程序中，证书验证通常由不同层面的多个组件完成。第一步的证书合法性验证，主要由 Java 标准库的 <code>javax.net.ssl.SSLSocket</code> 在 <code>startHandshake()</code> 方法中完成，后面两个步骤由更上层的组件完成，比如 HTTPS 库 OkHttp 等。</p>
<p>本文主要讨论 Android 中根证书库的管理和证书的合法性验证。（本文分析说明主要依据 android-7.1.1/android-7.1.2 系统的行为，可以通过 Google 的 <a href="http://androidxref.com/7.1.2_r36/" target="_blank" rel="external">OpenGrok 服务器</a> 阅读 Android 系统的源码。）</p>
<h1 id="Android-的根证书管理"><a href="#Android-的根证书管理" class="headerlink" title="Android 的根证书管理"></a>Android 的根证书管理</h1><p>在 AOSP 源码库中，CA 根证书主要存放在 <code>system/ca-certificates</code> 目录下，而在 Android 系统中，则存放在 <code>/system/etc/security/</code> 目录下，以 Android 7.1.1 系统的 Pixel 设备为例：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sailfish:/ <span class="comment"># ls -l  /system/etc/security/</span></div><div class="line">total 40</div><div class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>2017-07-18 16:37 cacerts</div><div class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>2017-07-18 16:36 cacerts_google</div><div class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 4995 </span>2017-07-18 16:03 mac_permissions.xml</div><div class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 1073 </span>2017-07-18 16:59 otacerts.zip</div></pre></td></tr></table></figure></p>
<p>其中 <code>cacerts_google</code> 目录下的根证书，主要用于 <code>system/update_engine</code>、<code>external/libbrillo</code> 和 <code>system/core/crash_reporter</code> 等模块，<code>cacerts</code> 目录下的根证书则用于所有的应用。<code>cacerts</code> 目录下的根证书，即 Android 系统的根证书库，像下面这样：<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">sailfish:/ # ls -l /system/etc/security/cacerts</div><div class="line">total <span class="number">2408</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4767 2017</span>-<span class="number">07-18 16:37</span> <span class="number">00673</span>b5b.<span class="number">0</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">7195 2017</span>-<span class="number">07-18 16:37</span> <span class="number">02756</span>ea4.<span class="number">0</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4919 2017</span>-<span class="number">07-18 16:37</span> <span class="number">02b73561.0</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">7142 2017</span>-<span class="number">07-18 16:37</span> <span class="number">03</span>f2b8cf.<span class="number">0</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">2877 2017</span>-<span class="number">07-18 16:37</span> <span class="number">04f60c28.0</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4836 2017</span>-<span class="number">07-18 16:37</span> <span class="number">052</span>e396b.<span class="number">0</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">5322 2017</span>-<span class="number">07-18 16:37</span> <span class="number">08</span>aef7bb.<span class="number">0</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4922 2017</span>-<span class="number">07-18 16:37</span> <span class="number">0d</span>5a4e1c.<span class="number">0</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">2308 2017</span>-<span class="number">07-18 16:37</span> <span class="number">0d69c7e1</span>.<span class="number">0</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4614 2017</span>-<span class="number">07-18 16:37</span> <span class="number">10531352.0</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4716 2017</span>-<span class="number">07-18 16:37</span> <span class="number">111e6273.0</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">5375 2017</span>-<span class="number">07-18 16:37</span> <span class="number">119</span>afc2e.<span class="number">0</span></div><div class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4927 2017</span>-<span class="number">07-18 16:37</span> <span class="number">124</span>bbd54.<span class="number">0</span></div><div class="line">. . . . . .</div></pre></td></tr></table></figure></p>
<p>它们都是 PEM 格式的 X.509 证书。Android 系统通过 <code>SystemCertificateSource</code>、<code>DirectoryCertificateSource</code> 和 <code>CertificateSource</code> 等类管理系统根证书库。<code>CertificateSource</code>定义（位于<code>frameworks/base/core/java/android/security/net/config/CertificateSource.java</code>）了可以对根证书库执行的操作，主要是对根证书的获取和查找：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> android.security.net.config;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"></div><div class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CertificateSource</span> </span>&#123;</div><div class="line">    <span class="function">Set&lt;X509Certificate&gt; <span class="title">getCertificates</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">X509Certificate <span class="title">findBySubjectAndPublicKey</span><span class="params">(X509Certificate cert)</span></span>;</div><div class="line">    <span class="function">X509Certificate <span class="title">findByIssuerAndSignature</span><span class="params">(X509Certificate cert)</span></span>;</div><div class="line">    <span class="function">Set&lt;X509Certificate&gt; <span class="title">findAllByIssuerAndSignature</span><span class="params">(X509Certificate cert)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleTrustStorageUpdate</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>DirectoryCertificateSource</code> 类则基于文件系统上分开存放的根证书文件的形式保存的根证书库，提供证书的创建、获取和查找操作，这个类的定义（位于<code>frameworks/base/core/java/android/security/net/config/DirectoryCertificateSource.java</code>）如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> android.security.net.config;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.os.Environment;</div><div class="line"><span class="keyword">import</span> android.os.UserHandle;</div><div class="line"><span class="keyword">import</span> android.util.ArraySet;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.util.Pair;</div><div class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.io.FileInputStream;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.security.cert.Certificate;</div><div class="line"><span class="keyword">import</span> java.security.cert.CertificateException;</div><div class="line"><span class="keyword">import</span> java.security.cert.CertificateFactory;</div><div class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</div><div class="line"><span class="keyword">import</span> java.util.Collections;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"><span class="keyword">import</span> libcore.io.IoUtils;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.android.org.conscrypt.Hex;</div><div class="line"><span class="keyword">import</span> com.android.org.conscrypt.NativeCrypto;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.security.auth.x500.X500Principal;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@link</span> CertificateSource&#125; based on a directory where certificates are stored as individual files</div><div class="line"> * named after a hash of their SubjectName for more efficient lookups.</div><div class="line"> * <span class="doctag">@hide</span></div><div class="line"> */</div><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectoryCertificateSource</span> <span class="keyword">implements</span> <span class="title">CertificateSource</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_TAG = <span class="string">"DirectoryCertificateSrc"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> File mDir;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object mLock = <span class="keyword">new</span> Object();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CertificateFactory mCertFactory;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Set&lt;X509Certificate&gt; mCertificates;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">DirectoryCertificateSource</span><span class="params">(File caDir)</span> </span>&#123;</div><div class="line">        mDir = caDir;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mCertFactory = CertificateFactory.getInstance(<span class="string">"X.509"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (CertificateException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to obtain X.509 CertificateFactory"</span>, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isCertMarkedAsRemoved</span><span class="params">(String caFile)</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;X509Certificate&gt; <span class="title">getCertificates</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> loading all of these is wasteful, we should instead use a keystore style API.</span></div><div class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">            <span class="keyword">if</span> (mCertificates != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> mCertificates;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Set&lt;X509Certificate&gt; certs = <span class="keyword">new</span> ArraySet&lt;X509Certificate&gt;();</div><div class="line">            <span class="keyword">if</span> (mDir.isDirectory()) &#123;</div><div class="line">                <span class="keyword">for</span> (String caFile : mDir.list()) &#123;</div><div class="line">                    <span class="keyword">if</span> (isCertMarkedAsRemoved(caFile)) &#123;</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    &#125;</div><div class="line">                    X509Certificate cert = readCertificate(caFile);</div><div class="line">                    <span class="keyword">if</span> (cert != <span class="keyword">null</span>) &#123;</div><div class="line">                        certs.add(cert);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            mCertificates = certs;</div><div class="line">            <span class="keyword">return</span> mCertificates;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> X509Certificate <span class="title">findBySubjectAndPublicKey</span><span class="params">(<span class="keyword">final</span> X509Certificate cert)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> findCert(cert.getSubjectX500Principal(), <span class="keyword">new</span> CertSelector() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(X509Certificate ca)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> ca.getPublicKey().equals(cert.getPublicKey());</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> X509Certificate <span class="title">findByIssuerAndSignature</span><span class="params">(<span class="keyword">final</span> X509Certificate cert)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> findCert(cert.getIssuerX500Principal(), <span class="keyword">new</span> CertSelector() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(X509Certificate ca)</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    cert.verify(ca.getPublicKey());</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;X509Certificate&gt; <span class="title">findAllByIssuerAndSignature</span><span class="params">(<span class="keyword">final</span> X509Certificate cert)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> findCerts(cert.getIssuerX500Principal(), <span class="keyword">new</span> CertSelector() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(X509Certificate ca)</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    cert.verify(ca.getPublicKey());</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleTrustStorageUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">            mCertificates = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">CertSelector</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">match</span><span class="params">(X509Certificate cert)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Set&lt;X509Certificate&gt; <span class="title">findCerts</span><span class="params">(X500Principal subj, CertSelector selector)</span> </span>&#123;</div><div class="line">        String hash = getHash(subj);</div><div class="line">        Set&lt;X509Certificate&gt; certs = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &gt;= <span class="number">0</span>; index++) &#123;</div><div class="line">            String fileName = hash + <span class="string">"."</span> + index;</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">new</span> File(mDir, fileName).exists()) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (isCertMarkedAsRemoved(fileName)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            X509Certificate cert = readCertificate(fileName);</div><div class="line">            <span class="keyword">if</span> (cert == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!subj.equals(cert.getSubjectX500Principal())) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (selector.match(cert)) &#123;</div><div class="line">                <span class="keyword">if</span> (certs == <span class="keyword">null</span>) &#123;</div><div class="line">                    certs = <span class="keyword">new</span> ArraySet&lt;X509Certificate&gt;();</div><div class="line">                &#125;</div><div class="line">                certs.add(cert);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> certs != <span class="keyword">null</span> ? certs : Collections.&lt;X509Certificate&gt;emptySet();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> X509Certificate <span class="title">findCert</span><span class="params">(X500Principal subj, CertSelector selector)</span> </span>&#123;</div><div class="line">        String hash = getHash(subj);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &gt;= <span class="number">0</span>; index++) &#123;</div><div class="line">            String fileName = hash + <span class="string">"."</span> + index;</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">new</span> File(mDir, fileName).exists()) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (isCertMarkedAsRemoved(fileName)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            X509Certificate cert = readCertificate(fileName);</div><div class="line">            <span class="keyword">if</span> (cert == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!subj.equals(cert.getSubjectX500Principal())) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (selector.match(cert)) &#123;</div><div class="line">                <span class="keyword">return</span> cert;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getHash</span><span class="params">(X500Principal name)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> hash = NativeCrypto.X509_NAME_hash_old(name);</div><div class="line">        <span class="keyword">return</span> Hex.intToHexString(hash, <span class="number">8</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> X509Certificate <span class="title">readCertificate</span><span class="params">(String file)</span> </span>&#123;</div><div class="line">        InputStream is = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            is = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(mDir, file)));</div><div class="line">            <span class="keyword">return</span> (X509Certificate) mCertFactory.generateCertificate(is);</div><div class="line">        &#125; <span class="keyword">catch</span> (CertificateException | IOException e) &#123;</div><div class="line">            Log.e(LOG_TAG, <span class="string">"Failed to read certificate from "</span> + file, e);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            IoUtils.closeQuietly(is);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>获取根证书库的 <code>getCertificates()</code> 操作在第一次被调用时，遍历文件系统，并加载系统所有的根证书文件，并缓存起来，以备后面访问。根证书的查找操作，主要依据证书文件的文件名进行，证书文件被要求以 <code>[SubjectName 的哈希值].[Index]</code> 的形式命名。</p>
<p><code>SystemCertificateSource</code> 类主要定义（位于<code>frameworks/base/core/java/android/security/net/config/SystemCertificateSource.java</code>）了系统根证书库的路径，以及无效一个根证书的机制：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> android.security.net.config;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.os.Environment;</div><div class="line"><span class="keyword">import</span> android.os.UserHandle;</div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@link</span> CertificateSource&#125; based on the system trusted CA store.</div><div class="line"> * <span class="doctag">@hide</span></div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemCertificateSource</span> <span class="keyword">extends</span> <span class="title">DirectoryCertificateSource</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NoPreloadHolder</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SystemCertificateSource INSTANCE = <span class="keyword">new</span> SystemCertificateSource();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> File mUserRemovedCaDir;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SystemCertificateSource</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> File(System.getenv(<span class="string">"ANDROID_ROOT"</span>) + <span class="string">"/etc/security/cacerts"</span>));</div><div class="line">        File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</div><div class="line">        mUserRemovedCaDir = <span class="keyword">new</span> File(configDir, <span class="string">"cacerts-removed"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SystemCertificateSource <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> NoPreloadHolder.INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isCertMarkedAsRemoved</span><span class="params">(String caFile)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> File(mUserRemovedCaDir, caFile).exists();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Android 系统的根证书位于 <code>/system/etc/security/cacerts/</code> 目录下。用户可以通过将特定根证书复制到用户配置目录的 <code>cacerts-removed</code> 目录下来无效一个根证书。</p>
<p>Android framework 还提供了另外一个用于加载并访问用户根证书库的组件 <code>UserCertificateSource</code>，这个类的定义（位于 <code>frameworks/base/core/java/android/security/net/config/UserCertificateSource.java</code>）如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> android.security.net.config;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.os.Environment;</div><div class="line"><span class="keyword">import</span> android.os.UserHandle;</div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@link</span> CertificateSource&#125; based on the user-installed trusted CA store.</div><div class="line"> * <span class="doctag">@hide</span></div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UserCertificateSource</span> <span class="keyword">extends</span> <span class="title">DirectoryCertificateSource</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NoPreloadHolder</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> UserCertificateSource INSTANCE = <span class="keyword">new</span> UserCertificateSource();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">UserCertificateSource</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> File(</div><div class="line">                Environment.getUserConfigDirectory(UserHandle.myUserId()), <span class="string">"cacerts-added"</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> UserCertificateSource <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> NoPreloadHolder.INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isCertMarkedAsRemoved</span><span class="params">(String caFile)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个组件与 <code>SystemCertificateSource</code> 类似，只是它定义了用户根证书库的路径。</p>
<p>相关的几个组件结构如下图：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-03eeb26ab6b4fa1d.png" alt="CertificateSource"></p>
<h1 id="证书链合法性验证"><a href="#证书链合法性验证" class="headerlink" title="证书链合法性验证"></a>证书链合法性验证</h1><p>有了根证书库之后，根证书库又是如何被用于 SSL/TLS 握手的证书验证过程的呢？</p>
<p>证书的合法性由 Java 标准库的 <code>javax.net.ssl.SSLSocket</code> 在 <code>startHandshake()</code> 方法中完成。对于 Android 系统而言，<code>SSLSocket</code> 基于 OpenSSL 库实现，这一实现由 <code>external/conscrypt</code> 模块提供，<code>SSLSocket</code> 的实现为 <code>OpenSSLSocketImpl</code> 类（位于<code>external/conscrypt/src/main/java/org/conscrypt/OpenSSLSocketImpl.java</code>）。</p>
<p><code>OpenSSLSocketImpl.startHandshake()</code> 中的 SSL/TLS 握手是一个极为精巧的过程，我们略过详细的握手过程，主要关注证书验证的部分。</p>
<p><code>OpenSSLSocketImpl.startHandshake()</code> 通过 <code>NativeCrypto</code> 类（位于<code>external/conscrypt/src/main/java/org/conscrypt/NativeCrypto.java</code>）中的静态本地层方法 <code>SSL_do_handshake()</code> 方法执行握手操作：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns the sslSessionNativePointer of the negotiated session. If this is</div><div class="line"> * a server negotiation, supplying the &#123;<span class="doctag">@code</span> alpnProtocols&#125; will enable</div><div class="line"> * ALPN negotiation.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="function"><span class="keyword">long</span> <span class="title">SSL_do_handshake</span><span class="params">(<span class="keyword">long</span> sslNativePointer,</span></span></div><div class="line">                                           FileDescriptor fd,</div><div class="line">                                           SSLHandshakeCallbacks shc,</div><div class="line">                                           <span class="keyword">int</span> timeoutMillis,</div><div class="line">                                           <span class="keyword">boolean</span> client_mode,</div><div class="line">                                           <span class="keyword">byte</span>[] npnProtocols,</div><div class="line">                                           <span class="keyword">byte</span>[] alpnProtocols)</div><div class="line">    <span class="keyword">throws</span> SSLException, SocketTimeoutException, CertificateException;</div></pre></td></tr></table></figure></p>
<p><code>NativeCrypto</code> 类内部定义了一组将会在本地层由与 SSL 握手相关的 OpenSSL C/C++ 代码调用的回调 <code>SSLHandshakeCallbacks</code>，在上面的 <code>SSL_do_handshake()</code> 方法中，这组回调作为参数传入本地层。</p>
<p><code>SSLHandshakeCallbacks</code> 定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A collection of callbacks from the native OpenSSL code that are</div><div class="line"> * related to the SSL handshake initiated by SSL_do_handshake.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SSLHandshakeCallbacks</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Verify that we trust the certificate chain is trusted.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> sslSessionNativePtr pointer to a reference of the SSL_SESSION</div><div class="line">     * <span class="doctag">@param</span> certificateChainRefs chain of X.509 certificate references</div><div class="line">     * <span class="doctag">@param</span> authMethod auth algorithm name</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span> CertificateException if the certificate is untrusted</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verifyCertificateChain</span><span class="params">(<span class="keyword">long</span> sslSessionNativePtr, <span class="keyword">long</span>[] certificateChainRefs,</span></span></div><div class="line">            String authMethod) <span class="keyword">throws</span> CertificateException;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Called on an SSL client when the server requests (or</div><div class="line">     * requires a certificate). The client can respond by using</div><div class="line">     * SSL_use_certificate and SSL_use_PrivateKey to set a</div><div class="line">     * certificate if has an appropriate one available, similar to</div><div class="line">     * how the server provides its certificate.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> keyTypes key types supported by the server,</div><div class="line">     * convertible to strings with #keyType</div><div class="line">     * <span class="doctag">@param</span> asn1DerEncodedX500Principals CAs known to the server</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clientCertificateRequested</span><span class="params">(<span class="keyword">byte</span>[] keyTypes,</span></span></div><div class="line">                                           <span class="keyword">byte</span>[][] asn1DerEncodedX500Principals)</div><div class="line">        <span class="keyword">throws</span> CertificateEncodingException, SSLException;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Gets the key to be used in client mode for this connection in Pre-Shared Key (PSK) key</div><div class="line">     * exchange.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> identityHint PSK identity hint provided by the server or &#123;<span class="doctag">@code</span> null&#125; if no hint</div><div class="line">     *        provided.</div><div class="line">     * <span class="doctag">@param</span> identity buffer to be populated with PSK identity (NULL-terminated modified UTF-8)</div><div class="line">     *        by this method. This identity will be provided to the server.</div><div class="line">     * <span class="doctag">@param</span> key buffer to be populated with key material by this method.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> number of bytes this method stored in the &#123;<span class="doctag">@code</span> key&#125; buffer or &#123;<span class="doctag">@code</span> 0&#125; if an</div><div class="line">     *         error occurred in which case the handshake will be aborted.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clientPSKKeyRequested</span><span class="params">(String identityHint, <span class="keyword">byte</span>[] identity, <span class="keyword">byte</span>[] key)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Gets the key to be used in server mode for this connection in Pre-Shared Key (PSK) key</div><div class="line">     * exchange.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> identityHint PSK identity hint provided by this server to the client or</div><div class="line">     *        &#123;<span class="doctag">@code</span> null&#125; if no hint was provided.</div><div class="line">     * <span class="doctag">@param</span> identity PSK identity provided by the client.</div><div class="line">     * <span class="doctag">@param</span> key buffer to be populated with key material by this method.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> number of bytes this method stored in the &#123;<span class="doctag">@code</span> key&#125; buffer or &#123;<span class="doctag">@code</span> 0&#125; if an</div><div class="line">     *         error occurred in which case the handshake will be aborted.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">serverPSKKeyRequested</span><span class="params">(String identityHint, String identity, <span class="keyword">byte</span>[] key)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Called when SSL state changes. This could be handshake completion.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSSLStateChange</span><span class="params">(<span class="keyword">long</span> sslSessionNativePtr, <span class="keyword">int</span> type, <span class="keyword">int</span> val)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中 <code>verifyCertificateChain()</code> 回调用于服务端证书的验证。Android 系统通过这一回调，将根证书库的管理模块和底层 OpenSSL 的 SSL/TLS 握手及身份验证连接起来。</p>
<p><code>SSLHandshakeCallbacks</code> 回调由 <code>OpenSSLSocketImpl</code> 实现，<code>verifyCertificateChain()</code> 的实现如下：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>) <span class="comment">// used by NativeCrypto.SSLHandshakeCallbacks</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">verifyCertificateChain</span><span class="params">(<span class="keyword">long</span> sslSessionNativePtr, <span class="keyword">long</span>[] certRefs, String authMethod)</span></span></div><div class="line">        <span class="keyword">throws</span> CertificateException &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        X509TrustManager x509tm = sslParameters.getX509TrustManager();</div><div class="line">        <span class="keyword">if</span> (x509tm == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CertificateException(<span class="string">"No X.509 TrustManager"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (certRefs == <span class="keyword">null</span> || certRefs.length == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SSLException(<span class="string">"Peer sent no certificate"</span>);</div><div class="line">        &#125;</div><div class="line">        OpenSSLX509Certificate[] peerCertChain = <span class="keyword">new</span> OpenSSLX509Certificate[certRefs.length];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; certRefs.length; i++) &#123;</div><div class="line">            peerCertChain[i] = <span class="keyword">new</span> OpenSSLX509Certificate(certRefs[i]);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Used for verifyCertificateChain callback</span></div><div class="line">        handshakeSession = <span class="keyword">new</span> OpenSSLSessionImpl(sslSessionNativePtr, <span class="keyword">null</span>, peerCertChain,</div><div class="line">                getHostnameOrIP(), getPort(), <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> client = sslParameters.getUseClientMode();</div><div class="line">        <span class="keyword">if</span> (client) &#123;</div><div class="line">            Platform.checkServerTrusted(x509tm, peerCertChain, authMethod, <span class="keyword">this</span>);</div><div class="line">            <span class="keyword">if</span> (sslParameters.isCTVerificationEnabled(getHostname())) &#123;</div><div class="line">                <span class="keyword">byte</span>[] tlsData = NativeCrypto.SSL_get_signed_cert_timestamp_list(</div><div class="line">                                    sslNativePointer);</div><div class="line">                <span class="keyword">byte</span>[] ocspData = NativeCrypto.SSL_get_ocsp_response(sslNativePointer);</div><div class="line"></div><div class="line">                CTVerifier ctVerifier = sslParameters.getCTVerifier();</div><div class="line">                CTVerificationResult result =</div><div class="line">                    ctVerifier.verifySignedCertificateTimestamps(peerCertChain, tlsData, ocspData);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (result.getValidSCTs().size() == <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> CertificateException(<span class="string">"No valid SCT found"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            String authType = peerCertChain[<span class="number">0</span>].getPublicKey().getAlgorithm();</div><div class="line">            Platform.checkClientTrusted(x509tm, peerCertChain, authType, <span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (CertificateException e) &#123;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CertificateException(e);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="comment">// Clear this before notifying handshake completed listeners</span></div><div class="line">        handshakeSession = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>OpenSSLSocketImpl</code> 的 <code>verifyCertificateChain()</code> 从 <code>sslParameters</code> 获得 <code>X509TrustManager</code>，然后在 <code>Platform.checkServerTrusted()</code> （<code>com.android.org.conscrypt.Platform</code>，位于 <code>external/conscrypt/src/compat/java/org/conscrypt/Platform.java</code>）中执行服务端证书合法有效性的检查：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> checkServerTrusted(X509TrustManager tm, X509Certificate[] chain,</div><div class="line">        <span class="keyword">String</span> authType, OpenSSLSocketImpl socket) throws CertificateException &#123;</div><div class="line">    <span class="built_in">if</span> (!checkTrusted(<span class="string">"checkServerTrusted"</span>, tm, chain, authType, Socket.<span class="keyword">class</span>, socket)</div><div class="line">            &amp;&amp; !checkTrusted(<span class="string">"checkServerTrusted"</span>, tm, chain, authType, <span class="keyword">String</span>.<span class="keyword">class</span>,</div><div class="line">                             socket.getHandshakeSession().getPeerHost())) &#123;</div><div class="line">        tm.checkServerTrusted(chain, authType);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>Platform.checkServerTrusted()</code> 通过执行 <code>X509TrustManager</code> 的 <code>checkServerTrusted()</code> 方法执行证书有合法性检查。</p>
<p><code>X509TrustManager</code> 来自于 <code>OpenSSLSocketImpl</code> 的 <code>sslParameters</code>，那 <code>sslParameters</code> 又来自于哪里呢？<code>OpenSSLSocketImpl</code> 的 <code>sslParameters</code> 由对象的创建者传入：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenSSLSocketImpl</span></span></div><div class="line">        extends javax.net.ssl.SSLSocket</div><div class="line">        implements NativeCrypto.SSLHandshakeCallbacks, SSLParametersImpl.AliasChooser,</div><div class="line">        SSLParametersImpl.PSKCallbacks &#123;</div><div class="line">. . . . . .</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SSLParametersImpl sslParameters;</div><div class="line">. . . . . .</div><div class="line">    <span class="keyword">protected</span> OpenSSLSocketImpl(SSLParametersImpl sslParameters) throws IOException &#123;</div><div class="line">        <span class="keyword">this</span>.socket = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">this</span>.peerHostname = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">this</span>.peerPort = <span class="number">-1</span>;</div><div class="line">        <span class="keyword">this</span>.autoClose = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">this</span>.sslParameters = sslParameters;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> OpenSSLSocketImpl(String hostname, int port, SSLParametersImpl sslParameters)</div><div class="line">            throws IOException &#123;</div><div class="line">        <span class="keyword">super</span>(hostname, port);</div><div class="line">        <span class="keyword">this</span>.socket = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">this</span>.peerHostname = hostname;</div><div class="line">        <span class="keyword">this</span>.peerPort = port;</div><div class="line">        <span class="keyword">this</span>.autoClose = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">this</span>.sslParameters = sslParameters;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> OpenSSLSocketImpl(InetAddress address, int port, SSLParametersImpl sslParameters)</div><div class="line">            throws IOException &#123;</div><div class="line">        <span class="keyword">super</span>(address, port);</div><div class="line">        <span class="keyword">this</span>.socket = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">this</span>.peerHostname = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">this</span>.peerPort = <span class="number">-1</span>;</div><div class="line">        <span class="keyword">this</span>.autoClose = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">this</span>.sslParameters = sslParameters;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">protected</span> OpenSSLSocketImpl(String hostname, int port,</div><div class="line">                                InetAddress clientAddress, int clientPort,</div><div class="line">                                SSLParametersImpl sslParameters) throws IOException &#123;</div><div class="line">        <span class="keyword">super</span>(hostname, port, clientAddress, clientPort);</div><div class="line">        <span class="keyword">this</span>.socket = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">this</span>.peerHostname = hostname;</div><div class="line">        <span class="keyword">this</span>.peerPort = port;</div><div class="line">        <span class="keyword">this</span>.autoClose = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">this</span>.sslParameters = sslParameters;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> OpenSSLSocketImpl(InetAddress address, int port,</div><div class="line">                                InetAddress clientAddress, int clientPort,</div><div class="line">                                SSLParametersImpl sslParameters) throws IOException &#123;</div><div class="line">        <span class="keyword">super</span>(address, port, clientAddress, clientPort);</div><div class="line">        <span class="keyword">this</span>.socket = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">this</span>.peerHostname = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">this</span>.peerPort = <span class="number">-1</span>;</div><div class="line">        <span class="keyword">this</span>.autoClose = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">this</span>.sslParameters = sslParameters;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Create an SSL socket that wraps another socket. Invoked by</div><div class="line">     * OpenSSLSocketImplWrapper constructor.</div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> OpenSSLSocketImpl(Socket socket, String hostname, int port,</div><div class="line">            boolean autoClose, SSLParametersImpl sslParameters) throws IOException &#123;</div><div class="line">        <span class="keyword">this</span>.socket = socket;</div><div class="line">        <span class="keyword">this</span>.peerHostname = hostname;</div><div class="line">        <span class="keyword">this</span>.peerPort = port;</div><div class="line">        <span class="keyword">this</span>.autoClose = autoClose;</div><div class="line">        <span class="keyword">this</span>.sslParameters = sslParameters;</div><div class="line"></div><div class="line">        <span class="comment">// this.timeout is not set intentionally.</span></div><div class="line">        <span class="comment">// OpenSSLSocketImplWrapper.getSoTimeout will delegate timeout</span></div><div class="line">        <span class="comment">// to wrapped socket</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>也就是说，<code>OpenSSLSocketImpl</code> 的 <code>sslParameters</code> 来自于 <code>javax.net.ssl.SSLSocketFactory</code>，即 <code>OpenSSLSocketFactoryImpl</code>。<code>OpenSSLSocketFactoryImpl</code> 定义（位于 <code>external/conscrypt/src/main/java/org/conscrypt/OpenSSLSocketFactoryImpl.java</code>）如下：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.conscrypt;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.net.InetAddress;</div><div class="line"><span class="keyword">import</span> java.net.Socket;</div><div class="line"><span class="keyword">import</span> java.net.UnknownHostException;</div><div class="line"><span class="keyword">import</span> java.security.KeyManagementException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenSSLSocketFactoryImpl</span> <span class="keyword">extends</span> <span class="title">javax</span>.<span class="title">net</span>.<span class="title">ssl</span>.<span class="title">SSLSocketFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SSLParametersImpl sslParameters;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IOException instantiationException;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OpenSSLSocketFactoryImpl</span><span class="params">()</span> </span>&#123;</div><div class="line">        SSLParametersImpl sslParametersLocal = <span class="keyword">null</span>;</div><div class="line">        IOException instantiationExceptionLocal = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            sslParametersLocal = SSLParametersImpl.getDefault();</div><div class="line">        &#125; <span class="keyword">catch</span> (KeyManagementException e) &#123;</div><div class="line">            instantiationExceptionLocal = <span class="keyword">new</span> IOException(<span class="string">"Delayed instantiation exception:"</span>);</div><div class="line">            instantiationExceptionLocal.initCause(e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.sslParameters = sslParametersLocal;</div><div class="line">        <span class="keyword">this</span>.instantiationException = instantiationExceptionLocal;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OpenSSLSocketFactoryImpl</span><span class="params">(SSLParametersImpl sslParameters)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.sslParameters = sslParameters;</div><div class="line">        <span class="keyword">this</span>.instantiationException = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> String[] getDefaultCipherSuites() &#123;</div><div class="line">        <span class="function"><span class="keyword">return</span> sslParameters.<span class="title">getEnabledCipherSuites</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> String[] getSupportedCipherSuites() &#123;</div><div class="line">        <span class="function"><span class="keyword">return</span> NativeCrypto.<span class="title">getSupportedCipherSuites</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function">Socket <span class="title">createSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (instantiationException != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> instantiationException;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OpenSSLSocketImpl((SSLParametersImpl) sslParameters.clone());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function">Socket <span class="title">createSocket</span><span class="params">(String hostname, <span class="keyword">int</span> port)</span> <span class="keyword">throws</span> IOException, UnknownHostException </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OpenSSLSocketImpl(hostname, port, (SSLParametersImpl) sslParameters.clone());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function">Socket <span class="title">createSocket</span><span class="params">(String hostname, <span class="keyword">int</span> port, InetAddress localHost, <span class="keyword">int</span> localPort)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException, UnknownHostException &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OpenSSLSocketImpl(hostname,</div><div class="line">                                     port,</div><div class="line">                                     localHost,</div><div class="line">                                     localPort,</div><div class="line">                                     (SSLParametersImpl) sslParameters.clone());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function">Socket <span class="title">createSocket</span><span class="params">(InetAddress address, <span class="keyword">int</span> port)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OpenSSLSocketImpl(address, port, (SSLParametersImpl) sslParameters.clone());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function">Socket <span class="title">createSocket</span><span class="params">(InetAddress address,</span></span></div><div class="line">                               <span class="keyword">int</span> port,</div><div class="line">                               InetAddress localAddress,</div><div class="line">                               <span class="keyword">int</span> localPort)</div><div class="line">            <span class="keyword">throws</span> IOException &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OpenSSLSocketImpl(address,</div><div class="line">                                     port,</div><div class="line">                                     localAddress,</div><div class="line">                                     localPort,</div><div class="line">                                     (SSLParametersImpl) sslParameters.clone());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function">Socket <span class="title">createSocket</span><span class="params">(Socket s, String hostname, <span class="keyword">int</span> port, <span class="keyword">boolean</span> autoClose)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OpenSSLSocketImplWrapper(s,</div><div class="line">                                            hostname,</div><div class="line">                                            port,</div><div class="line">                                            autoClose,</div><div class="line">                                            (SSLParametersImpl) sslParameters.clone());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>OpenSSLSocketImpl</code> 最主要的职责，即是将 SSL/TLS 参数 <code>SSLParametersImpl</code> 与 SSLSocket 粘起来。主要来看默认情况下 <code>SSLParametersImpl</code> 的 <code>X509TrustManager</code> 是什么（位于<code>external/conscrypt/src/main/java/org/conscrypt/SSLParametersImpl.java</code> ）：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">/**</span></div><div class="line">    * Initializes the parameters. Naturally this constructor is used</div><div class="line">    * in SSLContextImpl.engineInit method which directly passes its</div><div class="line">    * parameters. In other words this constructor holds all</div><div class="line">    * the functionality provided by SSLContext.init method.</div><div class="line">    * See &#123;<span class="doctag">@link</span> javax.net.ssl.SSLContext#init(KeyManager[],TrustManager[],</div><div class="line">    * SecureRandom)&#125; for more information</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="title">SSLParametersImpl</span><span class="params">(KeyManager[] kms, TrustManager[] tms,</span></span></div><div class="line">           SecureRandom sr, ClientSessionContext clientSessionContext,</div><div class="line">           ServerSessionContext serverSessionContext, String[] protocols)</div><div class="line">           <span class="keyword">throws</span> KeyManagementException &#123;</div><div class="line">       <span class="keyword">this</span>.serverSessionContext = serverSessionContext;</div><div class="line">       <span class="keyword">this</span>.clientSessionContext = clientSessionContext;</div><div class="line"></div><div class="line">       <span class="comment">// initialize key managers</span></div><div class="line">       <span class="keyword">if</span> (kms == <span class="keyword">null</span>) &#123;</div><div class="line">           x509KeyManager = getDefaultX509KeyManager();</div><div class="line">           <span class="comment">// There's no default PSK key manager</span></div><div class="line">           pskKeyManager = <span class="keyword">null</span>;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           x509KeyManager = findFirstX509KeyManager(kms);</div><div class="line">           pskKeyManager = findFirstPSKKeyManager(kms);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// initialize x509TrustManager</span></div><div class="line">       <span class="keyword">if</span> (tms == <span class="keyword">null</span>) &#123;</div><div class="line">           x509TrustManager = getDefaultX509TrustManager();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           x509TrustManager = findFirstX509TrustManager(tms);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// initialize secure random</span></div><div class="line">       <span class="comment">// We simply use the SecureRandom passed in by the caller. If it's</span></div><div class="line">       <span class="comment">// null, we don't replace it by a new instance. The native code below</span></div><div class="line">       <span class="comment">// then directly accesses /dev/urandom. Not the most elegant solution,</span></div><div class="line">       <span class="comment">// but faster than going through the SecureRandom object.</span></div><div class="line">       secureRandom = sr;</div><div class="line"></div><div class="line">       <span class="comment">// initialize the list of cipher suites and protocols enabled by default</span></div><div class="line">       enabledProtocols = NativeCrypto.checkEnabledProtocols(</div><div class="line">               protocols == <span class="keyword">null</span> ? NativeCrypto.DEFAULT_PROTOCOLS : protocols).clone();</div><div class="line">       <span class="keyword">boolean</span> x509CipherSuitesNeeded = (x509KeyManager != <span class="keyword">null</span>) || (x509TrustManager != <span class="keyword">null</span>);</div><div class="line">       <span class="keyword">boolean</span> pskCipherSuitesNeeded = pskKeyManager != <span class="keyword">null</span>;</div><div class="line">       enabledCipherSuites = getDefaultCipherSuites(</div><div class="line">               x509CipherSuitesNeeded, pskCipherSuitesNeeded);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function">SSLParametersImpl <span class="title">getDefault</span><span class="params">()</span> <span class="keyword">throws</span> KeyManagementException </span>&#123;</div><div class="line">       SSLParametersImpl result = defaultParameters;</div><div class="line">       <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// single-check idiom</span></div><div class="line">           defaultParameters = result = <span class="keyword">new</span> SSLParametersImpl(<span class="keyword">null</span>,</div><div class="line">                                                              <span class="keyword">null</span>,</div><div class="line">                                                              <span class="keyword">null</span>,</div><div class="line">                                                              <span class="keyword">new</span> ClientSessionContext(),</div><div class="line">                                                              <span class="keyword">new</span> ServerSessionContext(),</div><div class="line">                                                              <span class="keyword">null</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> (SSLParametersImpl) result.clone();</div><div class="line">   &#125;</div><div class="line">. . . . . . </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * <span class="doctag">@return</span> X.509 trust manager or &#123;<span class="doctag">@code</span> null&#125; for none.</div><div class="line">    */</div><div class="line">   <span class="keyword">protected</span> <span class="function">X509TrustManager <span class="title">getX509TrustManager</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> x509TrustManager;</div><div class="line">   &#125;</div><div class="line">. . . . . . </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Gets the default X.509 trust manager.</div><div class="line">    * &lt;p&gt;</div><div class="line">    * <span class="doctag">TODO:</span> Move this to a published API under dalvik.system.</div><div class="line">    */</div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="function">X509TrustManager <span class="title">getDefaultX509TrustManager</span><span class="params">()</span></span></div><div class="line">           <span class="keyword">throws</span> KeyManagementException &#123;</div><div class="line">       X509TrustManager result = defaultX509TrustManager;</div><div class="line">       <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// single-check idiom</span></div><div class="line">           defaultX509TrustManager = result = createDefaultX509TrustManager();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="function">X509TrustManager <span class="title">createDefaultX509TrustManager</span><span class="params">()</span></span></div><div class="line">           <span class="keyword">throws</span> KeyManagementException &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           String algorithm = TrustManagerFactory.getDefaultAlgorithm();</div><div class="line">           TrustManagerFactory tmf = TrustManagerFactory.getInstance(algorithm);</div><div class="line">           tmf.init((KeyStore) <span class="keyword">null</span>);</div><div class="line">           TrustManager[] tms = tmf.getTrustManagers();</div><div class="line">           X509TrustManager trustManager = findFirstX509TrustManager(tms);</div><div class="line">           <span class="keyword">if</span> (trustManager == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> KeyManagementException(</div><div class="line">                       <span class="string">"No X509TrustManager in among default TrustManagers: "</span></div><div class="line">                               + Arrays.toString(tms));</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> trustManager;</div><div class="line">       &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> KeyManagementException(e);</div><div class="line">       &#125; <span class="keyword">catch</span> (KeyStoreException e) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> KeyManagementException(e);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>将 <code>createDefaultX509TrustManager()</code> 的代码复制到我们的应用程序中，就像下面这样：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function">X509TrustManager <span class="title">systemDefaultTrustManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(</div><div class="line">                TrustManagerFactory.getDefaultAlgorithm());</div><div class="line">        trustManagerFactory.init((KeyStore) <span class="keyword">null</span>);</div><div class="line">        TrustManager[] trustManagers = trustManagerFactory.getTrustManagers();</div><div class="line">        <span class="keyword">if</span> (trustManagers.length != <span class="number">1</span> || !(trustManagers[<span class="number">0</span>] <span class="keyword">instanceof</span> X509TrustManager)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unexpected default trust managers:"</span></div><div class="line">                    + Arrays.toString(trustManagers));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> (X509TrustManager) trustManagers[<span class="number">0</span>];</div><div class="line">    &#125; <span class="keyword">catch</span> (GeneralSecurityException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(); <span class="comment">// The system has no TLS. Just give up.</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在应用程序执行时打断点，借助于 Android Studio 确认系统默认的 <code>X509TrustManager</code> 是什么，不难确认，它是 <code>android.security.net.config.RootTrustManager</code>。<code>android.security.net.config.RootTrustManager</code> 的 <code>checkServerTrusted()</code> 定义（位于 <code>frameworks/base/core/java/android/security/net/config/RootTrustManager.java</code>）如下：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> checkServerTrusted(X509Certificate[] certs, <span class="keyword">String</span> authType, Socket socket)</div><div class="line">        throws CertificateException &#123;</div><div class="line">    <span class="built_in">if</span> (socket instanceof SSLSocket) &#123;</div><div class="line">        SSLSocket sslSocket = (SSLSocket) socket;</div><div class="line">        SSLSession session = sslSocket.getHandshakeSession();</div><div class="line">        <span class="built_in">if</span> (session == null) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CertificateException(<span class="string">"Not in handshake; no session available"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">String</span> host = session.getPeerHost();</div><div class="line">        NetworkSecurityConfig <span class="built_in">config</span> = mConfig.getConfigForHostname(host);</div><div class="line">        <span class="built_in">config</span>.getTrustManager().checkServerTrusted(certs, authType, socket);</div><div class="line">    &#125; <span class="built_in">else</span> &#123;</div><div class="line">        <span class="comment">// Not an SSLSocket, use the hostname unaware checkServerTrusted.</span></div><div class="line">        checkServerTrusted(certs, authType);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> checkServerTrusted(X509Certificate[] certs, <span class="keyword">String</span> authType, SSLEngine engine)</div><div class="line">        throws CertificateException &#123;</div><div class="line">    SSLSession session = engine.getHandshakeSession();</div><div class="line">    <span class="built_in">if</span> (session == null) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CertificateException(<span class="string">"Not in handshake; no session available"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">String</span> host = session.getPeerHost();</div><div class="line">    NetworkSecurityConfig <span class="built_in">config</span> = mConfig.getConfigForHostname(host);</div><div class="line">    <span class="built_in">config</span>.getTrustManager().checkServerTrusted(certs, authType, engine);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> checkServerTrusted(X509Certificate[] certs, <span class="keyword">String</span> authType)</div><div class="line">        throws CertificateException &#123;</div><div class="line">    <span class="built_in">if</span> (mConfig.hasPerDomainConfigs()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CertificateException(</div><div class="line">                <span class="string">"Domain specific configurations require that hostname aware"</span></div><div class="line">                + <span class="string">" checkServerTrusted(X509Certificate[], String, String) is used"</span>);</div><div class="line">    &#125;</div><div class="line">    NetworkSecurityConfig <span class="built_in">config</span> = mConfig.getConfigForHostname(<span class="string">""</span>);</div><div class="line">    <span class="built_in">config</span>.getTrustManager().checkServerTrusted(certs, authType);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Hostname aware version of &#123;@link #checkServerTrusted(X509Certificate[], String)&#125;.</div><div class="line"> * This interface is used by conscrypt and android.net.http.X509TrustManagerExtensions do not</div><div class="line"> * modify without modifying those callers.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> List&lt;X509Certificate&gt; checkServerTrusted(X509Certificate[] certs, <span class="keyword">String</span> authType,</div><div class="line">        <span class="keyword">String</span> hostname) throws CertificateException &#123;</div><div class="line">    <span class="built_in">if</span> (hostname == null &amp;&amp; mConfig.hasPerDomainConfigs()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CertificateException(</div><div class="line">                <span class="string">"Domain specific configurations require that the hostname be provided"</span>);</div><div class="line">    &#125;</div><div class="line">    NetworkSecurityConfig <span class="built_in">config</span> = mConfig.getConfigForHostname(hostname);</div><div class="line">    <span class="built_in">return</span> <span class="built_in">config</span>.getTrustManager().checkServerTrusted(certs, authType, hostname);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>NetworkSecurityConfig</code> 的 <code>getTrustManager()</code> 定义（位于 <code>frameworks/base/core/java/android/security/net/config/NetworkSecurityConfig.java</code>）如下：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function">NetworkSecurityTrustManager <span class="title">getTrustManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span>(mTrustManagerLock) &#123;</div><div class="line">        <span class="keyword">if</span> (mTrustManager == <span class="keyword">null</span>) &#123;</div><div class="line">            mTrustManager = <span class="keyword">new</span> NetworkSecurityTrustManager(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mTrustManager;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>NetworkSecurityConfig</code> 将管根证书库的组件 <code>SystemCertificateSource</code> 、 <code>UserCertificateSource</code> 和执行证书合法性验证的 <code>NetworkSecurityTrustManager</code> 粘起来：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="function">Builder <span class="title">getDefaultBuilder</span><span class="params">(<span class="keyword">int</span> targetSdkVersion)</span> </span>&#123;</div><div class="line">    Builder builder = <span class="keyword">new</span> Builder()</div><div class="line">            .setCleartextTrafficPermitted(DEFAULT_CLEARTEXT_TRAFFIC_PERMITTED)</div><div class="line">            .setHstsEnforced(DEFAULT_HSTS_ENFORCED)</div><div class="line">            <span class="comment">// System certificate store, does not bypass static pins.</span></div><div class="line">            .addCertificatesEntryRef(</div><div class="line">                    <span class="keyword">new</span> CertificatesEntryRef(SystemCertificateSource.getInstance(), <span class="keyword">false</span>));</div><div class="line">    <span class="comment">// Applications targeting N and above must opt in into trusting the user added certificate</span></div><div class="line">    <span class="comment">// store.</span></div><div class="line">    <span class="keyword">if</span> (targetSdkVersion &lt;= Build.VERSION_CODES.M) &#123;</div><div class="line">        <span class="comment">// User certificate store, does not bypass static pins.</span></div><div class="line">        builder.addCertificatesEntryRef(</div><div class="line">                <span class="keyword">new</span> CertificatesEntryRef(UserCertificateSource.getInstance(), <span class="keyword">false</span>));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> builder;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同时 <code>NetworkSecurityConfig</code> 还提供了一些根据特定条件查找根证书的操作：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">    public Set<span class="variable">&lt;TrustAnchor&gt;</span> getTrustAnchors() &#123;</div><div class="line">        synchronized (mAnchorsLock) &#123;</div><div class="line">            if (mAnchors != null) &#123;</div><div class="line">                return mAnchors;</div><div class="line">            &#125;</div><div class="line">            // Merge trust anchors based <span class="keyword">on</span> the X509Certificate.</div><div class="line">            // If we see the same certificate <span class="keyword">in</span> two TrustAnchors, one with overridesPins and one</div><div class="line">            // without, the one with overridesPins wins.</div><div class="line">            // Because mCertificatesEntryRefs is sorted with <span class="literal">all</span> overridesPins anchors coming first</div><div class="line">            // this can be simplified <span class="keyword">to</span> just using the first occurrence of a certificate.</div><div class="line">            Map<span class="variable">&lt;X509Certificate, TrustAnchor&gt;</span> <span class="built_in">anchor</span>Map = new ArrayMap<span class="variable">&lt;&gt;</span>();</div><div class="line">            <span class="keyword">for</span> (CertificatesEntryRef ref : mCertificatesEntryRefs) &#123;</div><div class="line">                Set<span class="variable">&lt;TrustAnchor&gt;</span> anchors = ref.getTrustAnchors();</div><div class="line">                <span class="keyword">for</span> (TrustAnchor <span class="built_in">anchor</span> : anchors) &#123;</div><div class="line">                    X509Certificate cert = <span class="built_in">anchor</span>.certificate;</div><div class="line">                    if (!<span class="built_in">anchor</span>Map.containsKey(cert)) &#123;</div><div class="line">                        <span class="built_in">anchor</span>Map.put(cert, <span class="built_in">anchor</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            ArraySet<span class="variable">&lt;TrustAnchor&gt;</span> anchors = new ArraySet<span class="variable">&lt;TrustAnchor&gt;</span>(<span class="built_in">anchor</span>Map.size());</div><div class="line">            anchors.addAll(<span class="built_in">anchor</span>Map.values());</div><div class="line">            mAnchors = anchors;</div><div class="line">            return mAnchors;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">. . . . . .</div><div class="line">    public NetworkSecurityTrustManager getTrustManager() &#123;</div><div class="line">        synchronized(mTrustManagerLock) &#123;</div><div class="line">            if (mTrustManager == null) &#123;</div><div class="line">                mTrustManager = new NetworkSecurityTrustManager(this);</div><div class="line">            &#125;</div><div class="line">            return mTrustManager;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /** @hide */</div><div class="line">    public TrustAnchor findTrustAnchorBySubjectAndPublicKey(X509Certificate cert) &#123;</div><div class="line">        <span class="keyword">for</span> (CertificatesEntryRef ref : mCertificatesEntryRefs) &#123;</div><div class="line">            TrustAnchor <span class="built_in">anchor</span> = ref.findBySubjectAndPublicKey(cert);</div><div class="line">            if (<span class="built_in">anchor</span> != null) &#123;</div><div class="line">                return <span class="built_in">anchor</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /** @hide */</div><div class="line">    public TrustAnchor findTrustAnchorByIssuerAndSignature(X509Certificate cert) &#123;</div><div class="line">        <span class="keyword">for</span> (CertificatesEntryRef ref : mCertificatesEntryRefs) &#123;</div><div class="line">            TrustAnchor <span class="built_in">anchor</span> = ref.findByIssuerAndSignature(cert);</div><div class="line">            if (<span class="built_in">anchor</span> != null) &#123;</div><div class="line">                return <span class="built_in">anchor</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /** @hide */</div><div class="line">    public Set<span class="variable">&lt;X509Certificate&gt;</span> findAllCertificatesByIssuerAndSignature(X509Certificate cert) &#123;</div><div class="line">        Set<span class="variable">&lt;X509Certificate&gt;</span> certs = new ArraySet<span class="variable">&lt;X509Certificate&gt;</span>();</div><div class="line">        <span class="keyword">for</span> (CertificatesEntryRef ref : mCertificatesEntryRefs) &#123;</div><div class="line">            certs.addAll(ref.findAllCertificatesByIssuerAndSignature(cert));</div><div class="line">        &#125;</div><div class="line">        return certs;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>真正执行证书合法性验证的还不是 <code>NetworkSecurityTrustManager</code>，而是 <code>TrustManagerImpl</code>（位于 <code>external/conscrypt/src/platform/java/org/conscrypt/TrustManagerImpl.java</code>），由 <code>NetworkSecurityTrustManager</code> 的定义（位于<code>frameworks/base/core/java/android/security/net/config/NetworkSecurityTrustManager.java</code>）不难看出这一点：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">public</span> NetworkSecurityTrustManager(NetworkSecurityConfig config) &#123;</div><div class="line">        <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"config must not be null"</span>);</div><div class="line">        &#125;</div><div class="line">        mNetworkSecurityConfig = config;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            TrustedCertificateStoreAdapter certStore = <span class="keyword">new</span> TrustedCertificateStoreAdapter(config);</div><div class="line">            <span class="comment">// Provide an empty KeyStore since TrustManagerImpl doesn't support null KeyStores.</span></div><div class="line">            <span class="comment">// TrustManagerImpl will use certStore to lookup certificates.</span></div><div class="line">            KeyStore store = KeyStore.getInstance(KeyStore.getDefaultType());</div><div class="line">            store.load(<span class="keyword">null</span>);</div><div class="line">            mDelegate = <span class="keyword">new</span> TrustManagerImpl(store, <span class="keyword">null</span>, certStore);</div><div class="line">        &#125; <span class="keyword">catch</span> (GeneralSecurityException | IOException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">. . . . . .</div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> checkServerTrusted(X509Certificate[] certs, <span class="keyword">String</span> authType)</div><div class="line">            <span class="keyword">throws</span> CertificateException &#123;</div><div class="line">        checkServerTrusted(certs, authType, (<span class="keyword">String</span>) <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> checkServerTrusted(X509Certificate[] certs, <span class="keyword">String</span> authType, Socket socket)</div><div class="line">            <span class="keyword">throws</span> CertificateException &#123;</div><div class="line">        List&lt;X509Certificate&gt; trustedChain =</div><div class="line">                mDelegate.getTrustedChainForServer(certs, authType, socket);</div><div class="line">        checkPins(trustedChain);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> checkServerTrusted(X509Certificate[] certs, <span class="keyword">String</span> authType, SSLEngine engine)</div><div class="line">            <span class="keyword">throws</span> CertificateException &#123;</div><div class="line">        List&lt;X509Certificate&gt; trustedChain =</div><div class="line">                mDelegate.getTrustedChainForServer(certs, authType, engine);</div><div class="line">        checkPins(trustedChain);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Hostname aware version of &#123;@link #checkServerTrusted(X509Certificate[], String)&#125;.</div><div class="line">     * This interface is used by conscrypt and android.net.http.X509TrustManagerExtensions do not</div><div class="line">     * modify without modifying those callers.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> List&lt;X509Certificate&gt; checkServerTrusted(X509Certificate[] certs, <span class="keyword">String</span> authType,</div><div class="line">            <span class="keyword">String</span> host) <span class="keyword">throws</span> CertificateException &#123;</div><div class="line">        List&lt;X509Certificate&gt; trustedChain = mDelegate.checkServerTrusted(certs, authType, host);</div><div class="line">        checkPins(trustedChain);</div><div class="line">        <span class="keyword">return</span> trustedChain;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> checkPins(List&lt;X509Certificate&gt; chain) <span class="keyword">throws</span> CertificateException &#123;</div><div class="line">        PinSet pinSet = mNetworkSecurityConfig.getPins();</div><div class="line">        <span class="keyword">if</span> (pinSet.pins.isEmpty()</div><div class="line">                || System.currentTimeMillis() &gt; pinSet.expirationTime</div><div class="line">                || !isPinningEnforced(chain)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        Set&lt;<span class="keyword">String</span>&gt; pinAlgorithms = pinSet.getPinAlgorithms();</div><div class="line">        Map&lt;<span class="keyword">String</span>, MessageDigest&gt; digestMap = <span class="keyword">new</span> ArrayMap&lt;<span class="keyword">String</span>, MessageDigest&gt;(</div><div class="line">                pinAlgorithms.<span class="built_in">size</span>());</div><div class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = chain.<span class="built_in">size</span>() - <span class="number">1</span>; i &gt;= <span class="number">0</span> ; i--) &#123;</div><div class="line">            X509Certificate cert = chain.<span class="built_in">get</span>(i);</div><div class="line">            <span class="built_in">byte</span>[] encodedSPKI = cert.getPublicKey().getEncoded();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">String</span> algorithm : pinAlgorithms) &#123;</div><div class="line">                MessageDigest md = digestMap.<span class="built_in">get</span>(algorithm);</div><div class="line">                <span class="keyword">if</span> (md == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        md = MessageDigest.getInstance(algorithm);</div><div class="line">                    &#125; <span class="keyword">catch</span> (GeneralSecurityException e) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">                    &#125;</div><div class="line">                    digestMap.put(algorithm, md);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (pinSet.pins.contains(<span class="keyword">new</span> Pin(algorithm, md.digest(encodedSPKI)))) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> Throw a subclass of CertificateException which indicates a pinning failure.</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CertificateException(<span class="string">"Pin verification failed"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><code>TrustedCertificateStoreAdapter</code> 为根证书库提供了 <code>TrustedCertificateStore</code> 接口的查找操作，以方便 <code>TrustManagerImpl</code> 使用（位于<code>frameworks/base/core/java/android/security/net/config/TrustedCertificateStoreAdapter.java</code>）：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">public class TrustedCertificateStoreAdapter extends TrustedCertificateStore &#123;</div><div class="line">    private final NetworkSecurityConfig mConfig;</div><div class="line"></div><div class="line">    public TrustedCertificateStoreAdapter(NetworkSecurityConfig config) &#123;</div><div class="line">        mConfig = config;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public X509Certificate findIssuer(X509Certificate cert) &#123;</div><div class="line">        TrustAnchor <span class="built_in">anchor</span> = mConfig.findTrustAnchorByIssuerAndSignature(cert);</div><div class="line">        if (<span class="built_in">anchor</span> == null) &#123;</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line">        return <span class="built_in">anchor</span>.certificate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Set<span class="variable">&lt;X509Certificate&gt;</span> findAllIssuers(X509Certificate cert) &#123;</div><div class="line">        return mConfig.findAllCertificatesByIssuerAndSignature(cert);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public X509Certificate getTrustAnchor(X509Certificate cert) &#123;</div><div class="line">        TrustAnchor <span class="built_in">anchor</span> = mConfig.findTrustAnchorBySubjectAndPublicKey(cert);</div><div class="line">        if (<span class="built_in">anchor</span> == null) &#123;</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line">        return <span class="built_in">anchor</span>.certificate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean isUserAddedCertificate(X509Certificate cert) &#123;</div><div class="line">        // isUserAddedCertificate is used only <span class="keyword">for</span> pinning overrides, so use overridesPins here.</div><div class="line">        TrustAnchor <span class="built_in">anchor</span> = mConfig.findTrustAnchorBySubjectAndPublicKey(cert);</div><div class="line">        if (<span class="built_in">anchor</span> == null) &#123;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line">        return <span class="built_in">anchor</span>.overridesPins;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>不难看出 Android 中 Java 层证书验证的过程如下图所示：<br><img src="https://www.wolfcstech.com/images/1315506-6eb297cdb8af12d2.jpg" alt="57a8088064c6f4f0671ec61834688ca3.jpg"></p>
<p><code>OpenSSLSocketImpl.startHandshake()</code> 和 <code>NativeCrypto.SSL_do_handshake()</code> 执行完整的 SSL/TLS 握手过程。证书合法性验证作为 SSL/TLS 握手的一个重要步骤，通过本地层调用的 Java 层的回调方法 <code>SSLHandshakeCallbacks.verifyCertificateChain()</code> 完成，<code>OpenSSLSocketImpl</code> 实现这一回调。<code>OpenSSLSocketImpl.verifyCertificateChain()</code>、<code>Platform.checkServerTrusted()</code>、<code>RootTrustManager.checkServerTrusted()</code> 和<code>NetworkSecurityTrustManager.checkServerTrusted()</code> 用于将真正的根据系统根证书库执行证书合法性验证的 <code>TrustManagerImpl</code> 和 SSL/TLS 握手过程粘起来。<code>OpenSSLSocketFactoryImpl</code> 将 <code>OpenSSLSocketImpl</code> 和 <code>SSLParametersImpl</code> 粘起来。<code>SSLParametersImpl</code> 将 <code>OpenSSLSocketImpl</code> 和 <code>RootTrustManager</code> 粘起来。</p>
<p><code>NetworkSecurityConfig</code> 将 <code>RootTrustManager</code> 和 <code>NetworkSecurityTrustManager</code> 粘起来。<code>NetworkSecurityConfig</code>、<code>NetworkSecurityTrustManager</code> 和 <code>TrustedCertificateStoreAdapter</code> 将 <code>TrustManagerImpl</code> 和管理系统根证书库的 <code>SystemCertificateSource</code> 粘起来。</p>
<p><code>TrustManagerImpl</code> 是证书合法性验证的核心，它会查找系统根证书库，并对服务端证书的合法性做验证。</p>
<p>这个过程的调用栈如下：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">com<span class="selector-class">.android</span><span class="selector-class">.org</span><span class="selector-class">.conscrypt</span><span class="selector-class">.TrustManagerImpl</span><span class="selector-class">.checkServerTrusted</span>()</div><div class="line">android<span class="selector-class">.security</span><span class="selector-class">.net</span><span class="selector-class">.config</span><span class="selector-class">.NetworkSecurityTrustManager</span><span class="selector-class">.checkServerTrusted</span>()</div><div class="line">android<span class="selector-class">.security</span><span class="selector-class">.net</span><span class="selector-class">.config</span><span class="selector-class">.NetworkSecurityTrustManager</span><span class="selector-class">.checkServerTrusted</span>()</div><div class="line">android<span class="selector-class">.security</span><span class="selector-class">.net</span><span class="selector-class">.config</span><span class="selector-class">.RootTrustManager</span><span class="selector-class">.checkServerTrusted</span>()</div><div class="line">com<span class="selector-class">.android</span><span class="selector-class">.org</span><span class="selector-class">.conscrypt</span><span class="selector-class">.Platform</span><span class="selector-class">.checkServerTrusted</span>()</div><div class="line">com<span class="selector-class">.android</span><span class="selector-class">.org</span><span class="selector-class">.conscrypt</span><span class="selector-class">.OpenSSLSocketImpl</span><span class="selector-class">.verifyCertificateChain</span>()</div><div class="line">com<span class="selector-class">.android</span><span class="selector-class">.org</span><span class="selector-class">.conscrypt</span><span class="selector-class">.NativeCrypto</span><span class="selector-class">.SSL_do_handshake</span>()</div><div class="line">com<span class="selector-class">.android</span><span class="selector-class">.org</span><span class="selector-class">.conscrypt</span><span class="selector-class">.OpenSSLSocketImpl</span><span class="selector-class">.startHandshake</span>()</div><div class="line">com<span class="selector-class">.android</span><span class="selector-class">.okhttp</span><span class="selector-class">.Connection</span><span class="selector-class">.connectTls</span>()</div></pre></td></tr></table></figure></p>
<p>还有两个问题，一是 <code>SSLParametersImpl</code> 是如何找到的 <code>RootTrustManager</code>；二是如何定制或者影响证书合法性的验证过程。</p>
<h1 id="TrustManager-的查找"><a href="#TrustManager-的查找" class="headerlink" title="TrustManager 的查找"></a>TrustManager 的查找</h1><p>Java 加密体系架构（JCA）是一个非常灵活的架构，它的整体结构如下图：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-32a5c3c78d634e3a.jpg" alt="JCA"></p>
<p>Java 应用程序通过接口层访问加密服务，接口层的组成包括 JAAS（Java Authentication Authorization Service，Java验证和授权API）、JSSE（Java Secure Socket Extension，Java 安全 套接字扩展）、JGSS（Java Generic Security Service ）和 CertPath等。具体的组件如我们前面看到的 <code>CertificateFactory</code>、<code>TrustManagerFactory</code> 和 <code>SSLSocketFactory</code> 等。</p>
<p>JCA 还定义了一组加密服务 Provider 接口，如 <code>javax.net.ssl.SSLContextSpi</code> 和 <code>javax.net.ssl.TrustManagerFactorySpi</code> 等。加密服务的实现者实现这些接口，并通过 <code>java.security.Security</code> 提供的接口注册进 JCA 框架。</p>
<p>对于 Android 系统来说，<code>TrustManagerFactory</code> 加密服务的注册是在 <code>ActivityThread</code> 的 <code>handleBindApplication()</code> 中做的，相关代码（位于 <code>frameworks/base/core/java/android/app/ActivityThread.java</code>）如下：<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Install the Network Security Config Provider. This must happen before the application</span></div><div class="line"><span class="comment">// code is loaded to prevent issues with instances of TLS objects being created before</span></div><div class="line"><span class="comment">// the provider is installed.</span></div><div class="line"><span class="keyword">Trace</span>.traceBegin(<span class="keyword">Trace</span>.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"NetworkSecurityConfigProvider.install"</span>);</div><div class="line">NetworkSecurityConfigProvider.install(appContext);</div><div class="line"><span class="keyword">Trace</span>.traceEnd(<span class="keyword">Trace</span>.TRACE_TAG_ACTIVITY_MANAGER);</div></pre></td></tr></table></figure></p>
<p><code>NetworkSecurityConfigProvider</code> 类的定义（位于 <code>frameworks/base/core/java/android/security/net/config/NetworkSecurityConfigProvider.java</code>）如下：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> android.security.net.config;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.<span class="type">Context</span>;</div><div class="line"><span class="keyword">import</span> java.security.<span class="type">Security</span>;</div><div class="line"><span class="keyword">import</span> java.security.<span class="type">Provider</span>;</div><div class="line"></div><div class="line"><span class="comment">/** @hide */</span></div><div class="line">public <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkSecurityConfigProvider</span> <span class="keyword">extends</span> <span class="title">Provider</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> <span class="type">String</span> <span class="type">PREFIX</span> =</div><div class="line">            <span class="type">NetworkSecurityConfigProvider</span>.<span class="keyword">class</span>.getPackage().getName() + <span class="string">"."</span>;</div><div class="line"></div><div class="line">    public <span class="type">NetworkSecurityConfigProvider</span>() &#123;</div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> More clever name than this</span></div><div class="line">        <span class="keyword">super</span>(<span class="string">"AndroidNSSP"</span>, <span class="number">1.0</span>, <span class="string">"Android Network Security Policy Provider"</span>);</div><div class="line">        put(<span class="string">"TrustManagerFactory.PKIX"</span>, <span class="type">PREFIX</span> + <span class="string">"RootTrustManagerFactorySpi"</span>);</div><div class="line">        put(<span class="string">"Alg.Alias.TrustManagerFactory.X509"</span>, <span class="string">"PKIX"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void install(<span class="type">Context</span> context) &#123;</div><div class="line">        <span class="type">ApplicationConfig</span> config = <span class="keyword">new</span> <span class="type">ApplicationConfig</span>(<span class="keyword">new</span> <span class="type">ManifestConfigSource</span>(context));</div><div class="line">        <span class="type">ApplicationConfig</span>.setDefaultInstance(config);</div><div class="line">        int pos = <span class="type">Security</span>.insertProviderAt(<span class="keyword">new</span> <span class="type">NetworkSecurityConfigProvider</span>(), <span class="number">1</span>);</div><div class="line">        <span class="keyword">if</span> (pos != <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">RuntimeException</span>(<span class="string">"Failed to install provider as highest priority provider."</span></div><div class="line">                    + <span class="string">" Provider was installed at position "</span> + pos);</div><div class="line">        &#125;</div><div class="line">        libcore.net.<span class="type">NetworkSecurityPolicy</span>.setInstance(<span class="keyword">new</span> <span class="type">ConfigNetworkSecurityPolicy</span>(config));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 <code>NetworkSecurityConfigProvider.install()</code> 方法中，通过 <code>Security.insertProviderAt()</code> 将 <code>NetworkSecurityConfigProvider</code> 注册进 JCA 框架中。从 <code>NetworkSecurityConfigProvider</code> 的构造函数可以看到，它将 <code>android.security.net.config.RootTrustManagerFactorySpi</code> 带进 JCA 框架。</p>
<p><code>android.security.net.config.RootTrustManagerFactorySpi</code> 的定义（位于 <code>frameworks/base/core/java/android/security/net/config/RootTrustManagerFactorySpi.java</code>）如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> android.security.net.config;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.util.Pair;</div><div class="line"><span class="keyword">import</span> java.security.InvalidAlgorithmParameterException;</div><div class="line"><span class="keyword">import</span> java.security.InvalidParameterException;</div><div class="line"><span class="keyword">import</span> java.security.KeyStore;</div><div class="line"><span class="keyword">import</span> java.security.KeyStoreException;</div><div class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</div><div class="line"><span class="keyword">import</span> java.security.Provider;</div><div class="line"><span class="keyword">import</span> java.security.Security;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.ManagerFactoryParameters;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.TrustManager;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.TrustManagerFactory;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.TrustManagerFactorySpi;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.android.internal.annotations.VisibleForTesting;</div><div class="line"></div><div class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RootTrustManagerFactorySpi</span> <span class="keyword">extends</span> <span class="title">TrustManagerFactorySpi</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ApplicationConfig mApplicationConfig;</div><div class="line">    <span class="keyword">private</span> NetworkSecurityConfig mConfig;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">engineInit</span><span class="params">(ManagerFactoryParameters spec)</span></span></div><div class="line">            <span class="keyword">throws</span> InvalidAlgorithmParameterException &#123;</div><div class="line">        <span class="keyword">if</span> (!(spec <span class="keyword">instanceof</span> ApplicationConfigParameters)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidAlgorithmParameterException(<span class="string">"Unsupported spec: "</span> +  spec + <span class="string">". Only "</span></div><div class="line">                    + ApplicationConfigParameters.class.getName() + <span class="string">" supported"</span>);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        mApplicationConfig = ((ApplicationConfigParameters) spec).config;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">engineInit</span><span class="params">(KeyStore ks)</span> <span class="keyword">throws</span> KeyStoreException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (ks != <span class="keyword">null</span>) &#123;</div><div class="line">            mApplicationConfig = <span class="keyword">new</span> ApplicationConfig(<span class="keyword">new</span> KeyStoreConfigSource(ks));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mApplicationConfig = ApplicationConfig.getDefaultInstance();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> TrustManager[] engineGetTrustManagers() &#123;</div><div class="line">        <span class="keyword">if</span> (mApplicationConfig == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"TrustManagerFactory not initialized"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TrustManager[] &#123; mApplicationConfig.getTrustManager() &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@VisibleForTesting</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationConfigParameters</span> <span class="keyword">implements</span> <span class="title">ManagerFactoryParameters</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> ApplicationConfig config;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ApplicationConfigParameters</span><span class="params">(ApplicationConfig config)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.config = config;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>RootTrustManagerFactorySpi</code> 的 <code>TrustManager</code> 来自于 <code>ApplicationConfig</code>，<code>ApplicationConfig</code> 中 <code>TrustManager</code> 相关的代码（位于 <code>frameworks/base/core/java/android/security/net/config/ApplicationConfig.java</code>）如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationConfig</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationConfig sInstance;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object sLock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Set&lt;Pair&lt;Domain, NetworkSecurityConfig&gt;&gt; mConfigs;</div><div class="line">    <span class="keyword">private</span> NetworkSecurityConfig mDefaultConfig;</div><div class="line">    <span class="keyword">private</span> X509TrustManager mTrustManager;</div><div class="line">. . . . . .</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns the &#123;<span class="doctag">@link</span> X509TrustManager&#125; that implements the checking of trust anchors and</div><div class="line">     * certificate pinning based on this configuration.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> X509TrustManager <span class="title">getTrustManager</span><span class="params">()</span> </span>&#123;</div><div class="line">        ensureInitialized();</div><div class="line">        <span class="keyword">return</span> mTrustManager;</div><div class="line">    &#125;</div><div class="line">. . . . . .</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureInitialized</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span>(mLock) &#123;</div><div class="line">            <span class="keyword">if</span> (mInitialized) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            mConfigs = mConfigSource.getPerDomainConfigs();</div><div class="line">            mDefaultConfig = mConfigSource.getDefaultConfig();</div><div class="line">            mConfigSource = <span class="keyword">null</span>;</div><div class="line">            mTrustManager = <span class="keyword">new</span> RootTrustManager(<span class="keyword">this</span>);</div><div class="line">            mInitialized = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><code>ApplicationConfig</code> 的 <code>TrustManager</code> 是 <code>RootTrustManager</code>。</p>
<p>再来看 JCA 接口层的 <code>javax.net.ssl.TrustManagerFactory</code> 的定义：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrustManagerFactory</span> </span>&#123;</div><div class="line">    <span class="comment">// The provider</span></div><div class="line">    <span class="keyword">private</span> Provider provider;</div><div class="line"></div><div class="line">    <span class="comment">// The provider implementation (delegate)</span></div><div class="line">    <span class="keyword">private</span> TrustManagerFactorySpi factorySpi;</div><div class="line"></div><div class="line">    <span class="comment">// The name of the trust management algorithm.</span></div><div class="line">    <span class="keyword">private</span> String algorithm;</div><div class="line">. . . . . .</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="function">String <span class="title">getDefaultAlgorithm</span><span class="params">()</span> </span>&#123;</div><div class="line">        String type;</div><div class="line">        type = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;String&gt;() &#123;</div><div class="line">            <span class="keyword">public</span> <span class="function">String <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="function"><span class="keyword">return</span> Security.<span class="title">getProperty</span><span class="params">(</span></span></div><div class="line">                    <span class="string">"ssl.TrustManagerFactory.algorithm"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</div><div class="line">            type = <span class="string">"SunX509"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> type;</div><div class="line">    &#125;</div><div class="line">. . . . . .</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Creates a TrustManagerFactory object.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> factorySpi the delegate</div><div class="line">     * <span class="doctag">@param</span> provider the provider</div><div class="line">     * <span class="doctag">@param</span> algorithm the algorithm</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TrustManagerFactory</span><span class="params">(TrustManagerFactorySpi factorySpi,</span></span></div><div class="line">            Provider provider, String algorithm) &#123;</div><div class="line">        <span class="keyword">this</span>.factorySpi = factorySpi;</div><div class="line">        <span class="keyword">this</span>.provider = provider;</div><div class="line">        <span class="keyword">this</span>.algorithm = algorithm;</div><div class="line">    &#125;</div><div class="line">. . . . . .</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="function">TrustManagerFactory <span class="title">getInstance</span><span class="params">(String algorithm)</span></span></div><div class="line">            <span class="keyword">throws</span> NoSuchAlgorithmException &#123;</div><div class="line">        GetInstance.Instance instance = GetInstance.getInstance</div><div class="line">                (<span class="string">"TrustManagerFactory"</span>, TrustManagerFactorySpi.class,</div><div class="line">                algorithm);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TrustManagerFactory((TrustManagerFactorySpi)instance.impl,</div><div class="line">                instance.provider, algorithm);</div><div class="line">    &#125;</div><div class="line">. . . . . .</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(KeyStore ks)</span> <span class="keyword">throws</span> KeyStoreException </span>&#123;</div><div class="line">        factorySpi.engineInit(ks);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Initializes this factory with a source of provider-specific</div><div class="line">     * trust material.</div><div class="line">     * &lt;P&gt;</div><div class="line">     * In some cases, initialization parameters other than a keystore</div><div class="line">     * may be needed by a provider.  Users of that particular provider</div><div class="line">     * are expected to pass an implementation of the appropriate</div><div class="line">     * &lt;CODE&gt;ManagerFactoryParameters&lt;/CODE&gt; as defined by the</div><div class="line">     * provider.  The provider can then call the specified methods in</div><div class="line">     * the &lt;CODE&gt;ManagerFactoryParameters&lt;/CODE&gt; implementation to obtain the</div><div class="line">     * needed information.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> spec an implementation of a provider-specific parameter</div><div class="line">     *          specification</div><div class="line">     * <span class="doctag">@throws</span> InvalidAlgorithmParameterException if an error is</div><div class="line">     *          encountered</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(ManagerFactoryParameters spec)</span> <span class="keyword">throws</span></span></div><div class="line">            InvalidAlgorithmParameterException &#123;</div><div class="line">        factorySpi.engineInit(spec);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns one trust manager for each type of trust material.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span> IllegalStateException if the factory is not initialized.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> the trust managers</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> TrustManager[] getTrustManagers() &#123;</div><div class="line">        <span class="function"><span class="keyword">return</span> factorySpi.<span class="title">engineGetTrustManagers</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><code>TrustManagerFactory</code> 通过 JCA 框架提供的 <code>sun.security.jca.GetInstance</code> 找到注册的 <code>javax.net.ssl.TrustManagerFactorySpi</code>。应用程序通过 <code>javax.net.ssl.TrustManagerFactory</code> -&gt; <code>android.security.net.config.RootTrustManagerFactorySpi</code> -&gt; <code>android.security.net.config.ApplicationConfig</code> 得到 <code>android.security.net.config.RootTrustManager</code>，即 <code>X509TrustManager</code>。</p>
<h1 id="私有-CA-签名证书的应用"><a href="#私有-CA-签名证书的应用" class="headerlink" title="私有 CA 签名证书的应用"></a>私有 CA 签名证书的应用</h1><p>自签名证书是无需别的证书为其签名来证明其合法性的证书，根证书都是自签名证书。私有 CA 签名证书则是指，为域名证书签名的 CA，其合法有效性没有得到广泛的认可，该 CA 的根证书没有被内置到系统中。</p>
<p>在实际的开发过程中，有时为了节省昂贵的购买证书的费用，而想要自己给自己的服务器的域名签发域名证书，这即是私有 CA 签名的证书。为了能够使用这种证书，需要在客户端预埋根证书，并对客户端证书合法性验证的过程进行干预，通过我们预埋的根证书为服务端的证书做合法性验证，而不依赖系统的根证书库。</p>
<p>自定义 <code>javax.net.ssl.SSLSocket</code> 的代价太高，通常不会通过自定义 <code>javax.net.ssl.SSLSocket</code> 来修改服务端证书的合法性验证过程。以此为基础，从上面的分析中不难看出，要想定制 <code>OpenSSLSocketImpl</code> 的证书验证过程，则必然要改变 <code>SSLParametersImpl</code>，要改变 <code>OpenSSLSocketImpl</code> 的 <code>SSLParametersImpl</code>，则必然需要修改 <code>SSLSocketFactory</code>。修改 <code>SSLSocketFactory</code> 常常是一个不错的方法。</p>
<p>在 Java 中，<code>SSLContext</code> 正是被设计用于这一目的。创建定制了 <code>SSLParametersImpl</code>，即定制了 <code>TrustManager</code> 的 <code>SSLSocketFactory</code> 的方法如下：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">TrustManager[] trustManagers = new TrustManager[] &#123; new HelloX509TrustManager() &#125;<span class="comment">;;</span></div><div class="line"></div><div class="line">SSLContext <span class="built_in">context</span> = null<span class="comment">;</span></div><div class="line">try &#123;</div><div class="line">    <span class="built_in">context</span> = SSLContext.getInstance(<span class="string">"TLS"</span>)<span class="comment">;</span></div><div class="line">    <span class="built_in">context</span>.init(null, trustManagers, new SecureRandom())<span class="comment">;</span></div><div class="line">&#125; catch (NoSuchAlgorithmException e) &#123;</div><div class="line">    Log.i(TAG,<span class="string">"NoSuchAlgorithmException INFO:"</span>+e.getMessage())<span class="comment">;</span></div><div class="line">&#125; catch (KeyManagementException e) &#123;</div><div class="line">    Log.i(TAG, <span class="string">"KeyManagementException INFO:"</span> + e.getMessage())<span class="comment">;</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">HttpsURLConnection.setDefaultSSLSocketFactory(<span class="built_in">context</span>.getSocketFactory())<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p><code>SSLContext</code> 的相关方法实现（位于<code>libcore/ojluni/src/main/java/javax/net/ssl/SSLContext.java</code>）如下：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SSLContextSpi contextSpi;</div><div class="line">. . . . . .</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function">SSLContext <span class="title">getInstance</span><span class="params">(String protocol)</span></span></div><div class="line">            <span class="keyword">throws</span> NoSuchAlgorithmException &#123;</div><div class="line">        GetInstance.Instance instance = GetInstance.getInstance</div><div class="line">                (<span class="string">"SSLContext"</span>, SSLContextSpi.class, protocol);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SSLContext((SSLContextSpi)instance.impl, instance.provider,</div><div class="line">                protocol);</div><div class="line">    &#125;</div><div class="line">. . . . . .</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(KeyManager[] km, TrustManager[] tm,</span></span></div><div class="line">                                SecureRandom random)</div><div class="line">        <span class="keyword">throws</span> KeyManagementException &#123;</div><div class="line">        contextSpi.engineInit(km, tm, random);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns a &lt;code&gt;SocketFactory&lt;/code&gt; object for this</div><div class="line">     * context.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> the &lt;code&gt;SocketFactory&lt;/code&gt; object</div><div class="line">     * <span class="doctag">@throws</span> IllegalStateException if the SSLContextImpl requires</div><div class="line">     *          initialization and the &lt;code&gt;init()&lt;/code&gt; has not been called</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="function">SSLSocketFactory <span class="title">getSocketFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">return</span> contextSpi.<span class="title">engineGetSocketFactory</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>其中 <code>SSLContextSpi</code> 为 <code>OpenSSLContextImpl</code>，该类的实现（位于<code>external/conscrypt/src/main/java/org/conscrypt/OpenSSLContextImpl.java</code>）如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.conscrypt;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.security.GeneralSecurityException;</div><div class="line"><span class="keyword">import</span> java.security.KeyManagementException;</div><div class="line"><span class="keyword">import</span> java.security.SecureRandom;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.KeyManager;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.SSLContextSpi;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.SSLEngine;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.SSLServerSocketFactory;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</div><div class="line"><span class="keyword">import</span> javax.net.ssl.TrustManager;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * OpenSSL-backed SSLContext service provider interface.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenSSLContextImpl</span> <span class="keyword">extends</span> <span class="title">SSLContextSpi</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The default SSLContextImpl for use with</div><div class="line">     * SSLContext.getInstance("Default"). Protected by the</div><div class="line">     * DefaultSSLContextImpl.class monitor.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DefaultSSLContextImpl DEFAULT_SSL_CONTEXT_IMPL;</div><div class="line"></div><div class="line">    <span class="comment">/** TLS algorithm to initialize all sockets. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] algorithms;</div><div class="line"></div><div class="line">    <span class="comment">/** Client session cache. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClientSessionContext clientSessionContext;</div><div class="line"></div><div class="line">    <span class="comment">/** Server session cache. */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerSessionContext serverSessionContext;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> SSLParametersImpl sslParameters;</div><div class="line"></div><div class="line">    <span class="comment">/** Allows outside callers to get the preferred SSLContext. */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OpenSSLContextImpl <span class="title">getPreferred</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TLSv12();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">OpenSSLContextImpl</span><span class="params">(String[] algorithms)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.algorithms = algorithms;</div><div class="line">        clientSessionContext = <span class="keyword">new</span> ClientSessionContext();</div><div class="line">        serverSessionContext = <span class="keyword">new</span> ServerSessionContext();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Constuctor for the DefaultSSLContextImpl.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> dummy is null, used to distinguish this case from the public</div><div class="line">     *            OpenSSLContextImpl() constructor.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">OpenSSLContextImpl</span><span class="params">()</span> <span class="keyword">throws</span> GeneralSecurityException, IOException </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (DefaultSSLContextImpl.class) &#123;</div><div class="line">            <span class="keyword">this</span>.algorithms = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (DEFAULT_SSL_CONTEXT_IMPL == <span class="keyword">null</span>) &#123;</div><div class="line">                clientSessionContext = <span class="keyword">new</span> ClientSessionContext();</div><div class="line">                serverSessionContext = <span class="keyword">new</span> ServerSessionContext();</div><div class="line">                DEFAULT_SSL_CONTEXT_IMPL = (DefaultSSLContextImpl) <span class="keyword">this</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                clientSessionContext = DEFAULT_SSL_CONTEXT_IMPL.engineGetClientSessionContext();</div><div class="line">                serverSessionContext = DEFAULT_SSL_CONTEXT_IMPL.engineGetServerSessionContext();</div><div class="line">            &#125;</div><div class="line">            sslParameters = <span class="keyword">new</span> SSLParametersImpl(DEFAULT_SSL_CONTEXT_IMPL.getKeyManagers(),</div><div class="line">                    DEFAULT_SSL_CONTEXT_IMPL.getTrustManagers(), <span class="keyword">null</span>, clientSessionContext,</div><div class="line">                    serverSessionContext, algorithms);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Initializes this &#123;<span class="doctag">@code</span> SSLContext&#125; instance. All of the arguments are</div><div class="line">     * optional, and the security providers will be searched for the required</div><div class="line">     * implementations of the needed algorithms.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> kms the key sources or &#123;<span class="doctag">@code</span> null&#125;</div><div class="line">     * <span class="doctag">@param</span> tms the trust decision sources or &#123;<span class="doctag">@code</span> null&#125;</div><div class="line">     * <span class="doctag">@param</span> sr the randomness source or &#123;<span class="doctag">@code</span> null&#125;</div><div class="line">     * <span class="doctag">@throws</span> KeyManagementException if initializing this instance fails</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">engineInit</span><span class="params">(KeyManager[] kms, TrustManager[] tms, SecureRandom sr)</span></span></div><div class="line">            <span class="keyword">throws</span> KeyManagementException &#123;</div><div class="line">        sslParameters = <span class="keyword">new</span> SSLParametersImpl(kms, tms, sr, clientSessionContext,</div><div class="line">                serverSessionContext, algorithms);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SSLSocketFactory <span class="title">engineGetSocketFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (sslParameters == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"SSLContext is not initialized."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> Platform.wrapSocketFactoryIfNeeded(<span class="keyword">new</span> OpenSSLSocketFactoryImpl(sslParameters));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>如我们前面讨论，验证服务端证书合法性是 PKI 体系中，保障系统安全极为关键的环节。如果不验证服务端证书的合法性，则即使部署了 HTTPS，HTTPS 也将形同虚设，毫无价值。因而在我们自己实现的 <code>X509TrustManager</code> 中，加载预埋的根证书，并据此验证服务端证书的合法性必不可少，这一检查在 <code>checkServerTrusted()</code> 中完成。然而为了使我们实现的 <code>X509TrustManager</code> 功能更完备，在根据我们预埋的根证书验证失败后，我们再使用系统默认的 <code>X509TrustManager</code> 做验证，像下面这样：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloX509TrustManager</span> <span class="keyword">implements</span> <span class="title">X509TrustManager</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> X509TrustManager mSystemDefaultTrustManager;</div><div class="line">    <span class="keyword">private</span> X509Certificate mCertificate;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HelloX509TrustManager</span><span class="params">()</span> </span>&#123;</div><div class="line">        mCertificate = loadRootCertificate();</div><div class="line">        mSystemDefaultTrustManager = systemDefaultTrustManager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="function">X509Certificate <span class="title">loadRootCertificate</span><span class="params">()</span> </span>&#123;</div><div class="line">        String certName = <span class="string">"netease.crt"</span>;</div><div class="line">        X509Certificate certificate = <span class="keyword">null</span>;</div><div class="line">        InputStream certInput = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            certInput = <span class="keyword">new</span> BufferedInputStream(MainActivity.<span class="keyword">this</span>.getAssets().open(certName));</div><div class="line">            CertificateFactory certificateFactory = CertificateFactory.getInstance(<span class="string">"X.509"</span>);</div><div class="line">            certificate = (X509Certificate) certificateFactory.generateCertPath(certInput).getCertificates().get(<span class="number">0</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (CertificateException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (certInput != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    certInput.close();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> certificate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="function">X509TrustManager <span class="title">systemDefaultTrustManager</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(</div><div class="line">                    TrustManagerFactory.getDefaultAlgorithm());</div><div class="line">            trustManagerFactory.init((KeyStore) <span class="keyword">null</span>);</div><div class="line">            TrustManager[] trustManagers = trustManagerFactory.getTrustManagers();</div><div class="line">            <span class="keyword">if</span> (trustManagers.length != <span class="number">1</span> || !(trustManagers[<span class="number">0</span>] <span class="keyword">instanceof</span> X509TrustManager)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unexpected default trust managers:"</span></div><div class="line">                        + Arrays.toString(trustManagers));</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> (X509TrustManager) trustManagers[<span class="number">0</span>];</div><div class="line">        &#125; <span class="keyword">catch</span> (GeneralSecurityException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(); <span class="comment">// The system has no TLS. Just give up.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">checkClientTrusted</span><span class="params">(X509Certificate[] chain, String authType)</span> <span class="keyword">throws</span> CertificateException </span>&#123;</div><div class="line">        mSystemDefaultTrustManager.checkClientTrusted(chain, authType);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">checkServerTrusted</span><span class="params">(X509Certificate[] chain, String authType)</span> <span class="keyword">throws</span> CertificateException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (X509Certificate certificate : chain) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                certificate.verify(mCertificate.getPublicKey());</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125; <span class="keyword">catch</span> (InvalidKeyException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125; <span class="keyword">catch</span> (NoSuchProviderException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125; <span class="keyword">catch</span> (SignatureException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mSystemDefaultTrustManager.checkServerTrusted(chain, authType);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> X509Certificate[] getAcceptedIssuers() &#123;</div><div class="line">        <span class="function"><span class="keyword">return</span> mSystemDefaultTrustManager.<span class="title">getAcceptedIssuers</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>此外，也可以不自己实现 <code>X509TrustManager</code>，而仅仅修改 <code>X509TrustManager</code> 所用的根证书库，就像下面这样：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> TrustManager[] createX509TrustManager() &#123;</div><div class="line">    CertificateFactory cf = <span class="literal">null</span>;</div><div class="line">    InputStream <span class="keyword">in</span> = <span class="literal">null</span>;</div><div class="line">    TrustManager[] trustManagers = <span class="literal">null</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        cf = CertificateFactory.getInstance(<span class="string">"X.509"</span>);</div><div class="line">        <span class="keyword">in</span> = getAssets().<span class="keyword">open</span>(<span class="string">"ca.crt"</span>);</div><div class="line">        Certificate ca = cf.generateCertificate(<span class="keyword">in</span>);</div><div class="line"></div><div class="line">        KeyStore keystore = KeyStore.getInstance(KeyStore.getDefaultType());</div><div class="line">        keystore.load(<span class="literal">null</span>, <span class="literal">null</span>);</div><div class="line">        keystore.setCertificateEntry(<span class="string">"ca"</span>, ca);</div><div class="line"></div><div class="line">        String tmfAlgorithm = TrustManagerFactory.getDefaultAlgorithm();</div><div class="line">        TrustManagerFactory tmf = TrustManagerFactory.getInstance(tmfAlgorithm);</div><div class="line">        tmf.init(keystore);</div><div class="line"></div><div class="line">        trustManagers = tmf.getTrustManagers();</div><div class="line">    &#125; <span class="keyword">catch</span> (CertificateException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125; <span class="keyword">catch</span> (KeyStoreException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e1) &#123;</div><div class="line">        e1.printStackTrace();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">in</span> != <span class="literal">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">in</span>.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> trustManagers;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>自己实现 <code>X509TrustManager</code> 接口和通过 <code>TrustManagerFactory</code>，仅定制 <code>KeyStore</code> 这两种创建 <code>X509TrustManager</code> 对象的方式，当然是后一种方式更好一些了。如我们前面看到的，系统的 <code>X509TrustManager</code> 实现  <code>RootTrustManager</code> 集成自 <code>X509ExtendedTrustManager</code>，而不是直接实现的 <code>X509TrustManager</code> 接口 。JCA 的接口层也在随着新的安全协议和 SSL 库的发展在不断扩展，在具体的 Java 加密服务实现中，可能会实现并依赖这些扩展的功能，如上面看到的 <code>X509TrustManager</code>，而且加密服务的实现中常常通过反射，来动态依赖一些扩展的接口。因而，自己实现 <code>X509TrustManager</code> 接口时，以及其它加密相关的接口时，如 <code>SSLSocket</code> 等，可能会破坏一些功能。</p>
<p>很多时候可以看到，为了使用私有 CA 签名的证书，而定制域名匹配验证的逻辑，即自己实现 <code>HostnameVerifier</code>。不过通常情况下，网络库都会按照规范对域名与证书的匹配性做严格的检查，因而不是那么地有必要，除非域名证书有什么不那么规范的地方。</p>
<p>关于证书钉扎，在使用私有 CA 签名的证书时，通常似乎也没有那么必要。</p>
<p>参考文章：</p>
<p><a href="http://blog.csdn.net/qq_19822039/article/details/53333512#t9" target="_blank" rel="external">Android https 自定义 证书 问题</a><br><a href="http://blog.csdn.net/whu_zhangmin/article/details/45868057" target="_blank" rel="external">Android实现https网络通信之添加指定信任证书/信任所有证书</a><br><a href="https://help.aliyun.com/document_detail/30143.html?spm=5176.doc30140.2.4.Ek1lPN" target="_blank" rel="external">HTTPS（含SNI）业务场景“IP直连”方案说明</a><br><a href="https://imququ.com/post/http-public-key-pinning.html" target="_blank" rel="external">HTTP Public Key Pinning 介绍</a><br><a href="http://blog.csdn.net/csdnbenbenchong/article/details/7388260" target="_blank" rel="external">Java https请求 HttpsURLConnection</a></p>
<p>Done。</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wxpay.png" alt="Han Pengfei 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Han Pengfei 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android开发/" rel="tag"># Android开发</a>
          
            <a href="/tags/安全/" rel="tag"># 安全</a>
          
            <a href="/tags/HTTPS/" rel="tag"># HTTPS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/12/Networking_optimization_study/" rel="next" title="网络优化实践探索文章">
                <i class="fa fa-chevron-left"></i> 网络优化实践探索文章
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/26/gitlab_trigger_jenkins_build/" rel="prev" title="GitLab 自动触发 Jenkins 构建">
                GitLab 自动触发 Jenkins 构建 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/freesoft.jpg"
                alt="Han Pengfei" />
            
              <p class="site-author-name" itemprop="name">Han Pengfei</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">207</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/hanpfei" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.douban.com/people/3681478/" target="_blank" title="豆瓣"><i class="fa fa-fw fa-globe"></i>豆瓣</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/han-peng-fei-49" target="_blank" title="知乎"><i class="fa fa-fw fa-globe"></i>知乎</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:hanpfei@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Android-的根证书管理"><span class="nav-number">1.</span> <span class="nav-text">Android 的根证书管理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#证书链合法性验证"><span class="nav-number">2.</span> <span class="nav-text">证书链合法性验证</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TrustManager-的查找"><span class="nav-number">3.</span> <span class="nav-text">TrustManager 的查找</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#私有-CA-签名证书的应用"><span class="nav-number">4.</span> <span class="nav-text">私有 CA 签名证书的应用</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016.09.16 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Han Pengfei</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.3"></script>



  



	





  





  









<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 's9sbM9ODdusCzKcm5JcIj6t8-gzGzoHsz',
    appKey: 'UoO9ia1DLNwOXRUsTBQ6QXxm',
    placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true,
    lang: '' || 'zh-cn'
  });
</script>


  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

</body>
</html>
