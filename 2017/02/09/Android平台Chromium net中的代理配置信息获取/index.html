<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Android平台Chromium net中的代理配置信息获取 | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android平台Chromium net中的代理配置信息获取</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Android平台Chromium net中的代理配置信息获取</h1><div class="post-meta">Feb 9, 2017<span> | </span><span class="category"><a href="/categories/网络协议/">网络协议</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/02/09/Android平台Chromium net中的代理配置信息获取/" href="/2017/02/09/Android平台Chromium net中的代理配置信息获取/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>在计算机网络中，<strong><em>代理服务器</em></strong> 扮演着发起请求的客户端与服务器之间的中间人的角色。客户端连接到代理服务器，请求一些服务，比如文件，网页，或其它可以从服务器获得的资源，代理服务器以简化和控制复杂度的形式获取请求的响应。代理被发明以为分布式系统添加结构和封装。<br><a id="more"></a><br>在我们做移动端开发时，代理常常可以作为我们网络调试的利器。然而我们设置的代理究竟是如何对网络访问的整个过程产生影响的呢？本文将尝试回答这个问题。</p>
<h1 id="系统静态代理服务器信息的解析"><a href="#系统静态代理服务器信息的解析" class="headerlink" title="系统静态代理服务器信息的解析"></a>系统静态代理服务器信息的解析</h1><p>一个HTTP请求的执行过程，大体为：</p>
<ol>
<li>连接准备。</li>
<li>建立TCP连接。</li>
<li>如果是HTTPS的话，完成SSL/TLS的握手。</li>
<li>如果是HTTP2的话，在SSL/TLS握手完成之后，执行HTTP2的协商。</li>
<li>发送请求。</li>
<li>获取响应。</li>
<li>结束请求，关闭连接。</li>
</ol>
<p>与代理相关的处理，主要发生在上面的连接准备与连接建立阶段，这主要包括解析系统中保存的静态代理服务器设置信息，以及以特有的方式建立与代理之间的连接。</p>
<p>Chromium net在 <strong><em>HttpStreamFactoryImpl::Job::DoLoop(int result)</em></strong> 中执行解析代理信息、建立连接、处理TLS握手/HTTP2握手/QUIC握手，并创建Stream的过程：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> <span class="string">HttpStreamFactoryImpl:</span>:<span class="string">Job:</span>:DoLoop(<span class="keyword">int</span> result) &#123;</div><div class="line">  DCHECK_NE(next_state_, STATE_NONE);</div><div class="line">  <span class="keyword">int</span> rv = result;</div><div class="line">  do &#123;</div><div class="line">    State state = next_state_;</div><div class="line">    next_state_ = STATE_NONE;</div><div class="line">    <span class="keyword">switch</span> (state) &#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_START:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoStart();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_RESOLVE_PROXY:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoResolveProxy();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_RESOLVE_PROXY_COMPLETE:</span></div><div class="line">        rv = DoResolveProxyComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_WAIT:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoWait();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_WAIT_COMPLETE:</span></div><div class="line">        rv = DoWaitComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_INIT_CONNECTION:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoInitConnection();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_INIT_CONNECTION_COMPLETE:</span></div><div class="line">        rv = DoInitConnectionComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_WAITING_USER_ACTION:</span></div><div class="line">        rv = DoWaitingUserAction(rv);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_RESTART_TUNNEL_AUTH:</span></div><div class="line">        DCHECK_EQ(OK, rv);</div><div class="line">        rv = DoRestartTunnelAuth();</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">STATE_RESTART_TUNNEL_AUTH_COMPLETE:</span></div><div class="line">        rv = DoRestartTunnelAuthComplete(rv);</div><div class="line">        <span class="keyword">break</span>;</div></pre></td></tr></table></figure></p>
<p>具体到系统静态代理服务器设置信息的解析，<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> HttpStreamFactoryImpl::Job::DoResolveProxy() &#123;</div><div class="line">  DCHECK(!pac_request_);</div><div class="line">  DCHECK(session_);</div><div class="line"></div><div class="line">  next_state_ = STATE_RESOLVE_PROXY_COMPLETE;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (request_info_.load_flags &amp; LOAD_BYPASS_PROXY) &#123;</div><div class="line">    proxy_info_.UseDirect();</div><div class="line">    <span class="keyword">return</span> OK;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// TODO(rch): remove this code since Alt-Svc seems to prohibit it.</span></div><div class="line">  GURL url_for_proxy = origin_url_;</div><div class="line"></div><div class="line">  <span class="comment">// For SPDY via Alt-Svc, set |alternative_service_url_| to</span></div><div class="line">  <span class="comment">// https://&lt;alternative host&gt;:&lt;alternative port&gt;/...</span></div><div class="line">  <span class="comment">// so the proxy resolution works with the actual destination, and so</span></div><div class="line">  <span class="comment">// that the correct socket pool is used.</span></div><div class="line">  <span class="keyword">if</span> (IsSpdyAlternative()) &#123;</div><div class="line">    <span class="comment">// TODO(rch):  Figure out how to make QUIC iteract with PAC</span></div><div class="line">    <span class="comment">// scripts.  By not re-writing the URL, we will query the PAC script</span></div><div class="line">    <span class="comment">// for the proxy to use to reach the original URL via TCP.  But</span></div><div class="line">    <span class="comment">// the alternate request will be going via UDP to a different port.</span></div><div class="line">    GURL::Replacements replacements;</div><div class="line">    <span class="comment">// new_port needs to be in scope here because GURL::Replacements references</span></div><div class="line">    <span class="comment">// the memory contained by it directly.</span></div><div class="line">    <span class="keyword">const</span> std::string new_port = base::UintToString(alternative_service_.port);</div><div class="line">    replacements.SetSchemeStr(<span class="string">"https"</span>);</div><div class="line">    replacements.SetPortStr(new_port);</div><div class="line">    url_for_proxy = url_for_proxy.ReplaceComponents(replacements);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> session_-&gt;proxy_service()-&gt;ResolveProxy(</div><div class="line">      url_for_proxy, request_info_.method, &amp;proxy_info_, io_callback_,</div><div class="line">      &amp;pac_request_, session_-&gt;params().proxy_delegate, net_log_);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> HttpStreamFactoryImpl::Job::DoResolveProxyComplete(<span class="keyword">int</span> result) &#123;</div><div class="line">  pac_request_ = <span class="keyword">NULL</span>;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (result == OK) &#123;</div><div class="line">    <span class="comment">// Remove unsupported proxies from the list.</span></div><div class="line">    <span class="keyword">int</span> supported_proxies =</div><div class="line">        ProxyServer::SCHEME_DIRECT | ProxyServer::SCHEME_HTTP |</div><div class="line">        ProxyServer::SCHEME_HTTPS | ProxyServer::SCHEME_SOCKS4 |</div><div class="line">        ProxyServer::SCHEME_SOCKS5;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (session_-&gt;params().enable_quic)</div><div class="line">      supported_proxies |= ProxyServer::SCHEME_QUIC;</div><div class="line"></div><div class="line">    proxy_info_.RemoveProxiesWithoutScheme(supported_proxies);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (proxy_info_.is_empty()) &#123;</div><div class="line">      <span class="comment">// No proxies/direct to choose from. This happens when we don't support</span></div><div class="line">      <span class="comment">// any of the proxies in the returned list.</span></div><div class="line">      result = ERR_NO_SUPPORTED_PROXIES;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (using_quic_ &amp;&amp;</div><div class="line">               (!proxy_info_.is_quic() &amp;&amp; !proxy_info_.is_direct())) &#123;</div><div class="line">      <span class="comment">// QUIC can not be spoken to non-QUIC proxies.  This error should not be</span></div><div class="line">      <span class="comment">// user visible, because the non-alternative Job should be resumed.</span></div><div class="line">      result = ERR_NO_SUPPORTED_PROXIES;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (result != OK) &#123;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  next_state_ = STATE_WAIT;</div><div class="line">  <span class="keyword">return</span> OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Chromium net在对请求的代理的处理上比较灵活，它允许为请求设置一个标记 LOAD_BYPASS_PROXY ，以使该请求的执行总是绕过代理。在<code>HttpStreamFactoryImpl::Job::DoResolveProxy()</code> 中会首先检查请求是否设置了这个标记，若设置，则将与服务器直连而立即返回，不再执行后面解析系统代理服务器设置系统的过程。否则继续执行。</p>
<p>对于代理的使用，用户通常都可以设置一些规则，比如代理的类型，比如对设置对某些域名的访问不使用代理等等。因而对于适当的代理的选择，是根据设置的规则和要访问的URL进行的。Alternative-Service是一种用于支持新协议，比如HTTP2，SPDY和QUIC这种，的机制。这种机制通过服务器向客户端返回一个 “Alt-Svc” 头部字段以表明服务器期望客户端采用的新协议。如果要使用新协议，则发送请求的URL可能会有一定的改变。在<code>HttpStreamFactoryImpl::Job::DoResolveProxy()</code> 中，若要使用 “Alt-Svc” SPDY/HTTP2，会先对原始的Url做一定的修饰，并以修饰后的Url为基础去选择代理。</p>
<p>最后通过ProxyService解析代理信息，选择代理服务器。</p>
<p>解析代理之后，执行的<code>HttpStreamFactoryImpl::Job::DoResolveProxyComplete()</code> 主要是对解析的结果做检查。在这里会过滤掉不支持的代理，并返回最终的检查结果。为了保持处理逻辑的简便统一，即使没有设置任何代理服务器，解析的代理服务器列表也不会是空的，而是包含一个类型为DIRECT的代理设置。</p>
<h1 id="默认的ProxyService"><a href="#默认的ProxyService" class="headerlink" title="默认的ProxyService"></a>默认的ProxyService</h1><p><code>HttpStreamFactoryImpl::Job::DoResolveProxy()</code> 所用到的 <code>ProxyService</code> 来自于<code>HttpNetworkSession</code>。而 <code>HttpNetworkSession</code> 的 <code>ProxyService</code> 则是通过如下过程一步一步从 <code>URLRequestContextBuilder</code> 传过来的：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">HttpStreamFactoryImpl<span class="type">::Job</span><span class="type">::Job</span>()</div><div class="line">&lt;- DefaultJobFactory<span class="type">::CreateJob</span>() </div><div class="line">&lt;- HttpStreamFactoryImpl<span class="type">::HttpStreamFactoryImpl</span>()</div><div class="line">&lt;- HttpNetworkSession<span class="type">::HttpNetworkSession</span>(const <span class="keyword">Params</span>&amp; <span class="keyword">params</span>)</div><div class="line">&lt;- URLRequestContextBuilder<span class="type">::Build</span>()</div></pre></td></tr></table></figure>
<p>在 <code>URLRequestContextBuilder::Build()</code> 中可以看到如下的几行代码：<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">void URLRequestContextBuilder::SetHttpNetworkSessionComponents(</div><div class="line">    const URLRequestContext* context,</div><div class="line">    HttpNetworkSession::Params* params) &#123;</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">host_resolver</span> = context-&gt;</span>host_resolver();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">cert_verifier</span> = context-&gt;</span>cert_verifier();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">transport_security_state</span> = context-&gt;</span>transport_security_state();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">cert_transparency_verifier</span> = context-&gt;</span>cert_transparency_verifier();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">ct_policy_enforcer</span> = context-&gt;</span>ct_policy_enforcer();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">proxy_service</span> = context-&gt;</span>proxy_service();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">ssl_config_service</span> = context-&gt;</span>ssl_config_service();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">http_auth_handler_factory</span> = context-&gt;</span>http_auth_handler_factory();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">http_server_properties</span> = context-&gt;</span>http_server_properties();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">net_log</span> = context-&gt;</span>net_log();</div><div class="line">  <span class="function"><span class="title">params</span>-&gt;</span><span class="function"><span class="title">channel_id_service</span> = context-&gt;</span>channel_id_service();</div><div class="line">&#125;</div><div class="line">. . . . . .</div><div class="line">std::unique_ptr&lt;URLRequestContext&gt; URLRequestContextBuilder::Build() &#123;</div><div class="line">  std::unique_ptr&lt;ContainerURLRequestContext&gt; context(</div><div class="line">      new ContainerURLRequestContext(file_task_runner_));</div><div class="line">  URLR<span class="function"><span class="title">equestContextStorage</span>* storage = context-&gt;</span>storage();</div><div class="line">. . . . . .</div><div class="line">  <span class="keyword">if</span> (!proxy_service_) &#123;</div><div class="line">    <span class="comment">// TODO(willchan): Switch to using this code when</span></div><div class="line">    <span class="comment">// ProxyService::CreateSystemProxyConfigService()'s signature doesn't suck.</span></div><div class="line">#<span class="keyword">if</span> !defined(OS_LINUX) &amp;&amp; !defined(OS_ANDROID)</div><div class="line">    <span class="keyword">if</span> (!proxy_config_service_) &#123;</div><div class="line">      proxy_config_service_ = ProxyService::CreateSystemProxyConfigService(</div><div class="line">          base::ThreadTaskRunnerHandle::Get().get(),</div><div class="line">          <span class="function"><span class="title">context</span>-&gt;</span>GetFileTaskRunner());</div><div class="line">    &#125;</div><div class="line">#endif  <span class="comment">// !defined(OS_LINUX) &amp;&amp; !defined(OS_ANDROID)</span></div><div class="line">    proxy_service_ = ProxyService::CreateUsingSystemProxyResolver(</div><div class="line">        std::move(proxy_config_service_),</div><div class="line">        <span class="number">0</span>,  <span class="comment">// This results in using the default value.</span></div><div class="line">        <span class="function"><span class="title">context</span>-&gt;</span>net_log());</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="title">storage</span>-&gt;</span>set_proxy_service(std::move(proxy_service_));</div></pre></td></tr></table></figure></p>
<p>然而，对于Android而言，使用的并不是这里创建的  <code>ProxyService</code> 。<code>ProxyConfigService</code> 和 <code>ProxyService</code> 都是在更早的时候创建的。<code>ProxyConfigService</code> 创建的位置 (components/cronet/android/cronet_url_request_context_adapter.cc) 如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CronetURLRequestContextAdapter::InitRequestContextOnMainThread(</div><div class="line">    JNIEnv* env,</div><div class="line">    <span class="keyword">const</span> JavaParamRef&lt;jobject&gt;&amp; jcaller) &#123;</div><div class="line">  base::android::ScopedJavaGlobalRef&lt;jobject&gt; jcaller_ref;</div><div class="line">  jcaller_ref.Reset(env, jcaller);</div><div class="line">  proxy_config_service_ = net::ProxyService::CreateSystemProxyConfigService(</div><div class="line">      GetNetworkTaskRunner(), <span class="literal">nullptr</span> <span class="comment">/* Ignored on Android */</span>);</div><div class="line">  net::ProxyConfigServiceAndroid* android_proxy_config_service =</div><div class="line">      <span class="keyword">static_cast</span>&lt;net::ProxyConfigServiceAndroid*&gt;(proxy_config_service_.get());</div><div class="line">  <span class="comment">// If a PAC URL is present, ignore it and use the address and port of</span></div><div class="line">  <span class="comment">// Android system's local HTTP proxy server. See: crbug.com/432539.</span></div><div class="line">  <span class="comment">// TODO(csharrison) Architect the wrapper better so we don't need to cast for</span></div><div class="line">  <span class="comment">// android ProxyConfigServices.</span></div><div class="line">  android_proxy_config_service-&gt;set_exclude_pac_url(<span class="literal">true</span>);</div><div class="line">  g_net_log.Get().EnsureInitializedOnMainThread();</div><div class="line">  GetNetworkTaskRunner()-&gt;PostTask(</div><div class="line">      FROM_HERE,</div><div class="line">      base::Bind(&amp;CronetURLRequestContextAdapter::InitializeOnNetworkThread,</div><div class="line">                 base::Unretained(<span class="keyword">this</span>), base::Passed(&amp;context_config_),</div><div class="line">                 jcaller_ref));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而  <code>ProxyService</code> 的创建位置 (components/cronet/android/cronet_url_request_context_adapter.cc) 则在 <code>CronetURLRequestContextAdapter::InitializeOnNetworkThread()</code>：<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="literal">void</span> CronetURLRequestContextAdapter::InitializeOnNetworkThread(</div><div class="line">    std::unique_ptr&lt;URLRequestContextConfig&gt; config,</div><div class="line">    <span class="keyword">const</span> base::android::ScopedJavaGlobalRef&lt;jobject&gt;&amp;</div><div class="line">        jcronet_url_request_context) &#123;</div><div class="line">  DCHECK<span class="function"><span class="params">(GetNetworkTaskRunner()-&gt;BelongsToCurrentThread())</span>;</span></div><div class="line">  <span class="title">DCHECK</span><span class="params">(!is_context_initialized_)</span>;</div><div class="line">  <span class="title">DCHECK</span><span class="params">(proxy_config_service_)</span>;</div><div class="line">  // <span class="title">TODO</span><span class="params">(mmenke)</span>:  <span class="title">Add</span> <span class="title">method</span> <span class="title">to</span> <span class="title">have</span> <span class="title">the</span> <span class="title">builder</span> <span class="title">enable</span> <span class="title">SPDY</span>.</div><div class="line">  <span class="title">net</span>::<span class="title">URLRequestContextBuilder</span> <span class="title">context_builder</span>;</div><div class="line"></div><div class="line">  <span class="title">std</span>::<span class="title">unique_ptr</span>&lt;<span class="title">net</span>::<span class="title">NetworkDelegate</span>&gt; <span class="title">network_delegate</span><span class="params">(</span></div><div class="line">      <span class="keyword">new</span> BasicNetworkDelegate());</div><div class="line">#<span class="title">if</span> <span class="title">defined</span><span class="params">(DATA_REDUCTION_PROXY_SUPPORT)</span></div><div class="line">. . . . . .</div><div class="line">#<span class="title">endif</span>  // <span class="title">defined</span><span class="params">(DATA_REDUCTION_PROXY_SUPPORT)</span></div><div class="line">  <span class="title">context_builder</span>.<span class="title">set_network_delegate</span><span class="params">(std::move(network_delegate))</span>;</div><div class="line">  <span class="title">context_builder</span>.<span class="title">set_net_log</span><span class="params">(g_net_log.Get().net_log())</span>;</div><div class="line"></div><div class="line">  // <span class="title">Android</span> <span class="title">provides</span> <span class="title">a</span> <span class="title">local</span> <span class="title">HTTP</span> <span class="title">proxy</span> <span class="title">server</span> <span class="title">that</span> <span class="title">handles</span> <span class="title">proxying</span> <span class="title">when</span> <span class="title">a</span> <span class="title">PAC</span></div><div class="line">  // <span class="title">URL</span> <span class="title">is</span> <span class="title">present</span>. <span class="title">Create</span> <span class="title">a</span> <span class="title">proxy</span> <span class="title">service</span> <span class="title">without</span> <span class="title">a</span> <span class="title">resolver</span> <span class="title">and</span> <span class="title">rely</span> <span class="title">on</span> <span class="title">this</span></div><div class="line">  // <span class="title">local</span> <span class="title">HTTP</span> <span class="title">proxy</span>. <span class="title">See</span>: <span class="title">crbug</span>.<span class="title">com</span>/432539.</div><div class="line">  <span class="title">context_builder</span>.<span class="title">set_proxy_service</span><span class="params">(</span></div><div class="line">      net::ProxyService::CreateWithoutProxyResolver(</div><div class="line">          std::move(proxy_config_service_), g_net_log.Get().net_log()));</div></pre></td></tr></table></figure></p>
<p><code>ProxyConfigService</code> 和 <code>ProxyService</code> 的实际创建过程（位于net/proxy/proxy_service.cc ）如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// static</span></div><div class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ProxyService&gt; ProxyService::CreateWithoutProxyResolver(</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ProxyConfigService&gt; proxy_config_service,</div><div class="line">    NetLog* net_log) &#123;</div><div class="line">  <span class="keyword">return</span> base::WrapUnique(<span class="keyword">new</span> ProxyService(</div><div class="line">      <span class="built_in">std</span>::move(proxy_config_service),</div><div class="line">      base::WrapUnique(<span class="keyword">new</span> ProxyResolverFactoryForNullResolver), net_log));</div><div class="line">&#125;</div><div class="line">. . . . . .</div><div class="line"><span class="comment">// static</span></div><div class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ProxyConfigService&gt;</div><div class="line">ProxyService::CreateSystemProxyConfigService(</div><div class="line">    <span class="keyword">const</span> scoped_refptr&lt;base::SingleThreadTaskRunner&gt;&amp; io_task_runner,</div><div class="line">    <span class="keyword">const</span> scoped_refptr&lt;base::SingleThreadTaskRunner&gt;&amp; file_task_runner) &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></div><div class="line">. . . . . .</div><div class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(OS_ANDROID)</span></div><div class="line">  <span class="keyword">return</span> base::WrapUnique(<span class="keyword">new</span> ProxyConfigServiceAndroid(</div><div class="line">      io_task_runner, base::ThreadTaskRunnerHandle::Get()));</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">  LOG(WARNING) &lt;&lt; <span class="string">"Failed to choose a system proxy settings fetcher "</span></div><div class="line">                  <span class="string">"for this platform."</span>;</div><div class="line">  <span class="keyword">return</span> base::WrapUnique(<span class="keyword">new</span> ProxyConfigServiceDirect());</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可见在Android平台，默认的<code>ProxyConfigService</code> 为 <code>ProxyConfigServiceAndroid</code>， <code>ProxyService</code> 本身并不单单是接口，它在解析代理信息时，除了依赖静态信息外，还会依赖 <code>ProxyResolverFactory</code>  和 <code>ProxyResolver</code> 去获得代理信息。按照设计， <code>ProxyResolver</code> 将会填充用于特定URL的代理的列表。通常的 <code>ProxyResolver</code> 后端都是一个PAC脚本，但也不一定。一个 <code>ProxyResolver</code> 可以在同一时间为多个URL服务。</p>
<p>而在Android平台  <code>ProxyResolverFactory</code>  和 <code>ProxyResolver</code> 的实现分别为 <code>ProxyResolverFactoryForNullResolver</code> 和 <code>ProxyResolverNull</code>。可以看一下<code>ProxyResolverFactoryForNullResolver</code> 和 <code>ProxyResolverNull</code>的实现（位于net/proxy/proxy_service.cc ）：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Proxy resolver that fails every time.</span></div><div class="line"><span class="keyword">class</span> ProxyResolverNull : <span class="keyword">public</span> ProxyResolver &#123;</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  ProxyResolverNull() &#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment">// ProxyResolver implementation.</span></div><div class="line">  <span class="function"><span class="keyword">int</span> <span class="title">GetProxyForURL</span><span class="params">(<span class="keyword">const</span> GURL&amp; url,</span></span></div><div class="line">                     ProxyInfo* results,</div><div class="line">                     <span class="keyword">const</span> CompletionCallback&amp; callback,</div><div class="line">                     RequestHandle* request,</div><div class="line">                     <span class="keyword">const</span> BoundNetLog&amp; net_log) override &#123;</div><div class="line">    <span class="keyword">return</span> ERR_NOT_IMPLEMENTED;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">CancelRequest</span><span class="params">(RequestHandle request)</span> override </span>&#123; NOTREACHED(); &#125;</div><div class="line"></div><div class="line">  <span class="function">LoadState <span class="title">GetLoadState</span><span class="params">(RequestHandle request)</span> <span class="keyword">const</span> override </span>&#123;</div><div class="line">    NOTREACHED();</div><div class="line">    <span class="keyword">return</span> LOAD_STATE_IDLE;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;;</div><div class="line">. . . . . .</div><div class="line"><span class="keyword">class</span> ProxyResolverFactoryForNullResolver : <span class="keyword">public</span> ProxyResolverFactory &#123;</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  ProxyResolverFactoryForNullResolver() : ProxyResolverFactory(<span class="literal">false</span>) &#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment">// ProxyResolverFactory overrides.</span></div><div class="line">  <span class="function"><span class="keyword">int</span> <span class="title">CreateProxyResolver</span><span class="params">(</span></span></div><div class="line">      <span class="keyword">const</span> scoped_refptr&lt;ProxyResolverScriptData&gt;&amp; pac_script,</div><div class="line">      <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ProxyResolver&gt;* resolver,</div><div class="line">      <span class="keyword">const</span> net::CompletionCallback&amp; callback,</div><div class="line">      <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Request&gt;* request) override &#123;</div><div class="line">    resolver-&gt;reset(<span class="keyword">new</span> ProxyResolverNull());</div><div class="line">    <span class="keyword">return</span> OK;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"> <span class="keyword">private</span>:</div><div class="line">  DISALLOW_COPY_AND_ASSIGN(ProxyResolverFactoryForNullResolver);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>由此，可以认为在Android平台是没有 <code>ProxyResolver</code> 后端的，也就是代理解析，基本上只依赖系统的静态配置信息。</p>
<h1 id="ProxyService的初始化"><a href="#ProxyService的初始化" class="headerlink" title="ProxyService的初始化"></a>ProxyService的初始化</h1><p>在 <code>ProxyService</code> 创建的时候，会做一些初始化：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">ProxyService::ProxyService(</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ProxyConfigService&gt; config_service,</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ProxyResolverFactory&gt; resolver_factory,</div><div class="line">    NetLog* net_log)</div><div class="line">    : resolver_factory_(<span class="built_in">std</span>::move(resolver_factory)),</div><div class="line">      next_config_id_(<span class="number">1</span>),</div><div class="line">      current_state_(STATE_NONE),</div><div class="line">      net_log_(net_log),</div><div class="line">      stall_proxy_auto_config_delay_(</div><div class="line">          TimeDelta::FromMilliseconds(kDelayAfterNetworkChangesMs)),</div><div class="line">      quick_check_enabled_(<span class="literal">true</span>),</div><div class="line">      sanitize_url_policy_(SanitizeUrlPolicy::SAFE) &#123;</div><div class="line">  NetworkChangeNotifier::AddIPAddressObserver(<span class="keyword">this</span>);</div><div class="line">  NetworkChangeNotifier::AddDNSObserver(<span class="keyword">this</span>);</div><div class="line">  ResetConfigService(<span class="built_in">std</span>::move(config_service));</div><div class="line">&#125;</div><div class="line">. . . . . .</div><div class="line">ProxyService::State ProxyService::ResetProxyConfig(<span class="keyword">bool</span> reset_fetched_config) &#123;</div><div class="line">  DCHECK(CalledOnValidThread());</div><div class="line">  State previous_state = current_state_;</div><div class="line"></div><div class="line">  permanent_error_ = OK;</div><div class="line">  proxy_retry_info_.clear();</div><div class="line">  script_poller_.reset();</div><div class="line">  init_proxy_resolver_.reset();</div><div class="line">  SuspendAllPendingRequests();</div><div class="line">  resolver_.reset();</div><div class="line">  config_ = ProxyConfig();</div><div class="line">  <span class="keyword">if</span> (reset_fetched_config)</div><div class="line">    fetched_config_ = ProxyConfig();</div><div class="line">  current_state_ = STATE_NONE;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> previous_state;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> ProxyService::ResetConfigService(</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ProxyConfigService&gt; new_proxy_config_service) &#123;</div><div class="line">  DCHECK(CalledOnValidThread());</div><div class="line">  State previous_state = ResetProxyConfig(<span class="literal">true</span>);</div><div class="line"></div><div class="line">  <span class="comment">// Release the old configuration service.</span></div><div class="line">  <span class="keyword">if</span> (config_service_.get())</div><div class="line">    config_service_-&gt;RemoveObserver(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">  <span class="comment">// Set the new configuration service.</span></div><div class="line">  config_service_ = <span class="built_in">std</span>::move(new_proxy_config_service);</div><div class="line">  config_service_-&gt;AddObserver(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (previous_state != STATE_NONE)</div><div class="line">    ApplyProxyConfigIfAvailable();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里主要是将 <code>ProxyService</code> 对象注册为网络状态的监听者，以监听IP地址和 DNS 的改变，并注册为 <code>ProxyConfigService</code> 的监听者以监听。由于创建初始，previous_state 为 STATE_NONE，因而并不会做更多别的事情。</p>
<h1 id="ProxyConfigService的初始化"><a href="#ProxyConfigService的初始化" class="headerlink" title="ProxyConfigService的初始化"></a>ProxyConfigService的初始化</h1><p><code>ProxyConfigService</code> 是Android平台中 <code>ProxyService</code> 获取代理配置信息的关键，回头再来看 <code>ProxyConfigService</code> 的创建及初始化过程。如我们前面看到的，创建对象的位置在<code>CronetURLRequestContextAdapter::InitRequestContextOnMainThread()</code>。具体的过程（ 位于net/proxy/proxy_config_service_android.cc ）如下：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">ProxyConfigServiceAndroid:</span><span class="symbol">:ProxyConfigServiceAndroid</span>(</div><div class="line">    const scoped_refptr&lt;<span class="symbol">base:</span><span class="symbol">:SequencedTaskRunner&gt;&amp;</span> network_task_runner,</div><div class="line">    const scoped_refptr&lt;<span class="symbol">base:</span><span class="symbol">:SequencedTaskRunner&gt;&amp;</span> jni_task_runner)</div><div class="line">    : delegate<span class="number">_</span>(new Delegate(</div><div class="line">        network_task_runner, jni_task_runner, <span class="symbol">base:</span><span class="symbol">:Bind</span>(&amp;GetJavaProperty))) &#123;</div><div class="line">  delegate<span class="number">_</span>-&gt;SetupJNI();</div><div class="line">  delegate<span class="number">_</span>-&gt;FetchInitialConfig();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这里主要是创建 <code>ProxyConfigServiceAndroid::Delegate</code>，并做初始化。初始化主要包括 <code>SetupJNI()</code> 和 <code>FetchInitialConfig()</code>，其中 <code>SetupJNI()</code> 是这样的：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class">  <span class="keyword">class</span> <span class="type">JNIDelegateImpl</span> : public <span class="type">ProxyConfigServiceAndroid</span>::<span class="type">JNIDelegate</span> &#123;</span></div><div class="line">   public:</div><div class="line">    explicit <span class="type">JNIDelegateImpl</span>(<span class="type">Delegate</span>* <span class="title">delegate</span>) : delegate_(<span class="title">delegate</span>) &#123;&#125;</div><div class="line">. . . . . .</div><div class="line"><span class="keyword">class</span> <span class="type">ProxyConfigServiceAndroid</span>::<span class="type">Delegate</span></div><div class="line">    : public base::<span class="type">RefCountedThreadSafe</span>&lt;<span class="type">Delegate</span>&gt; &#123;</div><div class="line"> public:</div><div class="line">  <span class="type">Delegate</span>(<span class="title">const</span> <span class="title">scoped_refptr</span>&lt;<span class="title">base</span>::<span class="type">SequencedTaskRunner</span>&gt;&amp; <span class="title">network_task_runner</span>,</div><div class="line">           <span class="title">const</span> <span class="title">scoped_refptr</span>&lt;<span class="title">base</span>::<span class="type">SequencedTaskRunner</span>&gt;&amp; <span class="title">jni_task_runner</span>,</div><div class="line">           <span class="title">const</span> <span class="type">GetPropertyCallback</span>&amp; <span class="title">get_property_callback</span>)</div><div class="line">      : jni_delegate_(<span class="title">this</span>),</div><div class="line">        network_task_runner_(<span class="title">network_task_runner</span>),</div><div class="line">        jni_task_runner_(<span class="title">jni_task_runner</span>),</div><div class="line">        get_property_callback_(<span class="title">get_property_callback</span>),</div><div class="line">        exclude_pac_url_(<span class="title">false</span>) &#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  void <span class="type">SetupJNI</span>() &#123;</div><div class="line">    <span class="type">DCHECK</span>(<span class="type">OnJNIThread</span>());</div><div class="line">    <span class="type">JNIEnv</span>* env = <span class="type">AttachCurrentThread</span>();</div><div class="line">    if (<span class="title">java_proxy_change_listener_</span>.<span class="title">is_null</span>()) &#123;</div><div class="line">      <span class="type">VLOG</span>(1) &lt;&lt; "<span class="type">ProxyConfigServiceAndroid</span>::<span class="type">Delegate</span> <span class="type">SetupJNI</span>, try to create java_proxy_change_listener_ object";</div><div class="line">      java_proxy_change_listener_.<span class="type">Reset</span>(</div><div class="line">          <span class="type">Java_ProxyChangeListener_create</span>(</div><div class="line">              <span class="title">env</span>, <span class="title">base</span>::<span class="title">android</span>::<span class="type">GetApplicationContext</span>()));</div><div class="line">      <span class="type">CHECK</span>(!<span class="title">java_proxy_change_listener_</span>.<span class="title">is_null</span>());</div><div class="line">    &#125;</div><div class="line">    <span class="type">Java_ProxyChangeListener_start</span>(</div><div class="line">        <span class="title">env</span>,</div><div class="line">        <span class="title">java_proxy_change_listener_</span>.<span class="title">obj</span>(),</div><div class="line">        reinterpret_cast&lt;intptr_t&gt;(&amp;<span class="title">jni_delegate_</span>));</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，它主要是创建了一个类型为<code>org.chromium.net.ProxyChangeListener</code> 的Java对象，并调用了该对象的  <code>start(long nativePtr)</code> 方法（ 位于net/android/java/src/org/chromium/net/ProxyChangeListener.java ）。来看这个Java类的实现：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ProxyChangeListener</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        mContext = context;</div><div class="line">    &#125;</div><div class="line">. . . . . .</div><div class="line">    <span class="meta">@CalledByNative</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function">ProxyChangeListener <span class="title">create</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProxyChangeListener(context);</div><div class="line">    &#125;</div><div class="line">. . . . . .</div><div class="line">    <span class="meta">@CalledByNative</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">long</span> nativePtr)</span> </span>&#123;</div><div class="line">        <span class="keyword">assert</span> mNativePtr == <span class="number">0</span>;</div><div class="line">        mNativePtr = nativePtr;</div><div class="line">        registerReceiver();</div><div class="line">    &#125;</div><div class="line">. . . . . .</div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">registerReceiver</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mProxyReceiver != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        IntentFilter filter = <span class="keyword">new</span> IntentFilter();</div><div class="line">        filter.addAction(Proxy.PROXY_CHANGE_ACTION);</div><div class="line">        mProxyReceiver = <span class="keyword">new</span> ProxyReceiver();</div><div class="line">        mContext.getApplicationContext().registerReceiver(mProxyReceiver, filter);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里主要是注册了一个监听 Action 为 <strong>Proxy.PROXY_CHANGE_ACTION</strong> 的 BroadcastReceiver。再来看 <code>FetchInitialConfig()</code>：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Returns whether the provided string was successfully converted to a port.</span></div><div class="line"><span class="keyword">bool</span> ConvertStringToPort(<span class="keyword">const</span> std::string&amp; port, <span class="keyword">int</span>* output) &#123;</div><div class="line">  url::Component component(<span class="number">0</span>, port.size());</div><div class="line">  <span class="keyword">int</span> result = url::ParsePort(port.c_str(), component);</div><div class="line">  <span class="keyword">if</span> (result == url::PORT_INVALID || result == url::PORT_UNSPECIFIED)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  *output = result;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">ProxyServer ConstructProxyServer(ProxyServer::Scheme scheme,</div><div class="line">                                 <span class="keyword">const</span> std::string&amp; proxy_host,</div><div class="line">                                 <span class="keyword">const</span> std::string&amp; proxy_port) &#123;</div><div class="line">  DCHECK(!proxy_host.<span class="keyword">empty</span>());</div><div class="line">  <span class="keyword">int</span> port_as_int = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> (proxy_port.<span class="keyword">empty</span>())</div><div class="line">    port_as_int = ProxyServer::GetDefaultPortForScheme(scheme);</div><div class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (!ConvertStringToPort(proxy_port, &amp;port_as_int))</div><div class="line">    <span class="keyword">return</span> ProxyServer();</div><div class="line">  DCHECK(port_as_int &gt; <span class="number">0</span>);</div><div class="line">  <span class="keyword">return</span> ProxyServer(</div><div class="line">      scheme, HostPortPair(proxy_host, static_cast&lt;uint16_t&gt;(port_as_int)));</div><div class="line">&#125;</div><div class="line"></div><div class="line">ProxyServer LookupProxy(<span class="keyword">const</span> std::string&amp; prefix,</div><div class="line">                        <span class="keyword">const</span> GetPropertyCallback&amp; get_property,</div><div class="line">                        ProxyServer::Scheme scheme) &#123;</div><div class="line">  DCHECK(!prefix.<span class="keyword">empty</span>());</div><div class="line">  std::string proxy_host = get_property.Run(prefix + <span class="string">".proxyHost"</span>);</div><div class="line">  <span class="keyword">if</span> (!proxy_host.<span class="keyword">empty</span>()) &#123;</div><div class="line">    std::string proxy_port = get_property.Run(prefix + <span class="string">".proxyPort"</span>);</div><div class="line">    <span class="keyword">return</span> ConstructProxyServer(scheme, proxy_host, proxy_port);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// Fall back to default proxy, if any.</span></div><div class="line">  proxy_host = get_property.Run(<span class="string">"proxyHost"</span>);</div><div class="line">  <span class="keyword">if</span> (!proxy_host.<span class="keyword">empty</span>()) &#123;</div><div class="line">    std::string proxy_port = get_property.Run(<span class="string">"proxyPort"</span>);</div><div class="line">    <span class="keyword">return</span> ConstructProxyServer(scheme, proxy_host, proxy_port);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> ProxyServer();</div><div class="line">&#125;</div><div class="line"></div><div class="line">ProxyServer LookupSocksProxy(<span class="keyword">const</span> GetPropertyCallback&amp; get_property) &#123;</div><div class="line">  std::string proxy_host = get_property.Run(<span class="string">"socksProxyHost"</span>);</div><div class="line">  <span class="keyword">if</span> (!proxy_host.<span class="keyword">empty</span>()) &#123;</div><div class="line">    std::string proxy_port = get_property.Run(<span class="string">"socksProxyPort"</span>);</div><div class="line">    <span class="keyword">return</span> ConstructProxyServer(ProxyServer::SCHEME_SOCKS5, proxy_host,</div><div class="line">                                proxy_port);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> ProxyServer();</div><div class="line">&#125;</div><div class="line"></div><div class="line">void AddBypassRules(<span class="keyword">const</span> std::string&amp; scheme,</div><div class="line">                    <span class="keyword">const</span> GetPropertyCallback&amp; get_property,</div><div class="line">                    ProxyBypassRules* bypass_rules) &#123;</div><div class="line">  <span class="comment">// The format of a hostname pattern is a list of hostnames that are separated</span></div><div class="line">  <span class="comment">// by | and that use * as a wildcard. For example, setting the</span></div><div class="line">  <span class="comment">// http.nonProxyHosts property to *.android.com|*.kernel.org will cause</span></div><div class="line">  <span class="comment">// requests to http://developer.android.com to be made without a proxy.</span></div><div class="line"></div><div class="line">  std::string non_proxy_hosts =</div><div class="line">      get_property.Run(scheme + <span class="string">".nonProxyHosts"</span>);</div><div class="line">  <span class="keyword">if</span> (non_proxy_hosts.<span class="keyword">empty</span>())</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  base::StringTokenizer tokenizer(non_proxy_hosts, <span class="string">"|"</span>);</div><div class="line">  <span class="keyword">while</span> (tokenizer.GetNext()) &#123;</div><div class="line">    std::string token = tokenizer.token();</div><div class="line">    std::string pattern;</div><div class="line">    base::TrimWhitespaceASCII(token, base::TRIM_ALL, &amp;pattern);</div><div class="line">    <span class="keyword">if</span> (pattern.<span class="keyword">empty</span>())</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line">    <span class="comment">// '?' is not one of the specified pattern characters above.</span></div><div class="line">    DCHECK_EQ(std::string::npos, pattern.find(<span class="string">'?'</span>));</div><div class="line">    bypass_rules-&gt;AddRuleForHostname(scheme, pattern, <span class="number">-1</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Returns true if a valid proxy was found.</span></div><div class="line"><span class="keyword">bool</span> GetProxyRules(<span class="keyword">const</span> GetPropertyCallback&amp; get_property,</div><div class="line">                   ProxyConfig::ProxyRules* rules) &#123;</div><div class="line">  <span class="comment">// See libcore/luni/src/main/java/java/net/ProxySelectorImpl.java for the</span></div><div class="line">  <span class="comment">// mostly equivalent Android implementation.  There is one intentional</span></div><div class="line">  <span class="comment">// difference: by default Chromium uses the HTTP port (80) for HTTPS</span></div><div class="line">  <span class="comment">// connections via proxy.  This default is identical on other platforms.</span></div><div class="line">  <span class="comment">// On the opposite, Java spec suggests to use HTTPS port (443) by default (the</span></div><div class="line">  <span class="comment">// default value of https.proxyPort).</span></div><div class="line">  rules-&gt;type = ProxyConfig::ProxyRules::TYPE_PROXY_PER_SCHEME;</div><div class="line">  rules-&gt;proxies_for_http.SetSingleProxyServer(</div><div class="line">      LookupProxy(<span class="string">"http"</span>, get_property, ProxyServer::SCHEME_HTTP));</div><div class="line">  rules-&gt;proxies_for_https.SetSingleProxyServer(</div><div class="line">      LookupProxy(<span class="string">"https"</span>, get_property, ProxyServer::SCHEME_HTTP));</div><div class="line">  rules-&gt;proxies_for_ftp.SetSingleProxyServer(</div><div class="line">      LookupProxy(<span class="string">"ftp"</span>, get_property, ProxyServer::SCHEME_HTTP));</div><div class="line">  rules-&gt;fallback_proxies.SetSingleProxyServer(LookupSocksProxy(get_property));</div><div class="line">  rules-&gt;bypass_rules.Clear();</div><div class="line">  AddBypassRules(<span class="string">"ftp"</span>, get_property, &amp;rules-&gt;bypass_rules);</div><div class="line">  AddBypassRules(<span class="string">"http"</span>, get_property, &amp;rules-&gt;bypass_rules);</div><div class="line">  AddBypassRules(<span class="string">"https"</span>, get_property, &amp;rules-&gt;bypass_rules);</div><div class="line">  <span class="comment">// We know a proxy was found if not all of the proxy lists are empty.</span></div><div class="line">  <span class="keyword">return</span> !(rules-&gt;proxies_for_http.IsEmpty() &amp;&amp;</div><div class="line">      rules-&gt;proxies_for_https.IsEmpty() &amp;&amp;</div><div class="line">      rules-&gt;proxies_for_ftp.IsEmpty() &amp;&amp;</div><div class="line">      rules-&gt;fallback_proxies.IsEmpty());</div><div class="line">&#125;;</div><div class="line"></div><div class="line">void GetLatestProxyConfigInternal(<span class="keyword">const</span> GetPropertyCallback&amp; get_property,</div><div class="line">                                  ProxyConfig* config) &#123;</div><div class="line">  <span class="keyword">if</span> (!GetProxyRules(get_property, &amp;config-&gt;proxy_rules()))</div><div class="line">    *config = ProxyConfig::CreateDirect();</div><div class="line">&#125;</div><div class="line"></div><div class="line">std::string GetJavaProperty(<span class="keyword">const</span> std::string&amp; property) &#123;</div><div class="line">  <span class="comment">// Use Java System.getProperty to get configuration information.</span></div><div class="line">  <span class="comment">// TODO(pliard): Conversion to/from UTF8 ok here?</span></div><div class="line">  JNIEnv* env = AttachCurrentThread();</div><div class="line">  ScopedJavaLocalRef&lt;jstring&gt; str = ConvertUTF8ToJavaString(env, property);</div><div class="line">  ScopedJavaLocalRef&lt;jstring&gt; result =</div><div class="line">      Java_ProxyChangeListener_getProperty(env, str.obj());</div><div class="line">  <span class="keyword">return</span> result.is_null() ?</div><div class="line">      std::string() : ConvertJavaStringToUTF8(env, result.obj());</div><div class="line">&#125;</div><div class="line">. . . . . .</div><div class="line">  void FetchInitialConfig() &#123;</div><div class="line">    DCHECK(OnJNIThread());</div><div class="line">    ProxyConfig proxy_config;</div><div class="line">    GetLatestProxyConfigInternal(get_property_callback_, &amp;proxy_config);</div><div class="line">    network_task_runner_-&gt;PostTask(</div><div class="line">        FROM_HERE,</div><div class="line">        base::Bind(&amp;Delegate::SetNewConfigOnNetworkThread, this, proxy_config));</div><div class="line">  &#125;</div><div class="line">. . . . . .</div><div class="line">  <span class="comment">// Called on the network thread.</span></div><div class="line">  void SetNewConfigOnNetworkThread(<span class="keyword">const</span> ProxyConfig&amp; proxy_config) &#123;</div><div class="line">    DCHECK(OnNetworkThread());</div><div class="line">    proxy_config_ = proxy_config;</div><div class="line">    FOR_EACH_OBSERVER(Observer, observers_,</div><div class="line">                      OnProxyConfigChanged(proxy_config,</div><div class="line">                                           ProxyConfigService::CONFIG_VALID));</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里做了两件事，一是获取系统的代理配置信息，方法主要还是通过读取系统属性完成；二是通知监听者，这主要是<code>ProxyService</code>。</p>
<p>对于  Action 为 <strong>Proxy.PROXY_CHANGE_ACTION</strong> 的 BroadcastReceiver，是在注册完成之后几乎立即就会得到通知的。ProxyReceiver的实现如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line">private <span class="class"><span class="keyword">class</span> <span class="title">ProxyReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    public <span class="keyword">void</span> onReceive(Context context, Intent intent) &#123;</div><div class="line">        <span class="keyword">if</span> (intent.getAction().equals(Proxy.PROXY_CHANGE_ACTION)) &#123;</div><div class="line">            proxySettingsChanged(extractNewProxy(intent));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Extract a ProxyConfig object from the supplied Intent's extra data</span></div><div class="line">    <span class="comment">// bundle. The android.net.ProxyProperties class is not exported from</span></div><div class="line">    <span class="comment">// the Android SDK, so we have to use reflection to get at it and invoke</span></div><div class="line">    <span class="comment">// methods on it. If we fail, return an empty proxy config (meaning</span></div><div class="line">    <span class="comment">// 'direct').</span></div><div class="line">    <span class="comment">// TODO(sgurun): once android.net.ProxyInfo is public, rewrite this.</span></div><div class="line">    private ProxyConfig extractNewProxy(Intent intent) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">final</span> <span class="built_in">String</span> getHostName = <span class="string">"getHost"</span>;</div><div class="line">            <span class="keyword">final</span> <span class="built_in">String</span> getPortName = <span class="string">"getPort"</span>;</div><div class="line">            <span class="keyword">final</span> <span class="built_in">String</span> getPacFileUrl = <span class="string">"getPacFileUrl"</span>;</div><div class="line">            <span class="keyword">final</span> <span class="built_in">String</span> getExclusionList = <span class="string">"getExclusionList"</span>;</div><div class="line">            <span class="built_in">String</span> className;</div><div class="line">            <span class="built_in">String</span> proxyInfo;</div><div class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP) &#123;</div><div class="line">                className = <span class="string">"android.net.ProxyProperties"</span>;</div><div class="line">                proxyInfo = <span class="string">"proxy"</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                className = <span class="string">"android.net.ProxyInfo"</span>;</div><div class="line">                proxyInfo = <span class="string">"android.intent.extra.PROXY_INFO"</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="built_in">Object</span> props = intent.getExtras().<span class="keyword">get</span>(proxyInfo);</div><div class="line">            <span class="keyword">if</span> (props == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Class&lt;?&gt; cls = Class.forName(className);</div><div class="line">            Method getHostMethod = cls.getDeclaredMethod(getHostName);</div><div class="line">            Method getPortMethod = cls.getDeclaredMethod(getPortName);</div><div class="line">            Method getExclusionListMethod = cls.getDeclaredMethod(getExclusionList);</div><div class="line"></div><div class="line">            <span class="built_in">String</span> host = (<span class="built_in">String</span>) getHostMethod.invoke(props);</div><div class="line">            <span class="built_in">int</span> port = (Integer) getPortMethod.invoke(props);</div><div class="line"></div><div class="line">            <span class="built_in">String</span>[] exclusionList;</div><div class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP) &#123;</div><div class="line">                <span class="built_in">String</span> s = (<span class="built_in">String</span>) getExclusionListMethod.invoke(props);</div><div class="line">                exclusionList = s.split(<span class="string">","</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                exclusionList = (<span class="built_in">String</span>[]) getExclusionListMethod.invoke(props);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// TODO(xunjieli): rewrite this once the API is public.</span></div><div class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT</div><div class="line">                    &amp;&amp; Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP) &#123;</div><div class="line">                Method getPacFileUrlMethod = cls.getDeclaredMethod(getPacFileUrl);</div><div class="line">                <span class="built_in">String</span> pacFileUrl = (<span class="built_in">String</span>) getPacFileUrlMethod.invoke(props);</div><div class="line">                <span class="keyword">if</span> (!TextUtils.isEmpty(pacFileUrl)) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ProxyConfig(host, port, pacFileUrl, exclusionList);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</div><div class="line">                Method getPacFileUrlMethod = cls.getDeclaredMethod(getPacFileUrl);</div><div class="line">                <span class="built_in">Uri</span> pacFileUrl = (<span class="built_in">Uri</span>) getPacFileUrlMethod.invoke(props);</div><div class="line">                <span class="keyword">if</span> (!<span class="built_in">Uri</span>.EMPTY.equals(pacFileUrl)) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ProxyConfig(host, port, pacFileUrl.toString(), exclusionList);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ProxyConfig(host, port, <span class="keyword">null</span>, exclusionList);</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"Using no proxy configuration due to exception:"</span> + ex);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"Using no proxy configuration due to exception:"</span> + ex);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"Using no proxy configuration due to exception:"</span> + ex);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"Using no proxy configuration due to exception:"</span> + ex);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (NullPointerException ex) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"Using no proxy configuration due to exception:"</span> + ex);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">private <span class="keyword">void</span> proxySettingsChanged(ProxyConfig cfg) &#123;</div><div class="line">    <span class="keyword">if</span> (!sEnabled) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mDelegate != <span class="keyword">null</span>) &#123;</div><div class="line">        mDelegate.proxySettingsChanged();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mNativePtr == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Note that this code currently runs on a MESSAGE_LOOP_UI thread, but</span></div><div class="line">    <span class="comment">// the C++ code must run the callbacks on the network thread.</span></div><div class="line">    <span class="keyword">if</span> (cfg != <span class="keyword">null</span>) &#123;</div><div class="line">        nativeProxySettingsChangedTo(mNativePtr, cfg.mHost, cfg.mPort, cfg.mPacUrl,</div><div class="line">                cfg.mExclusionList);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        nativeProxySettingsChanged(mNativePtr);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个Receiver在收到通知后，会将代理信息传递到C/C++层。最终调用<code>ProxyConfigServiceAndroid::Delegate::JNIDelegateImpl</code>：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">// ProxyConfigServiceAndroid::JNIDelegate overrides.</span></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">ProxySettingsChangedTo</span><span class="params">(</span></span></div><div class="line">      JNIEnv* env,</div><div class="line">      <span class="keyword">const</span> JavaParamRef&lt;jobject&gt;&amp; jself,</div><div class="line">      <span class="keyword">const</span> JavaParamRef&lt;jstring&gt;&amp; jhost,</div><div class="line">      jint jport,</div><div class="line">      <span class="keyword">const</span> JavaParamRef&lt;jstring&gt;&amp; jpac_url,</div><div class="line">      <span class="keyword">const</span> JavaParamRef&lt;jobjectArray&gt;&amp; jexclusion_list) override &#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> host = ConvertJavaStringToUTF8(env, jhost);</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> pac_url;</div><div class="line">    <span class="keyword">if</span> (jpac_url)</div><div class="line">      ConvertJavaStringToUTF8(env, jpac_url, &amp;pac_url);</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; exclusion_list;</div><div class="line">    base::android::AppendJavaStringArrayToStringVector(</div><div class="line">        env, jexclusion_list, &amp;exclusion_list);</div><div class="line">    delegate_-&gt;ProxySettingsChangedTo(host, jport, pac_url, exclusion_list);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">ProxySettingsChanged</span><span class="params">(JNIEnv* env,</span></span></div><div class="line">                            <span class="keyword">const</span> JavaParamRef&lt;jobject&gt;&amp; self) override &#123;</div><div class="line">    delegate_-&gt;ProxySettingsChanged();</div><div class="line">  &#125;</div><div class="line"></div><div class="line"> <span class="keyword">private</span>:</div><div class="line">  Delegate* <span class="keyword">const</span> delegate_;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>继而调用 <code>ProxyConfigServiceAndroid::Delegate</code> 的相应方法：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CreateStaticProxyConfig</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; host,</span></span></div><div class="line">                             <span class="keyword">int</span> port,</div><div class="line">                             <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; pac_url,</div><div class="line">                             <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; exclusion_list,</div><div class="line">                             ProxyConfig* config) &#123;</div><div class="line">  <span class="keyword">if</span> (!pac_url.empty()) &#123;</div><div class="line">    config-&gt;set_pac_url(GURL(pac_url));</div><div class="line">    config-&gt;set_pac_mandatory(<span class="literal">false</span>);</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (port != <span class="number">0</span>) &#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> rules = base::StringPrintf(<span class="string">"%s:%d"</span>, host.c_str(), port);</div><div class="line">    config-&gt;proxy_rules().ParseFromString(rules);</div><div class="line">    config-&gt;proxy_rules().bypass_rules.Clear();</div><div class="line"></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;::const_iterator it;</div><div class="line">    <span class="keyword">for</span> (it = exclusion_list.begin(); it != exclusion_list.end(); ++it) &#123;</div><div class="line">      <span class="built_in">std</span>::<span class="built_in">string</span> pattern;</div><div class="line">      base::TrimWhitespaceASCII(*it, base::TRIM_ALL, &amp;pattern);</div><div class="line">      <span class="keyword">if</span> (pattern.empty())</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">      config-&gt;proxy_rules().bypass_rules.AddRuleForHostname(<span class="string">""</span>, pattern, <span class="number">-1</span>);</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    *config = ProxyConfig::CreateDirect();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">. . . . . .</div><div class="line">  <span class="comment">// Called on the JNI thread.</span></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">ProxySettingsChanged</span><span class="params">()</span> </span>&#123;</div><div class="line">    DCHECK(OnJNIThread());</div><div class="line">    ProxyConfig proxy_config;</div><div class="line">    GetLatestProxyConfigInternal(get_property_callback_, &amp;proxy_config);</div><div class="line">    network_task_runner_-&gt;PostTask(</div><div class="line">        FROM_HERE,</div><div class="line">        base::Bind(</div><div class="line">            &amp;Delegate::SetNewConfigOnNetworkThread, <span class="keyword">this</span>, proxy_config));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Called on the JNI thread.</span></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">ProxySettingsChangedTo</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; host,</span></span></div><div class="line">                              <span class="keyword">int</span> port,</div><div class="line">                              <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; pac_url,</div><div class="line">                              <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; exclusion_list) &#123;</div><div class="line">    DCHECK(OnJNIThread());</div><div class="line">    ProxyConfig proxy_config;</div><div class="line">    <span class="keyword">if</span> (exclude_pac_url_) &#123;</div><div class="line">      CreateStaticProxyConfig(host, port, <span class="string">""</span>, exclusion_list, &amp;proxy_config);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      CreateStaticProxyConfig(host, port, pac_url, exclusion_list,</div><div class="line">          &amp;proxy_config);</div><div class="line">    &#125;</div><div class="line">    network_task_runner_-&gt;PostTask(</div><div class="line">        FROM_HERE,</div><div class="line">        base::Bind(</div><div class="line">            &amp;Delegate::SetNewConfigOnNetworkThread, <span class="keyword">this</span>, proxy_config));</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p><code>ProxySettingsChanged()</code>如同 <code>FetchInitialConfig()</code> 一样，是从system property中获取代理配置信息，并通知监听者。而 <code>ProxySettingsChangedTo()</code> 则是以传入的代理配置信息构造配置，并通知监听者。</p>
<p>可见，<code>BroadcastReceiver</code> 通知时的这次配置信息更新会冲掉最初通过 <code>FetchInitialConfig()</code> 获取的那些。</p>
<p>总结一下，在Android中，chromium net获取代理配置信息的方法是：</p>
<ol>
<li>在 <code>ProxyConfigServiceAndroid</code> 创建过程中，从system property中读取代理设置信息，同时注册BroadcastReceiver以监听系统代理配置的改变。</li>
<li>在收到系统广播消息的通知时，若广播中包含详细的代理配置信息，则以这些信息更新Chromium net的代理设置；否则，再次读取system property获取代理配置信息。</li>
</ol>
<h1 id="代理解析"><a href="#代理解析" class="headerlink" title="代理解析"></a>代理解析</h1><p><code>ProxyConfigService</code> 在代理配置发生改变时，会将新的代理配置通知给<code>ProxyService</code>：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line">void ProxyService::SetReady() &#123;</div><div class="line">  DCHECK(!init_proxy_resolver_.get());</div><div class="line">  current_state_ = STATE_READY;</div><div class="line"></div><div class="line">  <span class="comment">// Make a copy in case |this| is deleted during the synchronous completion</span></div><div class="line">  <span class="comment">// of one of the requests. If |this| is deleted then all of the PacRequest</span></div><div class="line">  <span class="comment">// instances will be Cancel()-ed.</span></div><div class="line">  PendingRequests pending_copy = pending_requests_;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (PendingRequests::iterator it = pending_copy.begin();</div><div class="line">       it != pending_copy.end();</div><div class="line">       ++it) &#123;</div><div class="line">    PacRequest* req = it-&gt;get();</div><div class="line">    <span class="keyword">if</span> (!req-&gt;is_started() &amp;&amp; !req-&gt;was_cancelled()) &#123;</div><div class="line">      req-&gt;net_log()-&gt;EndEvent(NetLog::TYPE_PROXY_SERVICE_WAITING_FOR_INIT_PAC);</div><div class="line"></div><div class="line">      <span class="comment">// Note that we re-check for synchronous completion, in case we are</span></div><div class="line">      <span class="comment">// no longer using a ProxyResolver (can happen if we fell-back to manual).</span></div><div class="line">      req-&gt;StartAndCompleteCheckingForSynchronous();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">. . . . . .</div><div class="line">void ProxyService::OnProxyConfigChanged(</div><div class="line">    <span class="keyword">const</span> ProxyConfig&amp; config,</div><div class="line">    ProxyConfigService::ConfigAvailability availability) &#123;</div><div class="line">  <span class="comment">// Retrieve the current proxy configuration from the ProxyConfigService.</span></div><div class="line">  <span class="comment">// If a configuration is not available yet, we will get called back later</span></div><div class="line">  <span class="comment">// by our ProxyConfigService::Observer once it changes.</span></div><div class="line">  ProxyConfig effective_config;</div><div class="line">  <span class="keyword">switch</span> (availability) &#123;</div><div class="line">    <span class="keyword">case</span> ProxyConfigService::CONFIG_PENDING:</div><div class="line">      <span class="comment">// ProxyConfigService implementors should never pass CONFIG_PENDING.</span></div><div class="line">      NOTREACHED() &lt;&lt; <span class="string">"Proxy config change with CONFIG_PENDING availability!"</span>;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">case</span> ProxyConfigService::CONFIG_VALID:</div><div class="line">      effective_config = config;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> ProxyConfigService::CONFIG_UNSET:</div><div class="line">      effective_config = ProxyConfig::CreateDirect();</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Emit the proxy settings change to the NetLog stream.</span></div><div class="line">  <span class="keyword">if</span> (net_log_) &#123;</div><div class="line">    net_log_-&gt;AddGlobalEntry(NetLog::TYPE_PROXY_CONFIG_CHANGED,</div><div class="line">                             base::Bind(&amp;NetLogProxyConfigChangedCallback,</div><div class="line">                                        &amp;fetched_config_, &amp;effective_config));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Set the new configuration as the most recently fetched one.</span></div><div class="line">  fetched_config_ = effective_config;</div><div class="line">  fetched_config_.set_id(<span class="number">1</span>);  <span class="comment">// Needed for a later DCHECK of is_valid().</span></div><div class="line"></div><div class="line">  InitializeUsingLastFetchedConfig();</div><div class="line">&#125;</div><div class="line"></div><div class="line">void ProxyService::InitializeUsingLastFetchedConfig() &#123;</div><div class="line">  ResetProxyConfig(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">  DCHECK(fetched_config_.is_valid());</div><div class="line"></div><div class="line">  <span class="comment">// Increment the ID to reflect that the config has changed.</span></div><div class="line">  fetched_config_.set_id(next_config_id_++);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!fetched_config_.HasAutomaticSettings()) &#123;</div><div class="line">    config_ = fetched_config_;</div><div class="line">    SetReady();</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Start downloading + testing the PAC scripts for this new configuration.</span></div><div class="line">  current_state_ = STATE_WAITING_FOR_INIT_PROXY_RESOLVER;</div><div class="line"></div><div class="line">  <span class="comment">// If we changed networks recently, we should delay running proxy auto-config.</span></div><div class="line">  TimeDelta wait_delay =</div><div class="line">      stall_proxy_autoconfig_until_ - TimeTicks::Now();</div><div class="line"></div><div class="line">  init_proxy_resolver_.reset(<span class="keyword">new</span> InitProxyResolver());</div><div class="line">  init_proxy_resolver_-&gt;set_quick_check_enabled(quick_check_enabled_);</div><div class="line">  <span class="keyword">int</span> rv = init_proxy_resolver_-&gt;Start(</div><div class="line">      &amp;resolver_, resolver_factory_.get(), proxy_script_fetcher_.get(),</div><div class="line">      dhcp_proxy_script_fetcher_.get(), net_log_, fetched_config_, wait_delay,</div><div class="line">      base::Bind(&amp;ProxyService::OnInitProxyResolverComplete,</div><div class="line">                 base::Unretained(this)));</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (rv != ERR_IO_PENDING)</div><div class="line">    OnInitProxyResolverComplete(rv);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这里主要是将新的代理配置信息保存在 <code>fetched_config_</code> 中，继而将配置保存在 config_ 中，并设置状态标记 current<em>state</em> 为 ready。</p>
<p><code>HttpStreamFactoryImpl::Job::DoResolveProxy()</code> 通过 <code>ProxyService</code> 的 <code>ResolveProxy()</code> 来为特定的URL找到合适的代理服务器：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> ProxyService::ResolveProxy(<span class="keyword">const</span> GURL&amp; raw_url,</div><div class="line">                               <span class="keyword">const</span> std::string&amp; method,</div><div class="line">                               ProxyInfo* result,</div><div class="line">                               <span class="keyword">const</span> CompletionCallback&amp; callback,</div><div class="line">                               PacRequest** pac_request,</div><div class="line">                               ProxyDelegate* proxy_delegate,</div><div class="line">                               <span class="keyword">const</span> BoundNetLog&amp; net_log) &#123;</div><div class="line">  DCHECK(!callback.is_null());</div><div class="line">  <span class="keyword">return</span> ResolveProxyHelper(raw_url, method, result, callback, pac_request,</div><div class="line">                            proxy_delegate, net_log);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> ProxyService::ResolveProxyHelper(<span class="keyword">const</span> GURL&amp; raw_url,</div><div class="line">                                     <span class="keyword">const</span> std::string&amp; method,</div><div class="line">                                     ProxyInfo* result,</div><div class="line">                                     <span class="keyword">const</span> CompletionCallback&amp; callback,</div><div class="line">                                     PacRequest** pac_request,</div><div class="line">                                     ProxyDelegate* proxy_delegate,</div><div class="line">                                     <span class="keyword">const</span> BoundNetLog&amp; net_log) &#123;</div><div class="line">  DCHECK(CalledOnValidThread());</div><div class="line"></div><div class="line">  net_log.BeginEvent(NetLog::TYPE_PROXY_SERVICE);</div><div class="line"></div><div class="line">  <span class="comment">// Notify our polling-based dependencies that a resolve is taking place.</span></div><div class="line">  <span class="comment">// This way they can schedule their polls in response to network activity.</span></div><div class="line">  config_service_-&gt;OnLazyPoll();</div><div class="line">  <span class="keyword">if</span> (script_poller_.get())</div><div class="line">     script_poller_-&gt;OnLazyPoll();</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (current_state_ == STATE_NONE)</div><div class="line">    ApplyProxyConfigIfAvailable();</div><div class="line"></div><div class="line">  <span class="comment">// Sanitize the URL before passing it on to the proxy resolver (i.e. PAC</span></div><div class="line">  <span class="comment">// script). The goal is to remove sensitive data (like embedded user names</span></div><div class="line">  <span class="comment">// and password), and local data (i.e. reference fragment) which does not need</span></div><div class="line">  <span class="comment">// to be disclosed to the resolver.</span></div><div class="line">  GURL url = SanitizeUrl(raw_url, sanitize_url_policy_);</div><div class="line"></div><div class="line">  <span class="comment">// Check if the request can be completed right away. (This is the case when</span></div><div class="line">  <span class="comment">// using a direct connection for example).</span></div><div class="line">  <span class="keyword">int</span> rv = TryToCompleteSynchronously(url, proxy_delegate, result);</div><div class="line">  <span class="keyword">if</span> (rv != ERR_IO_PENDING) &#123;</div><div class="line">    rv = DidFinishResolvingProxy(</div><div class="line">        url, method, proxy_delegate, result, rv, net_log,</div><div class="line">        callback.is_null() ? TimeTicks() : TimeTicks::Now(), <span class="keyword">false</span>);</div><div class="line">    <span class="keyword">return</span> rv;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (callback.is_null())</div><div class="line">    <span class="keyword">return</span> ERR_IO_PENDING;</div><div class="line"></div><div class="line">  scoped_refptr&lt;PacRequest&gt; req(<span class="keyword">new</span> PacRequest(</div><div class="line">      this, url, method, proxy_delegate, result, callback, net_log));</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (current_state_ == STATE_READY) &#123;</div><div class="line">    <span class="comment">// Start the resolve request.</span></div><div class="line">    rv = req-&gt;Start();</div><div class="line">    <span class="keyword">if</span> (rv != ERR_IO_PENDING)</div><div class="line">      <span class="keyword">return</span> req-&gt;QueryDidComplete(rv);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    req-&gt;net_log()-&gt;BeginEvent(NetLog::TYPE_PROXY_SERVICE_WAITING_FOR_INIT_PAC);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  DCHECK_EQ(ERR_IO_PENDING, rv);</div><div class="line">  DCHECK(!ContainsPendingRequest(req.get()));</div><div class="line">  pending_requests_.insert(req);</div><div class="line"></div><div class="line">  <span class="comment">// Completion will be notified through |callback|, unless the caller cancels</span></div><div class="line">  <span class="comment">// the request using |pac_request|.</span></div><div class="line">  <span class="keyword">if</span> (pac_request)</div><div class="line">    *pac_request = req.get();</div><div class="line">  <span class="keyword">return</span> rv;  <span class="comment">// ERR_IO_PENDING</span></div><div class="line">&#125;</div><div class="line">. . . . . .</div><div class="line"><span class="keyword">int</span> ProxyService::TryToCompleteSynchronously(<span class="keyword">const</span> GURL&amp; url,</div><div class="line">                                             ProxyDelegate* proxy_delegate,</div><div class="line">                                             ProxyInfo* result) &#123;</div><div class="line">  DCHECK_NE(STATE_NONE, current_state_);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (current_state_ != STATE_READY)</div><div class="line">    <span class="keyword">return</span> ERR_IO_PENDING;  <span class="comment">// Still initializing.</span></div><div class="line"></div><div class="line">  DCHECK_NE(config_.id(), ProxyConfig::kInvalidConfigID);</div><div class="line"></div><div class="line">  <span class="comment">// If it was impossible to fetch or parse the PAC script, we cannot complete</span></div><div class="line">  <span class="comment">// the request here and bail out.</span></div><div class="line">  <span class="keyword">if</span> (permanent_error_ != OK)</div><div class="line">    <span class="keyword">return</span> permanent_error_;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (config_.HasAutomaticSettings())</div><div class="line">    <span class="keyword">return</span> ERR_IO_PENDING;  <span class="comment">// Must submit the request to the proxy resolver.</span></div><div class="line"></div><div class="line">  <span class="comment">// Use the manual proxy settings.</span></div><div class="line">  config_.proxy_rules().Apply(url, result);</div><div class="line">  result-&gt;config_source_ = config_.source();</div><div class="line">  result-&gt;config_id_ = config_.id();</div><div class="line"></div><div class="line">  <span class="keyword">return</span> OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个过程应用代理规则，选择适当的代理服务器给调用者。</p>
<p>Done。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://en.wikipedia.org/wiki/Proxy_server" target="_blank" rel="external">Proxy server</a><br><a href="http://www.7edown.com/edu/article/soft_5850_1.html" target="_blank" rel="external">教你在Android手机上使用全局代理</a></p>
</div><div class="tags"><a href="/tags/网络协议/">网络协议</a><a href="/tags/Android开发/">Android开发</a><a href="/tags/源码分析/">源码分析</a><a href="/tags/chromium/">chromium</a></div><div class="post-nav"><a href="/2017/02/16/Wireshark源码安装/" class="pre">Wireshark源码安装</a><a href="/2017/02/06/Android端打开HttpDns的正确姿势/" class="next">Android端打开HttpDns的正确姿势</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android-图形系统/">Android 图形系统</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android-开发/">Android 开发</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/11/android_emulator_dev/">Android 模拟器下载、编译及调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_start_streaming/">live555 源码分析：播放启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_subsession_setup/">live555 源码分析：子会话 SETUP</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/live555_src_analysis_subsession_sdp/">live555 源码分析：子会话 SDP 行生成</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/live555_src_analysis_servermediasession/">live555 源码分析：ServerMediaSession</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/06/live555_src_analysis_rtspserver_arch/">live555 源码分析：RTSPServer 组件结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/live555_src_analysis_play/">live555 源码分析： PLAY 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/live555_src_analysis_setup/">live555 源码分析： SETUP 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/04/live555_src_analysis_describe/">live555 源码分析： DESCRIBE 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/03/live555_src_analysis_rtspserver/">live555 源码分析：RTSPServer</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2017/02/09/Android平台Chromium net中的代理配置信息获取/';
var disqus_title = 'Android平台Chromium net中的代理配置信息获取';
var disqus_url = 'https://www.wolfcstech.com/2017/02/09/Android平台Chromium net中的代理配置信息获取/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>