<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Simpleperf介绍 | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Simpleperf介绍</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Simpleperf介绍</h1><div class="post-meta">Feb 21, 2017<span> | </span><span class="category"><a href="/categories/Android开发/">Android开发</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/02/21/Simpleperf_Introduction/" href="/2017/02/21/Simpleperf_Introduction/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h1 id="什么是simpleperf"><a href="#什么是simpleperf" class="headerlink" title="什么是simpleperf"></a>什么是simpleperf</h1><p>Simpleperf是Android平台的一个本地层性能分析工具。它的命令行界面支持与linux-tools perf大致相同的选项，但是它还支持许多Android特有的改进。<br><a id="more"></a><br>Simpleperf是Android开源项目（AOSP）的一部分。其源代码 <a href="https://android.googlesource.com/platform/system/extras/+/master/simpleperf/" target="_blank" rel="external">位于</a>。其最新的文档 <a href="https://android.googlesource.com/platform/system/extras/+show/master/simpleperf/README.md" target="_blank" rel="external">位于</a>。Bugs 和 功能需求可以提交到 <a href="http://github.com/android-ndk/ndk/issues" target="_blank" rel="external">githb上</a>。</p>
<h1 id="Simpleperf是如何工作的"><a href="#Simpleperf是如何工作的" class="headerlink" title="Simpleperf是如何工作的"></a>Simpleperf是如何工作的</h1><p>现代的CPU具有一个硬件组件，称为性能监控单元(PMU)。PMU具有一些硬件计数器，计数一些诸如 经历了多少次CPU周期，执行了多少条指令，或发生了多少次缓存未命中 等的事件。</p>
<p>Linux内核将这些硬件计数器包装到硬件perf事件 (hardware perf events)中。此外，Linux内核还提供了独立于硬件的软件事件和跟踪点事件。Linux内核通过 perf_event_open 系统调用将这些都暴露给了用户空间，这正是simpleperf所使用的机制。</p>
<p>Simpleperf具有三个主要的功能：stat，record 和 report。</p>
<p>Stat命令给出了在一个时间段内被分析的进程中发生了多少事件的摘要。以下是它的工作原理：</p>
<ol>
<li>给定用户选项，simpleperf通过对linux内核进行系统调用来启用分析。</li>
<li>Linux 内核在调度到被分析进程时启用计数器。</li>
<li>分析之后，simpleperf从内核读取计数器，并报告计数器摘要。</li>
</ol>
<p>Record 命令在一段时间内记录剖析进程的样本。它的工作原理如下：</p>
<ol>
<li>给定用户选项，simpleperf通过对linux内核进行系统调用来启用分析。</li>
<li>Simpleperf 在simpleperf 和 linux 内核之间创建映射缓冲区。</li>
<li>Linux 内核在调度到被分析进程时启用计数器。</li>
<li>每次给定数量的事件发生时，linux 内核将样本转储到映射缓冲区。</li>
<li>Simpleperf 从映射缓冲区读取样本并生成 perf.data。</li>
</ol>
<p>Report 命令读取 “perf.data” 文件及所有被剖析进程用到的共享库，并输出一份报告，展示时间消耗在了哪里。</p>
<h1 id="主-simpleperf-命令"><a href="#主-simpleperf-命令" class="headerlink" title="主 simpleperf 命令"></a>主 simpleperf 命令</h1><p>Simpleperf 支持一些子命令，包括 list，stat，record，report。每个子命令支持不同的选项。这一节只描述最重要的子命令和选项。要了解所有的子命令和选项，请使用 –help。<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># <span class="keyword">List</span> all subcommands.</div><div class="line"><span class="variable">$simpleperf</span> --<span class="keyword">help</span></div><div class="line"></div><div class="line"># <span class="keyword">Print</span> <span class="keyword">help</span> message <span class="keyword">for</span> record subcommand.</div><div class="line"><span class="variable">$simpleperf</span> record --<span class="keyword">help</span></div></pre></td></tr></table></figure></p>
<h2 id="simpleperf-list"><a href="#simpleperf-list" class="headerlink" title="simpleperf list"></a>simpleperf list</h2><p>simpleperf list 被用于列出设备上所有可用的事件。由于应该和内核的差异，不同的设备可以支持不同的事件。<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$simpleperf <span class="built_in">list</span></div><div class="line"><span class="built_in">List</span> of hw<span class="params">-cache</span> events:</div><div class="line">  branch<span class="params">-loads</span></div><div class="line">  <span class="params">...</span></div><div class="line"><span class="built_in">List</span> of hardware events:</div><div class="line">  cpu<span class="params">-cycles</span></div><div class="line">  instructions</div><div class="line">  <span class="params">...</span></div><div class="line"><span class="built_in">List</span> of software events:</div><div class="line">  cpu<span class="params">-clock</span></div><div class="line">  task<span class="params">-clock</span></div><div class="line">  <span class="params">...</span></div></pre></td></tr></table></figure></p>
<h2 id="simpleperf-stat"><a href="#simpleperf-stat" class="headerlink" title="simpleperf stat"></a>simpleperf stat</h2><p>simpleperf stat 被用于获取被剖析程序或系统范围内的原始事件计数器信息。通过传入选项，我们可以选择使用哪些事件，监视哪个进程/线程，监视多长时间，以及打印的间隔。下面是一个例子。<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Stat using default events (cpu-cycles,instructions,...), and monitor</span></div><div class="line"><span class="comment"># process 7394 for 10 seconds.</span></div><div class="line">$simpleperf stat -p <span class="number">7394</span> --duration <span class="number">10</span></div><div class="line">Performance counter statistics:</div><div class="line"></div><div class="line"> <span class="number">1</span>,<span class="number">320</span>,<span class="number">496</span>,<span class="number">145</span>  cpu-cycles         <span class="comment"># 0.131736 GHz                     (100%)</span></div><div class="line">   <span class="number">510</span>,<span class="number">426</span>,<span class="number">028</span>  <span class="keyword">instructions </span>      <span class="comment"># 2.587047 cycles per instruction  (100%)</span></div><div class="line">     <span class="number">4</span>,<span class="number">692</span>,<span class="number">338</span>  <span class="keyword">branch-misses </span>     <span class="comment"># 468.118 K/sec                    (100%)</span></div><div class="line"><span class="number">886</span>.<span class="number">008130</span>(ms)  task-<span class="keyword">clock </span>        <span class="comment"># 0.088390 cpus used               (100%)</span></div><div class="line">           <span class="number">753</span>  <span class="built_in">context</span>-<span class="keyword">switches </span>  <span class="comment"># 75.121 /sec                      (100%)</span></div><div class="line">           <span class="number">870</span>  page-faults        <span class="comment"># 86.793 /sec                      (100%)</span></div><div class="line"></div><div class="line">Total test time: <span class="number">10</span>.<span class="number">023829</span> seconds.</div></pre></td></tr></table></figure></p>
<h3 id="选择事件"><a href="#选择事件" class="headerlink" title="选择事件"></a><em>选择事件</em></h3><p>我们可以通过 -e 选项选择使用哪个事件。下面是例子：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Stat event cpu-cycles.</span></div><div class="line"><span class="variable">$simpleperf</span> <span class="built_in">stat</span> <span class="_">-e</span> cpu-cycles -p 11904 --duration 10</div><div class="line"></div><div class="line"><span class="comment"># Stat event cache-references and cache-misses.</span></div><div class="line"><span class="variable">$simpleperf</span> <span class="built_in">stat</span> <span class="_">-e</span> cache-references,cache-misses -p 11904 --duration 10</div></pre></td></tr></table></figure></p>
<p>当运行 stat 命令时，如果硬件事件的数量大于 PMU中可用的硬件计数器的数量，则内核在事件间共享硬件计数器，因此每个事件只在总时间中的一部分内被监视。在下面的例子中，每一行的最后都有一个百分比，展示了每个事件实际被监视的时间占总时间的百分比。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Stat using event cache-references, cache-references:u,....</span></div><div class="line">$simpleperf stat -p <span class="number">7394</span> -e     <span class="keyword">cache-references,cache-references:u,cache-references:k,cache-misses,cache-misses:u,cache-misses:k,instructions </span>--duration <span class="number">1</span></div><div class="line">Performance counter statistics:</div><div class="line"></div><div class="line"><span class="number">4</span>,<span class="number">331</span>,<span class="number">018</span>  <span class="keyword">cache-references </span>    <span class="comment"># 4.861 M/sec    (87%)</span></div><div class="line"><span class="number">3</span>,<span class="number">064</span>,<span class="number">089</span>  <span class="keyword">cache-references:u </span>  <span class="comment"># 3.439 M/sec    (87%)</span></div><div class="line"><span class="number">1</span>,<span class="number">364</span>,<span class="number">959</span>  <span class="keyword">cache-references:k </span>  <span class="comment"># 1.532 M/sec    (87%)</span></div><div class="line">   <span class="number">91</span>,<span class="number">721</span>  <span class="keyword">cache-misses </span>        <span class="comment"># 102.918 K/sec  (87%)</span></div><div class="line">   <span class="number">45</span>,<span class="number">735</span>  <span class="keyword">cache-misses:u </span>      <span class="comment"># 51.327 K/sec   (87%)</span></div><div class="line">   <span class="number">38</span>,<span class="number">447</span>  <span class="keyword">cache-misses:k </span>      <span class="comment"># 43.131 K/sec   (87%)</span></div><div class="line"><span class="number">9</span>,<span class="number">688</span>,<span class="number">515</span>  <span class="keyword">instructions </span>        <span class="comment"># 10.561 M/sec   (89%)</span></div><div class="line"></div><div class="line">Total test time: <span class="number">1</span>.<span class="number">026802</span> seconds.</div></pre></td></tr></table></figure>
<p>在上面的例子中，每个事件被监视的时间大概占总时间的 87%。但是，不保证任何一对事件总是在相同的时间被监视。如果我们想要让一些事件在同一时间被监视，我们可以使用 –group 选项。下面是一个例子。<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Stat using event cache-references, cache-references:u,....</span></div><div class="line">$simpleperf stat -p <span class="number">7394</span> --group <span class="keyword">cache-references,cache-misses </span>--group <span class="keyword">cache-references:u,cache-misses:u </span>--group <span class="keyword">cache-references:k,cache-misses:k </span>-e <span class="keyword">instructions </span>--duration <span class="number">1</span></div><div class="line">Performance counter statistics:</div><div class="line"></div><div class="line"><span class="number">3</span>,<span class="number">638</span>,<span class="number">900</span>  <span class="keyword">cache-references </span>    <span class="comment"># 4.786 M/sec          (74%)</span></div><div class="line">   <span class="number">65</span>,<span class="number">171</span>  <span class="keyword">cache-misses </span>        <span class="comment"># 1.790953% miss rate  (74%)</span></div><div class="line"><span class="number">2</span>,<span class="number">390</span>,<span class="number">433</span>  <span class="keyword">cache-references:u </span>  <span class="comment"># 3.153 M/sec          (74%)</span></div><div class="line">   <span class="number">32</span>,<span class="number">280</span>  <span class="keyword">cache-misses:u </span>      <span class="comment"># 1.350383% miss rate  (74%)</span></div><div class="line">  <span class="number">879</span>,<span class="number">035</span>  <span class="keyword">cache-references:k </span>  <span class="comment"># 1.251 M/sec          (68%)</span></div><div class="line">   <span class="number">30</span>,<span class="number">303</span>  <span class="keyword">cache-misses:k </span>      <span class="comment"># 3.447303% miss rate  (68%)</span></div><div class="line"><span class="number">8</span>,<span class="number">921</span>,<span class="number">161</span>  <span class="keyword">instructions </span>        <span class="comment"># 10.070 M/sec         (86%)</span></div><div class="line"></div><div class="line">Total test time: <span class="number">1</span>.<span class="number">029843</span> seconds.</div></pre></td></tr></table></figure></p>
<h3 id="选择监视目标"><a href="#选择监视目标" class="headerlink" title="选择监视目标"></a><em>选择监视目标</em></h3><p>我们可以通过 -p 选项或 -t 选项选择监视哪个进程或线程。监视一个进程如同监视进程中的所有线程。Simpleperf 也可以 fork 一个子进程来运行新命令，然后监视子进程。下面是例子。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Stat process 11904 and 11905.</span></div><div class="line"><span class="variable">$simpleperf</span> <span class="built_in">stat</span> -p 11904,11905 --duration 10</div><div class="line"></div><div class="line"><span class="comment"># Stat thread 11904 and 11905.</span></div><div class="line"><span class="variable">$simpleperf</span> <span class="built_in">stat</span> -t 11904,11905 --duration 10</div><div class="line"></div><div class="line"><span class="comment"># Start a child process running `ls`, and stat it.</span></div><div class="line"><span class="variable">$simpleperf</span> <span class="built_in">stat</span> ls</div></pre></td></tr></table></figure></p>
<h3 id="决定监视多长时间"><a href="#决定监视多长时间" class="headerlink" title="决定监视多长时间"></a><em>决定监视多长时间</em></h3><p>当监视已有线程时，我们可以使用 –duration 选项决定监视多长时间。当监视执行一个新命令的子进程时，simpleperf 将一直监视子进程直至其结束。在这种情况下，我们可以使用 Ctrl-C 在任何时间停止监视。例子如下。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Stat process 11904 for 10 seconds.</span></div><div class="line"><span class="variable">$simpleperf</span> <span class="built_in">stat</span> -p 11904 --duration 10</div><div class="line"></div><div class="line"><span class="comment"># Stat until the child process running `ls` finishes.</span></div><div class="line"><span class="variable">$simpleperf</span> <span class="built_in">stat</span> ls</div><div class="line"></div><div class="line"><span class="comment"># Stop monitoring using Ctrl-C.</span></div><div class="line"><span class="variable">$simpleperf</span> <span class="built_in">stat</span> -p 11904 --duration 10</div><div class="line">^C</div></pre></td></tr></table></figure></p>
<h3 id="决定打印的间隔"><a href="#决定打印的间隔" class="headerlink" title="决定打印的间隔"></a><em>决定打印的间隔</em></h3><p>当监视 perf 计数器时，我们还可以使用 –interval 选项决定打印的间隔。例子如下。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># Print stat for process <span class="number">11904</span> every <span class="number">300</span>ms.</div><div class="line">$simpleperf stat -p <span class="number">11904</span> --duration <span class="number">10</span> --interval <span class="number">300</span></div><div class="line"></div><div class="line"># Print system wide stat at interval of <span class="number">300</span>ms for <span class="number">10</span> seconds (rooted device only).</div><div class="line"># system wide profiling needs root privilege</div><div class="line">$su <span class="number">0</span> simpleperf stat -a --duration <span class="number">10</span> --interval <span class="number">300</span></div></pre></td></tr></table></figure></p>
<h3 id="在-systrace-中显示计数器"><a href="#在-systrace-中显示计数器" class="headerlink" title="在 systrace 中显示计数器"></a><em>在 systrace 中显示计数器</em></h3><p>simpleperf 还可以与systrace一起工作来将计数器转储进收集的trace中。下面是一个执行系统范围的 stat 的例子。<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># capture instructions (kernel <span class="keyword">only</span>) <span class="built_in">and</span> cache misses with interval of <span class="number">300</span> milliseconds <span class="keyword">for</span> <span class="number">15</span> seconds</div><div class="line">$su <span class="number">0</span> simpleperf stat -<span class="keyword">e</span> instruction<span class="variable">s:k</span>,cache-misses -<span class="keyword">a</span> --interval <span class="number">300</span> --duration <span class="number">15</span></div><div class="line"># <span class="keyword">on</span> host launch systrace <span class="keyword">to</span> collect trace <span class="keyword">for</span> <span class="number">10</span> seconds</div><div class="line">(HOST)$external/chromium-trace/systrace.<span class="keyword">py</span> --time=<span class="number">10</span> -<span class="keyword">o</span> <span class="keyword">new</span>.html sched gfx <span class="keyword">view</span></div><div class="line"># <span class="keyword">open</span> the collected <span class="keyword">new</span>.html in browser <span class="built_in">and</span> perf counters will <span class="keyword">be</span> shown <span class="keyword">up</span></div></pre></td></tr></table></figure></p>
<h2 id="simpleperf-record"><a href="#simpleperf-record" class="headerlink" title="simpleperf record"></a>simpleperf record</h2><p>simpleperf record用于转储被剖析程序的记录。通过传入选项，我们可以选择使用哪个事件，监视哪个进程/线程，以什么频率转储记录，监视多长时间，以及将记录存储到哪里。</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># <span class="keyword">Record</span> <span class="keyword">on</span> <span class="keyword">process</span> <span class="number">7394</span> <span class="keyword">for</span> <span class="number">10</span> seconds, using <span class="keyword">default</span> event (cpu-cycles),</div><div class="line"># using <span class="keyword">default</span> sample frequency (<span class="number">4000</span> samples per second), writing records</div><div class="line"># <span class="keyword">to</span> perf.data.</div><div class="line">$simpleperf <span class="keyword">record</span> -p <span class="number">7394</span> <span class="comment">--duration 10</span></div><div class="line">simpleperf I <span class="number">07</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">44</span>:<span class="number">11</span> <span class="number">17522</span> <span class="number">17522</span> cmd_record.cpp:<span class="number">316</span>] Samples recorded: <span class="number">21430</span>. Samples lost: <span class="number">0</span>.</div></pre></td></tr></table></figure>
<h3 id="选择事件-1"><a href="#选择事件-1" class="headerlink" title="选择事件"></a><em>选择事件</em></h3><p>在大多数情况下，cpu-cycles 事件被用于评估消耗的CPU时间。作为一个硬件事件，它精确而高效。我们还可以通过 -e 选项使用其它事件。下面是一个例子。<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># <span class="keyword">Record</span> using event instructions.</div><div class="line">$simpleperf <span class="keyword">record</span> -e instructions -p <span class="number">11904</span> <span class="comment">--duration 10</span></div></pre></td></tr></table></figure></p>
<h3 id="选择监视目标-1"><a href="#选择监视目标-1" class="headerlink" title="选择监视目标"></a><em>选择监视目标</em></h3><p>record命令中选择目标的方式与 stat 命令中的类似。例子如下。<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># <span class="keyword">Record</span> <span class="keyword">process</span> <span class="number">11904</span> <span class="keyword">and</span> <span class="number">11905</span>.</div><div class="line">$simpleperf <span class="keyword">record</span> -p <span class="number">11904</span>,<span class="number">11905</span> <span class="comment">--duration 10</span></div><div class="line"></div><div class="line"># <span class="keyword">Record</span> thread <span class="number">11904</span> <span class="keyword">and</span> <span class="number">11905</span>.</div><div class="line">$simpleperf <span class="keyword">record</span> -t <span class="number">11904</span>,<span class="number">11905</span> <span class="comment">--duration 10</span></div><div class="line"></div><div class="line"># <span class="keyword">Record</span> a child <span class="keyword">process</span> running `ls`.</div><div class="line">$simpleperf <span class="keyword">record</span> ls</div></pre></td></tr></table></figure></p>
<h3 id="设置记录的频率"><a href="#设置记录的频率" class="headerlink" title="设置记录的频率"></a><em>设置记录的频率</em></h3><p>我们可以通过 -f 或 -c 选项设置转储记录的频率。比如，-f 4000 意味着当监视的线程运行时每秒转储接近 4000 个记录。如果监视的线程一秒钟运行了 0.2 s（其它时间它可能被抢占或阻塞），simpleperf 每秒转储大约 4000 * 0.2 / 1.0 = 800 个记录。另一种方式是使用 -c 选项。比如，-c 10000 意味着每发生 10000 次事件转储一个记录。例子如下。<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># <span class="keyword">Record</span> <span class="keyword">with</span> sample frequency <span class="number">1000</span>: sample <span class="number">1000</span> times every second running.</div><div class="line">$simpleperf <span class="keyword">record</span> -f <span class="number">1000</span> -p <span class="number">11904</span>,<span class="number">11905</span> <span class="comment">--duration 10</span></div><div class="line"></div><div class="line"># <span class="keyword">Record</span> <span class="keyword">with</span> sample period <span class="number">100000</span>: sample <span class="number">1</span> <span class="built_in">time</span> every <span class="number">100000</span> events.</div><div class="line">$simpleperf <span class="keyword">record</span> -c <span class="number">100000</span> -t <span class="number">11904</span>,<span class="number">11905</span> <span class="comment">--duration 10</span></div></pre></td></tr></table></figure></p>
<h3 id="决定监视多长时间-1"><a href="#决定监视多长时间-1" class="headerlink" title="决定监视多长时间"></a><em>决定监视多长时间</em></h3><p>record 命令中决定监视多长时间的方式与 stat 命令中的类似。例子如下。<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># <span class="keyword">Record</span> <span class="keyword">process</span> <span class="number">11904</span> <span class="keyword">for</span> <span class="number">10</span> seconds.</div><div class="line">$simpleperf <span class="keyword">record</span> -p <span class="number">11904</span> <span class="comment">--duration 10</span></div><div class="line"></div><div class="line"># <span class="keyword">Record</span> <span class="keyword">until</span> the child <span class="keyword">process</span> running `ls` finishes.</div><div class="line">$simpleperf <span class="keyword">record</span> ls</div><div class="line"></div><div class="line"># Stop monitoring using Ctrl-C.</div><div class="line">$simpleperf <span class="keyword">record</span> -p <span class="number">11904</span> <span class="comment">--duration 10</span></div><div class="line">^C</div></pre></td></tr></table></figure></p>
<h3 id="设置存储记录的路径"><a href="#设置存储记录的路径" class="headerlink" title="设置存储记录的路径"></a><em>设置存储记录的路径</em></h3><p>默认情况下，simpleperf 将记录保存至当前文件夹下的 perf.data 文件中。我们可以使用 -o 选项设置存储记录的路径。下面是一个例子。<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># <span class="built_in">Write</span> records to <span class="keyword">data</span>/perf2.<span class="keyword">data</span>.</div><div class="line">$simpleperf record -p <span class="number">11904</span> -o <span class="keyword">data</span>/perf2.<span class="keyword">data</span> --duration <span class="number">10</span></div></pre></td></tr></table></figure></p>
<h2 id="simpleperf-report"><a href="#simpleperf-report" class="headerlink" title="simpleperf report"></a>simpleperf report</h2><p>simpleperf report 被用来基于 simpleperf record 命令生成的 perf.data 产生报告。Report 命令将记录分组为不同的样本项，基于每个样本项包含的事件的多少对样本项排序，并打印每个样本项。通过传入选项，我们可以选择到哪里寻找被监视的程序使用的 perf.data 和 可执行二进制文件，过滤不感兴趣的记录，并决定如何分组记录。</p>
<p>下面是一个例子。记录被分为 4 个样本项，每项一行。有一些列，每列展示了属于一个样本项的信息片段。第一列是 Overhead，它展示了当前样本项中的事件占总事件的百分比。由于 perf 事件是 cpu-cycles，overhead 可被视为是每个函数占用的 cpu 的百分比。<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># Reports perf.<span class="keyword">data</span>, using <span class="keyword">only</span> records sampled <span class="keyword">in</span> libsudo-game-jni.so,</div><div class="line"># grouping records using thread <span class="keyword">name</span>(comm), process id(pid), thread id(tid),</div><div class="line"># <span class="function"><span class="keyword">function</span></span> <span class="keyword">name</span>(symbol), and showing sample <span class="built_in">count</span> for each row.</div><div class="line">$simpleperf report --dsos /<span class="keyword">data</span>/app/com.example.sudogame-<span class="number">2</span>/lib/arm64/libsudo-game-jni.so --sort comm,pid,tid,symbol -n</div><div class="line">Cmdline: /<span class="keyword">data</span>/<span class="keyword">data</span>/com.example.sudogame/simpleperf record -p <span class="number">7394</span> --duration <span class="number">10</span></div><div class="line">Arch: arm64</div><div class="line">Event: cpu-cycles (<span class="keyword">type</span> <span class="number">0</span>, config <span class="number">0</span>)</div><div class="line">Samples: <span class="number">28235</span></div><div class="line">Event <span class="built_in">count</span>: <span class="number">546356211</span></div><div class="line"></div><div class="line">Overhead  Sample  Command    Pid   Tid   Symbol</div><div class="line"><span class="number">59.25</span>%    <span class="number">16680</span>   sudogame  <span class="number">7394</span>  <span class="number">7394</span>  checkValid(Board const&amp;, <span class="built_in">int</span>, <span class="built_in">int</span>)</div><div class="line"><span class="number">20.42</span>%    <span class="number">5620</span>    sudogame  <span class="number">7394</span>  <span class="number">7394</span>  canFindSolution_r(Board&amp;, <span class="built_in">int</span>, <span class="built_in">int</span>)</div><div class="line"><span class="number">13.82</span>%    <span class="number">4088</span>    sudogame  <span class="number">7394</span>  <span class="number">7394</span>  randomBlock_r(Board&amp;, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>)</div><div class="line"><span class="number">6.24</span>%     <span class="number">1756</span>    sudogame  <span class="number">7394</span>  <span class="number">7394</span>  @plt</div></pre></td></tr></table></figure></p>
<h3 id="设置存储记录的路径-1"><a href="#设置存储记录的路径-1" class="headerlink" title="设置存储记录的路径"></a><em>设置存储记录的路径</em></h3><p>默认情况下，simpleperf 读取当前目录下的 perf.data。我们可以使用 -i 选项选择从另一个文件读取记录。<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$simpleperf report -i <span class="class"><span class="keyword">data</span>/perf2.<span class="keyword">data</span></span></div></pre></td></tr></table></figure></p>
<h3 id="设置查找可执行二进制文件的路径"><a href="#设置查找可执行二进制文件的路径" class="headerlink" title="设置查找可执行二进制文件的路径"></a><em>设置查找可执行二进制文件的路径</em></h3><p>如果要生成函数符号报告，simpleperf 需要读取被监视的进程使用的可执行二进制文件来获取符号表和调试信息。默认情况下，路径是记录时被监视的进程使用的可执行二进制文件，然而，在生成报告时这些二进制文件可能不存在，或不包含符号表和调试信息。因此我们可以使用 –symfs 来重定向路径。下面是一个例子。<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$simpleperf <span class="keyword">report</span></div><div class="line"># <span class="keyword">In</span> this <span class="keyword">case</span>, <span class="keyword">when</span> simpleperf wants <span class="keyword">to</span> read executable binary /A/b,</div><div class="line"># it reads <span class="keyword">file</span> <span class="keyword">in</span> /A/b.</div><div class="line"></div><div class="line">$simpleperf <span class="keyword">report</span> <span class="comment">--symfs /debug_dir</span></div><div class="line"># <span class="keyword">In</span> this <span class="keyword">case</span>, <span class="keyword">when</span> simpleperf wants <span class="keyword">to</span> read executable binary /A/b,</div><div class="line"># it prefers <span class="keyword">file</span> <span class="keyword">in</span> /debug_dir/A/b <span class="keyword">to</span> <span class="keyword">file</span> <span class="keyword">in</span> /A/b.</div></pre></td></tr></table></figure></p>
<h3 id="过滤记录"><a href="#过滤记录" class="headerlink" title="过滤记录"></a><em>过滤记录</em></h3><p>当生成报告时，可能不是对所有记录都感兴趣。Simpleperf 支持五钟过滤器来选择感兴趣的记录。下面是例子。<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># <span class="keyword">Report</span> records <span class="keyword">in</span> threads having name sudogame.</div><div class="line">$simpleperf <span class="keyword">report</span> <span class="comment">--comms sudogame</span></div><div class="line"></div><div class="line"># <span class="keyword">Report</span> records <span class="keyword">in</span> <span class="keyword">process</span> <span class="number">7394</span> <span class="keyword">or</span> <span class="number">7395</span></div><div class="line">$simpleperf <span class="keyword">report</span> <span class="comment">--pids 7394,7395</span></div><div class="line"></div><div class="line"># <span class="keyword">Report</span> records <span class="keyword">in</span> thread <span class="number">7394</span> <span class="keyword">or</span> <span class="number">7395</span>.</div><div class="line">$simpleperf <span class="keyword">report</span> <span class="comment">--tids 7394,7395</span></div><div class="line"></div><div class="line"># <span class="keyword">Report</span> records <span class="keyword">in</span> libsudo-game-jni.so.</div><div class="line">$simpleperf <span class="keyword">report</span> <span class="comment">--dsos /data/app/com.example.sudogame-2/lib/arm64/libsudo-game-jni.so</span></div><div class="line"></div><div class="line"># <span class="keyword">Report</span> records <span class="keyword">in</span> <span class="keyword">function</span> checkValid <span class="keyword">or</span> canFindSolution_r.</div><div class="line">$simpleperf <span class="keyword">report</span> <span class="comment">--symbols "checkValid(Board const&amp;, int, int);canFindSolution_r(Board&amp;, int, int)"</span></div></pre></td></tr></table></figure></p>
<h3 id="决定如何将记录分组为样本项"><a href="#决定如何将记录分组为样本项" class="headerlink" title="决定如何将记录分组为样本项"></a><em>决定如何将记录分组为样本项</em></h3><p>Simpleperf 使用 –sort 选项决定如何分组样本项。下面是例子。<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># <span class="keyword">Group</span> records based <span class="keyword">on</span> their <span class="keyword">process</span> id: records having the same <span class="keyword">process</span></div><div class="line"># id are <span class="keyword">in</span> the same sample entry.</div><div class="line">$simpleperf <span class="keyword">report</span> <span class="comment">--sort pid</span></div><div class="line"></div><div class="line"># <span class="keyword">Group</span> records based <span class="keyword">on</span> their thread id <span class="keyword">and</span> thread comm: records having</div><div class="line"># the same thread id <span class="keyword">and</span> thread name are <span class="keyword">in</span> the same sample entry.</div><div class="line">$simpleperf <span class="keyword">report</span> <span class="comment">--sort tid,comm</span></div><div class="line"></div><div class="line"># <span class="keyword">Group</span> records based <span class="keyword">on</span> their binary <span class="keyword">and</span> <span class="keyword">function</span>: records <span class="keyword">in</span> the same</div><div class="line"># binary <span class="keyword">and</span> <span class="keyword">function</span> are <span class="keyword">in</span> the same sample entry.</div><div class="line">$simpleperf <span class="keyword">report</span> <span class="comment">--sort dso,symbol</span></div><div class="line"></div><div class="line"># <span class="keyword">Default</span> option: <span class="comment">--sort comm,pid,tid,dso,symbol. Group records in the same</span></div><div class="line"># thread, <span class="keyword">and</span> belong <span class="keyword">to</span> the same <span class="keyword">function</span> <span class="keyword">in</span> the same binary.</div><div class="line">$simpleperf <span class="keyword">report</span></div></pre></td></tr></table></figure></p>
<h2 id="simpleperf-的特性"><a href="#simpleperf-的特性" class="headerlink" title="simpleperf 的特性"></a>simpleperf 的特性</h2><p>Simpleperf 的工作方式与 linux-tools-perf 类似，但它有如下的提升：</p>
<ol>
<li>Aware of Android environment. Simpleperf 在剖析时处理一些Android特有的情形。例如，它可以剖析 apk 中嵌入的共享库，从 .gnu_debugdata 段读取符号表和调试信息。如果可能，当出现错误时它会给出一些提示，如如何禁用perf_harden启用分析。</li>
<li>记录时支持展开。如果我们想使用 -g 选项来记录并报告一个程序的调用图，我们需要转储每个记录中的用户栈和寄存器集合，然后展开栈来查找调用链。Simpleperf 支持在记录时展开，因此它无需在 perf.data 中存储用户栈。因而我们可以在设备上有限的空间内剖析更长的时间。</li>
<li>支持脚本使Android上的剖析更方便。</li>
<li>编译进静态的二进制文件。Simpleperf 是一个静态库，因此它无需支持运行共享库。这意味着对于 simpleperf 可以运行的的 Android 版本没有限制，尽管有些设备不支持剖析。</li>
</ol>
<h1 id="ndk中的Simpleperf工具"><a href="#ndk中的Simpleperf工具" class="headerlink" title="ndk中的Simpleperf工具"></a>ndk中的Simpleperf工具</h1><p>ndk 中的 simpleperf 工具包含三个部分：在 Android 设备上运行的 simpleperf 可执行文件，在主机上运行的 simpleperf 可执行文件，和 python 脚本。</p>
<h2 id="设备上的-simpleperf"><a href="#设备上的-simpleperf" class="headerlink" title="设备上的 simpleperf"></a>设备上的 simpleperf</h2><p>在设备上运行的 simpleperf 位于 bin/android 目录下。它包含不同体系架构的 Android 上运行的静态二进制文件。它们可被用于剖析运行在设备上的进程，并生成 perf.data。</p>
<h2 id="主机上的-simpleperf"><a href="#主机上的-simpleperf" class="headerlink" title="主机上的 simpleperf"></a>主机上的 simpleperf</h2><p>运行与主机上的 Simpleperfs 位于bin/darwin，bin/linux 和 bin/windows。它们可被用于在主机上解析 perf.data。</p>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>脚本被用于使得剖析和解析剖析结果更方便。app_profiler.py 被用于剖析一个 android 应用程序。它准备剖析环境，下载 simpleperf 到设备上，在主机上生成并拉出 perf.data。它由 app_profiler.config 配置。binary_cache_builder.py 被用于从设备拉出本地层二进制文件到主机上。它由 app_profiler.py 使用。annotate.py 被用于使用 perf.data 注解源文件。它由 annotate.config 配置。report.py 在一个 GUI 窗口中报告 perf.data。simpleperf_report_lib.py 被用于枚举 perf.data 中的样本。在内部它使用 libsimpleperf_report.so 来解析 perf.data。它可被用于将 perf.data 中的样本翻译为其它形式。使用 simpleperf_report_lib.py 的一个例子是 report_sample.py。</p>
<h1 id="使用-simpleperf-工具的例子"><a href="#使用-simpleperf-工具的例子" class="headerlink" title="使用 simpleperf 工具的例子"></a>使用 simpleperf 工具的例子</h1><p>这个部分展示了如何使用 simpleperf 工具来剖析一个 Android 应用。</p>
<h2 id="准备一个可调试-debuggable-的应用"><a href="#准备一个可调试-debuggable-的应用" class="headerlink" title="准备一个可调试(debuggable)的应用"></a>准备一个可调试(debuggable)的应用</h2><p>应用程序的包名是 com.example.sudogame。它包含 java 代码和 c++ 代码。我们需要运行一份在其 AndroidManifest.xml 元素中 android:debuggable=”true” 的app，因为我们不能为 non-debuggable apps 使用 run-as。应用应该已经安装在设备上了，而且我们可以通过 adb 连接设备。</p>
<h2 id="使用命令行剖析"><a href="#使用命令行剖析" class="headerlink" title="使用命令行剖析"></a>使用命令行剖析</h2><p>为了记录剖析数据，我们需要下载 simpleperf 和包含调试信息的本地库到设备上，运行 simpleperf 产生剖析数据：perf.data，并运行 simpleperf 为 perf.data 生成报告。步骤如下。</p>
<h3 id="1-Enable-profiling"><a href="#1-Enable-profiling" class="headerlink" title="1. Enable profiling"></a>1. Enable profiling</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$adb</span> shell setprop security<span class="selector-class">.perf_harden</span> <span class="number">0</span></div></pre></td></tr></table></figure>
<h3 id="2-寻找运行-app-的进程"><a href="#2-寻找运行-app-的进程" class="headerlink" title="2. 寻找运行 app 的进程"></a>2. 寻找运行 app 的进程</h3><p>在 app 的上下文运行 <code>ps</code>。在 &gt;=O 的设备上，用 <code>ps -e</code> 来替代。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$adb</span> shell</div><div class="line">angler:/ $ run-as com<span class="selector-class">.example</span><span class="selector-class">.sudogame</span></div><div class="line">angler:/data/data/com<span class="selector-class">.example</span><span class="selector-class">.sudogame</span> $ ps</div><div class="line">u0_a93    <span class="number">10324</span> <span class="number">570</span>   <span class="number">1030480</span> <span class="number">58104</span> SyS_epoll_ <span class="number">00</span>f41b7528 S com<span class="selector-class">.example</span><span class="selector-class">.sudogame</span></div><div class="line">u0_a93    <span class="number">10447</span> <span class="number">10441</span> <span class="number">7716</span>   <span class="number">1588</span>  sigsuspend <span class="number">753</span>c515d34 S sh</div><div class="line">u0_a93    <span class="number">10453</span> <span class="number">10447</span> <span class="number">9112</span>   <span class="number">1644</span>           <span class="number">0</span> <span class="number">7</span>ba07ff664 R ps</div></pre></td></tr></table></figure></p>
<p>因此是进程 10324 运行app。</p>
<h3 id="3-将-simpleperf-下载到-app-的-data-目录"><a href="#3-将-simpleperf-下载到-app-的-data-目录" class="headerlink" title="3. 将 simpleperf 下载到 app 的 data 目录"></a>3. 将 simpleperf 下载到 app 的 data 目录</h3><p>首先我们需要找出 app 使用的是哪个体系架构。有许多中方式，这里我们只检查进程的映射。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="string">angler:</span><span class="regexp">/data/</span>data<span class="regexp">/com.example.sudogame $cat /</span>proc<span class="regexp">/10324/</span>maps | grep boot.art</div><div class="line"><span class="number">70</span>f34000<span class="number">-7144e000</span> r--p <span class="number">00000000</span> <span class="string">fd:</span><span class="number">00</span> <span class="number">1082</span>  <span class="regexp">/system/</span>framework<span class="regexp">/arm/</span>boot.oat</div></pre></td></tr></table></figure></p>
<p>路径显示是它是 arm。因此我们将 simpleperf 下载到设备上的 arm 目录下。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$adb push bin<span class="regexp">/android/</span>arm<span class="regexp">/simpleperf /</span>data<span class="regexp">/local/</span>tmp</div><div class="line">$adb shell</div><div class="line"><span class="string">angler:</span>/ $ run-<span class="keyword">as</span> com.example.sudogame</div><div class="line"><span class="string">angler:</span><span class="regexp">/data/</span>data/com.example.sudogame </div><div class="line">$ cp <span class="regexp">/data/</span>local<span class="regexp">/tmp/</span>simpleperf .</div></pre></td></tr></table></figure></p>
<h3 id="4-记录-perf-data"><a href="#4-记录-perf-data" class="headerlink" title="4. 记录 perf.data"></a>4. 记录 perf.data</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">angler:/data/data/com<span class="selector-class">.example</span><span class="selector-class">.sudogame</span> $./simpleperf record -<span class="selector-tag">p</span> <span class="number">10324</span> --duration <span class="number">30</span></div><div class="line">simpleperf I <span class="number">01</span>-<span class="number">01</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">39</span> <span class="number">10598</span> <span class="number">10598</span> cmd_record<span class="selector-class">.cpp</span>:<span class="number">341</span>] Samples recorded: <span class="number">49471</span>. Samples lost: <span class="number">0</span>.</div><div class="line">angler:/data/data/com<span class="selector-class">.example</span><span class="selector-class">.sudogame</span> <span class="variable">$ls</span> -lh perf<span class="selector-class">.data</span></div><div class="line">-rw-rw-rw- <span class="number">1</span> u0_a93 u0_a93 <span class="number">2.6</span>M <span class="number">2017</span>-<span class="number">01</span>-<span class="number">01</span> <span class="number">09</span>:<span class="number">26</span> perf.data</div></pre></td></tr></table></figure>
<p>在记录时不要忘记运行 app。否则，我们可能无法获得样本，由于进程仍在休眠。</p>
<h3 id="5-为-perf-data-生成报告"><a href="#5-为-perf-data-生成报告" class="headerlink" title="5. 为 perf.data 生成报告"></a>5. 为 perf.data 生成报告</h3><p>有不同的方式来为 perf.data 生成报告。下面展示了一些例子。</p>
<p>报告不同线程中的样本。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="string">angler:</span><span class="regexp">/data/</span>data<span class="regexp">/com.example.sudogame $./</span>simpleperf report --sort pid,tid,comm</div><div class="line"><span class="string">Cmdline:</span> <span class="regexp">/data/</span>data<span class="regexp">/com.example.sudogame/</span>simpleperf record -p <span class="number">10324</span> --duration <span class="number">30</span></div><div class="line"><span class="string">Arch:</span> arm64</div><div class="line"><span class="string">Event:</span> cpu-cycles (type <span class="number">0</span>, config <span class="number">0</span>)</div><div class="line"><span class="string">Samples:</span> <span class="number">49471</span></div><div class="line">Event <span class="string">count:</span> <span class="number">16700769019</span></div><div class="line"></div><div class="line">Overhead  Pid    Tid    Command</div><div class="line"><span class="number">66.31</span>%    <span class="number">10324</span>  <span class="number">10324</span>  xample.sudogame</div><div class="line"><span class="number">30.97</span>%    <span class="number">10324</span>  <span class="number">10340</span>  RenderThread</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>报告主线程中不同二进制文件中的样本。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">angler:</span>/data/data/com.example.sudogame $./simpleperf report --tids <span class="number">10324</span> --sort dso -n</div><div class="line">...</div><div class="line">Overhead  Sample  Shared Object</div><div class="line"><span class="number">37.71</span>%    <span class="number">9970</span>    /system/<span class="class"><span class="keyword">lib</span>/<span class="title">libc</span>.<span class="title">so</span></span></div><div class="line"><span class="number">35.45</span>%    <span class="number">9786</span>    [kernel.kallsyms]</div><div class="line"><span class="number">8.71</span>%     <span class="number">3305</span>    /system/<span class="class"><span class="keyword">lib</span>/<span class="title">libart</span>.<span class="title">so</span></span></div><div class="line"><span class="number">6.44</span>%     <span class="number">2405</span>    /system/framework/arm/boot-framework.oat</div><div class="line"><span class="number">5.64</span>%     <span class="number">1480</span>    /system/<span class="class"><span class="keyword">lib</span>/<span class="title">libcutils</span>.<span class="title">so</span></span></div><div class="line"><span class="number">1.55</span>%     <span class="number">426</span>     /data/app/com.example.sudogame-<span class="number">1</span>/<span class="class"><span class="keyword">lib</span>/<span class="title">arm</span>/<span class="title">libsudo</span>-<span class="title">game</span>-<span class="title">jni</span>.<span class="title">so</span></span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>报告主线程中 libsudo-game-jni.so 中的不同函数的采样。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">angler:/data/data/com<span class="selector-class">.example</span><span class="selector-class">.sudogame</span> $./simpleperf report --tids <span class="number">10324</span> --dsos  /data/app/com<span class="selector-class">.example</span><span class="selector-class">.sudogame-1</span>/lib/arm/libsudo-game-jni<span class="selector-class">.so</span> --sort symbol -n</div><div class="line">...</div><div class="line">Overhead  Sample  Symbol</div><div class="line"><span class="number">8.94%</span>     <span class="number">35</span>      libsudo-game-jni<span class="selector-class">.so</span>[+<span class="number">1</span>d54]</div><div class="line"><span class="number">5.71%</span>     <span class="number">25</span>      libsudo-game-jni<span class="selector-class">.so</span>[+<span class="number">1</span>dae]</div><div class="line"><span class="number">5.70%</span>     <span class="number">23</span>      @plt</div><div class="line"><span class="number">5.09%</span>     <span class="number">22</span>      libsudo-game-jni<span class="selector-class">.so</span>[+<span class="number">1</span>d88]</div><div class="line"><span class="number">4.54%</span>     <span class="number">19</span>      libsudo-game-jni<span class="selector-class">.so</span>[+<span class="number">1</span>d82]</div><div class="line"><span class="number">3.61%</span>     <span class="number">14</span>      libsudo-game-jni<span class="selector-class">.so</span>[+<span class="number">1</span>f3c]</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>在上面的结果中，大多数符号是 二进制文件名[+virual_addr] 的形式呈现。那是由于设备上使用的 libsudo-game-jni.so 已经抛离了 .symbol 段。我们可以将带有调试信息的 libsudo-game-jni.so 下载到设备上。在 android studio工程中，它位于 app/build/intermediates/binaries/debug/arm/obj/armeabi-v7a/libsudo-game-jni.so。我们不得不下载 libsudo-game-jni.so 到与 perf.data 中记录的相同的相对路径（否则，simpleperf无法找到它）。在这个例子中，是/data/app/com.example.sudogame-1/lib/arm/libsudo-game-jni.so。</p>
<p>为包含了调试信息的库使用的符号生成报告。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$adb push app/build/intermediates/binaries/debug/arm/obj/armeabi-v7a/libsudo-game-jni.so /data/local/tmp</div><div class="line">$adb shell</div><div class="line"><span class="symbol">angler:</span>/ $ run-<span class="keyword">as</span> com.example.sudogame</div><div class="line"><span class="symbol">angler:</span>/data/data/com.example.sudogame $ mkdir -p data/app/com.example.sudogame-<span class="number">1</span>/<span class="class"><span class="keyword">lib</span>/<span class="title">arm</span></span></div><div class="line"><span class="symbol">angler:</span>/data/data/com.example.sudogame $cp /data/local/tmp/libsudo-game-jni.so data/app/com.example.sudogame-<span class="number">1</span>/<span class="class"><span class="keyword">lib</span>/<span class="title">arm</span></span></div><div class="line"><span class="symbol">angler:</span>/data/data/com.example.sudogame $./simpleperf report --tids <span class="number">10324</span> --dsos  /data/app/com.example.sudogame-<span class="number">1</span>/<span class="class"><span class="keyword">lib</span>/<span class="title">arm</span>/<span class="title">libsudo</span>-<span class="title">game</span>-<span class="title">jni</span>.<span class="title">so</span> --<span class="title">sort</span> <span class="title">symbol</span> -<span class="title">n</span> --<span class="title">symfs</span> .</span></div><div class="line">...</div><div class="line">Overhead  Sample  Symbol</div><div class="line"><span class="number">75.18</span>%    <span class="number">317</span>     checkValid(Board const&amp;, int, int)</div><div class="line"><span class="number">14.43</span>%    <span class="number">60</span>      canFindSolution_r(Board&amp;, int, int)</div><div class="line"><span class="number">5.70</span>%     <span class="number">23</span>      @plt</div><div class="line"><span class="number">3.51</span>%     <span class="number">20</span>      randomBlock_r(Board&amp;, int, int, int, int, int)</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>报告一个函数中的采样。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">angler:</span>/data/data/com.example.sudogame $./simpleperf report --tids <span class="number">10324</span> --dsos  /data/app/com.example.sudogame-<span class="number">1</span>/<span class="class"><span class="keyword">lib</span>/<span class="title">arm</span>/<span class="title">libsudo</span>-<span class="title">game</span>-<span class="title">jni</span>.<span class="title">so</span> --<span class="title">symbols</span> “<span class="title">checkValid</span>(<span class="title">Board</span> <span class="title">const</span>&amp;, <span class="title">int</span>, <span class="title">int</span>)” --<span class="title">sort</span> <span class="title">vaddr_in_file</span> -<span class="title">n</span> --<span class="title">symfs</span> .</span></div><div class="line">...</div><div class="line">Overhead  Sample  VaddrInFile</div><div class="line"><span class="number">11.89</span>%    <span class="number">35</span>      <span class="number">0x1d54</span></div><div class="line"><span class="number">7.59</span>%     <span class="number">25</span>      <span class="number">0x1dae</span></div><div class="line"><span class="number">6.77</span>%     <span class="number">22</span>      <span class="number">0x1d88</span></div><div class="line"><span class="number">6.03</span>%     <span class="number">19</span>      <span class="number">0x1d82</span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<h3 id="6-记录并报告调用图"><a href="#6-记录并报告调用图" class="headerlink" title="6. 记录并报告调用图"></a>6. 记录并报告调用图</h3><p>调用图是显示了函数调用关系的树。下面是一个例子。<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">main() &#123;</div><div class="line">    FunctionOne();</div><div class="line">    FunctionTwo();</div><div class="line">&#125;</div><div class="line">FunctionOne() &#123;</div><div class="line">    FunctionTwo();</div><div class="line">    FunctionThree();</div><div class="line">&#125;</div><div class="line">callgraph:</div><div class="line">    main-&gt; FunctionOne</div><div class="line">       |<span class="string">    </span>|</div><div class="line">       |<span class="string">    </span>|<span class="string">-&gt; FunctionTwo</span></div><div class="line">       |<span class="string">    </span>|<span class="string">-&gt; FunctionThree</span></div><div class="line">       |</div><div class="line">       |<span class="string">-&gt; FunctionTwo</span></div></pre></td></tr></table></figure></p>
<h4 id="基于调用图记录-dwarf"><a href="#基于调用图记录-dwarf" class="headerlink" title="基于调用图记录 dwarf"></a><em>基于调用图记录 dwarf</em></h4><p>为了生成调用图，simpleperf 需要为每个记录生成调用链。Simpleperf 需要内核为每个记录转储用户栈和用户寄存器集，然后它追踪用户栈来查找函数调用链。为了解析调用链，它需要 dwarf 调用帧信息的支持，这些通常位于二进制文件的 .eh_frame 或 .debug_frame段。因此我们需要使用 –symfs 指出带有调试信息的 libsudo-game-jni.so 位于哪里。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">angler:/data/data/com<span class="selector-class">.example</span><span class="selector-class">.sudogame</span> </div><div class="line">$./simpleperf record -<span class="selector-tag">p</span> <span class="number">10324</span> -g --symfs . --duration <span class="number">30</span></div><div class="line">simpleperf I <span class="number">01</span>-<span class="number">01</span> <span class="number">09</span>:<span class="number">59</span>:<span class="number">42</span> <span class="number">11021</span> <span class="number">11021</span> cmd_record<span class="selector-class">.cpp</span>:<span class="number">341</span>] Samples recorded: <span class="number">60700</span>. Samples lost: <span class="number">1240</span>.</div></pre></td></tr></table></figure></p>
<p>注意内核无法转储 &gt;= 64K 的用户栈，因此基于调用图的 dwarf 不要包含消耗了 &gt;= 64K 栈的调用链。此外，由于我们需要转储每个记录的栈，则可能丢失一些记录。通常，失去一些记录没关系。</p>
<h4 id="基于调用图记录栈帧"><a href="#基于调用图记录栈帧" class="headerlink" title="基于调用图记录栈帧"></a><em>基于调用图记录栈帧</em></h4><p>另外一种生成调用图的方式依赖内核为每个记录解析调用链。为了使它成为可能，内核需要能够识别每个函数调用的栈帧。这不总是可能的，因为编译器可能优化掉栈帧，或内核无法识别使用的栈帧风格。因此它如何工作视情况而定（它在 arm64 上工作的很好，但在 arm 上不行）。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">angler:/data/data/com<span class="selector-class">.example</span><span class="selector-class">.sudogame</span> </div><div class="line">$./simpleperf record -<span class="selector-tag">p</span> <span class="number">10324</span> --call-graph fp --symfs . --duration <span class="number">30</span></div><div class="line">simpleperf I <span class="number">01</span>-<span class="number">01</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">58</span> <span class="number">11267</span> <span class="number">11267</span> cmd_record<span class="selector-class">.cpp</span>:<span class="number">341</span>] Samples recorded: <span class="number">56736</span>. Samples lost: <span class="number">0</span>.</div></pre></td></tr></table></figure></p>
<h4 id="报告调用图"><a href="#报告调用图" class="headerlink" title="报告调用图"></a><em>报告调用图</em></h4><p>报告累积的周期。在下面的表中，第一列是 “Children”，它是函数及那个函数调用的函数所占的cpu 周期百分比。第二列是 “Self”，它只是一个函数的cpu 周期百分比。比如，checkValid() 自身消耗 1.28% 的 cpus，但通过运行它自身及调用其它函数，它消耗了 29.43%。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">angler:</span>/data/data/com.example.sudogame $./simpleperf report --children --symfs .</div><div class="line">...</div><div class="line">Children  Self   Command          Pid    Tid    Shared Object                                                 Symbol</div><div class="line"><span class="number">31.94</span>%    <span class="number">0.00</span>%  xample.sudogame  <span class="number">10324</span>  <span class="number">10324</span>  [kernel.kallsyms]                                             [kernel.kallsyms][+ffffffc000204268]</div><div class="line"><span class="number">31.10</span>%    <span class="number">0.92</span>%  xample.sudogame  <span class="number">10324</span>  <span class="number">10324</span>  /system/<span class="class"><span class="keyword">lib</span>/<span class="title">libc</span>.<span class="title">so</span>                                           <span class="title">writev</span></span></div><div class="line"><span class="number">29.43</span>%    <span class="number">1.28</span>%  xample.sudogame  <span class="number">10324</span>  <span class="number">10324</span>  /data/app/com.example.sudogame-<span class="number">1</span>/<span class="class"><span class="keyword">lib</span>/<span class="title">arm</span>/<span class="title">libsudo</span>-<span class="title">game</span>-<span class="title">jni</span>.<span class="title">so</span>  <span class="title">checkValid</span>(<span class="title">Board</span> <span class="title">const</span>&amp;, <span class="title">int</span>, <span class="title">int</span>)</span></div><div class="line"><span class="number">28.43</span>%    <span class="number">0.34</span>%  xample.sudogame  <span class="number">10324</span>  <span class="number">10324</span>  /system/<span class="class"><span class="keyword">lib</span>/<span class="title">liblog</span>.<span class="title">so</span>                                         <span class="title">__android_log_print</span></span></div><div class="line"><span class="number">28.24</span>%    <span class="number">0.00</span>%  xample.sudogame  <span class="number">10324</span>  <span class="number">10324</span>  /system/<span class="class"><span class="keyword">lib</span>/<span class="title">libcutils</span>.<span class="title">so</span>                                      <span class="title">libcutils</span>.<span class="title">so</span>[+107<span class="title">b7</span>]</span></div><div class="line"><span class="number">28.10</span>%    <span class="number">0.27</span>%  xample.sudogame  <span class="number">10324</span>  <span class="number">10324</span>  /data/app/com.example.sudogame-<span class="number">1</span>/<span class="class"><span class="keyword">lib</span>/<span class="title">arm</span>/<span class="title">libsudo</span>-<span class="title">game</span>-<span class="title">jni</span>.<span class="title">so</span>  <span class="title">canFindSolution_r</span>(<span class="title">Board</span>&amp;, <span class="title">int</span>, <span class="title">int</span>)</span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>报告调用图。<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="title">angler</span>:/<span class="class"><span class="keyword">data</span>/<span class="keyword">data</span>/com.example.sudogame $./simpleperf report -g <span class="comment">--symfs . &gt;report</span></span></div><div class="line"><span class="title">angler</span>:/<span class="class"><span class="keyword">data</span>/<span class="keyword">data</span>/com.example.sudogame $exit</span></div><div class="line"><span class="title">angler</span>:/ $cp /<span class="class"><span class="keyword">data</span>/<span class="keyword">data</span>/com.example.sudogame/report /<span class="keyword">data</span>/local/tmp</span></div><div class="line"><span class="title">angler</span>:/ $exit</div><div class="line">$adb pull /<span class="class"><span class="keyword">data</span>/local/tmp/report .</span></div><div class="line">$cat report</div><div class="line">...</div><div class="line"><span class="number">29.43</span>%    <span class="number">1.28</span>%  xample.sudogame  <span class="number">10324</span>  <span class="number">10324</span>  /<span class="class"><span class="keyword">data</span>/app/com.example.sudogame-1/lib/arm/libsudo-game-jni.so  checkValid(<span class="type">Board</span> <span class="title">const</span>&amp;, <span class="title">int</span>, <span class="title">int</span>)</span></div><div class="line">       |</div><div class="line">       <span class="comment">-- checkValid(Board const&amp;, int, int)</span></div><div class="line">          |</div><div class="line">          |<span class="comment">--95.50%-- __android_log_print</span></div><div class="line">          |    |<span class="comment">--0.68%-- [hit in function]</span></div><div class="line">          |    |</div><div class="line">          |    |<span class="comment">--51.84%-- __android_log_buf_write</span></div><div class="line">          |    |    |<span class="comment">--2.07%-- [hit in function]</span></div><div class="line">          |    |    |</div><div class="line">          |    |    |<span class="comment">--30.74%-- libcutils.so[+c69d]</span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>以 callee 模式报告调用图。我们还可以展示一个函数是如何被其它函数调用的。<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">angler:/data/data/com.example.sudogame $./simpleperf report -g callee --symfs . &gt;report</div><div class="line">$adb shell run-as com.example.sudogame cat report &gt;report</div><div class="line">$cat report</div><div class="line">…</div><div class="line">28.43%    0.34%  xample.sudogame  10324  10324  /system/lib/liblog.so                                         __android_log_print</div><div class="line">       |<span class="string"></span></div><div class="line">       -- __android_log_print</div><div class="line">          |</div><div class="line">          |<span class="string">--97.82%-- checkValid(Board const&amp;, int, int)</span></div><div class="line">          |<span class="string">    </span>|<span class="string">--0.13%-- [hit in function]</span></div><div class="line">          |<span class="string">    </span>|</div><div class="line">          |<span class="string">    </span>|<span class="string">--94.89%-- canFindSolution_r(Board&amp;, int, int)</span></div><div class="line">          |<span class="string">    </span>|<span class="string">    </span>|<span class="string">--0.01%-- [hit in function]</span></div><div class="line">          |<span class="string">    </span>|<span class="string">    </span>|</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h1 id="剖析-Java-代码"><a href="#剖析-Java-代码" class="headerlink" title="剖析 Java 代码"></a>剖析 Java 代码</h1><p>Simpleperf 只支持剖析 ELF 格式二进制文件中的本地指令。如果 java 代码由解释器执行，或使用 jit 缓存，则它不能由 simpleperf 剖析。由于 Android 支持提前编译，它可以将 java 字节码编译为包含调试信息的本地层指令。在 Android 版本 &lt;= M 的设备上，我们需要 root 权限来编译包含调试信息的 java 字节码。然而，在 Android 版本 &gt;= N 的设备上，我们无需 root 权限就可以做这些。</p>
<h2 id="在Android-N上"><a href="#在Android-N上" class="headerlink" title="在Android N上"></a>在Android N上</h2><h3 id="1-将-java-代码完整编译为本地层指令。"><a href="#1-将-java-代码完整编译为本地层指令。" class="headerlink" title="1. 将 java 代码完整编译为本地层指令。"></a><em>1. 将 java 代码完整编译为本地层指令。</em></h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$adb</span> shell setprop debug<span class="selector-class">.generate-debug-info</span> true</div><div class="line"><span class="variable">$adb</span> shell cmd package compile -f -m speed com<span class="selector-class">.example</span><span class="selector-class">.sudogame</span></div><div class="line"><span class="comment">// restart the app to take effect</span></div></pre></td></tr></table></figure>
<h3 id="2-记录-perf-data"><a href="#2-记录-perf-data" class="headerlink" title="2. 记录 perf.data"></a><em>2. 记录 perf.data</em></h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">angler:/data/data/com<span class="selector-class">.example</span><span class="selector-class">.sudogame</span> </div><div class="line">$./simpleperf record -<span class="selector-tag">p</span> <span class="number">11826</span> -g --symfs . --duration <span class="number">30</span></div><div class="line">simpleperf I <span class="number">01</span>-<span class="number">01</span> <span class="number">10</span>:<span class="number">31</span>:<span class="number">40</span> <span class="number">11859</span> <span class="number">11859</span> cmd_record<span class="selector-class">.cpp</span>:<span class="number">341</span>] Samples recorded: <span class="number">50576</span>. Samples lost: <span class="number">2139</span>.</div></pre></td></tr></table></figure>
<h3 id="3-为-perf-data-生成报告"><a href="#3-为-perf-data-生成报告" class="headerlink" title="3. 为 perf.data 生成报告"></a><em>3. 为 perf.data 生成报告</em></h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">angler:/data/data/com.example.sudogame $./simpleperf report -g --symfs . &gt;report</div><div class="line">angler:/data/data/com.example.sudogame $exit</div><div class="line">angler:/ $cp /data/data/com.example.sudogame/report /data/local/tmp</div><div class="line">angler:/ $exit</div><div class="line">$adb pull /data/local/tmp/report .</div><div class="line">$cat report</div><div class="line">...</div><div class="line">21.14%    0.00%  xample.sudogame  11826  11826  /data/app/com.example.sudogame-1/oat/arm/base.odex            boolean com.example.sudogame.MainActivity.onOptionsItemSelected(android.view.MenuItem)</div><div class="line">       |<span class="string"></span></div><div class="line">       -- boolean com.example.sudogame.MainActivity.onOptionsItemSelected(android.view.MenuItem)</div><div class="line">          |</div><div class="line">           --99.99%-- void com.example.sudogame.GameView.startNewGame()</div><div class="line">               |<span class="string">--0.01%-- [hit in function]</span></div><div class="line">               |</div><div class="line">               |<span class="string">--99.87%-- void com.example.sudogame.GameModel.reInit()</span></div><div class="line">               |<span class="string">    </span>|<span class="string">--0.01%-- [hit in function]</span></div><div class="line">               |<span class="string">    </span>|</div><div class="line">               |<span class="string">    </span>|<span class="string">--89.65%-- boolean com.example.sudogame.GameModel.canFindSolution(int[][])</span></div><div class="line">               |<span class="string">    </span>|<span class="string">    </span>|</div><div class="line">               |<span class="string">    </span>|<span class="string">    </span>|<span class="string">--99.95%-- Java_com_example_sudogame_GameModel_canFindSolution</span></div><div class="line">               |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|</div><div class="line">               |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">--99.49%-- canFindSolution(Board&amp;)</span></div><div class="line">               |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">--0.01%-- [hit in function]</span></div><div class="line">               |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|</div><div class="line">               |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">--99.97%-- canFindSolution_r(Board&amp;, int, int)</span></div><div class="line">               |<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">           canFindSolution_r(Board&amp;, int, int)</span></div><div class="line">...</div></pre></td></tr></table></figure>
<h2 id="在-Android-M上"><a href="#在-Android-M上" class="headerlink" title="在 Android M上"></a>在 Android M上</h2><p>在 M 设备上，我们需要 root 权限来强制 Android 将 java 代码完全编译为带调试信息的 ELF 二进制文件中的本地层指令。我们还需要 root 权限来读取编译后的本地层二进制文件（由于 installd 将它们写到了一个 uid/gid 是 system:install的目录下）。因而剖析 java 代码只能在 root 了的设备上完成。<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$adb</span> root</div><div class="line"><span class="variable">$adb</span> <span class="keyword">shell</span> setprop dalvik.vm.dex2oat-flags -<span class="keyword">g</span></div><div class="line"></div><div class="line"># Reinstall the <span class="keyword">app</span>.</div><div class="line"><span class="variable">$adb</span> install -r <span class="keyword">app</span>-debug.apk</div><div class="line"></div><div class="line"># Change to the <span class="keyword">app</span>’s data directory.</div><div class="line">$ adb root &amp;&amp; adb <span class="keyword">shell</span></div><div class="line">device# <span class="keyword">cd</span> `<span class="keyword">run</span>-<span class="keyword">as</span> com.example.sudogame <span class="keyword">pwd</span>`</div><div class="line"></div><div class="line"># Record <span class="keyword">as</span> root <span class="keyword">as</span> simpleperf needs to <span class="keyword">read</span> the generated native binary.</div><div class="line">device#./simpleperf record -p 25636 -<span class="keyword">g</span> --symfs . -f 1000 --duration 30</div><div class="line">simpleperf I 01-02 07:18:20 27182 27182 cmd_record.cpp:323] Samples recorded: 23552. Samples lost: 39.</div></pre></td></tr></table></figure></p>
<h2 id="在-Android-L上"><a href="#在-Android-L上" class="headerlink" title="在 Android L上"></a>在 Android L上</h2><p>在 L 设备上，我们也需要 root 权限来编译带调试信息的 app 并访问本地层二进制文件。<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$adb</span> root</div><div class="line"><span class="variable">$adb</span> <span class="keyword">shell</span> setprop dalvik.vm.dex2oat-flags --<span class="keyword">include</span>-debug-symbols</div><div class="line"></div><div class="line"># Reinstall the <span class="keyword">app</span>.</div><div class="line"><span class="variable">$adb</span> install -r <span class="keyword">app</span>-debug.apk</div></pre></td></tr></table></figure></p>
<h1 id="使用脚本剖析"><a href="#使用脚本剖析" class="headerlink" title="使用脚本剖析"></a>使用脚本剖析</h1><p>尽管使用命令行很灵活，但它可能太复杂了。因而我们提供了 pthon 脚本来帮助运行命令。</p>
<h2 id="使用-app-profiler-py-记录"><a href="#使用-app-profiler-py-记录" class="headerlink" title="使用 app_profiler.py 记录"></a>使用 app_profiler.py 记录</h2><p>app_profiler.py 用于剖析 Android 应用程序。它设置剖析环境，下载 simpleperf 和带有调试信息的本地层库，运行 simpleperf 产生 perf.data，并从设备上将 perf.data 和二进制文件拉到主机上。它由 app_profiler.config 配置。下面是一个例子。</p>
<p>app_profiler.config:<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">app_package_name</span> = “com.example.sudogame”</div><div class="line"><span class="attr">android_studio_project_dir</span> = “/AndroidStudioProjects/SudoGame”  <span class="comment"># absolute path of the project</span></div><div class="line">...</div><div class="line"><span class="attr">record_options</span> = <span class="string">"-e cpu-cycles:u -f 4000 -g --dump-symbols --duration 30"</span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>运行 app_profiler.py:<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$<span class="keyword">python</span> app_profiler.<span class="keyword">py</span></div><div class="line">...</div><div class="line">INFO:roo<span class="variable">t:profiling</span> <span class="keyword">is</span> finished.</div></pre></td></tr></table></figure></p>
<p>它将生成的 perf.data 拉到主机上，并从设备的 binary_cache 中收集二进制文件。</p>
<h2 id="使用-report-py-生成报告"><a href="#使用-report-py-生成报告" class="headerlink" title="使用 report.py 生成报告"></a>使用 report.py 生成报告</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$python</span> report<span class="selector-class">.py</span> -g</div></pre></td></tr></table></figure>
<p>它生成一个GUI接口来报告数据。</p>
<h2 id="使用-simpleperf-report-lib-py-处理样本"><a href="#使用-simpleperf-report-lib-py-处理样本" class="headerlink" title="使用 simpleperf_report_lib.py 处理样本"></a>使用 simpleperf_report_lib.py 处理样本</h2><p>simpleperf_report_lib.py 提供了一个接口从 perf.data 读取样本。一个例子是 report_sample.py。</p>
<h3 id="展示流程图"><a href="#展示流程图" class="headerlink" title="展示流程图"></a>展示流程图</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$python</span> report_sample<span class="selector-class">.py</span> &gt;out<span class="selector-class">.perf</span></div><div class="line"><span class="variable">$stackcollapse</span>-perf<span class="selector-class">.pl</span> out<span class="selector-class">.perf</span> &gt;out<span class="selector-class">.folded</span></div><div class="line">$./flamegraph<span class="selector-class">.pl</span> out<span class="selector-class">.folded</span> &gt;<span class="selector-tag">a</span>.svg</div></pre></td></tr></table></figure>
<h2 id="注解源代码"><a href="#注解源代码" class="headerlink" title="注解源代码"></a>注解源代码</h2><p>annotate.py 读取 perf.data 和 binary_cache 下的二进制文件。然后它知道每个样本命中哪个 源文件:line。因此它可以注解源代码。annotate.py 由 annotate.config 配置。下面是一个例子。</p>
<p>annotate.config:<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">source_dirs = [“/<span class="symbol">AndroidStudio</span>/<span class="symbol">SudoGame</span>”]  # <span class="symbol">It</span> is a directory containing source code.</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>运行 annotate.py:<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta"><span class="meta-keyword">$python</span> annotate.py</span></div></pre></td></tr></table></figure></p>
<p>它生成 annotated_files 目录。 annotated_files/summary 文件包含每个源文件的概要信息。例子如下。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/AndroidStudioProjects/</span>SudoGame<span class="regexp">/app/</span>src<span class="regexp">/main/</span>jni/sudo-game-jni.<span class="string">cpp:</span> <span class="string">accumulated_period:</span> <span class="number">25.587937</span>%, <span class="string">period:</span> <span class="number">1.250961</span>%</div><div class="line">  function (checkValid(Board const&amp;, <span class="keyword">int</span>, <span class="keyword">int</span>)): line <span class="number">99</span>, <span class="string">accumulated_period:</span> <span class="number">23.564356</span>%, <span class="string">period:</span> <span class="number">0.908457</span>%</div><div class="line">  function (canFindSolution_r(Board&amp;, <span class="keyword">int</span>, <span class="keyword">int</span>)): line <span class="number">135</span>, <span class="string">accumulated_period:</span> <span class="number">22.260125</span>%, <span class="string">period:</span> <span class="number">0.142359</span>%</div><div class="line">  function (canFindSolution(Board&amp;)): line <span class="number">166</span>, <span class="string">accumulated_period:</span> <span class="number">22.233101</span>%, <span class="string">period:</span> <span class="number">0.000000</span>%</div><div class="line">  function (Java_com_example_sudogame_GameModel_canFindSolution): line <span class="number">470</span>, <span class="string">accumulated_period:</span> <span class="number">21.983184</span>%, <span class="string">period:</span> <span class="number">0.000000</span>%</div><div class="line">  function (Java_com_example_sudogame_GameModel_initRandomBoard): line <span class="number">430</span>, <span class="string">accumulated_period:</span> <span class="number">2.226896</span>%, <span class="string">period:</span> <span class="number">0.000000</span>%</div><div class="line"></div><div class="line">  line <span class="number">27</span>: <span class="string">accumulated_period:</span> <span class="number">0.011729</span>%, <span class="string">period:</span> <span class="number">0.000000</span>%</div><div class="line">  line <span class="number">32</span>: <span class="string">accumulated_period:</span> <span class="number">0.004362</span>%, <span class="string">period:</span> <span class="number">0.000000</span>%</div><div class="line">  line <span class="number">33</span>: <span class="string">accumulated_period:</span> <span class="number">0.004427</span>%, <span class="string">period:</span> <span class="number">0.000000</span>%</div><div class="line">  line <span class="number">36</span>: <span class="string">accumulated_period:</span> <span class="number">0.003303</span>%, <span class="string">period:</span> <span class="number">0.000000</span>%</div><div class="line">  line <span class="number">39</span>: <span class="string">accumulated_period:</span> <span class="number">0.010367</span>%, <span class="string">period:</span> <span class="number">0.004123</span>%</div><div class="line">  line <span class="number">41</span>: <span class="string">accumulated_period:</span> <span class="number">0.162219</span>%, <span class="string">period:</span> <span class="number">0.000000</span>%</div></pre></td></tr></table></figure></p>
<p>annotated_files/ 还包含由 annotate.py 找到的经过注解的源文件。比如， libsudo-game-jni.cpp 中的 checkValid() 函数的一部分注解后如下。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* [func] acc_p: 23.564356%, p: 0.908457% */</span><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">checkValid</span><span class="params">(<span class="keyword">const</span> Board&amp; board, <span class="keyword">int</span> curR, <span class="keyword">int</span> curC)</span> </span>&#123;</div><div class="line"><span class="comment">/* acc_p: 0.037933%, p: 0.037933%         */</span>    <span class="keyword">int</span> digit = board.digits[curR][curC];</div><div class="line"><span class="comment">/* acc_p: 0.162355%, p: 0.162355%         */</span>    <span class="keyword">for</span> (<span class="keyword">int</span> r = <span class="number">0</span>; r &lt; BOARD_ROWS; ++r) &#123;</div><div class="line"><span class="comment">/* acc_p: 0.020880%, p: 0.020880%         */</span>        <span class="keyword">if</span> (r == curR) &#123;</div><div class="line"><span class="comment">/* acc_p: 0.034691%, p: 0.034691%         */</span>            <span class="keyword">continue</span>;</div><div class="line">                                                    &#125;</div><div class="line"><span class="comment">/* acc_p: 0.176490%, p: 0.176490%         */</span>        <span class="keyword">if</span> (board.digits[r][curC] == digit) &#123;</div><div class="line"><span class="comment">/* acc_p: 14.957673%, p: 0.059022%        */</span>            LOGI(<span class="string">"conflict (%d, %d) (%d, %d)"</span>, curR, curC, r, curC);</div><div class="line"><span class="comment">/* acc_p: 0.016296%, p: 0.016296%         */</span>            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">                                                    &#125;</div><div class="line">                                                &#125;</div></pre></td></tr></table></figure></p>
<p><a href="https://android.googlesource.com/platform/system/extras/+/master/simpleperf/README.md" target="_blank" rel="external">原文地址</a></p>
</div><div class="tags"><a href="/tags/Android开发/">Android开发</a><a href="/tags/翻译/">翻译</a></div><div class="post-nav"><a href="/2017/02/22/introduction_to_android_things/" class="pre">Android Things介绍</a><a href="/2017/02/16/Wireshark源码安装/" class="next">Wireshark源码安装</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android-图形系统/">Android 图形系统</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">31</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/01/anbox_container_manager_service/">Anbox 容器管理服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/28/run_anbox/">运行 Anbox</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/28/Anbox/">Anbox</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/24/gerrit_codereview/">Gerrit代码审核服务器搭建全过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/20/adb_overview/">关于 ADB 实现的说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/adb-standalone/">adb standalone</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/31/qcow2_on_linux/">在 Linux 上如何挂载 qcow2 磁盘镜像</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/21/android_graphics_gralloc/">Android 图形系统之gralloc</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/20/android_graphics_bufferalloc/">Android 图形系统之图形缓冲区分配</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/16/opengles_android_emulation/">Android 硬件 OpenGL ES 模拟设计概述</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2017/02/21/Simpleperf_Introduction/';
var disqus_title = 'Simpleperf介绍';
var disqus_url = 'https://www.wolfcstech.com/2017/02/21/Simpleperf_Introduction/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-109419024-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>