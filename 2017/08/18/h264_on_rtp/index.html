<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="mask-icon" href="/images/freesoft.jpg?v=6.0.3" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="翻译,音视频开发," />


<meta name="description" content="本文是 IETF 的规范 RFC 6184 的一部分的翻译，该规范 地址。翻译这份文档，主要是为了编写一段用 RTP 传输 H.264 流的代码。本想在网上找一些文章完成任务了事的，但由于个人之前音视频编解码相关的知识比较匮乏，网上找的文章大都没有办法把我的问题讲的很详细很明确，所以就找来了这份 IETF 的规范来学习。">
<meta property="og:type" content="article">
<meta property="og:title" content="H.264 视频的 RTP 载荷格式">
<meta property="og:url" content="https://www.wolfcstech.com/2017/08/18/h264_on_rtp/index.html">
<meta property="og:site_name" content="WolfcsTech">
<meta property="og:description" content="本文是 IETF 的规范 RFC 6184 的一部分的翻译，该规范 地址。翻译这份文档，主要是为了编写一段用 RTP 传输 H.264 流的代码。本想在网上找一些文章完成任务了事的，但由于个人之前音视频编解码相关的知识比较匮乏，网上找的文章大都没有办法把我的问题讲的很详细很明确，所以就找来了这份 IETF 的规范来学习。">
<meta property="og:image" content="https://www.wolfcstech.com/images/1315506-475027950d4a524d.png">
<meta property="og:updated_time" content="2017-08-25T11:25:55.101Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="H.264 视频的 RTP 载荷格式">
<meta name="twitter:description" content="本文是 IETF 的规范 RFC 6184 的一部分的翻译，该规范 地址。翻译这份文档，主要是为了编写一段用 RTP 传输 H.264 流的代码。本想在网上找一些文章完成任务了事的，但由于个人之前音视频编解码相关的知识比较匮乏，网上找的文章大都没有办法把我的问题讲的很详细很明确，所以就找来了这份 IETF 的规范来学习。">
<meta name="twitter:image" content="https://www.wolfcstech.com/images/1315506-475027950d4a524d.png">






  <link rel="canonical" href="https://www.wolfcstech.com/2017/08/18/h264_on_rtp/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>H.264 视频的 RTP 载荷格式 | WolfcsTech</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-109419024-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-109419024-1');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WolfcsTech</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="http://www.ixirong.com/404.html" rel="section">
            <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />Commonweal 404</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.wolfcstech.com/2017/08/18/h264_on_rtp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Han Pengfei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/freesoft.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WolfcsTech">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">H.264 视频的 RTP 载荷格式</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-18T22:05:49+08:00">2017-08-18</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/音视频开发/" itemprop="url" rel="index"><span itemprop="name">音视频开发</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/18/h264_on_rtp/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2017/08/18/h264_on_rtp/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/18/h264_on_rtp/" class="leancloud_visitors" data-flag-title="H.264 视频的 RTP 载荷格式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>本文是 IETF 的规范 RFC 6184 的一部分的翻译，该规范 <a href="https://tools.ietf.org/html/rfc6184" target="_blank" rel="external">地址</a>。翻译这份文档，主要是为了编写一段用 RTP 传输 H.264 流的代码。本想在网上找一些文章完成任务了事的，但由于个人之前音视频编解码相关的知识比较匮乏，网上找的文章大都没有办法把我的问题讲的很详细很明确，所以就找来了这份 IETF 的规范来学习。<br><a id="more"></a><br>当然翻译这份文档的另外的原因是，我认为关于软件开发某些方面的知识，最为权威、准确且可靠的来源大概就是源码、规范和官方文档了，其它的信息源，无论是博客还是书籍，都很有可能存在着误解和不准确的地方。为了让自己能够学到更加权威可靠的知识，而翻译了这份文档。</p>
<p>RFC 6184这份规范本身比较长，我实在是没有那么多的时间与精力把这份规范全部翻译完，于是就只是翻译了与编写用 RTP/RTCP 协议传输原始 H.264 码流的代码最为相关的几个部分。</p>
<p>下面的内容都翻译自 RFC 6184。</p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>这份备忘录描述了 ITU-T Recommendation H.264 视频编解码和技术的相应 ISO/IEC 国际标准 14496-10 视频编解码的 RTP 载荷格式，不包括 Scalable Video Coding (SVC) 扩展和 Multiview Video Coding 扩展，它们的 RTP 载荷格式在其它地方定义。RTP 载荷格式允许在每个 RTP 载荷中，打包一个或多个由 H.264 视频编码器产生的 Network Abstraction Layer Units (NALUs)。有效载荷格式具有广泛的适用性，它支持从简单的低比特率对话使用，到具有交错传输的因特网视频流，到高比特率视频点播的应用。</p>
<p>这份备忘录废弃 <a href="https://tools.ietf.org/html/rfc3984" target="_blank" rel="external">RFC 3984</a>。<a href="https://tools.ietf.org/html/rfc6184#section-14" target="_blank" rel="external">14 小节</a> 总结了自 <a href="https://tools.ietf.org/html/rfc3984" target="_blank" rel="external">RFC 3984</a> 以来的改变。<a href="https://tools.ietf.org/html/rfc6184#section-15" target="_blank" rel="external">15 小节</a> 讨论了到 <a href="https://tools.ietf.org/html/rfc3984" target="_blank" rel="external">RFC 3984</a> 的向后兼容性。</p>
<h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h1><p>这份备忘录描述了称为 ITU-T Recommendation H.264 和 ISO/IEC 国际标准 14496-10 （均被称为高级视频编码 (AVC)）的视频编码标准的 RTP 载荷规范。在这份备忘录中，名字 H.264 用于编解码器和标准，但是这个备忘录同样适用于编码标准的 ISO / IEC 对应物。</p>
<p>这份备忘录废弃 <a href="https://tools.ietf.org/html/rfc3984" target="_blank" rel="external">RFC 3984</a>。<a href="https://tools.ietf.org/html/rfc6184#section-14" target="_blank" rel="external">14 小节</a> 总结了自 <a href="https://tools.ietf.org/html/rfc3984" target="_blank" rel="external">RFC 3984</a> 以来的改变。<a href="https://tools.ietf.org/html/rfc6184#section-15" target="_blank" rel="external">15 小节</a> 讨论了到 <a href="https://tools.ietf.org/html/rfc3984" target="_blank" rel="external">RFC 3984</a> 的向后兼容性。</p>
<h2 id="1-1-H-264-Codec"><a href="#1-1-H-264-Codec" class="headerlink" title="1.1 H.264 Codec"></a>1.1 H.264 Codec</h2><p>H.264 视频编解码具有广泛的应用范围，其覆盖了所有形式的数字压缩视频，从低比特率的互联网流应用到 HDTV 广播到几乎无损编码的数字影院应用。对比当前的技术状态，H.264 的总体性能是，据报告比特率节省 50% 或更多。比如据报告，数字卫星 TV 质量，可达到 1.5 Bbit/s，对比当前操作点 MPEG-2 视频在大约 3.5 Mbit/s。</p>
<p>Codec 规范本身在概念上区分视频编码层 (VCL) 和网络抽象层 (NAL)。VCL 包含 codec 的信号处理功能；诸如变换，量化和运动补偿预测的机制；和环路滤波器。它遵循当今大多数视频编解码器的一般概念，这是基于宏块的编码器，一个基于宏块的编码器使用图像预测，其使用具有运动补偿的帧间预测和残差信号的变换编码。VCL 编码器输出 slices：包含整数个宏块的宏块数据的位串和 slice 头部信息（包含 slice 中第一个宏块的空间地址，初始的量化参数，及类似的信息）。Slice 中的宏块以扫描的顺序排列，除非使用 slice<br> 组语法指定了不同的宏块分配。图像预测只被用于 slice 内。更多信息在 Introduction to the special issue on the H.264/AVC video coding standard 中提供。</p>
<p>NAL 编码器把 VCL 编码器的 slice 输出封装进网络抽象层单元（NALUs），其适合于通过分组网络传输，或在面向分组的多种环境下使用。H.264 的附录 B 定义了通过面向流的网络传输这样的 NALU 的封装过程。本备忘录范围内，与附录 B 无关。</p>
<p>在内部，NAL 使用 NAL 单元。NAL 单元由一个字节的头部和载荷字节串组成。头部说明了 NAL 单元的类型，NAL 单元载荷中（潜在地）出现的位错误或语法违规，及对于解码过程而言 NAL 单元的相对重要性的信息。本 RTP 载荷规范被设计为对 NAL 单元载荷中的位串无感知。</p>
<p>H.264 的一个主要属性是完全解耦 slice 和图像的传输时间，解码时间，和采样或呈现时间。H.264 中描述的解码过程对时间无意识，而且 H.264 语法不携带诸如跳过的帧数（像在更早的视频压缩标准中常见的时间参照这样的形式）这样的信息。此外，还有 NAL 单位影响许多图片，因此是本质上是没有时间的。基于采样和呈现时间没有定义，或传输时间未知这些原因，NAL 单元的 RTP 时间戳的处理需要一些特殊的考虑。</p>
<h2 id="1-2-参数集概念"><a href="#1-2-参数集概念" class="headerlink" title="1.2 参数集概念"></a>1.2 参数集概念</h2><p>H.264 的一个非常基本的设计概念是生成自包含包，使得不再需要诸如 <a href="https://tools.ietf.org/html/rfc4629" target="_blank" rel="external">RFC 4629</a> 的头部复制或 MPEG-4 视觉的头部扩展码 (HEC) 这样的机制。这是通过从媒体流中去除与多个 slice 相关的信息来实现的。这个更高层的 meta 信息应该能够从包含 slice 包的 RTP 包流中被可靠地异步地预先发送出去。（带内发送此信息的规定也适用于不具有为了实现此目的的适当的带外传输通道的应用）。更高层参数的结合称为参数集。H.264 规范包含两种类型的参数机：序列参数集和图像参数集。有效的序列参数集在整个编码的视频序列中保持不变，而有效的图像参数集在一个编码的图像内保持不变。序列和图像参数集结构包含了诸如图像大小，可选的所用的编码模式，和宏块到 slice 组的映射这样的信息。</p>
<p>为了能够修改图像参数（比如图像大小）而无需同步地传输参数集合更新给 slice 包流，编码器和解码器可以维护一个多于一个序列和图像参数集合的列表。每个 slice 头部包含一个编码字，来指示要使用的序列和图像参数集。</p>
<p>这种机制允许将参数集合的传输从包流的传输中解耦出来，并通过外部的方法（比如，作为能力交换的一部分）或通过一个控制协议（可靠的或不可靠的）传输它们。甚至可能不传输它们，但通过应用设计规范来固定。</p>
<h2 id="1-3-网络抽象层单元类型"><a href="#1-3-网络抽象层单元类型" class="headerlink" title="1.3 网络抽象层单元类型"></a>1.3 网络抽象层单元类型</h2><p>关于 NAL 设计的教程信息可以在 “H.264/AVC over IP”，“H.26L over IP: The IP-Network Adaptation Layer” 和 “H.26L/JVT Coding Network Abstraction Layer and IP-Based Transport” 等几份文档中找到。</p>
<p>所有的 NAL 单元由单个 NAL 单元类型字节组成，其共同作为该 RTP 载荷格式的载荷头部。NAL 单元载荷的描述如下。</p>
<p>NAL 单元类型字节的语法和语义在 ITU-T Recommendation H.264 中描述，但 NAL 单元类型字节的必要属性总结如下。NAL 单元类型字节具有如下的格式：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="code">+---------------+</span></div><div class="line"><span class="section">|0|1|2|3|4|5|6|7|</span></div><div class="line">+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|F|NRI|  Type   |</span></div><div class="line">+---------------+</div></pre></td></tr></table></figure>
<p>NAL 单元类型字节的组件的语义，如 H.264规范所定，清晰地描述如下：</p>
<ul>
<li><p>F：1 位<br>forbidden_zero_bit。H.264 规范声明值为 1 表示语法违规。</p>
</li>
<li><p>NRI：2 位<br>nal_ref_idc。值为 00 表示 NAL 单元的内容不被用于重建图像预测的参考图像。这种 NAL 单元可以被丢弃而不危及参考图像的完整性。大于 00 的值表示需要解码该 NAL 单元来维护参考图像的完整性。</p>
</li>
<li><p>Type：5 位<br>nal_unit_type。这个组件指定 NAL 单元载荷的类型，如 ITU-T Recommendation H.264 的表 7-1 和本备忘录后面所定义的那样。要参考当前所有已定义 NAL 单元类型和它们的语义，请参考 ITU-T Recommendation H.264 的 <a href="https://tools.ietf.org/html/rfc6184#section-7.4.1" target="_blank" rel="external">7.4.1 节</a>。</p>
</li>
</ul>
<p>本备忘录引入了新的 NAL 单元类型，它们在 <a href="https://tools.ietf.org/html/rfc6184#section-5.2" target="_blank" rel="external">5.2 节</a> 中说明。本备忘录中定义的 NAL 单元类型被标记为 ITU-T Recommendation H.264 中的 unspecified。此外，本规范扩展了 F 和 NRI 的语义，如 <a href="https://tools.ietf.org/html/rfc6184#section-5.3" target="_blank" rel="external">5.3 节</a> 所述。</p>
<h1 id="5-载荷格式"><a href="#5-载荷格式" class="headerlink" title="5. 载荷格式"></a>5. 载荷格式</h1><h2 id="5-1-RTP-Header-用法"><a href="#5-1-RTP-Header-用法" class="headerlink" title="5.1 RTP Header 用法"></a>5.1 RTP Header 用法</h2><p><a href="https://tools.ietf.org/html/rfc3550" target="_blank" rel="external">RFC 3550</a> 中描述了 RTP Header 的格式，且为了方便在图 1 中再次展示了它。这里的载荷格式使用头部字段的方式与那份规范相同。</p>
<p>当一个 NALU 被封装进每个 RTP 包时，建议采用的 RTP 载荷格式在 <a href="https://tools.ietf.org/html/rfc6184#section-5.6" target="_blank" rel="external">5.6 小节</a> 中描述。聚合包和分片单元的 RTP 载荷（及一些 RTP 头部位的设置）分别在 <a href="https://tools.ietf.org/html/rfc6184#section-5.7.2" target="_blank" rel="external">5.7.2</a> 和 <a href="https://tools.ietf.org/html/rfc6184#section-5.8" target="_blank" rel="external">5.8</a> 小节描述。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|V=2|P|X|  CC   |M|     PT      |       sequence number         |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|                           timestamp                           |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|           synchronization source (SSRC) identifier            |</span></div><div class="line">+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</div><div class="line">|            contributing source (CSRC) identifiers             |</div><div class="line"><span class="section">|                             ....                              |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 1. <a href="https://tools.ietf.org/html/rfc3550" target="_blank" rel="external">RFC 3550</a> 的 RTP 头部</p>
<p>根据本 RTP 载荷格式所需设置的 RTP 头部信息按如下方式设置：</p>
<ul>
<li>Marker bit (M): 1 bit<br>设置由 RTP 时间戳表示的访问单元的最后一个数据包，符合视频格式的 M 位的正常使用，以允许高效的播放缓冲处理。对于聚合包（STAP 和 MTAP），RTP 头部中的 marker 位 必须被设置为，就像聚合包的最后一个 NAL 单元在其自己的 RTP 包中传输那样的值。解码器可以使用这个位作为访问单元最后一个数据包的早期指示，但不得依赖此属性。<br>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx<br>访问单元通常指一帧的图像数据？ 对于聚合包来说，这个位的值主要依赖于聚合包中的最后一个 NALU ？<br>yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy<br>资料性说明：携带多个 NAL 单元的聚合包只有一个 M 位与之关联。这样，如果网关将聚合包重新分包为多个包，则它无法可靠地设置那些包的 M 位。</li>
<li>载荷类型 (PT)：7 位<br>对于新的数据包格式，RTP负载类型的分配不属于本文档的范围，这里不再赘述。载荷类型的分配必须通过所使用的 profile 或以动态的方式来执行。</li>
<li>序列号 (SN)：16 位<br>根据 <a href="https://tools.ietf.org/html/rfc3550" target="_blank" rel="external">RFC 3550</a> 设置和使用。对于单独的 NALU 和非交错的打包模式，序列号用于决定 NALU 解码的顺序。</li>
<li>时间戳：32 位<br>RTP 时间戳被设置为内容的采样时间戳。必须使用 90 kHz 始终频率。<br>如果 NAL 单元没有它自己的时序属性（比如，参数集和 SEI NAL 单元），RTP 时间戳被设置为访问单元的主编码图像，其中包含了 NAL 单元，的 RTP 时间戳，根据 ITU-T Recommendation H.264 的 7.4.1.2 节。<br>MTAPs 的 RTP 时间戳的设置在 <a href="https://tools.ietf.org/html/rfc6184#section-5.7.2" target="_blank" rel="external">5.7.2 小节</a> 定义。<br>接收者应该忽略只包含一个显示时间戳的访问单元中包含的任何图像时序 SEI 消息。相反，接收者应该使用 RTP 时序来同步显示过程。<br>如果一个访问单元在图像时序 SEI 消息中携带了多个显示时间戳，则 SEI 消息中的信息应当被视为 RTP 时间戳的相对时间来处理，其中最早的事件发生在 RTP 时间戳给出的时间，其它事件随后发生，由图像时序 SEI 消息中携带的图像时间值的差给出。<br>令 tSEI1，tSEI2，. . .，tSEIn 为访问单元的 SEI 消息中携带的显示时间戳，其中 tSEI1 为所有这些时间戳中最早的一个。令 tmadjst() 为将 SEI 消息时间调整为一个 90 kHz 时间的函数。令 TS 为 RTP 时间戳。则与 tSEI1 关联的事件的显示时间为 TS。tSEIx 的事件的显示时间为，其中 x 为 [2..n]，是 TS + tmadjst (tSEIx - tSEI1)。<br>资料性说明：称为 3：2 下拉的操作中通常需要将编码的帧显示为字段，其中由编码帧组成的胶片内容使用隔行扫描显示在显示器上。图片时序 SEI 消息能够为相同的编码图像携带多个时间戳，因此 3：2 下拉过程被完全地控制。图像定时<br>SEI 消息机制是必要的，因为 RTP 时间戳只能为每个编码帧传送一个时间戳。</li>
</ul>
<h2 id="5-2-载荷结构"><a href="#5-2-载荷结构" class="headerlink" title="5.2 载荷结构"></a>5.2 载荷结构</h2><p>有效载荷格式定义三种不同的基本载荷结构。接收者可以通过 RTP 包载荷的第一个字节识别载荷结构，其共同用作 RTP 有效载荷报头，在某些情况下，作为载荷的第一个字节。这个字节总是被构造为 NAL 单元头。NAL 单元类型字段表示是哪种结构。可能的结构如下。</p>
<p>单个 NAL 单元包：载荷中包含一个单独的 NAL 单元。NAL 头部类型等于原始的 NAL 单元类型，比如，范围在 1 到 23 ，包括 23。在 <a href="https://tools.ietf.org/html/rfc6184#section-5.6" target="_blank" rel="external">5.6 小节</a> 中描述。</p>
<p>聚合包：用于将多个 NAL 单元聚合为一个单独的 RTP 载荷的包类型。这个包有四个版本，单时间聚合包类型 A (STAP-A)，单时间聚合包类型 B (STAP-B)，16 位偏移多时间聚合包 (MTAP) (MTAP16)，和 24 位偏移多时间聚合包 (MTAP) (MTAP24)。为 STAP-A，STAP-B，MTAP16 和 MTAP24 分配的数字值分别为 24，25，26，和 27。在 <a href="https://tools.ietf.org/html/rfc6184#section-5.7" target="_blank" rel="external">5.7 小节</a> 中描述。</p>
<p>分片单元：用于将一个单独的 NAL 单元分割为多个 RTP 包。有两个版本，FU-A 和 FU-B，分别由 NAL 单元类型数字 28 和 29 标识。在 <a href="https://tools.ietf.org/html/rfc6184#section-5.8" target="_blank" rel="external">5.8 小节</a> 中描述。</p>
<p>资料性说明：本规范不限制在单个 NAL 单元包中封装的 NAL 单元和分片单元的大小。在任何聚合包中封装的 NAL 单元的最大大小为 65535 字节。</p>
<p>表 1 总结了当这些 NAL 单元直接被用作一个包载荷时，NAL 单元类型和对应的 RTP 包类型，以及本备忘录中描述这些类型的章节。</p>
<p>表 1. NAL 单元类型和对应的包类型总结</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">NAL Unit  Packet    Packet Type Name               Section</div><div class="line">Type      Type</div><div class="line">-------------------------------------------------------------</div><div class="line"><span class="number">0</span>        reserved                                     -</div><div class="line"><span class="number">1</span><span class="number">-23</span>     NAL unit  Single NAL unit packet             <span class="number">5.6</span></div><div class="line"><span class="number">24</span>       STAP-A    Single-time aggregation packet     <span class="number">5.7</span><span class="number">.1</span></div><div class="line"><span class="number">25</span>       STAP-B    Single-time aggregation packet     <span class="number">5.7</span><span class="number">.1</span></div><div class="line"><span class="number">26</span>       MTAP16    Multi-time aggregation packet      <span class="number">5.7</span><span class="number">.2</span></div><div class="line"><span class="number">27</span>       MTAP24    Multi-time aggregation packet      <span class="number">5.7</span><span class="number">.2</span></div><div class="line"><span class="number">28</span>       FU-A      Fragmentation unit                 <span class="number">5.8</span></div><div class="line"><span class="number">29</span>       FU-B      Fragmentation unit                 <span class="number">5.8</span></div><div class="line"><span class="number">30</span><span class="number">-31</span>    reserved                                     -</div></pre></td></tr></table></figure>
<p>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx<br>聚合包中的单时间聚合包中，多个 NAL 单元的存储结构是什么样的？NAL 单元间是否需要 NAL 单元分割序列 0x00000001？<br>yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy</p>
<h2 id="5-3-NAL-单元头部使用"><a href="#5-3-NAL-单元头部使用" class="headerlink" title="5.3 NAL 单元头部使用"></a>5.3 NAL 单元头部使用</h2><p>NAL 单元头部的结构和语义在 <a href="https://tools.ietf.org/html/rfc6184#section-1.3" target="_blank" rel="external">1.3 节</a> 中介绍。为了方便，NAL 单元头部的格式重新显示如下：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="code">+---------------+</span></div><div class="line"><span class="section">|0|1|2|3|4|5|6|7|</span></div><div class="line">+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|F|NRI|  Type   |</span></div><div class="line">+---------------+</div></pre></td></tr></table></figure>
<p>本节根据本规范描述了 F 和 NRI 的语义。</p>
<ul>
<li>F：1 位<br>forbidden_zero_bit。值为 0，表示 NAL 单元型八位位组和有效载荷不应包含位错误或其他语法违规。值为 1 表示 NAL 单元类型八位位组可能包含位错误或其它语法违规。<br>MANEs 应该设置 F 位来表示在 NAL 单元中探测到位错误。H.264 规范要求 F 位等于 0。当设置了 F 位时，则告诉解码器 NAL 单元类型八位位组中或载荷中可能存在位错误或其它语法违规。最简单的解码器对 F 位等于 1 的 NAL 单元的响应为，丢弃这个 NAL 单元并隐藏丢弃的 NAL 单元中丢失的数据。</li>
<li>NRI：2 位<br>nal_ref_idc。00 和非零值的语义与 H.264 规范中的保持不变。换句话说，00 值表示 NAL 单元的内容不用于重建用于帧间预测的参考图像。这样 NAL 单元可以被丢弃而不危及参考图像的完整性。大于 00 的值表示，为了维护参考图像的完整性，需要解码 NAL 单元。<br>除了上面的规范，根据本 RTP 载荷规范，NRI 的值表示由编码器决定的相对的传输优先级。MANEs 可以使用这个信息，相对于不那么重要的 NAL 单元，更好地保护更重要的 NAL 单元。最高的传输优先级为 11，后面是 10，然后是 01；最后，00 最低。<br>资料性说明：在 H.264 解码器中，以同样的方式处理 NRI 的任何非零值。因此，当接收者传递 NAL 单元给解码器时，不需要管理 NRI 值。<br>当 nal_unit_type 的值在 1 到 12 （包括）范围内时，H.264 编码器必须根据 H.264 规范（7.4.1 单元）设置 NRI 的值。特别的，H.264 规范要求，对于所有 nal_unit_type 等于 6，9，10，11，或 12 的 NAL 单元，NRI 的值应该等于 0。<br>对于 nal_unit_type 等于 7 或 8（分别表示序列参数集或图像参数集）的 NAL 单元，H.264 编码器应该把 NRI 的值设置为 11（二进制格式）。对于主编码图像的编码的 slice NAL 单元，其 nal_unit_type 等于 5（表示一个编码的 slice 属于 IDR 图像），H.264 编码器应该把 NRI 的值设置为 11（二进制格式）。<br>其余的 nal_unit_types 到 NRI 值的映射，可以使用以下示例，并且已经被证明在某一环境中是有效的。其他映射也可能是可取的，具体取决于应用程序和使用的 H.264 配置文件。<br>资料性说明：数据分区在某些配置中是不可用的，比如在 Main 和 Baseline 配置中。因此，NAL 单元类型 2，3，和 4 只发生在允许数据分区的视频比特流配置中，而不在符合 Main 或 Baseline 配置的流中。<br>表 2. 主编码参考图像的编码 slice 和 编码 slice 数据分区的  NRI 值示例<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="section">NAL Unit Type     Content of NAL Unit              NRI (binary)</span></div><div class="line">----------------------------------------------------------------</div><div class="line"><span class="code"> 1              non-IDR coded slice                         10</span></div><div class="line"><span class="code"> 2              Coded slice data partition A                10</span></div><div class="line"><span class="code"> 3              Coded slice data partition B                01</span></div><div class="line"><span class="code"> 4              Coded slice data partition C                01</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>资料性说明：如前面提到的，H.264 强制非参考图像的 NRI 值为 00。<br>H.264 编码器应该设置冗余的编码参考图像的编码 slice 和 编码 slice 数据分区 NAL 单元的 NRI 的值为 01 （二进制格式）。<br>NAL 单元类型 24 到 29（包含）的 NRI 值的定义，在本备忘录的 <a href="https://tools.ietf.org/html/rfc6184#section-5.7" target="_blank" rel="external">5.7</a> 和 <a href="https://tools.ietf.org/html/rfc6184#section-5.8" target="_blank" rel="external">5.8</a> 节中给出。<br>nal_unit_type 在范围 13 到 23 （包含）内的 NAL 单元的 NRI 值没有建议值，因为这些值为 ITU-T 和 ISO/IEC 所保留。nal_unit_type 等于 0 或在范围 30 到 31 （包含）的 NAL 单元的 NRI 值也没有建议值，因为这些值的语义不在本备忘录中描述。</p>
<h2 id="5-4-打包模式"><a href="#5-4-打包模式" class="headerlink" title="5.4 打包模式"></a>5.4 打包模式</h2><p>本备忘录描述打包模式的三种情况：</p>
<ul>
<li>单 NAL 单元模式</li>
<li>非交错模式</li>
<li>交错模式</li>
</ul>
<p>单 NAL 单元模式针对符合 ITU-T Recommendation H.241 的会话系统（参考 <a href="https://tools.ietf.org/html/rfc6184#section-12.1" target="_blank" rel="external">12.1 节</a>）。非交错模式针对不符合 ITU-T Recommendation H.241 的会话系统。在非交错模式中，NAL 单元以 NAL 单元解码的顺序传输。交错模式针对不需要很低的端到端延迟的系统。交错模式允许不以 NAL 单元解码的顺序传输。</p>
<p>使用的打包模式可以通过可选的 packetization-mode 媒体类型参数的值来通知。所用的打包模式管理在 RTP 载荷中允许哪些 NAL 单元类型。表 3 总结了每种打包模式允许的包载荷类型。<a href="https://tools.ietf.org/html/rfc6184#section-6" target="_blank" rel="external">第 6 节</a> 更详细地解释了打包模式。</p>
<p>表 3. 每种打包模式允许的 NAL 单元类型总结 (yes = allowed, no = disallowed, ig = ignore)<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">Payload</span> Packet    Single NAL    N<span class="literal">on</span>-Interleaved    Interleaved</div><div class="line">Type    Type      Unit Mode           Mode             Mode</div><div class="line">-------------------------------------------------------------</div><div class="line"><span class="number">0</span>      reserved      ig               ig               ig</div><div class="line"><span class="number">1</span>-<span class="number">23</span>   NAL unit     <span class="literal">yes</span>              <span class="literal">yes</span>               <span class="literal">no</span></div><div class="line"><span class="number">24</span>     STAP-A        <span class="literal">no</span>              <span class="literal">yes</span>               <span class="literal">no</span></div><div class="line"><span class="number">25</span>     STAP-B        <span class="literal">no</span>               <span class="literal">no</span>              <span class="literal">yes</span></div><div class="line"><span class="number">26</span>     MTAP16        <span class="literal">no</span>               <span class="literal">no</span>              <span class="literal">yes</span></div><div class="line"><span class="number">27</span>     MTAP24        <span class="literal">no</span>               <span class="literal">no</span>              <span class="literal">yes</span></div><div class="line"><span class="number">28</span>     FU-A          <span class="literal">no</span>              <span class="literal">yes</span>              <span class="literal">yes</span></div><div class="line"><span class="number">29</span>     FU-B          <span class="literal">no</span>               <span class="literal">no</span>              <span class="literal">yes</span></div><div class="line"><span class="number">30</span>-<span class="number">31</span>  reserved      ig               ig               ig</div></pre></td></tr></table></figure></p>
<p>一些 NAL 单元或载荷类型值（如 表 3 中的 reserved 所示）被保留，以用于未来扩展。发送者不应该发送那些类型的 NAL 单元（直接作为包载荷，作为聚合包中的聚合单元，或作为 FU 包中的分片），且接收者必须忽略它们。比如，载荷类型 1-23，具有关联的包类型 “NAL unit”，它可以出现在 “Single NAL Unit Mode” 和 “Non-Interleaved Mode” 中，但不能出现在 “Interleaved Mode” 中。然而，NAL 单元类型 1-23 的 NAL 单元可被用于 “Interleaved Mode”，作为 STAP-B，MTAP16，和 MTAP24 包中的聚合单元，也可以作为 FU-A 和 FU-B 包中的分片单元。类似地，NAL 单元类型 1-23 的 NAL 单元也可被用于 “Non-Interleaved Mode” 作为 STAP-A 包中的聚合单元或 FU-A 包中的分片单元，除了直接被用作包载荷。</p>
<h2 id="5-5-解码顺序号（DON）"><a href="#5-5-解码顺序号（DON）" class="headerlink" title="5.5 解码顺序号（DON）"></a>5.5 解码顺序号（DON）</h2><p>在交错打包模式下，NAL 单元的传输顺序允许和其解码顺序不同。解码顺序号（DON）是载荷结构中表示 NAL 单元解码顺序的一个字段或一个派生变量。传输顺序与解码顺序不同的用例的基本原理和实例，以及 DON 的使用在 <a href="https://tools.ietf.org/html/rfc6184#section-13" target="_blank" rel="external">13 小节</a> 给出。</p>
<p>传输和解码顺序的耦合由可选的 sprop-interleaving-depth 媒体类型参数控制如下。当可选的 sprop-interleaving-depth 媒体类型参数的值为 0 时（明确地或默认的），NAL 单元的传输顺序必须与 NAL 单元的解码顺序一致。当可选的 sprop-interleaving-depth 媒体类型参数的值大于 0 时：</p>
<ul>
<li>MTAP16 和 MTAP24 中的 NAL 单元顺序不需要是 NAL 单元解码的顺序，且</li>
<li>由解包两个连续的包中的 STAP-Bs，MTAPs，和 FUs 产生的 NAL 单元的顺序不需要是 NAL 单元解码的顺序。</li>
</ul>
<p>单 NAL 单元包的 RTP 载荷结构，一个 STAP-A 或一个 FU-A 不包含 DON。STAP-B 和 FU-B 结构包含 DON，MTAPs 的结构允许 DON 的继承，如 <a href="https://tools.ietf.org/html/rfc6184#section-5.7.2" target="_blank" rel="external">5.7.2 小节</a> 所述。</p>
<p>资料性说明：当 FU-A 出现在交错模式中时，它总是跟在 FU-B 后面，后者设置它自己的 DON。</p>
<p>资料性说明：如果发送端想要每个包封装一个 NAL 单元并以非解码顺序传输包，则可以使用 STAP-B 包类型。</p>
<p>在单 NAL 单元打包模式中，NAL 单元的传输顺序，由 RTP 序列号决定，必须与它们的 NAL 单元解码顺序相同。在非交错打包模式中，单 NAL 单元包中的 NAL 单元的传输顺序， STAP-As，和 FU-As 必须与它们的 NAL 单元解码顺序相同。STAP 内的 NAL 单元必须以它们解码的顺序出现。这样，首先通过 STAP 内的顺序明确地提供解码顺序，然后通过 STAPs，FUs 和单 NAL 单元包之间的顺序的 RTP 序列号提供。</p>
<p>STAP-B，MTAP，和一系列以 FU-B 开头的分片单元中携带的 NAL 单元的 DON 值的信令分别在 <a href="https://tools.ietf.org/html/rfc6184#section-5.7.1" target="_blank" rel="external">5.7.1</a>，<a href="https://tools.ietf.org/html/rfc6184#section-5.7.2" target="_blank" rel="external">5.7.2</a> 和 <a href="https://tools.ietf.org/html/rfc6184#section-5.8" target="_blank" rel="external">5.8</a> 节中描述。传输顺序中第一个 NAL 单元的 DON 值可以被设置为任何值。DON 值的范围为 0 到 65535（包含）。在达到最大值之后，DON 的值环绕到 0。</p>
<p>任何 STAP-B，MTAP，和一系列以 FU-B 开头的分片单元中包含的两个 NAL 单元的解码顺序按如下方式决定。令 DON(i) 为传输序列中索引为 i 的 NAL 单元的解码顺序号。函数 don_diff(m,n) 描述如下：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">If DON(m) == DON(n), don_diff(m,n) = <span class="number">0</span></div><div class="line"></div><div class="line">If (DON(m) &lt; DON(n) <span class="keyword">and</span> DON(n) - DON(m) &lt; <span class="number">32768</span>),</div><div class="line"><span class="function"><span class="title">don_diff</span><span class="params">(m,n)</span> = DON<span class="params">(n)</span> - DON<span class="params">(m)</span></span></div><div class="line"></div><div class="line">I<span class="title">f</span> <span class="params">(DON(m)</span> &gt; DON<span class="params">(n)</span> <span class="title">and</span> DON<span class="params">(m)</span> - DON<span class="params">(n)</span> &gt;= 32768),</div><div class="line"><span class="title">don_diff</span><span class="params">(m,n)</span> = 65536 - DON<span class="params">(m)</span> + DON<span class="params">(n)</span></div><div class="line"></div><div class="line">I<span class="title">f</span> <span class="params">(DON(m)</span> &lt; DON<span class="params">(n)</span> <span class="title">and</span> DON<span class="params">(n)</span> - DON<span class="params">(m)</span> &gt;= 32768),</div><div class="line"><span class="title">don_diff</span><span class="params">(m,n)</span> = - <span class="params">(DON(m)</span> + 65536 - DON<span class="params">(n)</span>)</div><div class="line"></div><div class="line">I<span class="title">f</span> <span class="params">(DON(m)</span> &gt; DON<span class="params">(n)</span> <span class="title">and</span> DON<span class="params">(m)</span> - DON<span class="params">(n)</span> &lt; 32768),</div><div class="line"><span class="title">don_diff</span><span class="params">(m,n)</span> = - <span class="params">(DON(m)</span> - DON<span class="params">(n)</span>)</div></pre></td></tr></table></figure>
<p>正的 don_diff(m,n) 值表示发送顺序索引为 n 的 NAL 单元，其解码顺序在传输顺序索引为 m 的 NAL单元之后。当 don_diff(m,n) 等于 0 时，两个 NAL 单元的 NAL 单元解码顺序可以为任意顺序。负的 don_diff(m,n) 值表示发送顺序索引为 n 的 NAL 单元，其解码顺序在传输顺序索引为 m 的 NAL单元之前。</p>
<p>DON 相关字段（DON，DONB，和 DOND；参考 <a href="https://tools.ietf.org/html/rfc6184#section-5.7" target="_blank" rel="external">5.7 节</a>）的值必须使得由上述 DON 值决定的解码顺序符合 NAL 单元解码顺序。</p>
<p>如果 NAL 单元解码顺序中的两个 NAL 单元顺序切换，且新的顺序与 NAL 单元解码顺序不一致，则 NAL 单元必须不具有相同的 DON。如果 NAL 单元流中两个连续 NAL 单元的顺序被交换，且新的顺序依然符合 NAL 单元解码顺序，则 NAL 单元可以具有相同的 DON 值。比如，所用的视频编码配置允许任意的编码 slice 顺序，编码图片的所有编码 slice NAL 单元允许具有相同的 DON。因此，具有相同 DON 值的 NAL 单元可以以任意顺序解码，而具有不同 DON 值的两个 NAL 单元应该以上面描述的顺序传给解码器。当 NAL 单元解码顺序中的两个连续 NAL 单元具有不同的 DON 值时，解码顺序中第二个 NAL 单元的 DON 值应该是第一个的 DON 值加一。</p>
<p>解包过程恢复 NAL 单元解码顺序的示例在 <a href="https://tools.ietf.org/html/rfc6184#section-7" target="_blank" rel="external">第 7 节</a> 中描述。</p>
<p>资料性说明：接收者不应该期待 NAL 单元解码顺序中两个连续 NAL 单元的 DON 值的绝对差值等于 1，即使是在可靠传输中。在将 DON 值与 NAL 单元关联时，不要求递增 1，可能不知道所有NAL单元是否被传送到接收器。比如，当分组转发到的网络中存在缺少比特率时，网关可能不转发非参考图像或 SEI NAL 单元的编码 slice NAL 单元 。在另一个例子中，实况广播由预编码的内容（例如商业广告）不时地中断。预先编码剪辑的第一帧图像被预先发送，以确保其在接收机中容易获得。当传输第一帧图像时，在解码顺序中后面的预编码裁剪的第一帧图像之前，发起端不能精确地知道将编码多少 NAL 单元。这样，预编码裁剪的第一帧图像的 NAL 单元的DON 的值必须在它们被传输时评估，则 DON 值的 gaps 可能出现。</p>
<h2 id="5-6-单-NAL-单元包"><a href="#5-6-单-NAL-单元包" class="headerlink" title="5.6 单 NAL 单元包"></a>5.6 单 NAL 单元包</h2><p>这里定义的单 NAL 单元包必须只包含一个 ITU-T Recommendation H.264 中定义的类型的 NAL 单元。这意味着聚合包或分片单元都不能用在单 NAL 单元包中。通过以<br> RTP 序列号顺序对单 NAL 单元包进行解包组合的 NAL 单元流必须符合 NAL 单元解码顺序。单 NAL 单元包的结构如图 2 所示。</p>
<p>资料性说明：NAL 单元的第一个字节共同作为 RTP 载荷头。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|F|NRI|  Type   |                                               |</div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+                                               |</div><div class="line">|                                                               |</div><div class="line">|               Bytes 2..n of a single NAL unit                 |</div><div class="line">|                                                               |</div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :...OPTIONAL RTP padding        |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 2. 单 NAL 单元包的 RTP 载荷格式</p>
<h2 id="5-7-聚合包"><a href="#5-7-聚合包" class="headerlink" title="5.7 聚合包"></a>5.7 聚合包</h2><p>聚合包是这份载荷规范的 NAL 单元聚合方案。引入该方案以反映两个关键目标网络的显着不同的MTU大小：有线 IP 网络（具有常常由以太网 MTU 大小限制的 MTU 大小，大约 1500 字节）和基于 IP 或非基于 IP（比如，ITU-T H.324/M）的无线通信系统，其优选传输单元为 254 字节或更少。为了防止两个世界间的媒体传输编码，并避免不必要的分组化开销，引入了 NAL 单元聚合方案。</p>
<p>本规范定义了两种聚合包类型：</p>
<ul>
<li>单时间聚合包（STAP）：聚合具有相同 NALU 时间的 NAL 单元。定义两种 STAPs 类型，一个没有 DON（STAP-A），另一个包含 DON（STAP-B）。</li>
<li>多时间聚合包（MTAP）：聚合具有潜在不同 NALU 时间的 NAL 单元。定义了两个不同的 MTAPs，其 NAL 单元的时间戳偏移的长度不同。</li>
</ul>
<p>聚合包中携带的每个 NAL 单元被封装在一个聚合单元中。请参考下文来了解四种不同的聚合单元及其特性。</p>
<p>聚合包的 RTP 载荷格式结构如图 3 所示。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|F|NRI|  Type   |                                               |</div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+                                               |</div><div class="line">|                                                               |</div><div class="line">|             one or more aggregation units                     |</div><div class="line">|                                                               |</div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :...OPTIONAL RTP padding        |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 3. 聚合包的 RTP 载荷格式</p>
<p>MTAPs 和 STAPs 共享如下的打包规则：</p>
<ul>
<li>RTP 时间戳必须被设置为被聚合的所有 NAL 单元中 NALU 时间最早的那个。</li>
<li>NAL 单元类型八位位组的类型字段必须被设置为适当的值，如表 4 所示。</li>
<li>如果被聚合的所有 NAL 单元的 F 位为 0，则 F 位必须被清除；否则，它必须被设置。</li>
<li>NRI 值必须是聚合包中携带的所有 NAL 单元的最大值。</li>
</ul>
<p>表 4. STAPs 和 MTAPs 的字段类型<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="code">           Table 4.  Type field for STAPs and MTAPs</span></div><div class="line"></div><div class="line">Type   Packet    Timestamp offset   DON-related fields</div><div class="line"><span class="code">                 field length       (DON, DONB, DOND)</span></div><div class="line"><span class="section">                 (in bits)          present</span></div><div class="line">--------------------------------------------------------</div><div class="line">24     STAP-A       0                 no</div><div class="line">25     STAP-B       0                 yes</div><div class="line">26     MTAP16      16                 yes</div><div class="line">27     MTAP24      24                 yes</div></pre></td></tr></table></figure></p>
<p>RTP 头部中的 marker 位的值被设置为，就像聚合包的最后一个 NAL 单元在其自己的 RTP 包中传输时它的 marker 位一样的值。</p>
<p>聚合包的载荷由一个或多个聚合单元组成。参考 <a href="https://tools.ietf.org/html/rfc6184#section-5.7.1" target="_blank" rel="external">5.7.1</a> 和 <a href="https://tools.ietf.org/html/rfc6184#section-5.7.2" target="_blank" rel="external">5.7.2</a> 节来了解四种不同类型的聚合单元。聚合包可以根据需要携带尽可能多的聚合单元；然而，聚合包中总的数据量明显地必须刚好放入一个 IP 包中，选择的大小应该让最终的 IP 包大小小于 MTU 大小。聚合包必须不包含分片单元，如 <a href="https://tools.ietf.org/html/rfc6184#section-5.8" target="_blank" rel="external">5.8 节</a> 所述。聚合包必须不嵌套；即，聚合包必须不包含另一个聚合包。</p>
<h3 id="5-7-1-单时间聚合包（STAP）"><a href="#5-7-1-单时间聚合包（STAP）" class="headerlink" title="5.7.1 单时间聚合包（STAP）"></a>5.7.1 单时间聚合包（STAP）</h3><p>所有要聚合的 NAL 单元共享相同的 NALU 时间时应该使用单时间聚合包（STAP）。STAP-A 载荷不包含 DON，且由至少一个单时间聚合单元组成，如图 4 所示。STAP-B 载荷由一个 16 位无符号解码顺序号（DON）（以网络字节序）后跟至少一个单时间聚合单元组成，如图 5. 所示。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="code">                :                                               |</span></div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+                                               |</div><div class="line">|                                                               |</div><div class="line">|                single-time aggregation units                  |</div><div class="line">|                                                               |</div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 4. STAP-A 载荷格式</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="code">                :  decoding order number (DON)  |               |</span></div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+               |</div><div class="line">|                                                               |</div><div class="line">|                single-time aggregation units                  |</div><div class="line">|                                                               |</div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 5. STAP-B 的 载荷格式</p>
<p>DON 字段描述了 STAP-B 中传输顺序的第一个 NAL 单元的 DON 值。对于 STAP-B 中的每个连续的 NAL 单元，其 DON 值等于 (STAP-B 中前一个 NAL 单元的 DON 值+ 1) % 65536，其中 ‘%’ 表示取模操作。</p>
<p>单时间聚合单元由一个表示下面的 NAL 单元的字节大小（不包含这两个8位位组，但包含 NAL 单元的 NAL 单元类型八位位组）的 16 位无符号大小信息（以网络字节序），后跟 NAL 单元自身，包含它的 NAL 单元类型字节组成。单时间聚合单元是 RTP 载荷内字节对齐的，但它可能不是对齐到 32 位字边界的。图 6 展示了单时间聚合单元的结构。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="code">                :        NAL unit size          |               |</span></div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+               |</div><div class="line">|                                                               |</div><div class="line">|                           NAL unit                            |</div><div class="line">|                                                               |</div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 6. 单时间聚合单元的结构</p>
<p>图 7 展示了一个 RTP 包的示例，其包含了一个 STAP-A。STAP 包含两个单时间聚合单元，由图中的 1 和 2 表示。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|                          RTP Header                           |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|STAP-A NAL HDR |         NALU 1 Size           | NALU 1 HDR    |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|                         NALU 1 Data                           |</div><div class="line"><span class="meta">:                                                               :</span></div><div class="line"><span class="code">+               +</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span></div><div class="line"><span class="section">|               | NALU 2 Size                   | NALU 2 HDR    |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|                         NALU 2 Data                           |</div><div class="line"><span class="meta">:                                                               :</span></div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :...OPTIONAL RTP padding        |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 7. 包含一个包含两个单时间聚合单元的 STAP-A 的 RTP 包示例</p>
<p>图 8 展示了一个 RTP 包示例，其包含一个 STAP-B。STAP 包含两个单时间聚合单元，由图中的 1 和 2 标识。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|                          RTP Header                           |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|STAP-B NAL HDR | DON                           | NALU 1 Size   |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">| NALU 1 Size   | NALU 1 HDR    | NALU 1 Data                   |</div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+                               +</span></div><div class="line"><span class="meta">:                                                               :</span></div><div class="line"><span class="code">+               +</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span></div><div class="line"><span class="section">|               | NALU 2 Size                   | NALU 2 HDR    |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|                       NALU 2 Data                             |</div><div class="line"><span class="meta">:                                                               :</span></div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :...OPTIONAL RTP padding        |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 8. 包含一个包含两个单时间聚合单元的 STAP-B 的 RTP 包示例</p>
<h3 id="5-7-2-多时间聚合包（MTAPs）"><a href="#5-7-2-多时间聚合包（MTAPs）" class="headerlink" title="5.7.2 多时间聚合包（MTAPs）"></a>5.7.2 多时间聚合包（MTAPs）</h3><p>MTAPs 的 NAL 单元载荷由一个 16 位的无符号解码顺序号基数（DONB）（以网络字节序）和一个或多个多时间聚合单元组成，如图 9 所示。DONB 必须是 MTAP 中的 NAL 单元的 NAL 单元解码顺序号中的第一个的 DON 值。</p>
<p>资料性说明：NAL 单元解码顺序号的第一个 NAL 单元不一定是按封装进 MTAP 的顺序来算的第一个 NAL 单元。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="code">                :  decoding order number base   |               |</span></div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+               |</div><div class="line">|                                                               |</div><div class="line">|                 multi-time aggregation units                  |</div><div class="line">|                                                               |</div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 9. MTAPs 的 NAL 单元载荷格式</p>
<p>本规范定义了两个不同的多时间聚合单元。它们都由后面的 NAL 单元的 16 位无符号大小信息（以网络字节序），一个 8 位无符号解码顺序号差值（DOND），和这个 NAL 单元的 n 位（以网络字节序）时间戳偏移（TS offset）组成，其中 n 可以是 16 或 24。不同 MTAP 类型（MTAP16 和 MTAP24）间的选择依赖于应用：时间戳偏移越大，MTAP 的灵活性越高，但开销也更高。</p>
<p>MTAP16 和 MTAP24 的多时间聚合单元的结构分别如图 10 和 11 所示。一个包内聚合单元的开始或结束位置不要求是 32 位字的边界。一个多时间聚合单元中包含的 NAL 单元的 DON 等于(DONB + DOND) % 65536，其中 % 表示取模操作。本备忘录不描述 MTAP 内的 NAL 单元如何排序，但是，在大多数情况下，应该使用 NAL 单元解码顺序。</p>
<p>必须将时间戳偏移字段设置为等于以下公式的值：如果 NALU 时间大于等于包的 RTP 时间戳，则时间戳偏移等于 (NAL 单元的 NALU 时间 - 包的 RTP 时间戳)。如果 NALU 时间小于包的 RTP 时间戳，则时间戳偏移等于 NALU 时间 +<br>(2^32 - 包的 RTP 时间戳)。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">:        NAL unit size          |      DOND     |  TS offset    |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|  TS offset    |                                               |</div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+              NAL unit                         |</div><div class="line">|                                                               |</div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 10. MTAP16 的多时间聚合单元</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">:        NAL unit size         |      DOND     |  TS offset    |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|         TS offset             |                               |</div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+                               |</div><div class="line">|                              NAL unit                         |</div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 11. MTAP24 的多时间聚合单元</p>
<p>对于一个 MTAP 中 “最早的” 多时间聚合单元，其时间戳偏移必须是 0。因此，MTAP 自身的 RTP 时间戳与最早的 NALU 时间一样。</p>
<p>资料性说明：如果包含在聚合单元中的 NAL 单元被封装在单个 NAL 单元包中，则“最早”的多时间聚合单元将是 MTAP 的所有聚合单元中具有最小扩展 RTP 时间戳的那个。扩展时间戳是具有超过32位的时间戳，并且能够对时间戳字段的环绕进行计数，因此可以在时间戳环绕时确定最小值。这个 “最早的” 聚合单元可能不是以封装进 MTAP 中的顺序来计算的第一个聚合单元。“最早的” NAL 单元不需要与 NAL 单元解码顺序的第一个 NAL 单元相同。</p>
<p>图 12 展示了一个 RTP 包的示例，其包含了一个 MTAP16 类型的多时间聚合包，其中包含了两个多时间聚合单元，由图中的 1 和 2 标识。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|                          RTP Header                           |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|MTAP16 NAL HDR |  decoding order number base   | NALU 1 Size   |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|  NALU 1 Size  |  NALU 1 DOND  |       NALU 1 TS offset        |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|  NALU 1 HDR   |  NALU 1 DATA                                  |</div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+                                               +</span></div><div class="line"><span class="meta">:                                                               :</span></div><div class="line"><span class="code">+               +</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span></div><div class="line"><span class="section">|               | NALU 2 SIZE                   |  NALU 2 DOND  |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|       NALU 2 TS offset        |  NALU 2 HDR   |  NALU 2 DATA  |</div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+               |</div><div class="line"><span class="meta">:                                                               :</span></div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :...OPTIONAL RTP padding        |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 12. 包含一个包含了两个多时间聚合单元的类型 MTAP16 的多时间聚合包的 RTP 包</p>
<p>图 13 展示了一个 RTP 包的示例，其包含了一个 MTAP24 类型的多时间聚合包，其中包含了两个多时间聚合单元，由图中的 1 和 2 标识。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|                          RTP Header                           |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|MTAP24 NAL HDR |  decoding order number base   | NALU 1 Size   |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|  NALU 1 Size  |  NALU 1 DOND  |       NALU 1 TS offs          |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|NALU 1 TS offs |  NALU 1 HDR   |  NALU 1 DATA                  |</div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+                               +</span></div><div class="line"><span class="meta">:                                                               :</span></div><div class="line"><span class="code">+               +</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span></div><div class="line"><span class="section">|               | NALU 2 SIZE                   |  NALU 2 DOND  |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|       NALU 2 TS offset                        |  NALU 2 HDR   |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|  NALU 2 DATA                                                  |</div><div class="line"><span class="meta">:                                                               :</span></div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :...OPTIONAL RTP padding        |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 13. 包含一个包含了两个多时间聚合单元的类型 MTAP24 的多时间聚合包的 RTP 包</p>
<h2 id="5-8-分片单元（FUs）"><a href="#5-8-分片单元（FUs）" class="headerlink" title="5.8 分片单元（FUs）"></a>5.8 分片单元（FUs）</h2><p>这个载荷类型允许把一个 NAL 单元分片为多个 RTP 包。在应用层做这件事，而不是依赖于更底层的分片（比如，通过 IP）具有如下这些优势：</p>
<ul>
<li>载荷格式能够通过 IPv4 网络传输可能出现在预录制视频中大于 64 kbytes 的 NAL 单元，特别是高清格式。（有一个每图片最大 slice 数的限制，其将导致每图片 NAL 单元的限制，其可能导致大的 NAL 单元）。</li>
<li>分片机制允许将单个 NAL 单元分片，并应用 <a href="https://tools.ietf.org/html/rfc6184#section-12.5" target="_blank" rel="external">12.5 节</a> 所述的通用的前向纠错。</li>
</ul>
<p>分片只是为单 NAL 单元定义的，而不是为任何聚合包定义的。NAL 单元的片由一个该 NAL 单元的连续八位位组的整数组成。NAL单元的每个八位字节必须是该NAL单元的正好一个片段的一部分。相同 NAL 单元的片段必须连续顺序发送，具有升序的 RTP 序列号（被发送的相同 RTP 包流中第一个和最后一个片段间没有其它 RTP 包）。类似地，NAL 单元必须以 RTP 序列号顺序重新装好。</p>
<p>当 NAL 单元被分片并在分片单元（FUs）中传送时，它被称为一个分片的 NAL 单元。STAPs 和 MTAPs 必须不被分片。FUs 必须不被嵌套；即，FU 必须不包含另一个 FU。</p>
<p>携带一个 FU 的 RTP 包的 RTP 时间戳被设置为被分片的 NAL 单元的 NAL 时间。</p>
<p>图 14 展示了 FU-As 的 RTP 载荷格式。FU-A 由一个八位的分片单元指示器，一个八位的分片单元头，和一个分片单元载荷构成。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">| FU indicator  |   FU header   |                               |</div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+                               |</div><div class="line">|                                                               |</div><div class="line">|                         FU payload                            |</div><div class="line">|                                                               |</div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :...OPTIONAL RTP padding        |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 14. FU-A RTP 载荷格式</p>
<p>图 15 展示了 FU-Bs 的 RTP 载荷格式。FU-B 由一个八位的分片单元指示器，一个八位的分片单元头，一个解码顺序号（DON）（以网络字节序），和一个分片单元载荷构成。换句话说，FU-B 的结构与 FU-A 的结构相同，除了额外的 DON 字段。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="code"> 0                   1                   2                   3</span></div><div class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">| FU indicator  |   FU header   |               DON             |</div><div class="line"><span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-|</div><div class="line">|                                                               |</div><div class="line">|                         FU payload                            |</div><div class="line">|                                                               |</div><div class="line">|                               <span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-<span class="code">+-+</span>-+</div><div class="line"><span class="section">|                               :...OPTIONAL RTP padding        |</span></div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div></pre></td></tr></table></figure>
<p>图 15. FU-B RTP 载荷格式</p>
<p>NAL 单元类型 FU-B 必须被用在交错打包模式中，被分片的 NAL 单元的第一个分片单元中。NAL 单元类型 FU-B 必须不被用在其它情况下。换句话说，在交错打包模式中，被分片的每个 NALU 单元具有一个 FU-B 作为第一个片段，后面是一个或多个 FU-A 片段。</p>
<p>FU 指示器字节具有如下的格式：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="code">+---------------+</span></div><div class="line"><span class="section">|0|1|2|3|4|5|6|7|</span></div><div class="line">+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|F|NRI|  Type   |</span></div><div class="line">+---------------+</div></pre></td></tr></table></figure>
<p>FU 指示器的类型字段的值 28 和 29 分别标识 FU-A 和 FU-B。F 位的使用如 <a href="https://tools.ietf.org/html/rfc6184#section-5.3" target="_blank" rel="external">5.3 节</a> 所述。NRI 字段的值必须根据被分片的 NAL 单元中 NRI 字段的值设置。</p>
<p>FU 头部具有如下的格式：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="code">+---------------+</span></div><div class="line"><span class="section">|0|1|2|3|4|5|6|7|</span></div><div class="line">+-+-+-+-+-+-+-+-+</div><div class="line"><span class="section">|S|E|R|  Type   |</span></div><div class="line">+---------------+</div></pre></td></tr></table></figure>
<ul>
<li><p>S：1 位<br>当被设置为 1 时，Start 位表示被分片 NAL 单元的开始。当后面的 FU 载荷不是被分片 NAL 单元载荷的开始时，Start 位被设置为 0。</p>
</li>
<li><p>E：1 位<br>当被设置为 1 时，End 位表示被分片 NAL 单元的结束，比如，载荷的最后一个字节也是被分片的 NAL 单元的最后一个字节。当后面的 FU 载荷不是被分片的 NAL 单元的最后一个片段时，End 位被设置为0。</p>
</li>
<li><p>R：1 位<br>Reserved 位必须等于 0，且接收者必须忽略它。</p>
</li>
<li><p>Type：5 位<br>NAL 单元载荷类型，如 ITU-T Recommendation H.264 的表 7-1 所定义的那样。</p>
</li>
</ul>
<p>FU-Bs 中的 DON 的值的选择如 <a href="https://tools.ietf.org/html/rfc6184#section-5.5" target="_blank" rel="external">5.5 节</a> 所描述的那样。</p>
<p>资料性说明：FU-Bs 中的 DON 字段允许网关把 NAL 单元分片为 FU-Bs，而不将传入的 NAL 单元组织到 NAL 单元解码顺序。</p>
<p>被分片的 NAL 单元必须不在一个 FU 中传输：即，Start 位和 End 位必须不在相同的 FU 头中同时设置。</p>
<p>FU 载荷由被分片的 NAL 单元的载荷的片段组成，使得如果连续的 FU 的分片单元载荷被顺序连接，则可以重构分段的 NAL 单元的有载荷。被分片 NAL 单元的 NAL 单元类型字节没有包含分片单元载荷中，而是被分片 NAL 单元的 NAL 单元类型字节的的信息，由分片单元的 FU 指示器字节的 F 和 NRI 字段，以及 FU 头部的类型字段携带。FU 载荷可以具有任何数量的字节且可以是空的。</p>
<p>资料性说明：允许空的 FUs 减少几乎无损环境中某一类发送者的延迟。这些发送者的特征是，它们在 NALU 完全生成之前打包 NALU 片段，因此，在 NALU 大小已知之前。如果不允许零长度 NALU 片段，则发送方必须在可以发送当前片段之前，生成后面的片段的至少一位数据。由于H.264的特点，有时几个宏块占用零个位，这是不希望的，并且可以增加延迟。然而，应该仔细权衡零长度 NALU 片段的（潜在）使用，因为用于传输的附加数据包，NALU 的至少一部分丢失的风险增加了。</p>
<p>如果分片单元丢失了，则接收者应该丢弃以传输顺序对应于相同被分片 NAL 单元的所有后面的分片单元。</p>
<p>一端的接收者或 MANE 中可以聚合 NAL 单元的前面 n - 1 个片段为一个（不完整的）NAL 单元，即使那个 NAL 单元的片段 n 没有收到。在这种情况下，NAL 单元的 forbidden_zero_bit 必须被设置为 1 以表示语法违规。</p>
<h1 id="NAL-单元类型码"><a href="#NAL-单元类型码" class="headerlink" title="NAL 单元类型码"></a>NAL 单元类型码</h1><p><img src="https://www.wolfcstech.com/images/1315506-475027950d4a524d.png" alt="NAL 单元类型码"></p>
<h3 id="打赏"><a href="#打赏" class="headerlink" title="打赏"></a><a href="https://www.wolfcstech.com/about/donate.html">打赏</a></h3><p><a href="https://tools.ietf.org/html/rfc6184" target="_blank" rel="external">原文</a></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wxpay.png" alt="Han Pengfei WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Han Pengfei Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/翻译/" rel="tag"># 翻译</a>
          
            <a href="/tags/音视频开发/" rel="tag"># 音视频开发</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/08/12/working/" rel="next" title="从工作中得到了什么？">
                <i class="fa fa-chevron-left"></i> 从工作中得到了什么？
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/08/23/h264_play/" rel="prev" title="原始 H.264 码流播放">
                原始 H.264 码流播放 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/freesoft.jpg"
                alt="Han Pengfei" />
            
              <p class="site-author-name" itemprop="name">Han Pengfei</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">161</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/hanpfei" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.douban.com/people/3681478/" target="_blank" title="豆瓣"><i class="fa fa-fw fa-globe"></i>豆瓣</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/han-peng-fei-49" target="_blank" title="知乎"><i class="fa fa-fw fa-globe"></i>知乎</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:hanpfei@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.trinea.cn/" title="Trinea" target="_blank">Trinea</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-介绍"><span class="nav-number">2.</span> <span class="nav-text">1. 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-H-264-Codec"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 H.264 Codec</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-参数集概念"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 参数集概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-网络抽象层单元类型"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 网络抽象层单元类型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-载荷格式"><span class="nav-number">3.</span> <span class="nav-text">5. 载荷格式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-RTP-Header-用法"><span class="nav-number">3.1.</span> <span class="nav-text">5.1 RTP Header 用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-载荷结构"><span class="nav-number">3.2.</span> <span class="nav-text">5.2 载荷结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-NAL-单元头部使用"><span class="nav-number">3.3.</span> <span class="nav-text">5.3 NAL 单元头部使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-打包模式"><span class="nav-number">3.4.</span> <span class="nav-text">5.4 打包模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-解码顺序号（DON）"><span class="nav-number">3.5.</span> <span class="nav-text">5.5 解码顺序号（DON）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-6-单-NAL-单元包"><span class="nav-number">3.6.</span> <span class="nav-text">5.6 单 NAL 单元包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-7-聚合包"><span class="nav-number">3.7.</span> <span class="nav-text">5.7 聚合包</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-7-1-单时间聚合包（STAP）"><span class="nav-number">3.7.1.</span> <span class="nav-text">5.7.1 单时间聚合包（STAP）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-7-2-多时间聚合包（MTAPs）"><span class="nav-number">3.7.2.</span> <span class="nav-text">5.7.2 多时间聚合包（MTAPs）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-8-分片单元（FUs）"><span class="nav-number">3.8.</span> <span class="nav-text">5.8 分片单元（FUs）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#NAL-单元类型码"><span class="nav-number">4.</span> <span class="nav-text">NAL 单元类型码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#打赏"><span class="nav-number">4.0.1.</span> <span class="nav-text">打赏</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016.09.16 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Han Pengfei</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.3"></script>



  



	





  





  






<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname,
            owner: 'hanpfei',
            repo: 'blog_comment',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '2e5e06c86dfee4177d58dd4660d1ed4bce4f155d',
            
                client_id: '0ec580f0a999fbe77a63'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("KUAjB88PxNQR5DOgg6jhgdp7-gzGzoHsz", "3c3yzt2EN31aXwYgVdmzDUUk");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

</body>
</html>
