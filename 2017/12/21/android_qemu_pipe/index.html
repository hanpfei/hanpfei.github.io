<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="mask-icon" href="/images/freesoft.jpg?v=6.0.3" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="虚拟化,翻译,Android开发," />


<meta name="description" content="介绍Android 模拟器实现了一个特殊的虚拟设备，用于提供客户 Android 系统和模拟器本身 非常 快速的通信通道。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android QEMU 高速管道">
<meta property="og:url" content="https://www.wolfcstech.com/2017/12/21/android_qemu_pipe/index.html">
<meta property="og:site_name" content="WolfcsTech">
<meta property="og:description" content="介绍Android 模拟器实现了一个特殊的虚拟设备，用于提供客户 Android 系统和模拟器本身 非常 快速的通信通道。">
<meta property="og:updated_time" content="2017-12-21T08:32:47.741Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android QEMU 高速管道">
<meta name="twitter:description" content="介绍Android 模拟器实现了一个特殊的虚拟设备，用于提供客户 Android 系统和模拟器本身 非常 快速的通信通道。">






  <link rel="canonical" href="https://www.wolfcstech.com/2017/12/21/android_qemu_pipe/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>Android QEMU 高速管道 | WolfcsTech</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-109419024-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-109419024-1');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WolfcsTech</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="http://www.ixirong.com/404.html" rel="section">
            <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />Commonweal 404</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.wolfcstech.com/2017/12/21/android_qemu_pipe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Han Pengfei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/freesoft.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WolfcsTech">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android QEMU 高速管道</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-21T13:05:49+08:00">2017-12-21</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/虚拟化/" itemprop="url" rel="index"><span itemprop="name">虚拟化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/12/21/android_qemu_pipe/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2017/12/21/android_qemu_pipe/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/12/21/android_qemu_pipe/" class="leancloud_visitors" data-flag-title="Android QEMU 高速管道">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Android 模拟器实现了一个特殊的虚拟设备，用于提供客户 Android 系统和模拟器本身 <strong><em>非常</em></strong> 快速的通信通道。<br><a id="more"></a><br>在客户 Android 系统端，用法非常简单，如下：</p>
<p>  1/ 打开 /dev/qemu_pipe 设备文件来读和写<br>     注意：自 Linux 3.10 开始，设备被重命名为了 <code>/dev/goldfish_pipe</code>，但行为完全一样。</p>
<p>  2/ 写入描述你想要连接的服务，且以 0 结束的字符串。</p>
<p>  3/ 简单地使用 read() 和 write() 来与服务通信。</p>
<p>换句话说：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">fd = <span class="keyword">open</span>(<span class="string">"/dev/qemu_pipe"</span>, O_RDWR);</div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span>* pipeName = <span class="string">"&lt;pipename&gt;"</span>;</div><div class="line"><span class="keyword">ret</span> = write(fd, pipeName, <span class="built_in">strlen</span>(pipeName)+1);</div><div class="line"><span class="keyword">if</span> (<span class="keyword">ret</span> &lt; 0) &#123;</div><div class="line">    <span class="comment">// error</span></div><div class="line">&#125;</div><div class="line">... ready to go</div></pre></td></tr></table></figure></p>
<p>其中 <code>&lt;pipename&gt;</code> 是你想要使用的特定模拟器服务的名字。本文档在后面列出了支持的模拟器服务的名字。</p>
<h2 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h2><p>在模拟器的源码树中：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./hw/android/goldfish/pipe<span class="selector-class">.c</span>  实现虚拟驱动。</div><div class="line">./hw/android/goldfish/pipe<span class="selector-class">.h</span> 提供了任何模拟器 pipe 服务必须提供的接口。</div><div class="line">./android/hw-pipe-net<span class="selector-class">.c</span> 包含网络 pipe 服务（比如 <span class="string">'tcp'</span> 和 <span class="string">'unix'</span>）的实现。更多详情参考下文。</div></pre></td></tr></table></figure></p>
<p><strong><em>模拟器根据所使用的 Android Linux 内核的不同，而有两个不同的版本，即使用 goldfish 内核的 QEMU1 和使用 ranchu 内核的 QEMU2。上面列出的这些文件，是用于 QEMU1 的相关文件。这些文件在 emulator 2.3 release 版本代码库中的具体位置分别为 <code>qemu/android/qemu1/hw/android/goldfish/pipe.c</code>，<code>qemu/android/qemu1/include/hw/android/goldfish/pipe.h</code>，而 <code>hw-pipe-net.c</code> 文件则已经被移除了。关于网络虚拟化的代码，分布于 <code>qemu/net/</code>、<code>qemu/hw/net/</code> 目录下。</em></strong></p>
<p>在内核源码树中：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">   drivers<span class="meta-keyword">/misc/</span>qemupipe/qemu_pipe.c 包含在客户系统内，可通过 <span class="meta-keyword">/dev/</span>qemu_pipe</div><div class="line">访问的驱动源码。</div></pre></td></tr></table></figure></p>
<p><strong><em>这文件当然是在模拟器版的 Linux 内核中，也就是从 <code>git clone https://android.googlesource.com/kernel/goldfish</code> clone 下来的代码中，且在 <code>android-goldfish-3.4</code> 分支中。如在前面提到的，自 3.10 版内核开始，设备被重命名为了 <code>/dev/goldfish_pipe</code>，实现该设备的驱动程序文件也变为了 <code>goldfish/drivers/platform/goldfish/goldfish_pipe.c</code></em></strong></p>
<h2 id="设备-驱动协议细节"><a href="#设备-驱动协议细节" class="headerlink" title="设备 / 驱动协议细节"></a>设备 / 驱动协议细节</h2><p>设备和驱动使用一个 I/O 内存页和一个 IRQ 来通信。</p>
<ul>
<li><p>驱动写入不同的 I/O 寄存器来向设备发送命令。</p>
</li>
<li><p>设备触发一个 IRQ 通知驱动某一事件发生了。</p>
</li>
<li><p>驱动读取 I/O 寄存器获得它的最新命令的状态，或者在中断的情况下发生的事件的列表。</p>
</li>
</ul>
<p>客户系统内每个打开的 <code>/dev/qemu_pipe</code> 的文件描述符对应一个由驱动分配的 32 位的 <strong>‘通道’</strong> 值。</p>
<p>下面的内容描述了驱动向设备发送的不同命令。以 <code>REG_</code> 开头的可变的名字对应于 32 位的 I/O 寄存器：</p>
<p>  0/ 通道和地址值</p>
<p>   依赖于客户系统的 CPU 架构，每个通信通道由一个非零的 32 位或 64 位值标识。</p>
<p>   由内核向模拟器发送的通道值为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_channel</span><span class="params">(channel)</span> </span>&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> 64BIT_GUEST_CPU</span></div><div class="line">  REG_CHANNEL_HIGH = (channel &gt;&gt; <span class="number">32</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">  REG_CHANNEL = (channel &amp; <span class="number">0xffffffff</span>U);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  类似地，当给模拟器传递一个内核地址时：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">void write_address(<span class="keyword">buffer_address) </span>&#123;</div><div class="line"><span class="comment">#if 64BIT_GUEST_CPU</span></div><div class="line">  REG_ADDRESS_HIGH = (<span class="keyword">buffer_address </span>&gt;&gt; <span class="number">32</span>)<span class="comment">;</span></div><div class="line"><span class="comment">#endif</span></div><div class="line">  REG_ADDRESS = (<span class="keyword">buffer_address </span>&amp; <span class="number">0xffffffff</span>U)<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  1/ 创建一个新的通道</p>
<p>   驱动用来表示客户系统打开了将由名称 ‘<channel>‘ 标识的 <code>/dev/qemu_pipe</code>：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">write_channel</span><span class="params">(&lt;channel&gt;)</span></span></div><div class="line">REG_CMD = CMD_OPEN</div></pre></td></tr></table></figure></channel></p>
<p>   重要：<code>&lt;channel&gt;</code> 从不应该为 0</p>
<p>  2/ 关闭一个通道</p>
<p>   驱动用来表示客户系统调用了通道文件描述符的 ‘close’。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">write_channel</span><span class="params">(&lt;channel&gt;)</span></span></div><div class="line">REG_CMD = CMD_CLOSE</div></pre></td></tr></table></figure>
<p>  3/ 向通道写入数据</p>
<p>   对应于客户系统在通道的文件描述符上执行 <code>write()</code> 或 <code>writev()</code>。这个命令用于发送一个单独的内存缓冲区：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">write_channel</span><span class="params">(&lt;channel&gt;)</span></span></div><div class="line"><span class="function"><span class="title">write_address</span><span class="params">(&lt;buffer-address&gt;)</span></span></div><div class="line">REG_SIZE    = &lt;buffer-size&gt;</div><div class="line">REG_CMD     = CMD_WRITE_BUFFER</div><div class="line"></div><div class="line">status = REG_STATUS</div></pre></td></tr></table></figure>
<p>  注意：<code>&lt;buffer-address&gt;</code> 是 <strong><em>客户系统</em></strong> 的缓冲区地址，而不是物理的/内核的。</p>
<p>  重要：通过这个命令发送的缓冲区 <strong><em>应该总是</em></strong> 被完整的包含在一个客户系统的内存页内。这是强制的，用以简化驱动程序和设备。<br>  如果一个 <code>write()</code> 跨越多个客户系统的内存页，驱动将连续触发多个，对客户端透明的 <code>CMD_WRITE_BUFFER</code> 命令。</p>
<p>  <code>REG_STATUS</code> 返回的值应该是：</p>
<p>   <code>&gt; 0</code>  写入 pipe 的字节数<br>   <code>0</code>   表示流结束状态<br>   <code>&lt; 0</code>  负值错误码（参考下文）。</p>
<p>  一个重要的错误码是 <code>PIPE_ERROR_AGAIN</code>，用于表示写操作还不能执行。参考 <code>CMD_WAKE_ON_WRITE</code> 了解更多内容。</p>
<p>  4/ 从通道读取数据</p>
<p>  对应于客户系统在通道的文件描述符上执行 <code>read()</code> 和 <code>readv()</code>。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">write_channel</span><span class="params">(&lt;channel&gt;)</span></span></div><div class="line"><span class="function"><span class="title">write_address</span><span class="params">(&lt;buffer-address&gt;)</span></span></div><div class="line">REG_SIZE    = &lt;buffer-size&gt;</div><div class="line">REG_CMD     = CMD_READ_BUFFER</div><div class="line"></div><div class="line">status = REG_STATUS</div></pre></td></tr></table></figure></p>
<p>  有着相同的缓冲区地址/长度限制和相同的错误码集合。</p>
<p>  5/ 等待写能力</p>
<p>  如果 <code>CMD_WRITE_BUFFER</code> 返回 <code>PIPE_ERROR_AGAIN</code>，且文件描述符不是处于非阻塞模式，驱动必须把客户端任务放进一个等待队列中，直到 pipe 服务可以再次接受数据。</p>
<p>  在此之前，驱动将执行：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">write_channel</span><span class="params">(&lt;channel&gt;)</span></span></div><div class="line">REG_CMD     = CMD_WAKE_ON_WRITE</div></pre></td></tr></table></figure></p>
<p>  以向虚拟设备表明，它正在等待，并应该在 pipe 再次变得可写时被唤醒。稍后将解释这是如何完成的。</p>
<p>  6/ 等待读能力</p>
<p>  这与 <code>CMD_WAKE_ON_WRITE</code> 一样，但要替换为读能力。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">write_channel</span><span class="params">(&lt;channel&gt;)</span></span></div><div class="line">REG_CMD     = CMD_WAKE_ON_READ</div></pre></td></tr></table></figure>
<p>  7/ 轮询（polling）可读/可写状态</p>
<p>  下面的命令由驱动用于实现 <code>select()</code>，<code>poll()</code> 和 <code>epoll()</code> 系统调用，其中包含一个 pipe 通道。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">write_channel</span><span class="params">(&lt;channel&gt;)</span></span></div><div class="line">REG_CMD     = CMD_POLL</div><div class="line"><span class="attribute">mask</span> = REG_STATUS</div></pre></td></tr></table></figure>
<p>  REG_STATUS 返回的掩码值是自上次调用以来，哪些事件可用/已经发生的位标记的混合。参考 <code>PIPE_POLL_READ</code> / <code>PIPE_POLL_WRITE</code> / <code>PIPE_POLL_CLOSED</code>。</p>
<p>  8/ 向驱动通知事件</p>
<p>  设备可以通过生成它的 IRQ 来向驱动通知事件。驱动的中断处理器随后将读取一个以单独的 0 值结束的通道的 (channel,mask) 对的列表。</p>
<p>  换句话说，驱动的中断处理器将执行：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">for</span> (;;) &#123;</div><div class="line">    channel = REG_CHANNEL</div><div class="line">    <span class="built_in">if</span> (channel == <span class="number">0</span>)  <span class="comment">// END OF LIST</span></div><div class="line">        <span class="built_in">break</span>;</div><div class="line"></div><div class="line">    mask = REG_WAKES  <span class="comment">// BIT FLAGS OF EVENTS</span></div><div class="line">    ... <span class="built_in">process</span> events</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  通过这个列表报告的事件很简单：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="bullet">PIPE_WAKE_READ   :: </span>通道现在可读。</div><div class="line"><span class="bullet">PIPE_WAKE_WRITE  :: </span>通道现在可写。</div><div class="line"><span class="bullet">PIPE_WAKE_CLOSED :: </span>pipe 服务关闭了连接</div></pre></td></tr></table></figure></p>
<p>  如果 <code>CMD_WAKE_ON_READ</code> 或 <code>CMD_WAKE_ON_WRITE</code>（分别地）为给定通道发出，则 <code>PIPE_WAKE_READ</code> 和 <code>PIPE_WAKE_WRITE</code> 仅向它报告。</p>
<p>  <code>PIPE_WAKE_CLOSED</code> 可以在任何时间通知。</p>
<p>  9/ 通过参数块的更快的读/写</p>
<p>  最近的 Goldfish 内核实现了一种更快的方式来执行读和写，它每个操作执行一个单独的 I/O 写操作（当通过 KVM 或 HAX 模拟 x86 系统时很有用）。</p>
<p>  它使用下面同时为虚拟设备和内核所知的结构，在 <code>$QEMU/hw/android/goldfish/pipe.h</code> 中定义：</p>
<p>  32 位客户系统 CPU 的是：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> access_params &#123;</div><div class="line">    <span class="keyword">uint32_t</span> channel;</div><div class="line">    <span class="keyword">uint32_t</span> size;</div><div class="line">    <span class="keyword">uint32_t</span> address;</div><div class="line">    <span class="keyword">uint32_t</span> cmd;</div><div class="line">    <span class="keyword">uint32_t</span> result;</div><div class="line">    <span class="comment">/* reserved for future extension */</span></div><div class="line">    <span class="keyword">uint32_t</span> flags;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>  64 位的是：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> access_params_64 &#123;</div><div class="line">    <span class="keyword">uint64_t</span> channel;</div><div class="line">    <span class="keyword">uint32_t</span> size;</div><div class="line">    <span class="keyword">uint64_t</span> address;</div><div class="line">    <span class="keyword">uint32_t</span> cmd;</div><div class="line">    <span class="keyword">uint32_t</span> result;</div><div class="line">    <span class="comment">/* reserved for future extension */</span></div><div class="line">    <span class="keyword">uint32_t</span> flags;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>  这是把多个参数打包进一个单独的结构的简单的方式。起初的，比如，在启动时间，内核将分配一个这样的结构，并这样传递它的物理地址：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">PARAMS_ADDR_LOW</span>  = (params &amp; <span class="number">0</span>xffffffff);</div><div class="line"><span class="attr">PARAMS_ADDR_HIGH</span> = (params &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0</span>xffffffff;</div></pre></td></tr></table></figure></p>
<p>  然后对于每个操作，它将做这样一些事情：<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">params.<span class="attr">channel</span> = channel;</div><div class="line">params.<span class="attr">address</span> = buffer;</div><div class="line">params.<span class="attr">size</span> = buffer_size;</div><div class="line">params.<span class="attr">cmd</span> = CMD_WRITE_BUFFER (<span class="literal">or</span> CMD_READ_BUFFER)</div><div class="line"></div><div class="line"><span class="attr">REG_ACCESS_PARAMS</span> = &lt;any&gt;</div><div class="line"></div><div class="line"><span class="attr">status</span> = params.status</div></pre></td></tr></table></figure></p>
<p>  向 <code>REG_ACCESS_PARAMS</code> 写入将触发操作，比如 QEMU 将读取参数块的内容，使用它的字段来执行操作，然后把返回值写回 <code>params.status</code>。</p>
<p>10/ v2 pipe: 通过命令缓冲区和缓冲区列表的更快的读/写</p>
<p>  批量 access_params 依然一次只能执行一个缓冲区传输。这对于每次传输只使用一个内存页的应用来说是 OK 的，但对于许多延迟/吞吐量敏感的应用，比如 OpenGL 和 ADB push/pull，每次操作一个缓冲区/页是不够的。</p>
<p>  理想情况下，如果客户系统想要传输缓冲区，那么应该尽可能地像在一个步骤中完成。</p>
<p>  但是，客户系统的内存页更可能是分散在多个位置，且不是物理上连续的，使得这变得很困难。</p>
<p>  v2 Goldfish pipe 驱动和设备修改了寄存器集合以及 device/pipe 结构，以允许 <code>goldfish_pipe_read_write</code> 的每个循环传输更多的缓冲区，为所有吞吐量受限的 pipe 用户提升性能。</p>
<p>  有两个关键的新结构要考虑。</p>
<ol>
<li><p>v2 pipe 添加了一个 <code>struct goldfish_pipe_command</code> 来表示在一个 I/O 事务中传输多个缓冲区：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* A per-pipe command structure, shared with the host */</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">goldfish_pipe_command</span></span> &#123;</div><div class="line">	s32 cmd;		<span class="comment">/* PipeCmdCode, guest -&gt; host */</span></div><div class="line">	s32 id;			<span class="comment">/* pipe id, guest -&gt; host */</span></div><div class="line">	s32 status;		<span class="comment">/* command execution status, host -&gt; guest */</span></div><div class="line">	s32 reserved;	<span class="comment">/* to pad to 64-bit boundary */</span></div><div class="line">	union &#123;</div><div class="line">		<span class="comment">/* Parameters for PIPE_CMD_&#123;READ,WRITE&#125; */</span></div><div class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">			<span class="keyword">u64</span> ptrs[MAX_BUFFERS_PER_COMMAND]; 	<span class="comment">/* buffer pointers, guest -&gt; host */</span></div><div class="line">			<span class="keyword">u32</span> sizes[MAX_BUFFERS_PER_COMMAND];	<span class="comment">/* buffer sizes, guest -&gt; host */</span></div><div class="line">			<span class="keyword">u32</span> buffers_count;					<span class="comment">/* number of buffers, guest -&gt; host */</span></div><div class="line">			s32 consumed_size;					<span class="comment">/* number of consumed bytes, host -&gt; guest */</span></div><div class="line">		&#125; rw_params;</div><div class="line">	&#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>对于每个 pipe fd，都有一个对应的 <code>goldfish_pipe_command</code> 结构，它可以持有最多 <code>MAX_BUFFERS_PER_COMMAND</code> （具体地说，目前为 10^2）个缓冲区。缓冲区中包含客户系统内在 rw_params 中追踪的数据。需要做些努力来使列表尽可能短（比如，合并物理上连续的页等）。</p>
</li>
<li><p>以前，对于主机触发的传输，我们遍历具有挂起的 actions (PIPE<em>WAKE</em><em>*</em>) 的 pipe 的链表，称为 “signaled pipes” 列表，中断处理器在每次传输发生时将粗略地处理 1-3 个这样的 pipes。这不是很理想，因为 a) 我们在中断处理器中执行任务和 b) 在客户系统中运行内核驱动与在主机上运行虚拟设备之间可能有大量的事务（事务很慢）。</p>
<p>因此，pipe v2 记录了一系列来自于主机 IRQ 触发的要处理的 pipe：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Device-level set of buffers shared with the host */</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">goldfish_pipe_dev_buffers</span></span> &#123;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">open_command_param</span></span> open_command_params;</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">signalled_pipe_buffer</span></span> signalled_pipe_buffers[MAX_SIGNALLED_PIPES];</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>且每个中断处理器一次可以处理最多 MAX_SIGNALLED_PIPES 个。此外，唤醒被通知的 pipes 的工作被留给了一个 bottom-half 处理器，且不在中断上下文中完成。</p>
<p>11/ goldfish_dma：从主机系统直接访问客户系统上的内存</p>
<p>有时，对于同时需要非常高的吞吐量及非常低的延时的应用，比如视频回放，跳过主机/客户事务及收集非连续的缓冲区，而直接写入对主机系统也可见的内存可能是很有用的。</p>
<p>为了做到这一点，<code>goldfish_dma</code> 允许任何 pipe fd 用 ioctls 在内核空间分配一块连续的物理区域，然后从客户系统的用户空间 mmap() 到那个物理区域。这些区域也可以跨进程共享，比如通过 gralloc。</p>
<p><code>goldfish_dma</code> 内核驱动将  <code>struct goldfish_dma_context</code> 添加到所有的 <code>struct goldfish_pipe</code> 实例中：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">goldfish_dma_context</span></span> &#123;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span></span> kref; <span class="comment">/* kref to safely free dma region */</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span></span>* pdev_dev; <span class="comment">/* pointer to feed to dma_***_coherent */</span></div><div class="line">    void* dma_vaddr; <span class="comment">/* kernel vaddr of dma region */</span></div><div class="line">    dma_addr_t dma_bus_addr; <span class="comment">/* kernel dma_addr_t of dma region */</span></div><div class="line">    <span class="keyword">u64</span> dma_size; <span class="comment">/* size of dma region */</span></div><div class="line">	<span class="keyword">u64</span> phys_begin; <span class="comment">/* paddr of dma region */</span></div><div class="line">	unsigned long pfn; <span class="comment">/* pfn of dma region */</span></div><div class="line">	<span class="keyword">u64</span> phys_end; <span class="comment">/* paddr of dma region + dma_size */</span></div><div class="line">	<span class="keyword">bool</span> locked; <span class="comment">/* marks whether the region is currently in use */</span></div><div class="line">    unsigned long refcount; <span class="comment">/* For debugging purposes only. */</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">goldfish_pipe_command</span></span>* command_buffer; <span class="comment">/* For safe freeing of DMA regions,</span></div><div class="line">    we need another pipe command buffer that lives longer than the pipe instance */</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Interface (guest side):</div></pre></td></tr></table></figure>
<p>客户系统用户在一个 goldfish pipe fd 上调用 goldfish_dma_alloc (ioctls) 以及 mmap()，这意味着它想要高速访问主机可见的内存。</p>
<p>然后客户系统可以写入 <code>mmap()</code> 返回的指针，随后这些写入在主机上变得立即可见而无需 BQL 及上下为切换。</p>
<p>主要的数据结构跟踪状态是 <code>struct goldfish_dma_context</code>，它作为一个额外的指针成员而被包含在 <code>struct goldfish_pipe</code> 中。每个这样的上下文可能与由一个物理地址和大小描述的分配的 DMA 区域关联，且对于每个 pipe fd 只允许有一次分配。更多的分配需要 pipe fd 的更多 <code>open()</code>。</p>
<p><code>dma_alloc_coherent()</code> 被用于获得连续的物理内存区域，然后我们在客户系统和主机系统上分配并与这一区域交互，通过如下的 ioctls：</p>
</li>
</ol>
<ul>
<li>LOCK：为数据访问锁定 DMA 区域。</li>
<li>UNLOCK：解锁 DMA 区域。这也可能在主机系统上通过 WAKE_ON_UNLOCK_DMA 完成。</li>
<li>CREATE_REGION：为一个 DMA 区域初始化大小信息。</li>
<li>GETOFF：发送物理地址给客户系统驱动。</li>
<li><p>(UN)MAPHOST：使用 <code>goldfish_pipe_cmd</code> 告诉主机系统，(un)map 与当前 dma 上下文关联的客户系统的物理地址。这使物理的连续内存对于主机系统 (不) 可见。</p>
<p>客户系统用户空间使用 <code>mmap()</code> 获得一个指向 DMA 内存的指针，它也用 <code>dma_alloc_coherent()</code> 来延迟分配内存。（在最后一个 pipe <code>close()</code> 中，该区域被释放）。</p>
</li>
</ul>
<p>  <code>mmap()</code> 映射的区域可以处理非常高带宽的传输，且 pipe 操作可与处理同步和命令通信一起使用。</p>
<p>  在内核驱动中虚拟设备有这些 hooks：</p>
<ol>
<li>UNLOCK_DMA：从主机系统中解锁 DMA 区域。</li>
<li><p>MAP/UNMAP_HOST：这是一个 pipe 命令，用于告诉主机获得一个主机的 <code>void*</code> 指向特定的客户系统 RAM 物理地址。当通过 <code>ioctl()</code> 在客户系统的内核中分配一个新的 DMA 缓冲区时触发，以使主机系统也可以看到相同的区域。</p>
<p>然后主机系统将调用 <code>cpu_physical_memory_(un)map</code> 并在一个全局的数据结构  (DmaMap) 中追踪所有当前分配的区域。如果我们拍快照，我们将需要 remap 那些区域，一些东西也由 <code>DmaMap</code> 处理。</p>
</li>
<li><p>UNLOCK_DMA：这个 pipe 命令通知客户系统内核，主机系统完成了对 DMA 区域的处理。在大多数简单的用户案例中，客户系统将首先锁定它的 DMA 区域然后写入它，假设处理完成后 unlock 将由主机系统触发。UNLOCK_DMA 是主机如何触发这种解锁的方式。</p>
</li>
</ol>
<h2 id="可用的服务"><a href="#可用的服务" class="headerlink" title="可用的服务"></a>可用的服务</h2><p>  tcp:<port></port></p>
<p>   打开一个到给定 localhost 端口的 TCP socket。它提供了一个不依赖于非常慢的内部模拟器 NAT 路由器的非常快速的通道。注意，你只能以 <code>read()</code> 和 <code>write()</code> 使用文件描述符，<code>send()</code> 和 <code>recv()</code> 将返回一个 <code>ENOTSOCK</code> 错误，任何 socket 的 <code>ioctl()</code> 也是。</p>
<p>   出于安全原因，无法连接非 localhost 端口。</p>
<p>  unix:<path></path></p>
<p>   打开一个主机上的 Unix 域 socket。</p>
<p>  opengles</p>
<p>   连接 OpenGL ES 模拟进程。目前为止，其实现等价于 tcp:22468，但在未来这可能会改变。</p>
<p>  qemud</p>
<p>   连接模拟器内部的 QEMUD 服务。它替代了在老的 Android 平台发行版本上通过 <code>/dev/ttyS1</code> 执行的连接。详情请参考 <code>$QEMU/android/docs/ANDROID-QEMUD.TXT</code>。</p>
<h3 id="打赏"><a href="#打赏" class="headerlink" title="打赏"></a><a href="https://www.wolfcstech.com/about/donate.html">打赏</a></h3><p>原文  —- emu-2.4-release/external/qemu/android/docs/ANDROID-QEMU-PIPE.TXT</p>
<p>Done.</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wxpay.png" alt="Han Pengfei WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Han Pengfei Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/虚拟化/" rel="tag"># 虚拟化</a>
          
            <a href="/tags/翻译/" rel="tag"># 翻译</a>
          
            <a href="/tags/Android开发/" rel="tag"># Android开发</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/06/anbox_lxc/" rel="next" title="Anbox LXC">
                <i class="fa fa-chevron-left"></i> Anbox LXC
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/22/qemu_network_emulation/" rel="prev" title="QEMU 网络虚拟化">
                QEMU 网络虚拟化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/freesoft.jpg"
                alt="Han Pengfei" />
            
              <p class="site-author-name" itemprop="name">Han Pengfei</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">161</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/hanpfei" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.douban.com/people/3681478/" target="_blank" title="豆瓣"><i class="fa fa-fw fa-globe"></i>豆瓣</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/han-peng-fei-49" target="_blank" title="知乎"><i class="fa fa-fw fa-globe"></i>知乎</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:hanpfei@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.trinea.cn/" title="Trinea" target="_blank">Trinea</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#介绍"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现细节"><span class="nav-number">2.</span> <span class="nav-text">实现细节</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设备-驱动协议细节"><span class="nav-number">3.</span> <span class="nav-text">设备 / 驱动协议细节</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#可用的服务"><span class="nav-number">4.</span> <span class="nav-text">可用的服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#打赏"><span class="nav-number">4.1.</span> <span class="nav-text">打赏</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016.09.16 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Han Pengfei</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.3"></script>



  



	





  





  






<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname,
            owner: 'hanpfei',
            repo: 'blog_comment',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '2e5e06c86dfee4177d58dd4660d1ed4bce4f155d',
            
                client_id: '0ec580f0a999fbe77a63'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("KUAjB88PxNQR5DOgg6jhgdp7-gzGzoHsz", "3c3yzt2EN31aXwYgVdmzDUUk");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

</body>
</html>
