<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>TCP异常终止 | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">TCP异常终止</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">TCP异常终止</h1><div class="post-meta">Jun 8, 2017<span> | </span><span class="category"><a href="/categories/网络调试/">网络调试</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/06/08/tcp_unexpected_termination/" href="/2017/06/08/tcp_unexpected_termination/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>TCP 的异常终止是相对于正常释放 TCP 连接的过程而言的，我们都知道，TCP 连接的建立是通过三次握手完成的，而 TCP 正常释放连接是通过四次挥手来完成，但是有些情况下，TCP 在交互过程中会出现一些意想不到的情况，导致 TCP 无法按照正常的四次挥手来释放连接，如果此时不通过其他的方式来释放 TCP 连接的话，这个 TCP 连接将会一直存在，占用系统的部分资源。在这种情况下，我们就需要有一种能够释放 TCP 连接的机制，这种机制就是 TCP 的 Reset 报文。Reset 报文是指 TCP 报头的标志字段中的 Reset 位设置为一的报文，如下图所示：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-9dcac36fb9aede73.png" alt=""></p>
<p>我们在实际的工作环境中，导致某一方发送 Reset 报文的情形有多种。</p>
<h2 id="服务器端口未对外提供服务"><a href="#服务器端口未对外提供服务" class="headerlink" title="服务器端口未对外提供服务"></a>服务器端口未对外提供服务</h2><p>客户端尝试与服务器未对外提供服务的端口建立 TCP 连接，服务器将会直接向客户端发送 Reset 报文。</p>
<p><img src="https://www.wolfcstech.com/images/1315506-46db03ea0ad67aae.png" alt=""></p>
<p>通过共享 WiFi 热点的方式，用 Wireshark 抓包来看这个过程中网络包的交互，在 Android 客户端 Java 代码中访问服务器一个不提供服务的端口 442：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-116ae322c3296e16.png" alt=""></p>
<p>如上图，第 1 号和 2 号包，是客户端发向服务器，用于建立 TCP 连接的 SYN 包，随后立即就收到了服务器返回的 <strong><em>[RST，ACK]</em></strong> 包。</p>
<p>以 OkHttp 做为客户端 Java HttpStack 库，这种情况下将抛出如下异常：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">java<span class="selector-class">.net</span><span class="selector-class">.ConnectException</span>: Failed to connect to www<span class="selector-class">.wolfcstech</span><span class="selector-class">.com</span>/<span class="number">139.196</span>.<span class="number">224.72</span>:<span class="number">442</span></div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connectSocket</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">222</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connect</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">146</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">186</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findHealthyConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">121</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.newStream</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">100</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.ConnectInterceptor</span><span class="selector-class">.intercept</span>(ConnectInterceptor<span class="selector-class">.java</span>:<span class="number">42</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.cache</span><span class="selector-class">.CacheInterceptor</span><span class="selector-class">.intercept</span>(CacheInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.BridgeInterceptor</span><span class="selector-class">.intercept</span>(BridgeInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RetryAndFollowUpInterceptor</span><span class="selector-class">.intercept</span>(RetryAndFollowUpInterceptor<span class="selector-class">.java</span>:<span class="number">120</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.netlib</span><span class="selector-class">.OkHttp3Utils</span><span class="variable">$MyInterceptor</span>.intercept(OkHttp3Utils<span class="selector-class">.java</span>:<span class="number">29</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.RealCall</span><span class="selector-class">.getResponseWithInterceptorChain</span>(RealCall<span class="selector-class">.java</span>:<span class="number">179</span>)</div><div class="line">    at okhttp3.RealCall<span class="variable">$AsyncCall</span>.execute(RealCall<span class="selector-class">.java</span>:<span class="number">129</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.NamedRunnable</span><span class="selector-class">.run</span>(NamedRunnable<span class="selector-class">.java</span>:<span class="number">32</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1112</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.run(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">587</span>)</div><div class="line">    at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">841</span>)</div><div class="line">Caused by: java<span class="selector-class">.net</span><span class="selector-class">.ConnectException</span>: failed to connect to www<span class="selector-class">.wolfcstech</span><span class="selector-class">.com</span>/<span class="number">139.196</span>.<span class="number">224.72</span> (port <span class="number">442</span>) after <span class="number">10000ms</span>: isConnected failed: ECONNREFUSED (Connection refused)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.isConnected</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">223</span>)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.connectErrno</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">161</span>)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.connect</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">112</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.PlainSocketImpl</span><span class="selector-class">.connect</span>(PlainSocketImpl<span class="selector-class">.java</span>:<span class="number">192</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.PlainSocketImpl</span><span class="selector-class">.connect</span>(PlainSocketImpl<span class="selector-class">.java</span>:<span class="number">460</span>)</div><div class="line">    at java<span class="selector-class">.net</span><span class="selector-class">.Socket</span><span class="selector-class">.connect</span>(Socket<span class="selector-class">.java</span>:<span class="number">833</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.platform</span><span class="selector-class">.AndroidPlatform</span><span class="selector-class">.connectSocket</span>(AndroidPlatform<span class="selector-class">.java</span>:<span class="number">63</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connectSocket</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">220</span>)</div><div class="line">	... <span class="number">24</span> more</div><div class="line">Caused by: libcore<span class="selector-class">.io</span><span class="selector-class">.ErrnoException</span>: isConnected failed: ECONNREFUSED (Connection refused)</div><div class="line">    at libcore<span class="selector-class">.io</span><span class="selector-class">.IoBridge</span><span class="selector-class">.isConnected</span>(IoBridge<span class="selector-class">.java</span>:<span class="number">208</span>)</div></pre></td></tr></table></figure></p>
<p>OkHttp 抛出了 Java 异常 <code>java.net.ConnectException</code>，然而 libcore 层的异常显示，连接被拒绝：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">libcore<span class="selector-class">.io</span><span class="selector-class">.ErrnoException</span>: isConnected failed: ECONNREFUSED (Connection refused)</div></pre></td></tr></table></figure></p>
<h2 id="通信某一方异常崩溃"><a href="#通信某一方异常崩溃" class="headerlink" title="通信某一方异常崩溃"></a>通信某一方异常崩溃</h2><p>客户端和服务器的某一方在交互的过程中发生异常（如程序崩溃等），该方系统将向对端发送 TCP Reset 报文，告之对方释放相关的 TCP 连接，如下图所示：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-8580694a402e4d3a.png" alt=""></p>
<p>异常终止的一方，在进程退出时，释放占用的资源，包括 socket，TCP、UDP 端口等。站在异常退出的这一方的角度来看，对端是在访问一个没有打开的 socket。</p>
<p>通过如下方式模拟数据发送时，服务器端异常退出的情况：</p>
<ol>
<li>开启代理服务器，如 Fiddler，mitmproxy，或 Charles。</li>
<li>为 Android 设备配置代理服务器。</li>
<li>以 OkHttp 为 Android 应用 HTTP 客户端，在 OkHttp 中连接建立完成的地方打断点。</li>
<li>以 Debug 模式运行 Android 应用，执行一个 HTTP/HTTPS 请求，应用将停在连接建立完成的地方。</li>
<li>关掉代理服务器。</li>
<li>放开端点，继续执行 Android 应用。</li>
</ol>
<h3 id="HTTPS-请求-发送数据"><a href="#HTTPS-请求-发送数据" class="headerlink" title="HTTPS 请求-发送数据"></a>HTTPS 请求-发送数据</h3><p>前面的操作过程中，执行 HTTPS 请求，通过 Wireshark 抓包，得到如下结果：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-4b3570819c0bc3d8.png" alt=""></p>
<p>第 116 号包，Android 手机发送 TCP SYN 包，与代理服务器建立 TCP 连接。到第 118 号包，完成 TCP 三次握手，连接建立完成。</p>
<p>第119 号包到第121 号包，Android 应用请求代理服务器建立隧道连接，隧道连接建立完成。</p>
<p>第 123 号包是代理服务器进程在退出时，发送了 <strong><em>[FIN ACK]</em></strong> 结束 TCP 连接。</p>
<p>第 130 号包是在代理服务器关闭之后，Android 应用发送的数据，TLS 握手的 <strong><em>Client Hello </em></strong>。随后代理服务器主机立即响应了 RST 包给 Android 应用。</p>
<p>经过上面的操作，OkHttp 的执行将报错退出，报出的异常如下：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">javax<span class="selector-class">.net</span><span class="selector-class">.ssl</span><span class="selector-class">.SSLException</span>: Connection closed by peer</div><div class="line">    at com<span class="selector-class">.android</span><span class="selector-class">.org</span><span class="selector-class">.conscrypt</span><span class="selector-class">.NativeCrypto</span><span class="selector-class">.SSL_do_handshake</span>(Native Method)</div><div class="line">    at com<span class="selector-class">.android</span><span class="selector-class">.org</span><span class="selector-class">.conscrypt</span><span class="selector-class">.OpenSSLSocketImpl</span><span class="selector-class">.startHandshake</span>(OpenSSLSocketImpl<span class="selector-class">.java</span>:<span class="number">405</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connectTls</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">267</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.establishProtocol</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">237</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connect</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">148</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">186</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findHealthyConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">121</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.newStream</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">100</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.ConnectInterceptor</span><span class="selector-class">.intercept</span>(ConnectInterceptor<span class="selector-class">.java</span>:<span class="number">42</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.cache</span><span class="selector-class">.CacheInterceptor</span><span class="selector-class">.intercept</span>(CacheInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.BridgeInterceptor</span><span class="selector-class">.intercept</span>(BridgeInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RetryAndFollowUpInterceptor</span><span class="selector-class">.intercept</span>(RetryAndFollowUpInterceptor<span class="selector-class">.java</span>:<span class="number">120</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.netlib</span><span class="selector-class">.OkHttp3Utils</span><span class="variable">$MyInterceptor</span>.intercept(OkHttp3Utils<span class="selector-class">.java</span>:<span class="number">29</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.RealCall</span><span class="selector-class">.getResponseWithInterceptorChain</span>(RealCall<span class="selector-class">.java</span>:<span class="number">179</span>)</div><div class="line">    at okhttp3.RealCall<span class="variable">$AsyncCall</span>.execute(RealCall<span class="selector-class">.java</span>:<span class="number">129</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.NamedRunnable</span><span class="selector-class">.run</span>(NamedRunnable<span class="selector-class">.java</span>:<span class="number">32</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1112</span>)</div><div class="line">    at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.run(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">587</span>)</div><div class="line">    at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">841</span>)</div></pre></td></tr></table></figure></p>
<p>报出了  <strong>javax.net.ssl.SSLException: Connection closed by peer</strong>。</p>
<p>修改前面的操作，让 Android 客户端直接与远程 HTTP 服务器连接，在连接建立完成的时候，杀掉 HTTP 服务进程，其它保持完全不变，则无论是抓到的包，还是 OkHttp 报出的异常，基本都没有改变。抓到的包如下：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-9b5020536110a566.png" alt=""></p>
<p>OkHttp 抛出的异常如下：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">javax<span class="selector-class">.net</span><span class="selector-class">.ssl</span><span class="selector-class">.SSLException</span>: Connection closed by peer</div><div class="line">    at com<span class="selector-class">.android</span><span class="selector-class">.org</span><span class="selector-class">.conscrypt</span><span class="selector-class">.NativeCrypto</span><span class="selector-class">.SSL_do_handshake</span>(Native Method)</div><div class="line">    at com<span class="selector-class">.android</span><span class="selector-class">.org</span><span class="selector-class">.conscrypt</span><span class="selector-class">.OpenSSLSocketImpl</span><span class="selector-class">.startHandshake</span>(OpenSSLSocketImpl<span class="selector-class">.java</span>:<span class="number">405</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connectTls</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">267</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.establishProtocol</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">237</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.RealConnection</span><span class="selector-class">.connect</span>(RealConnection<span class="selector-class">.java</span>:<span class="number">148</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">186</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.findHealthyConnection</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">121</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.StreamAllocation</span><span class="selector-class">.newStream</span>(StreamAllocation<span class="selector-class">.java</span>:<span class="number">100</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.connection</span><span class="selector-class">.ConnectInterceptor</span><span class="selector-class">.intercept</span>(ConnectInterceptor<span class="selector-class">.java</span>:<span class="number">42</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.cache</span><span class="selector-class">.CacheInterceptor</span><span class="selector-class">.intercept</span>(CacheInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.BridgeInterceptor</span><span class="selector-class">.intercept</span>(BridgeInterceptor<span class="selector-class">.java</span>:<span class="number">93</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RetryAndFollowUpInterceptor</span><span class="selector-class">.intercept</span>(RetryAndFollowUpInterceptor<span class="selector-class">.java</span>:<span class="number">120</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.netlib</span><span class="selector-class">.OkHttp3Utils</span><span class="variable">$MyInterceptor</span>.intercept(OkHttp3Utils<span class="selector-class">.java</span>:<span class="number">29</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">92</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http</span><span class="selector-class">.RealInterceptorChain</span><span class="selector-class">.proceed</span>(RealInterceptorChain<span class="selector-class">.java</span>:<span class="number">67</span>)</div><div class="line">    at okhttp3<span class="selector-class">.RealCall</span><span class="selector-class">.getResponseWithInterceptorChain</span>(RealCall<span class="selector-class">.java</span>:<span class="number">179</span>)</div><div class="line">    at okhttp3.RealCall<span class="variable">$AsyncCall</span>.execute(RealCall<span class="selector-class">.java</span>:<span class="number">129</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.NamedRunnable</span><span class="selector-class">.run</span>(NamedRunnable<span class="selector-class">.java</span>:<span class="number">32</span>)</div></pre></td></tr></table></figure></p>
<p>可见，执行 HTTPS 请求，在发送数据时，代理服务器或远程 HTTP 服务器被杀掉的话，它们都会执行正常结束 TCP 连接的操作。而在 Android 端，OkHttp 将报出异常 <strong><code>javax.net.ssl.SSLException: Connection closed by peer</code></strong>。</p>
<h3 id="HTTP-请求-发送数据"><a href="#HTTP-请求-发送数据" class="headerlink" title="HTTP 请求-发送数据"></a>HTTP 请求-发送数据</h3><p>前面的操作过程中，使用代理时，执行 HTTP 请求，通过 Wireshark 抓包，得到如下结果：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-83b6857bdce37697.png" alt="2017-06-07 15-22-53屏幕截图.png"></p>
<p>Android 客户端与代理服务器的连接建立完成之后，立即杀掉代理服务器进程，代理服务器向 Android 客户端发送了 <strong>[FIN, ACK]</strong> 以结束 TCP 连接。随后 Android 客户端发出 HTTP 请求，将立即收到代理服务器进程发回的 RST 包。</p>
<p>OkHttp 将报出如下的异常：<br><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">java.io.IOException: unexpected end of stream on Connection&#123;<span class="attribute">www.wolfcstech.com</span>:80, proxy=HTTP@10.240.252.17:8888 hostAddress=/10.240.252.17:8888 cipherSuite=none protocol=http/1.1&#125;</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span>1<span class="variable">.Http</span>1Codec<span class="variable">.readResponseHeaders</span>(Http1Codec<span class="variable">.java</span>:205)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.CallServerInterceptor</span><span class="variable">.intercept</span>(CallServerInterceptor<span class="variable">.java</span>:67)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:92)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.connection</span><span class="variable">.ConnectInterceptor</span><span class="variable">.intercept</span>(ConnectInterceptor<span class="variable">.java</span>:45)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:92)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:67)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.cache</span><span class="variable">.CacheInterceptor</span><span class="variable">.intercept</span>(CacheInterceptor<span class="variable">.java</span>:93)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:92)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:67)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.BridgeInterceptor</span><span class="variable">.intercept</span>(BridgeInterceptor<span class="variable">.java</span>:93)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:92)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RetryAndFollowUpInterceptor</span><span class="variable">.intercept</span>(RetryAndFollowUpInterceptor<span class="variable">.java</span>:120)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:92)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:67)</div><div class="line">    at com<span class="variable">.netease</span><span class="variable">.netlib</span><span class="variable">.OkHttp</span>3Utils$MyInterceptor<span class="variable">.intercept</span>(OkHttp3Utils<span class="variable">.java</span>:29)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:92)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:67)</div><div class="line">    at okhttp3<span class="variable">.RealCall</span><span class="variable">.getResponseWithInterceptorChain</span>(RealCall<span class="variable">.java</span>:179)</div><div class="line">    at okhttp3<span class="variable">.RealCall</span>$AsyncCall<span class="variable">.execute</span>(RealCall<span class="variable">.java</span>:129)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.NamedRunnable</span><span class="variable">.run</span>(NamedRunnable<span class="variable">.java</span>:32)</div><div class="line">    at java<span class="variable">.util</span><span class="variable">.concurrent</span><span class="variable">.ThreadPoolExecutor</span><span class="variable">.runWorker</span>(ThreadPoolExecutor<span class="variable">.java</span>:1112)</div><div class="line">    at java<span class="variable">.util</span><span class="variable">.concurrent</span><span class="variable">.ThreadPoolExecutor</span>$Worker<span class="variable">.run</span>(ThreadPoolExecutor<span class="variable">.java</span>:587)</div><div class="line">    at java<span class="variable">.lang</span><span class="variable">.Thread</span><span class="variable">.run</span>(Thread<span class="variable">.java</span>:841)</div><div class="line">Caused by: java<span class="variable">.io</span><span class="variable">.EOFException</span>: \n not found: size=0 content=…</div><div class="line">    at okio<span class="variable">.RealBufferedSource</span><span class="variable">.readUtf</span>8LineStrict(RealBufferedSource<span class="variable">.java</span>:215)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span>1<span class="variable">.Http</span>1Codec<span class="variable">.readResponseHeaders</span>(Http1Codec<span class="variable">.java</span>:189)</div><div class="line">	... 22 more</div></pre></td></tr></table></figure></p>
<p>让 Android 客户端直接与远端 HTTP 服务器相连，则抓到的包如下：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-274e3eb45994bfa3.png" alt=""></p>
<p>在服务器进程被杀掉的时候，同样发出了 <strong><em>[FIN ACK]</em></strong> 来结束 TCP 连接。此时 OkHttp 报出的异常将像下面这样：<br><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">java.io.IOException: unexpected end of stream on Connection&#123;<span class="attribute">www.wolfcstech.com</span>:80, proxy=DIRECT@ hostAddress=www<span class="variable">.wolfcstech</span><span class="variable">.com</span>/139.196.224.72:80 cipherSuite=none protocol=http/1.1&#125;</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span>1<span class="variable">.Http</span>1Codec<span class="variable">.readResponseHeaders</span>(Http1Codec<span class="variable">.java</span>:205)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.CallServerInterceptor</span><span class="variable">.intercept</span>(CallServerInterceptor<span class="variable">.java</span>:67)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:92)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.connection</span><span class="variable">.ConnectInterceptor</span><span class="variable">.intercept</span>(ConnectInterceptor<span class="variable">.java</span>:45)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:92)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:67)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.cache</span><span class="variable">.CacheInterceptor</span><span class="variable">.intercept</span>(CacheInterceptor<span class="variable">.java</span>:93)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:92)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:67)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.BridgeInterceptor</span><span class="variable">.intercept</span>(BridgeInterceptor<span class="variable">.java</span>:93)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:92)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RetryAndFollowUpInterceptor</span><span class="variable">.intercept</span>(RetryAndFollowUpInterceptor<span class="variable">.java</span>:120)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:92)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:67)</div><div class="line">    at com<span class="variable">.netease</span><span class="variable">.netlib</span><span class="variable">.OkHttp</span>3Utils$MyInterceptor<span class="variable">.intercept</span>(OkHttp3Utils<span class="variable">.java</span>:29)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:92)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span><span class="variable">.RealInterceptorChain</span><span class="variable">.proceed</span>(RealInterceptorChain<span class="variable">.java</span>:67)</div><div class="line">    at okhttp3<span class="variable">.RealCall</span><span class="variable">.getResponseWithInterceptorChain</span>(RealCall<span class="variable">.java</span>:179)</div><div class="line">    at okhttp3<span class="variable">.RealCall</span>$AsyncCall<span class="variable">.execute</span>(RealCall<span class="variable">.java</span>:129)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.NamedRunnable</span><span class="variable">.run</span>(NamedRunnable<span class="variable">.java</span>:32)</div><div class="line">    at java<span class="variable">.util</span><span class="variable">.concurrent</span><span class="variable">.ThreadPoolExecutor</span><span class="variable">.runWorker</span>(ThreadPoolExecutor<span class="variable">.java</span>:1112)</div><div class="line">    at java<span class="variable">.util</span><span class="variable">.concurrent</span><span class="variable">.ThreadPoolExecutor</span>$Worker<span class="variable">.run</span>(ThreadPoolExecutor<span class="variable">.java</span>:587)</div><div class="line">    at java<span class="variable">.lang</span><span class="variable">.Thread</span><span class="variable">.run</span>(Thread<span class="variable">.java</span>:841)</div><div class="line">Caused by: java<span class="variable">.io</span><span class="variable">.EOFException</span>: \n not found: size=0 content=…</div><div class="line">    at okio<span class="variable">.RealBufferedSource</span><span class="variable">.readUtf</span>8LineStrict(RealBufferedSource<span class="variable">.java</span>:215)</div><div class="line">    at okhttp3<span class="variable">.internal</span><span class="variable">.http</span>1<span class="variable">.Http</span>1Codec<span class="variable">.readResponseHeaders</span>(Http1Codec<span class="variable">.java</span>:189)</div><div class="line">	... 22 more</div></pre></td></tr></table></figure></p>
<p>可见，执行 HTTP 请求，在发送数据时，代理服务器或远程 HTTP 服务器被杀掉的话，它们都会执行正常结束 TCP 连接的操作。而在 Android 端，OkHttp 将报出异常 <strong><code>java.io.IOException: unexpected end of stream on Connection{www.wolfcstech.com:80, proxy=DIRECT@ hostAddress=www.wolfcstech.com/139.196.224.72:80 cipherSuite=none protocol=http/1.1}</code></strong>。</p>
<p>通过如下方式模拟数据接收时，服务器端异常退出的情况：</p>
<ol>
<li>以 OkHttp 为 Android 应用 HTTP 客户端，向服务器请求文件。</li>
<li>在文件的接收过程中杀掉 HTTP 服务器进程。</li>
</ol>
<h3 id="HTTPS-请求-接收响应"><a href="#HTTPS-请求-接收响应" class="headerlink" title="HTTPS 请求 - 接收响应"></a>HTTPS 请求 - 接收响应</h3><p>按上面的操作，在接收响应的过程中，突然杀掉服务器进程，抓到的包如下：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-f25d35e415900901.png" alt=""></p>
<p>在这种情况下，服务器没有来得及给客户端发送 <strong><em>[FIN, ACK]</em></strong> 包结束 TCP 连接，而是客户端首先发出了 <strong><em>[FIN, ACK]</em></strong> 包 。</p>
<p>此时 OkHttp 报出了如下的异常：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">java.net.ProtocolException: </span>unexpected end of stream</div><div class="line">    <span class="built_in">at</span> okhttp3.internal.http1.Http1Codec$FixedLengthSource.read(Http1Codec.<span class="keyword">java:387)</span></div><div class="line">    <span class="built_in">at</span> okio.<span class="keyword">Buffer.writeAll(Buffer.java:996)</span></div><div class="line">    <span class="built_in">at</span> okio.RealBufferedSource.readString(RealBufferedSource.<span class="keyword">java:189)</span></div><div class="line">    <span class="built_in">at</span> okhttp3.ResponseBody.string(ResponseBody.<span class="keyword">java:174)</span></div><div class="line">    <span class="built_in">at</span> com.netease.volleydemo.MainActivity$<span class="number">2</span>$<span class="number">1</span>.onResponse(MainActivity.<span class="keyword">java:207)</span></div><div class="line">    <span class="built_in">at</span> okhttp3.RealCall$AsyncCall.execute(RealCall.<span class="keyword">java:135)</span></div><div class="line">    <span class="built_in">at</span> okhttp3.internal.NamedRunnable.run(NamedRunnable.<span class="keyword">java:32)</span></div><div class="line">    <span class="built_in">at</span> <span class="keyword">java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1112)</span></div><div class="line">    <span class="built_in">at</span> <span class="keyword">java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:587)</span></div><div class="line">    <span class="built_in">at</span> <span class="keyword">java.lang.Thread.run(Thread.java:841)</span></div></pre></td></tr></table></figure></p>
<h3 id="HTTP-2-请求-接收响应"><a href="#HTTP-2-请求-接收响应" class="headerlink" title="HTTP/2 请求 - 接收响应"></a>HTTP/2 请求 - 接收响应</h3><p>如果前面的请求是 HTTP/2 请求，在接收响应的过程中，突然杀掉服务器进程，抓到的包则如下：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-e53dd24e6c81ae3d.png" alt=""></p>
<p>服务器来不及结束 TCP 连接。客户端向服务器发送数据时，收到了服务器响应的 RST。OkHttp 抛出如下错误：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http2</span><span class="selector-class">.StreamResetException</span>: stream was reset: CANCEL</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http2</span><span class="selector-class">.Http2Stream</span><span class="variable">$FramingSource</span>.checkNotClosed(Http2Stream<span class="selector-class">.java</span>:<span class="number">436</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.http2</span><span class="selector-class">.Http2Stream</span><span class="variable">$FramingSource</span>.read(Http2Stream<span class="selector-class">.java</span>:<span class="number">338</span>)</div><div class="line">    at okio<span class="selector-class">.ForwardingSource</span><span class="selector-class">.read</span>(ForwardingSource<span class="selector-class">.java</span>:<span class="number">35</span>)</div><div class="line">    at okio<span class="selector-class">.Buffer</span><span class="selector-class">.writeAll</span>(Buffer<span class="selector-class">.java</span>:<span class="number">996</span>)</div><div class="line">    at okio<span class="selector-class">.RealBufferedSource</span><span class="selector-class">.readString</span>(RealBufferedSource<span class="selector-class">.java</span>:<span class="number">189</span>)</div><div class="line">    at okhttp3<span class="selector-class">.ResponseBody</span><span class="selector-class">.string</span>(ResponseBody<span class="selector-class">.java</span>:<span class="number">174</span>)</div><div class="line">    at com<span class="selector-class">.netease</span><span class="selector-class">.volleydemo</span><span class="selector-class">.MainActivity</span>$<span class="number">2</span>$<span class="number">1</span>.onResponse(MainActivity<span class="selector-class">.java</span>:<span class="number">207</span>)</div><div class="line">    at okhttp3.RealCall<span class="variable">$AsyncCall</span>.execute(RealCall<span class="selector-class">.java</span>:<span class="number">135</span>)</div><div class="line">    at okhttp3<span class="selector-class">.internal</span><span class="selector-class">.NamedRunnable</span><span class="selector-class">.run</span>(NamedRunnable<span class="selector-class">.java</span>:<span class="number">32</span>)</div></pre></td></tr></table></figure></p>
<h3 id="HTTP-请求-接收响应"><a href="#HTTP-请求-接收响应" class="headerlink" title="HTTP 请求 - 接收响应"></a>HTTP 请求 - 接收响应</h3><p>在接收响应的过程中，突然杀掉服务器进程，抓到的包如下：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-a812b3c0bd10470b.png" alt=""></p>
<p>服务器正常结束掉了 TCP 连接。OkHttp 抛出如下错误：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">java.net.ProtocolException: </span>unexpected end of stream</div><div class="line">    <span class="built_in">at</span> okhttp3.internal.http1.Http1Codec$FixedLengthSource.read(Http1Codec.<span class="keyword">java:387)</span></div><div class="line">    <span class="built_in">at</span> okio.<span class="keyword">Buffer.writeAll(Buffer.java:996)</span></div><div class="line">    <span class="built_in">at</span> okio.RealBufferedSource.readString(RealBufferedSource.<span class="keyword">java:189)</span></div><div class="line">    <span class="built_in">at</span> okhttp3.ResponseBody.string(ResponseBody.<span class="keyword">java:174)</span></div><div class="line">    <span class="built_in">at</span> com.netease.volleydemo.MainActivity$<span class="number">2</span>$<span class="number">1</span>.onResponse(MainActivity.<span class="keyword">java:207)</span></div><div class="line">    <span class="built_in">at</span> okhttp3.RealCall$AsyncCall.execute(RealCall.<span class="keyword">java:135)</span></div><div class="line">    <span class="built_in">at</span> okhttp3.internal.NamedRunnable.run(NamedRunnable.<span class="keyword">java:32)</span></div></pre></td></tr></table></figure></p>
<p>在 Android 客户端从 HTTP 接收数据时， HTTP 服务器意外挂掉，HTTPS 和 HTTP 请求，抛出了异常 <strong><code>java.net.ProtocolException: unexpected end of stream</code></strong> ，而 HTTP/2 请求，则抛出了异常 <strong><code>okhttp3.internal.http2.StreamResetException: stream was reset: CANCEL</code></strong>。对于这三种请求，在 HTTP 服务器结束退出时，都没有来得及发送 <strong><em>[FIN, ACK]</em></strong> 结束 TCP 连接，<strong><em>[FIN, ACK]</em></strong> 均是首先由 Android 客户端发出。</p>
<p>这分为两种情况，一是发送数据的一方意外崩溃，接收数据的一方看到了什么？二是接收数据的一方意外崩溃，发送数据的一方又看到了什么？</p>
<p>读写的角度，站在 Android 客户端的角度来看，如果是接收数据的时候，对端意外退出，它将会发生什么？二是在写数据的时候，对端意外退出，它又将看到什么？</p>
<p>数据接收的一方终止连接的话，数据发送的一方将看到如下的景象：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-a4265ccaea530a7c.png" alt="image_20170527160621.png"></p>
<p>从抓到的包来看，HTTP 请求结束之前，客户端把连接关闭的话，TCP正常结束的挥手流程会走，FIN 会发给服务器。不过后续在服务器收到 FIN 之前发的数据还会继续到达，客户端收到这些包的时候会发送 RST</p>
<p>3, 接收端收到TCP报文，但是发现该TCP的报文，并不在其已建立的TCP连接列表内，则其直接向对端发送reset报文，如下图所示：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-d48d8f5f7a196fc2.png" alt=""></p>
<p>为什么会出现这种情况？TCP 报文，具体指那种类型的报文，SYN 还是 DATA？是 TCP 报文路由出错了，被发送给了错误的主机了么？还是 TCP 连接已经被接收数据的一方关掉了？</p>
<p>4, 在交互的双方中的某一方长期未收到来自对方的确认报文，则其在超出一定的重传次数或时间后，会主动向对端发送reset报文释放该TCP连接，如下图所示：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-93dbbbadee19939a.png" alt=""></p>
<p>5, 有些应用开发者在设计应用系统时，会利用reset报文快速释放已经完成数据交互的TCP连接，以提高业务交互的效率，如下图所示：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-bc7ae7d5a52f88d6.png" alt=""></p>
<p>参考文档</p>
<ul>
<li><p><a href="http://www.vants.org/?post=22" target="_blank" rel="external">TCP异常终止（reset报文）</a></p>
</li>
<li><p><a href="https://caddyserver.com/docs/tls" target="_blank" rel="external">Caddy tls configuration</a></p>
</li>
</ul>
</div><div class="tags"><a href="/tags/Android开发/">Android开发</a><a href="/tags/网络调试/">网络调试</a></div><div class="post-nav"><a href="/2017/06/11/jni_tips/" class="pre">JNI技巧</a><a href="/2017/06/08/android_certificate_expired_issue/" class="next">Android 的 HTTPS 证书过期异常</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android-图形系统/">Android 图形系统</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">29</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/云计算/">云计算</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a> <a href="/tags/云计算/" style="font-size: 15px;">云计算</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/06/anbox_lxc/">Anbox LXC</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/05/lxc_c_api_usage/">LXC C API 使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/ubuntu_lxc/">Ubuntu LXC</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/01/anbox_container_manager_service/">Anbox 容器管理服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/28/run_anbox/">运行 Anbox</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/28/Anbox/">Anbox</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/24/gerrit_codereview/">Gerrit代码审核服务器搭建全过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/20/adb_overview/">关于 ADB 实现的说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/adb-standalone/">adb standalone</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/31/qcow2_on_linux/">在 Linux 上如何挂载 qcow2 磁盘镜像</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2017/06/08/tcp_unexpected_termination/';
var disqus_title = 'TCP异常终止';
var disqus_url = 'https://www.wolfcstech.com/2017/06/08/tcp_unexpected_termination/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-109419024-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>