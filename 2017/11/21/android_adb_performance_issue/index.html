<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/freesoft.jpg?v=6.0.3">


  <link rel="mask-icon" href="/images/freesoft.jpg?v=6.0.3" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="虚拟化," />


<meta name="description" content="NUMA 机制的应用在 ARM 服务器上，以默认的方式启动许多个 emulator 实例，像下面这样：1$ emulator -gpuserveraddr 10.240.209.153 -gpuserverport 6230 -port 5580 -avd android_7.1.1_arm64_portrait_720x1280_inst63">
<meta property="og:type" content="article">
<meta property="og:title" content="模拟器性能问题分析与解决">
<meta property="og:url" content="https://www.wolfcstech.com/2017/11/21/android_adb_performance_issue/index.html">
<meta property="og:site_name" content="WolfcsTech">
<meta property="og:description" content="NUMA 机制的应用在 ARM 服务器上，以默认的方式启动许多个 emulator 实例，像下面这样：1$ emulator -gpuserveraddr 10.240.209.153 -gpuserverport 6230 -port 5580 -avd android_7.1.1_arm64_portrait_720x1280_inst63">
<meta property="og:image" content="https://www.wolfcstech.com/images/1315506-440d1f11e905e493.png">
<meta property="og:image" content="https://www.wolfcstech.com/images/1315506-92090b1329bf0688.png">
<meta property="og:updated_time" content="2019-10-25T03:39:45.625Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="模拟器性能问题分析与解决">
<meta name="twitter:description" content="NUMA 机制的应用在 ARM 服务器上，以默认的方式启动许多个 emulator 实例，像下面这样：1$ emulator -gpuserveraddr 10.240.209.153 -gpuserverport 6230 -port 5580 -avd android_7.1.1_arm64_portrait_720x1280_inst63">
<meta name="twitter:image" content="https://www.wolfcstech.com/images/1315506-440d1f11e905e493.png">






  <link rel="canonical" href="https://www.wolfcstech.com/2017/11/21/android_adb_performance_issue/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>模拟器性能问题分析与解决 | WolfcsTech</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-109419024-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-109419024-1');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WolfcsTech</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="http://www.ixirong.com/404.html" rel="section">
            <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />公益 404</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.wolfcstech.com/2017/11/21/android_adb_performance_issue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Han Pengfei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/freesoft.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WolfcsTech">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">模拟器性能问题分析与解决</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-21T20:05:49+08:00">2017-11-21</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/虚拟化/" itemprop="url" rel="index"><span itemprop="name">虚拟化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/11/21/android_adb_performance_issue/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2017/11/21/android_adb_performance_issue/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/11/21/android_adb_performance_issue/" class="leancloud_visitors" data-flag-title="模拟器性能问题分析与解决">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <h1 id="NUMA-机制的应用"><a href="#NUMA-机制的应用" class="headerlink" title="NUMA 机制的应用"></a>NUMA 机制的应用</h1><p>在 ARM 服务器上，以默认的方式启动许多个 emulator 实例，像下面这样：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ emulator -gpuserveraddr <span class="number">10.240</span><span class="number">.209</span><span class="number">.153</span> -gpuserverport <span class="number">6230</span> -port <span class="number">5580</span> -avd android_7<span class="number">.1</span><span class="number">.1</span>_arm64_portrait_720x1280_inst63</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>将出现许多 emulator 进程 CPU 占用率都非常高，各个 emulator 间疯狂争抢 CPU 资源的问题。这种启动 emulator 的方式是不可能在 64 核的 ARM 服务器上同时运行多于 64 个 emulator 的实例的。</p>
<p>ARM 服务器共有 64 个 CPU 核，及 4 个 NUMA 节点，每个 NUMA 节点都与一些 CPU 核绑定，通过命令行工具 <code>lscpu</code> 可以查看相关的信息。<br><figure class="highlight ldif"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ lscpu</div><div class="line"><span class="attribute">Architecture</span>:          aarch64</div><div class="line"><span class="attribute">Byte Order</span>:            Little Endian</div><div class="line"><span class="attribute">CPU(s)</span>:                64</div><div class="line"><span class="attribute">On-line CPU(s) list</span>:   0-63</div><div class="line"><span class="attribute">Thread(s) per core</span>:    1</div><div class="line"><span class="attribute">Core(s) per socket</span>:    4</div><div class="line"><span class="attribute">Socket(s)</span>:             16</div><div class="line"><span class="attribute">NUMA node(s)</span>:          4</div><div class="line"><span class="attribute">NUMA node0 CPU(s)</span>:     0-15</div><div class="line"><span class="attribute">NUMA node1 CPU(s)</span>:     16-31</div><div class="line"><span class="attribute">NUMA node2 CPU(s)</span>:     32-47</div><div class="line"><span class="attribute">NUMA node3 CPU(s)</span>:     48-63</div></pre></td></tr></table></figure></p>
<p>从上面输出的信息中，可以看到，第 0 号 NUMA 节点与 0-15 号 CPU 绑定，第 1 号 NUMA 节点与 16-31 号 CPU 绑定，依次类推。通过如下命令启动模拟器，以优化整个系统的性能：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ numactl -m <span class="number">0</span> -C <span class="number">0</span> emulator -gpuserveraddr <span class="number">10.240</span><span class="number">.209</span><span class="number">.153</span> -gpuserverport <span class="number">6230</span> -port <span class="number">5580</span> -avd android_7<span class="number">.1</span><span class="number">.1</span>_arm64_portrait_720x1280_inst60</div></pre></td></tr></table></figure></p>
<p>这个命令将 emulator 的执行绑定在特定的 NUMA 节点和 CPU 核上。需要注意 指定的 CPU 核需要与它绑定的 NUMA 节点一致；指定的 NUMA 节点和 CPU 核均需要在可选择的有效 NUMA 节点和 CPU 范围内，否则进程将启动失败。</p>
<p>经过上面的优化，整个系统的性能得到比较大的优化，不再出现许多 emulator 进程 CPU 占用率都非常高，各个 emulator 间疯狂争抢 CPU 资源的问题。</p>
<h1 id="adb-导致的性能问题"><a href="#adb-导致的性能问题" class="headerlink" title="adb 导致的性能问题"></a>adb 导致的性能问题</h1><p>经过上面的优化，虽然性能得到大幅优化，但当我们通过 <code>top</code> 和 <code>htop</code> 命令查看进程状态时，还是发现了一些问题。top 命令执行结果如下：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND </div><div class="line">39985 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 468216 </span><span class="number"> 14720 </span>S  71.4  0.4   7:59.25 qemu-system-aar                                                                 </div><div class="line">45405 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3021788<span class="number"> 487032 </span><span class="number"> 14628 </span>S  68.8  0.4  20:55.06 qemu-system-aar                                                                 </div><div class="line">40041 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 462024 </span><span class="number"> 14536 </span>S  68.1  0.4   6:56.74 qemu-system-aar                                                                 </div><div class="line">45101 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 476648 </span><span class="number"> 14724 </span>S  67.8  0.4  17:23.12 qemu-system-aar                                                                 </div><div class="line">43542 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 468168 </span><span class="number"> 14432 </span>S  67.4  0.4  18:12.83 qemu-system-aar                                                                 </div><div class="line">45961 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 503280 </span><span class="number"> 14720 </span>S  67.1  0.4  22:19.33 qemu-system-aar                                                                 </div><div class="line">40289 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 472256 </span><span class="number"> 14648 </span>S  65.8  0.4  11:13.32 qemu-system-aar                                                                 </div><div class="line">39961 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 472296 </span><span class="number"> 14628 </span>S  64.8  0.4   8:13.39 qemu-system-aar                                                                 </div><div class="line">45875 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 482736 </span><span class="number"> 14584 </span>S  61.8  0.4  21:55.84 qemu-system-aar                                                                 </div><div class="line">40010 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 808292 </span><span class="number"> 14632 </span>S  60.2  0.6   7:59.66 qemu-system-aar                                                                 </div><div class="line">40096 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 459968 </span><span class="number"> 14620 </span>S  59.5  0.3   7:16.60 qemu-system-aar                                                                 </div><div class="line">41981 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 482728 </span><span class="number"> 14716 </span>S  59.5  0.4  16:19.01 qemu-system-aar                                                                 </div><div class="line">42436 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 476416 </span><span class="number"> 14512 </span>S  59.5  0.4  13:41.56 qemu-system-aar                                                                 </div><div class="line">40253 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 464088 </span><span class="number"> 14708 </span>S  58.9  0.4  10:50.09 qemu-system-aar                                                                 </div><div class="line">46449 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3021788<span class="number"> 726668 </span><span class="number"> 14716 </span>S  58.2  0.6  21:48.36 qemu-system-aar                                                                 </div><div class="line">42494 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 468384 </span><span class="number"> 14648 </span>S  57.6  0.4  14:09.92 qemu-system-aar                                                                 </div><div class="line">44146 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 468364 </span><span class="number"> 14652 </span>S  57.6  0.4  15:56.76 qemu-system-aar                                                                 </div><div class="line">40870 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 476396 </span><span class="number"> 14428 </span>S  56.9  0.4   9:50.65 qemu-system-aar                                                                 </div><div class="line">44660 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 474528 </span><span class="number"> 14652 </span>S  56.9  0.4  16:54.32 qemu-system-aar                                                                 </div><div class="line">45479 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 476516 </span><span class="number"> 14624 </span>S  56.2  0.4  20:37.84 qemu-system-aar                                                                 </div><div class="line">45718 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 486896 </span><span class="number"> 14704 </span>S  56.2  0.4  22:16.29 qemu-system-aar                                                                 </div><div class="line">45328 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 486856 </span><span class="number"> 14644 </span>S  55.6  0.4  20:43.48 qemu-system-aar                                                                 </div><div class="line">42381 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3021788<span class="number"> 470556 </span><span class="number"> 14572 </span>S  55.3  0.4  15:05.59 qemu-system-aar                                                                 </div><div class="line">43289 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 472464 </span><span class="number"> 14612 </span>S  55.3  0.4  17:52.02 qemu-system-aar                                                                 </div><div class="line">42549 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 472540 </span><span class="number"> 14608 </span>S  54.9  0.4  14:26.73 qemu-system-aar                                                                 </div><div class="line">40909 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 472296 </span><span class="number"> 14632 </span>S  54.6  0.4   9:53.95 qemu-system-aar                                                                 </div><div class="line">45248 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 474644 </span><span class="number"> 14644 </span>S  54.6  0.4  17:35.15 qemu-system-aar                                                                 </div><div class="line">43876 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3021788<span class="number"> 482736 </span><span class="number"> 14472 </span>S  54.3  0.4  20:28.21 qemu-system-aar                                                                 </div><div class="line">43608 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3021788<span class="number"> 480860 </span><span class="number"> 14604 </span>S  53.6  0.4  19:05.39 qemu-system-aar                                                                 </div><div class="line">41929 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 484804 </span><span class="number"> 14704 </span>S  52.3  0.4  16:15.19 qemu-system-aar                                                                 </div><div class="line">45796 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 484612 </span><span class="number"> 14552 </span>S  51.6  0.4  21:38.19 qemu-system-aar                                                                 </div><div class="line">40156 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 460008 </span><span class="number"> 14676 </span>S  51.3  0.3  10:05.45 qemu-system-aar                                                                 </div><div class="line">46038 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3021788<span class="number"> 496756 </span><span class="number"> 14412 </span>S  51.3  0.4  22:00.39 qemu-system-aar                                                                 </div><div class="line">45174 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 466276 </span><span class="number"> 14632 </span>S  51.0  0.4  17:57.39 qemu-system-aar                                                                 </div><div class="line">42980 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2880476<span class="number"> 123196 </span><span class="number"> 14552 </span>S  50.7  0.1 187:53.29 qemu-system-aar                                                                 </div><div class="line">41880 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 480564 </span><span class="number"> 14472 </span>S  50.3  0.4  15:50.96 qemu-system-aar                                                                 </div><div class="line">40640 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3095516<span class="number"> 466332 </span><span class="number"> 14668 </span>S  49.7  0.4  12:20.51 qemu-system-aar                                                                 </div><div class="line">41487 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 472360 </span><span class="number"> 14704 </span>S  49.7  0.4  13:40.67 qemu-system-aar</div></pre></td></tr></table></figure></p>
<p>从 top 命令的输出结果可以看到，多个 emulator 的进程 CPU 占用率仍然较高。</p>
<p><code>htop</code> 命令执行的结果如下：<br><img src="https://www.wolfcstech.com/images/1315506-440d1f11e905e493.png" alt=""></p>
<p>emualtor 进程使得 CPU 持续处于异常繁忙的状态同样得到验证。</p>
<p>然而，我们通过如下命令杀掉 ADB server：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ adb <span class="keyword">kill</span>-<span class="keyword">server</span></div></pre></td></tr></table></figure></p>
<p>再次查看 <code>top</code> 和 <code>htop</code> 命令的输出。<code>top</code> 命令的输出如下：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND </div><div class="line">42980 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2880476<span class="number"> 123196 </span><span class="number"> 14552 </span>S  99.0  0.1 193:43.96 qemu-system-aar                                                                 </div><div class="line">24348 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>  <span class="number"> 8360 </span> <span class="number"> 5864 </span> <span class="number"> 2452 </span>S   7.2  0.0  10:09.35 htop                                                                            </div><div class="line">39786 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 486748 </span><span class="number"> 14620 </span>S   2.0  0.4   7:56.54 qemu-system-aar                                                                 </div><div class="line">39836 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 437364 </span><span class="number"> 14624 </span>S   1.6  0.3   6:58.70 qemu-system-aar                                                                 </div><div class="line">39936 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3021788<span class="number"> 478760 </span><span class="number"> 14724 </span>S   1.6  0.4   9:01.92 qemu-system-aar                                                                 </div><div class="line">40461 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 480476 </span><span class="number"> 14668 </span>S   1.6  0.4  12:21.28 qemu-system-aar                                                                 </div><div class="line">40640 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3095516<span class="number"> 464440 </span><span class="number"> 14668 </span>S   1.6  0.4  14:00.10 qemu-system-aar                                                                 </div><div class="line">40675 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 474548 </span><span class="number"> 14632 </span>S   1.6  0.4  10:44.42 qemu-system-aar                                                                 </div><div class="line">40828 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3095516<span class="number"> 476800 </span><span class="number"> 14640 </span>S   1.6  0.4  10:46.27 qemu-system-aar                                                                 </div><div class="line">40870 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 476396 </span><span class="number"> 14428 </span>S   1.6  0.4  11:06.14 qemu-system-aar                                                                 </div><div class="line">41037 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3021788<span class="number"> 476644 </span><span class="number"> 14712 </span>S   1.6  0.4  11:27.86 qemu-system-aar                                                                 </div><div class="line">41581 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 492944 </span><span class="number"> 14748 </span>S   1.6  0.4  16:10.79 qemu-system-aar                                                                 </div><div class="line">42137 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 470320 </span><span class="number"> 14588 </span>S   1.6  0.4  15:38.55 qemu-system-aar                                                                 </div><div class="line">42191 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 464448 </span><span class="number"> 14704 </span>S   1.6  0.4  15:27.60 qemu-system-aar                                                                 </div><div class="line">42549 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 474608 </span><span class="number"> 14608 </span>S   1.6  0.4  16:21.91 qemu-system-aar                                                                 </div><div class="line">42861 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 474484 </span><span class="number"> 14632 </span>S   1.6  0.4  16:45.82 qemu-system-aar                                                                 </div><div class="line">43414 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 484748 </span><span class="number"> 14604 </span>S   1.6  0.4  20:35.28 qemu-system-aar                                                                 </div><div class="line">43876 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3021788<span class="number"> 482736 </span><span class="number"> 14472 </span>S   1.6  0.4  23:31.48 qemu-system-aar                                                                 </div><div class="line">44217 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 472392 </span><span class="number"> 14712 </span>S   1.6  0.4  18:51.15 qemu-system-aar                                                                 </div><div class="line">45642 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 497296 </span><span class="number"> 14728 </span>S   1.6  0.4  24:08.87 qemu-system-aar                                                                 </div><div class="line">45718 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 495088 </span><span class="number"> 14704 </span>S   1.6  0.4  25:19.87 qemu-system-aar                                                                 </div><div class="line">39713 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3020028<span class="number"> 483232 </span><span class="number"> 15208 </span>S   1.3  0.4   8:40.32 qemu-system-aar                                                                 </div><div class="line">39809 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 490952 </span><span class="number"> 14692 </span>S   1.3  0.4   8:01.09 qemu-system-aar                                                                 </div><div class="line">39857 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 488848 </span><span class="number"> 14664 </span>S   1.3  0.4   7:57.73 qemu-system-aar                                                                 </div><div class="line">39884 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 478456 </span><span class="number"> 14588 </span>S   1.3  0.4   8:51.47 qemu-system-aar                                                                 </div><div class="line">39907 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 476344 </span><span class="number"> 14648 </span>S   1.3  0.4   8:03.02 qemu-system-aar                                                                 </div><div class="line">39961 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3021788<span class="number"> 472456 </span><span class="number"> 14632 </span>S   1.3  0.4   9:15.31 qemu-system-aar                                                                 </div><div class="line">39985 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 468288 </span><span class="number"> 14724 </span>S   1.3  0.4   8:58.30 qemu-system-aar                                                                 </div><div class="line">40010 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 808292 </span><span class="number"> 14632 </span>S   1.3  0.6   8:56.44 qemu-system-aar                                                                 </div><div class="line">40069 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 470128 </span><span class="number"> 14620 </span>S   1.3  0.4   8:50.36 qemu-system-aar                                                                 </div><div class="line">40123 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 457932 </span><span class="number"> 14620 </span>S   1.3  0.3  12:03.48 qemu-system-aar                                                                 </div><div class="line">40156 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 460008 </span><span class="number"> 14676 </span>S   1.3  0.3  11:23.75 qemu-system-aar                                                                 </div><div class="line">40186 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 466192 </span><span class="number"> 14488 </span>S   1.3  0.4  12:36.00 qemu-system-aar                                                                 </div><div class="line">40220 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 468324 </span><span class="number"> 14636 </span>S   1.3  0.4  12:17.53 qemu-system-aar                                                                 </div><div class="line">40253 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 464176 </span><span class="number"> 14708 </span>S   1.3  0.4  12:14.23 qemu-system-aar                                                                 </div><div class="line">40289 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 472324 </span><span class="number"> 14648 </span>S   1.3  0.4  12:42.02 qemu-system-aar                                                                 </div><div class="line">40328 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 476508 </span><span class="number"> 14648 </span>S   1.3  0.4  11:41.24 qemu-system-aar</div></pre></td></tr></table></figure></p>
<p>从上面的输出中可以看到，除了进程号为 42980 的进程外，其它的 emulator 进程的 CPU 占用率都恢复到比较低的状态。</p>
<p><code>htop</code> 命令的输出如下：<br><img src="https://www.wolfcstech.com/images/1315506-92090b1329bf0688.png" alt=""></p>
<p>从上面的输出可以看到，除占用第 15 号 CPU 的进程 CPU 占用率总是非常高，接近 100% 之外，整个世界都平静了。不难猜测，这里占用第 15 号 CPU 的进程正是上面看到的进程号为 42980 的进程。</p>
<p>多次查看第 42980 号进程打开的端口：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">$ lsof -i | grep 42980</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   17u  IPv4<span class="number"> 3942777 </span>     0t0  TCP localhost:44040-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   31u  IPv4<span class="number"> 2680530 </span>     0t0  TCP localhost:5717 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   32u  IPv6<span class="number"> 2680531 </span>     0t0  TCP localhost:5717 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   33u  IPv4<span class="number"> 2680532 </span>     0t0  TCP localhost:5716 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   34u  IPv4<span class="number"> 4023949 </span>     0t0  TCP localhost:50402-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">$ lsof -i | grep 42980</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   17u  IPv4<span class="number"> 3942777 </span>     0t0  TCP localhost:44040-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   31u  IPv4<span class="number"> 2680530 </span>     0t0  TCP localhost:5717 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   32u  IPv6<span class="number"> 2680531 </span>     0t0  TCP localhost:5717 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   33u  IPv4<span class="number"> 2680532 </span>     0t0  TCP localhost:5716 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   34u  IPv4<span class="number"> 4024001 </span>     0t0  TCP localhost:57242-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">$ lsof -i | grep 42980</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   17u  IPv4<span class="number"> 3942777 </span>     0t0  TCP localhost:44040-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   31u  IPv4<span class="number"> 2680530 </span>     0t0  TCP localhost:5717 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   32u  IPv6<span class="number"> 2680531 </span>     0t0  TCP localhost:5717 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   33u  IPv4<span class="number"> 2680532 </span>     0t0  TCP localhost:5716 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   34u  IPv4<span class="number"> 4024001 </span>     0t0  TCP localhost:57242-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">$ lsof -i | grep 42980</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   17u  IPv4<span class="number"> 3942777 </span>     0t0  TCP localhost:44040-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   31u  IPv4<span class="number"> 2680530 </span>     0t0  TCP localhost:5717 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   32u  IPv6<span class="number"> 2680531 </span>     0t0  TCP localhost:5717 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   33u  IPv4<span class="number"> 2680532 </span>     0t0  TCP localhost:5716 (LISTEN)</div><div class="line">$ lsof -i | grep 42980</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   17u  IPv4<span class="number"> 3942777 </span>     0t0  TCP localhost:44040-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   31u  IPv4<span class="number"> 2680530 </span>     0t0  TCP localhost:5717 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   32u  IPv6<span class="number"> 2680531 </span>     0t0  TCP localhost:5717 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   33u  IPv4<span class="number"> 2680532 </span>     0t0  TCP localhost:5716 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 42980 </span>hzhanpengfei   34u  IPv4<span class="number"> 4024011 </span>     0t0  TCP localhost:58792-&gt;localhost:5037 (ESTABLISHED)</div></pre></td></tr></table></figure></p>
<p>这个 emulator 进程始终监听在第 5716 和 5717 号 TCP 端口上——这两个端口分别是用于终端和 ADB 连接的端口。emulator 与  tcp:localhost:5037 上的服务保持着一条长连接，并与相同地址上的服务有一个频繁地建立和销毁的连接。</p>
<p>对于模拟器而言，在 ADB 中，它的串号通常是 “emulator-“ 后跟终端端口号。我们启动 ADB server，并查看该 emulator 的状态：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ adb devices | grep <span class="number">5716</span></div><div class="line">emulator<span class="number">-5716</span>	offline</div></pre></td></tr></table></figure></p>
<p>CPU 占用率始终非常高的 emulator，其状态为 OFFLINE 的。这是由 ADB 导致的 emulator CPU 占用率高的一个问题，即处于 OFFLINE 状态的 emulator 进程 CPU 占用率非常高。</p>
<p>处于 OFFLINE 状态的 emulator，还可以观察到这样一种现象：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ adb devices  | grep offline</div><div class="line">emulator-5616	offline</div><div class="line">$ lsof -i | grep 5616</div><div class="line">qemu-syst<span class="number"> 40527 </span>hzhanpengfei   33u  IPv4<span class="number"> 2673543 </span>     0t0  TCP localhost:5616 (LISTEN)</div><div class="line">$ lsof -i | grep 40527</div><div class="line">qemu-syst<span class="number"> 40527 </span>hzhanpengfei   17u  IPv4<span class="number"> 3948652 </span>     0t0  TCP localhost:41784-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 40527 </span>hzhanpengfei   31u  IPv4<span class="number"> 2673541 </span>     0t0  TCP localhost:5617 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 40527 </span>hzhanpengfei   32u  IPv6<span class="number"> 2673542 </span>     0t0  TCP localhost:5617 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 40527 </span>hzhanpengfei   33u  IPv4<span class="number"> 2673543 </span>     0t0  TCP localhost:5616 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 40527 </span>hzhanpengfei   34u  IPv4<span class="number"> 4409291 </span>     0t0  TCP localhost:58470-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 40527 </span>hzhanpengfei   47u  IPv4<span class="number"> 2673550 </span>     0t0  TCP localhost:5617-&gt;localhost:57289 (CLOSE_WAIT)</div></pre></td></tr></table></figure></p>
<p>即由 ADB server 发起的与其建立的连接失败，连接始终处于 <code>CLOSE_WAIT</code> 状态。</p>
<p>除了这种处于 OFFLINE 故障状态的 emulator 进程外，在 ADB server 运行时，还有一些 emulator 进程 CPU 占用率也非常高。从中任意挑选一个，如进程号为 45559 的进程，多次查看其打开的端口状态：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">$ lsof -i | grep 45559</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   17u  IPv4<span class="number"> 3940753 </span>     0t0  TCP localhost:5791-&gt;localhost:42171 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   31u  IPv4<span class="number"> 2716489 </span>     0t0  TCP localhost:5791 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   32u  IPv6<span class="number"> 2716490 </span>     0t0  TCP localhost:5791 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   33u  IPv4<span class="number"> 2716491 </span>     0t0  TCP localhost:5790 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   34u  IPv4<span class="number"> 3940758 </span>     0t0  TCP localhost:44030-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   47u  IPv4<span class="number"> 4277378 </span>     0t0  TCP localhost:41488-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">$ lsof -i | grep 45559</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   17u  IPv4<span class="number"> 3940753 </span>     0t0  TCP localhost:5791-&gt;localhost:42171 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   31u  IPv4<span class="number"> 2716489 </span>     0t0  TCP localhost:5791 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   32u  IPv6<span class="number"> 2716490 </span>     0t0  TCP localhost:5791 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   33u  IPv4<span class="number"> 2716491 </span>     0t0  TCP localhost:5790 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   34u  IPv4<span class="number"> 3940758 </span>     0t0  TCP localhost:44030-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   47u  IPv4<span class="number"> 4277401 </span>     0t0  TCP localhost:43416-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">$ lsof -i | grep 45559</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   17u  IPv4<span class="number"> 3940753 </span>     0t0  TCP localhost:5791-&gt;localhost:42171 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   31u  IPv4<span class="number"> 2716489 </span>     0t0  TCP localhost:5791 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   32u  IPv6<span class="number"> 2716490 </span>     0t0  TCP localhost:5791 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   33u  IPv4<span class="number"> 2716491 </span>     0t0  TCP localhost:5790 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   34u  IPv4<span class="number"> 3940758 </span>     0t0  TCP localhost:44030-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   47u  IPv4<span class="number"> 4277413 </span>     0t0  TCP localhost:45272-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">$ lsof -i | grep 45559</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   17u  IPv4<span class="number"> 3940753 </span>     0t0  TCP localhost:5791-&gt;localhost:42171 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   31u  IPv4<span class="number"> 2716489 </span>     0t0  TCP localhost:5791 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   32u  IPv6<span class="number"> 2716490 </span>     0t0  TCP localhost:5791 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   33u  IPv4<span class="number"> 2716491 </span>     0t0  TCP localhost:5790 (LISTEN)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   34u  IPv4<span class="number"> 3940758 </span>     0t0  TCP localhost:44030-&gt;localhost:5037 (ESTABLISHED)</div><div class="line">qemu-syst<span class="number"> 45559 </span>hzhanpengfei   47u  IPv4<span class="number"> 4277430 </span>     0t0  TCP localhost:47834-&gt;localhost:5037 (ESTABLISHED)</div></pre></td></tr></table></figure></p>
<p>这个进程同样监听在两个端口上，只是这两个端口分别是 5790 和 5791。emulator 与 tcp:localhost:5037 上的服务保持着一条长连接，并与相同地址上的服务有一个频繁建立和销毁的连接。另外一个进程与 emulator 在 tcp:localhost:5791 上的服务也保持着一条长连接。</p>
<p>查看在 tcp:localhost:5037 上提供服务的进程，以及与 emulator 建立连接的进程是谁：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ lsof -i | <span class="keyword">grep</span> <span class="number">5037</span></div><div class="line">adb       <span class="number">21530</span> hzhanpengfei    <span class="number">4</span><span class="keyword">u</span>  IPv4 <span class="number">3930563</span>      <span class="number">0</span>t0  TCP localhos<span class="variable">t:5037</span>-&gt;localhos<span class="variable">t:45990</span> (ESTABLISHED)</div><div class="line">adb       <span class="number">21530</span> hzhanpengfei    <span class="number">7</span><span class="keyword">u</span>  IPv4 <span class="number">3930564</span>      <span class="number">0</span>t0  TCP localhos<span class="variable">t:5037</span>-&gt;localhos<span class="variable">t:45992</span> (ESTABLISHED)</div><div class="line">adb       <span class="number">21530</span> hzhanpengfei    <span class="number">8</span><span class="keyword">u</span>  IPv4 <span class="number">3925385</span>      <span class="number">0</span>t0  TCP localhos<span class="variable">t:5037</span> (LISTEN)</div><div class="line">$ lsof -i | <span class="keyword">grep</span> <span class="number">42171</span></div><div class="line">adb       <span class="number">21530</span> hzhanpengfei  <span class="number">142</span><span class="keyword">u</span>  IPv4 <span class="number">3912508</span>      <span class="number">0</span>t0  TCP localhos<span class="variable">t:42171</span>-&gt;localhos<span class="variable">t:5791</span> (ESTABLISHED)</div><div class="line">qemu-syst <span class="number">45559</span> hzhanpengfei   <span class="number">17</span><span class="keyword">u</span>  IPv4 <span class="number">3940753</span>      <span class="number">0</span>t0  TCP localhos<span class="variable">t:5791</span>-&gt;localhos<span class="variable">t:42171</span> (ESTABLISHED)</div></pre></td></tr></table></figure></p>
<p>可见 emulator 发起的连接的服务端 tcp:localhost:5037 位于 ADB server 进程内，发起与 emulator 内的服务建立连接的同样是 adb 进程。</p>
<p>由此推测，ADB server 启动之后，出现性能问题的可能原因：</p>
<ol>
<li>emulator 频繁地与 ADB server 建立销毁连接造成了比较大的开销。</li>
<li>emulator 在由 emulator 发起建立的与 ADB server 之间的连接上活动频繁消耗巨大。</li>
<li>emulator 在由 ADB server 发起建立的与 ADB server 之间的连接上活动频繁消耗巨大。</li>
</ol>
<p>总结一下，要解决或检查的问题：</p>
<ol>
<li>消除处于 OFFLINE 状态的 emulator，查找 ADB server 与 emulator 建立连接失败的原因。</li>
<li>检查 emulator 进程中，与 ADB server 建立的各条连接的状态。</li>
</ol>
<p>对于 ADB 导致的性能问题，我们从 emulator 与 ADB server 建立连接的过程开始分析。</p>
<p>emulator 发起的与 ADB server 之间的稳定的长连接的创建位置如下：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#0  android<span class="type">::wear</span><span class="type">::WearAgentImpl</span><span class="type">::connectToAdbHost</span> (this=<span class="number">0x7fffec081f20</span>) at android/android<span class="params">-emu</span>/android/wear<span class="params">-agent</span>/WearAgent.cpp:<span class="number">291</span></div><div class="line">#1  android<span class="type">::wear</span><span class="type">::WearAgentImpl</span><span class="type">::connectToAdbHostWorker</span> (this=<span class="number">0x7fffec081f20</span>) at android/android<span class="params">-emu</span>/android/wear<span class="params">-agent</span>/WearAgent.cpp:<span class="number">277</span></div><div class="line">#2  android<span class="type">::wear</span><span class="type">::WearAgentImpl</span><span class="type">::__lambda1</span><span class="type">::operator</span>() (__closure=&lt;optimized out&gt;) at android/android<span class="params">-emu</span>/android/wear<span class="params">-agent</span>/WearAgent.cpp:<span class="number">441</span></div><div class="line">#3  std<span class="type">::_Function_handler</span>&lt;long int(), android<span class="type">::wear</span><span class="type">::WearAgentImpl</span><span class="type">::WearAgentImpl</span>(android<span class="type">::base</span><span class="type">::Looper</span>*, int)<span class="type">::__lambda1</span>&gt;<span class="type">::_M_invoke</span>(const std<span class="type">::_Any_data</span> &amp;) (__functor=<span class="params">...</span>)</div><div class="line">    at /media/<span class="built_in">data</span>/Androids/emu<span class="number">-2.4</span><span class="params">-release</span>/prebuilts/gcc/linux<span class="params">-x86</span>/host/x86_64<span class="params">-linux</span><span class="params">-glibc2.11</span><span class="number">-4.8</span>/x86_64<span class="params">-linux</span>/include/c++/<span class="number">4.8</span>/functional:<span class="number">2056</span></div><div class="line">#4  <span class="number">0x000000000093d9c4</span> <span class="keyword">in</span> android<span class="type">::base</span><span class="type">::Thread</span><span class="type">::thread_main</span> (arg=<span class="number">0x7fffec0823e0</span>) at android/android<span class="params">-emu</span>/android/base/threads/Thread_pthread.cpp:<span class="number">152</span></div><div class="line">#5  <span class="number">0x00007ffff7bc16ba</span> <span class="keyword">in</span> start_thread (arg=<span class="number">0x7ffff228f700</span>) at pthread_create.c:<span class="number">333</span></div><div class="line">#6  <span class="number">0x00007ffff68403dd</span> <span class="keyword">in</span> clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:<span class="number">109</span></div></pre></td></tr></table></figure></p>
<p>emulator 进程与 ADB server 建立 TCP 连接的过程（位于 <code>qemu/android/android-emu/android/wear-agent/WearAgent.cpp</code>）如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> WearAgentImpl::connectToAdbHost() &#123;</div><div class="line">    <span class="comment">// this is the only function which modifies members from a separate thread</span></div><div class="line">    <span class="comment">// it means we need to be extra careful changing it:</span></div><div class="line">    <span class="comment">// - make sure correct locks are locked</span></div><div class="line">    <span class="comment">// - make sure the state is updated only after everything else</span></div><div class="line">    <span class="comment">// - don't hold locks for too long</span></div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> socket = socketTcp4LoopbackClient(mAdbHostPort);</div><div class="line">    <span class="keyword">if</span> (socket &lt; <span class="number">0</span>) &#123;</div><div class="line">        android::base::<span class="function">AutoLock <span class="title">lock</span><span class="params">(mSocketLock)</span></span>;</div><div class="line">        mSocketOpenState = SocketOpenState::Failed;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    socketSetNonBlocking(socket);</div><div class="line"></div><div class="line">    android::base::<span class="function">AutoLock <span class="title">lock</span><span class="params">(mSocketLock)</span></span>;</div><div class="line">    <span class="keyword">if</span> (mSocket &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// already created, make sure the completion runs</span></div><div class="line">        mSocketOpenState = SocketOpenState::Succeded;</div><div class="line">        lock.unlock();</div><div class="line">        socketClose(socket);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mSocket = socket;</div><div class="line">    mSocketOpenState = SocketOpenState::Succeded;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 <code>qemu/vl.c</code> 的 <code>main_impl()</code> 函数中有如下这样一行：<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android_wear_agent_start(<span class="name">looper_getForThread</span>())<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>这个函数创建 <code>android::wear::WearAgent</code> 对象，并在该对象的创建过程中，启动新的线程来建立与 ADB server 之间的连接，即与 ADB server 之间的长连接。</p>
<p>我们注意到，上面建立与 ADB server 之间的连接的过程中，是通过 <code>android::base::socketTcp4LoopbackClient()</code> 函数完成的，不难猜测在 emulator 中，建立与某个服务的连接的过程都是通过该函数完成的，包括前面观察到的与 ADB server 之间那个频繁建立与销毁的连接。</p>
<p>通过 GDB 来调试 emulator。我们观察到，在 emulator 的整个生命周期中，除了 <code>qemu/android/android-emu/android/wear-agent/WearAgent.cpp</code> 文件中，建立的与 ADB server 的长连接之外，还有如下几处，也与 ADB server 建立了连接。</p>
<p>连接一：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#<span class="number">0</span>  android::base::socketTcp4LoopbackClient (port=port@entry=<span class="number">5037</span>) <span class="meta">at</span> android/android-emu/android/base/sockets/SocketUtils.cpp:<span class="number">607</span></div><div class="line">#<span class="number">1</span>  <span class="number">0x00000000008b7027</span> <span class="keyword">in</span> android::emulation::AdbHostServer::notify (adbEmulatorPort=<span class="number">5555</span>, adbClientPort=<span class="number">5037</span>) <span class="meta">at</span> android/android-emu/android/emulation/AdbHostServer.cpp:<span class="number">34</span></div><div class="line">#<span class="number">2</span>  <span class="number">0x0000000000899cb1</span> <span class="keyword">in</span> android_emulation_setup (agents=<span class="number">0x161d500</span> &lt;qemu_android_emulation_setup::consoleAgents&gt;) <span class="meta">at</span> android/android-emu/android/qemu-setup.c:<span class="number">373</span></div><div class="line">#<span class="number">3</span>  <span class="number">0x0000000000429797</span> <span class="keyword">in</span> main_impl (argc=&lt;optimized <span class="keyword">out</span>&gt;, argv=&lt;optimized <span class="keyword">out</span>&gt;) <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/vl.c:<span class="number">5181</span></div><div class="line">#<span class="number">4</span>  <span class="number">0x000000000042a7b6</span> <span class="keyword">in</span> run_qemu_main (argc=&lt;optimized <span class="keyword">out</span>&gt;, argv=&lt;optimized <span class="keyword">out</span>&gt;) <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/vl.c:<span class="number">3254</span></div><div class="line">#<span class="number">5</span>  <span class="number">0x000000000042a80a</span> <span class="keyword">in</span> enter_qemu_main_loop (argc=<span class="number">62</span>, argv=<span class="number">0x7fffffffcf40</span>) <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/android-qemu2-glue/main.cpp:<span class="number">341</span></div><div class="line">#<span class="number">6</span>  <span class="number">0x0000000000414775</span> <span class="keyword">in</span> <span class="keyword">std</span>::function&lt;void ()&gt;::operator()() const (this=&lt;optimized <span class="keyword">out</span>&gt;)</div><div class="line">    <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2<span class="meta">.11</span>-<span class="number">4.8</span>/x86_64-linux/include/c++/<span class="number">4.8</span>/functional:<span class="number">2464</span></div><div class="line">#<span class="number">7</span>  AppThread::main (this=&lt;optimized <span class="keyword">out</span>&gt;) <span class="meta">at</span> android/android-emu/android/skin/nowindow/AppThread.cpp:<span class="number">18</span></div><div class="line">#<span class="number">8</span>  <span class="number">0x000000000093db44</span> <span class="keyword">in</span> android::base::Thread::thread_main (arg=<span class="number">0x1645900</span>) <span class="meta">at</span> android/android-emu/android/base/threads/Thread_pthread.cpp:<span class="number">152</span></div><div class="line">#<span class="number">9</span>  <span class="number">0x00007ffff7bc16ba</span> <span class="keyword">in</span> start_thread (arg=<span class="number">0x7ffff2a90700</span>) <span class="meta">at</span> pthread_create.c:<span class="number">333</span></div><div class="line">#<span class="number">10</span> <span class="number">0x00007ffff68403dd</span> <span class="keyword">in</span> clone () <span class="meta">at</span> ../sysdeps/unix/sysv/linux/x86_64/clone.S:<span class="number">109</span></div></pre></td></tr></table></figure></p>
<p>这里是在 emulator 进程完成对终端端口和 ADB 端口的监听之后，关于其状态通知 ADB server 而建立的临时连接，通知完成后连接销毁。</p>
<p>连接二：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="selector-id">#0</span>  <span class="selector-tag">android</span><span class="selector-pseudo">::base</span><span class="selector-pseudo">::socketTcp4LoopbackClient</span> (port=port<span class="variable">@entry</span>=<span class="number">5037</span>) <span class="selector-tag">at</span> <span class="selector-tag">android</span>/<span class="selector-tag">android-emu</span>/<span class="selector-tag">android</span>/<span class="selector-tag">base</span>/<span class="selector-tag">sockets</span>/<span class="selector-tag">SocketUtils</span><span class="selector-class">.cpp</span><span class="selector-pseudo">:607</span></div><div class="line"><span class="selector-id">#1</span>  <span class="selector-tag">0x00000000008b7027</span> <span class="selector-tag">in</span> <span class="selector-tag">android</span><span class="selector-pseudo">::emulation</span><span class="selector-pseudo">::AdbHostServer</span><span class="selector-pseudo">::notify</span> (adbEmulatorPort=<span class="number">5555</span>, adbClientPort=<span class="number">5037</span>) <span class="selector-tag">at</span> <span class="selector-tag">android</span>/<span class="selector-tag">android-emu</span>/<span class="selector-tag">android</span>/<span class="selector-tag">emulation</span>/<span class="selector-tag">AdbHostServer</span><span class="selector-class">.cpp</span><span class="selector-pseudo">:34</span></div><div class="line"><span class="selector-id">#2</span>  <span class="selector-tag">0x00000000008b65ae</span> <span class="selector-tag">in</span> <span class="selector-tag">android</span><span class="selector-pseudo">::emulation</span><span class="selector-pseudo">::AdbGuestPipe</span><span class="selector-pseudo">::onGuestSendCommand</span> (this=this<span class="variable">@entry</span>=<span class="number">0</span>x7fffd82b3fb0, buffers=<span class="number">0</span>x7fffe3ffd250, numBuffers=<span class="number">1</span>)</div><div class="line">    <span class="selector-tag">at</span> <span class="selector-tag">android</span>/<span class="selector-tag">android-emu</span>/<span class="selector-tag">android</span>/<span class="selector-tag">emulation</span>/<span class="selector-tag">AdbGuestPipe</span><span class="selector-class">.cpp</span><span class="selector-pseudo">:470</span></div><div class="line"><span class="selector-id">#3</span>  <span class="selector-tag">0x00000000008b6628</span> <span class="selector-tag">in</span> <span class="selector-tag">android</span><span class="selector-pseudo">::emulation</span><span class="selector-pseudo">::AdbGuestPipe</span><span class="selector-pseudo">::onGuestSend</span> (this=<span class="number">0</span>x7fffd82b3fb0, buffers=&lt;optimized out&gt;, numBuffers=&lt;optimized out&gt;)</div><div class="line">    <span class="selector-tag">at</span> <span class="selector-tag">android</span>/<span class="selector-tag">android-emu</span>/<span class="selector-tag">android</span>/<span class="selector-tag">emulation</span>/<span class="selector-tag">AdbGuestPipe</span><span class="selector-class">.cpp</span><span class="selector-pseudo">:229</span></div><div class="line"><span class="selector-id">#4</span>  <span class="selector-tag">0x000000000048437c</span> <span class="selector-tag">in</span> <span class="selector-tag">pipeDevice_doCommand_v2</span> (pipe=<span class="number">0</span>x7fffd8004d80) <span class="selector-tag">at</span> /<span class="selector-tag">media</span>/<span class="selector-tag">data</span>/<span class="selector-tag">Androids</span>/<span class="selector-tag">emu-2</span><span class="selector-class">.4-release</span>/<span class="selector-tag">external</span>/<span class="selector-tag">emulator-x86</span>/<span class="selector-tag">hw</span>/<span class="selector-tag">misc</span>/<span class="selector-tag">goldfish_pipe</span><span class="selector-class">.c</span><span class="selector-pseudo">:866</span></div><div class="line"><span class="selector-id">#5</span>  <span class="selector-tag">0x00000000004844b9</span> <span class="selector-tag">in</span> <span class="selector-tag">pipe_dev_write_v2</span> (dev=<span class="number">0</span>x7fff894e6e80, offset=&lt;optimized out&gt;, value=<span class="number">0</span>)</div><div class="line">    <span class="selector-tag">at</span> /<span class="selector-tag">media</span>/<span class="selector-tag">data</span>/<span class="selector-tag">Androids</span>/<span class="selector-tag">emu-2</span><span class="selector-class">.4-release</span>/<span class="selector-tag">external</span>/<span class="selector-tag">emulator-x86</span>/<span class="selector-tag">hw</span>/<span class="selector-tag">misc</span>/<span class="selector-tag">goldfish_pipe</span><span class="selector-class">.c</span><span class="selector-pseudo">:1082</span></div><div class="line"><span class="selector-id">#6</span>  <span class="selector-tag">0x000000000049a876</span> <span class="selector-tag">in</span> <span class="selector-tag">memory_region_write_accessor</span> (attrs=..., mask=<span class="number">4294967295</span>, shift=&lt;optimized out&gt;, size=&lt;optimized out&gt;, value=<span class="number">0</span>x7fffe3ffe838, addr=&lt;optimized out&gt;, </div><div class="line">    mr=<span class="number">0</span>x7fff894e68f0) <span class="selector-tag">at</span> /<span class="selector-tag">media</span>/<span class="selector-tag">data</span>/<span class="selector-tag">Androids</span>/<span class="selector-tag">emu-2</span><span class="selector-class">.4-release</span>/<span class="selector-tag">external</span>/<span class="selector-tag">emulator-x86</span>/<span class="selector-tag">memory</span><span class="selector-class">.c</span><span class="selector-pseudo">:525</span></div><div class="line"><span class="selector-id">#7</span>  <span class="selector-tag">access_with_adjusted_size</span> (attrs=..., mr=<span class="number">0</span>x7fff894e68f0, access=<span class="number">0</span>x4960d0 &lt;memory_region_write_accessor&gt;, access_size_max=&lt;optimized out&gt;, access_size_min=&lt;optimized out&gt;, </div><div class="line">    size=<span class="number">4</span>, value=<span class="number">0</span>x7fffe3ffe838, addr=<span class="number">0</span>) <span class="selector-tag">at</span> /<span class="selector-tag">media</span>/<span class="selector-tag">data</span>/<span class="selector-tag">Androids</span>/<span class="selector-tag">emu-2</span><span class="selector-class">.4-release</span>/<span class="selector-tag">external</span>/<span class="selector-tag">emulator-x86</span>/<span class="selector-tag">memory</span><span class="selector-class">.c</span><span class="selector-pseudo">:591</span></div><div class="line"><span class="selector-id">#8</span>  <span class="selector-tag">memory_region_dispatch_write</span> (mr=mr<span class="variable">@entry</span>=<span class="number">0</span>x7fff894e68f0, addr=<span class="number">0</span>, data=<span class="number">0</span>, size=size<span class="variable">@entry</span>=<span class="number">4</span>, attrs=..., attrs<span class="variable">@entry</span>=...)</div><div class="line">    <span class="selector-tag">at</span> /<span class="selector-tag">media</span>/<span class="selector-tag">data</span>/<span class="selector-tag">Androids</span>/<span class="selector-tag">emu-2</span><span class="selector-class">.4-release</span>/<span class="selector-tag">external</span>/<span class="selector-tag">emulator-x86</span>/<span class="selector-tag">memory</span><span class="selector-class">.c</span><span class="selector-pseudo">:1262</span></div><div class="line"><span class="selector-id">#9</span>  <span class="selector-tag">0x00000000004465de</span> <span class="selector-tag">in</span> <span class="selector-tag">address_space_write_continue</span> (mr=<span class="number">0</span>x7fff894e68f0, l=<span class="number">4</span>, addr1=<span class="number">0</span>, len=<span class="number">4</span>, buf=<span class="number">0</span>x7ffff7fcf028 <span class="string">""</span>, attrs=..., addr=<span class="number">4278194176</span>, </div><div class="line">    as=<span class="number">0</span>x11ebfc0 &lt;address_space_memory&gt;) <span class="selector-tag">at</span> /<span class="selector-tag">media</span>/<span class="selector-tag">data</span>/<span class="selector-tag">Androids</span>/<span class="selector-tag">emu-2</span><span class="selector-class">.4-release</span>/<span class="selector-tag">external</span>/<span class="selector-tag">emulator-x86</span>/<span class="selector-tag">exec</span><span class="selector-class">.c</span><span class="selector-pseudo">:2571</span></div><div class="line"><span class="selector-id">#10</span> <span class="selector-tag">address_space_write</span> (as=&lt;optimized out&gt;, addr=&lt;optimized out&gt;, attrs=..., buf=&lt;optimized out&gt;, len=&lt;optimized out&gt;)</div><div class="line">    <span class="selector-tag">at</span> /<span class="selector-tag">media</span>/<span class="selector-tag">data</span>/<span class="selector-tag">Androids</span>/<span class="selector-tag">emu-2</span><span class="selector-class">.4-release</span>/<span class="selector-tag">external</span>/<span class="selector-tag">emulator-x86</span>/<span class="selector-tag">exec</span><span class="selector-class">.c</span><span class="selector-pseudo">:2628</span></div><div class="line"><span class="selector-id">#11</span> <span class="selector-tag">0x00000000004476ed</span> <span class="selector-tag">in</span> <span class="selector-tag">address_space_rw</span> (as=&lt;optimized out&gt;, addr=&lt;optimized out&gt;, attrs=..., attrs<span class="variable">@entry</span>=..., buf=buf<span class="variable">@entry</span>=<span class="number">0</span>x7ffff7fcf028 <span class="string">""</span>, len=&lt;optimized out&gt;, </div><div class="line">    is_write=&lt;optimized out&gt;) <span class="selector-tag">at</span> /<span class="selector-tag">media</span>/<span class="selector-tag">data</span>/<span class="selector-tag">Androids</span>/<span class="selector-tag">emu-2</span><span class="selector-class">.4-release</span>/<span class="selector-tag">external</span>/<span class="selector-tag">emulator-x86</span>/<span class="selector-tag">exec</span><span class="selector-class">.c</span><span class="selector-pseudo">:2736</span></div><div class="line"><span class="selector-id">#12</span> <span class="selector-tag">0x00000000005f25df</span> <span class="selector-tag">in</span> <span class="selector-tag">kvm_cpu_exec</span> (cpu=cpu<span class="variable">@entry</span>=<span class="number">0</span>x7fffeff6eaa0) <span class="selector-tag">at</span> /<span class="selector-tag">media</span>/<span class="selector-tag">data</span>/<span class="selector-tag">Androids</span>/<span class="selector-tag">emu-2</span><span class="selector-class">.4-release</span>/<span class="selector-tag">external</span>/<span class="selector-tag">emulator-x86</span>/<span class="selector-tag">kvm-all</span><span class="selector-class">.c</span><span class="selector-pseudo">:1964</span></div><div class="line"><span class="selector-id">#13</span> <span class="selector-tag">0x000000000042fd7a</span> <span class="selector-tag">in</span> <span class="selector-tag">qemu_kvm_cpu_thread_fn</span> (arg=<span class="number">0</span>x7fffeff6eaa0) <span class="selector-tag">at</span> /<span class="selector-tag">media</span>/<span class="selector-tag">data</span>/<span class="selector-tag">Androids</span>/<span class="selector-tag">emu-2</span><span class="selector-class">.4-release</span>/<span class="selector-tag">external</span>/<span class="selector-tag">emulator-x86</span>/<span class="selector-tag">cpus</span><span class="selector-class">.c</span><span class="selector-pseudo">:1103</span></div><div class="line"><span class="selector-id">#14</span> <span class="selector-tag">0x0000000000827b00</span> <span class="selector-tag">in</span> <span class="selector-tag">qemu_thread_trampoline</span> (data_=<span class="number">0</span>x7fffeff8bed0) <span class="selector-tag">at</span> /<span class="selector-tag">media</span>/<span class="selector-tag">data</span>/<span class="selector-tag">Androids</span>/<span class="selector-tag">emu-2</span><span class="selector-class">.4-release</span>/<span class="selector-tag">external</span>/<span class="selector-tag">emulator-x86</span>/<span class="selector-tag">util</span>/<span class="selector-tag">qemu-thread-posix</span><span class="selector-class">.c</span><span class="selector-pseudo">:501</span></div><div class="line"><span class="selector-id">#15</span> <span class="selector-tag">0x00007ffff7bc16ba</span> <span class="selector-tag">in</span> <span class="selector-tag">start_thread</span> (arg=<span class="number">0</span>x7fffe3fff700) <span class="selector-tag">at</span> <span class="selector-tag">pthread_create</span><span class="selector-class">.c</span><span class="selector-pseudo">:333</span></div><div class="line"><span class="selector-id">#16</span> <span class="selector-tag">0x00007ffff68403dd</span> <span class="selector-tag">in</span> <span class="selector-tag">clone</span> () <span class="selector-tag">at</span> ../<span class="selector-tag">sysdeps</span>/<span class="selector-tag">unix</span>/<span class="selector-tag">sysv</span>/<span class="selector-tag">linux</span>/<span class="selector-tag">x86_64</span>/<span class="selector-tag">clone</span><span class="selector-class">.S</span><span class="selector-pseudo">:109</span></div></pre></td></tr></table></figure></p>
<p>这里是 emulator 运行的 Android 系统初始化到一定阶段之后，触发的与 ADB server 之间建立的连接，用于通知其状态。这个连接在通知完成之后销毁。</p>
<p>除了上面 3 个与 ADB server 建立连接的情况，在多个 emulator 同时运行时，如下这种情况发起的与 ADB server 建立连接的情况则要频繁得多：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">#<span class="number">0</span>  android::base::socketTcp4LoopbackClient (port=port@entry=<span class="number">5037</span>) <span class="meta">at</span> android/android-emu/android/base/sockets/SocketUtils.cpp:<span class="number">607</span></div><div class="line">#<span class="number">1</span>  <span class="number">0x00000000008f098b</span> <span class="keyword">in</span> android::wear::PairUpWearPhoneImpl::openConnection (this=<span class="number">0x7fff8add2b20</span>, port=<span class="number">5037</span>, watch=<span class="number">0x7fff8add2b30</span>, </div><div class="line">    callback=<span class="number">0x8f32e0</span> &lt;android::wear::_on_adb_server_socket_fd(void*, <span class="keyword">int</span>, unsigned <span class="keyword">int</span>)&gt;)</div><div class="line">    <span class="meta">at</span> android/android-emu/android/wear-agent/PairUpWearPhone.cpp:<span class="number">621</span></div><div class="line">#<span class="number">2</span>  <span class="number">0x00000000008f0cfb</span> <span class="keyword">in</span> android::wear::PairUpWearPhoneImpl::openAdbConnection (this=<span class="number">0x7fff8add2b20</span>)</div><div class="line">    <span class="meta">at</span> android/android-emu/android/wear-agent/PairUpWearPhone.cpp:<span class="number">595</span></div><div class="line">#<span class="number">3</span>  android::wear::PairUpWearPhoneImpl::startWriteCommandToAdb (this=this@entry=<span class="number">0x7fff8add2b20</span>, queryType=queryType@entry=<span class="number">1</span>, </div><div class="line">    message=<span class="number">0x7fffec08c2e8</span> <span class="string">"emulator-5556"</span>) <span class="meta">at</span> android/android-emu/android/wear-agent/PairUpWearPhone.cpp:<span class="number">373</span></div><div class="line">#<span class="number">4</span>  <span class="number">0x00000000008f0f77</span> <span class="keyword">in</span> android::wear::PairUpWearPhoneImpl::startProbeNextDevice (this=this@entry=<span class="number">0x7fff8add2b20</span>)</div><div class="line">    <span class="meta">at</span> android/android-emu/android/wear-agent/PairUpWearPhone.cpp:<span class="number">509</span></div><div class="line">#<span class="number">5</span>  <span class="number">0x00000000008f1de4</span> <span class="keyword">in</span> android::wear::PairUpWearPhoneImpl::updateDevices (this=this@entry=<span class="number">0x7fff8add2b20</span>, devices=...)</div><div class="line">    <span class="meta">at</span> android/android-emu/android/wear-agent/PairUpWearPhone.cpp:<span class="number">559</span></div><div class="line">#<span class="number">6</span>  <span class="number">0x00000000008f3503</span> <span class="keyword">in</span> android::wear::PairUpWearPhoneImpl::PairUpWearPhoneImpl (adbHostPort=<span class="number">5037</span>, devices=..., looper=&lt;optimized <span class="keyword">out</span>&gt;, </div><div class="line">    this=<span class="number">0x7fff8add2b20</span>) <span class="meta">at</span> android/android-emu/android/wear-agent/PairUpWearPhone.cpp:<span class="number">485</span></div><div class="line">#<span class="number">7</span>  android::wear::PairUpWearPhone::PairUpWearPhone (this=<span class="number">0x7fff899dbd50</span>, looper=&lt;optimized <span class="keyword">out</span>&gt;, devices=..., adbHostPort=<span class="number">5037</span>)</div><div class="line">    <span class="meta">at</span> android/android-emu/android/wear-agent/PairUpWearPhone.cpp:<span class="number">643</span></div><div class="line">#<span class="number">8</span>  <span class="number">0x00000000008effb3</span> <span class="keyword">in</span> android::wear::WearAgentImpl::onRead (this=<span class="number">0x7fffec081f20</span>) <span class="meta">at</span> android/android-emu/android/wear-agent/WearAgent.cpp:<span class="number">195</span></div><div class="line">#<span class="number">9</span>  <span class="number">0x00000000008727d0</span> <span class="keyword">in</span> android::qemu::(anonymous namespace)::QemuLooper::FdWatch::fire (this=<span class="number">0x7fff89b03590</span>)</div><div class="line">    <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/android-qemu2-glue/base/async/Looper.cpp:<span class="number">128</span></div><div class="line">#<span class="number">10</span> android::qemu::(anonymous namespace)::QemuLooper::handleBottomHalf (opaque=<span class="number">0x7fffec0813d0</span>)</div><div class="line">    <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/android-qemu2-glue/base/async/Looper.cpp:<span class="number">328</span></div><div class="line">#<span class="number">11</span> <span class="number">0x00000000005ffdc2</span> <span class="keyword">in</span> aio_bh_call (<span class="number">bh</span>=&lt;optimized <span class="keyword">out</span>&gt;) <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/async.c:<span class="number">67</span></div><div class="line">#<span class="number">12</span> aio_bh_poll (ctx=ctx@entry=<span class="number">0x7fffec080e10</span>) <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/async.c:<span class="number">95</span></div><div class="line">#<span class="number">13</span> <span class="number">0x00000000007ea320</span> <span class="keyword">in</span> aio_dispatch (ctx=<span class="number">0x7fffec080e10</span>) <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/aio-posix.c:<span class="number">309</span></div><div class="line">#<span class="number">14</span> <span class="number">0x00000000005ffae9</span> <span class="keyword">in</span> aio_ctx_dispatch (source=&lt;optimized <span class="keyword">out</span>&gt;, callback=&lt;optimized <span class="keyword">out</span>&gt;, user_data=&lt;optimized <span class="keyword">out</span>&gt;)</div><div class="line">    <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/async.c:<span class="number">234</span></div><div class="line">#<span class="number">15</span> <span class="number">0x0000000000cdeaee</span> <span class="keyword">in</span> g_main_dispatch (context=<span class="number">0x7fffec081270</span>) <span class="meta">at</span> /tmp/zyy-build-temp-<span class="number">120638</span>/src/glib-<span class="number">2.38</span><span class="meta">.2</span>/glib/gmain.c:<span class="number">3072</span></div><div class="line">#<span class="number">16</span> g_main_context_dispatch (context=context@entry=<span class="number">0x7fffec081270</span>) <span class="meta">at</span> /tmp/zyy-build-temp-<span class="number">120638</span>/src/glib-<span class="number">2.38</span><span class="meta">.2</span>/glib/gmain.c:<span class="number">3648</span></div><div class="line">#<span class="number">17</span> <span class="number">0x0000000000787d04</span> <span class="keyword">in</span> glib_pollfds_poll () <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/main-<span class="keyword">loop</span>.c:<span class="number">222</span></div><div class="line">#<span class="number">18</span> os_host_main_loop_wait (timeout=&lt;optimized <span class="keyword">out</span>&gt;) <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/main-<span class="keyword">loop</span>.c:<span class="number">267</span></div><div class="line">#<span class="number">19</span> main_loop_wait (nonblocking=&lt;optimized <span class="keyword">out</span>&gt;) <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/main-<span class="keyword">loop</span>.c:<span class="number">514</span></div><div class="line">#<span class="number">20</span> <span class="number">0x0000000000429c0c</span> <span class="keyword">in</span> main_loop () <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/vl.c:<span class="number">2150</span></div><div class="line">#<span class="number">21</span> main_impl (argc=&lt;optimized <span class="keyword">out</span>&gt;, argv=&lt;optimized <span class="keyword">out</span>&gt;) <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/vl.c:<span class="number">5346</span></div><div class="line">#<span class="number">22</span> <span class="number">0x000000000042a7b6</span> <span class="keyword">in</span> run_qemu_main (argc=&lt;optimized <span class="keyword">out</span>&gt;, argv=&lt;optimized <span class="keyword">out</span>&gt;)</div><div class="line">    <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/vl.c:<span class="number">3254</span></div><div class="line">#<span class="number">23</span> <span class="number">0x000000000042a80a</span> <span class="keyword">in</span> enter_qemu_main_loop (argc=<span class="number">62</span>, argv=<span class="number">0x7fffffffcf40</span>)</div><div class="line">    <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/external/emulator-x86/android-qemu2-glue/main.cpp:<span class="number">341</span></div><div class="line">#<span class="number">24</span> <span class="number">0x0000000000414775</span> <span class="keyword">in</span> <span class="keyword">std</span>::function&lt;void ()&gt;::operator()() const (this=&lt;optimized <span class="keyword">out</span>&gt;)</div><div class="line">    <span class="meta">at</span> /media/data/Androids/emu-<span class="number">2.4</span>-release/prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2<span class="meta">.11</span>-<span class="number">4.8</span>/x86_64-linux/include/c++/<span class="number">4.8</span>/functional:<span class="number">2464</span></div><div class="line">#<span class="number">25</span> AppThread::main (this=&lt;optimized <span class="keyword">out</span>&gt;) <span class="meta">at</span> android/android-emu/android/skin/nowindow/AppThread.cpp:<span class="number">18</span></div><div class="line">#<span class="number">26</span> <span class="number">0x000000000093db44</span> <span class="keyword">in</span> android::base::Thread::thread_main (arg=<span class="number">0x1645900</span>) <span class="meta">at</span> android/android-emu/android/base/threads/Thread_pthread.cpp:<span class="number">152</span></div><div class="line">#<span class="number">27</span> <span class="number">0x00007ffff7bc16ba</span> <span class="keyword">in</span> start_thread (arg=<span class="number">0x7ffff2a90700</span>) <span class="meta">at</span> pthread_create.c:<span class="number">333</span></div><div class="line">#<span class="number">28</span> <span class="number">0x00007ffff68403dd</span> <span class="keyword">in</span> clone () <span class="meta">at</span> ../sysdeps/unix/sysv/linux/x86_64/clone.S:<span class="number">109</span></div></pre></td></tr></table></figure></p>
<p>比较关键的是栈的 #8 号栈帧，其相关代码位于 <code>qemu/android/android-emu/android/wear-agent/WearAgent.cpp</code> 中，像这样：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> WearAgentImpl::onRead() &#123;</div><div class="line">    <span class="keyword">if</span> (!connected()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">bool</span> isError = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">int</span> msgsize = <span class="number">0</span>;</div><div class="line">    AsyncStatus status = mAsyncReader.run();</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (status) &#123;</div><div class="line">        <span class="keyword">case</span> kAsyncCompleted:</div><div class="line">            <span class="keyword">if</span> (expectOkay() &amp;&amp; !<span class="built_in">strncmp</span>(<span class="string">"OKAY"</span>, mReadBuffer, <span class="number">4</span>)) &#123;</div><div class="line">                mTimer-&gt;stop();</div><div class="line">                mReadBuffer[<span class="number">4</span>] = <span class="string">'\0'</span>;</div><div class="line">                mAsyncReader.reset(mReadBuffer, <span class="number">4</span>, mFdWatch.get());</div><div class="line">                mExpectReplayType = LENGTH;</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expectLength() &amp;&amp; isValidHexNumber(mReadBuffer, <span class="number">4</span>)</div><div class="line">                    &amp;&amp; <span class="number">1</span> == <span class="built_in">sscanf</span>(mReadBuffer, <span class="string">"%x"</span>, &amp;msgsize)) &#123;</div><div class="line">                <span class="keyword">if</span> (msgsize &lt; <span class="number">0</span>) &#123;</div><div class="line">                    isError = <span class="literal">true</span>;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == msgsize) &#123; <span class="comment">//this is not error: just no devices</span></div><div class="line">                    mExpectReplayType = LENGTH;</div><div class="line">                    mReadBuffer[msgsize] = <span class="string">'\0'</span>;</div><div class="line">                    mAsyncReader.reset(mReadBuffer, <span class="number">4</span>, mFdWatch.get());</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (msgsize &gt;= mSizeOfReadBuffer) &#123;</div><div class="line">                        <span class="keyword">char</span>* ptr = (<span class="keyword">char</span>*)<span class="built_in">calloc</span>(<span class="number">2</span> * msgsize, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</div><div class="line">                        <span class="keyword">if</span> (ptr) &#123;</div><div class="line">                            mSizeOfReadBuffer = <span class="number">2</span> * msgsize;</div><div class="line">                            <span class="built_in">free</span>(mReadBuffer);</div><div class="line">                            mReadBuffer = ptr;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    mExpectReplayType = MESSAGE;</div><div class="line">                    mReadBuffer[msgsize] = <span class="string">'\0'</span>;</div><div class="line">                    mAsyncReader.reset(mReadBuffer, msgsize, mFdWatch.get());</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (expectMsg()) &#123;</div><div class="line">                DPRINT(<span class="string">"message received from ADB:\n%s"</span>, mReadBuffer);</div><div class="line">                mPairUpWearPhone.reset();</div><div class="line"></div><div class="line">                <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; devices;</div><div class="line">                parseAdbDevices(mReadBuffer, &amp;devices);</div><div class="line">                <span class="keyword">if</span> (devices.size() &gt;= <span class="number">2</span>) &#123;</div><div class="line">                    mPairUpWearPhone.reset(<span class="keyword">new</span> PairUpWearPhone(mLooper,</div><div class="line">                                                               devices,</div><div class="line">                                                               mAdbHostPort));</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// prepare for next adb devices message</span></div><div class="line">                mReadBuffer[<span class="number">4</span>] = <span class="string">'\0'</span>;</div><div class="line">                mAsyncReader.reset(mReadBuffer, <span class="number">4</span>, mFdWatch.get());</div><div class="line">                mExpectReplayType = LENGTH;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                isError = <span class="literal">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> kAsyncAgain:</div><div class="line">            <span class="keyword">return</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> kAsyncError:</div><div class="line">            isError = <span class="literal">true</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isError) &#123;</div><div class="line">        cleanupConnection();</div><div class="line">        connectLater();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从中可以看到，在 <code>WearAgentImpl::onRead()</code> 中收到了新消息，从而触发了 emulator 与 ADB server 建立连接。这些消息实际上像下面这样：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">emulator<span class="number">-5810</span>	device</div><div class="line">emulator<span class="number">-5808</span>	device</div><div class="line">emulator<span class="number">-5806</span>	device</div><div class="line">emulator<span class="number">-5804</span>	device</div><div class="line">emulator<span class="number">-5802</span>	device</div><div class="line">emulator<span class="number">-5800</span>	device</div><div class="line">emulator<span class="number">-5798</span>	device</div><div class="line">emulator<span class="number">-5796</span>	device</div><div class="line">emulator<span class="number">-5794</span>	device</div><div class="line">emulator<span class="number">-5792</span>	device</div><div class="line">emulator<span class="number">-5790</span>	device</div><div class="line">emulator<span class="number">-5788</span>	device</div></pre></td></tr></table></figure></p>
<p>通过观察，不难发现，当系统中有设备/模拟器实例状态发生改变，比如新创建了 emulator 实例，或者 emulator 实例从 OFFLINE 状态切换到 ONLINE 状态，每个 emulator 进程都会收到所有设备/模拟器实例的最新状态。emulator 收到的这些状态信息就像执行 <code>adb devices</code> 命令时看到的那样。不难推测这些消息是由 ADB server 发送的。</p>
<p>当系统中运行大量的 emulator 实例时，大量 emulator 实例频繁地相互争抢 CPU 资源，正是由于 ADB server 频繁地向与其连接的所有 emulator 实例广播所有 emulator 实例的状态所导致。</p>
<p>这种机制本来主要是为 Android 可穿戴设备设计，用于与 Android 手机配对的，但在系统中运行大量 emulator 实例时，却导致了性能问题。</p>
<h1 id="ADB-导致的性能问题的解决"><a href="#ADB-导致的性能问题的解决" class="headerlink" title="ADB 导致的性能问题的解决"></a>ADB 导致的性能问题的解决</h1><p>既然找到了问题之所在，那就要寻找解决办法。解决方法可以有两个：一是让 ADB server 不要频繁地唤醒 emulator 进程并向与其连接的所有 emulator 实例广播所有 emulator 实例的状态；二是让 emulator 进程忽略收到的这种消息。</p>
<p>综合来看，还是修改 ADB server 代价较低。</p>
<p>分析 ADB 的代码，不难发现，在 ADB server 中，是通过 <code>system/core/adb/transport.cpp</code> 文件中的 <code>device_tracker_send()</code> 函数向所有 emulator 实例发送我们前面观察到的消息的。</p>
<p><code>device_tracker_send()</code> 函数在相同文件中的 <code>device_tracker_ready()</code> 和 <code>update_transports()</code> 函数中被调用，这两个函数定义如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">device_tracker_ready</span><span class="params">(asocket* socket)</span> </span>&#123;</div><div class="line">    device_tracker* tracker = <span class="keyword">reinterpret_cast</span>&lt;device_tracker*&gt;(socket);</div><div class="line"></div><div class="line">    <span class="comment">// We want to send the device list when the tracker connects</span></div><div class="line">    <span class="comment">// for the first time, even if no update occurred.</span></div><div class="line">    <span class="keyword">if</span> (tracker-&gt;update_needed &gt; <span class="number">0</span>) &#123;</div><div class="line">        tracker-&gt;update_needed = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> transports = list_transports(<span class="literal">false</span>);</div><div class="line">        device_tracker_send(tracker, transports);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">. . . . . .</div><div class="line"><span class="comment">// Call this function each time the transport list has changed.</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">update_transports</span><span class="params">()</span> </span>&#123;</div><div class="line">    update_transport_status();</div><div class="line"></div><div class="line">    <span class="comment">// Notify `adb track-devices` clients.</span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> transports = list_transports(<span class="literal">false</span>);</div><div class="line"></div><div class="line">    device_tracker* tracker = device_tracker_list;</div><div class="line">    <span class="keyword">while</span> (tracker != <span class="literal">nullptr</span>) &#123;</div><div class="line">        device_tracker* next = tracker-&gt;next;</div><div class="line">        <span class="comment">// This may destroy the tracker if the connection is closed.</span></div><div class="line">        device_tracker_send(tracker, transports);</div><div class="line">        tracker = next;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这两个函数分别在 emulator 启动之初，和其它的 emulator 状态改变时，向所有 emulator 实例发送消息。</p>
<p>鉴于对 Android wear 设备的支持没有太多意义，因而可以禁掉这里向所有 emulator 实例广播所有 emulator 实例状态的动作。</p>
<p>经过上面这番对于 ADB server 的改造，adb 支持的命令，如 <code>adb shell</code> 等，依然可以正常执行，但系统中 emulator 进程的 CPU 消耗则可以降到比较低的状态。通过 top 命令可以看到：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND </div><div class="line">7748 hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 431236 </span><span class="number"> 14700 </span>S   1.6  0.3   2:45.72 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 5716 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 437776 </span><span class="number"> 14624 </span>S   1.3  0.3   2:55.71 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 5903 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 433300 </span><span class="number"> 14620 </span>S   1.3  0.3   2:55.35 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6025 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 427112 </span><span class="number"> 14572 </span>S   1.3  0.3   2:37.52 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6056 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3095516<span class="number"> 525896 </span><span class="number"> 14668 </span>S   1.3  0.4   2:59.92 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6083 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 437616 </span><span class="number"> 14628 </span>S   1.3  0.3   2:45.89 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6220 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 437676 </span><span class="number"> 14660 </span>S   1.3  0.3   2:37.56 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6368 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 441672 </span><span class="number"> 14644 </span>S   1.3  0.3   2:56.10 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6400 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 437524 </span><span class="number"> 14748 </span>S   1.3  0.3   2:48.84 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6462 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 433292 </span><span class="number"> 14616 </span>S   1.3  0.3   2:39.45 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6560 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 433496 </span><span class="number"> 14724 </span>S   1.3  0.3   2:44.71 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6594 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 435388 </span><span class="number"> 14604 </span>S   1.3  0.3   2:44.74 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6630 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 429088 </span><span class="number"> 14556 </span>S   1.3  0.3   2:59.23 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6665 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 437472 </span><span class="number"> 14700 </span>S   1.3  0.3   2:51.72 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6699 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 429248 </span><span class="number"> 14700 </span>S   1.3  0.3   2:50.96 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6734 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 435380 </span><span class="number"> 14604 </span>S   1.3  0.3   2:51.35 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6847 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 431252 </span><span class="number"> 14712 </span>S   1.3  0.3   2:51.83 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6885 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 437388 </span><span class="number"> 14604 </span>S   1.3  0.3   2:44.26 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 6923 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3013596<span class="number"> 433640 </span><span class="number"> 14652 </span>S   1.3  0.3   2:47.02 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 7003 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 431240 </span><span class="number"> 14664 </span>S   1.3  0.3   2:50.47 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 7165 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 439512 </span><span class="number"> 14664 </span>S   1.3  0.3   2:39.88 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 7206 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>3021788<span class="number"> 431376 </span><span class="number"> 14660 </span>S   1.3  0.3   2:35.25 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 7249 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 439600 </span><span class="number"> 14700 </span>S   1.3  0.3   2:42.71 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 7293 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 433388 </span><span class="number"> 14628 </span>S   1.3  0.3   2:41.90 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 7336 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 437264 </span><span class="number"> 14584 </span>S   1.3  0.3   2:46.49 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 7424 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 439568 </span><span class="number"> 14620 </span>S   1.3  0.3   2:40.42 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 7653 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 437660 </span><span class="number"> 14720 </span>S   1.3  0.3   2:36.18 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 7848 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 439468 </span><span class="number"> 14728 </span>S   1.3  0.3   2:38.05 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 7946 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 429184 </span><span class="number"> 14664 </span>S   1.3  0.3   2:39.66 qemu-system-aar                                                                     </div><div class="line"><span class="number"> 8149 </span>hzhanpe+ <span class="number"> 20 </span> <span class="number"> 0 </span>2948060<span class="number"> 424992 </span><span class="number"> 14632 </span>S   1.3  0.3   2:36.11 qemu-system-aar</div></pre></td></tr></table></figure></p>
<h3 id="打赏"><a href="#打赏" class="headerlink" title="打赏"></a><a href="https://www.wolfcstech.com/about/donate.html">打赏</a></h3><p>Done。</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wxpay.png" alt="Han Pengfei 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Han Pengfei 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/虚拟化/" rel="tag"># 虚拟化</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/21/android_avd/" rel="next" title="Android AVD">
                <i class="fa fa-chevron-left"></i> Android AVD
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/11/24/gerrit_codereview/" rel="prev" title="Gerrit代码审核服务器搭建全过程">
                Gerrit代码审核服务器搭建全过程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/freesoft.jpg"
                alt="Han Pengfei" />
            
              <p class="site-author-name" itemprop="name">Han Pengfei</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">207</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/hanpfei" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.douban.com/people/3681478/" target="_blank" title="豆瓣"><i class="fa fa-fw fa-globe"></i>豆瓣</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/han-peng-fei-49" target="_blank" title="知乎"><i class="fa fa-fw fa-globe"></i>知乎</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:hanpfei@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#NUMA-机制的应用"><span class="nav-number">1.</span> <span class="nav-text">NUMA 机制的应用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#adb-导致的性能问题"><span class="nav-number">2.</span> <span class="nav-text">adb 导致的性能问题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ADB-导致的性能问题的解决"><span class="nav-number">3.</span> <span class="nav-text">ADB 导致的性能问题的解决</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#打赏"><span class="nav-number">3.0.1.</span> <span class="nav-text">打赏</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016.09.16 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Han Pengfei</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.3"></script>



  



	





  





  









<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 's9sbM9ODdusCzKcm5JcIj6t8-gzGzoHsz',
    appKey: 'UoO9ia1DLNwOXRUsTBQ6QXxm',
    placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true,
    lang: '' || 'zh-cn'
  });
</script>


  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

</body>
</html>
