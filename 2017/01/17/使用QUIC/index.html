<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>使用QUIC | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">使用QUIC</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">使用QUIC</h1><div class="post-meta">Jan 17, 2017<span> | </span><span class="category"><a href="/categories/网络协议/">网络协议</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/01/17/使用QUIC/" href="/2017/01/17/使用QUIC/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>QUIC是Google新开发的一个基于UDP的协议，它提供了像TCP一样的传输可靠性保证，可以实现数据传输的0-RTT延迟，灵活的设计使我们可以对它的拥塞控制及流量控制做更多的定制，它还提供了传输的安全性保障，以及像HTTP/2一样的应用数据二进制分帧传输。<br><a id="more"></a><br>而QUIC协议最最吸引人的特性有两点，一是对队首阻塞问题的解决更为彻底。基于TCP的HTTP/2，尽管从逻辑上来说，不同的流之间相互独立，不会相互影响，但在实际传输方面，数据还是要一帧一帧的发送和接收，一旦某一个流的数据有丢包，则同样会阻塞在它之后传输的其它与它毫不相干的流的数据的传输。而基于UDP的QUIC协议则可以更为彻底地解决这样的问题，让不同的流之间真正的实现相互独立传输，互不干扰。</p>
<p>另一个特性切换网络时的连接保持。当前移动端的应用环境，用户的网络可能会经常切换，比如从办公室或家里出门，WiFi断开，网络切换为3G或4G。基于TCP的协议，由于切换网络之后，IP会改变，因而之前的连接不可能继续保持。而基于UDP的QUIC协议，则可以内建与TCP中不同的连接标识方法，从而在网络完成切换之后，恢复之前与服务器的连接。</p>
<p>由于这些良好的特性，QUIC协议已经有在gmail中得到了大量的应用。打开Wireshark，随便对某个网卡抓包，都能看到大量的QUIC协议包：</p>
<p>这里我们来跑一下QUIC。</p>
<h1 id="选择一份QUIC代码"><a href="#选择一份QUIC代码" class="headerlink" title="选择一份QUIC代码"></a>选择一份QUIC代码</h1><p>下面的说明是用来基于chromium代码库编译QUIC代码。在Chrome支持的任何平台上，这里的说明都能保证是有效的，遇到问题时可以查看一些扩展的故障排查的文档。如果不想下载整个chromium代码库，则可以尝试github上快速而干净的<a href="https://github.com/google/proto-quic" target="_blank" rel="external">proto-quic</a>库。这是chromium中的代码的一份克隆，但剔除了大多数不必要的依赖，因而下载它要快得多，编译也更快，但不一定在所有的平台上都能用。事实上，github上的<a href="https://github.com/google/proto-quic" target="_blank" rel="external">proto-quic</a>库，当前只支持在Ubuntu linux上编译。</p>
<h1 id="编译QUIC客户端和服务器"><a href="#编译QUIC客户端和服务器" class="headerlink" title="编译QUIC客户端和服务器"></a>编译QUIC客户端和服务器</h1><p>Chromium中提供了一个示例客户端和服务器实现。要使用这些东西，你首先应该已经<a href="http://www.chromium.org/developers/how-tos/get-the-code" target="_blank" rel="external">下载Chromium的源代码</a>，然后构建二进制文件：<br><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ninja -<span class="keyword">C</span> out/<span class="keyword">Debug</span> quic_server quic_client</div></pre></td></tr></table></figure></p>
<p>这就像编译chromium的任何模块一样。可以参考 <a href="http://www.jianshu.com/p/9d7a6e9ed777" target="_blank" rel="external">懒人chromium net android移植指南</a> 来对Chromium的构建系统做更多了解。</p>
<p>如果条件允许，github上的<a href="https://github.com/google/proto-quic" target="_blank" rel="external">proto-quic</a>库，编译起来也很简单快捷。首先需要下载代码及构建依赖的整个工具链：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/google/proto-quic.git</div><div class="line"><span class="keyword">cd</span> proto-quic</div><div class="line">export PATH=$PATH:`<span class="keyword">pwd</span>`/depot_tools</div><div class="line">./proto_quic_tools/<span class="keyword">sync</span>.<span class="keyword">sh</span></div></pre></td></tr></table></figure></p>
<p>然后编译就是了，与普通的chromium模块编译一样：<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd src</div><div class="line">gn gen <span class="keyword">out</span>/<span class="keyword">Default</span> &amp;&amp; ninja -C <span class="keyword">out</span>/<span class="keyword">Default</span> quic_client quic_server net_unittests</div></pre></td></tr></table></figure></p>
<h1 id="从www-example-org准备测试数据"><a href="#从www-example-org准备测试数据" class="headerlink" title="从www.example.org准备测试数据"></a>从www.example.org准备测试数据</h1><p>下载一份www.example.org的拷贝，它主要是给quic_server二进制可执行文件用来提供本地服务的：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="title">mkdir</span> ~/quic-<span class="class"><span class="keyword">data</span></span></div><div class="line"><span class="title">cd</span> ~/quic-<span class="class"><span class="keyword">data</span></span></div><div class="line"><span class="title">wget</span> -p <span class="comment">--save-headers https://www.example.org</span></div></pre></td></tr></table></figure></p>
<p>这里主要是要下载一个html文件，且保存文件的所有的HTTP header，当然也可以从其它的站点下载这个文件。</p>
<p>手动地编辑index.html，并调整如下的headers：</p>
<ul>
<li>移除(如果存在的话)：”Transfer-Encoding: chunked”</li>
<li>移除(如果存在的话)：”Alternate-Protocol: …”</li>
<li>添加：X-Original-Url: <a href="https://www.example.org/" target="_blank" rel="external">https://www.example.org/</a></li>
</ul>
<h1 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h1><p>为了运行服务器，需要一个有效的证书，及一个pkcs8格式的私有key。如果没有，则可以使用脚本来产生它们：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> <span class="keyword">net</span>/tools/quic/certs</div><div class="line">./<span class="keyword">generate</span>-certs.<span class="keyword">sh</span></div><div class="line"><span class="keyword">cd</span> -</div></pre></td></tr></table></figure></p>
<p>除了服务器的证书及public key，这个脚本也会产生一个CA证书 (net/tools/quic/certs/out/2048-sha256-root.pem)，需要把它添加到操作系统的根证书商店以便于在证书验证期间它被信任。</p>
<p>一种比较简单的管理证书的方法是使用chrome浏览器。在地址栏中输入 <code>chrome://settings/search#ssl</code>，然后点击“管理证书”：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-a39ee579a3606059.png" alt="SSL Management"></p>
<p>在弹出的窗口中选择 “授权中心”，如下图：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-8512bcbe2d529253.png" alt="Import Certificate"></p>
<p>然后点击 “导入…” 按钮，此时将弹出一个文件选择对话框，我们选中所需要导入的根证书文件，也就是 <code>net/tools/quic/certs/out/2048-sha256-root.pem</code>，此时将有如下提示：</p>
<p><img src="https://www.wolfcstech.com/images/1315506-deed629c07d27313.png" alt=""></p>
<p>勾选其中的第一项，“信任该证书，以标识网站的身份。”，然后点击 “确定” 按钮结束导入。</p>
<p>在linux上管理证书相关的更多信息，请参考 <a href="https://chromium.googlesource.com/chromium/src/+/master/docs/linux_cert_management.md" target="_blank" rel="external">这些说明</a> 。</p>
<p>如果遗漏了这里的添加CA证书的步骤的话，后面在执行quic_client的时候会报出如下的证书验证错误：<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ./<span class="keyword">out</span>/<span class="keyword">Default</span>/quic_client <span class="comment">--host=127.0.0.1 --port=80 https://www.example.org/</span></div><div class="line">[<span class="number">1008</span>/<span class="number">164047</span>:<span class="literal">ERROR</span>:cert_verify_proc_nss.cc(<span class="number">942</span>)] CERT_PKIXVerifyCert <span class="keyword">for</span> www.example.org failed err=-<span class="number">8179</span></div><div class="line">[<span class="number">1008</span>/<span class="number">164047</span>:<span class="literal">WARNING</span>:proof_verifier_chromium.cc(<span class="number">466</span>)] Failed <span class="keyword">to</span> verify certificate chain: net::ERR_CERT_AUTHORITY_INVALID</div><div class="line">Failed <span class="keyword">to</span> connect <span class="keyword">to</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">80</span>. <span class="literal">Error</span>: QUIC_PROOF_INVALID</div></pre></td></tr></table></figure></p>
<h1 id="运行QUIC服务器和客户端"><a href="#运行QUIC服务器和客户端" class="headerlink" title="运行QUIC服务器和客户端"></a>运行QUIC服务器和客户端</h1><p>运行quic_server：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">.<span class="regexp">/out/</span><span class="keyword">Default</span><span class="regexp">/quic_server \</span></div><div class="line">  --quic_in_memory_cache_dir=~/quic-data<span class="regexp">/www.example.org \</span></div><div class="line">  --certificate_file=net/tools<span class="regexp">/quic/</span>certs<span class="regexp">/out/</span>leaf_cert.pem \</div><div class="line">  --key_file=net<span class="regexp">/tools/</span>quic<span class="regexp">/certs/</span>out<span class="regexp">/leaf_cert.pkcs8</span></div></pre></td></tr></table></figure></p>
<p>还可以通过–port参数指定quic_server监听的端口，及–v参数指定输出更多信息，如：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.<span class="regexp">/out/</span><span class="keyword">Default</span><span class="regexp">/quic_server --certificate_file=~/</span>proto-quic<span class="regexp">/src/</span>net<span class="regexp">/tools/</span>quic<span class="regexp">/certs/</span>out<span class="regexp">/leaf_cert.pem --key_file=~/</span>proto-quic<span class="regexp">/src/</span>net<span class="regexp">/tools/</span>quic<span class="regexp">/certs/</span>out<span class="regexp">/leaf_cert.pkcs8 --quic_in_memory_cache_dir=~/</span>quic-data<span class="regexp">/www.example.com --port=32457 --v=1</span></div></pre></td></tr></table></figure></p>
<p>quic_in_memory_cache_dir参数指定存放资源文件的目录路径。如我们前面看到的，从www.example.org下载到页面之后，需要调整headers，其中为<code>X-Original-Url</code>设置的是相应资源的url。quic_server起来的时候，会加载该目录下的文件。要为quic_server添加其它的测试资源，也要注意正确的设置其headers。如json接口：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># <span class="keyword">cat</span> testApi1 </div><div class="line">HTTP/1.1 200 OK</div><div class="line">Cache-Control: private</div><div class="line">Content-Length: 3214</div><div class="line">Content-<span class="keyword">Type</span>: application/json; charset=utf-8</div><div class="line">Server: Microsoft-<span class="keyword">IIS</span>/7.5</div><div class="line">X-AspNet-<span class="keyword">Version</span>: 4.0.30319</div><div class="line">X-Powered-<span class="keyword">By</span>: ASP.<span class="keyword">NET</span></div><div class="line">Date: Thu, 13 Oct 2016 02:12:28 GMT</div><div class="line">X-Original-Url: https:<span class="comment">//www.wolfcstech.com:6121/testApi1</span></div><div class="line"></div><div class="line">&#123;<span class="string">"res"</span>:[&#123;<span class="string">"ctime"</span>:<span class="string">"2016-10-11"</span>,<span class="string">"title"</span>:<span class="string">"温州"</span>,<span class="string">"des"</span>:<span class="string">"国内"</span>,<span class="string">"url"</span>:<span class="string">"http://news.163.com/16/1011/11/C33GFLIP0001124J.html"</span>&#125;,&#123;<span class="string">"ime"</span>:<span class="string">"2016"</span>,<span class="string">"tit"</span>:<span class="string">"b"</span>,<span class="string">"des"</span>:<span class="string">"a"</span>&#125;, &#123;<span class="string">"ime"</span>:<span class="string">"2016"</span>,<span class="string">"tit"</span>:<span class="string">"b"</span>,<span class="string">"des"</span>:<span class="string">"a"</span>&#125;],<span class="string">"rea"</span>:<span class="string">"Su"</span>&#125;</div></pre></td></tr></table></figure></p>
<p>然后就可以使用quic_client以QUIC协议请求文件了：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.<span class="regexp">/out/</span><span class="keyword">Default</span><span class="regexp">/quic_client --host=127.0.0.1 --port=32457 https:/</span><span class="regexp">/www.example.org/</span></div></pre></td></tr></table></figure></p>
<p>注意，如果要让服务器运行于端口32457上，则必须为客户端指定端口，因为它默认是80。</p>
<p>此外，如果本地机器有多个loopback地址 (由于它同时使用IPv4 和 IPv6)，则不得不选定一个地址。</p>
<p>目前还不确定后面的缺点是不是一个bug。</p>
<p>注意：client和server都主要是为了做集成测试的：它们都不能大规模使用。</p>
<p>要使用chrome来测试相同的下载过程，可以执行：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">chromium-browser \</div><div class="line">  -<span class="ruby">-user-data-dir=<span class="regexp">/tmp/chrome</span>-profile \</span></div><div class="line">  -<span class="ruby">-no-proxy-server \</span></div><div class="line">  -<span class="ruby">-enable-quic \</span></div><div class="line">  -<span class="ruby">-origin-to-force-quic-on=www.example.<span class="symbol">org:</span><span class="number">443</span> \</span></div><div class="line">  -<span class="ruby">-host-resolver-rules=<span class="string">'MAP www.example.org:443 127.0.0.1:32457'</span> \</span></div><div class="line">  https://www.example.org</div></pre></td></tr></table></figure></p>
<h1 id="使用Chromium-net访问QUIC资源"><a href="#使用Chromium-net访问QUIC资源" class="headerlink" title="使用Chromium net访问QUIC资源"></a>使用Chromium net访问QUIC资源</h1><p>我们不仅可以通过 Chrome 浏览器访问 QUIC 服务，还可以通过 Chromium net来访问。Chromium 有一个名为 cronet 的子项目，是一个 Chromium net 在移动端的封装，它提供了非常方便的接口，以便于将 Chromium net 用在移动平台，cronet 具体的移植过程，可以参考 <a href="https://www.wolfcstech.com/2016/11/11/lazy-chromium-net-android-porting-guide/">懒人chromium net android移植指南</a> 一文。</p>
<p>在将 Chromium net 移植到 Android 之后，我们可以通过如下的方式在手机上访问QUIC 服务：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.netease.netlib;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.chromium.net.CronetEngine;</div><div class="line"><span class="keyword">import</span> org.chromium.net.UploadDataProviders;</div><div class="line"><span class="keyword">import</span> org.chromium.net.UrlRequest;</div><div class="line"><span class="keyword">import</span> org.json.JSONException;</div><div class="line"><span class="keyword">import</span> org.json.<span class="keyword">JSONObject</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</div><div class="line"></div><div class="line"><span class="keyword">public</span> class CronetUtils &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> TAG = <span class="string">"CronetUtils"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CronetUtils sInstance;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> CronetEngine mCronetEngine;</div><div class="line">    <span class="keyword">private</span> Executor mExecutor = Executors.newCachedThreadPool();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> CronetUtilsBak() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> CronetUtilsBak getsInstance() &#123;</div><div class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</div><div class="line">            sInstance = <span class="keyword">new</span> CronetUtilsBak();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sInstance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> init(Context context) &#123;</div><div class="line">        <span class="keyword">if</span> (mCronetEngine == <span class="keyword">null</span>) &#123;</div><div class="line">            CronetEngine.Builder builder = <span class="keyword">new</span> CronetEngine.Builder(context);</div><div class="line">            builder.enableHttpCache(CronetEngine.Builder.HTTP_CACHE_IN_MEMORY,</div><div class="line">                            <span class="number">100</span> * <span class="number">1024</span>)</div><div class="line">                    .enableHttp2(<span class="keyword">true</span>)</div><div class="line">                    .enableQuic(<span class="keyword">true</span>)</div><div class="line">                    .enableSDCH(<span class="keyword">true</span>)</div><div class="line">                    .setLibraryName(<span class="string">"cronet"</span>)</div><div class="line">                    .addQuicHint(<span class="string">"www.example.org"</span>, <span class="number">32457</span>, <span class="number">32457</span>)</div><div class="line">                    .addQuicHint(<span class="string">"www.wolfcstech.com"</span>, <span class="number">443</span>, <span class="number">6121</span>)</div><div class="line">                    .addQuicHint(<span class="string">"www.wolfcstech.cn"</span>, <span class="number">443</span>, <span class="number">6121</span>)</div><div class="line">                    .addQuicHint(<span class="string">"www.wolfcstech.com"</span>, <span class="number">6121</span>, <span class="number">6121</span>)</div><div class="line">                    .addQuicHint(<span class="string">"www.wolfcstech.cn"</span>, <span class="number">6121</span>, <span class="number">6121</span>);</div><div class="line"></div><div class="line">            <span class="keyword">JSONObject</span> experimentalOptions = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">JSONObject</span> quicParams = <span class="keyword">new</span> <span class="keyword">JSONObject</span>()</div><div class="line">                        .put(<span class="string">"connection_options"</span>, <span class="string">"PACE,IW10,FOO,DEADBEEF"</span>)</div><div class="line">                        .put(<span class="string">"host_whitelist"</span>, <span class="string">"www.example.org"</span>)</div><div class="line">                        .put(<span class="string">"max_server_configs_stored_in_properties"</span>, <span class="number">2</span>)</div><div class="line">                        .put(<span class="string">"delay_tcp_race"</span>, <span class="keyword">true</span>)</div><div class="line">                        .put(<span class="string">"max_number_of_lossy_connections"</span>, <span class="number">10</span>)</div><div class="line">                        .put(<span class="string">"packet_loss_threshold"</span>, <span class="number">0.5</span>)</div><div class="line">                        .put(<span class="string">"idle_connection_timeout_seconds"</span>, <span class="number">300</span>)</div><div class="line">                        .put(<span class="string">"close_sessions_on_ip_change"</span>, <span class="keyword">false</span>)</div><div class="line">                        .put(<span class="string">"migrate_sessions_on_network_change"</span>, <span class="keyword">false</span>)</div><div class="line">                        .put(<span class="string">"migrate_sessions_early"</span>, <span class="keyword">false</span>)</div><div class="line">                        .put(<span class="string">"race_cert_verification"</span>, <span class="keyword">true</span>);</div><div class="line">                experimentalOptions = <span class="keyword">new</span> <span class="keyword">JSONObject</span>().put(<span class="string">"QUIC"</span>, quicParams);</div><div class="line">            &#125; <span class="keyword">catch</span> (JSONException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            builder.setExperimentalOptions(experimentalOptions.toString());</div><div class="line"></div><div class="line">            mCronetEngine = builder.build();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> getHtml(<span class="keyword">String</span> url, UrlRequest.Callback callback) &#123;</div><div class="line">        startWithURL(url, callback);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> startWithURL(<span class="keyword">String</span> url, UrlRequest.Callback callback) &#123;</div><div class="line">        startWithURL(url, callback, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> startWithURL(<span class="keyword">String</span> url, UrlRequest.Callback callback, <span class="keyword">String</span> postData) &#123;</div><div class="line">        UrlRequest.Builder builder = <span class="keyword">new</span> UrlRequest.Builder(url, callback, mExecutor, mCronetEngine);</div><div class="line">        applyPostDataToUrlRequestBuilder(builder, mExecutor, postData);</div><div class="line">        builder.build().start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> applyPostDataToUrlRequestBuilder(</div><div class="line">            UrlRequest.Builder builder, Executor executor, <span class="keyword">String</span> postData) &#123;</div><div class="line">        <span class="keyword">if</span> (postData != <span class="keyword">null</span> &amp;&amp; postData.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">            builder.setHttpMethod(<span class="string">"POST"</span>);</div><div class="line">            builder.addHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/x-www-form-urlencoded"</span>);</div><div class="line">            builder.setUploadDataProvider(</div><div class="line">                    UploadDataProviders.create(postData.getBytes()), executor);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>基本的过程与常规的通过 Cronet 发起 <strong><em>HTTPS</em></strong> 请求类似：</p>
<ol>
<li>创建 <code>CronetEngine</code> 对象。</li>
<li>实现 <code>UrlRequest.Callback</code> 回调，以接收请求结果。</li>
<li>发起请求。</li>
</ol>
<p>在访问 QUIC 服务时，仅有的差别在于，创建 <code>CronetEngine</code> 对象时，要注意启用 <code>QUIC</code> ，同时要调用 <code>addQuicHint()</code>，添加一些 <code>QuicHint</code>。<code>QuicHint</code> 作用于 Chromium net 的 Alternative-Service 实现，使得 Chromium net 在请求服务时，会尝试用QUIC 协议去做。</p>
<h1 id="故障排查"><a href="#故障排查" class="headerlink" title="故障排查"></a>故障排查</h1><p>如果你在运行时遇到了问题，则可以以–v=1参数运行服务器或客户端。它将提升日志的verbosity，更多的日志常常可以帮助暴露底层的问题。</p>
<h3 id="打赏"><a href="#打赏" class="headerlink" title="打赏"></a><a href="https://www.wolfcstech.com/about/donate.html">打赏</a></h3><p><a href="https://www.chromium.org/quic/playing-with-quic" target="_blank" rel="external">原文</a></p>
</div><div class="tags"><a href="/tags/网络协议/">网络协议</a><a href="/tags/QUIC/">QUIC</a><a href="/tags/翻译/">翻译</a></div><div class="post-nav"><a href="/2017/01/22/Chromium Android开发的Eclipse配置/" class="pre">Chromium Android开发的Eclipse配置</a><a href="/2017/01/13/QUIC协议规范/" class="next">QUIC协议规范</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">34</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/live555_src_analysis_play/">live555 源码分析： PLAY 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/live555_src_analysis_setup/">live555 源码分析： SETUP 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/04/live555_src_analysis_describe/">live555 源码分析： DESCRIBE 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/03/live555_src_analysis_rtspserver/">live555 源码分析：RTSPServer</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/01/live555_src_analysis_rtsp_rtp_rtcp_wireshark/">Wireshark 抓包分析 RTSP/RTP/RTCP 基本工作过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/31/live555_src_analysis_mediaserver/">live555 源码分析：MediaSever</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/30/live555_src_analysis_infrasture/">live555 源码分析：基础设施</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/28/live555_src_analysis_introduction/">live555 源码分析：简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/24/h264_send_with_ortp/">使用 ortp 发送原始 H.264 码流</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/23/h264_play/">原始 H.264 码流播放</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2017/01/17/使用QUIC/';
var disqus_title = '使用QUIC';
var disqus_url = 'https://www.wolfcstech.com/2017/01/17/使用QUIC/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>