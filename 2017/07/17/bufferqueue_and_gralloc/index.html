<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>BufferQueue 和 gralloc | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">BufferQueue 和 gralloc</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">BufferQueue 和 gralloc</h1><div class="post-meta">Jul 17, 2017<span> | </span><span class="category"><a href="/categories/Android开发/">Android开发</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/07/17/bufferqueue_and_gralloc/" href="/2017/07/17/bufferqueue_and_gralloc/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>理解 Android 图形系统，我们从场景背后的 BufferQueue 和 gralloc HAL 开始。</p>
<p>BufferQueue 类是 Android 中所有图形的核心。它的角色很简单：连接产生图形数据缓冲区的东西（<em>生产者</em>）和接受数据来显示或进一步处理的东西（<em>消费者</em>）。几乎所有在系统中移动图形数据缓冲区的东西都依赖于 BufferQueue。<br><a id="more"></a><br>gralloc 内存分配器执行缓冲区分配，且通过一个供应商特有的 HAL 接口（参考 <code>hardware/libhardware/include/hardware/gralloc.h</code>）实现。<code>alloc()</code> 期待接收的参数为 (width, height, pixel format) 及一系列使用标记（下面详述）。</p>
<h1 id="BufferQueue-生产者和消费者"><a href="#BufferQueue-生产者和消费者" class="headerlink" title="BufferQueue 生产者和消费者"></a>BufferQueue 生产者和消费者</h1><p>基本的用法很直接：生产者请求一块空闲的缓冲区 (<code>dequeueBuffer()</code>)，指定一系列特性，包括宽度，高度，像素格式，和使用标记。生产者填充缓冲区，并将它返回给队列 (<code>queueBuffer()</code>)。随后，消费者获得缓冲区(<code>acquireBuffer()</code>)  并使用缓冲区的内容。当消费者完成时，它将缓冲区返回给队列(<code>releaseBuffer()</code>)。</p>
<p>最近 Android 设备支持 <em>同步框架</em>，这使得系统可以与能够异步处理图形数据的硬件组件结合使用。比如，生产者可以提交一系列 OpenGL ES 绘制命令，然后在渲染完成之前加入输出缓冲区队列。缓冲区伴随着内容准备就绪时发出信号的栅栏。当缓冲区返回到空闲列表时，第二个栅栏随附缓冲区，因此消费者可以释放缓冲区，同时内容仍在使用中。当缓冲区移动通过系统时，这种方法可以提升延迟和吞吐量。</p>
<p>队列的一些特性，比如它可以持有的最大缓冲区数量，由生产者和消费者联合决定。然而，BufferQueue 负责根据需要分配缓冲区。除非特性改变，否则缓冲区将保留；比如，如果生产者请求了一个大小不同的缓冲区，老的缓冲区将释放，新的缓冲区将根据需要分配。</p>
<p>生产者和消费者可以位于不同的进程中。当前，消费者总是创建并拥有数据结构。在更老的版本中，只有生产者一端是 binder 化的 (比如生产者可以在一个远程进程中，但消费者必须位于队列创建的进程中)。Android 4.4 及之后的发行版采用了一个更加通用的实现。</p>
<p>BufferQueue 从来不拷贝缓冲区的内容 (像那样移动大量数据将是非常低效的)。相反，缓冲区总是通过句柄传递。</p>
<h1 id="gralloc-HAL-使用标记"><a href="#gralloc-HAL-使用标记" class="headerlink" title="gralloc HAL 使用标记"></a>gralloc HAL 使用标记</h1><p>gralloc 分配器不仅仅是另外一种在本地堆上分配内存的方式；在某些情形下，分配的内存可能不是高速缓存一致的，或者可能完全不能从用户空间访问。分配的性质由使用标记决定，这包括这样的一些属性：</p>
<ul>
<li>从软件访问内存的频率有多高 (CPU)</li>
<li>从硬件访问内存的频率有多高 (GPU)</li>
<li>内存是否会被用作 OpenGL ES (GLES) 纹理</li>
<li>内存是否会被视频编码器使用</li>
</ul>
<p>比如，如果你的格式指定 RGBA 8888 像素，然后你指出缓冲区将从软件访问 (意味着你的应用将直接接触像素)，然后分配器必须一个缓冲区，其中每像素 4 个字节，且以 R-G-B-A 的顺序。相反，如果你说缓冲区将只从硬件访问，并作为一个 GLES 纹理，分配器可以做任何 GLES 驱动想要的事情 － BGRA 顺序，非线性布局，替代颜色格式，等等。允许硬件使用它喜欢的格式可以提升性能。</p>
<p>一些值在某一平台上无法结合。比如，视频编码器标记可以请求 YUV 像素，于是添加软件访问和指定 RGBA 8888 将失败。</p>
<p>gralloc 分配器返回的句柄可以通过 Binder 在进程之间传递。</p>
<h1 id="使用systrace跟踪BufferQueue"><a href="#使用systrace跟踪BufferQueue" class="headerlink" title="使用systrace跟踪BufferQueue"></a>使用systrace跟踪BufferQueue</h1><p>要真正理解图形缓冲区如何移动，则使用 systrace。系统级的图形代码可以很好地进行探索，就像许多相关的应用程序框架代码一样。如何高效使用 systrace 的完整描述将需要一篇相当长的文档。首先启用 <code>gfx</code>，<code>view</code> 和 <code>sched</code> 标签。你也将在 trace 中看到 BufferQueues。如果你之前已经在使用 systrace 了，你可能已经看到过它们但可能不确定它们是什么。举个例子，如果你在 <a href="https://github.com/google/grafika" target="_blank" rel="external">Grafika’s</a> “Play video (SurfaceView)” 运行时获取 trace，标签为 <em> SurfaceView</em> 的行告诉你在任何给定时刻有多少缓冲区被加入队列。</p>
<p>值在应用活跃时增加 － MediaCodec 解码器触发帧的渲染 － 而在 SurfaceFlinger 工作，消费缓冲区时减小。当视频的帧率为 30 fps 时，队列的值将在 0 到 1 之间变动，因为 ~60 fps 显示可以轻松地跟踪源。(还要注意 SurfaceFlinger 只有在有工作要做时才唤醒，而不是美妙 60 次。系统努力试图避免工作，并且如果没有东西更新屏幕的话完全禁用 VSYNC。)</p>
<p>如果你切换到 Grafika’s “Play video (TextureView)” 并获取一个 trace，你将看到标签为 com.android.grafika/com.android.grafika.PlayMovieActivity 的行。这是主 UI 层，它只是另一个 BufferQueue。由于 TextureView 渲染到 UI 层 (而不是一个分离的层)，你将在这里看到所有的视频驱动的更新。</p>
<p>关于 systrace 工具的更多信息，请参考 <a href="https://developer.android.com/studio/profile/systrace-commandline.html" target="_blank" rel="external">Systrace documentation</a>。</p>
<h3 id="打赏"><a href="#打赏" class="headerlink" title="打赏"></a><a href="https://www.wolfcstech.com/about/donate.html">打赏</a></h3><p><a href="https://source.android.com/devices/graphics/arch-bq-gralloc" target="_blank" rel="external">原文</a></p>
</div><div class="tags"><a href="/tags/Android开发/">Android开发</a><a href="/tags/翻译/">翻译</a><a href="/tags/图形图像/">图形图像</a></div><div class="post-nav"><a href="/2017/07/20/qemu_build_system/" class="pre">QEMU 构建系统架构</a><a href="/2017/07/11/android-graphics-architecture/" class="next">Android 图形架构</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android-图形系统/">Android 图形系统</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/14/egl_init_drivers/">Android 图形驱动初始化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/13/opengl_on_android_with_sv/">在 Android 中使用 OpenGL</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/12/android_debug_gdb/">使用 GDB 调试 Android 应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/11/android_emulator_dev/">Android 模拟器下载、编译及调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_start_streaming/">live555 源码分析：播放启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_subsession_setup/">live555 源码分析：子会话 SETUP</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/live555_src_analysis_subsession_sdp/">live555 源码分析：子会话 SDP 行生成</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/live555_src_analysis_servermediasession/">live555 源码分析：ServerMediaSession</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/06/live555_src_analysis_rtspserver_arch/">live555 源码分析：RTSPServer 组件结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/live555_src_analysis_play/">live555 源码分析： PLAY 的处理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2017/07/17/bufferqueue_and_gralloc/';
var disqus_title = 'BufferQueue 和 gralloc';
var disqus_url = 'https://www.wolfcstech.com/2017/07/17/bufferqueue_and_gralloc/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>