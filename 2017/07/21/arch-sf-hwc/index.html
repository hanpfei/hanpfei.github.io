<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>SurfaceFlinger 和 Hardware Composer | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SurfaceFlinger 和 Hardware Composer</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">SurfaceFlinger 和 Hardware Composer</h1><div class="post-meta">Jul 21, 2017<span> | </span><span class="category"><a href="/categories/Android开发/">Android开发</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/07/21/arch-sf-hwc/" href="/2017/07/21/arch-sf-hwc/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>拥有图形数据缓冲区是很精彩的，但是当你在你的设备屏幕上看到它们时生活甚至更美好。那就是 SurfaceFlinger 和 Hardware Composer HAL 做的事情。<br><a id="more"></a></p>
<h1 id="SurfaceFlinger"><a href="#SurfaceFlinger" class="headerlink" title="SurfaceFlinger"></a>SurfaceFlinger</h1><p>SurfaceFlinger 的角色是接收来自于多个源的数据缓冲区，组合它们，并将它们发送给显示设备。曾经一段时期这是通过软将数据块传送到硬件 framebuffer (比如 /dev/graphics/fb0) 完成的，但那些日子已经过去许久了。</p>
<p>当一个应用来到前台，WindowManager 服务向 SurfaceFlinger 请求一块绘制 surface。SurfaceFlinger 创建一个 layer（其主要的组件是一个 BufferQueue），而<br> SurfaceFlinger 将作为其消费者。生产者端的 Binder 对象通过 WindowManager 被传递给应用，然后它可以开始直接向 SurfaceFlinger 发送帧。</p>
<p>注意：这一节使用 SurfaceFlinger 术语，WindowManager 使用术语 <em>window</em> 而不是 <em>layer</em>. . . 并使用 layer 表示其它一些东西。( 可以认为 SurfaceFlinger 应该被称为LayerFlinger。)</p>
<p>大多数应用于任何时间在屏幕上具有三个 layers：屏幕顶部的状态栏，底部或侧面的导航栏，以及应用程序 UI。一些应用具有更多，一些更少（比如默认的 home 应用有一个单独的壁纸 layer，而全屏游戏可能会隐藏状态栏）。每个 layer 可以被独立地更新。状态栏和导航栏由一个系统进程渲染，而应用 layers 有应用渲染，两者之间没有协调。</p>
<p>设备显示器以一定频率刷新，在手机和平板上典型的是每秒钟 60 帧。如果显示的内容在刷新中间更新，则将看到花屏；因此只在周期中间更新内容很重要。当可以安全更新内容时，系统收到来自于显示器的信号。出于历史原因我们称它为 VSYNC 信号。</p>
<p>刷新频率可能会随着时间而改变，比如依赖于当前的条件，一些设备的范围在 58 到 62fps。对于 HDMI 连接的电视机，理论上可以下降到 24 或 48Hz 来匹配视频。由于每个刷新周期我们只能更新屏幕一次，以 200 fps 提交缓冲区来显示将是巨大的浪费，因为大多数帧将从不会被看到。</p>
<p>不是在应用提交缓冲区时采取行动，SurfaceFlinger 而是在显示器为显示一些新东西做好准备时才唤醒。</p>
<p>当 VSYNC 信号到达时，SurfaceFlinger 遍历它的 layers 列表寻找新的缓冲区。如果它找到了一个新的，它获取它；如果没有，它继续使用之前获取的缓冲区。SurfaceFlinger 总是想要一些东西来显示，因此它会挂在一个缓冲区上。如果没有缓冲区已经提交给一个 layer，则该 layer 被忽略。</p>
<p>在 SurfaceFlinger 收集了所有可见的 layers 的缓冲区之后，它询问 Hardware Composer 应该如何执行组合。</p>
<h1 id="Hardware-Composer"><a href="#Hardware-Composer" class="headerlink" title="Hardware Composer"></a>Hardware Composer</h1><p>Hardware Composer HAL (HWC) 在 Android 3.0 中被引入，并已经稳定发展多年。它的主要目标是通过可用硬件确定组合缓冲区的最有效方式。作为 HAL，其实现是特定于设备的，且通常由显示设备硬件 OEM 完成。</p>
<p>当考虑 <em>覆盖平面(overlay planes)</em> 时，这种方法的价值很容易识别，其目的是在显示硬件而不是 GPU 中将多个缓冲区组合在一起。比如，考虑一个典型的竖直方向的 Android 手机，其状态栏在顶部，导航栏在底部，应用内容在其余的地方。每个 layers 的内容在单独的缓冲区中。你可以使用下列方法中的一种处理组合：</p>
<ul>
<li><p>将应用内容渲染到暂存缓冲区中，然后将状态栏渲染在它的上面，导航栏位于其上，最后将暂存缓冲区传递给显示硬件。</p>
</li>
<li><p>将所有三个缓冲区传递给显示硬件，并告诉它从不同的缓冲区为不同的屏幕部分读取数据。</p>
</li>
</ul>
<p>后一种方法可以显着提高效率。</p>
<p>显示处理器功能差异很大。overlays 的数量，layers 是否可以旋转或混合，以及位置和重叠上的限制，可能非常难以通过一个 API 来描述。HWC 试图通过一系列的决定容纳这些多样性：</p>
<ol>
<li><p>SurfaceFlinger 为 HWC 提供完整的 layers 的列表并询问，“你想要如何处理它？”。</p>
</li>
<li><p>HWC 通过将每个 layer 标记为 overlay 或 GLES composition 来进行响应。</p>
</li>
<li><p>SurfaceFlinger 关心任何 GLES composition，并把输出缓冲区传给 HWC，让 HWC 处理其余的事情。</p>
</li>
</ol>
<p>由于硬件供应商可以定制或裁剪决定作出的代码，因此可以从每个设备中获得最佳性能。</p>
<p>当屏幕上的东西没有改变时，overlay 平面可能比 GL composition 更低效。当 overlay 内容具有透明像素且覆盖的 layers 被混合在一起时尤其如此。在这种情况下，HWC 可以选择为一些或所有 layers 请求 GLES composition 并保留组合的缓冲区。如果 SurfaceFlinger 回来请求组合相同的缓冲区集合，HWC 可以继续展示之前组合好的临时缓冲区。这可以提升空闲的设备的电池续航能力。</p>
<p>运行 Android 4.4 及更新版本的设备典型地支持四个 overlay 平面。试图组合比 overlays 更多的 layers 会导致系统为它们中的一些使用 GLES composition，这意味着一个应用使用的 layers 的数量可能对电源消耗和性能有着重大的影响。</p>
<h1 id="虚拟显示器"><a href="#虚拟显示器" class="headerlink" title="虚拟显示器"></a>虚拟显示器</h1><p>SurfaceFlinger 支持一个主显示器（比如手机或平板内置的东西），一个外部显示器（比如通过 HDMI 连接的电视机），以及一个或多个使组合后的输出在系统中可用的虚拟显示器。虚拟显示器可用于记录屏幕或通过网络发送。</p>
<p>虚拟显示器可以共享主显示器相同的 layers 集合（layer 栈）或拥有它们自己的集合。虚拟显示器没有 VSYNC，因此主显示器的 VSYNC 用于触发所有显示器的组合<br> (composition) 。</p>
<p>在老版本的 Android 中，虚拟显示器总是通过 GLES 组合，而 Hardware Composer 只管理主显示器的组合。在 Android 4.4 中，Hardware Composer 获得了参与虚拟显示器组合的能力。</p>
<p>如你期待的那样，为一个虚拟显示器产生的帧被写入 BufferQueue。</p>
<h1 id="案例研究：screenrecord"><a href="#案例研究：screenrecord" class="headerlink" title="案例研究：screenrecord"></a>案例研究：screenrecord</h1><p><a href="https://android.googlesource.com/platform/frameworks/av/+/marshmallow-release/cmds/screenrecord/" target="_blank" rel="external">screenrecord 命令</a> 允许你将屏幕上出现的所有东西记录为磁盘上的 .mp4 文件。为了实现它，我们不得不从 SurfaceFlinger 接收组合之后的帧，将它们写入视频编码器，然后将编码的视频数据写入一个文件。视频编解码由一个单独的进程 (mediaserver) 管理，因此我们不得不在系统中移动巨大的图形缓冲区。使这件事情更具挑战性的是，我们还要试图以全解析度记录 60fps 的视频。使这件事情高效工作的关键是 BufferQueue。</p>
<p>MediaCodec 类允许一个应用以缓冲区中的原始字节提供数据，或通过一个 <a href="https://source.android.com/devices/graphics/arch-sh.html" target="_blank" rel="external">Surface</a>。当 screenrecord 请求访问一个视频编码器时，mediaserver 创建一个 BufferQueue，将它自己与消费者一端相连，然后将生产者端作为一个 Surface 传回给 screenrecord。</p>
<p>screenrecord 命令然后请求 SurfaceFlinger 创建一个镜像主显示器的虚拟显示器 (比如它具有所有相同的 layers)，然后指示它将输出发送给来自于 mediaserver 的 Surface。在这种情况下，SurfaceFlinger 是缓冲区的生产者而不是消费者。</p>
<p>配置完成之后，screenrecord 等待编码的数据出现。随着应用的绘制，它们的缓冲区进入 SurfaceFlinger，SurfaceFlinger 将它们组合为一个单独的缓冲区并直接发送给 mediaserver 中的视频编码器。screenrecord 进程甚至从来不会看到完整的帧。在内部，mediaserver 有着它自己的移动缓冲区的方式，即通过句柄传递数据，以最小化开销。</p>
<h1 id="案例研究：模拟二次显示"><a href="#案例研究：模拟二次显示" class="headerlink" title="案例研究：模拟二次显示"></a>案例研究：模拟二次显示</h1><p>WindowManager 可以请求 SurfaceFlinger 创建一个可见的 layer，其中 SurfaceFlinger 作为 BufferQueue 的消费者。它还可以请求 SurfaceFlinger 创建一个虚拟显示器，其中 SurfaceFlinger 作为 BufferQueue 的生产者。如果你将它们连接到一起会如何呢，配置一个虚拟显示器显示渲染到一个可见 layer 的东西？</p>
<p>你创建了一个闭环，其中组合后的屏幕出现在一个窗口中。然后窗口现在是组合后的输出的一部分了，因此在下一次刷新窗口内组合后的图像将也显示窗口的内容（然后 <a href="https://en.wikipedia.org/wiki/Turtles_all_the_way_down" target="_blank" rel="external">海龟下面还是海龟一路下来</a>）。为了看到这种行为，启用设置中的 <a href="http://developer.android.com/tools/index.html" target="_blank" rel="external">Developer options</a>，选择 <strong>Simulate secondary displays</strong>，并启用一个窗口。为了加分，请使用 screenrecord 捕获启用显示的行为，然后逐帧播放。 </p>
<h3 id="打赏"><a href="#打赏" class="headerlink" title="打赏"></a><a href="https://www.wolfcstech.com/about/donate.html">打赏</a></h3><p><a href="https://source.android.com/devices/graphics/arch-sf-hwc" target="_blank" rel="external">原文</a></p>
</div><div class="tags"><a href="/tags/Android开发/">Android开发</a><a href="/tags/翻译/">翻译</a><a href="/tags/图形图像/">图形图像</a></div><div class="post-nav"><a href="/2017/07/21/arch-sh/" class="pre">Surface 和 SurfaceHolder</a><a href="/2017/07/20/hikey960_android_build/" class="next">HiKey960 开发板 android 编译</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">34</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/04/live555_src_analysis_describe/">live555 源码分析： DESCRIBE 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/01/live555_src_analysis_rtsp_rtp_rtcp_wireshark/">Wireshark 抓包分析 RTSP/RTP/RTCP 基本工作过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/01/live555_src_analysis_rtspserver/">live555 源码分析：RTSPServer</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/31/live555_src_analysis_mediaserver/">live555 源码分析：MediaSever</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/30/live555_src_analysis_infrasture/">live555 源码分析：基础设施</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/24/h264_send_with_ortp/">使用 ortp 发送原始 H.264 码流</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/23/h264_play/">原始 H.264 码流播放</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/18/h264_on_rtp/">H.264 视频的 RTP 载荷格式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/12/working/">从工作中得到了什么？</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/03/sdp/">会话描述协议</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2017/07/21/arch-sf-hwc/';
var disqus_title = 'SurfaceFlinger 和 Hardware Composer';
var disqus_url = 'https://www.wolfcstech.com/2017/07/21/arch-sf-hwc/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>