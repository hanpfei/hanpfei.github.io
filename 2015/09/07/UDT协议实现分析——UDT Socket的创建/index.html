<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>UDT协议实现分析——UDT Socket的创建 | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">UDT协议实现分析——UDT Socket的创建</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">UDT协议实现分析——UDT Socket的创建</h1><div class="post-meta">Sep 7, 2015<span> | </span><span class="category"><a href="/categories/网络协议/">网络协议</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2015/09/07/UDT协议实现分析——UDT Socket的创建/" href="/2015/09/07/UDT协议实现分析——UDT Socket的创建/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h1 id="UDT-API的用法"><a href="#UDT-API的用法" class="headerlink" title="UDT API的用法"></a>UDT API的用法</h1><p>在分析 连接的建立过程 之前，先来看一下UDT API的用法。在UDT网络中，通常要有一个UDT Server监听在某台机器的某个UDP端口上，等待客户端的连接；有一个或多个客户端连接UDT Server；UDT Server接收到来自客户端的连接请求后，创建另外一个单独的UDT Socket用于与该客户端进行通信。<br><a id="more"></a><br>先来看一下UDT Server的简单的实现，UDT的开发者已经提供了一些demo程序可供参考，位于app/目录下。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;udt.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span>* <span class="title">recvdata</span><span class="params">(<span class="keyword">void</span>*)</span></span>;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> UDTUpDown &#123;</div><div class="line">    UDTUpDown() &#123;</div><div class="line">        <span class="comment">// use this function to initialize the UDT library</span></div><div class="line">        UDT::startup();</div><div class="line">    &#125;</div><div class="line">    ~UDTUpDown() &#123;</div><div class="line">        <span class="comment">// use this function to release the UDT library</span></div><div class="line">        UDT::cleanup();</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((<span class="number">1</span> != argc) &amp;&amp; ((<span class="number">2</span> != argc) || (<span class="number">0</span> == atoi(argv[<span class="number">1</span>])))) &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"usage: appserver [server_port]"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Automatically start up and clean up UDT module.</span></div><div class="line">    UDTUpDown _udt_;</div><div class="line"></div><div class="line">    addrinfo hints;</div><div class="line">    addrinfo* res;</div><div class="line"></div><div class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> addrinfo));</div><div class="line"></div><div class="line">    hints.ai_flags = AI_PASSIVE;</div><div class="line">    hints.ai_family = AF_INET;</div><div class="line">    hints.ai_socktype = SOCK_STREAM;</div><div class="line">    <span class="comment">//hints.ai_socktype = SOCK_DGRAM;</span></div><div class="line"></div><div class="line">    <span class="function"><span class="built_in">string</span> <span class="title">service</span><span class="params">(<span class="string">"9000"</span>)</span></span>;</div><div class="line">    <span class="keyword">if</span> (<span class="number">2</span> == argc)</div><div class="line">        service = argv[<span class="number">1</span>];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> != getaddrinfo(<span class="literal">NULL</span>, service.c_str(), &amp;hints, &amp;res)) &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"illegal port number or port is busy.\n"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    UDTSOCKET serv = UDT::socket(res-&gt;ai_family, res-&gt;ai_socktype, res-&gt;ai_protocol);</div><div class="line"></div><div class="line">    <span class="comment">// UDT Options</span></div><div class="line">    <span class="comment">//UDT::setsockopt(serv, 0, UDT_CC, new CCCFactory&lt;CUDPBlast&gt;, sizeof(CCCFactory&lt;CUDPBlast&gt;));</span></div><div class="line">    <span class="comment">//UDT::setsockopt(serv, 0, UDT_MSS, new int(9000), sizeof(int));</span></div><div class="line">    <span class="comment">//UDT::setsockopt(serv, 0, UDT_RCVBUF, new int(10000000), sizeof(int));</span></div><div class="line">    <span class="comment">//UDT::setsockopt(serv, 0, UDP_RCVBUF, new int(10000000), sizeof(int));</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (UDT::ERROR == UDT::bind(serv, res-&gt;ai_addr, res-&gt;ai_addrlen)) &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"bind: "</span> &lt;&lt; UDT::getlasterror().getErrorMessage() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    freeaddrinfo(res);</div><div class="line"></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"server is ready at port: "</span> &lt;&lt; service &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (UDT::ERROR == UDT::listen(serv, <span class="number">10</span>)) &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"listen: "</span> &lt;&lt; UDT::getlasterror().getErrorMessage() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sockaddr_storage clientaddr;</div><div class="line">    <span class="keyword">int</span> addrlen = <span class="keyword">sizeof</span>(clientaddr);</div><div class="line"></div><div class="line">    UDTSOCKET recver;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (UDT::INVALID_SOCK == (recver = UDT::accept(serv, (sockaddr*) &amp;clientaddr, &amp;addrlen))) &#123;</div><div class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"accept: "</span> &lt;&lt; UDT::getlasterror().getErrorMessage() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">char</span> clienthost[NI_MAXHOST];</div><div class="line">        <span class="keyword">char</span> clientservice[NI_MAXSERV];</div><div class="line">        getnameinfo((sockaddr *) &amp;clientaddr, addrlen, clienthost, <span class="keyword">sizeof</span>(clienthost), clientservice,</div><div class="line">                    <span class="keyword">sizeof</span>(clientservice), NI_NUMERICHOST | NI_NUMERICSERV);</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"new connection: "</span> &lt;&lt; clienthost &lt;&lt; <span class="string">":"</span> &lt;&lt; clientservice &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">        <span class="keyword">pthread_t</span> rcvthread;</div><div class="line">        pthread_create(&amp;rcvthread, <span class="literal">NULL</span>, recvdata, <span class="keyword">new</span> UDTSOCKET(recver));</div><div class="line">        pthread_detach(rcvthread);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    UDT::close(serv);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span>* <span class="title">recvdata</span><span class="params">(<span class="keyword">void</span>* usocket)</span> </span>&#123;</div><div class="line">    UDTSOCKET recver = *(UDTSOCKET*) usocket;</div><div class="line">    <span class="keyword">delete</span> (UDTSOCKET*) usocket;</div><div class="line"></div><div class="line">    <span class="keyword">char</span>* data;</div><div class="line">    <span class="keyword">int</span> size = <span class="number">100000</span>;</div><div class="line">    data = <span class="keyword">new</span> <span class="keyword">char</span>[size];</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">        <span class="keyword">int</span> rsize = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> rs;</div><div class="line">        <span class="keyword">while</span> (rsize &lt; size) &#123;</div><div class="line">            <span class="keyword">int</span> rcv_size;</div><div class="line">            <span class="keyword">int</span> var_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</div><div class="line">            UDT::getsockopt(recver, <span class="number">0</span>, UDT_RCVDATA, &amp;rcv_size, &amp;var_size);</div><div class="line">            <span class="keyword">if</span> (UDT::ERROR == (rs = UDT::recv(recver, data + rsize, size - rsize, <span class="number">0</span>))) &#123;</div><div class="line">                <span class="built_in">cout</span> &lt;&lt; <span class="string">"recv:"</span> &lt;&lt; UDT::getlasterror().getErrorMessage() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            rsize += rs;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (rsize &lt; size)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">delete</span>[] data;</div><div class="line"></div><div class="line">    UDT::close(recver);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>如在  <a href="http://my.oschina.net/wolfcs/blog/501896" target="_blank" rel="external">UDT协议实现分析——UDT初始化和销毁</a>  一文中提到的， 在调用任何UDT API之前，需要首先调用UDT::startup()来对库做一个初始化，并在结束之后执行UDT::cleanup()做最后的清理。在这个示例中，是创建了一个helper类UDTUpDown来帮助做这些事情的。利用编程语言本身提供的构造-析够机制来对UDT进行初始化和销毁要比手动调用这些函数要可靠得多。</li>
<li>获得本地UDP端口的网络地址。</li>
<li>调用UDT::socket()函数创建一个UDT Socket。这个Socket是UDT抽象出来的一个逻辑的Socket，我们并不能利用这个Socket本身来收发数据。</li>
<li>调用UDT::bind()将创建的UDT Socket绑定到本地端口的网络地址。这一步将会把UDT的逻辑Socket与能够进行数据收发的系统UDP socket进行关联，自此我们就可以利用UDT Socket进行收发数据了。</li>
<li>调用UDT::listen()告诉UDT，把这个UDT Socket做为这个端口上的Listening Socket。一个UDP端口可以被多个UDT Socket复用，在调用UDT::listen()之后，UDT就知道，在有其它节点连接这个UDP端口时，需要把相关的连接请求消息发送到哪个UDT Socket的接收缓冲区了。<br>对绑定到相同UDP端口的多个不同UDT Socket调用UDT::listen()时，UDT是如何处理的？我们知道，一个UDP端口上最多只能有一个listening Socket。</li>
<li>调用UDT::accept()函数等待其它节点的连接。其它节点连接时，这个函数返回另外一个单独的UDT Socket，以用于与发起连接的节点进行通信。<br>UDT::accept()函数返回的UDT Socket会被绑定到另外的一个不同的UDP端口，还是会被绑定到listening Socket所绑定的UDP端口？</li>
<li>使用UDT::accept()返回的UDT Socket，利用UDT::recv()与UDT::send()等函数同发起连接的节点进行数据传输。</li>
<li>在不再需要UDT Socket时，调用UDT::close()函数关掉它，以释放资源。<br>然后再来看下UDT Client的实现：</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;udt.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span>* <span class="title">monitor</span><span class="params">(<span class="keyword">void</span>*)</span></span>;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> UDTUpDown &#123;</div><div class="line">    UDTUpDown() &#123;</div><div class="line">        <span class="comment">// use this function to initialize the UDT library</span></div><div class="line">        UDT::startup();</div><div class="line">    &#125;</div><div class="line">    ~UDTUpDown() &#123;</div><div class="line">        <span class="comment">// use this function to release the UDT library</span></div><div class="line">        UDT::cleanup();</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((<span class="number">3</span> != argc) || (<span class="number">0</span> == atoi(argv[<span class="number">2</span>]))) &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"usage: appclient server_ip server_port"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Automatically start up and clean up UDT module.</span></div><div class="line">    UDTUpDown _udt_;</div><div class="line"></div><div class="line">    <span class="keyword">struct</span> addrinfo hints, *local, *peer;</div><div class="line"></div><div class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> addrinfo));</div><div class="line"></div><div class="line">    hints.ai_flags = AI_PASSIVE;</div><div class="line">    hints.ai_family = AF_INET;</div><div class="line">    hints.ai_socktype = SOCK_STREAM;</div><div class="line">    <span class="comment">//hints.ai_socktype = SOCK_DGRAM;</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> != getaddrinfo(<span class="literal">NULL</span>, <span class="string">"9000"</span>, &amp;hints, &amp;local)) &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"incorrect network address.\n"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    UDTSOCKET client = UDT::socket(local-&gt;ai_family, local-&gt;ai_socktype, local-&gt;ai_protocol);</div><div class="line"></div><div class="line">    <span class="comment">// UDT Options</span></div><div class="line">    <span class="comment">//UDT::setsockopt(client, 0, UDT_CC, new CCCFactory&lt;CUDPBlast&gt;, sizeof(CCCFactory&lt;CUDPBlast&gt;));</span></div><div class="line">    <span class="comment">//UDT::setsockopt(client, 0, UDT_MSS, new int(9000), sizeof(int));</span></div><div class="line">    <span class="comment">//UDT::setsockopt(client, 0, UDT_SNDBUF, new int(10000000), sizeof(int));</span></div><div class="line">    <span class="comment">//UDT::setsockopt(client, 0, UDP_SNDBUF, new int(10000000), sizeof(int));</span></div><div class="line">    <span class="comment">//UDT::setsockopt(client, 0, UDT_MAXBW, new int64_t(12500000), sizeof(int));</span></div><div class="line"></div><div class="line">    <span class="comment">// for rendezvous connection, enable the code below</span></div><div class="line">    <span class="comment">/*</span></div><div class="line">     UDT::setsockopt(client, 0, UDT_RENDEZVOUS, new bool(true), sizeof(bool));</div><div class="line">     if (UDT::ERROR == UDT::bind(client, local-&gt;ai_addr, local-&gt;ai_addrlen))</div><div class="line">     &#123;</div><div class="line">     cout &lt;&lt; "bind: " &lt;&lt; UDT::getlasterror().getErrorMessage() &lt;&lt; endl;</div><div class="line">     return 0;</div><div class="line">     &#125;</div><div class="line">     */</div><div class="line"></div><div class="line">    freeaddrinfo(local);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> != getaddrinfo(argv[<span class="number">1</span>], argv[<span class="number">2</span>], &amp;hints, &amp;peer)) &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"incorrect server/peer address. "</span> &lt;&lt; argv[<span class="number">1</span>] &lt;&lt; <span class="string">":"</span> &lt;&lt; argv[<span class="number">2</span>] &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// connect to the server, implict bind</span></div><div class="line">    <span class="keyword">if</span> (UDT::ERROR == UDT::connect(client, peer-&gt;ai_addr, peer-&gt;ai_addrlen)) &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"connect: "</span> &lt;&lt; UDT::getlasterror().getErrorMessage() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    freeaddrinfo(peer);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> size = <span class="number">100000</span>;</div><div class="line">    <span class="keyword">char</span>* data = <span class="keyword">new</span> <span class="keyword">char</span>[size];</div><div class="line"></div><div class="line">    pthread_create(<span class="keyword">new</span> <span class="keyword">pthread_t</span>, <span class="literal">NULL</span>, monitor, &amp;client);</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</div><div class="line">        <span class="keyword">int</span> ssize = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> ss;</div><div class="line">        <span class="keyword">while</span> (ssize &lt; size) &#123;</div><div class="line">            <span class="keyword">if</span> (UDT::ERROR == (ss = UDT::send(client, data + ssize, size - ssize, <span class="number">0</span>))) &#123;</div><div class="line">                <span class="built_in">cout</span> &lt;&lt; <span class="string">"send:"</span> &lt;&lt; UDT::getlasterror().getErrorMessage() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ssize += ss;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ssize &lt; size)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    UDT::close(client);</div><div class="line">    <span class="keyword">delete</span>[] data;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span>* <span class="title">monitor</span><span class="params">(<span class="keyword">void</span>* s)</span> </span>&#123;</div><div class="line">    UDTSOCKET u = *(UDTSOCKET*) s;</div><div class="line">    UDT::TRACEINFO perf;</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"SendRate(Mb/s)\tRTT(ms)\tCWnd\tPktSndPeriod(us)\tRecvACK\tRecvNAK"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">        <span class="keyword">if</span> (UDT::ERROR == UDT::perfmon(u, &amp;perf)) &#123;</div><div class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"perfmon: "</span> &lt;&lt; UDT::getlasterror().getErrorMessage() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="built_in">cout</span> &lt;&lt; perf.mbpsSendRate &lt;&lt; <span class="string">"\t\t"</span> &lt;&lt; perf.msRTT &lt;&lt; <span class="string">"\t"</span> &lt;&lt; perf.pktCongestionWindow &lt;&lt; <span class="string">"\t"</span></div><div class="line">             &lt;&lt; perf.usPktSndPeriod &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; perf.pktRecvACK &lt;&lt; <span class="string">"\t"</span> &lt;&lt; perf.pktRecvNAK &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到UDT Client连接UDT Server并发送数据的过程大体如下：</p>
<ol>
<li><p>同样需要在调用任何UDT API之前，先调用UDT::startup()来对库做初始化，并在结束之后执行UDT::cleanup()做最后的清理。这里同样使用helper类UDTUpDown来帮助做这些事情。</p>
</li>
<li><p>获得UDT Server的网络地址。</p>
</li>
<li><p>调用UDT::socket()函数创建一个UDT Socket。这个Socket可以与特定的本地地址绑定，也可以不绑定。如果绑定，则发送数据时的出口地址就是该端口，如果不绑定，出口地址则是一个不确定的值。</p>
</li>
<li><p>调用UDT::connect()连接UDT Server。</p>
</li>
<li><p>使用UDT Socket，利用UDT::recv()与UDT::send()等函数同UDT Server进行数据传输。</p>
</li>
<li><p>在不再需要UDT Socket时，调用UDT::close()函数关掉它，以释放资源。</p>
</li>
</ol>
<p>UDT基本的收发数据的API的用法大体如上面所示。接着我们来看，这些函数是如何实现的。</p>
<h1 id="UDT-Socket的创建"><a href="#UDT-Socket的创建" class="headerlink" title="UDT Socket的创建"></a>UDT Socket的创建</h1><p>无论是UDT Server要listening，还是UDT client要连接UDT Server，在调用UDT::startup()初始化UDT之后，首先要做的事情都是调用UDT::socket()创建UDT Socket了。我们就来看一下创建UDT Socket的过程：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">UDTSOCKET CUDTUnited::newSocket(<span class="keyword">int</span> af, <span class="keyword">int</span> type) &#123;</div><div class="line">    <span class="keyword">if</span> ((type != SOCK_STREAM) &amp;&amp; (type != SOCK_DGRAM))</div><div class="line">        <span class="keyword">throw</span> CUDTException(<span class="number">5</span>, <span class="number">3</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">    CUDTSocket* ns = <span class="keyword">NULL</span>;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        ns = <span class="keyword">new</span> CUDTSocket;</div><div class="line">        ns-&gt;m_pUDT = <span class="keyword">new</span> CUDT;</div><div class="line">        <span class="keyword">if</span> (AF_INET == af) &#123;</div><div class="line">            ns-&gt;m_pSelfAddr = (sockaddr*) (<span class="keyword">new</span> sockaddr_in);</div><div class="line">            ((sockaddr_in*) (ns-&gt;m_pSelfAddr))-&gt;sin_port = <span class="number">0</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ns-&gt;m_pSelfAddr = (sockaddr*) (<span class="keyword">new</span> sockaddr_in6);</div><div class="line">            ((sockaddr_in6*) (ns-&gt;m_pSelfAddr))-&gt;sin6_port = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (...) &#123;</div><div class="line">        delete ns;</div><div class="line">        <span class="keyword">throw</span> CUDTException(<span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    CGuard::enterCS(m_IDLock);</div><div class="line">    ns-&gt;m_SocketID = --m_SocketID;</div><div class="line">    CGuard::leaveCS(m_IDLock);</div><div class="line"></div><div class="line">    ns-&gt;m_Status = INIT;</div><div class="line">    ns-&gt;m_ListenSocket = <span class="number">0</span>;</div><div class="line">    ns-&gt;m_pUDT-&gt;m_SocketID = ns-&gt;m_SocketID;</div><div class="line">    ns-&gt;m_pUDT-&gt;m_iSockType = (SOCK_STREAM == type) ? UDT_STREAM : UDT_DGRAM;</div><div class="line">    ns-&gt;m_pUDT-&gt;m_iIPversion = ns-&gt;m_iIPversion = af;</div><div class="line">    ns-&gt;m_pUDT-&gt;m_pCache = m_pCache;</div><div class="line"></div><div class="line">    <span class="comment">// protect the m_Sockets structure.</span></div><div class="line">    CGuard::enterCS(m_ControlLock);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        m_Sockets[ns-&gt;m_SocketID] = ns;</div><div class="line">    &#125; <span class="keyword">catch</span> (...) &#123;</div><div class="line">        <span class="comment">//failure and rollback</span></div><div class="line">        CGuard::leaveCS(m_ControlLock);</div><div class="line">        delete ns;</div><div class="line">        ns = <span class="keyword">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    CGuard::leaveCS(m_ControlLock);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">NULL</span> == ns)</div><div class="line">        <span class="keyword">throw</span> CUDTException(<span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ns-&gt;m_SocketID;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">UDTSOCKET CUDT::socket(<span class="keyword">int</span> af, <span class="keyword">int</span> type, <span class="keyword">int</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (!s_UDTUnited.m_bGCStatus)</div><div class="line">        s_UDTUnited.startup();</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> s_UDTUnited.newSocket(af, type);</div><div class="line">    &#125; <span class="keyword">catch</span> (CUDTException&amp; e) &#123;</div><div class="line">        s_UDTUnited.setError(<span class="keyword">new</span> CUDTException(e));</div><div class="line">        <span class="keyword">return</span> INVALID_SOCK;</div><div class="line">    &#125; <span class="keyword">catch</span> (bad_alloc&amp;) &#123;</div><div class="line">        s_UDTUnited.setError(<span class="keyword">new</span> CUDTException(<span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>));</div><div class="line">        <span class="keyword">return</span> INVALID_SOCK;</div><div class="line">    &#125; <span class="keyword">catch</span> (...) &#123;</div><div class="line">        s_UDTUnited.setError(<span class="keyword">new</span> CUDTException(<span class="number">-1</span>, <span class="number">0</span>, <span class="number">0</span>));</div><div class="line">        <span class="keyword">return</span> INVALID_SOCK;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">UDTSOCKET socket(<span class="keyword">int</span> af, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol) &#123;</div><div class="line">    <span class="keyword">return</span> CUDT::socket(af, type, protocol);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用流程为，UDT::socket() -&gt; CUDT::socket() -&gt; CUDTUnited::newSocket()。</p>
<p>在CUDT::socket()中，我们看到，它会首先检查s_UDTUnited.m_bGCStatus，若发现UDT还没有初始化完成的话，则会调用s_UDTUnited.startup()进行初始化。这个地方对UDT状态s_UDTUnited.m_bGCStatus的检查没有问题，但在发现UDT没有初始化完成时调用s_UDTUnited.startup()似乎并不恰当。这个地方调用了s_UDTUnited.startup()，那与这次调用相对应的cleanup()又在哪调用了呢？显然在UDT内部是没有。若是调用cleanup()的职责总是在UDT的使用者，那倒不如在这个地方返回错误给调用者，完全让调用者来管理UDT的生命周期，以尽可能地避免资源泄漏。</p>
<p>创建UDT Socket的工作实际都在CUDTUnited::newSocket()函数中完成。可以看到，在这个函数中主要做了如下的这样一些事情：</p>
<ol>
<li>创建一个CUDTSocket对象ns，并创建一个CUDT对象被ns-&gt;m_pUDT引用。初始化ns对象的Self网络地址，端口会被设置为0。在UDT中使用CUDTSocket和CUDT共同来描述一个Socket。每个UDT Socket都会有其相应的CUDTSocket对象和CUDT对象。</li>
</ol>
<p>可以看一下CUDTSocket类的定义，来了解它都描述了UDT Socket的哪些属性(src/api.h)：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> CUDTSocket &#123;</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">    CUDTSocket();</div><div class="line">    ~CUDTSocket();</div><div class="line"></div><div class="line">    UDTSTATUS m_Status;                       <span class="comment">// current socket state</span></div><div class="line"></div><div class="line">    <span class="keyword">uint64_t</span> m_TimeStamp;                     <span class="comment">// time when the socket is closed</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> m_iIPversion;                         <span class="comment">// IP version</span></div><div class="line">    sockaddr* m_pSelfAddr;                    <span class="comment">// pointer to the local address of the socket</span></div><div class="line">    sockaddr* m_pPeerAddr;                    <span class="comment">// pointer to the peer address of the socket</span></div><div class="line"></div><div class="line">    UDTSOCKET m_SocketID;                     <span class="comment">// socket ID</span></div><div class="line">    UDTSOCKET m_ListenSocket;                 <span class="comment">// ID of the listener socket; 0 means this is an independent socket</span></div><div class="line"></div><div class="line">    UDTSOCKET m_PeerID;                       <span class="comment">// peer socket ID</span></div><div class="line">    <span class="keyword">int32_t</span> m_iISN;                      <span class="comment">// initial sequence number, used to tell different connection from same IP:port</span></div><div class="line"></div><div class="line">    CUDT* m_pUDT;                             <span class="comment">// pointer to the UDT entity</span></div><div class="line"></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">set</span>&lt;UDTSOCKET&gt;* m_pQueuedSockets;    <span class="comment">// set of connections waiting for accept()</span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">set</span>&lt;UDTSOCKET&gt;* m_pAcceptSockets;    <span class="comment">// set of accept()ed connections</span></div><div class="line"></div><div class="line">    <span class="keyword">pthread_cond_t</span> m_AcceptCond;              <span class="comment">// used to block "accept" call</span></div><div class="line">    <span class="keyword">pthread_mutex_t</span> m_AcceptLock;             <span class="comment">// mutex associated to m_AcceptCond</span></div><div class="line"></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> m_uiBackLog;                 <span class="comment">// maximum number of connections in queue</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> m_iMuxID;                             <span class="comment">// multiplexer ID</span></div><div class="line"></div><div class="line">    <span class="keyword">pthread_mutex_t</span> m_ControlLock;            <span class="comment">// lock this socket exclusively for control APIs: bind/listen/connect</span></div><div class="line"></div><div class="line"> <span class="keyword">private</span>:</div><div class="line">    CUDTSocket(<span class="keyword">const</span> CUDTSocket&amp;);</div><div class="line">    CUDTSocket&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> CUDTSocket&amp;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>这个类只提供了构造和析构两个成员函数。还声明了私有的copy构造函数和赋值操作符函数，但没有定义它们，以避免类对象的复制。</p>
<p>可以再来看一下CUDTSocket的构造函数实现(src/api.h)：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">CUDTSocket::CUDTSocket()</div><div class="line">        : m_Status(INIT),</div><div class="line">          m_TimeStamp(<span class="number">0</span>),</div><div class="line">          m_iIPversion(<span class="number">0</span>),</div><div class="line">          m_pSelfAddr(<span class="literal">NULL</span>),</div><div class="line">          m_pPeerAddr(<span class="literal">NULL</span>),</div><div class="line">          m_SocketID(<span class="number">0</span>),</div><div class="line">          m_ListenSocket(<span class="number">0</span>),</div><div class="line">          m_PeerID(<span class="number">0</span>),</div><div class="line">          m_iISN(<span class="number">0</span>),</div><div class="line">          m_pUDT(<span class="literal">NULL</span>),</div><div class="line">          m_pQueuedSockets(<span class="literal">NULL</span>),</div><div class="line">          m_pAcceptSockets(<span class="literal">NULL</span>),</div><div class="line">          m_AcceptCond(),</div><div class="line">          m_AcceptLock(),</div><div class="line">          m_uiBackLog(<span class="number">0</span>),</div><div class="line">          m_iMuxID(<span class="number">-1</span>) &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> WIN32</span></div><div class="line">    pthread_mutex_init(&amp;m_AcceptLock, <span class="literal">NULL</span>);</div><div class="line">    pthread_cond_init(&amp;m_AcceptCond, <span class="literal">NULL</span>);</div><div class="line">    pthread_mutex_init(&amp;m_ControlLock, <span class="literal">NULL</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    m_AcceptLock = CreateMutex(<span class="literal">NULL</span>, <span class="literal">false</span>, <span class="literal">NULL</span>);</div><div class="line">    m_AcceptCond = CreateEvent(<span class="literal">NULL</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">NULL</span>);</div><div class="line">    m_ControlLock = CreateMutex(<span class="literal">NULL</span>, <span class="literal">false</span>, <span class="literal">NULL</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>特别注意m_Status的初始化，该值被初始化为了INIT。从状态机的角度来看CUDTSocket，在它刚被new出来时，它处于INIT状态。</p>
<p>CUDT类有两个主要的职责，一是描述UDT Socket，包括所有的非静态成员变量和非静态成员函数，定义UDT Socket的大部分属性和所能提供操作；二是提供API，包括绝大部分的static成员函数，这些函数将调用者与UDT内部的实现连接起来。CUDT类这样的设计，明显违背了OO的SRP单一职责原则，这多少还是给代码的阅读带来了一定的障碍。再来看一下CUDT的构造函数实现(src/core.cpp)：<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">CUDT::CUDT() &#123;</div><div class="line">    <span class="attr">m_pSndBuffer</span> = NULL;</div><div class="line">    <span class="attr">m_pRcvBuffer</span> = NULL;</div><div class="line">    <span class="attr">m_pSndLossList</span> = NULL;</div><div class="line">    <span class="attr">m_pRcvLossList</span> = NULL;</div><div class="line">    <span class="attr">m_pACKWindow</span> = NULL;</div><div class="line">    <span class="attr">m_pSndTimeWindow</span> = NULL;</div><div class="line">    <span class="attr">m_pRcvTimeWindow</span> = NULL;</div><div class="line"></div><div class="line">    <span class="attr">m_pSndQueue</span> = NULL;</div><div class="line">    <span class="attr">m_pRcvQueue</span> = NULL;</div><div class="line">    <span class="attr">m_pPeerAddr</span> = NULL;</div><div class="line">    <span class="attr">m_pSNode</span> = NULL;</div><div class="line">    <span class="attr">m_pRNode</span> = NULL;</div><div class="line"></div><div class="line">    // Initilize mutex <span class="literal">and</span> condition variables</div><div class="line">    initSynch();</div><div class="line"></div><div class="line">    // Default UDT configurations</div><div class="line">    <span class="attr">m_iMSS</span> = <span class="number">1500</span>;</div><div class="line">    <span class="attr">m_bSynSending</span> = <span class="literal">true</span>;</div><div class="line">    <span class="attr">m_bSynRecving</span> = <span class="literal">true</span>;</div><div class="line">    <span class="attr">m_iFlightFlagSize</span> = <span class="number">25600</span>;</div><div class="line">    <span class="attr">m_iSndBufSize</span> = <span class="number">8192</span>;</div><div class="line">    <span class="attr">m_iRcvBufSize</span> = <span class="number">8192</span>;  //Rcv buffer MUST NOT be bigger than Flight Flag size</div><div class="line">    m_Linger.<span class="attr">l_onoff</span> = <span class="number">1</span>;</div><div class="line">    m_Linger.<span class="attr">l_linger</span> = <span class="number">180</span>;</div><div class="line">    <span class="attr">m_iUDPSndBufSize</span> = <span class="number">65536</span>;</div><div class="line">    <span class="attr">m_iUDPRcvBufSize</span> = m_iRcvBufSize * m_iMSS;</div><div class="line">    <span class="attr">m_iSockType</span> = UDT_STREAM;</div><div class="line">    <span class="attr">m_iIPversion</span> = AF_INET;</div><div class="line">    <span class="attr">m_bRendezvous</span> = <span class="literal">false</span>;</div><div class="line">    <span class="attr">m_iSndTimeOut</span> = -<span class="number">1</span>;</div><div class="line">    <span class="attr">m_iRcvTimeOut</span> = -<span class="number">1</span>;</div><div class="line">    <span class="attr">m_bReuseAddr</span> = <span class="literal">true</span>;</div><div class="line">    <span class="attr">m_llMaxBW</span> = -<span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="attr">m_pCCFactory</span> = new CCCFactory&lt;CUDTCC&gt;;</div><div class="line">    <span class="attr">m_pCC</span> = NULL;</div><div class="line">    <span class="attr">m_pCache</span> = NULL;</div><div class="line"></div><div class="line">    // Initial status</div><div class="line">    <span class="attr">m_bOpened</span> = <span class="literal">false</span>;</div><div class="line">    <span class="attr">m_bListening</span> = <span class="literal">false</span>;</div><div class="line">    <span class="attr">m_bConnecting</span> = <span class="literal">false</span>;</div><div class="line">    <span class="attr">m_bConnected</span> = <span class="literal">false</span>;</div><div class="line">    <span class="attr">m_bClosing</span> = <span class="literal">false</span>;</div><div class="line">    <span class="attr">m_bShutdown</span> = <span class="literal">false</span>;</div><div class="line">    <span class="attr">m_bBroken</span> = <span class="literal">false</span>;</div><div class="line">    <span class="attr">m_bPeerHealth</span> = <span class="literal">true</span>;</div><div class="line">    <span class="attr">m_ullLingerExpiration</span> = <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void CUDT::initSynch() &#123;</div><div class="line"><span class="comment">#ifndef WIN32</span></div><div class="line">    pthread_mutex_init(&amp;m_SendBlockLock, NULL);</div><div class="line">    pthread_cond_init(&amp;m_SendBlockCond, NULL);</div><div class="line">    pthread_mutex_init(&amp;m_RecvDataLock, NULL);</div><div class="line">    pthread_cond_init(&amp;m_RecvDataCond, NULL);</div><div class="line">    pthread_mutex_init(&amp;m_SendLock, NULL);</div><div class="line">    pthread_mutex_init(&amp;m_RecvLock, NULL);</div><div class="line">    pthread_mutex_init(&amp;m_AckLock, NULL);</div><div class="line">    pthread_mutex_init(&amp;m_ConnectionLock, NULL);</div><div class="line"><span class="comment">#else</span></div><div class="line">    <span class="attr">m_SendBlockLock</span> = CreateMutex(NULL, <span class="literal">false</span>, NULL);</div><div class="line">    <span class="attr">m_SendBlockCond</span> = CreateEvent(NULL, <span class="literal">false</span>, <span class="literal">false</span>, NULL);</div><div class="line">    <span class="attr">m_RecvDataLock</span> = CreateMutex(NULL, <span class="literal">false</span>, NULL);</div><div class="line">    <span class="attr">m_RecvDataCond</span> = CreateEvent(NULL, <span class="literal">false</span>, <span class="literal">false</span>, NULL);</div><div class="line">    <span class="attr">m_SendLock</span> = CreateMutex(NULL, <span class="literal">false</span>, NULL);</div><div class="line">    <span class="attr">m_RecvLock</span> = CreateMutex(NULL, <span class="literal">false</span>, NULL);</div><div class="line">    <span class="attr">m_AckLock</span> = CreateMutex(NULL, <span class="literal">false</span>, NULL);</div><div class="line">    <span class="attr">m_ConnectionLock</span> = CreateMutex(NULL, <span class="literal">false</span>, NULL);</div><div class="line"><span class="comment">#endif</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>都是成员变量的初始化，后续再来详细了解这些成员变量的作用。</p>
<ol>
<li>为Socket分配SocketID，其值为CUDTUnited的m_SocketID递减的结果。m_SocketID在CUDTUnited的构造函数中初始化：</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">CUDTUnited::CUDTUnited()</div><div class="line">        : m_Sockets(),</div><div class="line">          m_ControlLock(),</div><div class="line">          m_IDLock(),</div><div class="line">          m_SocketID(<span class="number">0</span>),</div><div class="line">          m_TLSError(),</div><div class="line">          m_mMultiplexer(),</div><div class="line">          m_MultiplexerLock(),</div><div class="line">          m_pCache(<span class="literal">NULL</span>),</div><div class="line">          m_bClosing(<span class="literal">false</span>),</div><div class="line">          m_GCStopLock(),</div><div class="line">          m_GCStopCond(),</div><div class="line">          m_InitLock(),</div><div class="line">          m_iInstanceCount(<span class="number">0</span>),</div><div class="line">          m_bGCStatus(<span class="literal">false</span>),</div><div class="line">          m_GCThread(),</div><div class="line">          m_ClosedSockets() &#123;</div><div class="line">    <span class="comment">// Socket ID MUST start from a random value</span></div><div class="line">    srand((<span class="keyword">unsigned</span> <span class="keyword">int</span>) CTimer::getTime());</div><div class="line">    m_SocketID = <span class="number">1</span> + (<span class="keyword">int</span>) ((<span class="number">1</span> &lt;&lt; <span class="number">30</span>) * (<span class="keyword">double</span>(rand()) / RAND_MAX));</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> WIN32</span></div><div class="line">    pthread_mutex_init(&amp;m_ControlLock, <span class="literal">NULL</span>);</div><div class="line">    pthread_mutex_init(&amp;m_IDLock, <span class="literal">NULL</span>);</div><div class="line">    pthread_mutex_init(&amp;m_InitLock, <span class="literal">NULL</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    m_ControlLock = CreateMutex(<span class="literal">NULL</span>, <span class="literal">false</span>, <span class="literal">NULL</span>);</div><div class="line">    m_IDLock = CreateMutex(<span class="literal">NULL</span>, <span class="literal">false</span>, <span class="literal">NULL</span>);</div><div class="line">    m_InitLock = CreateMutex(<span class="literal">NULL</span>, <span class="literal">false</span>, <span class="literal">NULL</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> WIN32</span></div><div class="line">    pthread_key_create(&amp;m_TLSError, TLSDestroy);</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    m_TLSError = TlsAlloc();</div><div class="line">    m_TLSLock = CreateMutex(<span class="literal">NULL</span>, <span class="literal">false</span>, <span class="literal">NULL</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    m_pCache = <span class="keyword">new</span> CCache&lt;CInfoBlock&gt;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>m_SocketID的初始值是一个随机数。</p>
<ol>
<li><p>初始化ns及它的CUDT对象的一些成员变量。特别注意ns-&gt;m_Status的赋值，这里该值被赋为了INIT。从状态机的角度来看待CUDTSocket，在执行UDT Socket创建结束执行时，它处于INIT状态下。</p>
</li>
<li><p>将ns放在std::map<udtsocket, cudtsocket*=""> m_Sockets中。</udtsocket,></p>
</li>
<li><p>将UDT socket的SocketID返回给调用者。</p>
</li>
</ol>
<p>这个接口直接返回一个表示UDT Socket的类对象，而不是一个handle，以便于调用者在调用UDT API时无需每次都输入UDT Socket handle参数，这样的API设计相对于UDT的这种API设计，有什么样的优缺点？</p>
<h1 id="UDT的错误处理机制"><a href="#UDT的错误处理机制" class="headerlink" title="UDT的错误处理机制"></a>UDT的错误处理机制</h1><p>在前面UDT Server和UDT Client的demo程序中，我们有看到，所有的UDT API都会在出错时返回一个错误码，比如UDT::bind()、UDT::bind2()、UDT::listen()和UDT::connect()等返回值类型为int的函数，在出错时返回UDT::ERROR，UDT::socket()和UDT::accept()等返回值类型为UDTSOCKET的函数在出错时返回UDT::INVALID_SOCK。</p>
<p>UDT API的调用者在检测到它们返回了错误值时，通过调用UDT::getlasterror()函数来获取关于异常更加详细的信息。这里我们就来看一下这套机制的实现。</p>
<p>注意看CUDT::socket()函数的实现。在这个函数中，会将实际创建UDT Socket的任务委托给s_UDTUnited.newSocket()，但这个调用会被包在一个try-catch块中。在s_UDTUnited.newSocket()函数执行的过程中发生任何的异常，都会先被CUDT::socket()捕获。CUDT::socket()函数在捕获这些异常之后，会根据捕获的异常的类型创建不同的CUDTException对象，并通过调用CUDTUnited::setError()函数将该CUDTException对象设置给s_UDTUnited。</p>
<p>我们来看一下CUDTUnited::setError()函数的实现(src/api.cpp)：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CUDTUnited::setError(CUDTException* e) &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> WIN32</span></div><div class="line">    <span class="keyword">delete</span> (CUDTException*) pthread_getspecific(m_TLSError);</div><div class="line">    pthread_setspecific(m_TLSError, e);</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="function">CGuard <span class="title">tg</span><span class="params">(m_TLSLock)</span></span>;</div><div class="line">    <span class="keyword">delete</span> (CUDTException*)TlsGetValue(m_TLSError);</div><div class="line">    TlsSetValue(m_TLSError, e);</div><div class="line">    m_mTLSRecord[GetCurrentThreadId()] = e;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这个函数中，会首先取出线程局部存储变量m_TLSError中保存的本线程上一次创建的 CUDTException对象，将其delete掉，并将本次创建的CUDTException对象设置进去。CUDTUnited类定义中m_TLSError的声明(src/api.h)：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="keyword">pthread_key_t</span> m_TLSError;                         <span class="comment">// thread local error record (last error)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> WIN32</span></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TLSDestroy</span><span class="params">(<span class="keyword">void</span>* e)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != e)</div><div class="line">            <span class="keyword">delete</span> (CUDTException*) e;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">map</span>&lt;DWORD, CUDTException*&gt; m_mTLSRecord;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">checkTLSValue</span><span class="params">()</span></span>;</div><div class="line">    <span class="keyword">pthread_mutex_t</span> m_TLSLock;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p>在CUDTUnited构造函数中也可以看到对这个对象的初始化。 CUDTUnited::TLSDestroy()函数是m_TLSError的析构函数，在m_TLSError最后被销毁时，这个函数被调用，以便于释放搜有还未释放的资源。</p>
<p>再来看UDT API的调用者获取上一次发生的异常的函数UDT::getlasterror()：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">CUDTException* CUDTUnited::getError() &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> WIN32</span></div><div class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == pthread_getspecific(m_TLSError))</div><div class="line">        pthread_setspecific(m_TLSError, <span class="keyword">new</span> CUDTException);</div><div class="line">    <span class="keyword">return</span> (CUDTException*) pthread_getspecific(m_TLSError);</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="function">CGuard <span class="title">tg</span><span class="params">(m_TLSLock)</span></span>;</div><div class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == TlsGetValue(m_TLSError))</div><div class="line">    &#123;</div><div class="line">        CUDTException* e = <span class="keyword">new</span> CUDTException;</div><div class="line">        TlsSetValue(m_TLSError, e);</div><div class="line">        m_mTLSRecord[GetCurrentThreadId()] = e;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (CUDTException*)TlsGetValue(m_TLSError);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line">CUDTException&amp; CUDT::getlasterror() &#123;</div><div class="line">    <span class="keyword">return</span> *s_UDTUnited.getError();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">ERRORINFO&amp; <span class="title">getlasterror</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> CUDT::getlasterror();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用过程为UDT::getlasterror() -&gt; CUDT::getlasterror() -&gt; CUDTUnited::getError()。</p>
<p>主要就是从s_UDTUnited的线程局部存储变量m_TLSError中取出前面设置的本线程上次创建的CUDTException对象返回给调用者。</p>
<p>总结一下，UDT的使用者在调用UDT API时，UDT API会直接调用CUDT类对应的static API函数，在CUDT类的这些static API函数中会将做实际事情的工作委托给s_UDTUnited的相应函数，但这个委托调用会被包在一个try-catch block中。s_UDTUnited的函数在遇到异常情况时抛出异常，CUDT类的static API函数捕获异常，根据捕获到的异常的具体类型，创建不同的CUDTException对象设置给s_UDTUnited的线程局部存储变量m_TLSError中并向UDT API调用者返回错误码，UDT API的调用者检测到错误码后，通过UDT::getlasterror()获取存储在m_TLSError中的异常。</p>
<p>此处可以看到，CUDT提供的这一层API，一个比较重要的作用大概就是做异常处理了。</p>
<p>在UDT中，使用CUDTException来描述所有出现的异常。可以看一下这个类的定义(src/udt.h)：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> UDT_API CUDTException &#123;</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">    CUDTException(<span class="keyword">int</span> major = <span class="number">0</span>, <span class="keyword">int</span> minor = <span class="number">0</span>, <span class="keyword">int</span> err = <span class="number">-1</span>);</div><div class="line">    CUDTException(<span class="keyword">const</span> CUDTException&amp; e);</div><div class="line">    <span class="keyword">virtual</span> ~CUDTException();</div><div class="line"></div><div class="line">    <span class="comment">// Functionality:</span></div><div class="line">    <span class="comment">//    Get the description of the exception.</span></div><div class="line">    <span class="comment">// Parameters:</span></div><div class="line">    <span class="comment">//    None.</span></div><div class="line">    <span class="comment">// Returned value:</span></div><div class="line">    <span class="comment">//    Text message for the exception description.</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">getErrorMessage</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// Functionality:</span></div><div class="line">    <span class="comment">//    Get the system errno for the exception.</span></div><div class="line">    <span class="comment">// Parameters:</span></div><div class="line">    <span class="comment">//    None.</span></div><div class="line">    <span class="comment">// Returned value:</span></div><div class="line">    <span class="comment">//    errno.</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">getErrorCode</span><span class="params">()</span> <span class="keyword">const</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// Functionality:</span></div><div class="line">    <span class="comment">//    Clear the error code.</span></div><div class="line">    <span class="comment">// Parameters:</span></div><div class="line">    <span class="comment">//    None.</span></div><div class="line">    <span class="comment">// Returned value:</span></div><div class="line">    <span class="comment">//    None.</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"> <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">int</span> m_iMajor;        <span class="comment">// major exception categories</span></div><div class="line"></div><div class="line"><span class="comment">// 0: correct condition</span></div><div class="line"><span class="comment">// 1: network setup exception</span></div><div class="line"><span class="comment">// 2: network connection broken</span></div><div class="line"><span class="comment">// 3: memory exception</span></div><div class="line"><span class="comment">// 4: file exception</span></div><div class="line"><span class="comment">// 5: method not supported</span></div><div class="line"><span class="comment">// 6+: undefined error</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> m_iMinor;		<span class="comment">// for specific error reasons</span></div><div class="line">    <span class="keyword">int</span> m_iErrno;		<span class="comment">// errno returned by the system if there is any</span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> m_strMsg;	<span class="comment">// text error message</span></div><div class="line"></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> m_strAPI;	<span class="comment">// the name of UDT function that returns the error</span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> m_strDebug;  <span class="comment">// debug information, set to the original place that causes the error</span></div><div class="line"></div><div class="line"> <span class="keyword">public</span>:</div><div class="line">    <span class="comment">// Error Code</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> SUCCESS;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ECONNSETUP;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ENOSERVER;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ECONNREJ;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ESOCKFAIL;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ESECFAIL;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ECONNFAIL;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ECONNLOST;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ENOCONN;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ERESOURCE;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ETHREAD;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ENOBUF;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EFILE;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EINVRDOFF;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ERDPERM;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EINVWROFF;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EWRPERM;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EINVOP;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EBOUNDSOCK;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ECONNSOCK;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EINVPARAM;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EINVSOCK;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EUNBOUNDSOCK;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ENOLISTEN;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ERDVNOSERV;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ERDVUNBOUND;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ESTREAMILL;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EDGRAMILL;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EDUPLISTEN;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ELARGEMSG;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EINVPOLLID;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EASYNCFAIL;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EASYNCSND;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EASYNCRCV;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> ETIMEOUT;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EPEERERR;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> EUNKNOWN;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>这个class主要通过Major错误码和Minor错误码来描述异常情况，如果是调用系统调用出错了，还会用Errno值。</p>
<p>具体看一下这个class的实现，特别是CUDTException::getErrorMessage()函数，来了解每一个错误码所代表的含义：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div></pre></td><td class="code"><pre><div class="line">CUDTException::CUDTException(<span class="keyword">int</span> major, <span class="keyword">int</span> minor, <span class="keyword">int</span> err)</div><div class="line">        : m_iMajor(major),</div><div class="line">          m_iMinor(minor) &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == err)</div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> WIN32</span></div><div class="line">        m_iErrno = errno;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">        m_iErrno = GetLastError();</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">        <span class="keyword">else</span></div><div class="line">        m_iErrno = err;</div><div class="line">&#125;</div><div class="line"></div><div class="line">CUDTException::CUDTException(<span class="keyword">const</span> CUDTException&amp; e)</div><div class="line">        : m_iMajor(e.m_iMajor),</div><div class="line">          m_iMinor(e.m_iMinor),</div><div class="line">          m_iErrno(e.m_iErrno),</div><div class="line">          m_strMsg() &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">CUDTException::~CUDTException() &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span>* CUDTException::getErrorMessage() &#123;</div><div class="line">    <span class="comment">// translate "Major:Minor" code into text message.</span></div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (m_iMajor) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">            m_strMsg = <span class="string">"Success"</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">            m_strMsg = <span class="string">"Connection setup failure"</span>;</div><div class="line"></div><div class="line">            <span class="keyword">switch</span> (m_iMinor) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    m_strMsg += <span class="string">": connection time out"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    m_strMsg += <span class="string">": connection rejected"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">                    m_strMsg += <span class="string">": unable to create/configure UDP socket"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">4</span>:</div><div class="line">                    m_strMsg += <span class="string">": abort for security reasons"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">            <span class="keyword">switch</span> (m_iMinor) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    m_strMsg = <span class="string">"Connection was broken"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    m_strMsg = <span class="string">"Connection does not exist"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">            m_strMsg = <span class="string">"System resource failure"</span>;</div><div class="line"></div><div class="line">            <span class="keyword">switch</span> (m_iMinor) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    m_strMsg += <span class="string">": unable to create new threads"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    m_strMsg += <span class="string">": unable to allocate buffers"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="number">4</span>:</div><div class="line">            m_strMsg = <span class="string">"File system failure"</span>;</div><div class="line"></div><div class="line">            <span class="keyword">switch</span> (m_iMinor) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    m_strMsg += <span class="string">": cannot seek read position"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    m_strMsg += <span class="string">": failure in read"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">                    m_strMsg += <span class="string">": cannot seek write position"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">4</span>:</div><div class="line">                    m_strMsg += <span class="string">": failure in write"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="number">5</span>:</div><div class="line">            m_strMsg = <span class="string">"Operation not supported"</span>;</div><div class="line"></div><div class="line">            <span class="keyword">switch</span> (m_iMinor) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    m_strMsg += <span class="string">": Cannot do this operation on a BOUND socket"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    m_strMsg += <span class="string">": Cannot do this operation on a CONNECTED socket"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">                    m_strMsg += <span class="string">": Bad parameters"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">4</span>:</div><div class="line">                    m_strMsg += <span class="string">": Invalid socket ID"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">5</span>:</div><div class="line">                    m_strMsg += <span class="string">": Cannot do this operation on an UNBOUND socket"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">6</span>:</div><div class="line">                    m_strMsg += <span class="string">": Socket is not in listening state"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">7</span>:</div><div class="line">                    m_strMsg += <span class="string">": Listen/accept is not supported in rendezous connection setup"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">8</span>:</div><div class="line">                    m_strMsg += <span class="string">": Cannot call connect on UNBOUND socket in rendezvous connection setup"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">9</span>:</div><div class="line">                    m_strMsg += <span class="string">": This operation is not supported in SOCK_STREAM mode"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">10</span>:</div><div class="line">                    m_strMsg += <span class="string">": This operation is not supported in SOCK_DGRAM mode"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">11</span>:</div><div class="line">                    m_strMsg += <span class="string">": Another socket is already listening on the same port"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">12</span>:</div><div class="line">                    m_strMsg += <span class="string">": Message is too large to send (it must be less than the UDT send buffer size)"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">13</span>:</div><div class="line">                    m_strMsg += <span class="string">": Invalid epoll ID"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="number">6</span>:</div><div class="line">            m_strMsg = <span class="string">"Non-blocking call failure"</span>;</div><div class="line"></div><div class="line">            <span class="keyword">switch</span> (m_iMinor) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    m_strMsg += <span class="string">": no buffer available for sending"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    m_strMsg += <span class="string">": no data available for reading"</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="number">7</span>:</div><div class="line">            m_strMsg = <span class="string">"The peer side has signalled an error"</span>;</div><div class="line"></div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            m_strMsg = <span class="string">"Unknown error"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Adding "errno" information</span></div><div class="line">    <span class="keyword">if</span> ((<span class="number">0</span> != m_iMajor) &amp;&amp; (<span class="number">0</span> &lt; m_iErrno)) &#123;</div><div class="line">        m_strMsg += <span class="string">": "</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> WIN32</span></div><div class="line">        <span class="keyword">char</span> errmsg[<span class="number">1024</span>];</div><div class="line">        <span class="keyword">if</span> (strerror_r(m_iErrno, errmsg, <span class="number">1024</span>) == <span class="number">0</span>)</div><div class="line">            m_strMsg += errmsg;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">        LPVOID lpMsgBuf;</div><div class="line">        FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_IGNORE_INSERTS, <span class="literal">NULL</span>, m_iErrno, MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), (LPTSTR)&amp;lpMsgBuf, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">        m_strMsg += (<span class="keyword">char</span>*)lpMsgBuf;</div><div class="line">        LocalFree(lpMsgBuf);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// period</span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> WIN32</span></div><div class="line">    m_strMsg += <span class="string">"."</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> m_strMsg.c_str();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> CUDTException::getErrorCode() <span class="keyword">const</span> &#123;</div><div class="line">    <span class="keyword">return</span> m_iMajor * <span class="number">1000</span> + m_iMinor;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CUDTException::clear() &#123;</div><div class="line">    m_iMajor = <span class="number">0</span>;</div><div class="line">    m_iMinor = <span class="number">0</span>;</div><div class="line">    m_iErrno = <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::SUCCESS = <span class="number">0</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ECONNSETUP = <span class="number">1000</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ENOSERVER = <span class="number">1001</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ECONNREJ = <span class="number">1002</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ESOCKFAIL = <span class="number">1003</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ESECFAIL = <span class="number">1004</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ECONNFAIL = <span class="number">2000</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ECONNLOST = <span class="number">2001</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ENOCONN = <span class="number">2002</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ERESOURCE = <span class="number">3000</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ETHREAD = <span class="number">3001</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ENOBUF = <span class="number">3002</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EFILE = <span class="number">4000</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EINVRDOFF = <span class="number">4001</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ERDPERM = <span class="number">4002</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EINVWROFF = <span class="number">4003</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EWRPERM = <span class="number">4004</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EINVOP = <span class="number">5000</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EBOUNDSOCK = <span class="number">5001</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ECONNSOCK = <span class="number">5002</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EINVPARAM = <span class="number">5003</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EINVSOCK = <span class="number">5004</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EUNBOUNDSOCK = <span class="number">5005</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ENOLISTEN = <span class="number">5006</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ERDVNOSERV = <span class="number">5007</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ERDVUNBOUND = <span class="number">5008</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ESTREAMILL = <span class="number">5009</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EDGRAMILL = <span class="number">5010</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EDUPLISTEN = <span class="number">5011</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ELARGEMSG = <span class="number">5012</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EINVPOLLID = <span class="number">5013</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EASYNCFAIL = <span class="number">6000</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EASYNCSND = <span class="number">6001</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EASYNCRCV = <span class="number">6002</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::ETIMEOUT = <span class="number">6003</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EPEERERR = <span class="number">7000</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> CUDTException::EUNKNOWN = <span class="number">-1</span>;</div></pre></td></tr></table></figure></p>
<p>Done。</p>
</div><div class="tags"><a href="/tags/网络协议/">网络协议</a><a href="/tags/源码分析/">源码分析</a><a href="/tags/UDT/">UDT</a></div><div class="post-nav"><a href="/2015/09/09/UDT协议实现分析——bind、listen与accept/" class="pre">UDT协议实现分析——bind、listen与accept</a><a href="/2015/09/06/UDT协议实现分析——UDT初始化和销毁/" class="next">UDT协议实现分析——UDT初始化和销毁</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android-图形系统/">Android 图形系统</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/15/egl_context_creation/">EGL Context 创建</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/14/egl_init_drivers/">Android 图形驱动初始化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/13/opengl_on_android_with_sv/">在 Android 中使用 OpenGL</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/12/android_debug_gdb/">使用 GDB 调试 Android 应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/11/android_emulator_dev/">Android 模拟器下载、编译及调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_start_streaming/">live555 源码分析：播放启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_subsession_setup/">live555 源码分析：子会话 SETUP</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/live555_src_analysis_subsession_sdp/">live555 源码分析：子会话 SDP 行生成</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/live555_src_analysis_servermediasession/">live555 源码分析：ServerMediaSession</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/06/live555_src_analysis_rtspserver_arch/">live555 源码分析：RTSPServer 组件结构</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2015/09/07/UDT协议实现分析——UDT Socket的创建/';
var disqus_title = 'UDT协议实现分析——UDT Socket的创建';
var disqus_url = 'https://www.wolfcstech.com/2015/09/07/UDT协议实现分析——UDT Socket的创建/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>