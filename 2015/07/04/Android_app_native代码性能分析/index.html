<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Android app native代码性能分析 | WolfcsTech</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.2.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.2.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android app native代码性能分析</h1><a id="logo" href="/.">WolfcsTech</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Android app native代码性能分析</h1><div class="post-meta">Jul 4, 2015<span> | </span><span class="category"><a href="/categories/Android开发/">Android开发</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2015/07/04/Android_app_native代码性能分析/" href="/2015/07/04/Android_app_native代码性能分析/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>分析我们app中native层的C/C++代码性能，能够方便我们找出其中的性能瓶颈，并在稍后做有针对性的优化。</p>
<h1 id="下载android-ndk-profiler"><a href="#下载android-ndk-profiler" class="headerlink" title="下载android-ndk-profiler"></a>下载android-ndk-profiler</h1><p>工欲善其事，必先利其器，我们先要有良好的工具来支持我们做性能分析的愿望。android-ndk-profiler就是目前我们可用的比较好的工具。原来这个项目是托管在google的代码托管服务器的，<a href="https://code.google.com/p/android-ndk-profiler/" target="_blank" rel="external">地址</a>，但现在它已经被迁移到gihub。访问原来的地址时，会自动地被重定向到github上，<a href="https://github.com/richq/android-ndk-profiler" target="_blank" rel="external">地址</a>。这样也好，倒省掉我们这些天朝子民翻墙的麻烦了。<br><a id="more"></a><br>我们可以到<strong>github</strong>去下载android ndk profiler。可以下载master branch的zip压缩包，也可以把整个项目直接git clone下来，git clone下来可能要更好一点。这个项目的目录结构大体如下(2015-06-25这天的版本)：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">hanpfei@hanpfei-ThundeRobot:~/android-ndk-profiler_repo$ ls -al</div><div class="line">总用量 84</div><div class="line">drwxrwxr-x  7 hanpfei hanpfei  4096  6月 25 11:26 .</div><div class="line">drwxr-xr-x 54 hanpfei hanpfei  4096  6月 25 11:27 ..</div><div class="line">-<span class="ruby">rw-rw-r--  <span class="number">1</span> hanpfei hanpfei <span class="number">35147</span>  <span class="number">6</span>月 <span class="number">24</span> <span class="number">19</span><span class="symbol">:</span><span class="number">29</span> COPYING</span></div><div class="line">drwxrwxr-x  2 hanpfei hanpfei  4096  6月 24 19:29 docs</div><div class="line">drwxrwxr-x  3 hanpfei hanpfei  4096  6月 25 11:26 example</div><div class="line">drwxrwxr-x  8 hanpfei hanpfei  4096  6月 25 11:26 .git</div><div class="line">-<span class="ruby">rw-rw-r--  <span class="number">1</span> hanpfei hanpfei   <span class="number">365</span>  <span class="number">6</span>月 <span class="number">24</span> <span class="number">19</span><span class="symbol">:</span><span class="number">29</span> .gitignore</span></div><div class="line">drwxrwxr-x  2 hanpfei hanpfei  4096  6月 25 11:26 jni</div><div class="line">-<span class="ruby">rw-rw-r--  <span class="number">1</span> hanpfei hanpfei   <span class="number">974</span>  <span class="number">6</span>月 <span class="number">24</span> <span class="number">19</span><span class="symbol">:</span><span class="number">29</span> Makefile</span></div><div class="line">-<span class="ruby">rw-rw-r--  <span class="number">1</span> hanpfei hanpfei   <span class="number">122</span>  <span class="number">6</span>月 <span class="number">25</span> <span class="number">11</span><span class="symbol">:</span><span class="number">26</span> ndk-excludes.txt</span></div><div class="line">-<span class="ruby">rw-rw-r--  <span class="number">1</span> hanpfei hanpfei   <span class="number">791</span>  <span class="number">6</span>月 <span class="number">24</span> <span class="number">19</span><span class="symbol">:</span><span class="number">29</span> README.mkd</span></div><div class="line">drwxrwxr-x  2 hanpfei hanpfei  4096  6月 24 19:29 test</div><div class="line">-<span class="ruby">rw-rw-r--  <span class="number">1</span> hanpfei hanpfei   <span class="number">643</span>  <span class="number">6</span>月 <span class="number">25</span> <span class="number">11</span><span class="symbol">:</span><span class="number">26</span> .travis.yml</span></div></pre></td></tr></table></figure></p>
<p>这个项目中提供的例子、文档什么的，可以参考一下。但真正需要被集成到我们项目里的就只有jni目录下面的那些。</p>
<p>我们把jni目录拷贝到另外一个地方，并重命名为android-ndk-profiler，比如：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hanpfei<span class="meta">@hanpfei</span>-<span class="string">ThundeRobot:</span><span class="regexp">~/android-ndk-profiler_repo$ cp -r jni ../</span>android-ndk-profiler</div></pre></td></tr></table></figure></p>
<p>后面我们会再来说明为什么要这么做。</p>
<h1 id="修改项目jni目录下的Android-mk文件，加载android-ndk-profiler"><a href="#修改项目jni目录下的Android-mk文件，加载android-ndk-profiler" class="headerlink" title="修改项目jni目录下的Android.mk文件，加载android-ndk-profiler"></a>修改项目jni目录下的Android.mk文件，加载android-ndk-profiler</h1><p>将android-ndk-profiler集成进我们项目的第一步，就是修改jni目录下的Android.mk文加载android-ndk-profiler了：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># compile with profiling</span></div><div class="line">LOCAL_CFLAGS <span class="symbol">:</span>= -pg</div><div class="line"></div><div class="line">LOCAL_STATIC_LIBRARIES <span class="symbol">:</span>= android-ndk-profiler</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># at the end of Android.mk</span></div><div class="line">$(call import-<span class="class"><span class="keyword">module</span>,<span class="title">android</span>-<span class="title">ndk</span>-<span class="title">profiler</span>)</span></div></pre></td></tr></table></figure></p>
<p>如果项目的编译还需要其它的flag，则把应该把”-pg”加在LOCAL_CFLAGS行的最后面，或者在适当的位置加一行，使用+=语法来添加这个flag，比如：<br><figure class="highlight fix"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">LOCAL_CFLAGS +</span>=<span class="string"> -pg -DP2P_PROFILING</span></div></pre></td></tr></table></figure></p>
<p><strong><em>-pg</em></strong>是gcc的调试选项，它们会将profiling信息加入到最终生成的二进制代码中，profiling信息包含了更多的调试信息。</p>
<p>LOCAL_STATIC_LIBRARIES的值需要与android-ndk-profiler的Android.mk文件中定义的LOCAL_MODULE值对应，$(call import-module,android-ndk-profiler)这一行中，call import-module为Android编译系统的内置命令，而android-ndk-profiler则要与项目的目录名对应，这也就是上面我们为什么要把jni目录copy，重命名为android-ndk-profiler的原因。</p>
<h1 id="设置NDK-MODULE-PATH环境变量"><a href="#设置NDK-MODULE-PATH环境变量" class="headerlink" title="设置NDK_MODULE_PATH环境变量"></a>设置NDK_MODULE_PATH环境变量</h1><p>到目前为止，我们的项目都还无法编译通过。我们还需要设置NDK_MODULE_PATH环境变量。我们可以用export命令来设置这个环境变量，也可以将这个设置放在ndk-build命令中完成，而这个环境变量的值是android-ndk-profiler的父目录。比如，我们刚刚将android-ndk-profiler的jni目录拷贝到了用户根目录下的android-ndk-profiler目录，那么这个环境变量就应该被设置为～，即我们的用户根目录。</p>
<p>对于Eclipse环境，可以这样来设置：在Package Explorer中，鼠标选中项目，右键单击弹出菜单，Propertities -&gt; C/C++ Build -&gt; Build command，在最后加上NDK_MODULE_PATH=~。比如像下面这样：<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ndk-build <span class="attr">NDK_DEBUG=1</span> <span class="attr">NDK_MODULE_PATH=~</span></div></pre></td></tr></table></figure></p>
<p>如果没有做这样的设置的话，编译时会报错，由Eclipse的Console我们可以看到这样的报错信息：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/dev_tools/</span>android-ndk-r9d/ndk-build NDK_DEBUG=<span class="number">1</span> </div><div class="line">Android <span class="string">NDK:</span> jni/Android.<span class="string">mk:</span> Cannot find module with tag <span class="string">'android-ndk-profiler'</span> <span class="keyword">in</span> <span class="keyword">import</span> path    </div><div class="line">jni/Android.<span class="string">mk:</span><span class="number">101</span>: *** Android <span class="string">NDK:</span> Aborting.    .  Stop.</div><div class="line">Android <span class="string">NDK:</span> Are you sure your NDK_MODULE_PATH variable is properly defined ?    </div><div class="line">Android NDK: The following directories were <span class="string">searched:</span>    </div><div class="line">Android <span class="string">NDK:</span></div></pre></td></tr></table></figure></p>
<h1 id="ucontext-t类型的定义"><a href="#ucontext-t类型的定义" class="headerlink" title="ucontext_t类型的定义"></a>ucontext_t类型的定义</h1><p>很不幸，在我们正确地设置了NDK_MODULE_PATH环境变量之后，还是无法通过编译。Eclipse Console中的报错信息如下：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">**** Build of configuration Default <span class="keyword">for</span> project peerTester_udt ****</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/dev_tools/</span>android-ndk-r9d/ndk-build NDK_DEBUG=<span class="number">1</span> NDK_MODULE_PATH=~ </div><div class="line">[armeabi-v7a] Gdbserver      : [arm-linux-androideabi<span class="number">-4.6</span>] libs<span class="regexp">/armeabi-v7a/</span>gdbserver</div><div class="line">[armeabi-v7a] Gdbsetup       : libs<span class="regexp">/armeabi-v7a/</span>gdb.setup</div><div class="line">[armeabi-v7a] Compile thumb  : android-ndk-profiler &lt;= prof.c</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/android-ndk-profiler/</span>prof.<span class="string">c:</span> In function <span class="string">'histogram_bin_incr'</span>:</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/android-ndk-profiler/</span>prof.<span class="string">c:</span><span class="number">150</span>:<span class="number">2</span>: <span class="string">error:</span> unknown type name <span class="string">'ucontext_t'</span></div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/android-ndk-profiler/</span>prof.<span class="string">c:</span><span class="number">150</span>:<span class="number">26</span>: <span class="string">error:</span> <span class="string">'ucontext_t'</span> undeclared (first use <span class="keyword">in</span> <span class="keyword">this</span> function)</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/android-ndk-profiler/</span>prof.<span class="string">c:</span><span class="number">150</span>:<span class="number">26</span>: <span class="string">note:</span> each undeclared identifier is reported only once <span class="keyword">for</span> each function it appears <span class="keyword">in</span></div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/android-ndk-profiler/</span>prof.<span class="string">c:</span><span class="number">150</span>:<span class="number">38</span>: <span class="string">error:</span> expected expression before <span class="string">')'</span> token</div><div class="line"><span class="regexp">/home/</span>hanpfei<span class="regexp">/android-ndk-profiler/</span>prof.<span class="string">c:</span><span class="number">151</span>:<span class="number">41</span>: <span class="string">error:</span> request <span class="keyword">for</span> member <span class="string">'uc_mcontext'</span> <span class="keyword">in</span> something not a structure or union</div><div class="line"><span class="string">make:</span> *** [obj<span class="regexp">/local/</span>armeabi-v7a<span class="regexp">/objs-debug/</span>android-ndk-profiler/prof.o] Error <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>提示找不到ucontext_t类型的定义。这究竟又是怎么一回事呢？在github上，这个项目的all commits列表中，我们看到有这么几笔commits的comments里提到了ucontext_t：</p>
<p><strong><em>b22514a66c0477dd34eadf7039e404bfc6f38c1b</em></strong><br>和<br><strong><em>516eee06cb18429dedabd145c9f00b0b14ff65c8</em></strong>，<br>其中前者把jni/ucontext.h头文件中ucontext_t的定义给删了，而后者则干脆直接把这个头文件给彻底移除了。</p>
<p>由<strong><em>b22514a66c0477dd34eadf7039e404bfc6f38c1b</em></strong>这笔commit的comments，我们大体可以了解到ucontext_t的定义被从项目中移除的原因。ucontext本是GNU C库提供的一套标准的机制，用来创建、保存、切换用户态执行“上下文”，但无奈早期的NDK不支持这套机制，所以android-ndk-profiler项目就自己加了相关结构的定义。但自r10d版本开始，官方NDK已经是自带了对这套机制的支持，所以原来项目中ucontext_t的定义就显得多余了。</p>
<p>真操蛋，可怜了我们这群还在使用r9版NDK的人儿。如果能方便地把使用的NDK更新到r10d及之后的版本自然更好。如果不能，只有另想他法。</p>
<p>官方把jni/ucontext.h这个文件给删了，那大不了我们把项目的repo reset几笔change，重新找回这个文件就是了。reset到b22514a66c0477dd34eadf7039e404bfc6f38c1b之前的那个状态，大概就是reset 9笔changes：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hanpfei<span class="meta">@hanpfei</span>-<span class="string">ThundeRobot:</span>~/android-ndk-profiler_repo$ git reset --hard HEAD~<span class="number">9</span></div></pre></td></tr></table></figure></p>
<p>OK，找回了我们要的ucontext.h文件了。此外，还需要修改prof.c文件来包含那个头文件。</p>
<p>至此，我们的项目终于能够顺利通过编译了。</p>
<h1 id="添加对监视函数的调用"><a href="#添加对监视函数的调用" class="headerlink" title="添加对监视函数的调用"></a>添加对监视函数的调用</h1><p>经过了上面的步骤，android-ndk-profiler的功能终于被顺地编译进了我们的so。但要如何使android-ndk-profiler提供的功能运转起来呢？我们还需要在代码的适当位置，加入对监视函数的调用。</p>
<p>默认产生的profiling结果文件的路径为/sdcard/gmon.out，这个路径在prof.c中定义。因而我们需要让我们的app具有在sdcard上写文件的权限。我们可以在AndroidManifest.xml文件中加入下面一行：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p>在我们native code的适当位置，加入对监视函数的调用：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* in the start-up code */</span></div><div class="line"><span class="selector-tag">monstartup</span>(<span class="string">"your_lib.so"</span>);</div><div class="line"></div><div class="line"><span class="comment">/* in the onPause or shutdown code */</span></div><div class="line"><span class="selector-tag">moncleanup</span>();</div></pre></td></tr></table></figure></p>
<p>比如在start性质的函数中加入对函数monstartup()的调用，在end性质的函数中加入对moncleanup()函数的调用。要调用这两个函数，其它的一些基本设置必不可少：在调用这些函数的code文件中，inlcude相应的头文件，也就是prof.h；在Android.mk文件的搜索头文件路径列表中加入android-ndk-profiler的路径，也就是变量LOCAL_C_INCLUDES加入~/android-ndk-profiler路径。</p>
<h1 id="产生并查看结果"><a href="#产生并查看结果" class="headerlink" title="产生并查看结果"></a>产生并查看结果</h1><p>moncleanup()执行结束之后，就在sdcard上产生了结果文件。我们可以使用gprof命令来产生profiling的报表文件。我们需要先用adb pull命令将gmon.out文件拷贝到自己的PC上，然后执行如下的命令产生结果：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$<span class="regexp">/media/</span>data<span class="regexp">/dev_tools/</span>android-ndk-r9d<span class="regexp">/toolchains/</span>arm-linux-androideabi-<span class="number">4.8</span><span class="regexp">/prebuilt/</span>linux-x86<span class="regexp">/bin/</span>arm-linux-androideabi-gprof  libmoretvp2p.so  &gt; gprof.txt</div></pre></td></tr></table></figure></p>
<p>这个地方的so文件，是从项目的obj/local/armeabi-v7a/下copy出来的，而不是项目的libs/armeabi-v7a/下。使用后者来产生报表时会报错：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hanpfei<span class="meta">@hanpfei</span>-<span class="string">ThundeRobot:</span><span class="regexp">~/p2pclient_prof$ /</span>media<span class="regexp">/data/</span>dev_tools<span class="regexp">/android-ndk-r9d/</span>toolchains<span class="regexp">/arm-linux-androideabi-4.8/</span>prebuilt<span class="regexp">/linux-x86/</span>bin/arm-linux-androideabi-gprof  libmoretvp2p.so  &gt; gprof.txt</div><div class="line"><span class="regexp">/media/</span>data<span class="regexp">/dev_tools/</span>android-ndk-r9d<span class="regexp">/toolchains/</span>arm-linux-androideabi<span class="number">-4.8</span><span class="regexp">/prebuilt/</span>linux-x86<span class="regexp">/bin/</span>arm-linux-androideabi-<span class="string">gprof:</span> file `libmoretvp2p.so<span class="string">' has no symbols</span></div></pre></td></tr></table></figure></p>
<p>提示no symbols。 </p>
<p>我们可以用普通的文本编辑器打开我们在上一步中产生的gprof.txt文件：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">Flat profile:</div><div class="line"></div><div class="line"></div><div class="line">Each sample counts as <span class="number">0.01</span> seconds.</div><div class="line">  %   cumulative   self              self     total           </div><div class="line"> time   seconds   seconds    calls  ms/call  ms/call  name    </div><div class="line"> <span class="number">21.69</span>      <span class="number">0.82</span>     <span class="number">0.82</span>      <span class="number">299</span>     <span class="number">2.74</span>     <span class="number">2.74</span>  CRcvLossList::CRcvLossList(<span class="keyword">int</span>)</div><div class="line"> <span class="number">20.11</span>      <span class="number">1.58</span>     <span class="number">0.76</span>                             profCount</div><div class="line"> <span class="number">12.70</span>      <span class="number">2.06</span>     <span class="number">0.48</span>      <span class="number">299</span>     <span class="number">1.61</span>     <span class="number">1.61</span>  CSndLossList::CSndLossList(<span class="keyword">int</span>)</div><div class="line">  <span class="number">5.29</span>      <span class="number">2.26</span>     <span class="number">0.20</span>                             systemMessage</div><div class="line">  <span class="number">4.76</span>      <span class="number">2.44</span>     <span class="number">0.18</span>      <span class="number">301</span>     <span class="number">0.60</span>     <span class="number">0.60</span>  CRcvBuffer::~CRcvBuffer()</div><div class="line">  <span class="number">3.44</span>      <span class="number">2.57</span>     <span class="number">0.13</span>      <span class="number">299</span>     <span class="number">0.43</span>     <span class="number">0.43</span>  CRcvBuffer::CRcvBuffer(CUnitQueue*, <span class="keyword">int</span>)</div><div class="line">  <span class="number">2.12</span>      <span class="number">2.65</span>     <span class="number">0.08</span>                             free_maps</div><div class="line">  <span class="number">1.32</span>      <span class="number">2.70</span>     <span class="number">0.05</span>     <span class="number">3052</span>     <span class="number">0.02</span>     <span class="number">0.02</span>  CChannel::sendto(sockaddr <span class="keyword">const</span>*, CPacket&amp;) <span class="keyword">const</span></div><div class="line">  <span class="number">1.32</span>      <span class="number">2.75</span>     <span class="number">0.05</span>                             <span class="built_in">std</span>::istream::sentry::sentry(<span class="built_in">std</span>::istream&amp;, <span class="keyword">bool</span>)</div><div class="line">  <span class="number">1.06</span>      <span class="number">2.79</span>     <span class="number">0.04</span>       <span class="number">31</span>     <span class="number">1.29</span>     <span class="number">3.29</span>  MORETV::HttpDownloadTask::downloadByHttp(<span class="built_in">std</span>::<span class="built_in">string</span> <span class="keyword">const</span>&amp;, Poco::AutoPtr&lt;MORETV::TsDownloadSession&gt;&amp;)</div><div class="line">  <span class="number">0.79</span>      <span class="number">2.82</span>     <span class="number">0.03</span>    <span class="number">13956</span>     <span class="number">0.00</span>     <span class="number">0.00</span>  Poco::AutoPtr&lt;MORETV::TransportStreamImpl&gt;::<span class="keyword">operator</span>-&gt;()</div><div class="line">  <span class="number">0.79</span>      <span class="number">2.85</span>     <span class="number">0.03</span>     <span class="number">7322</span>     <span class="number">0.00</span>     <span class="number">0.00</span>  MORETV::TransportStreamImpl::write(<span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">int</span>)</div><div class="line">  <span class="number">0.79</span>      <span class="number">2.88</span>     <span class="number">0.03</span>     <span class="number">4391</span>     <span class="number">0.01</span>     <span class="number">0.01</span>  <span class="built_in">std</span>::_Rb_tree&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::pair&lt;<span class="keyword">int</span> <span class="keyword">const</span>, CUDTSocket*&gt;, <span class="built_in">std</span>::_Select1st&lt;<span class="built_in">std</span>::pair&lt;<span class="keyword">int</span> <span class="keyword">const</span>, CUDTSocket*&gt; &gt;, <span class="built_in">std</span>::less&lt;<span class="keyword">int</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::pair&lt;<span class="keyword">int</span> <span class="keyword">const</span>, CUDTSocket*&gt; &gt; &gt;::_M_lower_bound(<span class="built_in">std</span>::_Rb_tree_node&lt;<span class="built_in">std</span>::pair&lt;<span class="keyword">int</span> <span class="keyword">const</span>, CUDTSocket*&gt; &gt;*, <span class="built_in">std</span>::_Rb_tree_node&lt;<span class="built_in">std</span>::pair&lt;<span class="keyword">int</span> <span class="keyword">const</span>, CUDTSocket*&gt; &gt;*, <span class="keyword">int</span> <span class="keyword">const</span>&amp;)</div><div class="line">  <span class="number">0.79</span>      <span class="number">2.91</span>     <span class="number">0.03</span>                             sigemptyset</div><div class="line">  <span class="number">0.53</span>      <span class="number">2.93</span>     <span class="number">0.02</span>    <span class="number">33591</span>     <span class="number">0.00</span>     <span class="number">0.00</span>  CChannel::recvfrom(sockaddr*, CPacket&amp;) <span class="keyword">const</span></div><div class="line">  <span class="number">0.53</span>      <span class="number">2.95</span>     <span class="number">0.02</span>     <span class="number">1323</span>     <span class="number">0.02</span>     <span class="number">0.02</span>  CACKWindow::store(<span class="keyword">int</span>, <span class="keyword">int</span>)</div><div class="line">  <span class="number">0.53</span>      <span class="number">2.97</span>     <span class="number">0.02</span>                             CRcvQueue::worker(<span class="keyword">void</span>*)</div><div class="line">  <span class="number">0.53</span>      <span class="number">2.99</span>     <span class="number">0.02</span>                             <span class="built_in">std</span>::<span class="built_in">string</span>::replace(<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">int</span>)</div><div class="line">  <span class="number">0.53</span>      <span class="number">3.01</span>     <span class="number">0.02</span>                             <span class="built_in">std</span>::locale::locale()</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>由这个结果，可以看到android-ndk-profiler工具本身的profCount()函数耗费了我们好多的CPU时间唉。</p>
<p>各个字段的具体含义如下：</p>
<p><strong>% time</strong><br>This is the percentage of the total execution time your program spent in this function. These should all add up to 100%.</p>
<p><strong>cumulative seconds</strong><br>This is the cumulative total number of seconds the computer spent executing this functions, plus the time spent in all the functions above this one in this table.</p>
<p><strong>self seconds</strong><br>This is the number of seconds accounted for by this function alone. The flat profile listing is sorted first by this number.</p>
<p><strong>calls</strong><br>This is the total number of times the function was called. If the function was never called, or the number of times it was called cannot be determined (probably because the function was not compiled with profiling enabled), the calls field is blank.</p>
<p><strong>self ms/call</strong><br>This represents the average number of milliseconds spent in this function per call, if this function is profiled. Otherwise, this field is blank for this function.</p>
<p><strong>total ms/call</strong><br>This represents the average number of milliseconds spent in this function and its descendants per call, if this function is profiled. Otherwise, this field is blank for this function. This is the only field in the flat profile that uses call graph analysis.</p>
<p><strong>name</strong><br>This is the name of the function. The flat profile is sorted by this field alphabetically after the self seconds and calls fields are sorted.</p>
<p>Done。</p>
</div><div class="tags"><a href="/tags/Android开发/">Android开发</a></div><div class="post-nav"><a href="/2015/09/06/UDT协议实现分析——UDT初始化和销毁/" class="pre">UDT协议实现分析——UDT初始化和销毁</a><a href="/2013/09/11/messagequeue_in_android/" class="next">android的消息队列机制</a></div><div id="disqus_thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android-图形系统/">Android 图形系统</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-开发/">C/C++开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java开发/">Java开发</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux内核/">Linux内核</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/live555/">live555</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/业界趣闻/">业界趣闻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台开发/">后台开发</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络协议/">网络协议</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络调试/">网络调试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随想杂谈/">随想杂谈</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频开发/">音视频开发</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/网络协议/" style="font-size: 15px;">网络协议</a> <a href="/tags/Android开发/" style="font-size: 15px;">Android开发</a> <a href="/tags/源码分析/" style="font-size: 15px;">源码分析</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/后台开发/" style="font-size: 15px;">后台开发</a> <a href="/tags/Java开发/" style="font-size: 15px;">Java开发</a> <a href="/tags/QUIC/" style="font-size: 15px;">QUIC</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/网络调试/" style="font-size: 15px;">网络调试</a> <a href="/tags/HTTP2/" style="font-size: 15px;">HTTP2</a> <a href="/tags/UDT/" style="font-size: 15px;">UDT</a> <a href="/tags/图形图像/" style="font-size: 15px;">图形图像</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/C-C-开发/" style="font-size: 15px;">C/C++开发</a> <a href="/tags/音视频开发/" style="font-size: 15px;">音视频开发</a> <a href="/tags/Linux内核/" style="font-size: 15px;">Linux内核</a> <a href="/tags/live555/" style="font-size: 15px;">live555</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Go-语言/" style="font-size: 15px;">Go 语言</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/12/android_debug_gdb/">使用 GDB 调试 Android 应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/11/android_emulator_dev/">Android 模拟器下载、编译及调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_start_streaming/">live555 源码分析：播放启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/live555_src_analysis_subsession_setup/">live555 源码分析：子会话 SETUP</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/live555_src_analysis_subsession_sdp/">live555 源码分析：子会话 SDP 行生成</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/07/live555_src_analysis_servermediasession/">live555 源码分析：ServerMediaSession</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/06/live555_src_analysis_rtspserver_arch/">live555 源码分析：RTSPServer 组件结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/live555_src_analysis_play/">live555 源码分析： PLAY 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/live555_src_analysis_setup/">live555 源码分析： SETUP 的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/04/live555_src_analysis_describe/">live555 源码分析： DESCRIBE 的处理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://developer.android.com/index.html" title="Android Developers" target="_blank">Android Developers</a><ul></ul><a href="https://source.android.com/" title="Android Open Source Project" target="_blank">Android Open Source Project</a><ul></ul><a href="http://www.vants.org/" title="蚂蚁网" target="_blank">蚂蚁网</a></div><div class="widget"><div class="widget-title"><i class="fa fa-commt"> 最近评论</i></div><script type="text/javascript" src="//wolfcstech.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.2.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:hanpfei@gmail.com" target="_blank" class="fa fa-email"> </a><a href="undefined" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/hanpfei" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">Han Pengfei</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var disqus_shortname = 'wolfcstech';
var disqus_identifier = '2015/07/04/Android_app_native代码性能分析/';
var disqus_title = 'Android app native代码性能分析';
var disqus_url = 'https://www.wolfcstech.com/2015/07/04/Android_app_native代码性能分析/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wolfcstech.disqus.com/count.js" async></script><script type="text/javascript" src="/js/search.json.js?v=1.2.0"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c736b12c32c019fd9ff6c825b6b9b44";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></body></html>